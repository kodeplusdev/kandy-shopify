#= require kandy.min
#= require jquery.barrating.min

class window.KCWidget
  _self = undefined

  constructor: (options) ->
    _self = @
    {@config} = options
    _self.chatData = {"id":1,"title":"anonymous","name":"anonymous","email":"anonymous@anonymous.com","status":"open","rating":"like","messages":[{"message":{"json":{"id":"1","cmd":"new_message","type":"v","display_name":"anonymous","text":"hi"}},"timestamp":"1449034496562"},{"message":{"json":{"id":"1","type":"o","text":"hi","cmd":"new_message","avatar":"","display_name":"operator","user_id":"1"}},"timestamp":"1449034504589"},{"message":{"json":{"id":"1","display_name":"operator","cmd":"new_message","type":"o","avatar":"","role":"admin","is_joined":"true","user_id":"1","text":"operator has joined the chat!"}},"timestamp":"1449036270630"},{"message":{"json":{"id":"7","display_name":"operator","cmd":"new_message","type":"o","avatar":"","role":"admin","is_left":"true","user_id":"1","text":"operator has left the chat"}},"timestamp":"1449036754421"},{"message":{"json":{"id":"7","display_name":"operator","cmd":"new_message","type":"o","avatar":"","role":"admin","is_closed":"true","user_id":"1","text":"operator has closed the chat"}},"timestamp":"1449036754421"}],"created_at":"2015-12-02T05:34:24.672Z","operators":[{"id":1,"email":"operator@operator.com","full_name":"operator","display_name":"operator","role":"role"}],"online":true}

    _self.flagStartChat = false
    _self.flagInChat = false
    _self.flagCloseChat = false
    _self.flagNoOperator = false
    _self.flagNoOperatorSuccess = false

    _self.renderWidget()
    _self.bindWidget()

  update: (config) ->
    _self.config = config.json_string
    _self.config.color = config.color
    _self.config.enabled = config.enabled
    _self.config.current_tab = config.current_tab

    _self.flagStartChat = false
    _self.flagInChat = false
    _self.flagCloseChat = false
    _self.flagNoOperator = false
    _self.flagNoOperatorSuccess = false

    _self.renderWidget()
    _self.bindWidget()

  renderWidget: ->
    $('body').html """
    <div class='animate chat-window'>
      <div id='start-chat' class='chat-window minimizee' style='display: none;'>
        <img class='chat-img top-img collapse-start-chat' src='' style='display:block !important;'>
        <table class='chattable' style='width: 300px;'>
          <tbody>
            <tr class='chattable-raw'>
              <td id='start-head' class='header-text collapse-start-chat'></td>
              <td class='header-btn minimize-btn#{_self.config.collapse.show_widget_hide_button}'>
                <a style='padding-left: 5px;'>
                  <img id='minimize' class="btn-img" style='margin:auto;vertical-align: middle;' src='<%= asset_url('icons/minus.png') %>'>
                </a>
              </td>
              <td class='header-btn'>
                <a style='padding-left: 5px;' class='collapse-start-chat'>
                  <img id='minimize' class='btn-img start-chat-btn-mini' style='margin:auto;vertical-align: middle;' src='<%= asset_url('icons/plus.png') %>'>
                </a>
              </td>
            </tr>
            <tr id='name-box'>
              <td colspan='3' style='padding:0;'>
                <div class='name-messages'>
                  <h4 class='title-info' id='lbl-intro'></h4>
                  <input id='txt-name' class='name-input' style=''>
                  <div class='error-message' id='name-error' style=''></div>
                  <input id='txt-emails' class='name-input'>
                  <div class='error-message' id='email-error' style=''></div>
                  <select class='name-input drp-department' style='height: 32px;width: 90%;'></select>
                  <textarea id='txt-question' class='question-input'></textarea>
                  <div class='error-message' id='question-error' style=''></div>
                  <center>
                    <button class='btn-send-req' id='send-request'>
                      <a id='send-req-text' style='text-decoration:none;color:white;padding: 0px 10px;'></a>
                    </button>
                  </center>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        <img class='chat-img bottom-img collapse-start-chat' src='' style='display:none !important;'>
        <div id='spinner-region' class='global-spinner' style='display: none;'>
          <div class='spinner-loader'></div>
        </div>
      </div>
      <div id='no-operator' class='chat-window  ' style='display: none;'>
        <img class='chat-img top-img collapse-no-operator' src='' style='display:block !important;'>
        <table class='chattable' style='width: 300px;'>
          <tbody>
            <tr class='chattable-raw'>
              <td id='no-operator-head' class='header-text collapse-no-operator'></td>
              <td class='header-btn minimize-btn#{_self.config.collapse.show_widget_hide_button}'>
                <a style='padding-left: 5px;'>
                  <img id='minimize' class="btn-img" style='margin:auto;vertical-align: middle;' src='<%= asset_url('icons/minus.png') %>'>
                </a>
              </td>
              <td class='header-btn'>
                <a style='padding-left: 5px;' class='collapse-no-operator'>
                  <img id='maxmizes' class='btn-img no-operator-btn-mini' style='margin:auto;vertical-align: middle;' src='<%= asset_url('icons/plus.png') %>'>
                </a>
              </td>
            </tr>
            <tr id='no-operator-box'>
              <td colspan='3' style='padding:0;'>
                <div class='name-messages' style='padding:5px;'>
                  <label id='lbl-email-intro'></label>
                  <input id='no-operator-name' class='name-input' placeholder='#{_self.config.no_operators.name}'>
                  <div class='error-message' id='name2-error' style=''></div>
                  <input id='no-operator-emails' class='name-input' placeholder='#{_self.config.no_operators.email}'>
                  <div class='error-message' id='email2-error' style=''></div>
                  <textarea id='no-operator-question' class='question-input' placeholder='#{_self.config.no_operators.question}'></textarea>
                  <div class='error-message' id='question2-error' style=''></div>
                  <center>
                    <button id='btn-send-email'>
                      <a id='send-no-operator-text' style='text-decoration:none;color:white;'></a>
                    </button>
                  </center>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        <img class='chat-img bottom-img collapse-no-operator' src='' style='display:none !important;'>
      </div>
      <div id='no-operator-sent' class='chat-window  ' style='display: none;'>
        <img class='chat-img top-img collapse-no-operator-success' src='' style='display:block !important;'>
        <table class='chattable' style='width: 300px;'>
          <tbody>
            <tr class='chattable-raw'>
              <td id='no-operator-sent-head' class='header-text collapse-no-operator-success'>#{_self.config.no_operators.title}</td>
              <td id='no-operator-refresh' class='header-btn'>
                <a id='refresh-send-mail'>
                  <img style='width: 32px;' class='btn-img' src='<%= asset_url('icons/refresh.png') %>'>
                </a>
              </td>
              <td class='header-btn'>
                <a style='padding-left: 4px;' class='collapse-no-operator-success'>
                  <img id='' class='btn-img no-operator-success-btn-mini' style='margin:auto;vertical-align: middle;' src='<%= asset_url('icons/plus.png') %>'>
                </a>
              </td>
            </tr>
            <tr id='no-operator-send-mail-box'>
              <td colspan='3' style='padding:0;'>
                <div class='name-messages' style='height: 75px;padding:10px;'>
                  <label id='lbl-email-sent'>#{_self.config.no_operators.email_sent_text}</label>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        <img class='chat-img bottom-img collapse-no-operator-success' src='' style='display:none !important;'>
      </div>
      <div id='in-chat' class='chat-window' style='display: none;'>
        <img class='chat-img top-img collapse-message-chat' src='' style='display:block !important;'>
        <table class='chattable' style='width: 300px;'>
          <tbody>
            <tr class='chattable-raw'>
              <td id='in-chat-head' class='send-req collapse-message-chat'>#{_self.config.start_chat.title}</td>
              <td class='header-btn chat-box'>
                <a style='padding-left: 4px;' class='collapse-message-chat'>
                  <img class='btn-img message-chat-btn-mini' src='<%= asset_url('icons/plus.png') %>'>
                </a>
              </td>
              <td class='header-btn close-button'>
                <a id='btn-close-chat'>
                  <img style='width: 15px;' class='btn-img' src='<%= asset_url('icons/close.png') %>'>
                </a>
              </td>
            </tr>
            <tr id='message-box'>
              <td colspan='3' style='padding:0;'>
                <div id='operator-img-div' class='name-messages' style='height: 56px;overflow: hidden;border-bottom: 5px solid #dcdcdc;'>
                  <div style='width:78%; float:left;'>
                    <div style='float:left;'>
                      <img id='operator-profile-img' style='height: 40px;width: 40px;margin: 8px;' src='<%= asset_url('icons/customer_support-128.png') %>'>
                    </div>
                    <div style='float:left;'>
                      <div id='operator-name' style='font-size: 20px;font-weight: bold;line-height: 1.5em;'></div>
                      <div id='operator-role' style='font-size:14px;'></div>
                    </div>
                  </div>
                  <div style='width:20%;float: right;margin-top: 5%;margin-right: 2%;'>
                    <div class='chat-box-control'>
                      <img class='chat-control active' id='chat-switch' style='margin-top: 4%;'>
                      |
                      <img class='chat-control' id='video-call-switch'>
                    </div>
                  </div>
                </div>
                <div id='def-chat' class='name-messages' style='min-height: 2px;'></div>
                <div id='con-chat' class='name-messages' style='min-height: 220px;max-height: 220px; border-bottom: white;border-top: none; word-break: break-all;overflow-y: auto; display:block!important;'>
                  <div class='messages'>
                    <div id='chat-msgs'></div>
                  </div>
                </div>
                <div id='img-typing' class='name-messages' style='border-top-color: white; display: none;'></div>
                <div class='name-messages send-mess' style='border-top-width:5px;'>
                  <textarea id='send-msg-text' style='max-width:225px; float:left' class='mess-input' rows='2' placeholder='#{_self.config.in_chat.send_message}'></textarea>
                  <a href='javascript:void(0)'>
                    <img id='message-send' src='<%= asset_url('icons/send.png') %>' style='margin-top: 8%;float:left;'>
                  </a>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        <img class='chat-img bottom-img collapse-message-chat' src='' style='display:none !important;'>
      </div>
      <div id='close-chat' class='chat-window' style='display: none;'>
        <img class='chat-img top-img collapse-close-chat' src='' style='display:block !important;'>
        <table class='chattable' style='width: 300px;'>
          <tbody>
            <tr class='chattable-raw'>
              <td id='close-head' class='header-text collapse-close-chat'></td>
              <td id='cls-chat-refresh' class='header-btn'>
                <a id='refresh-after-chats'>
                  <img style='width: 32px;height: 32px;' class='btn-img refresh-cls-chats' src='<%= asset_url('icons/refresh.png') %>'>
                </a>
              </td>
              <td class='header-btn'>
                <a style='padding-left: 4px;' class='collapse-close-chat'>
                  <img style='margin-bottom: 1px; margin:auto; vertical-align: middle;' class='btn-img close-chat-btn-mini' src='<%= asset_url('icons/plus.png') %>'>
                </a>
              </td>
            </tr>
            <tr id='close-box'>
              <td colspan='3' style='padding:0;'>
                <div class='name-messages'>
                  <p class='cls-chat-msg'></p>
                  <div id='cls-chat-rating'>
                    <select name="rating">
                      <option value=""></option>
                      <option value="1">Very bad</option>
                      <option value="2">Bad</option>
                      <option value="3">Normal</option>
                      <option value="4">Good</option>
                      <option value="5">Very good</option>
                    </select>
                  </div>
                  <br>
                  <p style='text-align: center; padding: 0px;'>
                    <a class='like-chat-dwld' style='cursor: pointer;font-family:Open Sans,Helvetica Neue,Helvetica,Arial,sans-serif !important;'></a>
                  </p>
                  <br/>
                  <br/>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        <img class='chat-img bottom-img collapse-close-chat' src='' style='display:none !important;'>
      </div>
      <div id='spinner-region' class='global-spinner' style='display: none;'>
        <div class='spinner-loader' style='top: 45%; left: 49%;'></div>
      </div>
    </div>
    """

    $('#start-chat').hide()
    $('#in-chat').hide()
    $('#close-chat').hide()
    $('#no-operator').hide()
    $('#no-operator-sent').hide()
    $('#img-typing').hide()

    wi = $(window).width()
    if wi <= 370
      $('.chattable').css('width', wi)
    else
      $('.chattable').css('width', '300px')

    $(window).resize ->
      wi = $(window).width()
      if wi <= 370
        $('.chattable').css('width', wi)
      else
        $('.chattable').css('width', '300px')

    $(document).on 'mouseover', '#message-send', ->
      $('#message-send').css('border', '0px solid ' + _self.config.color)
    $(document).on 'mouseout', '#message-send', ->
      $('#message-send').css('border', 'none')

  hideChatable: (bar) ->
    $(bar).attr('src', '<%= asset_url('icons/plus.png') %>') if bar isnt undefined
    $('.minimize-btn1').show()
    $('.chattable').hide() if _self.config.collapse.type is 'i'
    if _self.config.collapse.position is 'bl' || _self.config.collapse.position is 'br'
      $('.top-img').show() if _self.config.collapse.type is 'i' || _self.config.collapse.type is 'ti'
    else
      $('.bottom-img').show() if _self.config.collapse.type is 'i' || _self.config.collapse.type is 'ti'

  showChatable: (bar) ->
    $(bar).attr('src', '<%= asset_url('icons/minus.png') %>')  if bar isnt undefined
    $('.minimize-btn1').hide()
    $('.chattable').show() if _self.config.collapse.type is 'i'
    if _self.config.collapse.position is 'bl' || _self.config.collapse.position is 'br'
      $('.top-img').hide() if _self.config.collapse.type is 'i' || _self.config.collapse.type is 'ti'
    else
      $('.bottom-img').hide() if _self.config.collapse.type is 'i' || _self.config.collapse.type is 'ti'

  showToggle: (CurrentTab) ->
    switch (CurrentTab)
      when 'MessageChatTab'
        $('#message-box').toggle('fast') unless  _self.flagInChat
        $('#name-box').toggle('fast') if _self.flagStartChat
        $('#close-box').toggle('fast') if _self.flagCloseChat
        $('#no-operator-box').toggle('fast') if _self.flagNoOperator
        $('#no-operator-send-mail-box').toggle('fast') if _self.flagNoOperatorSuccess
        $('.message-chat-btn-mini').attr('src', '<%= asset_url('icons/minus.png') %>')
        _self.flagInChat = true
        _self.flagStartChat = false
        _self.flagCloseChat = false
        _self.flagNoOperator = false
        _self.flagNoOperatorSuccess = false
      when 'StartChatTab'
        $('#message-box').toggle('fast') if _self.flagInChat
        $('#name-box').toggle('fast') unless  _self.flagStartChat
        $('#close-box').toggle('fast') if _self.flagCloseChat
        $('#no-operator-box').toggle('fast') if _self.flagNoOperator
        $('#no-operator-send-mail-box').toggle('fast') if _self.flagNoOperatorSuccess
        $('.start-chat-btn-mini').attr('src', '<%= asset_url('icons/minus.png') %>')
        $('#start-head').text(_self.config.start_chat.title)
        _self.flagInChat = false
        _self.flagStartChat = true
        _self.flagCloseChat = false
        _self.flagNoOperator = false
        _self.flagNoOperatorSuccess = false
      when 'CloseChatTab'
        $('#message-box').toggle('fast') if _self.flagInChat
        $('#name-box').toggle('fast') if  _self.flagStartChat
        $('#close-box').toggle('fast') unless _self.flagCloseChat
        $('#no-operator-box').toggle('fast') if _self.flagNoOperator
        $('#no-operator-send-mail-box').toggle('fast') if _self.flagNoOperatorSuccess
        $('.close-chat-btn-mini').attr('src', '<%= asset_url('icons/minus.png') %>')
        _self.flagInChat = false
        _self.flagStartChat = false
        _self.flagCloseChat = true
        _self.flagNoOperator = false
        _self.flagNoOperatorSuccess = false
      when 'NoOperatorTab'
        $('#message-box').toggle('fast') if _self.flagInChat
        $('#name-box').toggle('fast') if  _self.flagStartChat
        $('#close-box').toggle('fast') if _self.flagCloseChat
        $('#no-operator-box').toggle('fast') unless _self.flagNoOperator
        $('#no-operator-send-mail-box').toggle('fast') if _self.flagNoOperatorSuccess
        $('.no-operator-btn-mini').attr('src', '<%= asset_url('icons/minus.png') %>')
        _self.flagInChat = false
        _self.flagStartChat = false
        _self.flagCloseChat = false
        _self.flagNoOperator = true
        _self.flagNoOperatorSuccess = false
      when 'NoOperatorSuccess'
        $('#message-box').toggle('fast') if _self.flagInChat
        $('#name-box').toggle('fast') if  _self.flagStartChat
        $('#close-box').toggle('fast') if _self.flagCloseChat
        $('#no-operator-box').toggle('fast') if _self.flagNoOperator
        $('#no-operator-send-mail-box').toggle('fast') unless _self.flagNoOperatorSuccess
        $('.no-operator-success-btn-mini').attr('src', '<%= asset_url('icons/minus.png') %>')
        _self.flagInChat = false
        _self.flagStartChat = false
        _self.flagCloseChat = false
        _self.flagNoOperator = false
        _self.flagNoOperatorSuccess = true

  hideToggle: (CurrentTab) ->
    switch (CurrentTab)
      when 'MessageChatTab'
        $('#message-box').toggle('fast') if _self.flagInChat
        $('.message-chat-btn-mini').attr('src', '<%= asset_url('icons/plus.png') %>')
        _self.flagInChat = false
      when 'StartChatTab'
        $('#name-box').toggle('fast') if _self.flagStartChat
        $('.start-chat-btn-mini').attr('src', '<%= asset_url('icons/plus.png') %>')
        $('#start-head').text(_self.config.collapse.title)
        _self.flagStartChat = false
      when 'CloseChatTab'
        $('#close-box').toggle('fast') if _self.flagCloseChat
        $('.close-chat-btn-mini').attr('src', '<%= asset_url('icons/plus.png') %>')
        _self.flagCloseChat = false
      when 'NoOperatorTab'
        $('#no-operator-box').toggle('fast') if _self.flagNoOperator
        $('.no-operator-btn-mini').attr('src', '<%= asset_url('icons/plus.png') %>')
        _self.flagNoOperator = false
      when 'NoOperatorSuccess'
        $('#no-operator-send-mail-box').toggle('fast') if _self.flagNoOperatorSuccess
        $('.no-operator-success-btn-mini').attr('src', '<%= asset_url('icons/plus.png') %>')
        _self.flagNoOperatorSuccess = false

  bindWidget: ->
    $('#def-chat').empty()
    $('#chat-msgs').empty()

    $('.top-img').hide()
    $('.bottom-img').hide()

    $('#name-box').hide()
    $('#message-box').hide()
    $('#close-box').hide()
    $('#no-operator-box').hide()
    $('#no-operator-send-mail-box').hide()

    _self.setPosition()
    _self.startChat()
    _self.closeChat()
    _self.setImgPosition()
    _self.widgetAnimate()

    if _self.config.enabled
      $('.chattable-raw').attr('style', 'background: ' + _self.config.color + ' !important')
      $('.btn-send-req').attr('style', 'background: ' + _self.config.color + ' !important')
      $('#btn-send-email').attr('style', 'background: ' + _self.config.color + ' !important')
      $('.send-mess').css('border-top-color', _self.config.color + ' !important')
      $('.header-text').attr('style', 'background: ' + _self.config.color + ' !important')
      $('.header-btn').attr('style', 'background: ' + _self.config.color + ' !important')
      $('#in-chat-head').attr('style', 'background: ' + _self.config.color + ' !important')
      $('#message-send').attr('style', 'background: ' + _self.config.color + ' !important')

    if _self.chatData.id && _self.chatData.id isnt '' && _self.config.current_tab is 'in-chat'
      if _self.chatData.rating is 'like'
        $('#chat-likes').attr('src', '<%= asset_url('icons/thumbg.svg') %>')
        $('.chat-likes').removeAttr('id')
      else if _self.chatData.rating is 'dislike'
        $('#chat-dislikes').attr('src', '<%= asset_url('icons/thumbr.svg') %>')
        $('.chat-dislikes').removeAttr('id')

      if _self.chatData.operators && _self.chatData.operators.length
        op = _self.chatData.operators[0]

        if !op.display_name || op.display_name is ''
          $('#operator-name').text('')
          $('#in-chat-head').text(_self.config.start_chat.title)
        else
          $('#operator-name').text(op.display_name)
          $('#in-chat-head').text("#{_self.config.in_chat.title} #{op.display_name}")

        if !op.avatar || op.avatar is ''
          $('#operator-profile-img').attr('src', '<%= asset_url('avatars/avatar-operator.png') %>')
        else
          $('#operator-profile-img').attr('src', op.avatar)

        if !op.role || op.role is ''
          $('#operator-role').text('')
        else
          $('#operator-role').text(op.role)

      flag = true
      for m in _self.chatData.messages
        if m.message.json.type isnt 'v'
          flag = false
          break
      if flag
        _self.inChat(_self.chatData.name)

      _self.chatContent()
      _self.showTab('MessageChatTab')
      _self.showToggle('MessageChatTab')
      $('.chattable').show()
      $('#con-chat').scrollTop($('#con-chat')[0].scrollHeight)
      $('.top-img').hide()
      $('.bottom-img').hide()
      $('#chat-msgs').append('<div class=\'in-chat-msg no-operator-msg-div\'>' + _self.config.in_chat.no_operators + '</div>')
      $('#con-chat').scrollTop($('#con-chat')[0].scrollHeight)
    else
      if _self.chatData.online && _self.config.current_tab isnt 'no-operator' && _self.config.current_tab isnt 'error'
        if _self.config.collapse.position is 'bl' || _self.config.collapse.position is 'br'
          $('.top-img').show() if _self.config.collapse.type is 'i' || _self.config.collapse.type is 'ti'
        else
          $('.bottom-img').show() if _self.config.collapse.type is 'i' || _self.config.collapse.type is 'ti'
        $('.chattable').hide() if _self.config.collapse.type is 'i'

        if _self.config.start_chat.ask_for_name is '0' && _self.config.start_chat.ask_for_email is '0' &&
            _self.config.start_chat.ask_for_question is '0' && _self.config.start_chat.ask_for_department is '0'
          _self.showTab('MessageChatTab')
        else
            _self.showTab('StartChatTab')

        if _self.config.current_tab is 'start-chat'
          _self.showChatable('.start-chat-btn-mini')
          _self.showToggle('StartChatTab')
        else if _self.config.current_tab is 'chat-closed'
          $('#in-chat-head').text(_self.config.start_chat.title)
          $('.top-img').hide()
          _self.showTab('CloseChatTab')
          _self.showToggle('CloseChatTab')
      else
        _self.noOperators()
        _self.showChatable('.no-operator-btn-mini')
        _self.showToggle('NoOperatorTab')
        if _self.config.current_tab is 'error'
          $('#email2-error').show()
          $('#name2-error').show()
          $('#question2-error').show()
          $('#btn-send-email').hide()

  showTab: (CurrentTab) ->
    switch (CurrentTab)
      when 'MessageChatTab'
        $('#start-chat').hide()
        $('#in-chat').show()
        $('#close-chat').hide()
        $('#no-operator').hide()
        $('#no-operator-sent').hide()
      when 'StartChatTab'
        $('#start-chat').show()
        $('#in-chat').hide()
        $('#close-chat').hide()
        $('#no-operator').hide()
        $('#no-operator-sent').hide()
      when 'CloseChatTab'
        $('#start-chat').hide()
        $('#in-chat').hide()
        $('#close-chat').show()
        $('#no-operator').hide()
        $('#no-operator-sent').hide()
      when 'NoOperatorTab'
        $('#start-chat').hide()
        $('#in-chat').hide()
        $('#close-chat').hide()
        $('#no-operator').show()
        $('#no-operator-sent').hide()
      when 'NoOperatorSuccess'
        $('#start-chat').hide()
        $('#in-chat').hide()
        $('#close-chat').hide()
        $('#no-operator').hide()
        $('#no-operator-sent').show()
      when 'AllHide'
        $('#start-chat').hide()
        $('#in-chat').hide()
        $('#close-chat').hide()
        $('#no-operator').hide()
        $('#no-operator-sent').hide()

  getDateTime: (val) ->
    date = new Date(val)
    minut = date.getMinutes()
    hour = date.getHours()
    ampm = if hour >= 12 then 'pm' else 'am'
    day = date.getDate()
    month = (date.getMonth() + 1)
    year = date.getFullYear()

    return hour + ':' + minut + ampm + '.' + ' ' + _self.getSetFormate(day) + ' ' + _self.getMonthName(month) + ' ' + year

  getMonthName: (val) ->
    months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Dec']
    if val > 0 and val <= 12
      monthyer = months[val - 1]
    return monthyer

  getSetFormate: (val) ->
    number = val
    str = ''
    if val.toString().length != 1
      number = parseInt(val.toString().substring(val.toString().length - 1, val.toString().length))
    if number == 1
      str = 'st'
    else if number == 2
      str = 'nd'
    else if number == 3
      str = 'rd'
    else if number == 0 || number >= 4 || number <= 9
      str = 'th'
    return val + str

  setPosition: ->
    if _self.config.collapse.position is 'bl'
      $('.chat-window').css
        'bottom': '0'
        'left': '10px'
        'top': ''
        'right': ''
        'position': 'fixed'
        'z-index': '999'
      if _self.config.collapse.type is 'i'
        if _self.config.collapse.image isnt '0'
          $('.top-img').show()
          $('.bottom-img').hide()
          $('.chattable').hide()
        else
          if _self.config.collapse.custom_image_url isnt ''
            $('.top-img').show()
            $('.bottom-img').hide()
            $('.chattable').hide()
      else if _self.config.collapse.type is 'ti'
        if _self.config.collapse.image isnt '0'
          $('.top-img').show()
          $('.bottom-img').hide()
        else
          if _self.config.collapse.custom_image_url isnt ''
            $('.top-img').show()
            $('.bottom-img').hide()
    else if _self.config.collapse.position is 'br'
      $('.chat-window').css
        'bottom': '0'
        'left': ''
        'top': ''
        'right': '10px'
        'position': 'fixed'
        'z-index': '999'
      if _self.config.collapse.type is 'i'
        if _self.config.collapse.image isnt '0'
          $('.top-img').show()
          $('.bottom-img').hide()
          $('.chattable').hide()
        else
          if _self.config.collapse.custom_image_url isnt ''
            $('.top-img').show()
            $('.bottom-img').hide()
            $('.chattable').hide()
      else if _self.config.collapse.type is 'ti'
        if _self.config.collapse.image isnt '0'
          $('.top-img').show()
          $('.bottom-img').hide()
        else
          if _self.config.collapse.custom_image_url isnt ''
            $('.top-img').show()
            $('.bottom-img').hide()
    else if _self.config.collapse.position is 'tl'
      $('.chat-window').css
        'bottom': ''
        'left': '10px'
        'top': '0'
        'right': ''
        'position': 'fixed'
        'z-index': '999'
      if _self.config.collapse.type is 'i'
        if _self.config.collapse.image isnt '0'
          $('.top-img').hide()
          $('.bottom-img').show()
          $('.chattable').hide()
        else
          if _self.config.collapse.custom_image_url isnt ''
            $('.top-img').hide()
            $('.bottom-img').show()
            $('.chattable').hide()
      else if _self.config.collapse.type is 'ti'
        if _self.config.collapse.image isnt '0'
          $('.top-img').hide()
          $('.bottom-img').show()
        else
          if _self.config.collapse.custom_image_url isnt ''
            $('.top-img').hide()
            $('.bottom-img').show()
    else if _self.config.collapse.position is 'tr'
      $('.chat-window').css
        'bottom': ''
        'left': ''
        'top': '0'
        'right': '10px'
        'position': 'fixed'
        'z-index': '999'
      if _self.config.collapse.type is 'i'
        if _self.config.collapse.image isnt 0
          $('.top-img').hide()
          $('.bottom-img').show()
          $('.chattable').hide()
        else
          if _self.config.collapse.custom_image_url isnt ''
            $('.top-img').hide()
            $('.bottom-img').show()
            $('.chattable').hide()
      else if _self.config.collapse.type is 'ti'
        if _self.config.collapse.image isnt 0
          $('.top-img').hide()
          $('.bottom-img').show()
        else
          if _self.config.collapse.custom_image_url
            $('.top-img').hide()
            $('.bottom-img').show()

  startChat: ->
    _self.showTab('StartChatTab')

    $('#start-head').text(_self.config.collapse.title)
    $('#lbl-intro').text(_self.config.start_chat.intro_text)
    $('#txt-name').attr('placeholder', _self.config.start_chat.ask_for_name_text)
    $('#txt-emails').attr('placeholder', _self.config.start_chat.ask_for_email_text)
    $('#txt-question').attr('placeholder', _self.config.start_chat.ask_for_question_text)
    $('#send-req-text').text(_self.config.start_chat.request_button)

    $('#name-error').text(_self.config.error_messages.name_required)
    $('#name2-error').text(_self.config.error_messages.name_required)
    $('#email-error').text(_self.config.error_messages.email_valid)
    $('#email2-error').text(_self.config.error_messages.email_valid)
    $('#question2-error').text(_self.config.error_messages.no_operator_required)

    $('#name-error').hide()
    $('#email-error').hide()
    $('#email2-error').hide()
    $('#name2-error').hide()
    $('#question2-error').hide()


    if _self.config.start_chat.ask_for_name is '1'
      $('#txt-name').show()
    else
      $('#txt-name').hide()

    if _self.config.start_chat.ask_for_email is '1'
      $('#txt-emails').show()
    else
      $('#txt-emails').hide()

    if _self.config.start_chat.ask_for_question is '1'
      $('#txt-question').show()
      $('#lbl-msg').show()
    else
      $('#txt-question').hide()
      $('#lbl-msg').hide()

    if _self.config.start_chat.ask_for_department is '1'
      if $('.drp-department').val()
        _self.departmentVisible = true
        $('.drp-department').show()
      else
        _self.departmentVisible = false
        $('.drp-department').hide()
    else
      _self.departmentVisible = false
      $('.drp-department').hide()

  noOperators: ->
    $('#no-operator-head').text(_self.config.no_operators.title)
    if _self.config.no_operators.action is 'h'
      _self.showTab('AllHide')
    else if _self.config.no_operators.action is 'm'
      _self.showTab('NoOperatorTab')
      $('#lbl-email-intro').text(_self.config.no_operators.message)
      $('#no-operator-name').hide()
      $('#no-operator-emails').hide()
      $('#no-operator-question').hide()
      $('#btn-send-email').hide()
    else if _self.config.no_operators.action is 'e'
      _self.showTab('NoOperatorTab');
      $('#lbl-email-intro').text(_self.config.no_operators.email_intro)
      $('#no-operator-name').show()
      $('#no-operator-emails').show()
      $('#nno-operator-question').show()
      $('#btn-send-email').show()

    $('#no-operator-name').attr('placeholder', _self.config.no_operators.your_name)
    $('#no-operator-emails').attr('placeholder', _self.config.no_operators.your_email)
    $('#no-operator-question').attr('placeholder', _self.config.no_operators.your_question)
    $('#lbl-email-sent').text(_self.config.no_operators.email_sent_text)
    $('#send-no-operator-text').text(_self.config.no_operators.send_button)

  inChat: (visitorName)->
    $('#con-chat').hide()
    $('#def-chat').show()
    $('#def-chat').append('<label>' + _self.config.in_chat.greeting + ' ' + visitorName + '!</label>')
    $('#def-chat').append('<label>' + _self.config.in_chat.connecting + '</label>')
    setTimeout ->
      $('#def-chat').empty();
      $('#def-chat').append('<div style=\'margin-top: 4%;\'><img src=\'<%= asset_url('icons/50-20.png') %>\'/><span style=\'margin-left: 4%;\' id=\'no-operator-msg\' class=\'in-chat-msg\' >' + _self.config.in_chat.message + '</span></div >')
    , 1200

  closeChat: ->
    if _self.config.chat_close.ask_for_rating is '1'
      $('#cls-chat-rating').show()
      $('#cls-chat-rating > select').barrating
        theme: 'css-stars'
    else
      $('#cls-chat-rating').hide()

    if _self.config.chat_close.custom_link_button is '1'
      $('#btn-text').show()
    else
      $('#btn-text').hide()

    $('#close-head').text(_self.config.chat_close.title);
    $('.cls-chat-msg').text(_self.config.chat_close.chat_closed);
    $('#btn-text').text(_self.config.chat_close.button_text);
    if _self.config.chat_close.downloadable is '1'
      $('.like-chat-dwld').text(_self.config.chat_close.download);
    else
      $('.like-chat-dwld').hide()
  pad: (padString, value, length) ->
    str = value.toString()
    while (str.length < length)
      str = padString + str;
    return str

  chatContent: ->
    $('#chat-msgs').empty()
    _self.displayStartMessage()
    if _self.chatData.messages
      if _self.chatData.messages.length > 0
        for m in _self.chatData.messages
          _self.displayMessage(m)
        $('#con-chat').scrollTop($('#con-chat')[0].scrollHeight)

  displayStartMessage: ->
    text = _self.config.in_chat.start_message
    if text && text isnt ''
      time = new Date().toLocaleTimeString()
      $('#chat-msgs').append('<div><span class=\'left\' style=\'word-break: break-word;background:' + _self.config.color + '\'>' + text + '<label class=\'left-time\'>' + time + '</label></span><div class=\'clear\'></div></div>')
      $('.left').append('<style>.left:after{border-right: 8px solid' + _self.config.color + '}</style>')

  displayMessage: (m) ->
    DateTime = new Date(Number(m.timestamp))
    Time = _self.pad('0', DateTime.getHours(), 2) + ':' + _self.pad('0', DateTime.getMinutes(), 2)
    json = m.message.json
    if json.is_joined
      $('#chat-msgs').append("<div class=\'in-chat-msg\'>#{json.display_name} #{_self.config.in_chat.joined_chat}</div>")
    else if json.is_left
      $('#chat-msgs').append("<div class=\'in-chat-msg\'>#{json.display_name} #{_self.config.in_chat.left_chat}</div>")
    else if json.is_closed
      $('#chat-msgs').append("<div class=\'in-chat-msg\'>#{json.display_name} #{_self.config.in_chat.closed_chat}</div>")
    else
      if json.type is 'v'
        $('#chat-msgs').append('<div><span class=\'right\' style=\'word-break: break-word;\'>' + json.text + '<label class=\'right-time\'>' + Time + '</label></span><div class=\'clear\'></div></div>')
      else
        if !json.avatar || json.avatar is ''
          $('#chat-msgs').append('<div><div style=\'float: left;height: auto;margin-bottom: 0px;\'><img style=\'width:35px;\' src=\'<%= asset_url('avatars/avatar-operator.png') %>\'></div><span class=\'left\' style=\'word-break: break-word;background:' + _self.config.color + '\'>' + json.text + '<label class=\'left-time\'>' + Time + '</label></span><div class=\'clear\'></div></div>')
        else
          $('#chat-msgs').append('<div><div style=\'float: left;height: auto;margin-bottom: 0px;\'><img style=\'width:35px;\' src=\'' + json.avatar + '\'></div><span class=\'left\' style=\'word-break: break-word;background:' + _self.config.color + '\'>' + json.text + '<label class=\'left-time\'>' + Time + '</label></span><div class=\'clear\'></div></div>')
        $('.left').append('<style>.left:after{border-right: 8px solid' + _self.config.color + '}</style>')

  setImgPosition: ->
    if _self.config.collapse.image isnt '0'
      $('.chat-img').attr('src', '<%= asset_url('assets/tabimages/TabImg-') %>' + _self.config.collapse.image + '.png')
    else
      if _self.config.collapse.custom_image_url isnt ''
        $('.chat-img').attr('src', _self.config.collapse.custom_image_url)

    $('.chat-img').css('width', '' + _self.config.collapse.scale + '%')
    if _self.config.collapse.image_in_front_of_tab is '0'
      $('.chat-img').css({'position': ''})
      $('.chattable').css({'position': 'relative'})
    else
      $('.chat-img').css({'position': 'relative'})
      $('.chattable').css({'position': ''})

    if _self.config.collapse.position is 'bl' || _self.config.collapse.position is 'br'
      vertic = 50 - _self.config.collapse.vertical
      $('.chat-img').css('margin-top', '')
      $('.chat-img').css('margin-bottom', '' + vertic + '%')
    else
      vertic = 50 - _self.config.collapse.vertical
      $('.chat-img').css('margin-bottom', '')
      $('.chat-img').css('margin-top', '' + vertic + '%')

    if _self.config.collapse.position is 'bl' || _self.config.collapse.position is 'tl'
      if _self.config.collapse.horizontal > 50
        first = (_self.config.collapse.horizontal * 130) / 50
        second = (first * _self.config.collapse.horizontal) / 100
        third = second - _self.config.collapse.horizontal
        $('.chat-img').css('margin-left', '' + third + '%')
      else if _self.config.collapse.horizontal < 50
        first = _self.config.collapse.horizontal - 52;
        $('.chat-img').css('margin-left', '' + first + '%')
      else
        first = 25;
        $('.chat-img').css('margin-left', '' + first + '%')
    else
      if _self.config.collapse.horizontal > 50
        first = (_self.config.collapse.horizontal * 25) / 50
        second = first - 25
        third = (second * 2)
        fourth = first + third
        $('.chat-img').css('margin-left', '' + fourth + '%')
      else if _self.config.collapse.horizontal < 50
        first = (_self.config.collapse.horizontal * 25) / 50
        second = first - 25
        third = (second * 2)
        fourth = (first + third) * 2
        $('.chat-img').css('margin-left', '' + fourth + '%')
      else
        first = 25
        $('.chat-img').css('margin-left', '' + first + '%')

  widgetAnimate: ->
    if _self.config.collapse.page_load isnt 'none' && _self.config.current_tab is 'collapsed'
      $('.chat-window').removeClass().addClass(_self.config.collapse.page_load + ' animated').one 'webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', ->
        $(this).removeClass()
        $(this).addClass('chat-window')