// Kandy.js
// Site: http://kandy.io
// Version: 2.6.0
// Copyright 2015 Genband
// ----------------------
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.kandy=t():e.kandy=t()}(this,function(){return function(e){function t(i){if(n[i])return n[i].exports;var o=n[i]={exports:{},id:i,loaded:!1};return e[i].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){function i(){"use strict";function e(e){var t=!1,n=!1,i=!1,o=!1;window.console&&console.warn&&console.error&&console.info&&("debug"===e&&(t=n=i=o=!0),"info"===e?t=n=i=!0:"warn"===e?t=n=!0:"error"===e&&(t=!0),o&&(_.debug=window.console.log.bind(window.console,"kandy debug: %s")),i&&(_.info=window.console.info.bind(window.console,"kandy info: %s")),n&&(_.warn=window.console.warn.bind(window.console,"kandy warn: %s")),t&&(_.error=window.console.error.bind(window.console,"kandy error: %s")))}function t(){var e=!1;return k&&(e=1===k.readyState),e}function n(){if(t()){V=setTimeout(n,3e4);var e={message_type:"ping"};try{k.send(JSON.stringify(e))}catch(i){window.console.error("Exception in sendWSPing: "+i.message)}}}function i(){window.console.log("reconnecting"),u(function(){window.console.log("reconnect success"),U=0,P.emit("onconnectionrestored")},function(){U++,window.console.log("failed to reconnect"),a()})}function a(){var e=U>10?U>100?6e4:3e4:1e4;M=setTimeout(i,e)}function s(){window.console.log("browser going online"),clearTimeout(M),M=setTimeout(i,500)}function c(){window.console.log("browser going offline"),clearTimeout(V),k&&k.onclose&&(k.onclose(),E(),k.close())}function d(e){var t=e.data_server_host,n=e.data_server_port,i=e.is_secure,o=t.match("^(?:https?://)?(?:www.)?([^/]+)"),r=n?":"+n:"";return(i?"wss":"ws")+"://"+o[1]+r}function l(e,t){O({url:"/users/configurations/data_channel",success:function(t){e&&e(t.result)},failure:t})}function u(e,i){return t()?void p():void l(function(t){D.kandyWSUrl=d(t)+"?client_sw_type=js&client_sw_version="+R.version+"&user_access_token=";try{_.debug("Opening websocket, UAT = "+N.userAccessToken),k&&E(),k=new WebSocket(D.kandyWSUrl+encodeURIComponent(N.userAccessToken))}catch(r){return void(i&&i("Error opening websocket",v.wsCreateError))}null!==k&&2!==k.readyState&&3!==k.readyState?(k.onopen=function(t){window.addEventListener&&!W&&(o.notification.setOnConnectionEstablished(function(){_.info("Connection established"),P.emit("onconnectionestablished","spider"),s()}),o.notification.setOnConnectionLost(function(){_.info("Connection Lost"),P.emit("onconnectionlost","spider"),c()}),W=!0),e(),n()},k.onclose=function(e){V&&(h&&!M&&(window.console.log("connection closed"),clearTimeout(V),a()),0===U&&P.emit("onconnectionlost",e))},k.onerror=function(e){P.emit("onconnectionerror",e)},k.onmessage=function(e){var t,n,i,o,r=JSON.parse(e.data);if("response"===r.message_type)n=w[r.id],n&&(delete w[r.id],0===r.status?n.success&&n.success():n.failure&&n.failure(r.message,r.status));else if(F.hasOwnProperty(r.message_type)&&(t=F[r.message_type],t&&t.length>0))for(o=t.length,i=0;o>i;i++)"function"==typeof t[i]&&t[i](r)}):i("Error opening websocket",v.wsCreateError)},i)}function f(e,n,i){if(t()){if((n||i)&&void 0===e.id){var o=m.createUUIDv4();e.id=o,w[o]={success:n,failure:i}}try{k.send(JSON.stringify(e))}catch(r){window.console.log("Exception in sendWebSocketData: "+r.message)}}else i()}function p(){clearTimeout(V),V=null,t()&&k.close()}function E(){k.onclose=null,k.onopen=null,k.onerror=null,k.onmessage=null}function S(e){if(e)for(var t in e)e.hasOwnProperty(t)&&(void 0===F[t]&&(F[t]=[]),F[t].push(e[t]))}function T(e,t,n,i,o,r){t=t.split("@")[0],O({url:"/domains/users/accesstokens",params:{key:e,user_id:t,user_password:n,client_sw_version:r&&r.client_sw_version,client_sw_type:r&&r.client_sw_type,kandy_device_id:r&&r.kandy_device_id},success:function(e){i&&i(e.result)},failure:o})}var g="2.6.0",m=function(){var e={};return e.createUUIDv4=function(){for(var e=[],t="0123456789ABCDEF",n=0;36>n;n++)e[n]=Math.floor(16*Math.random());for(e[14]=4,e[19]=3&e[19]|8,n=0;36>n;n++)e[n]=t[e[n]];return e[8]=e[13]=e[18]=e[23]="-",e.join("")},e.extend=function(e){e=e||{};for(var t=1;t<arguments.length;t++)if(arguments[t])for(var n in arguments[t])arguments[t].hasOwnProperty(n)&&(e[n]=arguments[t][n]);return e},e.defaults=function(e){e=e||{};for(var t=1;t<arguments.length;t++)if(arguments[t])for(var n in arguments[t])!e[n]&&arguments[t].hasOwnProperty(n)&&(e[n]=arguments[t][n]);return e},e.param=function(e){var t,n="";for(t in e)if(e.hasOwnProperty(t)){var i=e[t];if(void 0===i)continue;null===i&&(i=""),"string"!=typeof i&&(i=JSON.stringify(i)),n.length>0&&(n+="&"),n+=encodeURIComponent(t)+"="+encodeURIComponent(i)}return n},e.isPlainObject=function(e){return!!e&&"object"==typeof e&&e.constructor===Object},e.deepExtend=function(t){var n=Array.prototype.slice.call(arguments,1);return n.forEach(function(n){e.isPlainObject(n)&&Object.keys(n).forEach(function(i){var o=t[i],r=n[i];e.isPlainObject(r)?e.isPlainObject(o)?t[i]=e.deepExtend(o,r):t[i]=e.deepExtend({},r):t[i]=r})}),t},e}(),C=function(e){var t=function(n){n=e.defaults(n,t.defaultOptions),n.headers=e.defaults(n.headers,t.defaultHeaders);var i=e.param(n.params);i.length>0&&(-1===n.url.indexOf("?")&&(n.url+="?"),n.url+=i);var o=new XMLHttpRequest;o.open(n.type,n.url,!0),o.withCredentials=n.withCredentials;var r;for(r in n.headers)o.setRequestHeader(r,n.headers[r]);n.data&&"string"!=typeof n.data&&(n.data=JSON.stringify(n.data)),o.onreadystatechange=function(){if(4===o.readyState){var e=o.status>=200&&o.status<300||304===o.status;if(e){if("function"==typeof n.success){var t=o.responseText;"json"===n.dataType&&"string"==typeof t&&(t=t.length?JSON.parse(t):{}),n.success({status:o.status,response:t})}}else"function"==typeof n.failure&&n.failure({status:o.status,statusText:o.statusText,response:o.responseText})}else 0===o.readyState&&"function"==typeof n.failure&&n.failure({status:o.status,statusText:o.statusText,response:"Call aborted."})},o.send(n.data)};return t.defaultHeaders={"Content-Type":"application/json",Accept:"application/json"},t.defaultOptions={type:"GET",url:"",withCredentials:!1,dataType:"json"},t}(m),I=function(e){return function(t){function n(e){if(o&&!i[e])throw new Error("Invalid event type: "+e)}var i=[],o=!1;return e.extend(t,{define:function(e){i[e]=i[e]||[]},alias:function(e,t){n(e),i[t]=i[e]=i[e]||[]},on:function(e,t){n(e),(i[e]=i[e]||[]).push(t)},off:function(e,t){n(e);for(var o=i[e]||[],r=o.length;r--;)t===o[r]&&o.splice(r,1)},emit:function(e){n(e);for(var t=Array.prototype.slice.call(arguments,1),o=i[e]||[],r=0;r<o.length;r++)o[r].apply(void 0,t)},setStrictMode:function(e){o=e}})}}(m),v={OK:0,internalServerError:1,tokenExpired:10,permissionDenied:11,usageQuotaExceeded:12,insufficientFunds:13,validationFailed:14,missingParameter:15,invalidParameterValue:16,badParameterValue:17,unknownRequest:18,noData:19,alreadyExists:50,invalidIdentifier:51,invalidPassword:52,doesNotExist:53,invalidCountryCode:54,invalidCredentials:55,ajaxError:5e3,wsError:6e3,wsAlreadyOpened:6001,wsNotFound:6002,wsCreateError:6003,wsNotAuth:6004},R={version:"undefined"!=typeof g?g:"dev",responseCodes:JSON.parse(JSON.stringify(v)),internal:{}},A=function(){},_={info:A,warn:A,error:A,debug:A};e("warn");var D={version:0,listeners:{},kandyApiUrl:"https://api.kandy.io/v1.2",mediatorUrl:"http://service.kandy.io:8080/kandywrapper-1.0-SNAPSHOT",messageProvider:"fring",pstnOutNumber:"71",sipOutNumber:"72",allowAutoLogin:!1,kandyWSUrl:null,fcsConfig:{restPlatform:"kandy",kandyApiUrl:"https://api.kandy.io/v1.1/users/gateway",useInternalJquery:!1},spidrApi:{cors:!1,disableNotifications:null,notificationType:o.notification.NotificationTypes.WEBSOCKET,websocketProtocol:"wss",pluginMode:{mode:"auto",h264:!0,firefox:{mode:"webrtc"}},codecsToReplace:[]},spidrMedia:{pluginLogLevel:2,screenSharing:{chromeExtensionId:"daohbhpgnnlgkipndobecbmahalalhcp"}}},N=null,h=!0,b=!0,O=function(e){void 0!==e.type&&e.type||(e.type="GET"),e.url=(e.kandyApiUrl||D.kandyApiUrl)+e.url,e.params=e.params||{},e.params.key||(e.params.key=N.userAccessToken),"DELETE"!==e.type||e.data||(e.headers=e.headers||{},e.headers["Content-Type"]="text/html");var t=e.success,n=e.failure;e.success=function(e){e.response.status===v.OK?t&&t(e.response):n&&n(e.statusText,v.ajaxError)},e.failure=function(e){403===e.status||401===e.status?console.log("Unauthorized Error !!!"):426===e.status&&console.log("Kandy upgrade required!"),n&&n(e.statusText,v.ajaxError)},C(e)},L=function(e){return new r(function(t,n){e.success=t,e.failure=n,O(e)})},y=function(){try{o.logManager.initLogging(function(e,t,n){"ERROR"===n.message?window.console.log(n.message):window.console.log(n.message)},!0),_=o.logManager.getLogger("kandy_js")}catch(e){}};R.internal.initLogger=y,R.internal.kandyRequest=L;var V,M,P=function(e,t){var n=t();return e.on=n.on.bind(n),e.off=n.off.bind(n),n.define("callinitiated"),n.define("callinitiatefailed"),n.define("callincoming"),n.define("callended"),n.define("callendfailed"),n.define("callanswered"),n.define("callanswerfailed"),n.define("oncall"),n.define("callestablished"),n.define("callstatechanged"),n.define("media"),n.define("presencenotification"),n.define("loginsuccess"),n.define("loginfailed"),n.define("callrejected"),n.define("callrejectfailed"),n.define("callignored"),n.define("callignorefailed"),n.define("callhold"),n.define("calltransferred"),n.define("calltransferfailed"),n.alias("callhold","remotehold"),n.define("callunhold"),n.alias("callunhold","remoteunhold"),n.define("callscreenstopped"),n.define("onconnectionlost"),n.define("message"),n.define("messagesavailable"),n.define("chatRemoteAck"),n.define("chatGroupMessage"),n.define("chatGroupInvite"),n.define("chatGroupBoot"),n.define("chatGroupLeave"),n.define("chatGroupUpdate"),n.define("chatGroupDelete"),n}(R,I),F={},w={},k=null,U=0,W=!1;R.setup=function(t){if(t=t||{},D=m.extend(D,t),D.screenSharing&&(D.spidrMedia.screenSharing=m.extend(D.spidrMedia.screenSharing,t.screenSharing)),t.listeners)for(var n in t.listeners)t.listeners.hasOwnProperty(n)&&P.on(n,t.listeners[n]);t.hasOwnProperty("autoreconnect")&&(h=t.autoreconnect),t.hasOwnProperty("registerforcalls")&&(b=t.registerforcalls),t.hasOwnProperty("loglevel")&&e(t.loglevel),b&&H&&H(t),t.hasOwnProperty("exposeFcs")&&(R._fcs=o)},R.getUserAccessToken=T,R.getLimitedUserDetails=function(e,t,n){O({url:"/users/details/limited",params:{key:e},success:function(e){t&&t(e.result.user)},failure:n})},R.getDevices=function(e,t,n){O({url:"/users/devices",params:{key:e},success:function(e){t&&t(e.result)},failure:n})},R.getLastSeen=function(e,t,n){O({url:"/users/presence/last_seen",params:{users:e},success:function(e){t&&t(e.result)},failure:n})},R.login=function(e,t,n,i,o){var r=function(){N=null,o&&"function"==typeof o&&o()},a={client_sw_version:R.version,client_sw_type:"JS",kandy_device_id:null};T(e,t,n,function(e){var t=e.user_access_token;R.getLimitedUserDetails(t,function(o){N=o,N.userPassword=n,N.userAccessToken=t,u(function(){N.devices=[],R.getDevices(t,function(t){N.devices=t.devices,b&&x?x(function(){i&&i(e)},r):i&&i(e)},r)},r)},r)},r,a)},R.getUserDetails=function(){return N?{fullUserId:N.full_user_id,domainName:N.domain_name,userAccessToken:N.userAccessToken,email:N.user_email,firstName:N.user_first_name,lastName:N.user_last_name,userId:N.user_id,devices:N.devices}:{}},R.loginSSO=function(e,t,n,i){_.info("loginSSO is not supported for calls at the moment, unless provided with the password");var o=function(){N=null,n&&"function"==typeof n&&n()};R.getLimitedUserDetails(e,function(n){N=n,N.userAccessToken=e,N.userPassword=i,u(function(){N.devices=[],R.getDevices(e,function(e){N.devices=e.devices,b&&x?x(function(){t&&t(n)},o):t&&t(n)},o)},o)},o)},R.logout=function(e){p(),B(e)},R.reconnect=function(e,t){_.warn("Deprecated method KandyAPI.reconnet."),u(e,t)},R.Session=R.session=function(){var e={},t={},n=function(e){var n,i,o,r=0;if("sessionNotification"===e.message_type&&(e=e.payload),window.console.log("Session message recvd: "+e.message_type),n=e.message_type.replace(/^session/,"on"),i=t[e.session_id]){var a=i.length;for(r;a>r;r++)if(o=i[r],o&&o.hasOwnProperty(n))try{o[n](e)}catch(s){console.log("could not execute listner: "+s)}}};return S({sessionData:n,sessionNotification:n}),e.setListeners=function(e,n){void 0===t[e]&&(t[e]=[]),t[e].push(n)},e.create=function(e,t,n){O({type:"POST",url:"/users/sessions/session",data:e,success:function(e){t&&t(e.result)},failure:n})},e.activate=function(e,t,n){O({type:"POST",url:"/users/sessions/session/id/start",data:{session_id:e},success:function(e){t&&t()},failure:n})},e.inactivate=function(e,t,n){O({type:"POST",url:"/users/sessions/session/id/stop",data:{session_id:e},success:function(e){t&&t()},failure:n})},e.sendData=function(e,t,n,i,o){f({message_type:"sessionData",session_id:e,destination:o,payload:t},n,i)},e.terminate=function(e,t,n){O({type:"DELETE",url:"/users/sessions/session/id",data:{session_id:e},success:function(e){t&&t()},failure:n})},e.getInfoById=function(e,t,n){O({url:"/users/sessions/session/id",params:{session_id:e},success:function(e){t&&t(e.result)},failure:n})},e.getInfoByName=function(e,t,n){O({url:"/users/sessions/session/name",params:{session_name:e},success:function(e){t&&t(e.result)},failure:n})},e.getOpenSessions=function(e,t){O({url:"/users/sessions",success:function(t){e&&e(t.result)},failure:t})},e.getOpenSessionsByType=function(e,t,n){O({url:"/users/sessions/type",params:{session_type:e},success:function(e){t&&t(e.result)},failure:n})},e.getOpenSessionsCreatedByUser=function(e,t){O({url:"/users/sessions/user",success:function(t){e&&e(t.result)},failure:t})},e.join=function(e,t,n,i){var o=t||{};o.session_id=e,O({type:"POST",url:"/users/sessions/session/id/participants/participant",data:o,success:function(e){n&&n(e.result)},failure:i})},e.leave=function(e,t,n,i){O({type:"DELETE",url:"/users/sessions/session/id/participants/participant",data:{session_id:e,leave_reason:t},success:function(e){n&&n()},failure:i})},e.acceptJoinRequest=function(e,t,n,i){O({type:"POST",url:"/users/sessions/session/id/admin/participants/participant/join",data:{session_id:e,full_user_id:t},success:function(e){n&&n()},failure:i})},e.rejectJoinRequest=function(e,t,n,i,o){O({type:"DELETE",url:"/users/sessions/session/id/admin/participants/participant/join",data:{session_id:e,full_user_id:t,reject_reason:n},success:function(e){i&&i()},failure:o})},e.bootUser=function(e,t,n,i,o){O({type:"DELETE",url:"/users/sessions/session/id/admin/participants/participant",data:{session_id:e,full_user_id:t,boot_reason:n},success:function(e){i&&i()},failure:o})},e}(),R.coBrowsing=R.CoBrowse=function(){var e,t,n,i,o,r,a,s={},c=!1,d=!1,l=!0,u=!0,f=-1,p="",E="",S="",T="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAMAAAAbzM5ZAAABNVBMVEUAvuf///8AvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucBveYCuuECuuIDuN8Ett0FtdsGstcHsNUIr9MJrdEKqs0Kq80Kq84LqMoMpsgPocEQnr0RnbwSm7kWkq0XkasYj6kaiqIdhJoeg5kgf5MhfJAkdogkd4kldYcmcoMqa3oraXYsaHQwYGoxXmc0WGA1VVw1Vl06TFA7Sk07Sk48R0o8SEo+Q0Q+REU/QUE/QkNAQEBAQEFG5UD4AAAANHRSTlMAAAIEBggKHCMnKS0uNTk7PEBCSUpLU1dcX2tsbnFzdXeAhYuSk5aho63Fz9XZ29/l6uv9gq4ZTAAAAQBJREFUeAFdzmcjQmEAR/EngwzZkSSyR0aOvUe2DMoW8u/7fwRuV7r3OS9/r44xJhhpMG6Bv4wZBhbCfgwCQNSHETjbBRJeHILMRxqYsFCfJ8BUsx9VvASSLX6Urpcg1WahsstAl4V6WAN6LdTzFhC1UK8HQMJCucMWusOtFpaGBy0s5NLQ7sO3zAZAtReLe1Ca+sfHgpSB2YG68tLX3T456X0FGp35OFzcbgPHkk5hxMEQ5V6kJ1is+kUzDjA/BueSDqHPQROKj/aYJljNS/cwV0K3abiRvjehvoJh2CkqfwQdFTQpyF6tAzUejOHWH/BgbRJgptv59GhsMtEZcPoBmRFquUFm5kkAAAAASUVORK5CYII=",g=function(e){if(c!==!1)switch(e.payload.type){case"screenUpdate":I(e.payload.data);break;case"userMousePosition":N(e.payload.data);break;case"userWindowScroll":h(e.payload.data);break;case"userWindowResize":b(e.payload.data);break;case"closeCoBrowse":s.stopBrowsingAgent()}},m=function(e){if(c!==!1)switch(e.payload.type){case"agentWindowScroll":M(e.payload.data);break;case"agentMouseMove":V(e.payload.data);break;case"agentClick":y(e.payload.data);break;case"agentInputChange":k(e.payload.data);break;case"requestFullPage":U("HTML",e.full_user_id)}},C=function(e,n,i){c!==!1&&kandy.session.sendData(t,{type:e,data:n},null,null,i)},I=function(e){"undefined"!=typeof o&&null!=o||L();var t=H(e.html);if(("HTML"==e.element||"HEAD"==e.element)&&"string"==typeof e.baseURI&&!t.head.getElementsByTagName("base")[0]){var n=document.createElement("base");n.href=e.baseURI,t.head.firstChild?t.head.insertBefore(n,t.head.firstChild):t.head.appendChild(n)}if("HTML"==e.element){o.width=e.screenx+"px",o.height=e.screeny+"px",d=!0;var i=G(t);a.open(),a.write(i),a.close(),"complete"===a.readyState?(d=!1,r.scroll(e.scrollx,e.scrolly)):a.onreadystatechange=function(){"complete"===a.readyState&&(l=!1,d=!1,r.scroll(e.scrollx,e.scrolly))},R()}else if("HEAD"==e.element)a.documentElement.replaceChild(t.head.cloneNode(!0),a.head);else if("BODY"==e.element)a.documentElement.replaceChild(t.body.cloneNode(!0),a.body);else{var s=e.element.substr(1),c=a.getElementById(s);c.parentNode.replaceChild(t.getElementById(s).cloneNode(!0),c)}if("string"==typeof e.css){for(var u=a.getElementsByTagName("style"),f=0;f<u.length;f++)u[f].parentNode.removeChild(u[f]);var p=document.createElement("style");p.type="text/css",p.appendChild(document.createTextNode(e.css)),a.head.appendChild(p)}console.log(Math.floor(Date.now()/1e3)+" Changed "+e.element)},v=function(){"undefined"!=typeof r&&(r.removeEventListener("mousemove",_),r.removeEventListener("scroll",D),r.removeEventListener("click",A),r.removeEventListener("input",O))},R=function(){v(),r.addEventListener("mousemove",_),r.addEventListener("scroll",D),r.addEventListener("click",A),r.addEventListener("input",O)},A=function(e){e.preventDefault(),null!=e.target.id&&""!=e.target.id&&C("agentClick",e.target.id)},_=function(e){C("agentMouseMove",{x:e.clientX,y:e.clientY})},D=function(e){l&&!d&&C("agentWindowScroll",{x:0!=e.target.documentElement.scrollLeft?e.target.documentElement.scrollLeft:e.target.body.scrollLeft,y:0!=e.target.documentElement.scrollTop?e.target.documentElement.scrollTop:e.target.body.scrollTop}),l=!0},N=function(e){if("undefined"!=typeof i){var n=document.getElementById("coBrowsingCursor-"+t);null==n&&(n=document.createElement("img"),n.id="coBrowsingCursor-"+t,n.src=T,n.style.position="absolute",n.style.zIndex="2147483647",i.appendChild(n)),n.style.left=e.x+"px",n.style.top=e.y+"px"}},h=function(e){"undefined"!=typeof i&&(l=!1,r.scroll(e.x,e.y))},b=function(e){o.width=e.x+"px",o.height=e.y+"px"},O=function(e){var t=e.target,n={id:t.id,type:t.nodeName};switch(t.nodeName){case"INPUT":switch(t.type){case"password":for(var i="";i.length<t.value.length;)i+="*";n.value=i;break;default:n.value=t.value}break;case"SELECT":n.options={};for(var o=t.options.length-1;o>=0;o--)t.options[o].selected&&(n.options[o]=t.options[o].selected);break;case"TEXTAREA":n.value=t.value}C("agentInputChange",n)},L=function(){n.innerHTML='<div id="coBrowsingDiv-'+t+'" style="position: relative;"></div>',i=document.getElementById("coBrowsingDiv-"+t),i.innerHTML='<iframe id="coBrowsingIframe-'+t+'" sandbox="allow-same-origin allow-scripts" src="javascript:;" style="border: none;"></iframe>',o=document.getElementById("coBrowsingIframe-"+t),r=o.contentWindow,a=r.document};s.startBrowsingAgent=function(e,i){t=e,n=i,c=!0,kandy.session.setListeners(t,{onData:g}),C("requestFullPage",!0)},s.stopBrowsingAgent=function(){for(v(),i=o=r=a=null;n.firstChild;)n.removeChild(n.firstChild);t=n=null,c=!1};var y=function(e){document.getElementById(e).click()},V=function(e){var n=document.getElementById("coBrowsingCursor-"+t);null==n&&(n=document.createElement("img"),n.id="coBrowsingCursor-"+t,n.src=T,n.style.position="fixed",n.style.zIndex="2147483647",document.body.appendChild(n)),n.style.left=e.x+"px",n.style.top=e.y+"px"},M=function(e){l=!1,window.scroll(e.x,e.y)},P=function(e){C("userMousePosition",{x:e.clientX,y:e.clientY})},F=function(e){l&&C("userWindowScroll",{x:0!=e.target.documentElement.scrollLeft?e.target.documentElement.scrollLeft:e.target.body.scrollLeft,y:0!=e.target.documentElement.scrollTop?e.target.documentElement.scrollTop:e.target.body.scrollTop}),l=!0},w=function(e){C("userWindowResize",{x:window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,y:window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight})},k=function(e){var t=document.getElementById(e.id);switch(u=!1,e.type){case"INPUT":t.value=e.value;break;case"SELECT":for(var n=t.options.length-1;n>=0;n--)t.options[n].selected=e.options[n];break;case"TEXTAREA":t.value=e.value}},U=function(e,t){var n,i="string"==typeof e?e:"HTML";if("HTML"==i)n=G(document.doctype)+document.documentElement.outerHTML,n=G(H(n));else if("HEAD"==i)n=H(document.head.outerHTML).head.outerHTML;else if("BODY"==i)n=H(document.body.outerHTML).body.outerHTML;else{var o=i.substr(1);n=H(document.getElementById(o).outerHTML).getElementById(o).outerHTML}for(var r={element:i,html:n},a="",s=document.getElementsByTagName("style"),c=0;c<s.length;c++)a+=s[c].innerHTML;a===S&&"HTML"!=i||(r.css=S=a,console.log("New CSS")),"HTML"==i&&(r.screenx=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,r.screeny=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,r.scrollx=0!=document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft,r.scrolly=0!=document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop),"HTML"!=i&&"HEAD"!=i||(r.baseURI=document.baseURI),C("screenUpdate",r,t),console.log(Math.floor(Date.now()/1e3)+" Screen Sent "+i)},W=function(){document.removeEventListener("mousemove",P),document.removeEventListener("scroll",F),window.removeEventListener("resize",w),window.removeEventListener("input",Y),window.removeEventListener("change",j)},x=function(){W(),document.addEventListener("mousemove",P),document.addEventListener("scroll",F),window.addEventListener("resize",w),window.addEventListener("input",Y),window.addEventListener("change",j)},B=function(e,n){e.forEach(function(e){var n,i=0,o="",r=[];if("undefined"==typeof e.addedNodes[0]||e.addedNodes[0].id!="coBrowsingCursor-"+t){for(n="characterData"==e.type||"attributes"==e.type&&"id"==e.attributeName?e.target.parentNode:e.target;n.parentNode;){if(""!=n.id||"HTML"==n.tagName||"HEAD"==n.tagName||"BODY"==n.tagName){if("HTML"==n.tagName||"HEAD"==n.tagName||"BODY"==n.tagName)var a=n.tagName;else var a="#"+n.id;""==o&&(o=a),r.push(a)}""!=o&&i++,n=n.parentNode}if(""==o)return p="HTML",!1;if(o=="#coBrowsingCursor-"+t)return!1;if(r=r.reverse(),-1==f)console.log("First element: "+o+" ("+i+")"),f=i,p=o,E=r;else if(-1==r.indexOf(p)){console.log(o+" ("+i+") not under "+p);var s="HTML";E.forEach(function(e){return-1==r.indexOf(e)?!1:void(s=e)}),f=E.indexOf(s)+1,p=s,E=E.slice(0,f),console.log("Renegotiated top to: "+p+" ("+f+")")}}});var i=J(),o=Y();return 0!=i||0!=o?void console.log("Updated skipped, ids:"+i+" forms:"+o):("HTML"==p?(console.log("Doing a full page refresh"),U()):""!=p&&(console.log("Doing a partial page update on: "+p),U(p)),f=-1,p="",void(E=""))};s.startBrowsingUser=function(n){t=n,c=!0,kandy.session.setListeners(t,{onData:m}),J(),Y(),U(),x(),e=new MutationObserver(B),e.observe(document.body,{childList:!0,attributes:!0,characterData:!0,subtree:!0})},s.stopBrowsingUser=function(){e.disconnect(),W(),C("closeCoBrowse",!0);var n=document.getElementById("coBrowsingCursor-"+t);null!=n&&n.remove(),c=!1};var H=function(e){for(var n=["SCRIPT","STYLE"],i=new RegExp("^on","i"),o=new RegExp("^javascript:","i"),r=[],a=(new DOMParser).parseFromString(e,"text/html"),s=a.getElementsByTagName("*"),c=0;c<s.length;c++){var d=s[c];if(-1==n.indexOf(d.nodeName))for(var l=0;l<d.attributes.length;l++){var u=d.attributes[l];i.test(u.name)?d.removeAttribute(u.name):o.test(u.value)&&(u.value="")}else r.push(d)}for(var f=null,p=document.createTreeWalker(a,NodeFilter.SHOW_COMMENT,f,!1);p.nextNode();)r.push(p.currentNode);r.forEach(function(e){e.parentNode.removeChild(e)});var E=a.getElementById("coBrowsingCursor-"+t);return E&&E.parentNode&&E.parentNode.removeChild(E),a},G=function(e){if("object"==typeof e&&null!=e){if("undefined"!=typeof window.XMLSerializer)return(new window.XMLSerializer).serializeToString(e);if("undefined"!=typeof e.xml)return e.xml}return""},Y=function(){if(!u)return void(u=!0);for(var e=0,t=document.getElementsByTagName("input"),n=0;n<t.length;n++){var i=t[n];switch(i.type){case"password":for(var o="";o.length<i.value.length;)o+="*";i.defaultValue!=o&&(i.defaultValue=o,e++);break;case"checkbox":case"radio":i.defaultChecked!=i.checked&&(i.defaultChecked=i.checked,e++);break;case"reset":case"submit":case"button":break;default:i.defaultValue!=i.value&&(i.defaultValue=i.value,e++)}}for(var r=document.getElementsByTagName("select"),n=0;n<r.length;n++)for(var i=r[n],a=i.options.length-1;a>=0;a--)i.options[a].defaultSelected!=i.options[a].selected&&(i.options[a].defaultSelected=i.options[a].selected,e++);for(var s=document.getElementsByTagName("textarea"),n=0;n<s.length;n++)s[n].defaultValue!=s[n].value&&(s[n].defaultValue=s[n].value,e++);return e},j=function(e){"INPUT"!=e.target.nodeName||"radio"!=e.target.type&&"checkbox"!=e.target.type||Y()},J=function(){for(var e="uid-ui-",t=0,n=document.querySelectorAll('body *:not([id]), body *[id=""]'),i=0;i<n.length;i++){for(;null!=document.getElementById(e+t);)t++;n[i].id=e+t,t++}return n.length};return s}(),R.messaging=function(){function e(e,t,n,i,o,r,a){a=a||{};var s,c,d=a&&a.uuid||m.createUUIDv4(),l={message:{contentType:t,UUID:d,message:n,additional_data:a.additionalData}};return r?(m.extend(l.message,{group_id:e}),s="/users/chatgroups/chatgroup/messages"):(l.message.destination=e,l.messageType="chat",s="/devices/messages",c={device_id:N.devices[0].id}),O({type:"POST",url:s,params:c,data:l,success:function(e){i&&i(l.message)},failure:o}),d}function t(t,n,i,o,r,a,s){if("fring"===D.messageProvider){var c=m.createUUIDv4();return s=s||{},s.uuid=c,d.uploadFile(n,function(c){var d={mimeType:n.type,content_uuid:c,content_name:n.name,contact_display_name:s.contact_display_name};return e(t,i,d,o,r,a,s)},r)}_.error("NOT SUPPORTED"),r&&r()}function n(t,n,i,o,r,a){return n.location_latitude&&n.location_longitude&&(n.latitude=n.location_latitude,n.longitude=n.location_longitude),e(t,c.LOCATION,{mimeType:"location/utm",media_map_zoom:10,location_latitude:n.latitude,locationLatitude:n.latitude,location_longitude:n.longitude,locationLongitude:n.longitude},i,o,r,a)}function i(t,n,i,o,r,a){return e(t,c.TEXT,{mimeType:"application/json",json:JSON.stringify(n)},i,o,r,a)}function r(e,t,n,i){O({type:"PUT",url:"/users/chatgroups/chatgroup/mute",params:{mute:i,group_id:e},success:function(e){t&&t(e.result)},failure:n})}function a(e,t,n,i,o){var r={members:t,mute:o,group_id:e};O({type:"PUT",data:r,url:"/users/chatgroups/chatgroup/members/mute",success:function(e){n&&n(e.result)},failure:i})}function s(e){var t=e.message;if(t){var n=t.messageType;"chat"===n?P.emit("message",t):"groupChat"===n?P.emit("chatGroupMessage",t):"chatGroupInvite"===n?P.emit("chatGroupInvite",t):"chatGroupBoot"===n?P.emit("chatGroupBoot",t):"chatGroupLeave"===n?P.emit("chatGroupLeave",t):"chatGroupUpdate"===n?P.emit("chatGroupUpdate",t):"chatGroupDelete"===n?P.emit("chatGroupDelete",t):"chatRemoteAck"===n&&P.emit("chatRemoteAck",t)}}var c={TEXT:"text",VIDEO:"video",AUDIO:"audio",IMAGE:"image",FILE:"file",LOCATION:"location",CONTACT:"contact"},d={};return d.sendSMS=function(e,t,n,i,o){O({type:"POST",url:"/devices/smss",params:{device_id:N.devices[0].id},data:{message:{source:t,destination:e,message:{text:n}}},success:i,failure:o})},d.sendIm=function(t,n,i,r,a){if("fring"===D.messageProvider)return e(t,c.TEXT,{mimeType:"text/plain",text:n},i,r,!1,a);if("spidr"===D.messageProvider){var s=new o.im.Message;return s.primaryContact=t,s.type="A2",s.msgText=n,s.charset="UTF-8",o.im.send(s,i,r),0}},d.sendJSON=function(e,t,n,o,r){return i(e,t,n,o,!1,r)},d.sendImWithFile=function(e,n,i,o,r){return t(e,n,c.FILE,i,o,!1,r)},d.sendImWithImage=function(e,n,i,o,r){return t(e,n,c.IMAGE,i,o,!1,r)},d.sendImWithAudio=function(e,n,i,o,r){return t(e,n,c.AUDIO,i,o,!1,r)},d.sendImWithVideo=function(e,n,i,o,r){return t(e,n,c.VIDEO,i,o,!1,r)},d.sendImWithContact=function(e,n,i,o,r){if("string"==typeof r){var a=r;r={contact_display_name:a}}return t(e,n,c.CONTACT,i,o,!1,r)},d.sendImWithLocation=function(e,t,i,o,r){return n(e,t,i,o,!1,r)},d.uploadFile=function(e,t,n){var i=m.createUUIDv4(),o=new FormData;o.append("file",e,e.name);var r=new XMLHttpRequest,a=D.kandyApiUrl+"/devices/content?key="+N.userAccessToken+"&content_uuid="+encodeURIComponent(i)+"&device_id="+N.devices[0].id+"&content_type="+encodeURIComponent(e.type);return r.open("POST",a,!0),r.onload=function(){if(200===r.status){var e=JSON.parse(r.responseText);e.status===v.OK?t&&t(i):n&&n(e.message,e.status)}else n&&n("Request Error","500")},r.send(o),function(){r.abort()}},d.buildFileUrl=function(e){return D.kandyApiUrl+"/devices/content?key="+N.userAccessToken+"&content_uuid="+encodeURIComponent(e)+"&device_id="+N.devices[0].id},d.buildFileThumbnailUrl=function(e,t){return t=t||"large",D.kandyApiUrl+"/devices/content/thumbnail?key="+N.userAccessToken+"&content_uuid="+encodeURIComponent(e)+"&device_id="+N.devices[0].id+"&thumbnail_size="+t},d.getIm=function(e,t,n){_.info("Consider using the message event instead of fetching messages"),void 0===n&&(n=!0),O({url:"/devices/messages",params:{device_id:N.devices[0].id},success:function(t){if(e){if(t.result.messages.length){var i=t.result.messages.map(function(e){return e.UUID});t.result.messages=t.result.messages.map(function(e){return-1===e.UUID.indexOf("-")&&(e.UUID=[e.UUID.substring(0,8),e.UUID.substring(8,12),e.UUID.substring(12,16),e.UUID.substring(16,20),e.UUID.substring(20,e.UUID.length)].join("-")),e})}e(t.result),n&&t.result.messages.length&&d.clearIm(i)}},failure:t})},d.clearIm=function(e,t,n){for(var i=0;i<e.length;i+=10)O({type:"DELETE",url:"/devices/messages",params:{messages:e.slice(i,i+10),device_id:N.devices[0].id},failure:n})},d.getConversations=function(e,t){L({type:"GET",url:"/users/messages/conversations"}).then(function(e){return e.result.conversations}).then(e,t)},d.deleteConversations=function(e,t,n){L({type:"DELETE",url:"/users/messages/conversations/conversation",params:{conversations:e}}).then(function(){}).then(t,n)},d.getMessages=function(e,t,n,i){t=t||{};var o;"asc"===t.order?o="forward":"desc"===t.order&&(o="backward");var r={conversation_id:e,conversation_type:-1===e.indexOf("@")?"group":"single",number_of_records:t.limit,message_sequence_number:t.startSequence,timestamp:t.startTimestamp,order:o};L({type:"GET",url:"/users/messages/conversations/conversation",params:r}).then(function(e){return e.result.messages}).then(n,i)},d.deleteMessages=function(e,t,n,i){L({type:"DELETE",url:"/users/messages/conversations/conversation/messages",params:{conversation_id:e,messages:t}}).then(function(){}).then(n,i)},d.getGroups=function(e,t){O({url:"/users/chatgroups",success:function(t){e&&e(t.result)},failure:t})},d.createGroup=function(e,t,n,i){function o(t){var o={group_name:e,group_image:t};O({type:"POST",data:o,url:"/users/chatgroups",success:function(e){n&&n(e.result)},failure:i})}return t?d.uploadFile(t,function(e){o({content_name:t.name||e,content_uuid:e,file_length_bytes:t.size})},i):void o({})},d.getGroupById=function(e,t,n){O({url:"/users/chatgroups/chatgroup",params:{group_id:e},success:function(e){t&&t(e.result)},failure:n})},d.deleteGroup=function(e,t,n){O({type:"DELETE",url:"/users/chatgroups/chatgroup",params:{group_id:e},success:function(e){t&&t(e.result)},failure:n})},d.updateGroup=function(e,t,n,i,o){function r(n){
var r={group_id:e,group_name:t,group_image:n};O({type:"PUT",data:r,url:"/users/chatgroups/chatgroup",success:function(e){i&&i(e.result)},failure:o})}return n?void d.uploadFile(n,function(e){r({content_name:n.name||e,content_uuid:e,file_length_bytes:n.size})},o):void r({})},d.addGroupMembers=function(e,t,n,i){var o={members:t};O({type:"POST",url:"/users/chatgroups/chatgroup/members",params:{group_id:e},data:o,success:function(e){n&&n(e.result)},failure:i})},d.removeGroupMembers=function(e,t,n,i){O({type:"DELETE",url:"/users/chatgroups/chatgroup/members",params:{group_id:e,members:t},success:function(e){n&&n(e.result)},failure:i})},d.leaveGroup=function(e,t,n){O({type:"DELETE",url:"/users/chatgroups/chatgroup/members/membership",params:{group_id:e},success:function(e){t&&t(e.result)},failure:n})},d.muteGroup=function(e,t,n){r(e,t,n,!0)},d.unmuteGroup=function(e,t,n){r(e,t,n,!1)},d.muteGroupMembers=d.muteGroupMember=function(e,t,n,i){a(e,t,n,i,!0)},d.unmuteGroupMembers=d.unmuteGroupMember=function(e,t,n,i){a(e,t,n,i,!1)},d.sendGroupIm=function(t,n,i,o,r){return e(t,c.TEXT,{mimeType:"text/plain",text:n},i,o,!0,r)},d.sendGroupImWithFile=function(e,n,i,o,r){return t(e,n,c.FILE,i,o,!0,r)},d.sendGroupImWithImage=function(e,n,i,o,r){return t(e,n,c.IMAGE,i,o,!0,r)},d.sendGroupImWithAudio=function(e,n,i,o,r){return t(e,n,c.AUDIO,i,o,!0,r)},d.sendGroupImWithContact=function(e,n,i,o,r){return t(e,n,c.CONTACT,i,o,!0,r)},d.sendGroupImWithVideo=function(e,n,i,o,r){return t(e,n,c.VIDEO,i,o,!0,r)},d.sendGroupJSON=function(e,t,n,o,r){return i(e,t,n,o,!0,r)},d.sendGroupImWithLocation=function(e,t,i,o,r){return n(e,t,i,o,!0,r)},S({notification:s}),d}();var x,B,H;return R.Phone=R.call=R.voice=function(){function e(e){e.intraframe||(e.intraframe=setInterval(function(){e.sendIntraFrame()},5e3))}function t(e){e.intraframe&&(clearInterval(e.intraframe),delete e.intraframe)}function n(n,i){switch(i){case o.call.States.IN_CALL:n.canSendVideo()&&e(n),P.emit("oncall",n),n._remoteHold&&(P.emit("callunhold"),n._remoteHold=!1),n._established?P.emit("callstatechanged",n):(P.emit("callestablished",n),n._established=!0);break;case o.call.States.RENEGOTIATION:P.emit("callstatechanged",n);break;case o.call.States.RINGING:P.emit("ringing",n.getId());break;case o.call.States.ENDED:n&&(t(n),0===n.statusCode||void 0===n.statusCode?_.info("CALL END"):n.statusCode>=100&&n.statusCode<=300?_.error("WebRTC ERROR"):_.error("ERROR"),n.isAnonymous&&n.isOutgoing&&I.logout(),delete V[n.getId()],P.emit("callended",n));break;case o.call.States.ON_REMOTE_HOLD:n._remoteHold=!0,P.emit("callhold",n);break;case o.call.States.TRANSFERRED:P.emit("calltransferred",n);break;case o.call.States.TRANSFER_FAILURE:P.emit("calltransferfailed",n)}}function i(e){return null===e.state?void _.info("State is empty."):null===e.name?void _.info("Name is empty."):void P.emit("presencenotification",e.name,e.state,h[e.state],e.activity)}function r(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}}function a(e){return localStorage["kandyphone.userinformation"]=v+";"+N.full_user_id+";"+e,!0}function s(){return localStorage["kandyphone.userinformation"]}function c(){return localStorage.removeItem("kandyphone.userinformation"),!0}function d(e){return e.fcsApi?e.fcsApi:{notificationType:o.notification.NotificationTypes.WEBSOCKET,restUrl:e.REST_server_address,restPort:e.REST_server_port,websocketIP:e.webSocket_server_address,websocketPort:e.webSocket_server_port,websocketProtocol:e.webSocket_secure!==!1?"wss":"ws",protocol:e.REST_protocol,serverProvidedTurnCredentials:e.serverProvidedTurnCredentials}}function l(e){return e.fcsMedia?e.fcsMedia:(e.ICE_servers&&m.extend(e,{ICE_server_address:e.ICE_servers[0],ICE_server_port:""}),{iceserver:e.ICE_server_address,iceserverPort:e.ICE_server_port,webrtcdtls:e.use_DTLS})}function u(e){D.spidrApi=m.defaults(d(e),D.spidrApi),D.spidrMedia=m.defaults(l(e),D.spidrMedia),D.screenSharing&&(D.spidrMedia.screenSharing=D.screenSharing),D.screenSharingChromeExtensionId&&(D.spidrMedia.screenSharingChromeExtensionId=D.screenSharingChromeExtensionId)}function f(e){var t=e.versions;if(t){delete e.versions;var n=t.slice(0,D.version+1);m.deepExtend.apply(void 0,[e].concat(n))}return e}function p(e,t,n){f(e),u(e),o.setup(D.spidrApi),e.useProxy&&o.setKandyUAT(N.userAccessToken),o.setUserAuth(N.full_user_id,N.userPassword),o.notification.start(function(){D.allowAutoLogin&&r()&&a(N.userPassword),t()},function(e){_.error("login failed: unable to start spidr notification"),n(e)},!1)}function E(e){for(var t in V)I.endCall(t)}function T(e){e=e.message,e=e&&(e.kandyType||e.message_type),e&&"gofetch"!==e?"incomingCall"===e&&I._onIncommingCall("CALLavailable",e.call_id):P.emit("messagesavailable")}function g(e,t,i,r,a,s){function c(e){u(e.result.spidr_configuration),o.setup(D.spidrApi),o.setUserAuth(t,""),o.notification.start(function(){_.info("Notification started"),I.initMedia(function(){_.info("Call init successfully"),setTimeout(function(){o.call.startCall(i,a,r,function(e){e.onStateChange=function(t,i){e.statusCode=i,n(e,t)},e.isOutgoing=!0,e.isAnonymous=!0,V[e.getId()]=e,P.emit("callinitiated",e,r)},function(e){_.error("call failed"),P.emit("callinitiatefailed","error code: "+e)},!1,s)},100)},function(e){_.error("Call init failed"),R.logout(),P.emit("callinitiatefailed","Init media failed: "+e)})},function(){console.error("Notification failed"),P.emit("callinitiatefailed","Auth failed")},!0)}y(),O({url:"/domains/configurations/communications/spidr",params:{key:e},success:c,failure:function(){P.emit("callinitiatefailed","Failed to retrieve domain configuration"),_.error("Call Failed: Failed to retrieve domain configuration")}})}function C(e,t){O({url:"/users/configurations/communications/spidr",params:{secure:!0},success:function(t){e&&e(t.result.spidr_configuration)},failure:t})}var I={},v=null,A={INCOMING_CALL:1,OUTGOING_CALL:2},h={0:"Available",1:"Unavailable",2:"Away",3:"Out To Lunch",4:"Busy",5:"On Vacation",6:"Be Right Back",7:"On The Phone",8:"Active",9:"Inactive",10:"Pending",11:"Offline"},b={urlWin32bit:"https://kandy-portal.s3.amazonaws.com/public/plugin/3.1.509/Kandy_Plugin_3.1.509.exe",urlWin64bit:"https://kandy-portal.s3.amazonaws.com/public/plugin/3.1.509/Kandy_Plugin_3.1.509_x86_64.exe",urlMacUnix:"https://kandy-portal.s3.amazonaws.com/public/plugin/3.1.509/Kandy_Plugin_3.1.509.pkg"},V=[],M=!1,F=!1,w=null;I.MediaErrors=o.call.MediaErrors,R.internal.applySpiderConfiguration=p,x=function(e,t){C(function(n){p(n,e,t)},function(e){_.error("login failed: unable to get spidr configuration"),t()})},S({notification:T}),I.setup=function(e){_.warn("Deprecated method KandyAPI.Phone.setup use kandy.setup"),R.setup(e)},H=function(e){D=m.extend(D,e),o.notification.setOnConnectionEstablished(function(){_.info("Connection established"),P.emit("onconnectionestablished","spider")}),o.notification.setOnConnectionLost(function(){_.info("Connection Lost"),P.emit("onconnectionlost","spider")}),D.allowAutoLogin&&r()&&s()&&R.login(s().split(";")[0],s().split(";")[1],s().split(";")[2],function(){P.emit("loginsuccess",N)},function(e,t){P.emit("loginfailed",e,t)}),o.presence.onReceived=function(e){i(e)},o.call.onReceived=function(e){_.info("incoming call"),e.onStateChange=function(t){n(e,t)},e.isOutgoing=!1,V[e.getId()]=e,e.isAnonymous=-1!==e.callerNumber.indexOf("concierge"),P.emit("callincoming",e,e.isAnonymous)}},I.login=function(e,t,n){_.warn("Deprecated method KandyAPI.Phone.login use kandy.login"),R.login(e,t,n,function(){P.emit("loginsuccess",N)},function(e){P.emit("loginfailed","",e)})},I.mediaErrors=o.call.MediaErrors,I.initMedia=function(e,t,n,i){return n||i||!F?(F=!1,M=!1,i=i||{},i=m.defaults({remoteVideoContainer:i.remoteVideoContainer||D.remoteVideoContainer,localVideoContainer:i.localVideoContainer||D.localVideoContainer},D.spidrMedia),void o.call.initMedia(function(){_.info("media initiated"),M=!0,window.addEventListener("beforeunload",E),F=!0,e()},function(n){switch(n){case I.mediaErrors.WRONG_VERSION:_.error("Media Plugin Version Not Supported"),P.emit("media",{type:I.mediaErrors.WRONG_VERSION});break;case I.mediaErrors.NEW_VERSION_WARNING:_.error("New Plugin Version is available"),P.emit("media",m.extend({type:I.mediaErrors.NEW_VERSION_WARNING},b));break;case I.mediaErrors.NOT_INITIALIZED:_.error("Media couldn't be initialized"),P.emit("media",{type:I.mediaErrors.NOT_INITIALIZED});break;case I.mediaErrors.NOT_FOUND:_.error("Plugin couldn't be found!"),P.emit("media",m.extend({type:I.mediaErrors.NOT_FOUND},b));break;case I.mediaErrors.NO_SCREENSHARING_WARNING:return _.info("ScreenShare extension could not be found"),P.emit("media",{type:I.mediaErrors.NO_SCREENSHARING_WARNING}),F=!0,void e()}t(n)},i)):void e()},B=function(e){r()&&c(),o.notification.stop(function(){e&&e()},void 0,!0)},I.logout=function(e){_.info("KandyAPI.Phone.logout is deprecated use kandy.logout"),R.logout(e)},I.hasStoredLogin=function(){r()&&s()},I.isMediaInitiated=function(){return M},I.isIncoming=function(e){var t=V[e];return!t.isOutgoing},I.isOutgoing=function(e){var t=V[e];return t.isOutgoing},I.callTypes=function(){return A};for(var k in A)A.hasOwnProperty(k)&&(I.callTypes[k]=A[k]);return I.getAnonymousData=function(e){var t=_call[e];return t&&t.isAnonymous?t.callerName:null},I.callType=function(e){var t=V[e];return t.isIncoming?A.INCOMING_CALL:t.isOutgoing?A.OUTGOING_CALL:void 0},I.makeSIPCall=function(e,t,n){I.makeCall(D.sipOutNumber+e+"@"+N.domain_name,!1,t,n)},I.makePSTNCall=function(e,t,n){I.makeCall(D.pstnOutNumber+e+"@"+N.domain_name,!1,t,n)},I.makeCall=function(e,t,i,r){_.info("making voice call"),L({type:"POST",url:"/users/messages/event",params:{client_timestamp:(new Date).getTime()},data:{message:{UUID:m.createUUIDv4(),destination:e,messageType:"PRIVATE",message:{type:"WAKEUP"}}}}),I.initMedia(function(){return e===N.full_user_id?void P.emit("callinitiatefailed","You cannot call yourself"):void o.call.startCall(o.getUser(),{firstName:i},e,function(t){t.onStateChange=function(e,i){t.statusCode=i,n(t,e)},t.isOutgoing=!0,t.isAnonymous=!1,V[t.getId()]=t,P.emit("callinitiated",t,e)},function(e){_.error("call failed"),P.emit("callinitiatefailed","Start call failed: "+e)},!0,t)},function(e){_.error("call failed"),P.emit("callinitiatefailed","Init media failed: "+e)},!1,r)},I.makeAnonymousCallWithToken=function(e,t,n,i,r,a){o.setRealm(t),g(e,n,i,r,null,a)},I.makeAnonymousCall=function(e,t,n,i,o){var r={firstName:n};i=i||"anonymous@concierge.com",g(e,i,i,t,r,o)},I.rejectCall=function(e){var t=V[e];t.reject(function(){P.emit("callrejected",t)},function(e){_.info("reject failed"),P.emit("callrejectfailed",t,e)})},I.ignoreCall=function(e){var t=V[e];t.ignore(function(){P.emit("callignored",t)},function(e){P.emit("callignorefailed",t,e),_.info("ignore failed")})},I.answerCall=function(e,t,i){I.initMedia(function(){var i=V[e];i.answer(function(){P.emit("callanswered",i,i.isAnonymous),n(i,o.call.States.IN_CALL)},function(e){_.info("answer failed"),P.emit("callanswerfailed",i,e)},t)},function(e){_.info("answer failed"),P.emit("callanswerfailed")},!1,i)},I.muteCall=function(e){var t=V[e];t&&(t.mute(),t.isMuted=!0)},I.unMuteCall=function(e){var t=V[e];t&&(t.unmute(),t.isMuted=!1)},I.holdCall=function(e,t,n){var i=V[e];i&&(i.hold(t,n),i.held=!0)},I.unHoldCall=function(e,t,n){var i=V[e];i&&(i.unhold(t,n),i.held=!1)},I.startCallVideo=function(e,t,n){var i=V[e];i&&i.videoStart(t,n)},I.stopCallVideo=function(e,t,n){var i=V[e];i&&i.videoStop(t,n)},I.startScreenSharing=function(e,t,n,i){var o=V[e];o&&o.screenSharingStart(t,n,function(){P.emit("callscreenstopped",o)},i)},I.stopScreenSharing=function(e,t,n){var i=V[e];i&&i.screenSharingStop(function(){P.emit("callscreenstopped",i),t&&t()},n)},I.getMediaStream=function(e){var t=V[e];return t?t.getMediaStream():void _.warn("Invalid call Id.")},I.sendDTMF=function(e,t){var n=V[e];n&&n.sendDTMF(t)},I.transferCall=function(e,t){if(t===N.full_user_id)return void P.emit("calltransferfailed","You cannot transfer to yourself.");var n=V[e];n&&t&&I.holdCall(e,function(){_.info("Call held, now being transferred."),n.directTransfer(t,function(){_.info("Call transferred to "+t)},function(){_.info("Could not transfer call.")})},function(){_.info("Could not hold call to transfer.")})},I.endCall=function(e){var n=V[e];n&&(_.info("ending call"),n.end(function(){t(n),delete V[e],n.isAnonymous&&n.isOutgoing&&o.notification.stop(function(){},void 0,!0),P.emit("callended",n)},function(e){_.error("COULD NOT END CALL"),P.emit("callendfailed",n,e)}))},I.startLocalVideo=function(e){var t=e||D.localVideoContainer;return t?void I.initMedia(function(){o.call.getUserMedia(function(e){o.call.createStreamRenderer(e.streamURL,t,{muted:!0}),w={stream:e,container:t},_.info("Started local video stream.")},function(e){_.info("Failed to start local video.")},{audio:!1,video:!0})},function(e){_.info("Failed to start local video.")}):void _.info("No local video container specified.")},I.stopLocalVideo=function(){w?(o.call.disposeStreamRenderer(w.container),o.call.removeStreamById(w.stream.id),w=null,_.info("Local video stream stopped.")):_.info("No local video stream to stop.")},I.watchPresence=function(e,t,n){_.warn("KandyAPI.Phone.watchPresence is deprecated please use kandy.getLastSeen");o.presence.watch(e.map(function(e){return e.full_user_id}),function(){_.info("Watch presence successful"),t&&t()},function(){_.error("Watch presence error"),n&&n()})},I.updatePresence=function(e){_.warn("KandyAPI.Phone.updatePresence is deprecated please use kandy.getLastSeen"),o.getServices().presence===!0?o.presence.update(parseInt(e),function(){_.info("Presence update success")},function(){_.error("Presence update failed")}):_.error("Presence service not available for account")},I.normalizeNumber=function(e,t,n,i){O({url:"/users/services/normalize/phone_number",params:{phone_number:e,country_code:t},success:function(e){n&&n(e.result)},failure:i})},I.getSpidrConfiguration=C,I}(),R.addressBook=R.addressbook=function(){var e={};return e.searchDirectoryByPhoneNumber=function(e,t,n){O({url:"/users/directories/native/searches/phone_number",params:{search_string:e},success:function(e){t&&t(e.result.contacts)},failure:n})},e.searchDirectoryByName=function(e,t,n){O({url:"/users/directories/native/searches/name",params:{search_string:e},success:function(e){t&&t(e.result.contacts)},failure:n})},e.searchDirectoryByUsername=function(e,t,n){O({url:"/users/directories/native/searches/user_id",params:{search_string:e},success:function(e){t&&t(e.result.contacts)},failure:n})},e.searchDirectoryByUserName=e.searchDirectoryByUsername,e.searchDirectory=function(e,t,n){O({url:"/users/directories/native/search/",params:{search_string:e},success:function(e){t&&t(e.result.contacts)},failure:n})},e.retrieveDirectory=function(e,t){O({url:"/users/directories/native",success:function(t){e&&t.result&&t.result.contacts&&(t.result.contacts.forEach(function(e){e.firstName=e.user_first_name,e.lastName=e.user_last_name,e.number=e.user_phone_number,e.hintType="community",delete e.user_first_name,delete e.user_last_name}),e(t.result))},failure:t})},e.retrievePersonalAddressBook=function(e,t){O({url:"/users/addressbooks/personal",success:function(t){e&&e(t.result.contacts)},failure:t})},e.addToPersonalAddressBook=function(e,t,n){O({type:"POST",url:"/users/addressbooks/personal",data:{contact:e},success:function(e){t&&t(e.result)},failure:n})},e.removeFromPersonalAddressBook=function(e,t,n){O({type:"DELETE",url:"/users/addressbooks/personal",params:{contact_id:e},success:function(e){t&&t()},failure:n})},e.retrieveUserDeviceAddressBook=function(e,t){O({url:"/users/addressbooks/device",success:function(t){e&&e(t.result)},failure:t})},e}(),R.Registration=R.registration=function(){var e={};return e.setup=function(t){D=m.extend(D,t),e._domainAccessToken=t.domainAccessToken,_=o.logManager.getLogger()},e.retrieveCountryCode=function(t,n){O({url:"/domains/countrycodes",params:{key:e._domainAccessToken},success:function(e){t&&t(e.result)},failure:n})},e.sendValidationCode=function(t,n,i,o){O({type:"POST",url:"/domains/verifications/smss",params:{key:e._domainAccessToken},data:{user_phone_number:t,user_country_code:n},success:i,failure:o})},e.validateCode=function(t,n,i){encodeURIComponent(e._domainAccessToken);O({url:"/domains/verifications/codes",params:{key:e._domainAccessToken,validation_code:t},success:function(e){n&&n(e.result.valid)},failure:i})},e.getUserInfo=function(e,t){O({url:"/users/billing/packages/status/active",success:function(t){e&&e(t.result)},failure:t})},e.getProfileInfo=function(e,t,n,i){O({url:"/users/profiles/user_profiles/user_profile",params:{user_id:e,domain_name:t},success:function(e){n&&n(e.result)},failure:i})},e.setProfileInfo=function(e,t,n){O({type:"POST",url:"/users/profiles/user_profiles",params:{first_name:e.first_name,last_name:e.last_name,status_text:e.status_text,image_details:e.image_details,user_data:e.user_data},success:function(e){t&&t()},failure:n})},e.register=function(t,n,i){O({type:"POST",url:"/api_wrappers/registrations",params:{key:e._domainAccessToken},data:{user_phone_number:t.userPhoneNumber,user_country_code:t.userCountryCode,validation_code:t.validationCode,device_native_id:t.deviceNativeId},success:function(e){n&&n(e.result)},failure:i})},e.getConfiguration=function(e,t,n){O({url:"/api_wrappers/configurations",params:{key:e.domainApiKey,domain_api_secret:e.domainApiSecret},success:function(e){t&&t({domainName:e.result.domain_name,domainAccessToken:e.result.domain_access_token,spidrConfiguration:{restUrl:e.result.spidr_configuration.REST_server_address,restPort:e.result.spidr_configuration.REST_server_port,protocol:e.result.spidr_configuration.REST_protocol,websocketIP:e.result.spidr_configuration.webSocket_server_address,websocketPort:e.result.spidr_configuration.webSocket_server_port,spidr_env:{iceserver:"stun:"+e.result.spidr_configuration.ICE_server_address+":"+e.result.spidr_configuration.ICE_server_port,ice:"STUN stun:"+e.result.spidr_configuration.ICE_server_address+":"+e.result.spidr_configuration.ICE_server_port}}})},failure:n})},e}(),R.Phone.sendSMS=function(){return _.warn("KandyAPI.Phone.sendSMS is deprecated please use kandy.messaging.sendSMS"),R.messaging.sendSMS.apply(null,arguments)},R.Phone.sendIm=function(){return _.warn("KandyAPI.Phone.sendIm is deprecated please use kandy.messaging.sendIm"),R.messaging.sendIm.apply(null,arguments)},R.Phone.sendJSON=function(){return _.warn("KandyAPI.Phone.sendJSON is deprecated please use kandy.messaging.sendJSON"),R.messaging.sendJSON.apply(null,arguments)},R.Phone.sendImWithFile=function(){return _.warn("KandyAPI.Phone.sendImWithFile is deprecated please use kandy.messaging.sendImWithFile"),R.messaging.sendImWithFile.apply(null,arguments)},R.Phone.sendImWithImage=function(){return _.warn("KandyAPI.Phone.sendImWithImage is deprecated please use kandy.messaging.sendImWithImage"),R.messaging.sendImWithImage.apply(null,arguments)},R.Phone.sendImWithAudio=function(){return _.warn("KandyAPI.Phone.sendImWithAudio is deprecated please use kandy.messaging.sendImWithAudio"),R.messaging.sendImWithAudio.apply(null,arguments)},R.Phone.sendImWithVideo=function(){return _.warn("KandyAPI.Phone.sendImWithVideo is deprecated please use kandy.messaging.sendImWithVideo"),R.messaging.sendImWithVideo.apply(null,arguments)},R.Phone.uploadFile=function(){return _.warn("KandyAPI.Phone.uploadFile is deprecated please use kandy.messaging.uploadFile"),R.messaging.uploadFile.apply(null,arguments)},R.Phone.buildFileUrl=function(){return _.warn("KandyAPI.Phone.buildFileUrl is deprecated please use kandy.messaging.buildFileUrl"),R.messaging.buildFileUrl.apply(null,arguments)},R.Phone.buildFileThumbnailUrl=function(){return _.warn("KandyAPI.Phone.buildFileThumbnailUrl is deprecated please use kandy.messaging.buildFileThumbnailUrl"),R.messaging.buildFileThumbnailUrl.apply(null,arguments)},R.Phone.getIm=function(){return _.warn("KandyAPI.Phone.getIm is deprecated please use kandy.messaging.getIm"),R.messaging.getIm.apply(null,arguments)},R.Phone.clearIm=function(){return _.warn("KandyAPI.Phone.clearIm is deprecated please use kandy.messaging.clearIm"),R.messaging.clearIm.apply(null,arguments)},R.Phone.searchDirectoryByPhoneNumber=function(){return _.warn("KandyAPI.Phone.searchDirectoryByPhoneNumber is deprecated please use kandy.addressbook.searchDirectoryByPhoneNumber"),R.addressbook.searchDirectoryByPhoneNumber.apply(null,arguments)},R.Phone.searchDirectoryByName=function(){return _.warn("KandyAPI.Phone.searchDirectoryByName is deprecated please use kandy.addressbook.searchDirectoryByName"),R.addressbook.searchDirectoryByName.apply(null,arguments)},R.Phone.searchDirectoryByUserName=function(){return _.warn("KandyAPI.Phone.searchDirectoryByUserName is deprecated please use kandy.addressbook.searchDirectoryByUserName"),R.addressbook.searchDirectoryByUserName.apply(null,arguments)},R.Phone.searchDirectory=function(){return _.warn("KandyAPI.Phone.searchDirectory is deprecated please use kandy.addressbook.searchDirectory"),R.addressbook.searchDirectory.apply(null,arguments)},R.Phone.retrievePersonalAddressBook=function(){_.warn("KandyAPI.Phone.retrievePersonalAddressBook is deprecated please use kandy.addressbook.retrievePersonalAddressBook"),R.addressbook.retrievePersonalAddressBook.apply(null,arguments)},R.Phone.addToPersonalAddressBook=function(){return _.warn("KandyAPI.Phone.addToPersonalAddressBook is deprecated please use kandy.addressbook.addToPersonalAddressBook"),R.addressbook.addToPersonalAddressBook.apply(null,arguments)},R.Phone.removeFromPersonalAddressBook=function(){return _.warn("KandyAPI.Phone.removeFromPersonalAddressBook is deprecated please use kandy.addressbook.removeFromPersonalAddressBook"),R.addressbook.removeFromPersonalAddressBook.apply(null,arguments)},R.Phone.retrieveUserDeviceAddressBook=function(){return _.warn("KandyAPI.Phone.retrieveUserDeviceAddressBook is deprecated please use kandy.addressbook.retrieveUserDeviceAddressBook"),R.addressbook.retrieveUserDeviceAddressBook.apply(null,arguments)},R}var o=n(1),r=n(2);e.exports=i()},function(e,t,n){var i,o;!function(r,a){i=a,o="function"==typeof i?i.call(t,n,t,e):i,!(void 0!==o&&(e.exports=o))}(this,function(){function e(e){var t,i,o,r,a,s,c,d,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",u=0,f=0,p="",E=[];if(!e)return e;e=n(e+"");do t=e.charCodeAt(u++),i=e.charCodeAt(u++),o=e.charCodeAt(u++),d=t<<16|i<<8|o,r=d>>18&63,a=d>>12&63,s=d>>6&63,c=63&d,E[f++]=l.charAt(r)+l.charAt(a)+l.charAt(s)+l.charAt(c);while(u<e.length);switch(p=E.join(""),e.length%3){case 1:p=p.slice(0,-2)+"==";break;case 2:p=p.slice(0,-1)+"="}return p}function t(e){var t,n,o,r,a,s,c,d,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",u=0,f=0,p="",E=[];if(!e)return e;e+="";do r=l.indexOf(e.charAt(u++)),a=l.indexOf(e.charAt(u++)),s=l.indexOf(e.charAt(u++)),c=l.indexOf(e.charAt(u++)),d=r<<18|a<<12|s<<6|c,t=d>>16&255,n=d>>8&255,o=255&d,64==s?E[f++]=String.fromCharCode(t):64==c?E[f++]=String.fromCharCode(t,n):E[f++]=String.fromCharCode(t,n,o);while(u<e.length);return p=E.join(""),p=i(p)}function n(e){var t,n,i=e+"",o="",r=0;t=n=0,r=i.length;for(var a=0;r>a;a++){var s=i.charCodeAt(a),c=null;128>s?n++:c=s>127&&2048>s?String.fromCharCode(s>>6|192)+String.fromCharCode(63&s|128):String.fromCharCode(s>>12|224)+String.fromCharCode(s>>6&63|128)+String.fromCharCode(63&s|128),null!==c&&(n>t&&(o+=i.substring(t,n)),o+=c,t=n=a+1)}return n>t&&(o+=i.substring(t,i.length)),o}function i(e){var t=[],n=0,i=0,o=0,r=0,a=0;for(e+="";n<e.length;)o=e.charCodeAt(n),128>o?(t[i++]=String.fromCharCode(o),n++):o>191&&224>o?(r=e.charCodeAt(n+1),t[i++]=String.fromCharCode((31&o)<<6|63&r),n+=2):(r=e.charCodeAt(n+1),a=e.charCodeAt(n+2),t[i++]=String.fromCharCode((15&o)<<12|(63&r)<<6|63&a),n+=3);return t.join("")}function o(e,t){var n;for(n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}function r(e,t,n,i){i.serviceManagerMap||(i.serviceManagerMap=new m),i.serviceManagerMap.get(e)||i.serviceManagerMap.add(e,new m),i.serviceManagerMap.get(e).add(t,n)}function a(e,t,n){r(e,t,n,O)}function s(){return L.split("@")[1]}function c(){return L}function d(){return V?V:L}function l(){return F}function u(){return w}function f(){return"3.1.3"}function p(){return M}function E(e){M=e===!0}function S(){var e="";return O.protocol&&O.restUrl&&O.restPort?e+O.protocol+"://"+O.restUrl+":"+O.restPort:e}function T(e,t,n){return n===!1?S()+"/rest/version/"+(e?e:"latest")+t:R.notification?S()+"/rest/version/"+(e?e:"latest")+(R.notification.isAnonymous()?"/anonymous/":"/user/")+R.getUser()+t:S()+"/rest/version/"+(e?e:"latest")+"/user/"+R.getUser()+t}var g,m=function(){var e={},t=0;this.size=function(){return t},this.add=function(n,i){return t++,e[n]=i,this},this.get=function(t){return e[t]},this.remove=function(n){return t--,delete e[n]},this.clear=function(){var n;for(n in e)e.hasOwnProperty(n)&&delete e[n]&&t--},this.entries=function(){return e}};g&&(g.Map=m),g&&(g.extend=o),g&&(g.addToServiceList=r);var C=function(){function e(e){var t,n,i;for(t in r)if(r[t]&&r.hasOwnProperty(t))for(i=r[t].length,n=0;i>n;n++)if(r[t][n].token===e)return r[t].splice(n,1),e;return!1}function t(e,t,n,s){var c,d=i,l=!1;if("string"!=typeof e)throw new Error("First parameter must be a string topic name.");if("function"!=typeof t)throw new Error("Second parameter must be a function.");if("undefined"!=typeof n){if("number"!=typeof n)throw new Error("Priority must be a number.");if(n>i||o>n)throw new Error("Priority must be between 1-10.");d=n}return s===!0&&(l=s),r[e]||(r[e]=[]),c=(++a).toString(),r[e].push({token:c,prio:d,func:t,temp:l}),r[e].sort(function(e,t){return parseFloat(t.prio)-parseFloat(e.prio)}),c}function n(t,n){var i,o,a,s;if(0===arguments.length)throw new Error("First parameter must be a string topic name.");for(a=Array.prototype.slice.call(arguments),s=a.shift(),i=r[s],o=i?i.length:0;o--;)i[o].func.apply(null,a),i[o].temp&&e(i[o].token)}var i=10,o=1,r={},a=-1;this.publish=n,this.subscribe=t,this.unsubscribe=e},I=new C;g&&(g.GlobalBroadcaster=C);var v={WEBRTC:{PLUGIN_ID:"fcsPlugin",MEDIA_STATE:{NOT_FOUND:"notfound",SEND_RECEIVE:"sendrecv",SEND_ONLY:"sendonly",RECEIVE_ONLY:"recvonly",INACTIVE:"inactive"},RTC_SIGNALING_STATE:{STABLE:"stable",HAVE_LOCAL_OFFER:"have-local-offer",HAVE_REMOTE_OFFER:"have-remote-offer",HAVE_LOCAL_PRANSWER:"have-local-pranswer",HAVE_REMOTE_PRANSWER:"have-remote-pranswer",CLOSED:"closed"},RTC_SDP_TYPE:{OFFER:"offer",ANSWER:"answer",PRANSWER:"pranswer"},ERROR:{ICE_ICELITE:"ICE_ICELITE"}},STRING:{NEW_LINE:"\n",CARRIAGE_RETURN:"\r",VIDEO:"video",AUDIO:"audio"},SDP:{A_LINE:"a=",M_LINE:"m=",CRYPTO:"crypto",FINGERPRINT:"fingerprint",ICE_UFRAG:"ice-ufrag:",ICE_PWD:"ice-pwd:",NACK:"nack",NACKPLI:"nack pli",SETUP_ACTIVE:"a=setup:active",SETUP_PASSIVE:"a=setup:passive",SETUP_ACTPASS:"a=setup:actpass"},HTTP_METHOD:{GET:"GET",POST:"POST",PUT:"PUT",DELETE:"DELETE",OPTIONS:"OPTIONS"},WEBSOCKET:{PROTOCOL:{SECURE:"wss",NONSECURE:"ws"},DEFAULT_PORT:"8581",STATUS:{OPENED:1,ALREADY_OPENED:2,CREATE_ERROR:3,CONNECTION_ERROR:4,NOT_FOUND:5,CONNECTION_CLOSED:6}},LONG_POLLING:{STATUS:{TRIGGERED_CONNECT:1}},NOTIFICATION:{STATUS:{NOT_STARTED:3,CONFIGURATION_ERROR:4,STOP_FOR_LP_TO_WS_UPGRADE:5}},EVENT:{XHR_REQUEST_NOT_INITIALIZED:"XHR_REQUEST_NOT_INITIALIZED",DEVICE_SUBSCRIPTION_STARTED:"DEVICE_SUBSCRIPTION_STARTED",DEVICE_SUBSCRIPTION_ENDED:"DEVICE_SUBSCRIPTION_ENDED",CONNECTION_REESTABLISHED:"CONNECTION_REESTABLISHED",CONNECTION_LOST:"CONNECTION_LOST",TOKEN_AUTH_STARTED:"TOKEN_AUTH_STARTED",BASIC_AUTH_STARTED:"BASIC_AUTH_STARTED",TOKEN_NOT_FOUND:"TOKEN_NOT_FOUND",SESSION_EXPIRED:"SESSION_EXPIRED",NOTIFICATION_CHANNEL_LOST:"NOTIFICATION_CHANNEL_LOST",FCS_SETUP_COMPLETED:"FCS_SETUP_COMPLETED",WEBSOCKET_CONNECTED:"WEBSOCKET_CONNECTED",WEBSOCKET_DISCONNECTED:"WEBSOCKET_DISCONNECTED"},SUBSCRIPTION_EVENT:{TOKEN_OR_SESSION_LOSS:"TOKEN_OR_SESSION_LOSS",SUBSCRIPTION_SUCCESS:"SUBSCRIPTION_SUCCESS",EXTEND_SUCCESS:"EXTEND_SUCCESS",EXTEND_FAILURE:"EXTEND_FAILURE",REGULAR_EXTEND_PROCESSING:"REGULAR_EXTEND_PROCESSING",STOP_SUCCESS:"STOP_SUCCESS",STOP_FAILURE:"STOP_FAILURE",CONNECTION_LOSS:"CONNECTION_LOSS",SET_NOTIFICATION_ONERROR:"SET_NOTIFICATION_ONERROR",SET_NOTIFICATION_ONSUCCESS:"SET_NOTIFICATION_ONSUCCESS",TRIGGER_LONG_POLLING:"TRIGGER_LONG_POLLING",RESTART_SUBSCRIPTION_REQUEST:"RESTART_SUBSCRIPTION_REQUEST"},NOTIFICATION_EVENT:{NOTIFICATION_SUCCESS:"NOTIFICATION_SUCCESS",NOTIFICATION_FAILURE:"NOTIFICATION_FAILURE"},CACHE:{NOTIFYURL:"NotificationUrl",NOTIFYID:"NotificationId",SUBSCRIBEURL:"SubscriptionUrl",SUBSCRIBEEXPIRY:"SubscriptionExpiry",SUBSCRIBEEXTENDINTERVAL:"SubscriptionExtendInterval",USERNAME:"USERNAME",PASSWORD:"PASSWORD",SESSION:"SESSION"},TIMEOUT:{INTERVAL_TO_PREVENT_CONFLICTS:5e3,DEFAULT_CONNECTIVITY_CHECK_INTERVAL:1e4}};g&&(g.CONSTANTS=v);var R,R,A=function(e){function t(){return B.getLogger("jQrestful")}function n(e,t,n,i){var o=e;return i&&(o.data=i),n&&(o.errorThrown=n),t&&(o.status=t.status,o.statusText=t.statusText,o.responseText=t.responseText,o.readyState=t.readyState),o}function i(e,n){var i,o;switch(t().error("parseError:'"+n+"' Status:'"+e.status+"' ResponseText:'"+e.responseText+"'"),e.responseText&&-1!==e.responseText.search("statusCode")&&(void 0!==JSON.parse(e.responseText).subscribeResponse?o=JSON.parse(e.responseText).subscribeResponse.statusCode:void 0!==JSON.parse(e.responseText).authorizationResponse&&(o=JSON.parse(e.responseText).authorizationResponse.statusCode)),o=o?o:e.status){case 401:i=R.Errors.AUTH;break;case 403:i=R.Errors.INCORRECT_LOGIN_PASS;break;case 19:i=R.Errors.LOGIN_LIMIT_CLIENT;break;case 20:i=R.Errors.LOGIN_LIMIT_TABLET;break;case 44:i=R.Errors.FORCE_LOGOUT_ERROR;break;case 46:i=R.Errors.TOKEN_NOT_FOUND;break;case 47:i=R.Errors.SESSION_EXPIRED;break;default:i=R.Errors.NETWORK}return i}function r(e,n,i){return t().error("parseErrorStatusCode:'"+n+"' Status:'"+e.status+"' ResponseText:'"+e.responseText+"'"),e.responseText&&-1!==e.responseText.search("statusCode")&&void 0!==JSON.parse(e.responseText)[i]?JSON.parse(e.responseText)[i].statusCode:401===e.status||403===e.status?e.status:400}var a=3e4,s=4e4,c={REQUEST_NOT_INITIALIZED:0,REQUEST_DONE:4};this.call=function(d,l,u,f,p,E,S,T){function g(e){try{L=e.status>=200&&e.status<300||304===e.status}catch(t){return t instanceof Error&&"Could not complete the operation due to error c00c023f."===t.description&&F.trace("Ajax request aborted internally. not calling failure callback"),-1}return L}var m,C,I,A,_,D,N,h,b,L,y,V=s,M=l.url,P=M.split("/rest/version/")[1],F=t();l&&l.data&&(m=l.data),O.polling&&(V=1e3*O.polling,V+=O.longpollingTolerans?O.longpollingTolerans:a),P&&-1===P.indexOf("isAlive")&&(C=P.split("/")[3],C||(C=M.substring(M.lastIndexOf("/")+1,M.length)),C=C.split("?")[0],m&&!m.imRequest?F.info("Send ajax request: "+C,m):F.info("Send ajax request: "+C)),"GET"===d&&(A=q.serialize(m),A.length>0&&(M+=-1===M.indexOf("?")?"?"+A:"&"+A),m=null),I=new XMLHttpRequest,I.onload=function(){h(I)},I.onabort=function(){F.trace("Ajax request aborted internally. not calling failure callback")},I.onerror=function(){F.error("Ajax request error! Handle the error"),b(I)},O.ajaxHook&&(y=q.callFunctionIfExist(O.ajaxHook,I,window,{type:d,url:M,headers:T,data:m}),y&&(M=y.url?y.url:M,T=y.headers?y.headers:T)),I.open(d,M,R.isAsync()),R.isAsync()&&(I.withCredentials=!!O.cors,I.timeout=V),_={"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},_=o(_,T);for(D in _)_.hasOwnProperty(D)&&I.setRequestHeader(D,_[D]);return"string"!=typeof m&&(m=JSON.stringify(m)),I.send(m),N={type:d,url:M,dataType:"json",async:R.isAsync(),jsonp:!1,crossDomain:!!O.cors,timeout:V},h=function(e){if(e.readyState===c.REQUEST_DONE){if(L=g(e),-1===L)return;if(!L)return void b(e);var t={};try{"string"==typeof e.responseText&&e.responseText.length&&(t=JSON.parse(e.responseText)),"string"==typeof e.responseURL&&-1===e.responseURL.indexOf("isAlive")&&F.info("ajax success: "+e.status+" "+e.statusText,n(N,e,void 0,t));
}catch(i){return i instanceof SyntaxError?F.error("Failed to parse json ajax response into object:"+e.responseText,n(N,e,void 0,t)):F.error("Unknown error:"+e.status+" "+e.statusText,n(N,e,void 0,t)),void b(e)}p&&"function"==typeof p&&(t=p(t)),u&&"function"==typeof u&&u(t)}},b=function(t){return F.error("ajax error: "+t.status+" "+t.statusText,n(N,t,t.statusText)),410===t.status?(F.error("410 Gone received"),void q.callFunctionIfExist(R.notification.onGoneReceived)):(t.readyState===c.REQUEST_NOT_INITIALIZED&&(e.publish(v.EVENT.XHR_REQUEST_NOT_INITIALIZED),F.debug("Ajax request cannot be sent, this is a connection problem.")),void(f&&"function"==typeof f?f("addressBookResponse"===S?r(t,t.statusText,S):E&&"function"==typeof E?E(t,t.statusText):i(t,t.statusText)):F.trace("Error handler is not defined or not a function")))},R.isAsync()?4===I.readyState?setTimeout(function(){h(I)}):I.onreadystatechange=function(){-1===g(I)}:h(I),I}},_=function(e){return new A(e||I)},D=new _,N=function(t,n){function i(e){p=e.session}function o(){p=null}function r(e){l=e.username}function a(e){l=e.username,f=e.password,E=e.authname}function s(t){return t||(t={}),t.Accept||(t.Accept="application/json"),t["Content-Type"]||(t["Content-Type"]="application/json"),u()||(p?(t["x-session"]=p,delete t.Authorization):(E&&f?t.Authorization="basic "+e(E+":"+f):l&&f&&(t.Authorization="basic "+e(l+":"+f)),delete t["x-session"])),t}function c(e,i,o,r,a,s,c,d){var l=function(e){e===R.Errors.TOKEN_NOT_FOUND?(n.publish(v.EVENT.TOKEN_NOT_FOUND),p=null):e===R.Errors.SESSION_EXPIRED&&(n.publish(v.EVENT.SESSION_EXPIRED),p=null),r&&"function"==typeof r&&r(e)},f=u();return f&&(-1===i.url.indexOf("?")?i.url+="?key="+f:i.url+="&key="+f),t.call(e,i,o,l,a,s,c,d)}function d(e,t,n,i,o,r,a,s){return a||(a={}),a.Accept||(a.Accept="application/json"),a["Content-Type"]||(a["Content-Type"]="application/json"),a["x-session"]&&delete a["x-session"],a.Authorization&&delete a.Authorization,a["x-token"]||(a["x-token"]=s),c(T,e,t,n,i,o,r,a)}var l,f,p,E,S="PUT",T="POST",g="GET",m="DELETE";this.call=function(e,t,n,i,o,r,a,d){return d=s(d),c(e,t,n,i,o,r,a,d)},this.sendPostRequest=function(e,t,n,i,o,r,a,l){return l?d(e,t,n,i,o,r,a,l):(a=s(a),c(T,e,t,n,i,o,r,a))},this.sendGetRequest=function(e,t,n,i,o,r,a){return a=s(a),c(g,e,t,n,i,o,r,a)},this.sendDeleteRequest=function(e,t,n,i,o,r,a){return a=s(a),c(m,e,t,n,i,o,r,a)},this.sendPutRequest=function(e,t,n,i,o,r,a){return a=s(a),c(S,e,t,n,i,o,r,a)},n.subscribe(v.EVENT.TOKEN_AUTH_STARTED,r,9),n.subscribe(v.EVENT.BASIC_AUTH_STARTED,a,10),n.subscribe(v.EVENT.DEVICE_SUBSCRIPTION_STARTED,i),n.subscribe(v.EVENT.DEVICE_SUBSCRIPTION_ENDED,o)},h=function(e,t){return new N(e||D,t||I)},b=new h,O={polling:30,iceCandidateCollectionTimeoutInterval:3e3,codecsToReplace:[{name:"opus",value:"109"}],pluginMode:{mode:"auto"}},L=null,y=null,V=null,M=!0,P=null,F=null,w=null,k=function(e,t,n){var i=null,o=null,r={},a=!0;this.isAsync=function(){return a},this.setAsync=function(e){a=e},this.getUser=c,this.getAuthUser=d,this.getDomain=s,this.getVersion=f,this.getDevice=function(){return i},this.setUserAuth=function(e,n,o){L=e,y=n,i=null;var r={username:e,password:n};"string"==typeof o&&o.trim().length>0?(r.authname=o,V=o):V=null,t.publish(v.EVENT.BASIC_AUTH_STARTED,r)},this.setTokenAuth=function(e,n){L=e,P=n,t.publish(v.EVENT.TOKEN_AUTH_STARTED,{username:e,token:n})},this.setDeviceAuth=function(e){i=e,L=null},this.setRealm=function(e){F=e},this.setKandyUAT=function(e){w=e},this.AuthenticationType={USER:1,DEVICE:2},this.Errors={NETWORK:1,AUTH:2,STATE:3,PRIV:4,UNKNOWN:9,LOGIN_LIMIT_CLIENT:10,INCORRECT_LOGIN_PASS:11,INVALID_LOGIN:12,FORCE_LOGOUT_ERROR:13,LOGIN_LIMIT_TABLET:14,TOKEN_NOT_FOUND:15,SESSION_EXPIRED:16,VIDEO_SESSION_NOT_AVAILABLE:17,PENDING_REQUEST:18,NOT_ALLOWED_SERVICE:19,NOT_ALLOWED_METHOD:20,NOT_ALLOWED_INSTANCE:21,INVALID_PARAMETER:22,CONNECTION_ISSUE:23,MEDIA_NOT_FOUND:24,MEDIA_NOT_ALLOWED:25,CALL_FAILED:26,CALL_ENDED:27},this.setup=function(e){var t;for(t in e)e.hasOwnProperty(t)&&(O[t]=e[t])},this.setPluginVersion=function(e){o=e},this.getPluginVersion=function(){return o},this.getServices=function(){return r},this.setServices=function(e){var t;if(e)for(t=0;t<e.length;t++)switch(e[t]){case"CallDisplay":r.callDisplay=!0;break;case"CallDisposition":r.callDisposition=!0;break;case"RestfulClient":r.restfulClient=!0;break;case"call":r.callControl=!0,r.remoteCallControl=!1;break;case"CallControl":r.callControl=!0,r.remoteCallControl=!1;break;case"RCC":r.callControl=!1,r.remoteCallControl=!0;break;case"CallMe":r.callMe=!0;break;case"Directory":r.directory=!0;break;case"ClickToCall":r.clickToCall=!0;break;case"Presence":r.presence=!0;break;case"AddressBook":r.contacts=!0;break;case"CallLog":r.history=!0;break;case"Custom":r.custom=!0;break;case"IM":r.IM=!0;break;case"Route":r.routes=!0}},this.getUserLocale=function(t,n){e.sendGetRequest({url:T(1,"/localization",!1)},function(e){q.callFunctionIfExist(t,e)},n)},this.isConnected=p},U=function(e,t,n){return new k(e||b,t||I,n||window)};R=new U,window.fcs=R,R.fcsConfig=O,g&&(g.Core=U);var W=function(){function e(e){function t(e,t,i){if(n){var a={};if(a.user=c(),a.timestamp=(new Date).getTime(),a.logger=r,a.level=e,a.message=t,a.args=i,o)try{o(a.logger,a.level,a)}catch(s){return}}return!1}var r=e;this.getName=function(){return r},this.trace=function(e,n){return t(i.TRACE,e,n)},this.debug=function(e,n){return t(i.DEBUG,e,n)},this.info=function(e,n){return t(i.INFO,e,n)},this.warn=function(e,n){return t(i.WARN,e,n)},this.error=function(e,n){return t(i.ERROR,e,n)},this.fatal=function(e,n){return t(i.FATAL,e,n)}}var t={},n=!1,i={OFF:"OFF",FATAL:"FATAL",ERROR:"ERROR",WARN:"WARN",INFO:"INFO",DEBUG:"DEBUG",TRACE:"TRACE",ALL:"ALL"},o=null;this.initLogging=function(e,t){return e&&"function"==typeof e?(o=e,n=t===!0,!0):!1},this.Level=i,this.isEnabled=function(){return n},this.getLogger=function(n){var i,o;return o=n&&0!==n.trim().length?n:"Default",t[o]?i=t[o]:(i=new e(o),t[i.getName()]=i),i}},x=function(){return new W};g&&(g.LogManager=x);var B=new x;R.logManager=B;var H=function(e,t,n){var i,o,r,a=e.getLogger("ServiceInvokeManager"),s=null,c=null,d=null;this.invoke=function(e,l,u,f,p){function E(e){return a.error("Service mapping error : "+e),"function"==typeof r?void r({errorText:e}):void 0}if(o=f,r=p,"object"!=typeof u||null===u){if(a.info("Data parameter not object!"),u)return a.error("Wrong parameter for data object "+u+" .The process cannot be made"),void E(n.INVALID_PARAMETER);u={},a.info("Data parameter undefined.Created object for data parameter.")}return i=u.serviceName?u.serviceName:"spidr",(s=t.serviceManagerMap.get(e))?"string"!=typeof i?void E(n.NOT_ALLOWED_SERVICE):(d=s.get(i))?(c=d[l])?(a.debug("Called Invoke Method - instance : "+e+" service : "+i+" method : "+l),c(u,o,r)):void E(n.NOT_ALLOWED_METHOD):void E(n.NOT_ALLOWED_SERVICE):void E(n.NOT_ALLOWED_INSTANCE)}},G=new H(B,O,R.Errors);g&&(g.ServiceInvokeManager=H);var Y=function(){var e,t=function(){var e,t,n,i,o,r={},a=document.cookie,s=0;if(""===a)return r;for(e=a.split("; ");s<e.length;s+=1)t=e[s],n=t.indexOf("="),i=t.substring(0,n),o=t.substring(n+1),o=decodeURIComponent(o),r[i]=o;return r}(),n=[];for(e in t)t.hasOwnProperty(e)&&n.push(e);this.length=n.length,this.key=function(e){return 0>e||e>=n.length?null:n[e]},this.getItem=function(e){if(1!==arguments.length)throw new Error("Provide one argument");return t[e]||null},this.setItem=function(e,i){if(2!==arguments.length)throw new Error("Provide two arguments");void 0===t[e]&&(n.push(e),this.length++),t[e]=i;var o=e+"="+encodeURIComponent(i),r=new Date,a=new Date(r.getTime()+2592e6);o+="; max-age="+a,o+="; path=/",document.cookie=o},this.removeItem=function(e){if(1!==arguments.length)throw new Error("Provide one argument");var i,o=0;if(void 0!==t[e]){for(delete t[e],i=n.length;i>o;o+=1)if(n[o]===e){n.splice(o,1);break}this.length--,document.cookie=e+"=; max-age=0"}},this.clear=function(){for(var e=0;e<n.length;e++)document.cookie=n[e]+"=; max-age=0";t={},n=[],this.length=0}};g&&(g.CookieStorage=Y);var j="undefined"!=typeof window.localStorage?window.localStorage:new Y;window.cache=j;var J=function(e){var t=e.getLogger("utils");this.getProperty=function(e,t){return"undefined"==typeof e[t]?null:e[t]},this.callFunctionIfExist=function(){var e,n=Array.prototype.slice.call(arguments);if(e=n.shift(),"function"==typeof e)try{return e.apply(null,n)}catch(i){t.error("Exception occured:\n"+i.stack)}else t.info("Not a function:"+e)},this.compose=function(e,t){var n;for(n in e)"function"!=typeof e[n]||t[n]||(t[n]=e[n].bind(e))},this.getTimestamp=function(){return(new Date).getTime()},this.Queue=function(){var e;this.enqueue=function(t){"undefined"==typeof e&&(e=[]),e.push(t)},this.dequeue=function(){return e.shift()},this.peek=function(){return e[0]},this.size=function(){return"undefined"==typeof e?0:e.length}},this.getQueue=function(){return new this.Queue},this.serialize=function(e){var t,n="";for(t in e)e.hasOwnProperty(t)&&(n.length>0&&(n+="&"),n+=encodeURI(t+"="+e[t]));return n}};Function.prototype.bind||(Function.prototype.bind=function(e){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var t=Array.prototype.slice.call(arguments,1),n=this,i=function(){},o=function(){return n.apply(this instanceof i&&e?this:e,t.concat(Array.prototype.slice.call(arguments)))};return i.prototype=this.prototype,o.prototype=new i,o});var q=new J(B);g&&(g.UtilsQueue=q.Queue);var K=function(n,i){var o=this,r="JSL/VHVybkNyZWRlbnRpYWxz";o.get=function(){return JSON.parse(t(n.getItem(r)))},o.save=function(t){n.setItem(r,e(JSON.stringify(t))),i.callFunctionIfExist(o.onCredentialsReceived)},o.remove=function(){n.removeItem(r)}},z=new K(j,q),Q=function(e,t,n){function i(e,t,i){var o;if(null!==e&&void 0!==e)return(o=e.match(/m=audio [\w\W]*?(\r|\n)/))?(o=o[0].split(" "),o.shift(),o.shift(),o.shift(),-1===o.indexOf(t)?e:-1!==e.indexOf(i)?e:(e=e.split(n.SDP.M_LINE+n.STRING.VIDEO),e[0]=e[0]+i+s+a,e=e[1]?e[0]+n.SDP.M_LINE+n.STRING.VIDEO+e[1]:e[0])):e}var o,r=e.getLogger("sdpParser"),a="\n",s="\r";this.init=function(e){o=this,o.sessionDescription={},o.mediaDescriptions=[],o.sdp=e,o.parseSDP(),o.setSessionDescriptionAttributes(),o.setMediaDescriptionsAttributes()},this.parseSDP=function(){var e,t=[],n=1;for(t=o.sdp.split(/^(?=m=)/m),o.sessionDescription.data=t[0],n;n<t.length;n++)e={},e.data=t[n],o.mediaDescriptions.push(e)},this.setSessionDescriptionAttributes=function(){var e,t=0,n=o.sessionDescription.data.split(/\r\n|\r|\n/);for(t;t<n.length;t++)n[t].match("^e=")?o.sessionDescription.email=n[t].split("=")[1]:n[t].match("^c=")&&(e=n[t].split("=")[1],o.sessionDescription.connection=e,o.sessionDescription.ip=e.split(" ")[2])},this.setMediaDescriptionsAttributes=function(){var e,t,n,i,r=0;for(e in o.mediaDescriptions)if(o.mediaDescriptions.hasOwnProperty(e)){t=o.mediaDescriptions[e].data.split(/\r\n|\r|\n/),this.mediaDescriptions[e].direction="sendrecv";for(r in t)t.hasOwnProperty(r)&&(t[r].match("^m=")?(n=t[r].split("=")[1],o.mediaDescriptions[e].media=n,o.mediaDescriptions[e].port=n.split(" ")[1]):t[r].match("^a=sendrecv")||t[r].match("^a=sendonly")||t[r].match("^a=recvonly")||t[r].match("^a=inactive")?o.mediaDescriptions[e].direction=t[r].split("=")[1]:t[r].match("^c=")&&(i=t[r].split("=")[1],o.mediaDescriptions[e].connection=i,o.mediaDescriptions[e].ip=i.split(" ")[2]))}},this.isHold=function(e){var t,n,i=!1,r=0;for(r in o.mediaDescriptions)if(o.mediaDescriptions.hasOwnProperty(r)&&(n=this.mediaDescriptions[r],n.ip?t=n.ip:o.sessionDescription.ip&&(t=o.sessionDescription.ip),0!==n.port)){if(!("inactive"===n.direction||"sendonly"===n.direction&&e||"recvonly"===n.direction&&!e||"0.0.0.0"===t)){i=!1;break}i=!0}return i},this.isRemoteHold=function(){return this.isHold(!0)},this.isLocalHold=function(){return this.isHold(!1)},this.getSessionDescription=function(){return o.sessionDescription},this.getMediaDescriptions=function(){return o.mediaDescriptions},this.isSdpHas=function(e,t){var i=!1;return null===e||void 0===e?i:-1!==e.indexOf(n.SDP.M_LINE+t)?i=!0:i},this.isSdpHasAudio=function(e){return this.isSdpHas(e,n.STRING.AUDIO)},this.isSdpHasVideo=function(e){return this.isSdpHas(e,n.STRING.VIDEO)},this.isSdpHasUfrag=function(e){var t=!1;return null===e||void 0===e?t:-1!==e.indexOf(n.SDP.A_LINE+n.SDP.ICE_UFRAG)?t=!0:t},this.isSdpHasMediaWithExpectedPort=function(e,t,i){return null===e||void 0===e?!1:-1!==e.indexOf(n.SDP.M_LINE+t+" "+i)},this.isSdpHasAudioWithZeroPort=function(e){return this.isSdpHasMediaWithExpectedPort(e,n.STRING.AUDIO,0)},this.isSdpHasVideoWithZeroPort=function(e){return this.isSdpHasMediaWithExpectedPort(e,n.STRING.VIDEO,0)},this.isSdpHasAudioWithOnePort=function(e){return this.isSdpHasMediaWithExpectedPort(e,n.STRING.AUDIO,1)},this.isSdpHasVideoWithOnePort=function(e){return this.isSdpHasMediaWithExpectedPort(e,n.STRING.VIDEO,1)},this.isSdpHasAudioWithNinePort=function(e){return this.isSdpHasMediaWithExpectedPort(e,n.STRING.AUDIO,9)},this.isSdpHasVideoWithNinePort=function(e){return this.isSdpHasMediaWithExpectedPort(e,n.STRING.VIDEO,9)},this.replaceZeroVideoPortWithOne=function(e){return null===e||void 0===e?e:(this.isSdpHasVideoWithZeroPort(e)&&(e=e.replace(n.SDP.M_LINE+n.STRING.VIDEO+" 0 ",n.SDP.M_LINE+n.STRING.VIDEO+" 1 ")),e)},this.getSdpDirection=function(e,t){var i,o,a="",s=[],c=n.WEBRTC.MEDIA_STATE.INACTIVE;if(o=function(e){r.info("getSdpDirection: type= "+t+" state= "+e)},!this.isSdpHas(e,t))return o(c),c;if(this.isSdpHasMediaWithExpectedPort(e,t,0))return o(c),c;for(s=e.split(/^(?=m=)/m),i=0;i<s.length;i++)if(a=s[i],-1!==a.indexOf(n.SDP.M_LINE+t))return-1!==a.indexOf(n.SDP.A_LINE+n.WEBRTC.MEDIA_STATE.SEND_RECEIVE)?(c=n.WEBRTC.MEDIA_STATE.SEND_RECEIVE,o(c),c):-1!==a.indexOf(n.SDP.A_LINE+n.WEBRTC.MEDIA_STATE.SEND_ONLY)?(c=n.WEBRTC.MEDIA_STATE.SEND_ONLY,o(c),c):-1!==a.indexOf(n.SDP.A_LINE+n.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)?(c=n.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,o(c),c):-1!==a.indexOf(n.SDP.A_LINE+n.WEBRTC.MEDIA_STATE.INACTIVE)?(o(c),c):c=n.WEBRTC.MEDIA_STATE.SEND_RECEIVE;return c=n.WEBRTC.MEDIA_STATE.NOT_FOUND,o(c),c},this.getAudioSdpDirection=function(e){return this.getSdpDirection(e,n.STRING.AUDIO)},this.getVideoSdpDirection=function(e){return this.getSdpDirection(e,n.STRING.VIDEO)},this.isAudioSdpDirectionInactive=function(e){return this.getAudioSdpDirection(e)===n.WEBRTC.MEDIA_STATE.INACTIVE},this.isAudioSdpDirectionSendrecv=function(e){return this.getAudioSdpDirection(e)===n.WEBRTC.MEDIA_STATE.SEND_RECEIVE},this.isAudioSdpDirectionSendonly=function(e){return this.getAudioSdpDirection(e)===n.WEBRTC.MEDIA_STATE.SEND_ONLY},this.isAudioSdpDirectionRecvonly=function(e){return this.getAudioSdpDirection(e)===n.WEBRTC.MEDIA_STATE.RECEIVE_ONLY},this.isSdpContainsAudioDirection=function(e){return this.getAudioSdpDirection(e)!==n.WEBRTC.MEDIA_STATE.NOT_FOUND},this.isVideoSdpDirectionInactive=function(e){return this.getVideoSdpDirection(e)===n.WEBRTC.MEDIA_STATE.INACTIVE},this.isVideoSdpDirectionSendrecv=function(e){return this.getVideoSdpDirection(e)===n.WEBRTC.MEDIA_STATE.SEND_RECEIVE},this.isVideoSdpDirectionSendonly=function(e){return this.getVideoSdpDirection(e)===n.WEBRTC.MEDIA_STATE.SEND_ONLY},this.isVideoSdpDirectionRecvonly=function(e){return this.getVideoSdpDirection(e)===n.WEBRTC.MEDIA_STATE.RECEIVE_ONLY},this.isSdpContainsVideoDirection=function(e){return this.getVideoSdpDirection(e)!==n.WEBRTC.MEDIA_STATE.NOT_FOUND},this.changeDirection=function(e,t,i,o){var a,s,c="",d=[],l="changeDirection: before= "+t+" after= "+i;if(t===i)return e;if(void 0===o||null===o)r.info(l+" for all media types");else{if(t!==this.getSdpDirection(e,o))return e;r.info(l+" type= "+o)}for(d=e.split(/^(?=m=)/m),s=0;s<d.length;s++)a=d[s],void 0!==o&&null!==o&&-1===a.indexOf(n.SDP.M_LINE+o)||(a=a.replace(n.SDP.A_LINE+t,n.SDP.A_LINE+i)),c+=a;return c},this.updateSdpDirection=function(e,t,n){r.info("updateSdpDirection: type= "+t+" direction= "+n);var i=this.getSdpDirection(e,t);return this.changeDirection(e,i,n,t)},this.updateAudioSdpDirection=function(e,t){r.info("updateSdpDirection: type= "+n.STRING.AUDIO+" direction= "+t);var i=this.getSdpDirection(e,n.STRING.AUDIO);return this.changeDirection(e,i,t,n.STRING.AUDIO)},this.updateVideoSdpDirection=function(e,t){r.info("updateSdpDirection: type= "+n.STRING.VIDEO+" direction= "+t);var i=this.getSdpDirection(e,n.STRING.VIDEO);return this.changeDirection(e,i,t,n.STRING.VIDEO)},this.updateAudioSdpDirectionToInactive=function(e){return this.updateAudioSdpDirection(e,n.WEBRTC.MEDIA_STATE.INACTIVE)},this.updateVideoSdpDirectionToInactive=function(e){return this.updateVideoSdpDirection(e,n.WEBRTC.MEDIA_STATE.INACTIVE)},this.isSdpHasDirection=function(e){var t,i,o,r;return null===e||void 0===e?!1:(t=e.indexOf(n.SDP.A_LINE+n.WEBRTC.MEDIA_STATE.SEND_RECEIVE,0),i=e.indexOf(n.SDP.A_LINE+n.WEBRTC.MEDIA_STATE.SEND_ONLY,0),o=e.indexOf(n.SDP.A_LINE+n.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,0),r=e.indexOf(n.SDP.A_LINE+n.WEBRTC.MEDIA_STATE.INACTIVE,0),t+1+(i+1)+(o+1)+(r+1)!==0)},this.isSdpEnabled=function(e,t){var i,o="isSdpEnabled for type "+t+": ",a=!1;return null===e||void 0===e?!1:this.isSdpHasMediaWithExpectedPort(e,t,0)?(r.info(o+a),a):t===n.STRING.VIDEO&&(i=this.getVideoSdpDirection(e),i===n.WEBRTC.MEDIA_STATE.RECEIVE_ONLY||i===n.WEBRTC.MEDIA_STATE.INACTIVE)?(r.info(o+a),a):(this.isSdpHas(e,t)&&(a=!0),r.info(o+a),a)},this.isAudioSdpEnabled=function(e){return this.isSdpEnabled(e,n.STRING.AUDIO)},this.isVideoSdpEnabled=function(e){return this.isSdpEnabled(e,n.STRING.VIDEO)},this.isSdpVideoReceiveEnabled=function(e){var t,i="isSdpVideoReceiveEnabled: ",o=!1;return null===e||void 0===e?!1:-1!==e.indexOf(n.SDP.M_LINE+n.STRING.VIDEO+" 0")?(r.info(i+o),o):(t=this.getVideoSdpDirection(e),t===n.WEBRTC.MEDIA_STATE.SEND_ONLY||t===n.WEBRTC.MEDIA_STATE.INACTIVE?(r.info(i+o),o):-1!==e.indexOf(n.SDP.M_LINE+n.STRING.VIDEO)?(o=!0,r.info(i+o),o):(r.info(i+o),o))},this.updateH264Level=function(e){var t,i,o,r,a,s="",c="",d=[],l=/\r\n|\r|\n/m,u="";for(d=e.split(/^(?=m=)/m),t=0;t<d.length;t++){if(c=d[t],-1!==c.indexOf(n.SDP.M_LINE+n.STRING.VIDEO)){for(i=c.split(l),o=0;o<i.length;o++)r=i[o],r&&-1!==r.indexOf("a=rtpmap:")&&-1!==r.indexOf("H264")?(a=r.split(/\:| /m),r=r+n.STRING.CARRIAGE_RETURN+n.STRING.NEW_LINE,r=r+"a=fmtp:"+a[1]+" profile-level-id=428014;",r=r+n.STRING.CARRIAGE_RETURN+n.STRING.NEW_LINE):r&&""!==r&&(r=r+n.STRING.CARRIAGE_RETURN+n.STRING.NEW_LINE),u+=r;c=u}s+=c}return s},this.updateH264LevelTo42E01F=function(e,t){return null===e||void 0===e?e:(t&&(r.debug("Updating the H264 profile-level-id to 42e01f"),e=e.replace(/profile-level-id=4280/g,"profile-level-id=42e0")),e)},this.isSdpVideoCandidateEnabled=function(e){var t="isSdpVideoCandidateEnabled: ",n=!1;return this.isSdpHasVideoWithZeroPort(e)||this.isVideoSdpDirectionInactive(e)?(r.info(t+n),n):this.isSdpHasVideo(e)?(r.info(t+n),n):(n=!0,r.info(t+n),!0)},this.deleteFingerprintFromSdp=function(e,t){if(null===e||void 0===e)return e;if(t)return e;for(;-1!==e.indexOf("a=fingerprint:");)e=e.replace(/(a=fingerprint:[\w\W]*?(:\r|\n))/,"");for(;-1!==e.indexOf("a=setup:");)e=e.replace(/(a=setup:[\w\W]*?(:\r|\n))/,"");return e},this.deleteCryptoFromSdp=function(e,t){if(null!==e&&void 0!==e){if(!t)return e;for(;-1!==e.indexOf("a=crypto:");)e=e.replace(/(a=crypto:[\w\W]*?(:\r|\n))/,"");return e}},this.deleteCryptoZeroFromSdp=function(e){if(null===e||void 0===e)return e;for(;-1!==e.indexOf("a=crypto:0");)e=e.replace(/(a=crypto:0[\w\W]*?(:\r|\n))/,"");return e},this.updateAudioCodec=function(e){var n,i,o,r,c,d,l,u,f="",p="",E=[],S=/\r\n|\r|\n/m,T="",g=[];for(u="",E=e.split(/^(?=m=)/m),n=0;n<E.length;n++){if(p=E[n],this.isSdpHasAudio(p)){for(i=p.split(S),o=0;o<i.length;o++){if(r=i[o],r&&this.isSdpHasAudio(r)){if(g=t.codecsToRemove,void 0!==g)for(l=0;l<g.length;l++)c=g[l],d=new RegExp(" "+c,"g"),r=r.replace(d,""),0!==l&&(u+="|"),u+=c;r=r+s+a}else r&&-1!==r.indexOf("a=fmtp")?r=r.replace(/a=fmtp[\w\W]*/,""):r&&""!==r&&(r=r+s+a);T+=r}p=T}f+=p}return""!==u&&(d=new RegExp("a=rtpmap:(?:"+u+").*\r\n","g"),f=f.replace(d,"")),f},this.removeAudioCodec=function(e,t){var n,i,o,r,c,d,l="",u="",f=[],p=/\r\n|\r|\n/m,E="";for(f=e.split(/^(?=m=)/m),n=0;n<f.length;n++){if(u=f[n],this.isSdpHasAudio(u)){for(i=u.split(p),o=0;o<i.length;o++)r=i[o],r&&this.isSdpHasAudio(r)?(d=new RegExp(" "+t+"($| )","m"),c=i[o].split(/RTP[\w\W]*/),r=r.replace(/(\m=audio+)\s(\w+)/,""),r=r.trim(),r=r.replace(d," "),r=c[0]+r+s+a):r&&-1!==r.indexOf("a=fmtp:"+t)?r=r.replace(/a=fmtp[\w\W]*/,""):r&&-1!==r.indexOf("a=rtpmap:"+t)?r=r.replace(/a=rtpmap[\w\W]*/,""):r&&-1!==r.indexOf("a=rtcp-fb:"+t)?r=r.replace(/a=rtcp-fb[\w\W]*/,""):r&&""!==r&&(r=r+s+a),E+=r;u=E}l+=u}return l},this.removeRTXCodec=function(e){var t,n,i;return null===e||void 0===e?e:(n=this.getVp8Ssrc(e),r.debug("vp8SSRC = "+n),i=this.getRtxSsrc(e),r.debug("rtxSSRC = "+i),e=this.removeSsrcId(e,i),e=e.replace(/(a=ssrc-group:FID[\w\W]*?(:\r|\n))/g,""),-1===e.indexOf("rtx/90000")?e:(t=this.getRTXPayloadType(e),r.debug("removeRTXCodec : Removing rtx video codec "+t),e=this.removeVideoCodec(e,t)))},this.getVp8Ssrc=function(e){var t,n,i,o,a=/\r\n|\r|\n/m;if(null===e||void 0===e)return-1;if(-1===e.indexOf("a=ssrc-group:FID "))return-1;for(t=e.split("a=ssrc-group:FID "),n=t[1].split(a),i=n[0].split(" "),o=0;o<i.length;o++)r.debug("ssrcArray["+o+"] : "+i[o]);return i[0]},this.getRtxSsrc=function(e){var t,n,i,o,a=/\r\n|\r|\n/m;if(null===e||void 0===e)return-1;if(-1===e.indexOf("a=ssrc-group:FID "))return-1;for(t=e.split("a=ssrc-group:FID "),n=t[1].split(a),i=n[0].split(" "),o=0;o<i.length;o++)r.debug("ssrcArray["+o+"] : "+i[o]);return i[1]},this.removeSsrcId=function(e,t){var n,i,o,r="",c=/\r\n|\r|\n/m,d="";if(null===e||void 0===e)return e;for(n=e.split(c),i=0;i<n.length;i++)o=n[i],o&&-1!==o.indexOf("a=ssrc:"+t)?o=o.replace(/a=ssrc:[\w\W]*/,""):o&&""!==o&&(o=o+s+a),d+=o;return r=d},this.removeG722Codec=function(e){return e},this.getPayloadTypeOf=function(e,t){var n,i,o,a=[];if(-1===t.indexOf(e))return-1;for(i=t.match(/(a=rtpmap[\w\W]*?(:\r|\n))/g),o=0;o<i.length;o++)-1!==i[o].search(new RegExp(e,"i"))&&(n=i[o].match(/^[^\d]*(\d+)/g),n=n[0].split(":"),a.push(n[1]));return r.debug("getPayloadTypeOf("+e+") = "+a[0]),a.length<2?a[0]:a},this.replaceTelephoneEventPayloadType=function(e,t,n){var i,o,a,s,c,d,l,u="",f="";if(!e||-1===e.indexOf("telephone-event"))return e;if(o=/^\.*(a=rtpmap:)(\d*)( telephone-event[ \w+ ]*[ \/+ ]*[ \w+ ]*)\r\n?/m,t===n)return e;for(i=e,o=new RegExp("^\\.*a=rtpmap:"+n+" telephone-event[ \\/+ ]*([ \\w+ ]*)\\r\n","m"),a=i.match(o),f=null!==a&&a.length>=2&&""!==a[1]?a[1]:8e3,i=i.replace(o,"a=rtpmap:"+t+" telephone-event/"+f+"\r\n"),o=new RegExp("^\\.*(m=audio )[ \\w+ ]*[ \\/+ ]*[ \\w+ ]*( "+n+")","mg"),a=i.match(o),null!==a&&a.length>=1&&""!==a[0]&&(s=a[0],s=s.replace(n,t),i=i.replace(o,s)),c=i.split(/^(?=m=)/m),d=0;d<c.length;d++)l=c[d],this.isSdpHasAudio(l)&&(o=new RegExp("^\\.*a=fmtp:"+n,"mg"),l=l.replace(o,"a=fmtp:"+t)),u+=l;return""!==u&&(i=u),r.debug("replaceTelephoneEventPayloadType: newcode "+n+" is replaced with oldcode "+t),i},this.replaceOpusCodec=function(e){var t,n,i,o,a,s,c="",d=109,l="";if(!e||-1===e.indexOf("opus"))return e;for(t=/^\.*(a=rtpmap:)(\d*)( opus)/m,n=e.match(t),null!==n&&n.length>=3&&""!==n[2]?c=n[2]:r.warn("sdp has opus without codec number"),e=e.replace(t,"a=rtpmap:"+d+" opus"),t=new RegExp("^\\.*(m=audio )[ \\w+ ]*[ \\/+ ]*[ \\w+ ]*( "+c+")","mg"),n=e.match(t),null!==n&&n.length>=1&&""!==n[0]&&(i=n[0],i=i.replace(c,d),e=e.replace(t,i)),o=e.split(/^(?=m=)/m),a=0;a<o.length;a++)s=o[a],this.isSdpHasAudio(s)&&(t=new RegExp("^\\.*a=fmtp:"+c,"mg"),s=s.replace(t,"a=fmtp:"+d)),l+=s;return""!==l&&(e=l),r.debug("replaceOpusCodec: new codec= "+d),e},this.getG7228000PayloadType=function(e){return this.getPayloadTypeOf("G722/8000",e)},this.getVP8PayloadType=function(e){return this.getPayloadTypeOf("VP8/90000",e)},this.getG72216000PayloadType=function(e){return this.getPayloadTypeOf("G722/16000",e)},this.getRTXPayloadType=function(e){return this.getPayloadTypeOf("rtx/90000",e)},this.getH264PayloadType=function(e){return this.getPayloadTypeOf("H264/90000",e)},this.isSdpHasTelephoneEventWithRate=function(e,t){return null===e||void 0===e?!1:-1!==e.indexOf("telephone-event/"+t)},this.isSdpHasTelephoneEvent=function(e){return null===e||void 0===e?!1:-1!==e.indexOf("telephone-event/")},this.isSdpHasVP8Codec=function(e){return null===e||void 0===e?!1:-1!==e.indexOf("VP8/90000")},this.isSdpHasH264Codec=function(e){return null===e||void 0===e?!1:-1!==e.indexOf("H264/90000")},this.checkSupportedVideoCodecs=function(e,t,i){var o;return null===e||void 0===e?e:this.isVideoCodecsSupported(e,i)?e:(t?(o=this.removeAllVideoCodecs(e),o=this.addVP8Codec(o,t),o=this.updateSdpVideoPort(o,!1),o=this.performVideoPortZeroWorkaround(o)):this.isSdpHasVP8Codec(e)?o=this.removeVideoDescription(e):-1!==e.indexOf(n.SDP.M_LINE+n.STRING.VIDEO+" 0 ",0)?o=this.addVP8Codec(e,o):(o=this.updateSdpVideoPort(e,!1),o=this.addVP8Codec(o,o)),o)},this.isVideoCodecsSupported=function(e,t){return this.isSdpHasVP8Codec(e)?!0:!(!t||!this.isSdpHasH264Codec(e))},this.removeAllVideoCodecs=function(e){var t,n,i,o,a;if(null===e||void 0===e)return e;if(t=new RegExp("^\\.*(m=video )(\\d*)( RTP/SAVPF )([ \\w+ ]*[ \\/+ ]*[ \\w+ ])\\r\n","m"),o=e,n=o.match(t),null!==n&&n.length>=5&&""!==n[0])for(i=n[4].split(" "),a=0;a<i.length;a++)r.debug("codec["+a+"] : "+i[a]),o=this.removeVideoCodec(o,i[a]);return o},this.removeVideoCodec=function(e,t){var n,i,o,r,c,d="",l="",u=[],f=/\r\n|\r|\n/m,p="";if(null===e||void 0===e||!t)return e;for(u=e.split(/^(?=m=)/m),n=0;n<u.length;n++){if(l=u[n],this.isSdpHasVideo(l)){for(i=l.split(f),o=0;o<i.length;o++)r=i[o],r&&this.isSdpHasVideo(r)?(c=new RegExp(" "+t,"g"),r=r.replace(c,""),r=r+s+a):r&&-1!==r.indexOf("a=fmtp:"+t)?r=r.replace(/a=fmtp[\w\W]*/,""):r&&-1!==r.indexOf("a=rtpmap:"+t)?r=r.replace(/a=rtpmap[\w\W]*/,""):r&&-1!==r.indexOf("a=rtcp-fb:"+t)?r=r.replace(/a=rtcp-fb[\w\W]*/,""):r&&""!==r&&(r=r+s+a),p+=r;l=p}d+=l}return d},this.addVP8Codec=function(e,t){var i,o,r,c,d,l,u,f,p,E,S="",T="",g=[],m=/\r\n|\r|\n/m,C="";if(this.isSdpHasVP8Codec(e))return e;for(g=e.split(/^(?=m=)/m),i=0;i<g.length;i++){if(T=g[i],this.isSdpHasVideo(T)){if(t&&this.isSdpHasVideo(t)&&this.isSdpHasVP8Codec(t))c=this.getVP8PayloadType(t),-1!==T.indexOf("a=rtpmap:"+c)&&this.removeSdpLineContainingText(T,"a=rtpmap:"+c);else{for(d=100;-1!==T.indexOf("a=rtpmap:"+d);)d+=1;c=d}for(o=T.split(m),r=0;r<o.length;r++)l=o[r],l&&this.isSdpHasVideo(l)?(-1===l.indexOf(c)&&(l=l+" "+c),l=l+s+a+"a=rtpmap:"+c+" VP8/90000"+s+a):l&&""!==l&&(l=l+s+a),C+=l;T=C}S+=T}return u=this.checkICEParams(S,"video",n.SDP.ICE_UFRAG),2>u&&(p=this.getICEParams(S,n.SDP.ICE_UFRAG,!1),p&&(S=this.restoreICEParams(S,"video",n.SDP.ICE_UFRAG,p))),f=this.checkICEParams(S,"video",n.SDP.ICE_PWD),2>f&&(E=this.getICEParams(S,n.SDP.ICE_PWD,!1),E&&(S=this.restoreICEParams(S,"video",n.SDP.ICE_PWD,E))),S},this.removeSdpLineContainingText=function(e,t){var n,i;if(null===e||void 0===e||!t)return e;for(i=e.split(a),e=i[0]+a,n=1;n<i.length-1;n++)-1!==i[n].indexOf(t)?r.debug("removed line which contains "+t):e+=i[n]+a;return e},this.removeVideoDescription=function(e){var t,n="",i="",o=[];if(null===e||void 0===e)return e;for(o=e.split(/^(?=m=)/m),t=0;t<o.length;t++)i=o[t],this.isSdpHasVideo(i)?r.debug("removeVideoDescription : m=video description removed"):n+=i;return n},this.updateSdpVideoPort=function(e,t){var i,o;return null===e||void 0===e?e:(r.debug("updateSdpVideoPort: status= "+t),i=e,t?o=n.SDP.M_LINE+n.STRING.VIDEO+" 1":(o=n.SDP.M_LINE+n.STRING.VIDEO+" 0",i=this.updateSdpDirection(i,n.STRING.VIDEO,n.WEBRTC.MEDIA_STATE.INACTIVE)),this.isSdpHasVideo(i)&&(i=i.replace(/m=video [0-9]+/,o)),i)},this.performVideoPortZeroWorkaround=function(e){return null===e||void 0===e?e:this.isSdpHasVideoWithZeroPort(e)?(e=this.addSdpMissingCryptoLine(e),e=this.replaceZeroVideoPortWithOne(e),e=this.updateVideoSdpDirectionToInactive(e)):e},this.addSdpMissingCryptoLine=function(e){var t,i,o,a=null,s=/\r\n|\r|\n/m;if(-1===e.indexOf(n.SDP.M_LINE+n.STRING.VIDEO+" 0 ",0))return e;for(t=e.split(n.SDP.M_LINE+n.STRING.VIDEO),i=t[0].split(s),o=0;o<i.length;o++)if(-1!==i[o].indexOf(n.SDP.A_LINE+n.SDP.CRYPTO)||-1!==i[o].indexOf(n.SDP.A_LINE+n.SDP.FINGERPRINT)){a=i[o];break}return null===a?e:(-1!==t[0].indexOf(n.SDP.A_LINE+n.SDP.CRYPTO)?-1===t[1].indexOf(n.SDP.A_LINE+n.SDP.CRYPTO,0)&&(t[1]+=a+"\n",r.debug("addSdpMissingCryptoLine : crypto line is added : "+a)):-1!==t[0].indexOf(n.SDP.A_LINE+n.SDP.FINGERPRINT,0)&&-1===t[1].indexOf(n.SDP.A_LINE+n.SDP.FINGERPRINT,0)&&(t[1]+=a+"\na=setup:passive\n",r.debug("addSdpMissingCryptoLine : dtls lines are added : "+a+"and a=setup:passive"),r.debug("dtls enabled: known issue by webrtc may be fixed! Check it")),e=t.join(n.SDP.M_LINE+n.STRING.VIDEO))},this.checkICEParams=function(e,t,i){var o,r;if(null===e||void 0===e)return 0;if(o=e.split("m=video"),o.length<2)return 0;switch(i){case n.SDP.ICE_UFRAG:r="audio"===t?o[0].split("a=ice-ufrag:"):o[1].split("a=ice-ufrag:");break;case n.SDP.ICE_PWD:r="audio"===t?o[0].split("a=ice-pwd:"):o[1].split("a=ice-pwd:");break;default:return 0}return r.length},this.getICEParams=function(e,t,i){var o,r,a,s;if(null!==e&&void 0!==e){switch(t){case n.SDP.ICE_UFRAG:o=e.split("a=ice-ufrag:");break;case n.SDP.ICE_PWD:o=e.split("a=ice-pwd:");break;default:return}return i?void 0!==o[2]?(r=o[2],a=r.split("a="),s=a[0]):void 0:void 0!==o[1]?(r=o[1],a=r.split("a="),s=a[0]):void 0}},this.restoreICEParams=function(e,t,n,i){var o,r,a,s="";if(null===e||void 0===e)return e;if(a=e.split("m=video"),a.length<2)return e;for(r=0;r<a.length;r++)o=a[r],0===r&&("audio"===t&&(o=o+"a="+n+i),s+=o),1===r&&("video"===t&&(o=o+"a="+n+i),s=s+"m=video"+o);return s},this.updateICEParams=function(e,t,i){var o,r,a,s,c,d,l="",u="";if(null===e||void 0===e)return e;switch(t){case n.SDP.ICE_UFRAG:s=e.split("a=ice-ufrag:");break;case n.SDP.ICE_PWD:s=e.split("a=ice-pwd:");break;default:return e}for(r=0;r<s.length;r++)if(o=s[r],2===r){for(c=o.split("a="),a=0;a<c.length;a++)d=c[a],0===a?(c[a]=i,u+=c[a]):u=u+"a="+c[a];o=u,l+=o}else l=l+o+"a="+t;return l},this.checkIceParamsLengths=function(e,t){var i,o;return i=this.getICEParams(e,n.SDP.ICE_UFRAG,!0),o=this.getICEParams(e,n.SDP.ICE_PWD,!0),i&&i.length<4&&(i=this.getICEParams(t,n.SDP.ICE_UFRAG,!0),i&&(e=this.updateICEParams(e,n.SDP.ICE_UFRAG,i))),o&&o.length<22&&(o=this.getICEParams(t,n.SDP.ICE_PWD,!0),o&&(e=this.updateICEParams(e,n.SDP.ICE_PWD,o))),e},this.isSdpVideoSendEnabled=function(e){var t,i="isSdpVideoSendEnabled: ",o=!1;return null===e||void 0===e?!1:this.isSdpEnabled(e,n.STRING.VIDEO)?(t=this.getSdpDirectionLogging(e,n.STRING.VIDEO,!1),t===n.WEBRTC.MEDIA_STATE.SEND_RECEIVE||t===n.WEBRTC.MEDIA_STATE.SEND_ONLY?(o=!0,r.debug(i+o),o):(r.debug(i+o),o)):(r.debug(i+o),o)},this.getSdpDirectionLogging=function(e,t,i){var o,a,s="",c=[],d=n.WEBRTC.MEDIA_STATE.INACTIVE;if(a=function(e){i&&r.debug("getSdpDirection: type= "+t+" state= "+e)},-1===e.indexOf(n.SDP.M_LINE+t))return a(d),d;if(-1!==e.indexOf(n.SDP.M_LINE+t+" 0"))return a(d),d;for(c=e.split(/^(?=m=)/m),o=0;o<c.length;o++)if(s=c[o],-1!==s.indexOf(n.SDP.M_LINE+t))return-1!==s.indexOf(n.SDP.A_LINE+n.WEBRTC.MEDIA_STATE.SEND_RECEIVE)?(d=n.WEBRTC.MEDIA_STATE.SEND_RECEIVE,a(d),d):-1!==s.indexOf(n.SDP.A_LINE+n.WEBRTC.MEDIA_STATE.SEND_ONLY)?(d=n.WEBRTC.MEDIA_STATE.SEND_ONLY,a(d),d):-1!==s.indexOf(n.SDP.A_LINE+n.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)?(d=n.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,a(d),d):-1!==s.indexOf(n.SDP.A_LINE+n.WEBRTC.MEDIA_STATE.INACTIVE)?(a(d),d):d=n.WEBRTC.MEDIA_STATE.SEND_RECEIVE;return d=n.WEBRTC.MEDIA_STATE.NOT_FOUND,a(d),d},this.deleteInactiveVideoSsrc=function(e){var t=[];return this.isSdpHas(e,n.STRING.VIDEO)?(t=e.split(n.SDP.M_LINE+n.STRING.VIDEO),null!==t[1]&&(t[1]=this.deleteSsrcFromSdp(t[1])),t[0]+n.SDP.M_LINE+n.STRING.VIDEO+t[1]):e},this.deleteSsrcFromSdp=function(e){if(null===e||void 0===e)return e;for(;-1!==e.indexOf("a=ssrc");)e=e.replace(/(a=ssrc[\w\W]*?(:\r|\n))/,"");
return e},this.getTcpSetupAttribute=function(e){var t;if(null!==e&&void 0!==e)return-1!==e.indexOf(n.SDP.SETUP_ACTIVE)?t=n.SDP.SETUP_ACTIVE:-1!==e.indexOf(n.SDP.SETUP_PASSIVE)?t=n.SDP.SETUP_PASSIVE:-1!==e.indexOf(n.SDP.SETUP_ACTPASS)&&(t=n.SDP.SETUP_ACTPASS),t},this.setTcpSetupAttributeTo=function(e,t,i){if(null===e||void 0===e)return e;if(!i)return e;if(t!==n.SDP.SETUP_ACTIVE)for(;-1!==e.indexOf(n.SDP.SETUP_ACTIVE);)r.debug("a=setup:active to "+t),e=e.replace(n.SDP.SETUP_ACTIVE,t);if(t!==n.SDP.SETUP_PASSIVE)for(;-1!==e.indexOf(n.SDP.SETUP_PASSIVE);)r.debug("a=setup:passive to "+t),e=e.replace(n.SDP.SETUP_PASSIVE,t);if(t!==n.SDP.SETUP_ACTPASS)for(;-1!==e.indexOf(n.SDP.SETUP_ACTPASS);)r.debug("a=setup:passive to "+t),e=e.replace(n.SDP.SETUP_ACTPASS,t);return e},this.setTcpSetupAttributeToActpass=function(e,t){return this.setTcpSetupAttributeTo(e,n.SDP.SETUP_ACTPASS,t)},this.checkAndRestoreICEParams=function(e,t){var i,o,r,a,s,c;return i=this.checkICEParams(e,n.STRING.AUDIO,n.SDP.ICE_UFRAG),2>i&&(s=this.getICEParams(t,n.SDP.ICE_UFRAG,!1),s&&(e=this.restoreICEParams(e,n.STRING.AUDIO,n.SDP.ICE_UFRAG,s))),o=this.checkICEParams(e,n.STRING.AUDIO,n.SDP.ICE_PWD),2>o&&(c=this.getICEParams(t,n.SDP.ICE_PWD,!1),c&&(e=this.restoreICEParams(e,n.STRING.AUDIO,n.SDP.ICE_PWD,c))),r=this.checkICEParams(e,n.STRING.VIDEO,n.SDP.ICE_UFRAG),2>r&&(s=this.getICEParams(t,n.SDP.ICE_UFRAG,!1),s&&(e=this.restoreICEParams(e,n.STRING.VIDEO,n.SDP.ICE_UFRAG,s))),a=this.checkICEParams(e,n.STRING.VIDEO,n.SDP.ICE_PWD),2>a&&(c=this.getICEParams(t,n.SDP.ICE_PWD,!1),c&&(e=this.restoreICEParams(e,n.STRING.VIDEO,n.SDP.ICE_PWD,c))),e},this.incrementVersion=function(e){var t,n,i,o=[],a="";if(r.debug("incrementVersion"),null===e||void 0===e)return e;if(i=e.match(/(o=[\w\W]*?(:\r|\n))/),!i)return e;for(o=i[0].split(" "),n=+o[2],n+=1,t=0;t<o.length;t++)0!==t&&(a+=" "),a+=2===t?n:o[t];return e=e.replace(i[0],a)},this.escalateSdpDirection=function(e,t){var i=this.getSdpDirectionLogging(e,t,!1);return r.debug("escalateSdpDirection: type= "+t+" direction= "+i),i===n.WEBRTC.MEDIA_STATE.RECEIVE_ONLY?this.changeDirection(e,i,n.WEBRTC.MEDIA_STATE.SEND_RECEIVE,t):i===n.WEBRTC.MEDIA_STATE.INACTIVE?this.changeDirection(e,i,n.WEBRTC.MEDIA_STATE.SEND_ONLY,t):e},this.deescalateSdpDirection=function(e,t){var i=this.getSdpDirectionLogging(e,t,!1);return r.debug("deescalateSdpDirection: type= "+t+" direction= "+i),i===n.WEBRTC.MEDIA_STATE.SEND_RECEIVE?this.changeDirection(e,i,n.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,t):i===n.WEBRTC.MEDIA_STATE.SEND_ONLY?this.changeDirection(e,i,n.WEBRTC.MEDIA_STATE.INACTIVE,t):e},this.isIceLite=function(e){return null===e||void 0===e?!1:!(!e||-1===e.indexOf("a=ice-lite"))},this.getSessionIdFromSdp=function(e){var t;return e&&(t=e.match(/(o=[\w\W]*?(:\r|\n))/))?(t=t[0].split(" "),t[1]?(r.info("getSessionIdFromSdp = "+t[1]),t[1]):(r.warn("getSessionIdFromSdp called with wrong sdp!!"),-1)):-1},this.updateVersion=function(e,t){var n,i,o=[],a=[],s="",c="";if(null===e||void 0===e)return t;if(r.debug(" updateVersion called..."),o=e.match(/(o=[\w\W]*?(:\r|\n))/),!o)return t;if(o=o[0].split(" "),c=t.match(/(o=[\w\W]*?(:\r|\n))/),a=c[0].split(" "),!o)return r.warn("updateVersion called with wrong fromSdp!!"),t;for(i=o[2],i=+i+1,r.debug(" updateVersion fromVersion incremented: "+i),n=0;n<a.length;n++)0!==n&&(s+=" "),s+=2===n?i:a[n];return t=t.replace(c[0],s)},this.copyCandidatesToTheNewLocalSdp=function(e,t){var i,o,r,a,s=[],c=[];return s=e.split(n.SDP.M_LINE+n.STRING.VIDEO),c=t.split(n.SDP.M_LINE+n.STRING.VIDEO),r=s[0],i=void 0!==s[1]?n.SDP.M_LINE+n.STRING.VIDEO+s[1]:void 0,a=c[0],o=void 0!==c[1]?n.SDP.M_LINE+n.STRING.VIDEO+c[1]:void 0,a=this.copyCandidates(r,a),void 0!==i&&void 0!==o&&(o=this.copyCandidates(i,o)),void 0!==o?a+o:a},this.copyCandidates=function(e,t){var i,o,r,a=/\r\n|\r|\n/m;for(i=e.split(a),o=0;o<i.length;o++)-1!==i[o].indexOf("a=candidate")&&t.indexOf(!1)?t+=i[o]+"\r\n":-1!==i[o].indexOf("c=IN")&&t.indexOf(!0)?t=t.replace(/(c=[\w\W]*?(:\r|\n))/,i[o]+"\r\n"):-1===i[o].indexOf("m=audio")||-1===t.indexOf(n.SDP.M_LINE+n.STRING.AUDIO+" 1 ")&&-1===t.indexOf(n.SDP.M_LINE+n.STRING.AUDIO+" 9 ")?-1===i[o].indexOf("m=video")||-1===t.indexOf(n.SDP.M_LINE+n.STRING.VIDEO+" 1 ")&&-1===t.indexOf(n.SDP.M_LINE+n.STRING.VIDEO+" 9 ")||(r=i[o].split(" ")[1],t=t.replace(/m=video \d/,n.SDP.M_LINE+n.STRING.VIDEO+" "+r)):(r=i[o].split(" ")[1],t=t.replace(/m=audio \d/,n.SDP.M_LINE+n.STRING.AUDIO+" "+r));return t},this.getSdpFromObject=function(e){var t;return t=e.sdp},this.deleteGoogleIceFromSdp=function(e){return null===e||void 0===e?e:e=e.replace(/(a=ice-options:google-ice[\w\W]*?(:\r|\n))/g,"")},this.respondToRemoteSdpDirections=function(e,t){return e=this.respondToRemoteMediaSdpDirection(e,t,n.STRING.AUDIO),e=this.respondToRemoteMediaSdpDirection(e,t,n.STRING.VIDEO)},this.respondToRemoteMediaSdpDirection=function(e,t,i){var o;return this.isSdpHas(t,i)&&(o=this.getSdpDirection(t,i),o===n.WEBRTC.MEDIA_STATE.SEND_ONLY?(r.debug(i+" sendonly -> recvonly"),e=this.updateSdpDirection(e,i,n.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)):o===n.WEBRTC.MEDIA_STATE.RECEIVE_ONLY?(r.debug(i+" recvonly -> sendonly"),e=this.updateSdpDirection(e,i,n.WEBRTC.MEDIA_STATE.SEND_ONLY)):o===n.WEBRTC.MEDIA_STATE.SEND_RECEIVE?(r.debug(i+" sendrecv -> sendrecv"),e=this.updateSdpDirection(e,i,n.WEBRTC.MEDIA_STATE.SEND_RECEIVE)):o===n.WEBRTC.MEDIA_STATE.INACTIVE&&(r.debug(i+" inactive -> inactive"),e=this.updateSdpDirection(e,i,n.WEBRTC.MEDIA_STATE.INACTIVE))),e},this.hasCandidates=function(e,t,n){var i,o,r;return this.checkRelayCandidateCollectionTimeout(t,n)?!0:(r=this.getCandidateType(t,n),this.isSdpHasAudio(e)?(i=e.split("m=audio"),-1===i[1].indexOf(r)?!1:!this.isSdpHasVideo(e)||this.isVideoSdpDirectionInactive(e)||this.isVideoSdpDirectionRecvonly(e)?!0:(o=e.split("m=video"),-1!==o[1].indexOf(r))):!1)},this.getCandidateType=function(e,t){var n;return n=e&&t>=e?"relay":"a=candidate"},this.checkRelayCandidateCollectionTimeout=function(e,t){return!!(e&&e>t)},this.deleteFingerprintOrCrypto=function(e,t){return null===e||void 0===e?e:-1===e.indexOf("a=crypto:")||-1===e.indexOf("a=fingerprint:")?e:(e=this.deleteCryptoFromSdp(e,t),e=this.deleteFingerprintFromSdp(e,t))},this.addRtpmapForPCMU=function(e){return i(e,"0","a=rtpmap:0 PCMU/8000")},this.addRtpmapForPCMA=function(e){return i(e,"8","a=rtpmap:8 PCMA/8000")},this.deleteCurlyBracketsSDP=function(e){return null===e||void 0===e?e:(r.debug("Deleting curly brackets from sdp"),e=e.replace(/(\{|\})/g,""))},this.deleteBandwidthLineFromSdp=function(e){return null===e||void 0===e?e:(this.isVideoSdpDirectionInactive(e)&&(r.debug("Deleting b:AS line from SDP"),e=e.replace(/(b=AS:[\w\W]*?(:\r|\n))/g,"")),e)},this.setOpusCodecToLowerCase=function(e){return null===e||void 0===e?e:(r.debug("Setting OPUS codec to lower case"),e.replace("OPUS","opus"))},this.replaceAudioMlineOfCodec=function(e,t,i){return this.isSdpHasAudio(e)&&(e=this.replaceMlineOfCodec(e,n.STRING.AUDIO,t,i)),e},this.replaceVideoMlineOfCodec=function(e,t,i){return this.isSdpHasVideo(e)&&(e=this.replaceMlineOfCodec(e,n.STRING.VIDEO,t,i)),e},this.replaceMlineOfCodec=function(e,t,n,i){var o,r,a,s="";for(r=new RegExp("m="+t+" [\\w\\W]*?(\\r|\\n)","g"),o=e.match(r),o=o[0].split(" "),a=0;a<o.length;a++)1!==a&&o[a]&&-1!==o[a].indexOf(n)&&(o[a]=o[a].replace(n,i)),s+=a===o.length-1?o[a]:o[a]+" ";return e.replace(r,s)},this.replaceRTPMapOfCodec=function(e,t,n){var i=new RegExp("a=rtpmap:"+t,"g");return e.replace(i,"a=rtpmap:"+n)},this.replaceRTCPOfCodec=function(e,t,n){var i=new RegExp("a=rtcp-fb:"+t,"g");return e.replace(i,"a=rtcp-fb:"+n)},this.replaceFMTPOfCodec=function(e,t,n){var i=new RegExp("a=fmtp:"+t,"g");return e.replace(i,"a=fmtp:"+n)},this.replaceCodecValue=function(e,t,n){var i,o;return i=this.getPayloadTypeOf(t,e),i&&(o=Array.isArray(i)?i[0]:i,e=this.replaceAudioMlineOfCodec(e,o,n),e=this.replaceVideoMlineOfCodec(e,o,n),e=this.replaceRTPMapOfCodec(e,o,n),e=this.replaceRTCPOfCodec(e,o,n),e=this.replaceFMTPOfCodec(e,o,n)),e},this.replaceCodecs=function(e,t){var n;if(t&&t.length)for(n=0;n<t.length;n++)e=this.replaceCodecValue(e,t[n].name,t[n].value);return e},this.removeH264Codec=function(e){if(null===e||void 0===e)return e;r.debug("Removing H264 codec from SDP");var t,n;if(-1===e.indexOf("H264/90000"))return e;if(t=this.getH264PayloadType(e),-1!==t)for(n=0;n<t.length;n++)r.debug("removeH264Codec : Removing H264/90000 video codec "+t[n]),e=this.removeVideoCodec(e,t[n]);return e},this.hasZeroConnectionIP=function(e){return null===e||void 0===e?!1:-1!==e.indexOf("c=IN IP4 0.0.0.0")},this.findZeroConnectionIPandModify=function(e){var t,i,o="",a="",s=[];if(r.debug("findZeroConnectionIPandModify received SDP: "+e),null===e||void 0===e)return e;for(s=e.split(/^(?=m=)/m),t=0;t<s.length;t++)a=s[t],i=this.isSdpHasVideo(a)?n.STRING.VIDEO:n.STRING.AUDIO,this.hasZeroConnectionIP(a)&&this.getSdpDirection(e,i)!==n.WEBRTC.MEDIA_STATE.INACTIVE&&(a=a.replace("c=IN IP4 0.0.0.0","c=IN IP4 1.1.1.1")),o+=a;return r.debug("findZeroConnectionIPandModify updated SDP: "+o),o},this.isRemoteEndFirefox=function(e){return e?-1!==e.indexOf("SDPARTA"):!1},this.hasCodecPayloadChanged=function(e,t){if(!e||!t)return!1;var n=this.getPayloadTypeOf("telephone-event/8000",e),i=this.getPayloadTypeOf("telephone-event/8000",t);return n!==i}},X=function(e,t,n){return new Q(e||B,t||O,n||v)},Z=new X;g&&(g.SDPParser=X);var $=function(){var e,t,n,i,o,r,a,s,c=this,d=!1,l="",u={video:null,localVideo:null,remoteVideo:null,defaultVideo:null},f={audio:!1,video:!1},p={video:{available:!1},audio:{available:!1},screen:{available:!1,width:"1024",height:"768",rate:15}},E=!1,S={},T=4,g=0,C=!1,I=!1,v=new m,R=new m,A={};c.getLocalMedia=function(){return A},c.setLocalMedia=function(e){A=e},c.getLocalStreamMap=function(){return v},c.getScreenStream=function(){return i},c.setScreenStream=function(e){i=e},c.isH264Enabled=function(){return I},c.setH264Enabled=function(e){I=e===!0},c.getIceServerUrl=function(){return l},c.setIceServerUrl=function(e){l=e},c.isDtlsEnabled=function(){return d},c.setDtlsEnabled=function(e){d=e},c.getVideoContainer=function(){return u.video},c.setVideoContainer=function(e){u.video=e},c.getLocalVideoContainer=function(){return u.localVideo},c.setLocalVideoContainer=function(e){u.localVideo=e},c.getRemoteVideoContainer=function(){return u.remoteVideo},c.setRemoteVideoContainer=function(e){u.remoteVideo=e},c.getDefaultVideoContainer=function(){return u.defaultVideo},c.setDefaultVideoContainer=function(e){u.defaultVideo=e},c.isInitialized=function(){return E},c.setInitialized=function(e){E=e===!0},c.getRtcLibrary=function(){return S},c.setRtcLibrary=function(e){S=e},c.getLogLevel=function(){return T},c.setLogLevel=function(e){T=e},c.getLanguage=function(){return e},c.setLanguage=function(t){e=t},c.getMediaAudio=function(){return f.audio},c.setMediaAudio=function(e){f.audio=!!e},c.getMediaVideo=function(){return f.video},c.setMediaVideo=function(e){f.video=!!e},c.getVideoWidth=function(){return p.video.width},c.setVideoWidth=function(e){p.video.width=e},c.getVideoHeight=function(){return p.video.height},c.setVideoHeight=function(e){p.video.height=e},c.getVideoSourceAvailable=function(){return p.video.available},c.setVideoSourceAvailable=function(e){p.video.available=e},c.getAudioSourceAvailable=function(){return p.audio.available},c.setAudioSourceAvailable=function(e){p.audio.available=e},c.setMediaSources=function(e){e&&(c.setVideoSourceAvailable(e.videoSourceAvailable),c.setAudioSourceAvailable(e.audioSourceAvailable),c.setScreenSourceAvailable(e.screenSourceAvailable),c.setMediaSourceList(e.sourceList))},c.getScreenSourceAvailable=function(){return p.screen.available},c.setScreenSourceAvailable=function(e){p.screen.available=e},c.getScreenWidth=function(){return p.screen.width},c.setScreenWidth=function(e){p.screen.width=e},c.getScreenHeight=function(){return p.screen.height},c.setScreenHeight=function(e){p.screen.height=e},c.getScreenFrameRate=function(){return p.screen.rate},c.setScreenFrameRate=function(e){p.screen.rate=e},c.getPeerCount=function(){return g},c.setPeerCount=function(e){g=e},c.isPluginEnabled=function(){return C},c.setPluginEnabled=function(e){C=e},c.initAudioContext=function(){window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext,t=new window.AudioContext},c.getAudioContext=function(){return t},c.initMediaStreamDestination=function(){n=c.getAudioContext().createMediaStreamDestination()},c.getMediaStreamDestination=function(){return n},c.setSelectedMicrophoneId=function(e){o=e},c.getSelectedMicrophoneId=function(){return o},c.setSelectedSpeakerId=function(e){r=e},c.getSelectedSpeakerId=function(){return r},c.setSelectedCameraId=function(e){a=e},c.getSelectedCameraId=function(){return a},c.getStreamById=function(e){return R.get(e)},c.removeStreamFromMap=function(e){R.remove(e)},c.getPrivateStreamMap=function(){return R},c.setMediaSourceList=function(e){s=e},c.getMediaSourceList=function(){return s}};g&&(g.WebRtcAdaptorModel=$);var ee=function(){var e=this;e.isH264Enabled=function(){return!1}};ee.prototype=new $,g&&(g.WebRtcChromeAdaptorModel=ee);var te=function(){var e=this,t=!0;e.isH264Enabled=function(){return t},e.setH264Enabled=function(e){t=e===!0}};te.prototype=new $,g&&(g.WebRtcFirefoxAdaptorModel=te);var ne=function(){var e=this,t={major:0,minor:0,min_revision:0,min_build:0,current_revision:0,current_build:0};e.getPluginVersion=function(){return t},e.setPluginVersion=function(e){t=e}};ne.prototype=new $,g&&(g.WebRtcPluginAdaptorModel=ne);var ie=function(e,t,n){var i={};return i.getUserMedia=e.getUserMedia,i.showSettingsWindow=e.showSettingsWindow,i.getURLFromStream=e.getURLFromStream,i.enableH264=e.enableH264,i.createRTCSessionDescription=function(t,n){return e.createSessionDescription(t,n)},i.createRTCIceCandidate=function(t,n,i){return e.createIceCandidate(t,n,i)},i.createRTCPeerConnection=function(t,n){return e.createPeerConnection(t,n)},i.setLang=function(t){e.setLanguage(t||"en")},i.checkMediaSourceAvailability=function(t){n.callFunctionIfExist(t,{videoSourceAvailable:e.getVideoDeviceNames().length>0,audioSourceAvailable:e.getAudioInDeviceNames().length>0,screenSourceAvailable:!1})},i.get_audioInDeviceCount=function(){return e.getAudioInDeviceNames().length},i.get_audioOutDeviceCount=function(){return e.getAudioOutDeviceNames().length},i.get_videoDeviceCount=function(){return e.getVideoDeviceNames().length},i.set_logSeverityLevel=function(t){return e.logSeverityLevel=t,!0},i.get_logSeverityLevel=function(){return e.logSeverityLevel},i.enable_logCallback=function(t){return e.logCallback=t,!0},i.disable_logCallback=function(){e.logCallback=null},i.setType=function(t){e.type=t},i.getType=function(){return e.type},i.getVersion=function(){return e.version},i.setH264CodecStateChangeHandler=function(t){e.onh264codecstatechange=t},i.getCurrentPluginVersionObject=function(){var t,n=e.version.split(".");return t={major:parseInt(n[0],10),minor:parseInt(n[1],10),revision:parseInt(n[2],10),build:parseInt(n[3],10)}},i.detachWebAudioContextFromLocalMedia=function(e){e.audioContext.close(),e.mediaStreamDestination.disconnect()},i.stopLocalMedia=function(e){e&&(i.stopStream(e.stream),i.stopStream(e.originalStream))},i.stopStream=function(e){e&&e.stop&&e.stop()},i},oe=function(e,t,n){return ie(e||{},t,n||q)};g&&(g.webRtcLibraryDecorator=oe);var re=function(e,t,n,i,o,r){var a=r.getLogger("webRtcLibraryFirefoxDecoratorImpl");t(e),e.getUserMedia=function(e,t,n){i.mozGetUserMedia(e,t,n)},e.getScreenMedia=function(e,t,n){q.callFunctionIfExist(n,R.call.MediaErrors.NO_SCREENSHARING_WARNING)},e.initScreenSharing=function(e,t){q.callFunctionIfExist(t,R.call.MediaErrors.NO_SCREENSHARING_WARNING)},e.showSettingsWindow=function(){},e.createRTCSessionDescription=function(e,t){return new n.mozRTCSessionDescription({type:e,sdp:t})},e.createRTCIceCandidate=function(e){return new n.mozRTCIceCandidate(e)},e.getURLFromStream=function(e){return n.URL.createObjectURL(e)},e.createRTCPeerConnection=function(e,t){return new n.mozRTCPeerConnection(e,t)},e.checkMediaSourceAvailability=function(e){var t,n,r;i.mediaDevices&&i.mediaDevices.enumerateDevices?i.mediaDevices.enumerateDevices().then(function(i){for(t=0;t<i.length;t++)"videoinput"===i[t].kind?n=!0:"audioinput"===i[t].kind&&(r=!0);o.callFunctionIfExist(e,{videoSourceAvailable:n,audioSourceAvailable:r,sourceList:i})})["catch"](function(t){a.error("Failed to enumerate devices. Error name: "+t.name+"Error message: "+t.message),o.callFunctionIfExist(e,{videoSourceAvailable:!1,audioSourceAvailable:!1,sourceList:null})}):o.callFunctionIfExist(e,{videoSourceAvailable:!0,audioSourceAvailable:!0,screenSourceAvailable:!1})},e.detachWebAudioContextFromLocalMedia=function(e){e.audioContext.close(),e.mediaStreamDestination.numberOfOutputs>0&&e.mediaStreamDestination.disconnect()},e.stopLocalMedia=function(t){t&&(e.stopStream(t.stream),e.stopStream(t.originalStream))},e.stopStream=function(e){e&&e.stop&&e.stop()},e.get_audioInDeviceCount=function(){return 1},e.get_audioOutDeviceCount=function(){return 1},e.get_videoDeviceCount=function(){return 1},e.set_logSeverityLevel=function(){return!1},e.get_logSeverityLevel=function(){},e.enable_logCallback=function(){},e.disable_logCallback=function(){}},ae=function(e,t,n,i,o,r){re(e||{},t||oe,n||window,i||navigator,o||q,r||B)};g&&(g.webRtcLibraryFirefoxDecorator=ae);var se=function(e,t,n,i,o,r){var a,s=r.getLogger("webRtcLibraryChromeDecoratorImpl"),c=!1;t(e),e.getUserMedia=function(e,t,n){i.webkitGetUserMedia(e,t,n)},e.getScreenMedia=function(t,n,i){var o=function(o){o&&o.mediaSourceId?(t.audio=!1,t.video.mandatory.chromeMediaSource="desktop",t.video.mandatory.chromeMediaSourceId=o.mediaSourceId,e.getUserMedia(t,n,i)):q.callFunctionIfExist(i)};c&&window.chrome.runtime.sendMessage(a,{message:"chooseDesktopMedia"},o)},e.initScreenSharing=function(e,t,n){var i=n.screenSharing;if(i&&i.chromeExtensionId){a=i.chromeExtensionId;try{window.chrome.runtime.sendMessage(a,{message:"version"},function(n){n&&n.version?(c=!0,q.callFunctionIfExist(e)):q.callFunctionIfExist(t,R.call.MediaErrors.NO_SCREENSHARING_WARNING)})}catch(o){q.callFunctionIfExist(t,R.call.MediaErrors.NO_SCREENSHARING_WARNING)}}else q.callFunctionIfExist(e)},e.showSettingsWindow=function(){},e.createRTCSessionDescription=function(e,t){return new n.RTCSessionDescription({type:e,sdp:t})},e.createRTCIceCandidate=function(e){return new n.RTCIceCandidate(e)},e.getURLFromStream=function(e){return n.URL.createObjectURL(e)},e.createRTCPeerConnection=function(e,t){return new n.webkitRTCPeerConnection(e,t)},e.checkMediaSourceAvailability=function(e){function t(t,n,i){o.callFunctionIfExist(e,{videoSourceAvailable:t,audioSourceAvailable:n,sourceList:i,screenSourceAvailable:c})}function r(e){for(a=0;a<e.length;a++)"videoinput"===e[a].kind||"video"===e[a].kind?d=!0:"audioinput"!==e[a].kind&&"audio"!==e[a].kind||(l=!0);t(d,l,e)}var a,d,l;i.mediaDevices&&i.mediaDevices.enumerateDevices?i.mediaDevices.enumerateDevices().then(r)["catch"](function(e){s.error("Failed to enumerate devices. Error name: "+e.name+"Error message: "+e.message),t(!1,!1,null)}):n.MediaStreamTrack.getSources(r)},e.detachWebAudioContextFromLocalMedia=function(e){e.audioContext.close(),e.mediaStreamDestination.disconnect()},e.stopLocalMedia=function(t){t&&(e.stopStream(t.stream),e.stopStream(t.originalStream))},e.stopStream=function(e){var t,n=[];e&&e.getTracks&&(n=e.getTracks());for(t in n)n.hasOwnProperty(t)&&n[t].stop()},e.get_audioInDeviceCount=function(){return 1},e.get_audioOutDeviceCount=function(){return 1},e.get_videoDeviceCount=function(){return 1},e.set_logSeverityLevel=function(){return!1},e.get_logSeverityLevel=function(){},e.enable_logCallback=function(){},e.disable_logCallback=function(){}},ce=function(e,t,n,i,o,r){se(e||{},t||oe,n||window,i||navigator,o||q,r||B)};g&&(g.webRtcLibraryChromeDecorator=ce);var de=function(e,t,n,i,o,r,a){var s=this,c=i.getLogger("WebRtcAdaptorImpl"),d="0";c.debug("WebRtcAdaptor initializing"),o.compose(n,s),s.storeStableRemoteAndLocalSdpInCall=function(e){e&&e.peer&&e.peer.signalingState===v.WEBRTC.RTC_SIGNALING_STATE.STABLE&&(e.stableRemoteSdp=e.peer.remoteDescription.sdp,e.stableLocalSdp=e.peer.localDescription.sdp)},s.performSdpWorkaroundsAfterCreateOffer=function(e,t){return t.sdp=r.replaceCodecs(t.sdp,e.codecsToReplace?e.codecsToReplace:O.codecsToReplace),t},s.overrideConfiguredCodecValues=function(e,t){var n,i;if(e.codecsToReplace=e.codecsToReplace?e.codecsToReplace:JSON.parse(JSON.stringify(O.codecsToReplace)),e.codecsToReplace)for(n=0;n<e.codecsToReplace.length;n++)i=r.getPayloadTypeOf(e.codecsToReplace[n].name,t),i&&-1!==i&&(Array.isArray(i)&&(i=i[0]),e.codecsToReplace[n].value=i)},s.addLocalStream=function(e){var t,n=!1,i=s.canOriginatorSendLocalVideo(e);e.localMedia.stream&&(i?(t=s.getRtcLibrary().getURLFromStream(e.localMedia.stream),t&&(s.getDefaultVideoContainer()?n=s.useDefaultRenderer(t,!0,!0):s.getLocalVideoContainer()?n=s.createStreamRenderer(t,s.getLocalVideoContainer(),{muted:!0}):(e.call.localStreamURL=t,n=!0))):s.getDefaultVideoContainer()?s.getDefaultVideoContainer().lastElementChild&&s.disposeStreamRenderer(s.getDefaultVideoContainer().lastElementChild):s.getLocalVideoContainer()&&s.disposeStreamRenderer(s.getLocalVideoContainer()),c.debug("onLocalStreamAdded: "+t),n&&s.fireOnLocalStreamAddedEvent(e,t))},s.fireOnLocalStreamAddedEvent=function(e,t){e&&e.call&&e.call.onLocalStreamAdded&&o.callFunctionIfExist(e.call.onLocalStreamAdded,t)},s.storeLocalStreamToCall=function(e,t){c.debug("assigning local stream ["+t+"] to call: "+e.id),e.localMedia&&s.endLocalMedia(e.localMedia),s.updateLocalStreamToCall(e,t)},s.updateLocalStreamToCall=function(e,t){e.localMedia=s.getLocalStreamMap().get(t)},s.performSdpWorkaroundsBeforeProcessingIncomingSdp=function(e){e.sdp=r.deleteBandwidthLineFromSdp(e.sdp),e.sdp=r.removeG722Codec(e.sdp)},s.createReOffer=function(e,t,n,i){var a,d,l,u,f,p=e.peer,E=e.peer.localDescription.sdp;c.debug("createReOffer:"+e.id),f={call:e,mustCreatePeer:!0},s.createNewPeerForCall(f)&&(p=e.peer),p.createOffer(function(t){i?(d=r.getAudioSdpDirection(E),t.sdp=r.updateAudioSdpDirection(t.sdp,d),l=r.getVideoSdpDirection(E),t.sdp=r.updateVideoSdpDirection(t.sdp,l)):(l=r.getVideoSdpDirection(E),u=r.getVideoSdpDirection(t.sdp),l===v.WEBRTC.MEDIA_STATE.INACTIVE&&u===v.WEBRTC.MEDIA_STATE.SEND_RECEIVE&&(t.sdp=r.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY))),t.sdp=r.deleteCryptoZeroFromSdp(t.sdp),t.sdp=r.updateAudioCodec(t.sdp),t.sdp=r.removeG722Codec(t.sdp),t.sdp=r.deleteCryptoFromSdp(t.sdp,s.isDtlsEnabled()),t.sdp=r.setTcpSetupAttributeToActpass(t.sdp,s.isDtlsEnabled()),t.sdp=r.updateVersion(E,t.sdp),t=s.performSdpWorkaroundsAfterCreateOffer(e,t),a=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,t.sdp),p.setLocalDescription(a,function(){c.debug("createReOffer: setLocalDescription success"+e.id)},function(t){c.debug("createReOffer: setLocalDescription failed!!"+t+e.id),o.callFunctionIfExist(n)})},function(e){c.error("createReOffer: createOffer failed!! "+e),o.callFunctionIfExist(n)},{mandatory:{OfferToReceiveAudio:s.getMediaAudio(),OfferToReceiveVideo:s.getMediaVideo()}})},s.getLocalAudioTrack=function(e){c.debug("getLocalAudioTrack");var t;if(e.localStreams&&e.localStreams[d].audioTracks){if(e.localStreams[d].audioTracks.length>0)return e.localStreams[d].audioTracks[d]}else if(e.getLocalStreams&&(t=e.getLocalStreams()[d].getAudioTracks(),t&&t.length>0))return t[d];return null},s.getLocalVideoTrack=function(e){c.debug("getLocalVideoTrack");var t;if(e.localStreams&&e.localStreams[d].videoTracks){if(e.localStreams[d].videoTracks.length>0)return e.localStreams[d].videoTracks[d]}else if(e.getLocalStreams&&(t=e.getLocalStreams(),t&&t[d].getVideoTracks()&&t[d].getVideoTracks().length>0))return t[d].getVideoTracks()[d];return null},s.setFcsUserMuteState=function(e,t){e.fcsUserMuteState=t},s.muteAudioTrack=function(e,t){var n;return s.isInitialized()?void(e.peer&&(n=s.getLocalAudioTrack(e.peer),n&&(c.info("mute Audio Track ["+n.id+"], call ["+e.id+"] mute="+t),n.enabled=!t,e.audioMuted=t,s.setFcsUserMuteState(e,t)))):void c.warn("muteAudioTrack: Plugin is not installed")},s.muteVideoTrack=function(e,t){var n;return s.isInitialized()?void(e.peer&&(n=s.getLocalVideoTrack(e.peer),n&&(c.info("mute Video Track ["+n.id+"], call ["+e.id+"] mute="+t),n.enabled=!t,e.videoMuted=t))):void c.warn("muteVideoTrack: Plugin is not installed")},s.isAudioMuted=function(e){return e&&e.audioMuted?e.audioMuted:!1},s.restoreMuteStateOfCall=function(e){var t=!1,n=!1;e.peer&&(e.fcsUserMuteState&&(t=e.fcsUserMuteState),c.debug("previous mute state of call: "+t),s.muteAudioTrack(e,t),s.muteVideoTrack(e,n))},s.muteOnHold=function(e,t){s.muteAudioTrack(e,t),s.muteVideoTrack(e,t)},s.initMedia=function(e,n,i){function o(){s.getRtcLibrary().checkMediaSourceAvailability(function(e){s.setMediaSources(e)})}s.setInitialized(!0),t(s.getRtcLibrary()),i&&(i.localVideoContainer&&s.setLocalVideoContainer(i.localVideoContainer),i.remoteVideoContainer&&s.setRemoteVideoContainer(i.remoteVideoContainer),i.videoContainer&&s.setDefaultVideoContainer(i.videoContainer)),s.getRtcLibrary().initScreenSharing(function(){o(),q.callFunctionIfExist(e)},function(e){o(),q.callFunctionIfExist(n,e)},i)},s.performVideoStartWorkaround=function(e,t,n){var i,a,d,l,u=e.peer;c.debug("Workaround to play video"),l=e.peer.localDescription.sdp,e.sdp=r.addSdpMissingCryptoLine(e.sdp),i=r.getAudioSdpDirection(e.sdp),a=r.getVideoSdpDirection(e.sdp),e.sdp=r.updateAudioSdpDirectionToInactive(e.sdp),e.sdp=r.updateVideoSdpDirectionToInactive(e.sdp),e.sdp=r.setTcpSetupAttributeToActpass(e.sdp,s.isDtlsEnabled()),d=r.deleteSsrcFromSdp(e.sdp),u.setRemoteDescription(s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,d),function(){c.debug("performVideoStartWorkaround: first setRemoteDescription success"),e.sdp=r.updateAudioSdpDirection(e.sdp,i),e.sdp=r.updateVideoSdpDirection(e.sdp,a),u.setRemoteDescription(s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),function(){c.debug("performVideoStartWorkaround: second setRemoteDescription success"),u.createAnswer(function(d){i===v.WEBRTC.MEDIA_STATE.INACTIVE&&(d.sdp=r.updateAudioSdpDirectionToInactive(d.sdp)),a===v.WEBRTC.MEDIA_STATE.INACTIVE?d.sdp=r.updateVideoSdpDirectionToInactive(d.sdp):s.canOriginatorSendLocalVideo(e)?d.sdp=r.updateVideoSdpDirection(d.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):d.sdp=r.updateVideoSdpDirection(d.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),d.sdp=r.checkAndRestoreICEParams(d.sdp,e.sdp),d.sdp=r.setTcpSetupAttributeTo(d.sdp,e.localTcpSetupAttribute,s.isDtlsEnabled()),d.sdp=r.updateVersion(l,d.sdp),u.setLocalDescription(s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.ANSWER,d.sdp),function(){c.debug("performVideoStartWorkaround: setlocalDescription success"),o.callFunctionIfExist(t)},function(e){c.debug("performVideoStartWorkaround: setlocalDescription failed!!"+e),o.callFunctionIfExist(n,"performVideoStartWorkaround: setlocalDescription failed!!")})},function(e){c.debug("performVideoStartWorkaround: createAnswer failed!! "+e),o.callFunctionIfExist(n,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:s.getMediaAudio(),OfferToReceiveVideo:s.getMediaVideo()}})},function(e){c.debug("performVideoStartWorkaround: second setRemoteDescription failed!!"+e),o.callFunctionIfExist(n,"performVideoStartWorkaround: second setRemoteDescription failed!!")})},function(e){c.debug("performVideoStartWorkaround: first setRemoteDescription failed!!"+e),o.callFunctionIfExist(n,"performVideoStartWorkaround: first setRemoteDescription failed!!")})},s.getUserMedia=function(e){s.getRtcLibrary().checkMediaSourceAvailability(function(t){var n,i,r,l={audio:!1,video:!1};return s.setMediaSources(t),t&&!t.audioSourceAvailable?(c.debug("Failed to get access to local media."),void o.callFunctionIfExist(e.onFailure,a.NOT_FOUND)):(s.getMediaVideo()&&s.getVideoSourceAvailable()&&(l.video=e.options.videoConstraints),s.getMediaAudio()&&s.getAudioSourceAvailable()&&(l.audio=e.options.audioConstraints),c.debug("getUserMedia - constraints: ",l),void s.getRtcLibrary().getUserMedia(l,function(t){s.initAudioContext(),i=s.getAudioContext().createMediaStreamSource(t),s.initMediaStreamDestination(),i.connect(s.getMediaStreamDestination()),t.getVideoTracks()&&t.getVideoTracks()[d]&&s.getMediaStreamDestination().stream.addTrack(t.getVideoTracks()[d]),r={audioContext:s.getAudioContext(),mediaStreamDestination:s.getMediaStreamDestination(),stream:s.getMediaStreamDestination().stream,originalStream:t},s.setLocalMedia(r),s.getLocalStreamMap().add(r.stream.id,r),s.setInitialized(!0),n={audio:s.getMediaAudio(),video:s.getMediaVideo(),id:r.stream.id,originalStream:t,streamURL:s.getRtcLibrary().getURLFromStream(t)},c.debug("user has granted access to local media: ",r),o.callFunctionIfExist(e.onSuccess,n)},function(t){c.debug("Failed to get access to local media. Error code was "+t.code),o.callFunctionIfExist(e.onFailure,a.NOT_ALLOWED)}))})},s.replaceVideoStream=function(e){var t,n,i,o=s.getMediaStreamDestination(),r=0;if(o&&(t=o.stream)){for(n=t.id,i=t.getVideoTracks();r<i.length;++r)t.removeTrack(i[r]);e&&e.getVideoTracks()&&e.getVideoTracks()[d]&&t.addTrack(e.getVideoTracks()[d])}return{audio:s.getMediaAudio(),video:s.getMediaVideo(),id:n}},s.startScreenMedia=function(e,t,n){s.getRtcLibrary().checkMediaSourceAvailability(function(i){var o;s.setMediaSources(i),s.getScreenSourceAvailable()?(o={mandatory:{maxFrameRate:s.getScreenFrameRate(),maxWidth:s.getScreenWidth(),maxHeight:s.getScreenHeight()}},s.getRtcLibrary().getScreenMedia({video:o},function(t){var i=s.replaceVideoStream(t),o=s.getScreenStream();o&&(o.onended=null,s.getRtcLibrary().stopStream(o)),t.onended=n,s.setScreenStream(t),c.debug("user granted access to local media."),q.callFunctionIfExist(e,i)},function(){c.debug("Failed to get access to screen media."),q.callFunctionIfExist(t,R.call.MediaErrors.NOT_ALLOWED)},n)):q.callFunctionIfExist(t,R.call.MediaErrors.NOT_FOUND)})},s.stopScreenMedia=function(){var e=s.getScreenStream();s.replaceVideoStream(s.getLocalMedia().originalStream),e&&(s.getRtcLibrary().stopStream(e),s.setScreenStream(null))},s.createOffer=function(e,t,n,i){c.debug("createOffer: sendInitialVideo= "+i+" state= "+e.peer.signalingState);var a=e.peer;e.peer.addStream(e.localMedia.stream),s.addCallIdInPluginContainer(e),a.createOffer(function(t){i=i&&s.getVideoSourceAvailable(),i?t.sdp=r.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):t.sdp=r.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),t.sdp=r.deleteCryptoZeroFromSdp(t.sdp),t.sdp=r.updateAudioCodec(t.sdp),t.sdp=r.removeG722Codec(t.sdp),t.sdp=r.deleteCryptoFromSdp(t.sdp,s.isDtlsEnabled()),t.sdp=r.setTcpSetupAttributeToActpass(t.sdp,s.isDtlsEnabled()),t=s.performSdpWorkaroundsAfterCreateOffer(e,t),a.setLocalDescription(s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,t.sdp),function(){},function(e){c.error("createOffer: setLocalDescription failed : "+e),o.callFunctionIfExist(n,"createOffer: setLocalDescription failed")})},function(e){c.error("createOffer: createOffer failed!! "+e),o.callFunctionIfExist(n)},{mandatory:{OfferToReceiveAudio:s.getMediaAudio(),OfferToReceiveVideo:s.getMediaVideo()}})},s.createAnswer=function(e,t,n,i){c.debug("createAnswer: isVideoEnabled= "+i+" state= "+e.peer.signalingState);var a=e.peer;e.peer.addStream(e.localMedia.stream),e.sdp=r.checkSupportedVideoCodecs(e.sdp,null,s.isH264Enabled()),e.sdp=r.changeDirection(e.sdp,v.WEBRTC.MEDIA_STATE.INACTIVE,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE,v.STRING.AUDIO),e.sdp=r.deleteFingerprintOrCrypto(e.sdp,s.isDtlsEnabled()),s.addCallIdInPluginContainer(e),r.isSdpVideoSendEnabled(e.sdp)||(e.sdp=r.deleteInactiveVideoSsrc(e.sdp)),a.setRemoteDescription(s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),function(){
e.remoteVideoState=r.getSdpDirection(e.sdp,v.STRING.VIDEO),a.createAnswer(function(t){i=i&&s.getVideoSourceAvailable()&&r.isSdpHasVideo(e.sdp),i?r.isSdpVideoSendEnabled(e.sdp)?t.sdp=r.updateSdpDirection(t.sdp,v.STRING.VIDEO,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):r.getVideoSdpDirection(e.sdp)!==v.WEBRTC.MEDIA_STATE.INACTIVE?t.sdp=r.updateSdpDirection(t.sdp,v.STRING.VIDEO,v.WEBRTC.MEDIA_STATE.SEND_ONLY):t.sdp=r.updateSdpDirection(t.sdp,v.STRING.VIDEO,v.WEBRTC.MEDIA_STATE.INACTIVE):r.isSdpVideoSendEnabled(e.sdp)?t.sdp=r.updateSdpDirection(t.sdp,v.STRING.VIDEO,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY):t.sdp=r.updateSdpDirection(t.sdp,v.STRING.VIDEO,v.WEBRTC.MEDIA_STATE.INACTIVE),s.muteOnHold(e,!1),t.sdp=r.checkAndRestoreICEParams(t.sdp,e.sdp),a.setLocalDescription(s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.ANSWER,t.sdp),function(){e.videoOfferSent=r.isSdpHasVideo(t.sdp),s.setTcpSetupAttiributesOnCreateAnswer(e,t.sdp)},function(e){c.error("createAnswer: setLocalDescription failed : "+e),o.callFunctionIfExist(n,"createNativeAnswer setLocalDescription failed")})},function(e){c.error("createAnswer: failed!! Error: "+e),o.callFunctionIfExist(n,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:s.getMediaAudio(),OfferToReceiveVideo:s.getMediaVideo()}})},function(e){c.error("createAnswer: setremotedescription failed!! Error: "+e)})},s.createUpdate=function(e,t,n,i){c.debug("createUpdate: isVideoStart= "+i+" state= "+e.peer.signalingState);var a,d,l,u,f=e.peer;u=O.iceLiteVideoWorkaround&&r.isIceLite(e.sdp)&&i||r.isRemoteEndFirefox(e.sdp),a=e.peer.localDescription.sdp,c.debug("create new offer to start the video"),l={call:e,mustCreatePeer:u},s.createNewPeerForCall(l)&&(c.debug("remote end is firefox"),f=e.peer),f.removeStream(f.getLocalStreams()[0]),f.addStream(e.localMedia.stream),s.setMediaVideo(!0),f.createOffer(function(t){i=i&&s.getVideoSourceAvailable(),i?t.sdp=r.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):r.isVideoSdpDirectionInactive(e.stableRemoteSdp)?t.sdp=r.updateVideoSdpDirectionToInactive(t.sdp):t.sdp=r.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),t.sdp=r.updateVersion(a,t.sdp),t.sdp=r.setTcpSetupAttributeToActpass(t.sdp,s.isDtlsEnabled()),t.sdp=r.deleteCryptoZeroFromSdp(t.sdp),t.sdp=r.updateAudioCodec(t.sdp),t.sdp=r.removeG722Codec(t.sdp),t.sdp=r.deleteCryptoFromSdp(t.sdp,s.isDtlsEnabled()),t=s.performSdpWorkaroundsAfterCreateOffer(e,t),d=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,t.sdp),f.setLocalDescription(d,function(){c.debug("createUpdate setLocalDescription success. iceConnectionState: "+f.iceConnectionState+" iceGatheringState: "+f.iceGatheringState),"complete"===f.iceGatheringState&&e.successCallback&&(c.debug("createUpdate iceGatheringState completed "+f.localDescription.sdp),e.successCallback(f.localDescription.sdp))},function(e){c.debug("createUpdate: createOffer setLocalDescription failed: "+e),o.callFunctionIfExist(n)})},function(e){c.debug("createUpdate: createOffer failed!!: "+e),n()},{mandatory:{OfferToReceiveAudio:s.getMediaAudio(),OfferToReceiveVideo:s.getMediaVideo()}})},s.revertRtcState=function(e,t,n){var i,a=e.peer,d=e.stableLocalSdp,l=e.stableRemoteSdp,u=a.signalingState;switch(l=r.deleteGoogleIceFromSdp(l),u){case v.WEBRTC.RTC_SIGNALING_STATE.STABLE:case v.WEBRTC.RTC_SIGNALING_STATE.HAVE_LOCAL_OFFER:d=r.setTcpSetupAttributeToActpass(d,s.isDtlsEnabled()),i=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,d),a.setLocalDescription(i,function(){c.debug("revertRtcState[stable|local_offer]: setLocalDescription success"),l=r.setTcpSetupAttributeTo(l,e.remoteTcpSetupAttribute,s.isDtlsEnabled()),i=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.ANSWER,l),a.setRemoteDescription(i,function(){c.debug("revertRtcState[stable|local_offer]: setRemoteDescription success"),"complete"===a.iceGatheringState&&o.callFunctionIfExist(t)},function(t){c.error("revertRtcState[stable|local_offer]: setRemoteDescription failed: "+t),o.callFunctionIfExist(n,e)})},function(t){c.error("revertRtcState[stable|local_offer]: setLocalDescription failed: "+t),o.callFunctionIfExist(n,e)});break;case v.WEBRTC.RTC_SIGNALING_STATE.HAVE_REMOTE_OFFER:l=r.setTcpSetupAttributeToActpass(l,s.isDtlsEnabled()),i=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,l),a.setRemoteDescription(i,function(){c.debug("revertRtcState[remote_offer]: setLocalDescription success"),d=r.setTcpSetupAttributeTo(d,e.localTcpSetupAttribute,s.isDtlsEnabled()),i=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.ANSWER,d),a.setLocalDescription(i,function(){c.debug("revertRtcState[remote_offer]: setRemoteDescription success"),"complete"===a.iceGatheringState&&o.callFunctionIfExist(t)},function(t){c.error("revertRtcState[remote_offer]: setRemoteDescription failed: "+t),o.callFunctionIfExist(n,e)})},function(t){c.error("revertRtcState[remote_offer]: setLocalDescription failed: "+t),o.callFunctionIfExist(n,e)});break;default:c.debug("revertRtcState: not applicible for state: "+u)}},s.createHoldUpdate=function(e,t,n,i,a){c.debug("createHoldUpdate: local hold= "+t+" remote hold= "+n+" state= "+e.peer.signalingState);var d,l,u,f,p,E=e.peer;f=E.localDescription.sdp,d=r.getAudioSdpDirection(f),l=r.getVideoSdpDirection(f),p={call:e,mustCreatePeer:r.isRemoteEndFirefox(e.sdp)},s.createNewPeerForCall(p)&&(c.debug("remote end is firefox"),E=e.peer),E.createOffer(function(i){i.sdp=r.updateVersion(f,i.sdp),i.sdp=r.deleteCryptoZeroFromSdp(i.sdp),i.sdp=r.setTcpSetupAttributeToActpass(i.sdp,s.isDtlsEnabled()),i=s.performSdpWorkaroundsAfterCreateOffer(e,i),t||n?(d===v.WEBRTC.MEDIA_STATE.SEND_RECEIVE?i.sdp=r.updateAudioSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_ONLY):!t&&n?i.sdp=r.updateAudioSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):i.sdp=r.updateAudioSdpDirectionToInactive(i.sdp),l===v.WEBRTC.MEDIA_STATE.SEND_RECEIVE?i.sdp=r.updateVideoSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_ONLY):!t&&n?i.sdp=r.updateVideoSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):i.sdp=r.updateVideoSdpDirectionToInactive(i.sdp)):(i.sdp=r.updateAudioSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE),s.canOriginatorSendLocalVideo(e)?i.sdp=r.updateVideoSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):i.sdp=r.updateVideoSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)),u=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,i.sdp),E.setLocalDescription(u,function(){c.debug("createHoldUpdate setLocalDescription success. iceConnectionState: "+E.iceConnectionState+" iceGatheringState: "+E.iceGatheringState),"complete"===E.iceGatheringState&&e.successCallback&&(c.debug("createHoldUpdate iceGatheringState completed "+E.localDescription.sdp),e.successCallback(E.localDescription.sdp))},function(e){c.error("createHoldUpdate: setLocalDescription failed: "+e.message),o.callFunctionIfExist(a)})},function(e){c.error("createHoldUpdate: createOffer failed: "+e.message),o.callFunctionIfExist(a)},{mandatory:{OfferToReceiveAudio:s.getMediaAudio(),OfferToReceiveVideo:s.getMediaVideo()}})},s.processHold=function(e,t,n,i,a){c.debug("processHold: local hold= "+n+" remote hold= "+t+" state= "+e.peer.signalingState);var d,l,u,f,p,E,S,T=e.peer;n||t||s.muteOnHold(e,!1),e.sdp=r.checkSupportedVideoCodecs(e.sdp,null,s.isH264Enabled()),e.sdp=r.performVideoPortZeroWorkaround(e.sdp),e.sdp=r.checkAndRestoreICEParams(e.sdp,e.peer.localDescription.sdp),l=r.getAudioSdpDirection(e.sdp),u=r.getVideoSdpDirection(e.sdp),f=e.prevRemoteSdp,p=T.localDescription.sdp,d=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),E=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,d.sdp),E.sdp=r.updateAudioSdpDirectionToInactive(E.sdp),E.sdp=r.updateVideoSdpDirectionToInactive(E.sdp),S={call:e,oldSdp:e.prevRemoteSdp,newSdp:e.sdp},s.createNewPeerForCall(S)&&(T=e.peer),E.sdp=r.deleteSsrcFromSdp(E.sdp),T.setRemoteDescription(E,function(){d.sdp=r.updateAudioSdpDirection(d.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE),r.getVideoSdpDirection(d.sdp)!==v.WEBRTC.MEDIA_STATE.INACTIVE&&r.getVideoSdpDirection(d.sdp)!==v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY||(d.sdp=r.deleteInactiveVideoSsrc(d.sdp)),T.setRemoteDescription(d,function(){t||n||u!==v.WEBRTC.MEDIA_STATE.INACTIVE?e.remoteVideoState=r.getVideoSdpDirection(d.sdp):e.remoteVideoState=v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,T.createAnswer(function(i){c.debug("processHold: isSdpEnabled audio= "+r.isAudioSdpEnabled(i.sdp)),c.debug("processHold: isSdpEnabled video= "+r.isVideoSdpEnabled(i.sdp)),t?(c.debug("processHold: Remote HOLD"),i.sdp=r.respondToRemoteSdpDirections(i.sdp,e.sdp)):n?n&&!t&&(c.debug("processHold: Remote UNHOLD on local hold"),l===v.WEBRTC.MEDIA_STATE.INACTIVE?i.sdp=r.updateAudioSdpDirectionToInactive(i.sdp):i.sdp=r.updateAudioSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_ONLY),s.canOriginatorSendLocalVideo(e)?i.sdp=r.updateVideoSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_ONLY):i.sdp=r.updateVideoSdpDirectionToInactive(i.sdp)):(c.debug("processHold: Remote UNHOLD: direction left as it is"),r.isSdpVideoSendEnabled(e.sdp)?s.canOriginatorSendLocalVideo(e)?i.sdp=r.updateVideoSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):i.sdp=r.updateVideoSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY):s.canOriginatorSendLocalVideo(e)&&!r.isVideoSdpDirectionInactive(e.sdp)?i.sdp=r.updateVideoSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_ONLY):i.sdp=r.updateVideoSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.INACTIVE),i.sdp=r.changeDirection(i.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE,v.STRING.AUDIO)),i.sdp=r.updateVersion(p,i.sdp),i.sdp=r.checkIceParamsLengths(i.sdp,d.sdp),i.sdp=r.setTcpSetupAttributeTo(i.sdp,e.localTcpSetupAttribute,s.isDtlsEnabled()),T.setLocalDescription(i,function(){c.debug("processHold: setLocalDescription success!! iceConnectionState: "+T.iceConnectionState+" iceGatheringState: "+T.iceGatheringState),"complete"===T.iceGatheringState&&e.successCallback&&(c.debug("processHold iceGatheringState completed "+T.localDescription.sdp),e.successCallback(T.localDescription.sdp))},function(e){c.error("processHold: setLocalDescription failed!! "+e),o.callFunctionIfExist(a,"Session cannot be created")})},function(e){c.error("processHold: createAnswer failed!!: "+e),o.callFunctionIfExist(a,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:s.getMediaAudio(),OfferToReceiveVideo:s.getMediaVideo()}})},function(e){c.error("processHold: second setRemoteDescription failed!! "+e),o.callFunctionIfExist(a,"Session cannot be created")})},function(e){c.debug("processHold: first setRemoteDescription failed!! "+e),o.callFunctionIfExist(a,"Session cannot be created")})},s.processUpdate=function(e,t,n,i){c.debug("processUpdate: state= "+e.peer.signalingState);var a,d,l,u,f,p,E,S,T,g,m,C=e.peer;if(e.sdp=r.addSdpMissingCryptoLine(e.sdp),e.sdp=r.checkAndRestoreICEParams(e.sdp,e.peer.localDescription.sdp),l=r.getVideoSdpDirection(e.sdp),u=r.getVideoSdpDirection(C.localDescription.sdp),s.setMediaVideo(r.isSdpHasVideo(e.sdp)),l===v.WEBRTC.MEDIA_STATE.INACTIVE&&"COMPLETED"===e.currentState)switch(e.remoteVideoState){case v.WEBRTC.MEDIA_STATE.INACTIVE:case v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY:e.sdp=r.updateVideoSdpDirection(e.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE);break;case v.WEBRTC.MEDIA_STATE.SEND_RECEIVE:e.sdp=r.updateVideoSdpDirection(e.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)}e.sdp=r.changeDirection(e.sdp,v.WEBRTC.MEDIA_STATE.SEND_ONLY,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE,v.STRING.VIDEO),e.sdp=r.checkSupportedVideoCodecs(e.sdp,null,s.isH264Enabled()),a=r.getAudioSdpDirection(e.sdp),d=r.getVideoSdpDirection(e.sdp),e.sdp=r.setTcpSetupAttributeToActpass(e.sdp,s.isDtlsEnabled()),d!==v.WEBRTC.MEDIA_STATE.INACTIVE&&d!==v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY||(e.sdp=r.deleteInactiveVideoSsrc(e.sdp)),S=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,e.prevRemoteSdp),T=C.localDescription.sdp,m={call:e,oldSdp:e.prevRemoteSdp,newSdp:e.sdp},s.createNewPeerForCall(m)&&(C=e.peer),g=function(){p=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),C.setRemoteDescription(p,function(){c.debug("processUpdate: setRemoteDescription success"),e.remoteVideoState=r.getVideoSdpDirection(e.sdp),C.createAnswer(function(t){c.debug("processUpdate: isSdpEnabled audio= "+r.isAudioSdpEnabled(t.sdp)),c.debug("processUpdate: isSdpEnabled video= "+r.isVideoSdpEnabled(t.sdp)),r.isSdpVideoSendEnabled(e.sdp)?s.canOriginatorSendLocalVideo(e)?t.sdp=r.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):t.sdp=r.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY):s.canOriginatorSendLocalVideo(e)&&!r.isVideoSdpDirectionInactive(e.sdp)?t.sdp=r.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.SEND_ONLY):t.sdp=r.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.INACTIVE),t.sdp=r.updateVersion(T,t.sdp),t.sdp=r.checkIceParamsLengths(t.sdp,p.sdp),t.sdp=r.setTcpSetupAttributeTo(t.sdp,e.localTcpSetupAttribute,s.isDtlsEnabled()),E=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.ANSWER,t.sdp),C.setLocalDescription(E,function(){c.debug("processUpdate setLocalDescription success. iceConnectionState: "+C.iceConnectionState+" iceGatheringState: "+C.iceGatheringState),"complete"===C.iceGatheringState&&e.successCallback&&(c.debug("processUpdate iceGatheringState completed "+C.localDescription.sdp),e.successCallback(C.localDescription.sdp))},function(e){c.debug("processUpdate: setlocalDescription failed!!"+e),o.callFunctionIfExist(n,"processUpdate: setlocalDescription failed!!")})},function(e){c.debug("processUpdate: createAnswer failed!! "+e),o.callFunctionIfExist(n,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:s.getMediaAudio(),OfferToReceiveVideo:s.getMediaVideo()}})},function(e){c.debug("processUpdate: setRemoteDescription failed!!"+e),o.callFunctionIfExist(n,"processUpdate: setRemoteDescription failed!!")})},r.isSdpHasVideo(e.prevRemoteSdp)||r.isIceLite(e.sdp)||i?(e.sdp=r.updateAudioSdpDirectionToInactive(e.sdp),e.sdp=r.updateVideoSdpDirectionToInactive(e.sdp),f=r.deleteSsrcFromSdp(e.sdp),p=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,f),C.setRemoteDescription(p,function(){c.debug("processUpdate: workaround setRemoteDescription success"),e.sdp=r.updateAudioSdpDirection(e.sdp,a),e.sdp=r.updateVideoSdpDirection(e.sdp,d),g()},function(e){c.debug("processUpdate: workaround setRemoteDescription failed!!"+e),o.callFunctionIfExist(n,"processUpdate: workaround setRemoteDescription failed!!")})):g()},s.processAnswer=function(e,t,n){c.debug("processAnswer: state= "+e.peer.signalingState);var i,a,d,l,u,f=e.peer;return i=function(){e.remoteVideoState=r.getVideoSdpDirection(e.sdp),e.videoOfferSent=r.isSdpHasVideo(e.sdp),o.callFunctionIfExist(t)},a=function(e,t,n){e.peer.setRemoteDescription(s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),function(){c.debug("processAnswer: setRemoteDescription success"),t()},function(e){c.error("processAnswer: setRemoteDescription failed: "+e),n()})},s.setTcpSetupAttiributesOnProcessAnswer(e,e.sdp),e.sdp=r.checkSupportedVideoCodecs(e.sdp,f.localDescription.sdp,s.isH264Enabled()),e.sdp=r.performVideoPortZeroWorkaround(e.sdp),f.signalingState===v.WEBRTC.RTC_SIGNALING_STATE.HAVE_REMOTE_PRANSWER?r.isIceLite(e.prevRemoteSdp)!==r.isIceLite(e.sdp)?(c.debug("ice - ice-lite change."),void n(v.WEBRTC.ERROR.ICE_ICELITE)):(u=e.sdp,e.sdp=r.updateVideoSdpDirection(e.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),e.sdp=r.updateAudioSdpDirection(e.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),c.debug("call processPrAnswer again to trigger on remote stream added with updated sdp."),void s.processPreAnswer(e,function(){e.sdp=u,c.debug("processPrAnswer success callback. Restore original sdp."),a(e,i,n)},function(){e.sdp=u,c.debug("processPrAnswer failure callback. Restore original sdp."),a(e,i,n)})):(d=r.getVideoSdpDirection(e.sdp),l=r.getVideoSdpDirection(e.peer.localDescription.sdp),c.debug("processAnswer: ice-lite: do remote video escalation"),e.sdp=r.changeDirection(e.sdp,v.WEBRTC.MEDIA_STATE.SEND_ONLY,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE),void(l!==v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY&&l!==v.WEBRTC.MEDIA_STATE.SEND_RECEIVE||d!==v.WEBRTC.MEDIA_STATE.INACTIVE&&d!==v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY?l!==v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY||d!==v.WEBRTC.MEDIA_STATE.SEND_ONLY&&d!==v.WEBRTC.MEDIA_STATE.SEND_RECEIVE?a(e,i,n):a(e,function(){s.performVideoStartWorkaround(e,i,n)},n):(e.sdp=r.deleteInactiveVideoSsrc(e.sdp),a(e,i,n))))},s.processPreAnswer=function(e,t,n){c.debug("processPreAnswer: state= "+e.peer.signalingState);var i,o=e.peer;e.sdp=r.checkSupportedVideoCodecs(e.sdp,e.peer.localDescription.sdp,s.isH264Enabled()),i=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.PRANSWER,e.sdp),o.setRemoteDescription(i,function(){s.setOriginatorReceiveRemoteVideo(e),e.remoteVideoState=r.getVideoSdpDirection(e.sdp),t(),c.debug("processPreAnswer: setRemoteDescription success")},function(e){c.error("processPreAnswer: setRemoteDescription failed: "+e),n(e)})},s.processRespond=function(e,t,n,i){var a,d,l,u=e.peer;if(c.debug("processRespond: state= "+e.peer.signalingState),e.sdp=r.checkSupportedVideoCodecs(e.sdp,u.localDescription.sdp,s.isH264Enabled()),a=r.getVideoSdpDirection(e.sdp),a===v.WEBRTC.MEDIA_STATE.INACTIVE&&"COMPLETED"===e.currentState)switch(e.remoteVideoState){case v.WEBRTC.MEDIA_STATE.INACTIVE:case v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY:e.sdp=r.updateVideoSdpDirection(e.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)}return e.sdp=r.changeDirection(e.sdp,v.WEBRTC.MEDIA_STATE.SEND_ONLY,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE,v.STRING.VIDEO),i&&(e.sdp=r.changeDirection(e.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE,v.STRING.AUDIO),s.muteOnHold(e,!1)),e.peer.signalingState===v.WEBRTC.RTC_SIGNALING_STATE.STABLE?void o.callFunctionIfExist(t):(r.getVideoSdpDirection(e.sdp)!==v.WEBRTC.MEDIA_STATE.INACTIVE&&r.getVideoSdpDirection(e.sdp)!==v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY||(e.sdp=r.deleteInactiveVideoSsrc(e.sdp)),d=r.deleteSsrcFromSdp(e.sdp),l=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.ANSWER,d),void u.setRemoteDescription(l,function(){c.debug("processRespond: setRemoteDescription success");var i=function(){e.remoteVideoState=r.getVideoSdpDirection(e.sdp),e.videoOfferSent=!0,o.callFunctionIfExist(t)};s.performVideoStartWorkaround(e,i,n)},function(e){c.debug("processRespond: setRemoteDescription failed: "+e),o.callFunctionIfExist(n)}))},s.processHoldRespond=function(e,t,n,i){var a,d,l,u,f,p=!1,E=!1;return u=function(){o.callFunctionIfExist(t)},c.debug("processHoldRespond: state= "+e.peer.signalingState+" call.currentState= "+e.currentState),e.sdp=r.checkSupportedVideoCodecs(e.sdp,e.peer.localDescription.sdp,s.isH264Enabled()),r.init(e.sdp),E=r.isRemoteHold(),p="LOCAL_HOLD"===e.currentState,p||s.addCallIdInPluginContainer(e),a=r.getAudioSdpDirection(e.sdp),d=r.getVideoSdpDirection(e.sdp),e.remoteVideoState=d,l=r.getVideoSdpDirection(e.peer.localDescription.sdp),c.debug("processHoldRespond: localHold= "+p+" remoteHold= "+E),E===!1?a===v.WEBRTC.MEDIA_STATE.SEND_RECEIVE&&"REMOTE_HOLD"===e.currentState&&(c.debug("set current web state to COMPLETED"),e.previousState=e.currentState,e.currentState="COMPLETED"):"COMPLETED"===e.currentState&&(c.debug("set current web state to REMOTE_HOLD"),e.previousState=e.currentState,e.currentState="REMOTE_HOLD"),(p||E)&&(c.debug("processHoldRespond: "+e.currentState+" : video -> inactive"),e.sdp=r.updateVideoSdpDirection(e.sdp,v.WEBRTC.MEDIA_STATE.INACTIVE)),d===v.WEBRTC.MEDIA_STATE.INACTIVE&&"COMPLETED"===e.currentState&&(c.debug("processHoldRespond: video inactive -> recvonly"),e.sdp=r.updateVideoSdpDirection(e.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)),i&&s.muteOnHold(e,!1),e.peer.signalingState===v.WEBRTC.RTC_SIGNALING_STATE.STABLE?void o.callFunctionIfExist(t):(e.sdp=r.changeDirection(e.sdp,v.WEBRTC.MEDIA_STATE.SEND_ONLY,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE),r.getVideoSdpDirection(e.sdp)!==v.WEBRTC.MEDIA_STATE.INACTIVE&&r.getVideoSdpDirection(e.sdp)!==v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY||(e.sdp=r.deleteInactiveVideoSsrc(e.sdp)),p&&a===v.WEBRTC.MEDIA_STATE.SEND_RECEIVE&&(c.debug("processHoldRespond: Mute Remote Audio"),e.sdp=r.updateAudioSdpDirection(e.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)),p&&d===v.WEBRTC.MEDIA_STATE.SEND_RECEIVE&&(c.debug("processHoldRespond: Mute Remote Video"),e.sdp=r.updateVideoSdpDirection(e.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)),f=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),void e.peer.setRemoteDescription(f,function(){c.debug("processHoldRespond: setRemoteDescription typeAns success"),a===v.WEBRTC.MEDIA_STATE.INACTIVE||a===v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY?u():s.performVideoStartWorkaround(e,u,n)},function(e){c.debug("processHoldRespond: setRemoteDescription typeAns failed: "+e),o.callFunctionIfExist(n)}))},s.processRemoteOfferOnLocalHold=function(e,t,n){c.info("processRemoteOfferOnLocalHold"),e.peer?o.callFunctionIfExist(t,e.peer.localDescription.sdp):o.callFunctionIfExist(n,"we dont have a peer object somehow")},s.removeJslIdFromContainer=function(){s.getDefaultVideoContainer()?(s.getDefaultVideoContainer().removeAttribute("jsl-id"),s.disposeStreamRenderer(s.getDefaultVideoContainer().lastElementChild)):s.getLocalVideoContainer()&&(s.getLocalVideoContainer().removeAttribute("jsl-id"),s.disposeStreamRenderer(s.getLocalVideoContainer()))},s.clearLocalMediaProperties=function(e){e.stream=null,e.originalStream=null,e.audioContext=null,e.mediaStreamDestination=null},s.endLocalMedia=function(e){e.stream&&!e.privateStream&&(c.info("stopping local media "+e.stream.id),s.getLocalStreamMap().remove(e.stream.id),s.getRtcLibrary().detachWebAudioContextFromLocalMedia(e),s.getRtcLibrary().stopLocalMedia(e),s.clearLocalMediaProperties(e))},s.processEnd=function(e){var t,n;if(s.clearIceCandidateCollectionTimer(e),s.clearWebrtcLogCollectionInterval(e),e.peer&&(c.info("close peer connection "+e.id),e.peer.close(),s.endLocalMedia(e.localMedia),s.setPeerCount(s.getPeerCount()-1),s.getPeerCount()<=0)){s.removeJslIdFromContainer(),n=s.getLocalStreamMap().entries();for(t in n)n.hasOwnProperty(t)&&s.endLocalMedia(s.getLocalStreamMap().get(t))}},s.onSessionConnecting=function(){c.debug("onSessionConnecting")},s.onSessionOpened=function(){c.debug("onSessionOpened")},s.onSignalingStateChange=function(e){c.debug("Signalling state changed: state= "+e.peer.signalingState)},s.useDefaultRenderer=function(e,t,n){var i;return s.getDefaultVideoContainer()&&0===s.getDefaultVideoContainer().children.length&&(s.getDefaultVideoContainer().innerHTML="<div style='height:100%;width:100%'></div><div style='position:absolute;bottom:10px;right:10px;height:30%; width:30%;'></div>"),t?i=s.getDefaultVideoContainer().lastElementChild:(i=s.getDefaultVideoContainer().firstElementChild,n?i.style.width="100%":i.style.width="0%"),s.createStreamRenderer(e,i,{muted:t})},s.createStreamRenderer=function(e,t,n){var i;if(e&&t)return t.innerHTML="",i=document.createElement("video"),i.src=e,i.style.width="100%",i.style.height="100%",i.autoplay="true",n&&n.muted&&(i.muted="true"),t.appendChild(i),i},s.addCallIdInPluginContainer=function(e){c.info("addCallIdInPluginContainer Call ID= "+e.id),s.getDefaultVideoContainer()?s.getDefaultVideoContainer().setAttribute("jsl-id",e.id):s.getRemoteVideoContainer()&&s.getRemoteVideoContainer().setAttribute("jsl-id",e.id)},s.isActiveCallInVideoContainer=function(e,t){return c.info("isActiveCallInVideoContainer Call ID= "+t.id),"undefined"===e.getAttribute("jsl-id")||(c.info("isActiveCallInVideoContainer Jsl Id= "+e.getAttribute("jsl-id")),t.id===e.getAttribute("jsl-id"))},s.onRemoteStreamAdded=function(e,t){var n,i,o=[],r=!1;if(s.getDefaultVideoContainer()){if(!s.isActiveCallInVideoContainer(s.getDefaultVideoContainer(),e))return void c.debug("onRemoteStreamAdded: It is not active call. Call Id: "+e.id)}else if(s.getRemoteVideoContainer()&&!s.isActiveCallInVideoContainer(s.getRemoteVideoContainer(),e))return void c.debug("onRemoteStreamAdded: It is not active call. Call Id: "+e.id);t.stream&&(n=s.getRtcLibrary().getURLFromStream(t.stream),n&&(o=t.stream.getVideoTracks(),o&&o.length>0&&(r=!0),i=s.getDefaultVideoContainer()?s.useDefaultRenderer(n,!1,r):s.getRemoteVideoContainer()?s.createStreamRenderer(n,s.getRemoteVideoContainer()):!0),c.debug("onRemoteStreamAdded: "+n),i&&s.fireOnStreamAddedEvent(e,n))},s.fireOnStreamAddedEvent=function(e,t){e&&e.call&&e.call.onStreamAdded&&(s.setOriginatorReceiveRemoteVideo(e),o.callFunctionIfExist(e.call.onStreamAdded,t))},s.onRemoteStreamRemoved=function(){c.debug("onRemoteStreamRemoved")},s.clearIceCandidateCollectionTimer=function(e){clearTimeout(e.iceCandidateCollectionTimer),e.iceCandidateCollectionTimer=null},s.onIceCandidate=function(e,t){var n;null===t.candidate?(c.debug("Null candidate received."),e.successCallback&&(n=e.peer.localDescription.sdp,r.hasCandidates(n,e.relayCandidateCycle,O.relayCandidateCollectionTimeoutCycle)?(s.clearIceCandidateCollectionTimer(e),c.debug("Candidates received, invoking successCallback."),e.successCallback(n)):c.trace("Sdp does not have candidates."))):c.debug("ICE candidate received: sdpMLineIndex = "+t.candidate.sdpMLineIndex+", candidate = "+t.candidate.candidate+" for call : "+e.id)},s.onIceComplete=function(e){var t;c.debug("All ICE candidates received for call : "+e.id),s.clearIceCandidateCollectionTimer(e),e.successCallback&&(t=e.peer.localDescription.sdp,c.debug("onIceComplete sdp : "+t),e.successCallback(t))},s.iceCandidateCollectionTimeoutHandler=function(e){var t=e.peer.localDescription.sdp;return s.clearIceCandidateCollectionTimer(e),O.relayCandidateCollectionTimeoutCycle&&e.relayCandidateCycle++,r.hasCandidates(t,e.relayCandidateCycle,O.relayCandidateCollectionTimeoutCycle)?void(e.successCallback&&(c.debug("Ice candidate collection interrupted after given timeout, invoking successCallback."),e.successCallback(t))):(c.debug("Re-setting ice candidate collection timeout: "+O.iceCandidateCollectionTimeoutInterval),void(e.iceCandidateCollectionTimer=setTimeout(function(){s.iceCandidateCollectionTimeoutHandler(e)},O.iceCandidateCollectionTimeoutInterval)))},s.setupIceCandidateCollectionTimer=function(e){O.iceCandidateCollectionTimeoutInterval&&(e.iceCandidateCollectionTimer?c.trace("Ice candidate collection timer exists."):(c.debug("Setting ice candidate collection timeout: "+O.iceCandidateCollectionTimeoutInterval),O.relayCandidateCollectionTimeoutCycle&&(e.relayCandidateCycle=1),e.iceCandidateCollectionTimer=setTimeout(function(){s.iceCandidateCollectionTimeoutHandler(e)},O.iceCandidateCollectionTimeoutInterval)))},s.clearWebrtcLogCollectionInterval=function(e){clearInterval(e.webrtcLogCollectionInterval),e.webrtcLogCollectionInterval=null},s.webrtcLogCollectionTimeoutHandler=function(e){e&&e.peer&&"closed"!==e.peer.signalingState?e.peer.getStats(function(e){var t,n,i,o,r,a,s,d=e.result();for(a=d.length,t=0;a>t;++t)if(i=d[t],!i.local||i.local===i){if(r={},r.timestamp=i.timestamp,i.id&&(r.id=i.id),i.type&&(r.type=i.type),i.names)for(o=i.names(),s=o.length,n=0;s>n;++n)r[o[n]]=i.stat(o[n]);else i.stat("audioOutputLevel")&&(r.audioOutputLevel=i.stat("audioOutputLevel"));c.trace("Peer connection stats, report["+t+"]: ",r)}}):s.clearWebrtcLogCollectionInterval(e)},s.setupWebrtcLogCollectionTimer=function(e){if(O.webrtcLogCollectionInterval){s.clearWebrtcLogCollectionInterval(e);var t=1e3*O.webrtcLogCollectionInterval;c.debug("Setting webrtc log collection interval: "+t),e.webrtcLogCollectionInterval=setInterval(function(){s.webrtcLogCollectionTimeoutHandler(e)},t)}},s.oniceconnectionstatechange=function(e){c.debug("ICE connection state change : "+e.peer.iceConnectionState)},s.createPeer=function(e,t,n){try{var i,o,r,a,d=[],l=s.getIceServerUrl();if(l instanceof Array)for(r=0;r<l.length;r++)d[r]=l[r];else null===l||""===l?d=[]:d[0]=l;a={iceServers:d},o={optional:[{DtlsSrtpKeyAgreement:s.isDtlsEnabled()}]},i=s.getRtcLibrary().createRTCPeerConnection(a,o),s.setPeerCount(s.getPeerCount()+1),e.peer=i,i.onconnecting=function(t){s.onSessionConnecting(e,t)},i.onopen=function(t){s.onSessionOpened(e,t)},i.onsignalingstatechange=function(t){s.onSignalingStateChange(e,t)},i.onaddstream=function(t){s.onRemoteStreamAdded(e,t)},i.onremovestream=function(t){s.onRemoteStreamRemoved(e,t)},i.onicecandidate=function(t){"complete"===t.currentTarget.iceGatheringState?(c.debug("ice gathering complete"),s.onIceComplete(e)):(s.setupIceCandidateCollectionTimer(e),s.onIceCandidate(e,t))},i.onicecomplete=function(){s.onIceComplete(e)},i.oniceconnectionstatechange=function(t){s.oniceconnectionstatechange(e,t)},c.info("create PeerConnection successfully."),s.setupWebrtcLogCollectionTimer(e),t(e)}catch(u){c.error("Failed to create PeerConnection, exception: "+u.message),n()}},s.createNewPeerForCall=function(e){var t=e.call,n=e.mustCreatePeer,i=r.getSessionIdFromSdp(e.oldSdp),o=r.getSessionIdFromSdp(e.newSdp),a=!1,d=s.getPeerCount(),l=r.hasCodecPayloadChanged(e.oldSdp,e.newSdp);return(n||l||i!==o)&&(t.peer&&(t.peer.close(),s.setPeerCount(d-1),t.dtmfSender=null),c.trace("Creating new peer for call: "+t.id),s.createPeer(t,function(){c.trace("New peer has created for call: "+t.id),t.peer.addStream(t.localMedia.stream),a=!0},function(){c.error("New peer creation has failed!: "+t.id)})),a},s.getRemoteVideoResolutions=function(){var e,t,n=[];if(s.getRemoteVideoContainer()){if(!s.getRemoteVideoContainer().firstChild)return n;e=s.getRemoteVideoContainer().firstChild.videoHeight,t=s.getRemoteVideoContainer().firstChild.videoWidth}else{if(!s.getDefaultVideoContainer().firstElementChild.firstChild)return n;e=s.getDefaultVideoContainer().firstElementChild.firstChild.videoHeight,t=s.getDefaultVideoContainer().firstElementChild.firstChild.videoWidth}return c.debug("remote video resolutions of plugin webrtc..."),c.debug("remoteVideoWidth  : "+t),c.debug("remoteVideoHeight : "+e),n.push(e),n.push(t),s.getLocalVideoResolutions(),n},s.getLocalVideoResolutions=function(){var e,t,n=[];if(s.getLocalVideoContainer()){if(!s.getLocalVideoContainer().firstChild)return n;e=s.getLocalVideoContainer().firstChild.videoHeight,t=s.getLocalVideoContainer().firstChild.videoWidth}else{if(!s.getDefaultVideoContainer().lastElementChild.firstChild)return n;e=s.getDefaultVideoContainer().lastElementChild.firstChild.videoHeight,t=s.getDefaultVideoContainer().lastElementChild.firstChild.videoWidth}return c.debug("local video resolutions of plugin webrtc..."),c.debug("localVideoWidth  : "+t),c.debug("localVideoHeight : "+e),n.push(e),n.push(t),n},s.refreshVideoRenderer=function(){},s.sendIntraFrame=function(){},s.sendBlackFrame=function(){},s.disposeStreamRenderer=function(e){e&&(e.innerHTML="")},s.sendInbandDTMF=function(e,t,n){var i,o,r,a,s,d;c.info("sending inband DTMF tone: "+t),"1"===t&&(r="697",a="1209"),"2"===t&&(r="697",a="1336"),"3"===t&&(r="697",a="1477"),"4"===t&&(r="770",a="1209"),"5"===t&&(r="770",a="1336"),"6"===t&&(r="770",a="1477"),"7"===t&&(r="852",a="1209"),"8"===t&&(r="852",a="1336"),"9"===t&&(r="852",a="1477"),"*"===t&&(r="941",a="1209"),"0"===t&&(r="941",a="1336"),"#"===t&&(r="941",a="1477"),d=e.localMedia.mediaStreamDestination,i=n.createOscillator(),i.type="sine",i.frequency.value=r,s=n.createGain?n.createGain():n.createGainNode(),i.connect(s,0,0),s.connect(d),s.gain.value=.1,i.start(),o=n.createOscillator(),o.type="sine",o.frequency.value=a,s=n.createGain?n.createGain():n.createGainNode(),o.connect(s),s.connect(d),s.gain.value=.1,o.start(),setTimeout(function(){i.disconnect(),o.disconnect()},100)},s.sendDTMF=function(e,t){var n,i;if(r.isSdpHasTelephoneEvent(e.peer.remoteDescription.sdp)){if(c.info("sending outband DTMF tone: "+t),!e.dtmfSender){if(i=s.getLocalAudioTrack(e.peer),!i)return;if(e.dtmfSender=e.peer.createDTMFSender(i),!e.dtmfSender)return}e.dtmfSender.canInsertDTMF===!0?e.dtmfSender.insertDTMF(t,400):c.error("Failed to execute 'insertDTMF' on 'RTCDTMFSender': The 'canInsertDTMF' attribute is false: this sender cannot send DTMF");
}else n=e.localMedia.audioContext,s.sendInbandDTMF(e,t,n)},s.showSettingsWindow=function(){s.getRtcLibrary().showSettingsWindow()},s.set_logSeverityLevel=function(e){s.getRtcLibrary().set_logSeverityLevel(e)},s.enable_logCallback=function(){var e=i.getLogger("rtcPlugin");s.getRtcLibrary().enable_logCallback(e)},s.disable_logCallback=function(){s.getRtcLibrary().disable_logCallback()},s.get_audioInDeviceCount=function(){return s.getRtcLibrary().get_audioInDeviceCount()},s.get_audioOutDeviceCount=function(){return s.getRtcLibrary().get_audioOutDeviceCount()},s.get_videoDeviceCount=function(){return s.getRtcLibrary().get_videoDeviceCount()},s.setOriginatorSendLocalVideo=function(e,t){var n=r.isVideoSdpEnabled(e.peer.localDescription.sdp);e.canOrigSendVideo=t&&n},s.canOriginatorSendLocalVideo=function(e){return e.canOrigSendVideo},s.setOriginatorReceiveRemoteVideo=function(e){e.canOrigReceiveVideo=r.isVideoSdpEnabled(e.sdp)},s.canOriginatorReceiveRemoteVideo=function(e){return e.canOrigReceiveVideo},s.setTcpSetupAttiributesOnProcessAnswer=function(e,t){e.remoteTcpSetupAttribute=r.getTcpSetupAttribute(t),e.remoteTcpSetupAttribute===v.SDP.SETUP_ACTIVE?e.localTcpSetupAttribute=v.SDP.SETUP_PASSIVE:e.remoteTcpSetupAttribute===v.SDP.SETUP_PASSIVE?e.localTcpSetupAttribute=v.SDP.SETUP_ACTIVE:c.debug("Not handling remote TCP setup attribute: "+e.remoteTcpSetupAttribute)},s.setTcpSetupAttiributesOnCreateAnswer=function(e,t){e.localTcpSetupAttribute=r.getTcpSetupAttribute(t),e.localTcpSetupAttribute===v.SDP.SETUP_ACTIVE?e.remoteTcpSetupAttribute=v.SDP.SETUP_PASSIVE:e.localTcpSetupAttribute===v.SDP.SETUP_PASSIVE?e.remoteTcpSetupAttribute=v.SDP.SETUP_ACTIVE:c.debug("Not handling remote TCP setup attribute: "+e.remoteTcpSetupAttribute)},s.privateGetUserMedia=function(e){s.getRtcLibrary().checkMediaSourceAvailability(function(){var t,n,i={audio:e.options.audioConstraints,video:e.options.videoConstraints};s.getRtcLibrary().getUserMedia(i,function(i){n={stream:i,privateStream:e.options.privateStream},s.getPrivateStreamMap().add(i.id,n),t={id:i.id,stream:i,streamURL:s.getRtcLibrary().getURLFromStream(i)},o.callFunctionIfExist(e.onSuccess,t)},function(){o.callFunctionIfExist(e.onFailure,a.NOT_ALLOWED)})})},s.getCameraList=function(e){var t,n=[],i=[];s.getRtcLibrary().checkMediaSourceAvailability(function(r){for(i=r.sourceList,t=0;t<i.length;t++)"video"!==i[t].kind&&"videoinput"!==i[t].kind||n.push(i[t]);o.callFunctionIfExist(e,n)})},s.getMicrophoneList=function(e){var t,n=[],i=[];s.getRtcLibrary().checkMediaSourceAvailability(function(r){for(i=r.sourceList,t=0;t<i.length;t++)"audio"!==i[t].kind&&"audioinput"!==i[t].kind||n.push(i[t]);o.callFunctionIfExist(e,n)})},s.getSpeakerList=function(e){var t,n=[],i=[];s.getRtcLibrary().checkMediaSourceAvailability(function(r){for(i=r.sourceList,t=0;t<i.length;t++)"audiooutput"===i[t].kind&&n.push(i[t]);o.callFunctionIfExist(e,n)})},s.removeStreamById=function(e){var t=s.getStreamById(e);t&&(s.getRtcLibrary().stopStream(t.stream),s.removeStreamFromMap(e))},c.debug("WebRtcAdaptor initialized")},le=function(e,t,n){return new de(e,t,n,B,q,Z,R.call.MediaErrors)};g&&(g.WebRtcAdaptor=le);var ue=function(e,t,n,i,o,r,a){var s=this,c=i.getLogger("WebRtcPluginAdaptorImpl");c.debug("WebRtcPluginAdaptor initializing"),o.compose(e,s),o.compose(n,s),s.setPluginEnabled(!0),s.performSdpWorkaroundsAfterCreateOffer=function(e,t){return t=r.replaceCodecs(t,e.codecsToReplace?e.codecsToReplace:O.codecsToReplace)},s.addLocalStream=function(e){var t,n=!1,i=s.canOriginatorSendLocalVideo(e);e.localMedia.stream&&(i?(t=s.getRtcLibrary().getURLFromStream(e.localMedia.stream),t&&(s.getDefaultVideoContainer()?n=s.useDefaultRenderer(t,!0):s.getLocalVideoContainer()?n=s.createStreamRenderer(t,s.getLocalVideoContainer(),{muted:!0}):(e.call.localStreamURL=t,n=!0))):s.getDefaultVideoContainer()?s.getDefaultVideoContainer().lastElementChild&&s.disposeStreamRenderer(s.getDefaultVideoContainer().lastElementChild):s.getLocalVideoContainer()&&s.disposeStreamRenderer(s.getLocalVideoContainer()),c.debug("onLocalStreamAdded: "+t),n&&s.fireOnLocalStreamAddedEvent(e,t))},s.performSdpWorkaroundsBeforeProcessingIncomingSdp=function(e){e.sdp=r.deleteBandwidthLineFromSdp(e.sdp),e.sdp=r.removeRTXCodec(e.sdp),e.sdp=r.removeG722Codec(e.sdp)},s.initMedia=function(e,n,i){var r,d,l,u=document.body,f={},p=!0,E=a,S="1px",T="fcsPlugin",g="application/x-gcfwenabler",m=s.getPluginVersion();if(c.debug("Configured plugin version: "+m.major+"."+m.minor+"."+m.current_revision),i&&(i.pluginLogLevel&&s.setLogLevel(i.pluginLogLevel),i.language&&s.setLanguage(i.language)),s.onFCSPLoaded=function(){s.setRtcLibrary(t(f)),s.isH264Enabled()&&s.getRtcLibrary().enableH264(),s.getRtcLibrary().checkMediaSourceAvailability(function(e){s.setMediaSources(e)}),s.getRtcLibrary().setH264CodecStateChangeHandler(function(e){s.setH264Enabled(e.state)}),d=s.getRtcLibrary().getCurrentPluginVersionObject(),l=s.getRtcLibrary().getVersion(),!s.isInitialized()&&p&&(p=!1,c.debug("Plugin callback"),R.setPluginVersion(l),c.debug("Installed plugin version: "+l),l.length<1||d.major!==m.major||d.minor!==m.minor||d.revision<m.min_revision||d.revision===m.min_revision&&d.build<m.min_build?(c.debug("Plugin version not supported"),o.callFunctionIfExist(n,E.WRONG_VERSION)):(s.setInitialized(!0),d.revision<m.current_revision||d.revision===m.current_revision&&d.build<m.current_build?(c.debug("New plugin version warning"),o.callFunctionIfExist(n,E.NEW_VERSION_WARNING)):o.callFunctionIfExist(e,{pluginVersion:f.version}),s.getRtcLibrary().setLang(s.getLanguage())),s.getRtcLibrary().checkMediaSourceAvailability())},"undefined"==typeof u.appendChild)return c.debug("Could not inject plugin in container"),void o.callFunctionIfExist(n,E.OPTIONS);f=document.createElement("object"),r=document.createElement("param"),r.setAttribute("name","onload"),r.setAttribute("value","onFCSPLoaded"),f.appendChild(r),f.id=T,f.width=f.height=S;try{"Microsoft Internet Explorer"===navigator.appName?(u.appendChild(f),f.type=g):(f.type=g,u.appendChild(f))}catch(C){p=!1,o.callFunctionIfExist(n,E.NOT_FOUND)}p&&("undefined"!=typeof document.getElementById(T).createPeerConnection?s.onFCSPLoaded():setTimeout(function(){s.isInitialized()||("undefined"==typeof document.getElementById(T).createPeerConnection?o.callFunctionIfExist(n,E.NOT_FOUND):s.onFCSPLoaded())},7e3))},s.getUserMedia=function(e){s.getRtcLibrary().checkMediaSourceAvailability(function(t){var n,i,r={audio:!1,video:!1};return s.setMediaSources(t),t&&!t.audioSourceAvailable?(c.debug("Failed to get access to local media."),void o.callFunctionIfExist(e.onFailure,a.NOT_FOUND)):(s.getMediaVideo()&&s.getVideoSourceAvailable()&&(r.video=e.options.videoConstraints),s.getMediaAudio()&&s.getAudioSourceAvailable()&&(r.audio=e.options.audioConstraints),c.debug("Plugin version:"+s.getRtcLibrary().version),c.debug("getUserMedia - constraints: ",r),void s.getRtcLibrary().getUserMedia(r,function(t){i={audioContext:{close:function(){}},mediaStreamDestination:{disconnect:function(){}},stream:t,originalStream:t},s.setLocalMedia(i),s.getLocalStreamMap().add(i.stream.label,i),s.setInitialized(!0),n={audio:s.getMediaAudio(),video:s.getMediaVideo(),id:i.stream.label,originalStream:t,streamURL:s.getRtcLibrary().getURLFromStream(t)},c.debug("user has granted access to local media: ",i),o.callFunctionIfExist(e.onSuccess,n)},function(t){c.debug("Failed to get access to local media. Error code was "+t.code),o.callFunctionIfExist(e.onFailure,a.NOT_ALLOWED)}))})},s.createOffer=function(e,t,n,i){c.debug("createOffer: sendInitialVideo= "+i+" state= "+e.peer.signalingState);var a,d=e.peer;e.peer.addStream(e.localMedia.stream),s.addCallIdInPluginContainer(e),d.createOffer(function(t){i=i&&s.getVideoSourceAvailable(),a=r.getSdpFromObject(t),t=null,a=i?r.updateVideoSdpDirection(a,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):r.updateVideoSdpDirection(a,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),a=r.deleteCryptoZeroFromSdp(a),a=r.updateAudioCodec(a),a=r.removeG722Codec(a),a=r.deleteCryptoFromSdp(a,s.isDtlsEnabled()),a=r.setTcpSetupAttributeToActpass(a,s.isDtlsEnabled()),a=s.performSdpWorkaroundsAfterCreateOffer(e,a),s.muteOnHold(e,!1),d.setLocalDescription(s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,a),function(){},function(e){c.error("createOffer: setLocalDescription failed : "+e),o.callFunctionIfExist(n,"createOffer: setLocalDescription failed")})},function(e){c.error("createOffer: createOffer failed!! "+e),o.callFunctionIfExist(n)},{mandatory:{OfferToReceiveAudio:s.getMediaAudio(),OfferToReceiveVideo:s.getMediaVideo()}})},s.createAnswer=function(e,t,n,i){c.debug("createAnswer: isVideoEnabled= "+i+" state= "+e.peer.signalingState);var a,d=e.peer;e.sdp=r.checkSupportedVideoCodecs(e.sdp,null,s.isH264Enabled()),e.sdp=r.changeDirection(e.sdp,v.WEBRTC.MEDIA_STATE.INACTIVE,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE,v.STRING.AUDIO),e.sdp=r.deleteFingerprintOrCrypto(e.sdp,s.isDtlsEnabled()),r.isSdpVideoSendEnabled(e.sdp)||(e.sdp=r.deleteInactiveVideoSsrc(e.sdp)),s.addCallIdInPluginContainer(e),d.setRemoteDescription(s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),function(){e.peer.addStream(e.localMedia.stream),e.remoteVideoState=r.getVideoSdpDirection(e.sdp),d.createAnswer(d.remoteDescription,function(t){a=r.getSdpFromObject(t),t=null,i=i&&s.getVideoSourceAvailable()&&r.isSdpHasVideo(e.sdp),a=i?r.isSdpVideoSendEnabled(e.sdp)?r.updateVideoSdpDirection(a,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):r.getVideoSdpDirection(e.sdp)!==v.WEBRTC.MEDIA_STATE.INACTIVE?r.updateVideoSdpDirection(a,v.WEBRTC.MEDIA_STATE.SEND_ONLY):r.updateVideoSdpDirection(a,v.WEBRTC.MEDIA_STATE.INACTIVE):r.isSdpVideoSendEnabled(e.sdp)?r.updateVideoSdpDirection(a,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY):r.updateVideoSdpDirection(a,v.WEBRTC.MEDIA_STATE.INACTIVE),c.debug("doAnswer(plugin) - isSdpEnabled audio : "+r.isAudioSdpEnabled(a)),c.debug("doAnswer(plugin) - isSdpEnabled video : "+r.isVideoSdpEnabled(a)),r.isSdpHasAudio(a)||r.isSdpHasVideo(a)?(a=r.checkAndRestoreICEParams(a,e.sdp),s.muteOnHold(e,!1),d.setLocalDescription(s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.ANSWER,a),function(){e.videoOfferSent=r.isSdpHasVideo(a),s.setTcpSetupAttiributesOnCreateAnswer(e,a)},function(e){c.error("createAnswer: setLocalDescription failed : "+e),o.callFunctionIfExist(n,"createAnswer setLocalDescription failed")})):(c.error("createrAnswer: createAnswer failed!!"),o.callFunctionIfExist(n,"No codec negotiation"))},function(e){c.error("createAnswer: failed!!"+e),o.callFunctionIfExist(n,"Session cannot be created ")},{mandatory:{OfferToReceiveAudio:s.getMediaAudio(),OfferToReceiveVideo:s.getMediaVideo()}})},function(e){c.error("createAnswer setRemoteDescription failed : "+e)})},s.createUpdate=function(e,t,n,i){c.debug("createEnablerUpdate: isVideoStart= "+i+" state= "+e.peer.signalingState);var a,d,l,u,f=e.peer;u=O.iceLiteVideoWorkaround&&r.isIceLite(e.sdp)&&i||r.isRemoteEndFirefox(e.sdp),a=r.getSdpFromObject(e.peer.localDescription),a=r.deleteCryptoFromSdp(a,s.isDtlsEnabled()),c.debug("create new offer to start the video"),l={call:e,mustCreatePeer:u},s.createNewPeerForCall(l)&&(c.debug("remote end is firefox"),f=e.peer),f.removeStream(f.localStreams[0]),f.addStream(e.localMedia.stream),s.setMediaVideo(!0),f.createOffer(function(t){i=i&&s.getVideoSourceAvailable(),i?t.sdp=r.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):r.isVideoSdpDirectionInactive(e.stableRemoteSdp)?t.sdp=r.updateVideoSdpDirectionToInactive(t.sdp):t.sdp=r.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),d=t.sdp,t=null,d=r.updateVersion(a,d),d=r.updateH264Level(d),d=r.deleteCryptoZeroFromSdp(d),d=r.updateAudioCodec(d),d=r.removeG722Codec(d),d=r.deleteCryptoFromSdp(d,s.isDtlsEnabled()),d=r.setTcpSetupAttributeToActpass(d,s.isDtlsEnabled()),d=s.performSdpWorkaroundsAfterCreateOffer(e,d),f.setLocalDescription(s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,d),function(){c.debug("createUpdate setLocalDescription success. iceConnectionState: "+f.iceConnectionState+" iceGatheringState: "+f.iceGatheringState),"complete"===f.iceGatheringState&&e.successCallback&&(c.debug("createUpdate iceGatheringState completed "+f.localDescription.sdp),e.successCallback(f.localDescription.sdp))},function(e){c.debug("createUpdate: createOffer setLocalDescription failed: "+e),o.callFunctionIfExist(n)})},function(e){c.debug("createUpdate: createOffer failed!!: "+e),n()},{mandatory:{OfferToReceiveAudio:s.getMediaAudio(),OfferToReceiveVideo:s.getMediaVideo()}})},s.createHoldUpdate=function(e,t,n,i,a){c.debug("createHoldUpdate: local hold= "+t+" remote hold= "+n+" state= "+e.peer.signalingState);var d,l,u,f,p,E=e.peer;f=E.localDescription.sdp,d=r.getAudioSdpDirection(f),l=r.getVideoSdpDirection(f),p={call:e,mustCreatePeer:r.isRemoteEndFirefox(e.sdp)},s.createNewPeerForCall(p)&&(c.debug("remote end is firefox"),E=e.peer),E.createOffer(function(i){i.sdp=r.updateVersion(f,i.sdp),i.sdp=r.setTcpSetupAttributeToActpass(i.sdp,s.isDtlsEnabled()),i.sdp=s.performSdpWorkaroundsAfterCreateOffer(e,i.sdp),t||n?(d===v.WEBRTC.MEDIA_STATE.SEND_RECEIVE?i.sdp=r.updateAudioSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_ONLY):!t&&n?i.sdp=r.updateAudioSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):i.sdp=r.updateAudioSdpDirectionToInactive(i.sdp),l===v.WEBRTC.MEDIA_STATE.SEND_RECEIVE?i.sdp=r.updateVideoSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_ONLY):!t&&n?i.sdp=r.updateVideoSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):i.sdp=r.updateVideoSdpDirectionToInactive(i.sdp)):(i.sdp=r.updateAudioSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE),s.canOriginatorSendLocalVideo(e)?i.sdp=r.updateVideoSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):i.sdp=r.updateVideoSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)),u=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,i.sdp),E.setLocalDescription(u,function(){c.debug("createHoldUpdate setLocalDescription success. iceConnectionState: "+E.iceConnectionState+" iceGatheringState: "+E.iceGatheringState),"complete"===E.iceGatheringState&&e.successCallback&&(c.debug("createHoldUpdate iceGatheringState completed "+E.localDescription.sdp),e.successCallback(E.localDescription.sdp))},function(e){c.error("createHoldUpdate: setLocalDescription failed: "+e.message),o.callFunctionIfExist(a)})},function(e){c.error("createHoldUpdate: createOffer failed: "+e.message),o.callFunctionIfExist(a)},{mandatory:{OfferToReceiveAudio:s.getMediaAudio(),OfferToReceiveVideo:s.getMediaVideo()}})},s.processUpdate=function(e,t,n,i){c.debug("processUpdate: state= "+e.peer.signalingState);var a,d,l,u,f,p,E,S,T,g,m=e.peer;if(e.sdp=r.addSdpMissingCryptoLine(e.sdp),e.sdp=r.checkAndRestoreICEParams(e.sdp,e.peer.localDescription.sdp),E=r.getVideoSdpDirection(e.sdp),s.setMediaVideo(r.isSdpHasVideo(e.sdp)),E===v.WEBRTC.MEDIA_STATE.INACTIVE&&"COMPLETED"===e.currentState)switch(e.remoteVideoState){case v.WEBRTC.MEDIA_STATE.INACTIVE:case v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY:e.sdp=r.updateVideoSdpDirection(e.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE);break;case v.WEBRTC.MEDIA_STATE.SEND_RECEIVE:e.sdp=r.updateVideoSdpDirection(e.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)}e.sdp=r.changeDirection(e.sdp,v.WEBRTC.MEDIA_STATE.SEND_ONLY,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE,v.STRING.VIDEO),e.sdp=r.checkSupportedVideoCodecs(e.sdp,null,s.isH264Enabled()),d=r.getAudioSdpDirection(e.sdp),l=r.getVideoSdpDirection(e.sdp),r.getVideoSdpDirection(e.sdp)!==v.WEBRTC.MEDIA_STATE.INACTIVE&&r.getVideoSdpDirection(e.sdp)!==v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY||(e.sdp=r.deleteInactiveVideoSsrc(e.sdp)),e.sdp=r.setTcpSetupAttributeToActpass(e.sdp,s.isDtlsEnabled()),u=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,e.prevRemoteSdp),p=m.localDescription.sdp,g={call:e,oldSdp:e.prevRemoteSdp,newSdp:e.sdp},s.createNewPeerForCall(g)&&(m=e.peer),T=function(){f=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),m.setRemoteDescription(f,function(){c.debug("processUpdate: setRemoteDescription success"),e.remoteVideoState=r.getVideoSdpDirection(e.sdp),m.createAnswer(m.remoteDescription,function(t){c.debug("processUpdate: isSdpEnabled audio= "+r.isAudioSdpEnabled(t.sdp)),c.debug("processUpdate: isSdpEnabled video= "+r.isVideoSdpEnabled(t.sdp)),r.isAudioSdpEnabled(t.sdp)||r.isVideoSdpEnabled(t.sdp)?(r.isSdpVideoSendEnabled(e.sdp)?s.canOriginatorSendLocalVideo(e)?t.sdp=r.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):t.sdp=r.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY):s.canOriginatorSendLocalVideo(e)&&!r.isVideoSdpDirectionInactive(e.sdp)?t.sdp=r.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.SEND_ONLY):t.sdp=r.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.INACTIVE),a=r.getSdpFromObject(t),t=null,a=r.updateVersion(p,a),a=r.checkIceParamsLengths(a,e.sdp),a=r.setTcpSetupAttributeTo(a,e.localTcpSetupAttribute,s.isDtlsEnabled()),m.setLocalDescription(s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.ANSWER,a),function(){c.debug("processUpdate setLocalDescription success. iceConnectionState: "+m.iceConnectionState+" iceGatheringState: "+m.iceGatheringState),"complete"===m.iceGatheringState&&e.successCallback&&(c.debug("processUpdate iceGatheringState completed "+m.localDescription.sdp),e.successCallback(m.localDescription.sdp))},function(e){c.debug("processUpdate: setLocalDescription failed: "+e),o.callFunctionIfExist(n,"processUpdate: setlocalDescription failed!!")})):(c.debug("processUpdate: createAnswer failed!!"),o.callFunctionIfExist(n,"No codec negotiation"))},function(e){c.debug("processUpdate: createAnswer failed!! "+e),o.callFunctionIfExist(n,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:s.getMediaAudio(),OfferToReceiveVideo:s.getMediaVideo()}})},function(e){c.debug("processUpdate: setRemoteDescription failed: "+e),o.callFunctionIfExist(n,"processUpdate: setRemoteDescription failed!!")})},r.isSdpHasVideo(e.prevRemoteSdp)||r.isIceLite(e.sdp)||i?(e.sdp=r.updateAudioSdpDirectionToInactive(e.sdp),e.sdp=r.updateVideoSdpDirectionToInactive(e.sdp),S=r.deleteSsrcFromSdp(e.sdp),f=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,S),m.setRemoteDescription(f,function(){c.debug("processUpdate: workaround setRemoteDescription success"),e.sdp=r.updateAudioSdpDirection(e.sdp,d),e.sdp=r.updateVideoSdpDirection(e.sdp,l),T()},function(e){c.debug("processUpdate: workaround setRemoteDescription failed!!"+e),o.callFunctionIfExist(n,"processUpdate: workaround setRemoteDescription failed!!")})):T()},s.processAnswer=function(e,t,n){c.debug("processAnswer: state= "+e.peer.signalingState);var i,a,d,l,u,f=e.peer;return i=function(){e.remoteVideoState=r.getVideoSdpDirection(e.sdp),e.videoOfferSent=r.isSdpHasVideo(e.sdp),o.callFunctionIfExist(t)},a=function(e,t,n){e.peer.setRemoteDescription(s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),function(){c.debug("processAnswer: setRemoteDescription success"),t()},function(e){c.error("processAnswer: setRemoteDescription failed: "+e),n()})},s.setTcpSetupAttiributesOnProcessAnswer(e,e.sdp),e.sdp=r.checkSupportedVideoCodecs(e.sdp,r.getSdpFromObject(e.peer.localDescription),s.isH264Enabled()),e.sdp=r.performVideoPortZeroWorkaround(e.sdp),f.signalingState===v.WEBRTC.RTC_SIGNALING_STATE.HAVE_REMOTE_PRANSWER?r.isIceLite(e.prevRemoteSdp)!==r.isIceLite(e.sdp)?(c.debug("ice - ice-lite change."),void n(v.WEBRTC.ERROR.ICE_ICELITE)):(u=e.sdp,e.sdp=r.updateVideoSdpDirection(e.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),e.sdp=r.updateAudioSdpDirection(e.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),c.debug("call processPrAnswer again to trigger on remote stream added with updated sdp."),void s.processPreAnswer(e,function(){e.sdp=u,c.debug("processPrAnswer sucess callback. Restore original sdp."),a(e,i,n)},function(){e.sdp=u,c.debug("processPrAnswer failure callback. Restore original sdp."),a(e,i,n)})):(d=r.getVideoSdpDirection(e.sdp),l=r.getVideoSdpDirection(r.getSdpFromObject(e.peer.localDescription)),c.debug("processAnswer: ice-lite: do remote video escalation"),e.sdp=r.changeDirection(e.sdp,v.WEBRTC.MEDIA_STATE.SEND_ONLY,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE),void(l!==v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY&&l!==v.WEBRTC.MEDIA_STATE.SEND_RECEIVE||d!==v.WEBRTC.MEDIA_STATE.INACTIVE&&d!==v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY?l!==v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY||d!==v.WEBRTC.MEDIA_STATE.SEND_ONLY&&d!==v.WEBRTC.MEDIA_STATE.SEND_RECEIVE?a(e,i,n):a(e,function(){s.performVideoStartWorkaround(e,i,n)},n):(e.sdp=r.deleteInactiveVideoSsrc(e.sdp),a(e,i,n))))},s.performVideoStartWorkaround=function(e,t,n){var i,a,d,l,u=e.peer;c.debug("Workaround to play video"),l=e.peer.localDescription.sdp,e.sdp=r.addSdpMissingCryptoLine(e.sdp),i=r.getSdpDirectionLogging(e.sdp,v.STRING.AUDIO,!1),a=r.getSdpDirectionLogging(e.sdp,v.STRING.VIDEO,!1),e.sdp=r.updateSdpDirection(e.sdp,v.STRING.AUDIO,v.WEBRTC.MEDIA_STATE.INACTIVE),e.sdp=r.updateSdpDirection(e.sdp,v.STRING.VIDEO,v.WEBRTC.MEDIA_STATE.INACTIVE),e.sdp=r.setTcpSetupAttributeToActpass(e.sdp,s.isDtlsEnabled()),d=r.deleteSsrcFromSdp(e.sdp),u.setRemoteDescription(s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,d),function(){c.debug("performVideoStartWorkaround: first setRemoteDescription success"),e.sdp=r.updateSdpDirection(e.sdp,v.STRING.AUDIO,i),e.sdp=r.updateSdpDirection(e.sdp,v.STRING.VIDEO,a),u.setRemoteDescription(s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),function(){c.debug("performVideoStartWorkaround: second setRemoteDescription success"),u.createAnswer(u.remoteDescription,function(i){var a=r.getSdpFromObject(i);r.getSdpDirectionLogging(e.sdp,v.STRING.AUDIO,!1)===v.WEBRTC.MEDIA_STATE.INACTIVE&&(a=r.updateSdpDirection(a,v.STRING.AUDIO,v.WEBRTC.MEDIA_STATE.INACTIVE)),a=e.remoteVideoState===v.WEBRTC.MEDIA_STATE.INACTIVE?r.updateSdpDirection(a,v.STRING.VIDEO,v.WEBRTC.MEDIA_STATE.INACTIVE):s.canOriginatorSendLocalVideo(e)?r.updateSdpDirection(a,v.STRING.VIDEO,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):r.updateSdpDirection(a,v.STRING.VIDEO,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),a=r.checkAndRestoreICEParams(a,e.sdp),a=r.setTcpSetupAttributeTo(a,e.localTcpSetupAttribute,s.isDtlsEnabled()),a=r.updateVersion(l,a),u.setLocalDescription(s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.ANSWER,a),function(){c.debug("performVideoStartWorkaround: setlocalDescription success"),o.callFunctionIfExist(t)},function(e){c.debug("performVideoStartWorkaround: setlocalDescription failed!!"+e),o.callFunctionIfExist(n,"performVideoStartWorkaround: setlocalDescription failed!!")})},function(e){c.debug("performVideoStartWorkaround: createAnswer failed!! "+e),o.callFunctionIfExist(n,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:s.getMediaAudio(),OfferToReceiveVideo:s.getMediaVideo()}})},function(e){c.debug("performVideoStartWorkaround: second setRemoteDescription failed!!"+e),o.callFunctionIfExist(n,"performVideoStartWorkaround: second setRemoteDescription failed!!")})},function(e){c.debug("performVideoStartWorkaround: first setRemoteDescription failed!!"+e),o.callFunctionIfExist(n,"performVideoStartWorkaround: first setRemoteDescription failed!!")})},s.processPreAnswer=function(e,t,n){var i;c.debug("processPreAnswer: state= "+e.peer.signalingState),e.sdp=r.checkSupportedVideoCodecs(e.sdp,r.getSdpFromObject(e.peer.localDescription),s.isH264Enabled()),i=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.PRANSWER,e.sdp),e.peer.setRemoteDescription(i,function(){s.setOriginatorReceiveRemoteVideo(e),e.remoteVideoState=r.getVideoSdpDirection(e.sdp),t(),c.debug("processPreAnswer: setRemoteDescription success")},function(e){c.error("processPreAnswer: setRemoteDescription failed: "+e),n(e)})},s.processRespond=function(e,t,n,i){var a;if(c.debug("processRespond: state= "+e.peer.signalingState),e.sdp=r.checkSupportedVideoCodecs(e.sdp,r.getSdpFromObject(e.peer.localDescription),s.isH264Enabled()),a=r.getVideoSdpDirection(e.sdp),a===v.WEBRTC.MEDIA_STATE.INACTIVE&&"COMPLETED"===e.currentState)switch(e.remoteVideoState){case v.WEBRTC.MEDIA_STATE.INACTIVE:case v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY:e.sdp=r.updateSdpDirection(e.sdp,v.STRING.VIDEO,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)}return e.remoteVideoState=r.getVideoSdpDirection(e.sdp),e.sdp=r.changeDirection(e.sdp,v.WEBRTC.MEDIA_STATE.SEND_ONLY,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE,v.STRING.VIDEO),i&&(e.sdp=r.changeDirection(e.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE,v.STRING.AUDIO),s.muteOnHold(e,!1)),e.peer.signalingState===v.WEBRTC.RTC_SIGNALING_STATE.STABLE?void o.callFunctionIfExist(t):(r.getVideoSdpDirection(e.sdp)!==v.WEBRTC.MEDIA_STATE.INACTIVE&&r.getVideoSdpDirection(e.sdp)!==v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY||(e.sdp=r.deleteInactiveVideoSsrc(e.sdp)),void e.peer.setRemoteDescription(s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),function(){c.debug("processRespond: setRemoteDescription success");var i=function(){e.remoteVideoState=r.getVideoSdpDirection(e.sdp),e.videoOfferSent=!0,o.callFunctionIfExist(t)};s.performVideoStartWorkaround(e,i,n)},function(e){c.debug("processRespond: setRemoteDescription failed: "+e),o.callFunctionIfExist(n)}))},s.createReOffer=function(e,t,n,i){var a,d,l,u,f,p=e.peer,E=e.peer.localDescription.sdp;c.debug("createReOffer:"+e.id),f={call:e,mustCreatePeer:!0},s.createNewPeerForCall(f)&&(p=e.peer),p.createOffer(function(t){a=r.getSdpFromObject(t),t=null,i?(d=r.getAudioSdpDirection(E),a=r.updateAudioSdpDirection(a,d),l=r.getVideoSdpDirection(E),a=r.updateVideoSdpDirection(a,l)):(l=r.getVideoSdpDirection(E),u=r.getVideoSdpDirection(a),l===v.WEBRTC.MEDIA_STATE.INACTIVE&&u===v.WEBRTC.MEDIA_STATE.SEND_RECEIVE&&(a=r.updateVideoSdpDirection(a,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY))),a=r.deleteCryptoZeroFromSdp(a),a=r.updateAudioCodec(a),a=r.removeG722Codec(a),a=r.deleteCryptoFromSdp(a,s.isDtlsEnabled()),a=r.setTcpSetupAttributeToActpass(a,s.isDtlsEnabled()),a=s.performSdpWorkaroundsAfterCreateOffer(e,a),p.setLocalDescription(s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,a),function(){c.debug("createReOffer: setLocalDescription success"+e.id)},function(t){c.debug("createReOffer: setLocalDescription failed!!"+t+e.id),o.callFunctionIfExist(n)})},function(e){c.error("createReOffer: createOffer failed!! "+e),o.callFunctionIfExist(n)},{mandatory:{OfferToReceiveAudio:s.getMediaAudio(),OfferToReceiveVideo:s.getMediaVideo()}})},s.processHold=function(e,t,n,i,a){c.debug("processHold: local hold= "+n+" remote hold= "+t+" state= "+e.peer.signalingState);var d,l,u,f,p,E,S,T,g=e.peer;n||t||s.muteOnHold(e,!1),e.sdp=r.checkSupportedVideoCodecs(e.sdp,null,s.isH264Enabled()),e.sdp=r.performVideoPortZeroWorkaround(e.sdp),e.sdp=r.checkAndRestoreICEParams(e.sdp,r.getSdpFromObject(e.peer.localDescription)),l=r.getAudioSdpDirection(e.sdp),u=r.getVideoSdpDirection(e.sdp),f=e.prevRemoteSdp,E=g.localDescription.sdp,d=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),p=s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,d.sdp),p.sdp=r.updateAudioSdpDirectionToInactive(p.sdp),p.sdp=r.updateVideoSdpDirectionToInactive(p.sdp),T={call:e,oldSdp:e.prevRemoteSdp,newSdp:e.sdp},s.createNewPeerForCall(T)&&(g=e.peer),p.sdp=r.deleteSsrcFromSdp(p.sdp),g.setRemoteDescription(p,function(){d.sdp=r.updateAudioSdpDirection(d.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE),r.getVideoSdpDirection(d.sdp)!==v.WEBRTC.MEDIA_STATE.INACTIVE&&r.getVideoSdpDirection(d.sdp)!==v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY||(d.sdp=r.deleteInactiveVideoSsrc(d.sdp)),g.setRemoteDescription(d,function(){t||n||u!==v.WEBRTC.MEDIA_STATE.INACTIVE?e.remoteVideoState=r.getVideoSdpDirection(d.sdp):e.remoteVideoState=v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,g.createAnswer(g.remoteDescription,function(i){S=r.getSdpFromObject(i),c.debug("processHold: isSdpEnabled audio= "+r.isAudioSdpEnabled(i.sdp)),c.debug("processHold: isSdpEnabled video= "+r.isVideoSdpEnabled(i.sdp)),i=null,t?(c.debug("processHold: Remote HOLD"),S=r.respondToRemoteSdpDirections(S,e.sdp)):n?n&&!t&&(c.debug("processHold: Remote UNHOLD on local hold"),S=l===v.WEBRTC.MEDIA_STATE.INACTIVE?r.updateAudioSdpDirectionToInactive(S):r.updateAudioSdpDirection(S,v.WEBRTC.MEDIA_STATE.SEND_ONLY),S=s.canOriginatorSendLocalVideo(e)?r.updateVideoSdpDirection(S,v.WEBRTC.MEDIA_STATE.SEND_ONLY):r.updateVideoSdpDirectionToInactive(S)):(c.debug("processHold: Remote UNHOLD: direction left as it is"),S=r.isSdpVideoSendEnabled(e.sdp)?s.canOriginatorSendLocalVideo(e)?r.updateVideoSdpDirection(S,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):r.updateVideoSdpDirection(S,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY):s.canOriginatorSendLocalVideo(e)&&!r.isVideoSdpDirectionInactive(e.sdp)?r.updateVideoSdpDirection(S,v.WEBRTC.MEDIA_STATE.SEND_ONLY):r.updateVideoSdpDirection(S,v.WEBRTC.MEDIA_STATE.INACTIVE),S=r.changeDirection(S,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE,v.STRING.AUDIO)),S=r.updateVersion(E,S),S=r.checkIceParamsLengths(S,d.sdp),S=r.setTcpSetupAttributeTo(S,e.localTcpSetupAttribute,s.isDtlsEnabled()),S=r.updateH264Level(S),g.setLocalDescription(s.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.ANSWER,S),function(){c.debug("processHold: setLocalDescription success!! iceConnectionState: "+g.iceConnectionState+" iceGatheringState: "+g.iceGatheringState),"complete"===g.iceGatheringState&&e.successCallback&&(c.debug("processHold iceGatheringState completed "+g.localDescription.sdp),e.successCallback(g.localDescription.sdp))},function(e){c.error("processHold: setLocalDescription failed!! "+e),o.callFunctionIfExist(a,"Session cannot be created")})},function(e){c.error("processHold: createAnswer failed!!: "+e),o.callFunctionIfExist(a,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:s.getMediaAudio(),OfferToReceiveVideo:s.getMediaVideo()}})},function(e){c.error("processHold: second setRemoteDescription failed!! "+e),o.callFunctionIfExist(a,"Session cannot be created")})},function(e){c.debug("processHold: first setRemoteDescription failed!! "+e),o.callFunctionIfExist(a,"Session cannot be created")})},s.processHoldRespond=function(e,t,n,i){var o,a,d=!1,l=!1;c.debug("processHoldRespond: state= "+e.peer.signalingState+" call.currentState= "+e.currentState),e.sdp=r.checkSupportedVideoCodecs(e.sdp,r.getSdpFromObject(e.peer.localDescription),s.isH264Enabled()),r.init(e.sdp),l=r.isRemoteHold(),d="LOCAL_HOLD"===e.currentState,d||s.addCallIdInPluginContainer(e),o=r.getAudioSdpDirection(e.sdp),a=r.getVideoSdpDirection(e.sdp),c.debug("processHoldRespond: localHold= "+d+" remoteHold= "+l),l===!1?o===v.WEBRTC.MEDIA_STATE.SEND_RECEIVE&&"REMOTE_HOLD"===e.currentState&&(e.previousState=e.currentState,e.currentState="COMPLETED"):"COMPLETED"===e.currentState&&(e.previousState=e.currentState,e.currentState="REMOTE_HOLD"),(d||l)&&(c.debug("processHoldRespond: "+e.currentState+" : video -> inactive"),e.sdp=r.updateSdpDirection(e.sdp,v.STRING.VIDEO,v.WEBRTC.MEDIA_STATE.INACTIVE)),a===v.WEBRTC.MEDIA_STATE.INACTIVE&&"COMPLETED"===e.currentState&&(c.debug("processHoldRespond: video inactive -> recvonly"),e.sdp=r.updateSdpDirection(e.sdp,v.STRING.VIDEO,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)),d&&o===v.WEBRTC.MEDIA_STATE.SEND_RECEIVE&&(c.debug("processHoldRespond: Mute Remote Audio"),e.sdp=r.updateAudioSdpDirection(e.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)),d&&a===v.WEBRTC.MEDIA_STATE.SEND_RECEIVE&&(c.debug("processHoldRespond: Mute Remote Video"),e.sdp=r.updateVideoSdpDirection(e.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)),s.processRespond(e,t,n,i)},s.createPeer=function(e,t,n){try{var i,r,a,d,l=[],u=s.getIceServerUrl();if(u instanceof Array)for(a=0;a<u.length;a++)l[a]=u[a];else null===u||""===u?l=[]:l[0]=u;d={iceServers:l},r={optional:{DtlsSrtpKeyAgreement:s.isDtlsEnabled()}},i=s.getRtcLibrary().createRTCPeerConnection(d,r),
s.setPeerCount(s.getPeerCount()+1),e.peer=i,i.onconnecting=function(t){s.onSessionConnecting(e,t)},i.onopen=function(t){s.onSessionOpened(e,t)},i.onsignalingstatechange=function(t){s.onSignalingStateChange(e,t)},i.onaddstream=function(t){s.onRemoteStreamAdded(e,t)},i.onremovestream=function(t){s.onRemoteStreamRemoved(e,t)},i.onicecandidate=function(t){s.setupIceCandidateCollectionTimer(e),s.onIceCandidate(e,t)},i.onicecomplete=function(){s.onIceComplete(e)},i.oniceconnectionstatechange=function(t){s.oniceconnectionstatechange(e,t)},c.info("create PeerConnection successfully."),s.setupWebrtcLogCollectionTimer(e),o.callFunctionIfExist(t)}catch(f){c.error("Failed to create PeerConnection, exception: "+f.message),o.callFunctionIfExist(n)}},s.createNewPeerForCall=function(e){var t=e.call,n=e.mustCreatePeer,i=r.getSessionIdFromSdp(e.oldSdp),o=r.getSessionIdFromSdp(e.newSdp),a=!1,d=s.getPeerCount(),l=r.hasCodecPayloadChanged(e.oldSdp,e.newSdp);return(n||l||i!==o)&&(t.peer&&(t.peer.close(),s.setPeerCount(d-1),t.dtmfSender=null),c.trace("Creating new peer for call: "+t.id),s.createPeer(t,function(){c.trace("New peer has created for call: "+t.id),t.peer.addStream(t.localMedia.stream),a=!0},function(){c.error("New peer creation has failed!: "+t.id)})),a},s.onRemoteStreamAdded=function(e,t){var n,i,o=[],r=!1;if(s.getDefaultVideoContainer()){if(!s.isActiveCallInVideoContainer(s.getDefaultVideoContainer(),e))return void c.debug("onRemoteStreamAdded: It is not active call. Call Id: "+e.id)}else if(s.getRemoteVideoContainer()&&!s.isActiveCallInVideoContainer(s.getRemoteVideoContainer(),e))return void c.debug("onRemoteStreamAdded: It is not active call. Call Id: "+e.id);t.stream&&(n=s.getRtcLibrary().getURLFromStream(t.stream),n&&(o=t.stream.getVideoTracks(),o&&o.length>0&&(r=!0),i=s.getDefaultVideoContainer()?s.useDefaultRenderer(n,!1,r):s.getRemoteVideoContainer()?s.createStreamRenderer(n,s.getRemoteVideoContainer()):!0),c.debug("onRemoteStreamAdded: "+n),i&&s.fireOnStreamAddedEvent(e,n))},s.iceCandidateCollectionTimeoutHandler=function(e){var t=e.peer.localDescription.sdp;return s.clearIceCandidateCollectionTimer(e),O.relayCandidateCollectionTimeoutCycle&&e.relayCandidateCycle++,r.hasCandidates(t,e.relayCandidateCycle,O.relayCandidateCollectionTimeoutCycle)?void(e.successCallback&&(c.debug("Ice candidate collection interrupted after given timeout, invoking successCallback."),t=r.updateH264Level(t),e.successCallback(t))):(c.debug("Re-setting ice candidate collection timeout: "+O.iceCandidateCollectionTimeoutInterval),void(e.iceCandidateCollectionTimer=setTimeout(function(){s.iceCandidateCollectionTimeoutHandler(e)},O.iceCandidateCollectionTimeoutInterval)))},s.setupIceCandidateCollectionTimer=function(e){O.iceCandidateCollectionTimeoutInterval&&(e.iceCandidateCollectionTimer?c.trace("Ice candidate collection timer exists."):(c.debug("Setting ice candidate collection timeout: "+O.iceCandidateCollectionTimeoutInterval),O.relayCandidateCollectionTimeoutCycle&&(e.relayCandidateCycle=1),e.iceCandidateCollectionTimer=setTimeout(function(){s.iceCandidateCollectionTimeoutHandler(e)},O.iceCandidateCollectionTimeoutInterval)))},s.onIceCandidate=function(e,t){var n;null===t.candidate?(c.debug("Null candidate received."),e.successCallback&&(n=r.getSdpFromObject(e.peer.localDescription),r.hasCandidates(n,e.relayCandidateCycle,O.relayCandidateCollectionTimeoutCycle)?(s.clearIceCandidateCollectionTimer(e),c.debug("Candidates received, invoking successCallback."),n=r.updateH264Level(n),e.successCallback(n)):c.trace("Sdp does not have candidates."))):c.debug("ICE candidate received : sdpMLineIndex = "+t.candidate.sdpMLineIndex+", candidate = "+t.candidate.candidate+" for call : "+e.id)},s.onIceComplete=function(e){var t;c.debug("All ICE candidates received for call : "+e.id),s.clearIceCandidateCollectionTimer(e),e.successCallback&&(t=e.peer.localDescription.sdp,t=r.updateH264Level(t),c.debug("onIceComplete sdp : "+t),e.successCallback(t))},s.useDefaultRenderer=function(e,t,n){var i;return s.getDefaultVideoContainer()&&0===s.getDefaultVideoContainer().children.length&&(s.getDefaultVideoContainer().innerHTML="<div style='height:100%;width:100%'></div><div style='position:absolute;bottom:10px;right:10px;height:30%; width:30%;'></div>"),t?i=s.getDefaultVideoContainer().lastElementChild:(i=s.getDefaultVideoContainer().firstElementChild,n?i.style.width="100%":i.style.width="0%"),s.createStreamRenderer(e,i,{muted:t})},s.createStreamRenderer=function(e,t){return e&&t?(t.innerHTML="<object width='100%' height='100%' type='application/x-gcfwenabler-video'><param name='autoplay' value='true' /><param name='videosrc' value='"+e+"' /></object>",!0):void 0},s.sendIntraFrame=function(e){e.peer&&s.canOriginatorSendLocalVideo(e)&&e.peer.sendIntraFrame()},s.sendBlackFrame=function(e){!e.peer},s.sendDTMF=function(e,t){var n;if(!e.dtmfSender){if(n=s.getLocalAudioTrack(e.peer),!n)return;if(e.dtmfSender=e.peer.createDTMFSender(n),!e.dtmfSender)return}e.dtmfSender.canInsertDTMF===!0?(e.dtmfSender.insertDTMF(t,400),c.info("sending outband DTMF tone: "+t)):c.error("Failed to execute 'insertDTMF' on 'RTCDTMFSender': The 'canInsertDTMF' attribute is false: this sender cannot send DTMF")},s.getCameraList=function(){},s.getMicrophoneList=function(){},s.getSpeakerList=function(){},c.debug("WebRtcPluginAdaptor initialized")},fe=function(e,t,n){var i=t||oe,o=n||new ne;return new ue(e||new le({},i,o),i,o,B,q,Z,R.call.MediaErrors)};g&&(g.WebRtcPluginAdaptor=fe);var pe=function(e,t,n,i){var o=this,r={major:2,minor:2,min_revision:477,min_build:0,current_revision:477,current_build:0},a=i.getLogger("WebRtcPluginv22AdaptorImpl");a.debug("WebRtcPluginv22Adaptor initializing"),q.compose(e,o),q.compose(n,o),o.setPluginVersion(r),a.debug("WebRtcPluginv22Adaptor initialized")},Ee=function(e,t,n){var i=t||oe,o=n||new ne;return new pe(e||new fe(void 0,i,o),i,o,B)};g&&(g.WebRtcPluginv22Adaptor=Ee);var Se=function(e,t,n,i){var o=this,r={major:3,minor:1,min_revision:500,min_build:0,current_revision:509,current_build:0},a=i.getLogger("WebRtcPluginv31AdaptorImpl");a.debug("WebRtcPluginv31Adaptor initializing"),q.compose(e,o),q.compose(n,o),o.setPluginVersion(r),o.sendDTMF=function(e,t){var n;if(!e.dtmfSender){if(n=o.getLocalAudioTrack(e.peer),!n)return;if(e.dtmfSender=e.peer.createDTMFSender(n),!e.dtmfSender)return}Z.isSdpHasTelephoneEvent(e.peer.remoteDescription.sdp)?e.dtmfSender.canInsertDTMF===!0?(e.dtmfSender.insertDTMF(t,400),a.info("sending outband DTMF tone: "+t)):a.error("Failed to execute 'insertDTMF' on 'RTCDTMFSender': The 'canInsertDTMF' attribute is false: this sender cannot send DTMF"):(e.dtmfSender.insertDTMF(t,400,100,!0),a.info("sending inband DTMF tone: "+t))},a.debug("WebRtcPluginv31Adaptor initialized")},Te=function(e,t,n){var i=t||oe,o=n||new ne;return new Se(e||new fe(void 0,i,o),i,o,B)};g&&(g.WebRtcPluginv31Adaptor=Te);var ge=function(e,t,n,i,o){var r=this,a=i.getLogger("WebRtcChromeAdaptorImpl");a.debug("WebRtcChromeAdaptor initializing"),o.compose(e,r),o.compose(n,r),a.debug("WebRtcChromeAdaptor initialized")},me=function(e,t,n){var i=t||ce,o=n||new ee;return new ge(e||new le({},i,o),i,o,B,q)};g&&(g.WebRtcChromeAdaptor=me);var Ce=function(e,t,n,i){var o=this,r=i.getLogger("WebRtcFirefoxAdaptorImpl");r.debug("WebRtcFirefoxAdaptor initializing"),q.compose(e,o),q.compose(n,o),o.performSdpWorkaroundsBeforeProcessingIncomingSdp=function(e){e.sdp=Z.updateH264LevelTo42E01F(e.sdp,o.isH264Enabled()),e.sdp=Z.deleteBandwidthLineFromSdp(e.sdp),e.sdp=Z.addRtpmapForPCMU(e.sdp),e.sdp=Z.addRtpmapForPCMA(e.sdp),e.sdp=Z.removeG722Codec(e.sdp),e.sdp=Z.setOpusCodecToLowerCase(e.sdp)},o.getUserMedia=function(e){o.getRtcLibrary().checkMediaSourceAvailability(function(t){var n,i,a,s={audio:!1,video:!1};return o.setMediaSources(t),t&&!t.audioSourceAvailable?(r.debug("Failed to get access to local media."),void q.callFunctionIfExist(e.onFailure,R.call.MediaErrors.NOT_FOUND)):(o.getMediaVideo()&&o.getVideoSourceAvailable()&&(s.video=e.options.videoConstraints),o.getMediaAudio()&&o.getAudioSourceAvailable()&&(s.audio=e.options.audioConstraints),r.debug("getUserMedia - constraints: ",s),void o.getRtcLibrary().getUserMedia(s,function(t){s.video?a={audioContext:{close:function(){}},mediaStreamDestination:{disconnect:function(){}},stream:t,originalStream:t}:(o.initAudioContext(),i=o.getAudioContext().createMediaStreamSource(t),o.initMediaStreamDestination(),i.connect(o.getMediaStreamDestination()),a={audioContext:o.getAudioContext(),mediaStreamDestination:o.getMediaStreamDestination(),stream:o.getMediaStreamDestination().stream,originalStream:t}),o.setLocalMedia(a),o.getLocalStreamMap().add(a.stream.id,a),o.setInitialized(!0),n={audio:o.getMediaAudio(),video:o.getMediaVideo(),id:a.stream.id,originalStream:t,streamURL:o.getRtcLibrary().getURLFromStream(t)},r.debug("user has granted access to local media: ",a),q.callFunctionIfExist(e.onSuccess,n)},function(t){r.debug("Failed to get access to local media. Error code was "+t.code),q.callFunctionIfExist(e.onFailure,R.call.MediaErrors.NOT_ALLOWED)}))})},o.createOffer=function(e,t,n,i){r.debug("createOffer: sendInitialVideo= "+i+" state= "+e.peer.signalingState);var a=e.peer;e.peer.addStream(e.localMedia.stream),o.addCallIdInPluginContainer(e),a.createOffer(function(t){i=i&&o.getVideoSourceAvailable(),i?t.sdp=Z.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):t.sdp=Z.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),t.sdp=Z.deleteCryptoZeroFromSdp(t.sdp),t.sdp=Z.updateAudioCodec(t.sdp),t.sdp=Z.removeG722Codec(t.sdp),t.sdp=Z.deleteCryptoFromSdp(t.sdp,o.isDtlsEnabled()),t.sdp=Z.setTcpSetupAttributeToActpass(t.sdp,o.isDtlsEnabled()),t=o.performSdpWorkaroundsAfterCreateOffer(e,t),a.setLocalDescription(o.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,t.sdp),function(){},function(e){r.error("createOffer: setLocalDescription failed : "+e),q.callFunctionIfExist(n,"createOffer: setLocalDescription failed")})},function(e){r.error("createOffer: createOffer failed!! "+e),q.callFunctionIfExist(n)},{offerToReceiveAudio:o.getMediaAudio(),offerToReceiveVideo:o.getMediaVideo()})},o.createReOffer=function(e,t,n,i){var a,s,c,d,l=e.peer,u=e.peer.localDescription.sdp;r.debug("createReOffer:"+e.id),o.createNewPeerForCall(e)&&(l=e.peer),l.createOffer(function(t){i?(s=Z.getAudioSdpDirection(u),t.sdp=Z.updateAudioSdpDirection(t.sdp,s),c=Z.getVideoSdpDirection(u),t.sdp=Z.updateVideoSdpDirection(t.sdp,c)):(c=Z.getVideoSdpDirection(u),d=Z.getVideoSdpDirection(t.sdp),c===v.WEBRTC.MEDIA_STATE.INACTIVE&&d===v.WEBRTC.MEDIA_STATE.SEND_RECEIVE&&(t.sdp=Z.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY))),t.sdp=Z.deleteCryptoZeroFromSdp(t.sdp),t.sdp=Z.updateAudioCodec(t.sdp),t.sdp=Z.removeG722Codec(t.sdp),t.sdp=Z.deleteCryptoFromSdp(t.sdp,o.isDtlsEnabled()),t.sdp=Z.setTcpSetupAttributeToActpass(t.sdp,o.isDtlsEnabled()),t.sdp=Z.updateVersion(u,t.sdp),t=o.performSdpWorkaroundsAfterCreateOffer(e,t),a=o.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,t.sdp),l.setLocalDescription(a,function(){r.debug("createReOffer: setLocalDescription success"+e.id)},function(t){r.debug("createReOffer: setLocalDescription failed!!"+t+e.id),q.callFunctionIfExist(n)})},function(e){r.error("createReOffer: createOffer failed!! "+e),q.callFunctionIfExist(n)},{offerToReceiveAudio:o.getMediaAudio(),offerToReceiveVideo:o.getMediaVideo()})},o.processAnswer=function(e,t,n){var i,a,s,c=e.peer;r.debug("processAnswer: state= "+c.signalingState),o.setTcpSetupAttiributesOnProcessAnswer(e,e.sdp),e.sdp=Z.checkSupportedVideoCodecs(e.sdp,c.localDescription.sdp,o.isH264Enabled()),e.sdp=Z.performVideoPortZeroWorkaround(e.sdp),i=Z.getVideoSdpDirection(e.sdp),a=Z.getVideoSdpDirection(e.peer.localDescription.sdp),s=o.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),c.setRemoteDescription(s,function(){r.debug("processAnswer: setRemoteDescription success"),e.remoteVideoState=Z.getVideoSdpDirection(e.sdp),e.videoOfferSent=Z.isSdpHasVideo(e.sdp),q.callFunctionIfExist(t)},function(e){r.error("processAnswer: setRemoteDescription failed: "+e.message),q.callFunctionIfExist(n)})},o.revertRtcState=function(e,t){setTimeout(function(){q.callFunctionIfExist(t,e)},0)},o.createHoldUpdate=function(e,t,n,i,a){r.debug("createHoldUpdate: local hold= "+t+" remote hold= "+n+" state= "+e.peer.signalingState);var s,c,d,l,u,f,p=e.peer;u=function(){l=e.stableLocalSdp,s=Z.getAudioSdpDirection(l),c=Z.getVideoSdpDirection(l),o.createNewPeerForCall(e)&&(p=e.peer),p.createOffer(function(i){i.sdp=Z.updateVersion(l,i.sdp),i.sdp=Z.setTcpSetupAttributeToActpass(i.sdp,o.isDtlsEnabled()),i=o.performSdpWorkaroundsAfterCreateOffer(e,i),t||n?(s===v.WEBRTC.MEDIA_STATE.SEND_RECEIVE?i.sdp=Z.updateAudioSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_ONLY):!t&&n?i.sdp=Z.updateAudioSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):i.sdp=Z.updateAudioSdpDirectionToInactive(i.sdp),c===v.WEBRTC.MEDIA_STATE.SEND_RECEIVE?i.sdp=Z.updateVideoSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_ONLY):!t&&n?i.sdp=Z.updateVideoSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):i.sdp=Z.updateVideoSdpDirectionToInactive(i.sdp)):(i.sdp=Z.updateAudioSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE),o.canOriginatorSendLocalVideo(e)?i.sdp=Z.updateVideoSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):i.sdp=Z.updateVideoSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)),d=o.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,i.sdp),p.setLocalDescription(d,function(){r.debug("createHoldUpdate: setLocalDescription success")},function(e){r.error("createHoldUpdate: setLocalDescription failed: "+e.message),q.callFunctionIfExist(a)})},function(e){r.error("createHoldUpdate: createOffer failed: "+e.message),q.callFunctionIfExist(a)},{offerToReceiveAudio:o.getMediaAudio(),offerToReceiveVideo:o.getMediaVideo()})},f=Z.isSdpHasVideo(e.sdp)&&!Z.isVideoSdpDirectionInactive(p.localDescription.sdp),!e.isVideoSourceAllowed&&f?(o.setMediaAudio(!0),o.setMediaVideo(!0),o.getUserMedia(function(t){o.storeLocalStreamToCall(e,t.id),e.isVideoSourceAllowed=t.video,u()},function(){q.callFunctionIfExist(a)})):(f&&(e.isVideoSourceAllowed=!0),u())},o.processHold=function(e,t,n,i,a){r.debug("processHold: local hold= "+n+" remote hold= "+t+" state= "+e.peer.signalingState);var s,c,d,l=e.peer;n||t||o.muteOnHold(e,!1),d=Z.getAudioSdpDirection(e.sdp),e.sdp=Z.checkSupportedVideoCodecs(e.sdp,null),e.sdp=Z.performVideoPortZeroWorkaround(e.sdp),e.sdp=Z.setTcpSetupAttributeToActpass(e.sdp,o.isDtlsEnabled()),c=e.prevRemoteSdp,s=o.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),o.createNewPeerForCall(e)&&(l=e.peer),l.setRemoteDescription(s,function(){l.createAnswer(function(i){r.debug("processHold: isSdpEnabled audio= "+Z.isAudioSdpEnabled(i.sdp)),r.debug("processHold: isSdpEnabled video= "+Z.isVideoSdpEnabled(i.sdp)),t?(r.debug("processHold: Remote HOLD"),i.sdp=Z.respondToRemoteSdpDirections(i.sdp,e.sdp)):n?n&&!t&&(r.debug("processHold: Remote UNHOLD on local hold"),d===v.WEBRTC.MEDIA_STATE.INACTIVE?i.sdp=Z.updateAudioSdpDirectionToInactive(i.sdp):i.sdp=Z.updateAudioSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_ONLY),o.canOriginatorSendLocalVideo(e)?i.sdp=Z.updateVideoSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_ONLY):i.sdp=Z.updateVideoSdpDirectionToInactive(i.sdp)):(r.debug("processHold: Remote UNHOLD: direction left as it is"),Z.isSdpVideoSendEnabled(e.sdp)?o.canOriginatorSendLocalVideo(e)?i.sdp=Z.updateVideoSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):i.sdp=Z.updateVideoSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY):o.canOriginatorSendLocalVideo(e)&&!Z.isVideoSdpDirectionInactive(e.sdp)?i.sdp=Z.updateVideoSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.SEND_ONLY):i.sdp=Z.updateVideoSdpDirection(i.sdp,v.WEBRTC.MEDIA_STATE.INACTIVE),i.sdp=Z.changeDirection(i.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE,v.STRING.AUDIO)),i.sdp=Z.setTcpSetupAttributeTo(i.sdp,e.localTcpSetupAttribute,o.isDtlsEnabled()),l.setLocalDescription(i,function(){r.debug("processHold: setLocalDescription succeeded")},function(e){r.error("processHold: setLocalDescription failed!! "+e),q.callFunctionIfExist(a,"Session cannot be created")})},function(){r.debug("FAIL")})},function(e){r.error("processHold: setRemoteDescription failed: "+e.message),q.callFunctionIfExist(a,"Session cannot be created")})},o.processHoldRespond=function(e,t,n,i){var a,s,c,d,l=!1,u=!1;return r.debug("processHoldRespond: state= "+e.peer.signalingState+" call.currentState= "+e.currentState),e.sdp=Z.checkSupportedVideoCodecs(e.sdp,e.peer.localDescription.sdp,o.isH264Enabled()),Z.init(e.sdp),u=Z.isRemoteHold(),l="LOCAL_HOLD"===e.currentState,l||o.addCallIdInPluginContainer(e),a=Z.getAudioSdpDirection(e.sdp),s=Z.getVideoSdpDirection(e.sdp),e.remoteVideoState=s,c=Z.getVideoSdpDirection(e.peer.localDescription.sdp),r.debug("processHoldRespond: localHold= "+l+" remoteHold= "+u),u===!1?a===v.WEBRTC.MEDIA_STATE.SEND_RECEIVE&&"REMOTE_HOLD"===e.currentState&&(r.debug("set current web state to COMPLETED"),e.previousState=e.currentState,e.currentState="COMPLETED"):"COMPLETED"===e.currentState&&(r.debug("set current web state to REMOTE_HOLD"),e.previousState=e.currentState,e.currentState="REMOTE_HOLD"),(l||u)&&(r.debug("processHoldRespond: "+e.currentState+" : video -> inactive"),e.sdp=Z.updateVideoSdpDirection(e.sdp,v.WEBRTC.MEDIA_STATE.INACTIVE)),i&&o.muteOnHold(e,!1),e.peer.signalingState===v.WEBRTC.RTC_SIGNALING_STATE.STABLE?void q.callFunctionIfExist(t):(Z.getVideoSdpDirection(e.sdp)!==v.WEBRTC.MEDIA_STATE.INACTIVE&&Z.getVideoSdpDirection(e.sdp)!==v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY||(e.sdp=Z.deleteInactiveVideoSsrc(e.sdp)),l&&a===v.WEBRTC.MEDIA_STATE.SEND_RECEIVE&&(r.debug("processHoldRespond: Mute Remote Audio"),e.sdp=Z.updateAudioSdpDirection(e.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)),l&&s===v.WEBRTC.MEDIA_STATE.SEND_RECEIVE&&(r.debug("processHoldRespond: Mute Remote Video"),e.sdp=Z.updateVideoSdpDirection(e.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)),d=o.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),void e.peer.setRemoteDescription(d,function(){r.debug("processHoldRespond: setRemoteDescription typeAns success"),q.callFunctionIfExist(t)},function(e){r.debug("processHoldRespond: setRemoteDescription typeAns failed: "+e),q.callFunctionIfExist(n)}))},o.createUpdate=function(e,t,n,i){r.debug("createUpdate: isVideoStart= "+i+" state= "+e.peer.signalingState);var a,s,c=e.peer;a=e.peer.localDescription.sdp,r.debug("create new offer to start the video"),o.createNewPeerForCall(e)&&(c=e.peer),o.setMediaVideo(!0),c.createOffer(function(t){i=i&&o.getVideoSourceAvailable(),i?t.sdp=Z.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):Z.isVideoSdpDirectionInactive(e.stableRemoteSdp)?t.sdp=Z.updateVideoSdpDirectionToInactive(t.sdp):t.sdp=Z.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),t.sdp=Z.updateVersion(a,t.sdp),t.sdp=Z.setTcpSetupAttributeToActpass(t.sdp,o.isDtlsEnabled()),t.sdp=Z.deleteCryptoZeroFromSdp(t.sdp),t.sdp=Z.updateAudioCodec(t.sdp),t.sdp=Z.removeG722Codec(t.sdp),t.sdp=Z.deleteCryptoFromSdp(t.sdp,o.isDtlsEnabled()),t=o.performSdpWorkaroundsAfterCreateOffer(e,t),s=o.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,t.sdp),c.setLocalDescription(s,function(){r.debug("createUpdate: createOffer setLocalDescription success ")},function(e){r.debug("createUpdate: createOffer setLocalDescription failed: "+e),q.callFunctionIfExist(n)})},function(e){r.debug("createUpdate: createOffer failed!!: "+e),n()},{offerToReceiveAudio:o.getMediaAudio(),offerToReceiveVideo:o.getMediaVideo()})},o.processUpdate=function(e,t,n){r.debug("processUpdate: state= "+e.peer.signalingState);var i,a,s,c,d,l=e.peer;e.sdp=Z.addSdpMissingCryptoLine(e.sdp),e.sdp=Z.checkAndRestoreICEParams(e.sdp,e.stableLocalSdp),i=Z.getVideoSdpDirection(e.sdp),a=Z.getVideoSdpDirection(e.stableLocalSdp),e.sdp=Z.checkSupportedVideoCodecs(e.sdp,null,o.isH264Enabled()),e.sdp=Z.setTcpSetupAttributeToActpass(e.sdp,o.isDtlsEnabled()),d=e.stableLocalSdp,o.createNewPeerForCall(e)&&(l=e.peer),s=o.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),l.setRemoteDescription(s,function(){r.debug("processUpdate: setRemoteDescription success"),e.remoteVideoState=Z.getVideoSdpDirection(e.sdp),l.createAnswer(function(t){r.debug("processUpdate: isSdpEnabled audio= "+Z.isAudioSdpEnabled(t.sdp)),r.debug("processUpdate: isSdpEnabled video= "+Z.isVideoSdpEnabled(t.sdp)),Z.isSdpVideoSendEnabled(e.sdp)?o.canOriginatorSendLocalVideo(e)?t.sdp=Z.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE):t.sdp=Z.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY):o.canOriginatorSendLocalVideo(e)&&!Z.isVideoSdpDirectionInactive(e.sdp)?t.sdp=Z.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.SEND_ONLY):t.sdp=Z.updateVideoSdpDirection(t.sdp,v.WEBRTC.MEDIA_STATE.INACTIVE),t.sdp=Z.updateVersion(d,t.sdp),t.sdp=Z.checkIceParamsLengths(t.sdp,s.sdp),t.sdp=Z.setTcpSetupAttributeTo(t.sdp,e.localTcpSetupAttribute,o.isDtlsEnabled()),c=o.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.ANSWER,t.sdp),l.setLocalDescription(c,function(){r.debug("processUpdate: setlocalDescription success")},function(e){r.debug("processUpdate: setlocalDescription failed!!"+e),q.callFunctionIfExist(n,"processUpdate: setlocalDescription failed!!")})},function(e){r.debug("processUpdate: createAnswer failed!! "+e),q.callFunctionIfExist(n,"Session cannot be created")},{offerToReceiveAudio:o.getMediaAudio(),offerToReceiveVideo:o.getMediaVideo()})},function(e){r.debug("processUpdate: setRemoteDescription failed!!"+e),q.callFunctionIfExist(n,"processUpdate: setRemoteDescription failed!!")})},o.processRespond=function(e,t,n,i){var a,s,c=e.peer;return r.debug("processRespond: state= "+e.peer.signalingState),e.sdp=Z.checkSupportedVideoCodecs(e.sdp,c.localDescription.sdp,o.isH264Enabled()),a=Z.getVideoSdpDirection(e.sdp),e.remoteVideoState=Z.getVideoSdpDirection(e.sdp),i&&(e.sdp=Z.changeDirection(e.sdp,v.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,v.WEBRTC.MEDIA_STATE.SEND_RECEIVE,v.STRING.AUDIO),o.muteOnHold(e,!1)),e.peer.signalingState===v.WEBRTC.RTC_SIGNALING_STATE.STABLE?void q.callFunctionIfExist(t):(s=o.getRtcLibrary().createRTCSessionDescription(v.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),void c.setRemoteDescription(s,function(){r.debug("processRespond: setRemoteDescription success"),e.remoteVideoState=Z.getVideoSdpDirection(e.sdp),e.videoOfferSent=!0,q.callFunctionIfExist(t)},function(e){r.debug("processRespond: setRemoteDescription failed: "+e),q.callFunctionIfExist(n)}))},o.sendDTMF=function(e,t){var n;n=e.localMedia.audioContext,n.createOscillator?o.sendInbandDTMF(e,t,n):r.debug("DMTF IS NOT SUPPORTED FOR VIDEO CALL ON FIREFOX")},o.iceCandidateCollectionTimeoutHandler=function(e){var t=e.peer.localDescription.sdp;return o.clearIceCandidateCollectionTimer(e),O.relayCandidateCollectionTimeoutCycle&&e.relayCandidateCycle++,t=Z.findZeroConnectionIPandModify(t),Z.hasCandidates(t,e.relayCandidateCycle,O.relayCandidateCollectionTimeoutCycle)?void(e.successCallback&&(r.debug("Ice candidate collection interrupted after given timeout, invoking successCallback."),t=Z.deleteCurlyBracketsSDP(t),o.isH264Enabled()||(t=Z.removeH264Codec(t)),Z.isSdpHasUfrag(t)||(t=Z.checkAndRestoreICEParams(t,e.stableLocalSdp),r.debug("Absent ufrag due to inactive video direction is restored from that in stable local sdp")),e.successCallback(t))):(r.debug("Re-setting ice candidate collection timeout: "+O.iceCandidateCollectionTimeoutInterval),void(e.iceCandidateCollectionTimer=setTimeout(function(){o.iceCandidateCollectionTimeoutHandler(e)},O.iceCandidateCollectionTimeoutInterval)))},o.setupIceCandidateCollectionTimer=function(e){O.iceCandidateCollectionTimeoutInterval&&(e.iceCandidateCollectionTimer?r.trace("Ice candidate collection timer exists."):(r.debug("Setting ice candidate collection timeout: "+O.iceCandidateCollectionTimeoutInterval),O.relayCandidateCollectionTimeoutCycle&&(e.relayCandidateCycle=1),e.iceCandidateCollectionTimer=setTimeout(function(){o.iceCandidateCollectionTimeoutHandler(e)},O.iceCandidateCollectionTimeoutInterval)))},o.onIceCandidate=function(e,t){var n;null===t.candidate?(r.debug("Null candidate received."),e.successCallback&&(n=e.peer.localDescription.sdp,o.clearIceCandidateCollectionTimer(e),r.debug("Candidates received, invoking successCallback."),n=Z.deleteCurlyBracketsSDP(n),o.isH264Enabled()||(n=Z.removeH264Codec(n)),Z.isSdpHasUfrag(n)||(n=Z.checkAndRestoreICEParams(n,e.stableLocalSdp),r.debug("Absent ufrag due to inactive video direction is restored from that in stable local sdp")),e.successCallback(n))):r.debug("ICE candidate received: sdpMLineIndex = "+t.candidate.sdpMLineIndex+", candidate = "+t.candidate.candidate+" for call : "+e.id)},o.onIceComplete=function(e){var t;r.debug("All ICE candidates received for call : "+e.id),o.clearIceCandidateCollectionTimer(e),e.successCallback&&(t=e.peer.localDescription.sdp,t=Z.deleteCurlyBracketsSDP(t),o.isH264Enabled()||(t=Z.removeH264Codec(t)),Z.isSdpHasUfrag(t)||(t=Z.checkAndRestoreICEParams(t,e.stableLocalSdp),r.debug("Absent ufrag due to inactive video direction is restored from that in stable local sdp")),r.debug("onIceComplete sdp : "+t),e.successCallback(t))},o.createNewPeerForCall=function(e){var t=!1,n=o.getPeerCount();return e.peer&&(e.peer.close(),o.setPeerCount(n-1),e.dtmfSender=null),r.trace("Creating new peer for call: "+e.id),o.createPeer(e,function(){r.trace("New peer has created for call: "+e.id),e.peer.addStream(e.localMedia.stream),t=!0},function(){r.error("New peer creation has failed!: "+e.id)}),t},o.createPeer=function(e,t,n){try{var i,a,s,c,d,l=[],u=o.getIceServerUrl();if(u instanceof Array)for(s=0;s<u.length;s++)d=u[s].url.substring(0,u[s].url.indexOf(":")),"turns"===d&&(u[s].url=u[s].url.replace("turns","turn")),l[s]=u[s];else null===u||""===u?l=[]:l[0]=u;c={iceServers:l},a={optional:[{DtlsSrtpKeyAgreement:o.isDtlsEnabled()}]},i=o.getRtcLibrary().createRTCPeerConnection(c,a),o.setPeerCount(o.getPeerCount()+1),e.peer=i,i.onconnecting=function(t){o.onSessionConnecting(e,t)},i.onopen=function(t){o.onSessionOpened(e,t)},i.onsignalingstatechange=function(t){o.onSignalingStateChange(e,t)},i.onaddstream=function(t){o.onRemoteStreamAdded(e,t)},i.onremovestream=function(t){o.onRemoteStreamRemoved(e,t)},i.onicecandidate=function(t){"complete"===t.currentTarget.iceGatheringState?(r.debug("ice gathering complete"),o.onIceComplete(e)):(o.setupIceCandidateCollectionTimer(e),o.onIceCandidate(e,t))},i.onicecomplete=function(){o.onIceComplete(e)},i.oniceconnectionstatechange=function(t){o.oniceconnectionstatechange(e,t)},r.info("create PeerConnection successfully."),t(e)}catch(f){r.error("Failed to create PeerConnection, exception: "+f.message),n()}},o.getCameraList=function(){},o.getMicrophoneList=function(){},o.getSpeakerList=function(){},r.debug("WebRtcFirefoxAdaptor initialized")},Ie=function(e,t,n){var i=t||ae,o=n||new te;return new Ce(e||new le({},i,o),i,o,B)};g&&(g.WebRtcFirefoxAdaptor=Ie);var ve=function(e,t,n,i){var o=this,r=i.getLogger("WebRtcFirefoxEsrAdaptorImpl");r.debug("WebRtcFirefoxEsrAdaptor initializing"),q.compose(e,o),q.compose(n,o),o.getUserMedia=function(e){o.getRtcLibrary().checkMediaSourceAvailability(function(t){var n,i,a={audio:!1,video:!1};return o.setMediaSources(t),t&&!t.audioSourceAvailable?(r.debug("Failed to get access to local media."),void q.callFunctionIfExist(e.onFailure,R.call.MediaErrors.NOT_FOUND)):(o.getMediaVideo()&&o.getVideoSourceAvailable()&&(a.video=e.options.videoConstraints),o.getMediaAudio()&&o.getAudioSourceAvailable()&&(a.audio=e.options.audioConstraints),r.debug("getUserMedia - constraints: ",a),void o.getRtcLibrary().getUserMedia(a,function(t){i={audioContext:{close:function(){}},mediaStreamDestination:{disconnect:function(){}},stream:t,originalStream:t},o.setLocalMedia(i),o.getLocalStreamMap().add(i.stream.id,i),o.setInitialized(!0),n={audio:o.getMediaAudio(),video:o.getMediaVideo(),id:i.stream.id,originalStream:t,streamURL:o.getRtcLibrary().getURLFromStream(t)},r.debug("user has granted access to local media: ",i),q.callFunctionIfExist(e.onSuccess,n)},function(t){r.debug("Failed to get access to local media. Error code was "+t.code),q.callFunctionIfExist(e.onFailure,R.call.MediaErrors.NOT_ALLOWED)}))})},o.sendDTMF=function(e,t){r.debug("DMTF IS ONLY SUPPORTED FOR  FIREFOX 40 AND NEWER VERSIONS")},r.debug("WebRtcFirefoxEsrAdaptor initialized")},Re=function(e,t,n){var i=t||ae,o=n||new te;return new ve(e||new Ie(null,i,o),i,o,B)},Ae=function(e,t,n,i,o,r,a,s){function c(){var e,n,i;return t.userAgent&&-1!==t.userAgent.indexOf("GENBANDOmni")?e=E.CHROME:t.webkitGetUserMedia?(e=E.CHROME,i=new RegExp(/\Chrome\/(\d*)/)):t.mozGetUserMedia?(e=E.FIREFOX,i=new RegExp(/\Firefox\/(\d*)/)):e=E.PLUGIN,i&&t.userAgent&&(n=parseInt(t.userAgent.match(i).pop(),10)),{type:e,version:n}}function d(e){var t;if(!e||!e.pluginMode)return S.AUTO;for(t in S)if(S[t]===e.pluginMode)return S[t];return S.AUTO}function l(e){var t,n,i,o,r,a=S.AUTO,s=!1,c=O.pluginMode[e.type];c?(r=new RegExp(/^\d+\+$/),c.version&&r.test(c.version)&&(n=parseInt(c.version.replace(/\+/,""),10)),i=e.version,c.mode&&(!n||i>=n)?a=c.mode:O.pluginMode.mode&&(a=O.pluginMode.mode),t="undefined"!=typeof c.h264&&(!n||i>=n)?c.h264:O.pluginMode.h264):(a=O.pluginMode.mode,t=O.pluginMode.h264);for(o in I)I[o]===a&&(s=!0);return s||(a=S.AUTO),t!==!0&&t!==!1&&(t=void 0),{pluginMode:a,h264Enabled:t}}function u(e,t){var n=d(e);return m[t.type][n]||n}var f,p=n.getLogger("WebRtcAdaptorFactory"),E={CHROME:"chrome",FIREFOX:"firefox",PLUGIN:"plugin"},S={WEBRTCH264:"webrtch264",WEBRTC22:"webrtc22",WEBRTC:"webrtc",AUTO:"auto",AUTO22:"auto22",AUTOH264:"autoh264",AUTOFIREFOX:"autofirefox"},T=S.WEBRTCH264,g=o,m={chrome:{webrtc:T,autofirefox:S.AUTO,autoh264:S.AUTO,webrtch264:S.WEBRTCH264},firefox:{webrtc:T,auto:T,auto22:S.WEBRTC22,autoh264:S.WEBRTCH264,autofirefox:S.AUTO},plugin:{auto:T,auto22:S.WEBRTC22,autoh264:S.WEBRTCH264,autofirefox:T,webrtc:T}},C={chrome:{auto:r,autoh264:r,webrtc22:i,webrtch264:o},firefox:{auto:a,autoesr:s,webrtc22:i,webrtch264:o},plugin:{webrtc22:i,webrtch264:o}},I={WEBRTC:"webrtc",AUTO:"auto"},v={chrome:{auto:r,webrtc:g},firefox:{auto:a,autoesr:s,webrtc:g},plugin:{auto:g,webrtc:g}};this.getWebRtcAdaptor=function(t){var n,i,o,r,a=c();return O.pluginMode?(o=l(a),f=o.pluginMode,r=o.h264Enabled,"auto"===f&&"firefox"===a.type&&a.version<40&&(f="autoesr"),n=v[a.type][f]):(f=u(t,a),"auto"===f&&"firefox"===a.type&&a.version<40&&(f="autoesr"),n=C[a.type][f]),n||(p.debug("Invalid Plugin Mode Detected, Treated as WEBRTC"),f=T,n=g),p.debug("Adaptor initializing from "+a+" browser and "+f+" plugIn mode"),e.pluginMode=f,i=new n,"undefined"!=typeof r&&i.setH264Enabled(r),i},this.getPluginModes=function(){return S},this.getDefaultRtcPluginMode=function(){return T},this.getDefaultRtcAdaptor=function(){return g}},_e=new Ae(window,navigator,B,Ee,Te,me,Ie,Re);g&&(g.WebRtcAdaptorFactory=Ae);var De=function(e,t,n,i,o,r,a){function s(e,t){e.successCallback=t}function c(e){e.successCallback=null}var d,l=this,u=t.getLogger("WebRtcManager");l.onCredentialsReceived=function(){d&&d.setIceServerUrl(l.addTurnCredentialsToUrl())},n.onCredentialsReceived=l.onCredentialsReceived,l.addTurnCredentialsToUrl=function(){var e,t,i=d.getIceServerUrl(),o=n.get();if(o&&(u.info("Turn credentials are avaliable."),i instanceof Array))for(e=0;e<i.length;e++)t=i[e].url.substring(0,i[e].url.indexOf(":")),"turn"!==t&&"turns"!==t||(i[e].credential=o.credential,i[e].username=o.username);return i},l.canOriginatorSendLocalVideo=function(e){return d.canOriginatorSendLocalVideo(e)},l.canOriginatorReceiveRemoteVideo=function(e){return d.canOriginatorReceiveRemoteVideo(e)},l.onFcsSetupCompleted=function(e){l.initMedia(null,null,e)},l.initMedia=function(t,n,i){
u.info("Initializing media for call"),d||(d=e.getWebRtcAdaptor(i)),i&&(i.iceserver&&(d.setIceServerUrl(i.iceserver),d.setIceServerUrl(l.addTurnCredentialsToUrl(i.iceserver))),i.webrtcdtls&&d.setDtlsEnabled(i.webrtcdtls),i.localVideoContainer&&d.setLocalVideoContainer(i.localVideoContainer),i.remoteVideoContainer&&d.setRemoteVideoContainer(i.remoteVideoContainer),i.videoContainer&&d.setDefaultVideoContainer(i.videoContainer)),d.isInitialized()?t():d.initMedia(t,n,i)},l.privateGetUserMedia=function(e,t,n){var i={onSuccess:e,onFailure:t,options:{audioConstraints:n.audio,videoConstraints:n.video,privateStream:n.privateStream}};return n.audio||n.video?void d.privateGetUserMedia(i):void o.callFunctionIfExist(t,r.call.MediaErrors.INVALID_PARAMETER)},l.getUserMedia=function(e,t,n){var a=!1,s=!1,c={onSuccess:e,onFailure:t};return n&&(d.setMediaAudio(n.audio),a=n.audio,d.setMediaVideo(n.video),s=n.video),a||s?(c.options={audioConstraints:a,videoConstraints:s},u.info("getting user media - userAgent: "+i.userAgent+" constraints: ",{audio:a,video:s}),void d.getUserMedia(c)):void o.callFunctionIfExist(t,r.call.MediaErrors.INVALID_PARAMETER)},l.startScreenMedia=function(e,t,n,o){u.info("getting screen media for call: started - userAgent: "+i.userAgent),n&&(n.width&&d.setScreenWidth(n.width),n.height&&d.setScreenHeight(n.height),n.frameRate&&d.setScreenFrameRate(n.frameRate)),d.startScreenMedia(e,t,o)},l.stopScreenMedia=function(){d.stopScreenMedia()},l.createOffer=function(e,t,n,i){u.info("create offer SDP: sendInitialVideo= "+i);var r=function(n){c(e),d.restoreMuteStateOfCall(e),d.setOriginatorSendLocalVideo(e,i),"function"==typeof t&&t(n)};s(e,r),e.peer||d.createPeer(e,function(){d.createOffer(e,r,function(t){c(e),"function"==typeof n&&n(t)},i)},function(){o.callFunctionIfExist(n,2)})},l.createAnswer=function(e,t,n,i){u.info("creating answer SDP: callid= "+e.id),u.info("creating answer SDP: isVideoEnabled= "+i);var r=function(n){c(e),d.setOriginatorSendLocalVideo(e,i),d.setOriginatorReceiveRemoteVideo(e),"function"==typeof t&&t(n)};s(e,r),e.peer||d.createPeer(e,function(){d.performSdpWorkaroundsBeforeProcessingIncomingSdp(e),d.createAnswer(e,r,function(t){c(e),"function"==typeof n&&n(t)},i)},function(){o.callFunctionIfExist(n,2)})},l.processAnswer=function(e,t,n){if(e.peer){var i=function(){c(e),d.restoreMuteStateOfCall(e),d.setOriginatorReceiveRemoteVideo(e),"function"==typeof t&&t()};s(e,i),d.performSdpWorkaroundsBeforeProcessingIncomingSdp(e),d.processAnswer(e,i,function(t){c(e),"function"==typeof n&&n(t)})}},l.processRespond=function(e,t,n,i){if(e.peer){var o=function(){c(e),d.setOriginatorReceiveRemoteVideo(e),"function"==typeof t&&t()};s(e,o),d.performSdpWorkaroundsBeforeProcessingIncomingSdp(e),d.processRespond(e,o,function(t){c(e),"function"==typeof n&&n(t)},i)}},l.createUpdate=function(e,t,n,i){if(u.info("createUpdate: isVideoStart= "+i),e.peer){var o=function(n){c(e),d.restoreMuteStateOfCall(e),d.setOriginatorSendLocalVideo(e,i),"function"==typeof t&&t(n)};s(e,o),d.storeStableRemoteAndLocalSdpInCall(e),d.createUpdate(e,o,n,i)}},l.processUpdate=function(e,t,n,i){if(u.info("processUpdate: local_hold_status:"+i),e.peer){var o=function(n){c(e),d.restoreMuteStateOfCall(e),d.setOriginatorReceiveRemoteVideo(e),"function"==typeof t&&t(n)};s(e,o),d.performSdpWorkaroundsBeforeProcessingIncomingSdp(e),d.storeStableRemoteAndLocalSdpInCall(e),d.processUpdate(e,o,function(t){c(e),"function"==typeof n&&n(t)},i)}},l.createReOffer=function(e,t,n,i){if(e.peer){var o=function(n){c(e),d.restoreMuteStateOfCall(e),"function"==typeof t&&t(n)};s(e,o),d.createReOffer(e,o,function(t){c(e),"function"==typeof n&&n(t)},i)}},l.createHoldUpdate=function(e,t,n,i,o){if(u.info("create hold update local hold= "+t+" remote hold= "+n),e.peer){var r=function(o){c(e),t||n?d.muteOnHold(e,!0):(d.setFcsUserMuteState(e,!1),d.restoreMuteStateOfCall(e)),"function"==typeof i&&i(o)};s(e,r),d.storeStableRemoteAndLocalSdpInCall(e),d.createHoldUpdate(e,t,n,r,function(t){c(e),"function"==typeof o&&o(t)})}},l.processRemoteOfferOnLocalHold=function(e,t,n){if(e.peer){var i=function(n){c(e),d.restoreMuteStateOfCall(e),"function"==typeof t&&t(n)};s(e,i),d.processRemoteOfferOnLocalHold(e,i,function(t){c(e),"function"==typeof n&&n(t)})}},l.processEnd=function(e){e.peer&&d.processEnd(e)},l.processHold=function(e,t,n,i,o){if(u.info("processHold: local hold= "+n+" remote hold= "+t),e.peer){var r=function(t){c(e),n||d.restoreMuteStateOfCall(e),d.setOriginatorReceiveRemoteVideo(e),"function"==typeof i&&i(t)};s(e,r),d.performSdpWorkaroundsBeforeProcessingIncomingSdp(e),d.storeStableRemoteAndLocalSdpInCall(e),d.processHold(e,t,n,r,function(t){c(e),"function"==typeof o&&o(t)})}},l.processHoldRespond=function(e,t,n,i){if(u.info("Processing response to hold offer sent"),e.peer){var o=function(){c(e),d.setOriginatorReceiveRemoteVideo(e),"function"==typeof t&&t()};s(e,o),d.performSdpWorkaroundsBeforeProcessingIncomingSdp(e),d.processHoldRespond(e,o,function(t){c(e),"function"==typeof n&&n(t)},i)}},l.processPreAnswer=function(e,t,n){u.info("processing preanswer from the offer we sent"),e.peer&&(d.performSdpWorkaroundsBeforeProcessingIncomingSdp(e),d.processPreAnswer(e,function(){"function"==typeof t&&t()},function(e){"function"==typeof n&&n(e)}))},l.isDtlsEnabled=function(){return d.isDtlsEnabled()},l.revertRtcState=function(e,t,n){var i=function(){c(e),"function"==typeof t&&t(e)};s(e,i),d.revertRtcState(e,i,n)},l.getRemoteVideoResolutions=function(){return d.getRemoteVideoResolutions()},l.getLocalVideoResolutions=function(){return d.getLocalVideoResolutions()},l.isAudioSourceAvailable=function(){return d.getAudioSourceAvailable()},l.isVideoSourceAvailable=function(){return d.getVideoSourceAvailable()},l.refreshVideoRenderer=function(){d.refreshVideoRenderer()},l.sendIntraFrame=function(e){d.sendIntraFrame(e)},l.sendBlackFrame=function(e){d.sendBlackFrame(e)},l.muteAudioTrack=function(e,t){return d.setFcsUserMuteState(e,t),d.muteAudioTrack(e,t)},l.isAudioMuted=function(e){return d.isAudioMuted(e)},l.addLocalStream=function(e){d.addLocalStream(e)},l.isPluginEnabled=function(){return d.isPluginEnabled()},l.sendDTMF=function(e,t){d.sendDTMF(e,t)},l.showSettingsWindow=function(){d.showSettingsWindow()},l.createStreamRenderer=function(e,t,n){return d.createStreamRenderer(e,t,n)},l.disposeStreamRenderer=function(e){d.disposeStreamRenderer(e)},l.set_logSeverityLevel=function(e){d.set_logSeverityLevel(e)},l.enable_logCallback=function(){d.enable_logCallback()},l.disable_logCallback=function(){d.disable_logCallback()},l.get_audioInDeviceCount=function(){return d.get_audioInDeviceCount()},l.get_audioOutDeviceCount=function(){return d.get_audioOutDeviceCount()},l.get_videoDeviceCount=function(){return d.get_videoDeviceCount()},l.storeLocalStreamToCall=function(e,t){d.storeLocalStreamToCall(e,t)},l.updateLocalStreamToCall=function(e,t){d.updateLocalStreamToCall(e,t)},l.getStreamById=function(e){return d.getStreamById(e)},l.removeStreamById=function(e){d.removeStreamById(e)},l.setSelectedMicrophoneId=function(e){d.setSelectedMicrophoneId(e)},l.setSelectedSpeakerId=function(e){d.setSelectedSpeakerId(e)},l.setSelectedCameraId=function(e){d.setSelectedCameraId(e)},l.getSelectedMicrophoneId=function(){return d.getSelectedMicrophoneId()},l.getSelectedSpeakerId=function(){return d.getSelectedSpeakerId()},l.getSelectedCameraId=function(){return d.getSelectedCameraId()},l.getCameraList=function(e){d.getCameraList(function(t){o.callFunctionIfExist(e,t)})},l.getMicrophoneList=function(e){d.getMicrophoneList(function(t){o.callFunctionIfExist(e,t)})},l.getSpeakerList=function(e){d.getSpeakerList(function(t){o.callFunctionIfExist(e,t)})},a.subscribe(v.EVENT.FCS_SETUP_COMPLETED,l.onFcsSetupCompleted)},Ne=new De(_e,B,z,navigator,q,R,I),he=function(e,t,n,i,o,r,a){function s(){return t.currentNotificationType===n.notification.NotificationTypes.WEBSOCKET&&i.WebSocket?{notificationType:"WebSocket",clientIp:t.clientIp}:{notificationType:"LongPolling",pollingTimer:t.polling}}function c(e){var t,n=[];for(t in f)f.hasOwnProperty(t)&&-1!==e.indexOf(t)&&n.push(f[t]);return n}function d(e,i){var o,r,a=s();r={expires:Math.floor(t.expires),service:c(n.notification.isAnonymous()?t.anonymousServices?t.anonymousServices:E:t.services?t.services:p),localization:"English_US"},i&&t.serverProvidedTurnCredentials&&(r.useTurn=t.serverProvidedTurnCredentials===!0),e===!0&&(r.forceLogOut="true");for(o in a)a.hasOwnProperty(o)&&(r[o]=a[o]);return r}var u="/subscription",f={CallControl:"call",call:"call",IM:"IM",Presence:"Presence",custom:"custom",callMe:"callMe",RCC:"RCC"},p=[f.IM,f.Presence,f.CallControl],E=[f.callMe],S=3600;this.extendSubscription=function(n,i,o){0===t.expires&&(t.expires=S),e.sendPutRequest({url:r()+n,data:{subscribeRequest:d()}},function(e){var t=e.subscribeResponse,n=t.subscriptionParams;i(n.notificationChannel,n.assignedService,n.service)},o)},this.subscribe=function(n,i,r,s){var c,f=l();t.expires=S,e.sendPostRequest({url:o(1,u+(f?"?tokenrealm="+f:"")),data:{subscribeRequest:d(r,!0)}},function(e){var t,i=e.subscribeResponse,o=i.subscriptionParams;o.turnActive===!0&&o.turnCredentials&&o.turnCredentials.username&&o.turnCredentials.password&&(t={username:o.turnCredentials.username,credential:o.turnCredentials.password},a.save(t)),n(i.subscription,o.notificationChannel,o.expires,o.pollingTimer,o.assignedService,o.service,o.sessionId)},i,c,c,c,c,s)},this.deleteSubscription=function(t,n,i){a.remove(),e.sendDeleteRequest({url:r()+t},n,i)}},be=new he(b,O,R,window,T,S,z),Oe=function(e,t){this.retrieveNotification=function(n){return e.sendGetRequest({url:t()+n.notificationUrl},function(e){var t,i=null;null!==e&&(t=e.notificationMessage,t&&(i=t.eventType)),n.notificationSuccess({type:i,data:t,notificationURL:n.notificationUrl})},function(e){n.notificationFailure({error:e,notificationChannelURL:n.notificationUrl})})}},Le=function(e,t){return new Oe(e||b,t||S)},ye=new Le;g&&(g.LongpollingService=Le);var Ve=function(e,t,n){var i="/rest/version/latest/isAlive";this.checkConnectivity=function(o,r){e.sendGetRequest({url:t()+i+"?"+n.getTimestamp()},o,r)}},Me=function(e,t,n){return new Ve(e||b,t||S,n||q)},Pe=new Me;g&&(g.ConnectivityService=Me);var Fe=function(e,t,n){var i=e.getLogger("longpollingManager"),o=!1,r=null,a=this;this.clearConnection=function(){r?(i.trace("aborting last long polling request."),r.abort(),r=null):i.info("lastLongpollingRequest is undefined, cannot clear connection")},this.connect=function(e){e.notificationURL?(a.clearConnection(),e.onSuccess(n.LONG_POLLING.STATUS.TRIGGERED_CONNECT),r=t.retrieveNotification({notificationUrl:e.notificationURL,notificationSuccess:e.onNotificationReceived,notificationFailure:e.onFailure})):i.error("notification URL is undefined, cannot fetch notification")},this.trigger=function(e){o?i.error("trigger could not fetch notification"):(a.connect({notificationURL:e.notificationUrl,onSuccess:function(){},onNotificationReceived:e.notificationSuccess,onFailure:e.notificationFailure}),o=!0)}},we=function(e,t,n){return new Fe(e||B,t||ye,n||v)},ke=new we;g&&(g.LongpollingManager=we);var Ue=function(e,t,n,i,o){function r(){return!(!u||u.readyState!==u.OPEN)}function a(){d.debug("check web socket is stopped."),clearInterval(c)}function s(){var e;a(),e=p.handleWebsocketTestIntervalValueValidation(parseInt(i.websocketInterval,10)),0!==e?(d.debug("check web socket is started."+e),c=setInterval(p.websocketConnectionCheck,e)):d.debug("check web socket is not started."+e)}var c,d=e.getLogger("websocketManager"),l=n.WEBSOCKET,u=null,f=1e4,p=this;this.websocketConnectionCheck=function(){if(r())try{u.send("test")}catch(e){d.trace("Exception occured while executing connecitivy handler: ",e)}},this.handleWebsocketTestIntervalValueValidation=function(e){return isNaN(e)||1e3>e&&0!==e||e>1e4?f:e},this.clearConnection=function(){u&&(u.onmessage=null,u.onopen=null,u.onclose=null,u.onerror=null,u.close&&u.close(),u=null),a()},this.connect=function(e){function r(t){d.trace("websocket connection created successfully: "+t.status),o.publish(n.EVENT.WEBSOCKET_CONNECTED),"function"==typeof e.onSuccess&&e.onSuccess(t.status)}function a(t){d.trace("websocket connection failed: "+t.status),p.clearConnection(),o.publish(n.EVENT.WEBSOCKET_DISCONNECTED),"function"==typeof e.onFailure&&e.onFailure(t.status)}var c=l.PROTOCOL.NONSECURE;p.clearConnection();try{i.websocketProtocol&&i.websocketProtocol===l.PROTOCOL.SECURE&&(c=l.PROTOCOL.SECURE),u=new t.WebSocket(c+"://"+(i.websocketIP?i.websocketIP:t.location.hostname)+":"+(i.websocketPort?i.websocketPort:l.DEFAULT_PORT)+e.notificationURL)}catch(f){return d.error("WebSocket create error: ",f),void a({status:l.STATUS.CREATE_ERROR})}null!==u?(u.onmessage=function(t){var n,i,o=JSON.parse(t.data);o&&(n=o.notificationMessage,n&&(i=n.eventType,e.onNotificationReceived({type:i,data:n,notificationURL:e.notificationURL})))},u.onopen=function(){d.info("WebSocket opened"),s(),r({status:l.STATUS.OPENED})},u.onclose=function(){d.info("WebSocket closed"),a({status:l.STATUS.CONNECTION_CLOSED})},u.onerror=function(){d.error("Error on Web Socket connection."),a({status:l.STATUS.CONNECTION_ERROR})}):a({status:l.STATUS.NOT_FOUND})}},We=function(e,t,n,i,o){return new Ue(e||B,t||window,n||v,i||O,o||I)},xe=new We;g&&(g.WebsocketManager=We);var Be=function(e,t,n,i,o,r,a){function s(e){S.info("check connectivity timer is stopped."),clearInterval(E),e&&e.resetConnectivity&&(g=!0,r(g))}function c(){g||(g=!0,r(g),S.trace("Connectivity re-established..."),i.publish(o.EVENT.CONNECTION_REESTABLISHED))}function d(){g&&(g=!1,r(g),S.trace("Connectivity is lost..."),i.publish(o.EVENT.CONNECTION_LOST))}function l(){e.checkConnectivity(c,d)}function u(e){var t=/^(?:0|[1-9][0-9]*)$/;return t.test(e)}function f(){S.info("connectivity check via Container"),l()}function p(){var e=u(a.connectivityInterval)?a.connectivityInterval:o.TIMEOUT.DEFAULT_CONNECTIVITY_CHECK_INTERVAL;s(),"0"!==e&&(E=setInterval(l,e)),n.registerNetworkInternetCallback&&n.registerNetworkInternetCallback(f)}var E,S=t.getLogger("connectivityManager"),T=1,g=!0;i.subscribe(o.EVENT.DEVICE_SUBSCRIPTION_STARTED,p,T),i.subscribe(o.EVENT.DEVICE_SUBSCRIPTION_ENDED,s,T),i.subscribe(o.EVENT.XHR_REQUEST_NOT_INITIALIZED,d,T),i.subscribe(o.EVENT.WEBSOCKET_DISCONNECTED,d,T),i.subscribe(o.EVENT.WEBSOCKET_CONNECTED,c,T)},He=function(e,t,n,i,o,r,a){return new Be(e||Pe,t||B,n||window,i||I,o||v,r||E,a||O)};new He;g&&(g.ConnectivityManager=He);var Ge={},Ye=function(e,t,n,i,o,r,a,s,c){function d(e){R.debug("Long polling failure..."),p(e),r.callFunctionIfExist(v,e.error)}function l(e,t){R.debug("Connect long polling to: ",e),i.connect({notificationURL:e,onSuccess:t,onFailure:d,onNotificationReceived:f})}function u(e,t,i){R.debug("Connect web socket to: ",e),n.connect({notificationURL:e,onSuccess:t,onFailure:i,onNotificationReceived:f})}var f,p,E,S,T,g,m,C,I,v,R=e.getLogger("notificationManager"),A=[],_=!1,D=this,N=5e3,h=5,b=100;this.NotificationTypes={LONGPOLLING:"longpolling",SNMP:"snmp",WEBSOCKET:"websocket",WEBSOCKET_ONLY:"websocketonly"},this.isWebSocketConnection=function(e){return e&&e.notificationURL?-1!==e.notificationURL.indexOf("/websocket/"):void 0},this.isLongPollingConnection=function(e){return e&&e.notificationURL?-1!==e.notificationURL.indexOf("/notification/"):void 0},this.handleWebsocketRetry=function(e){R.debug("WebSocket Connection Retry... retry : "+m),m&&m>0?(m-=1,T=setTimeout(function(){u(I,function(t){R.debug("WebSocket re-connection success."),m=g,e.successCallback(t)},function(t){R.debug("WebSocket re-connection failure.The left trial : "+m),D.handleWebsocketRetry({message:t,successCallback:e.successCallback,failureCallback:e.failureCallback})})},C)):(R.debug("WebSocket re-connection failure.WebSocket URL out of use !"),e.failureCallback(e.message))},this.handleWebsocketRetryValueValidation=function(e){return isNaN(e)||0>e||e>10?h:e},this.handleWebsocketRetryTimeValidation=function(e){return isNaN(e)||1e3>e||e>1e4?N:e},this.setNotificationSuccessAfterFailureCallback=function(e){E=e.callback},this.setNotificationFailureCallback=function(e){S=e.callback},f=function(e){var t=e.data,n=e.type;t&&n&&(-1!==A.indexOf(t.eventId)?R.info("event received previously: "+t.eventId):(A.push(t.eventId),A.length===b&&A.splice(0,50),r.callFunctionIfExist(c[n],t))),D.isLongPollingConnection({notificationURL:e.notificationURL})&&l(e.notificationURL,function(){})},p=function(e){return R.error("received notification error:"+e.error),t.publish(a.EVENT.NOTIFICATION_CHANNEL_LOST),o.isConnected()?(R.trace("It was set isNotificationFailureDetected parameter as true"),_=!0,void S(e.error)):void R.debug("Connection is lost, no need to handle notification failure...")},this.trigger=function(e){i.trigger({notificationUrl:e.notificationUrl,notificationSuccess:f,notificationFailure:d})},this.connect=function(e){function t(t){_&&(R.trace("It was set isNotificationFailureDetected parameter as false"),_=!1,"function"==typeof E&&E(t)),"function"==typeof e.onSuccess&&e.onSuccess(t)}R.trace("Clear web socket timer"),clearTimeout(T),D.isWebSocketConnection({notificationURL:e.notificationURL})?(g=D.handleWebsocketRetryValueValidation(parseInt(s.serverRetryNumber,10)),m=D.handleWebsocketRetryValueValidation(parseInt(s.serverRetryNumber,10)),C=D.handleWebsocketRetryTimeValidation(parseInt(s.serverRetryInterval,10)),I=e.notificationURL,u(e.notificationURL,t,function(n){R.debug("WebSocket Connection Failed..."),p(n),D.handleWebsocketRetry({message:n,successCallback:t,failureCallback:e.onFailure})})):(v=e.onFailure,l(e.notificationURL,t))},this.clearConnection=function(e){e&&e.notificationType===D.NotificationTypes.LONGPOLLING?i.clearConnection():e&&e.notificationType===D.NotificationTypes.WEBSOCKET?n.clearConnection():(i.clearConnection(),n.clearConnection()),e&&e.withNotificationFailure&&(R.trace("It was set isNotificationFailureDetected parameter as true"),_=!0),R.trace("Clear web socket timer"),clearTimeout(T)}},je=function(e,t,n,i,o,r,a,s,c){return new Ye(e||B,t||I,n||xe,i||ke,o||R,r||q,a||v,s||O,c||Ge)},Je=new je;g&&(g.NotificationManager=je),g&&(R.NotificationManager=Je);var qe=function(e,t,n,i,o,r,a,s,c,d){function l(e){Te=e.token}function u(){r.removeItem(me+ue.NOTIFYURL),r.removeItem(me+ue.NOTIFYID),r.removeItem(me+ue.SUBSCRIBEURL),r.removeItem(me+ue.SUBSCRIBEEXPIRY),r.removeItem(me+ue.SUBSCRIBEEXTENDINTERVAL),r.removeItem(me+ue.SESSION)}function f(){r.removeItem(me+ue.USERNAME),r.removeItem(ue.PASSWORD)}function p(e){o.publish(c.EVENT.DEVICE_SUBSCRIPTION_STARTED,e)}function E(e){o.publish(c.EVENT.DEVICE_SUBSCRIPTION_ENDED,e)}function S(){clearTimeout(ne),ne=null}function T(){le.debug("Notification subscription success"),e.currentNotificationType===Ce.WEBSOCKET&&a.clearConnection({notificationType:Ce.LONGPOLLING}),p({session:ge}),Ee&&(s.callFunctionIfExist(Ee),Ee=null)}function g(){clearTimeout(te),te=null}function m(){le.debug("extend notification subscription timer is stopped."),clearInterval(pe),pe=null}function C(){m(),g(),S()}function I(t){le.debug("Clearing subscription."),re=null,u(),a.clearConnection(),C(),E(t),t&&t.doNotDeleteConfig||(e.currentNotificationType=void 0)}function v(){return ce>se?(le.debug("server index: ",se),le.debug("updating config values to: ",e.servers[se]),e.restUrl=e.servers[se].restUrl,e.restPort=e.servers[se].restPort,e.protocol=e.servers[se].protocol,e.websocketIP=e.servers[se].websocketIP,e.websocketPort=e.servers[se].websocketPort,e.websocketProtocol=e.servers[se].websocketProtocol,!0):!1}function R(){se=0}function A(){return ce>se+1}function _(){return++se,v()}function D(e){le.debug("Clear for on subscription failure."),t.isConnected()&&(I(),s.callFunctionIfExist(Se,e))}function N(e){le.debug("notification failure: ",e),s.callFunctionIfExist(ie,e)}function h(){return re}function b(e){le.debug("Handle long polling failure.."),ae&&A()?(le.debug("Try next server."),de({changeServerCallback:_})):D(e)}function O(t){le.debug("Handle web socket failure.."),ae&&A()?(le.debug("Try next server."),de({changeServerCallback:_})):e.currentNotificationType===Ce.WEBSOCKET?(le.debug("New server could not be configured. Try long polling."),de({newNotificationType:Ce.LONGPOLLING,forceDeviceSubscription:!0})):D(t)}function L(e){le.debug("Handle web socket only failure.."),ae&&A()?(le.debug("Try next server."),de({changeServerCallback:_})):D(e)}function y(t){e.notificationType===Ce.LONGPOLLING?b(t):e.notificationType===Ce.WEBSOCKET?O(t):e.notificationType===Ce.WEBSOCKET_ONLY&&L(t)}function V(e){y(e)}function M(e){y(e)}function P(i){return t.isConnected()?(m(),le.debug("Subscribing..."),void n.subscribe(function(n,i,o,s,c,d,l){Te=null,t.setServices(e.services||c),e.services=e.services||c,e.servicesReceivingNotification=d,e.polling=s,e.expires=o,e.extendInterval=o/2,re={},re.notificationURL=i,re.notificationId=i.substr(i.lastIndexOf("/")+1),re.subscriptionURL=n,r.setItem(me+ue.NOTIFYURL,re.notificationURL),r.setItem(me+ue.NOTIFYID,re.notificationId),r.setItem(me+ue.SUBSCRIBEURL,re.subscriptionURL),r.setItem(me+ue.SUBSCRIBEEXPIRY,e.expires),r.setItem(me+ue.SUBSCRIBEEXTENDINTERVAL,e.extendInterval),r.setItem(me+ue.USERNAME,t.getUser()),l&&(ge=l,r.setItem(me+ue.SESSION,ge)),pe=setInterval(Z,1e3*e.extendInterval),le.debug("Subscription successfull - notifier: ",re),a.connect({notificationURL:i,onSuccess:T,onFailure:V})},function(e){e!==t.Errors.CONNECTION_ISSUE&&(le.error("Subscription is failed - error: "+e),M(e))},i,Te)):(le.debug("Connection is lost, no need to subscribe..."),void M(t.Errors.CONNECTION_ISSUE))}function F(){a.clearConnection({withNotificationFailure:!0}),N(c.NOTIFICATION.STATUS.STOP_FOR_RESTART),E()}function w(){return t.isConnected()?(m(),le.debug("Extending subscription... - subscription URL: ",re.subscriptionURL),void n.extendSubscription(re.subscriptionURL,function(n,i,o){t.setServices(e.services||i),e.services=e.services||i,e.servicesReceivingNotification=o,re.notificationURL=n,r.setItem(me+ue.NOTIFYURL,n),pe=setInterval(Z,1e3*e.extendInterval),le.debug("Extending subscription successful - notifier: ",re),a.connect({notificationURL:n,onSuccess:T,onFailure:V})},function(e){t.isConnected()?(le.error("Extending subscription is failed - error: "+e),le.error("Fail reusing existing subscription, re-subscribing."),F(),P()):le.error("Extending subscription is failed and connection is lost - error: "+e)})):void le.debug("Connection is lost, no need to extend subscribe...")}function k(e){I({doNotDeleteConfig:!0}),e(),P()}function U(e){h()?n.deleteSubscription(re.subscriptionURL,function(){k(e)},function(){k(e)}):(e(),P())}function W(e){h()?e?n.deleteSubscription(re.subscriptionURL,function(){P()},function(){le.debug("Un usbscription failed for old subscription with websocket"),P()}):w():P()}function x(){R(),v()}function B(){de(ae&&ce>1?{newNotificationType:Ce.WEBSOCKET,clearConnectionAndNotifiyUser:!0,changeServerCallback:x}:{newNotificationType:Ce.WEBSOCKET,clearConnectionAndNotifiyUser:!0})}function H(n){if(!t.isConnected())return void le.debug("Connection is lost, no need to subscribe...");le.debug("start - notification subscription...");var i=r.getItem(me+ue.NOTIFYURL),o=r.getItem(me+ue.NOTIFYID),a=r.getItem(me+ue.SUBSCRIBEURL),s=r.getItem(me+ue.SUBSCRIBEEXPIRY),c=r.getItem(me+ue.SUBSCRIBEEXTENDINTERVAL),d=r.getItem(me+ue.USERNAME);le.debug("start - cached data - nurl: "+i+" nid: "+o+" surl: "+a+" exp: "+s+" extendInterval: "+c+" user: "+d),i&&o&&a&&s&&c&&t.getUser()===d?(re={},re.notificationURL=i,re.notificationId=o,re.subscriptionURL=a,e.expires=s,e.extendInterval=c,Z()):P(n)}function G(){ce=e.servers.length,le.debug("Number of servers to be tried: ",ce)}function Y(){return e.servers?(ae=!0,G(),R(),v()):!0}function j(e,t,n,i){Ee=e,Se=t,fe=n,i&&(me=i)}function J(){e.notificationType||(e.notificationType=Ce.LONGPOLLING),e.notificationType===Ce.WEBSOCKET_ONLY?e.currentNotificationType=Ce.WEBSOCKET:e.currentNotificationType=e.notificationType,le.debug("Current notification type is set as: ",e.currentNotificationType)}function q(){return e.currentNotificationType}function K(){g(),te=setTimeout(function(){H(),t.isConnected()&&s.callFunctionIfExist(ee)},Math.random()*c.TIMEOUT.INTERVAL_TO_PREVENT_CONFLICTS)}function z(){C(),a.clearConnection(),s.callFunctionIfExist($)}function Q(e){I(),f(),s.callFunctionIfExist(t.notification.onGoneReceived,e)}function X(){I(),f(),s.callFunctionIfExist(Se,c.SUBSCRIPTION_EVENT.TOKEN_OR_SESSION_LOSS)}var Z,$,ee,te,ne,ie,oe,re,ae,se,ce,de,le=i.getLogger("subscriptionManager"),ue=c.CACHE,fe=!1,pe=null,Ee=null,Se=null,Te=null,ge=null,me="",Ce=a.NotificationTypes;this.isAnonymous=function(){return fe},de=function(n){S(),ne=setTimeout(function(){return t.isConnected()?(le.debug("Restarting subscription..."),n.newNotificationType&&(e.currentNotificationType=n.newNotificationType,le.debug("Current notification type is set as: ",e.currentNotificationType)),n.clearConnectionAndNotifiyUser&&(a.clearConnection({withNotificationFailure:!0}),N(c.NOTIFICATION.STATUS.STOP_FOR_RESTART)),void(n.changeServerCallback?U(n.changeServerCallback):W(n.forceDeviceSubscription))):void le.debug("Connection is lost, no need to restart subscription...")},Math.random()*c.TIMEOUT.INTERVAL_TO_PREVENT_CONFLICTS)},Z=function(){return t.isConnected()?void(h()?e.notificationType===Ce.WEBSOCKET&&e.currentNotificationType===Ce.LONGPOLLING?(le.debug("Try recovering from long polling..."),B()):w():(le.debug("Cannot reuse existing subscription, re-subscribing."),P())):void le.debug("Connection is lost, no need to extend subscribe...")},this.stop=function(e,i,o){return o||t.isConnected()?(le.debug("Unsubscribing... - notifier: ",re),void(h()?n.deleteSubscription(re.subscriptionURL,function(){le.debug("Unsubscription successfull"),I({resetConnectivity:!0}),"function"==typeof e&&e()},function(t){o?(le.debug("Forced Unsubscription successfull"),I({resetConnectivity:!0}),"function"==typeof e&&e()):(le.error("Unsubscribe if failed - error:"+t),"function"==typeof i&&i())}):(le.trace("subscription URL is unknown, cannot send unsubscribe request."),"function"==typeof e&&e()))):(le.debug("Connection is lost, no need to unsubscribe..."),void("function"==typeof i&&i(t.Errors.CONNECTION_ISSUE)))},this.start=function(e,t,n,i,o){return Y()?(j(e,t,n,i),J(),void H(o)):void s.callFunctionIfExist(t,c.NOTIFICATION.STATUS.CONFIGURATION_ERROR)},this.extend=function(e,t){return q()?(Ee=e,Se=t,void H()):void s.callFunctionIfExist(t,c.NOTIFICATION.STATUS.NOT_STARTED)},this.setOnConnectionLost=function(e){$=e},this.setOnConnectionEstablished=function(e){ee=e},this.setOnError=function(e){ie=e},this.getNotificationId=function(){return re?re.notificationId:void 0},a.setNotificationFailureCallback({callback:N}),this.setOnSuccess=function(e){oe=e},a.setNotificationSuccessAfterFailureCallback({callback:function(){le.debug("notification success after notification failure."),s.callFunctionIfExist(oe)}}),this.trigger=function(){le.debug("Trigger called to fetch notification."),a.trigger({notificationUrl:re.notificationURL})},d.gone=function(e){Q(e)},o.subscribe(c.EVENT.CONNECTION_REESTABLISHED,K),o.subscribe(c.EVENT.CONNECTION_LOST,z),o.subscribe(c.EVENT.TOKEN_AUTH_STARTED,l,10),o.subscribe(c.EVENT.TOKEN_NOT_FOUND,X),o.subscribe(c.EVENT.SESSION_EXPIRED,X)},Ke=function(e,t,n,i,o,r,a,s,c,d){return new qe(e||O,t||R,n||be,i||B,o||I,r||j,a||Je,s||q,c||v,d||Ge)},ze=new Ke;g&&(g.SubscriptionManager=Ke),g&&(R.SubscriptionManager=ze);var Qe=function(e){this.onGoneReceived=null,this.NotificationTypes={LONGPOLLING:"longpolling",WEBSOCKET:"websocket",WEBSOCKET_ONLY:"websocketonly"},this.isAnonymous=function(){return e.isAnonymous()},this.stop=function(t,n,i){e.stop(t,n,i)},this.start=function(t,n,i,o,r){e.start(t,n,i,o,r)},this.extend=function(t,n){e.extend(t,n)},this.setOnError=function(t){e.setOnError(t)},this.setOnSuccess=function(t){e.setOnSuccess(t)},this.setOnConnectionLost=function(t){e.setOnConnectionLost(t)},this.setOnConnectionEstablished=function(t){e.setOnConnectionEstablished(t)},this.trigger=function(){e.trigger()}},Xe=function(e){return new Qe(e||ze)};R.notification=new Xe(ze),g&&(g.Notification=Xe);var Ze=function(e){function t(e,t,i,o){var r=n.getCurrentState(e);switch(r){case n.CallFSMState.INIT:switch(t){case n.NotificationEvent.callStart_GUI:e.currentState=n.CallFSMState.TRYING,i(e,n.TransferEvent.callStart_fsm);break;case n.NotificationEvent.callNotify:e.currentState=n.CallFSMState.RINGING,i(e,n.TransferEvent.callReceived_fsm);break;case n.NotificationEvent.callNotify_noSDP:e.currentState=n.CallFSMState.RINGING_SLOW,i(e,n.TransferEvent.callReceived_fsm);break;case n.NotificationEvent.joiningSuccess_Notify:e.currentState=n.CallFSMState.PROVISIONRECEIVED,i(e,n.TransferEvent.joiningSuccess_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.RINGING:switch(t){case n.NotificationEvent.answer_GUI:e.currentState=n.CallFSMState.COMPLETED,i(e,n.TransferEvent.answer_fsm);break;case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.reject_GUI);break;case n.NotificationEvent.callNotify_noSDP:e.currentState=n.CallFSMState.RINGING_SLOW,i(e,n.TransferEvent.callReceived_fsm);break;case n.NotificationEvent.callEnd_Notify:case n.NotificationEvent.callCancel_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.forward_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.forward_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.RINGING_SLOW:switch(t){case n.NotificationEvent.answer_GUI:e.currentState=n.CallFSMState.ANSWERING,i(e,n.TransferEvent.answerRingingSlow_fsm);break;case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.reject_GUI);break;case n.NotificationEvent.callEnd_Notify:case n.NotificationEvent.callCancel_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.forward_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.forward_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.ANSWERING:switch(t){case n.NotificationEvent.respondCallUpdate_Notify:e.currentState=n.CallFSMState.COMPLETED,i(e,n.TransferEvent.callCompletedAnswering_fsm);break;case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.TRYING:switch(t){case n.NotificationEvent.sessionProgress:e.currentState=n.CallFSMState.PROVISIONRECEIVED,i(e,n.TransferEvent.remotePranswer_fsm);break;case n.NotificationEvent.ringing_Notify:e.currentState=n.CallFSMState.PROVISIONRECEIVED,i(e,n.TransferEvent.ringing_fsm);break;case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.noAnswer_fsm);break;case n.NotificationEvent.respondCallUpdate_Notify:e.currentState=n.CallFSMState.COMPLETED,i(e,n.TransferEvent.callCompleted_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.PROVISIONRECEIVED:switch(t){case n.NotificationEvent.respondCallUpdate_Notify:e.currentState=n.CallFSMState.COMPLETED,i(e,n.TransferEvent.callCompleted_fsm);break;case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.ringing_Notify:i(e,n.TransferEvent.ringing_fsm);break;case n.NotificationEvent.sessionProgress:i(e,n.TransferEvent.remotePranswer_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.COMPLETED:
switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.startCallUpdate_remoteHold_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.REMOTE_HOLDING,i(e,n.TransferEvent.remoteHolding_fsm);break;case n.NotificationEvent.startCallUpdate_slowStart_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_SLOW_START_OFFER,i(e,n.TransferEvent.slowStartOfferDuringOnCall_fsm);break;case n.NotificationEvent.hold_GUI:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_HOLDING,i(e,n.TransferEvent.localHolding_fsm);break;case n.NotificationEvent.videoStopStart_GUI:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_VIDEO_STOP_START,i(e,n.TransferEvent.localVideoStopStart_fsm);break;case n.NotificationEvent.startCallUpdate_remoteOffer_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.REMOTE_OFFER,i(e,n.TransferEvent.remoteOffer_fsm);break;case n.NotificationEvent.transfering:e.previousState=e.currentState,e.currentState=n.CallFSMState.TRANSFERING,i(e,n.TransferEvent.transfering_fsm);break;case n.NotificationEvent.callCancel_Notify:i(e,n.TransferEvent.ignoredNotification_fsm);break;case n.NotificationEvent.performReconnectWorkaround_JSL:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_REOFFER,i(e,n.TransferEvent.performReconnectWorkaround_fsm);break;case n.NotificationEvent.performCreateNewPeerWorkaround_JSL:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_REOFFER,i(e,n.TransferEvent.performCreateNewPeerWorkaround_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.LOCAL_REOFFER:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.respondCallUpdate_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.respondCallUpdate_fsm);break;case n.NotificationEvent.webrtcFailure_JSL:case n.NotificationEvent.requestFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.REMOTE_OFFER:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.remoteOfferProcessed_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.renegotiationCompleted_fsm);break;case n.NotificationEvent.requestFailure_JSL:case n.NotificationEvent.webrtcFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.LOCAL_VIDEO_STOP_START:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.respondCallUpdate_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.respondCallUpdate_fsm);break;case n.NotificationEvent.requestFailure_JSL:case n.NotificationEvent.webrtcFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;case n.NotificationEvent.respondCallUpdate_glareCondition_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.glareCondition_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.LOCAL_HOLDING:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.respondCallUpdate_Notify:e.currentState=n.CallFSMState.LOCAL_HOLD,e.previousState===n.CallFSMState.REMOTE_HOLD&&(e.currentState=n.CallFSMState.BOTH_HOLD),e.previousState=r,i(e,n.TransferEvent.respondCallHoldUpdate_fsm);break;case n.NotificationEvent.requestFailure_JSL:case n.NotificationEvent.webrtcFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;case n.NotificationEvent.respondCallUpdate_glareCondition_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.glareCondition_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.LOCAL_UNHOLDING:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.respondCallUpdate_Notify:e.currentState=n.CallFSMState.COMPLETED,e.previousState===n.CallFSMState.BOTH_HOLD&&(e.currentState=n.CallFSMState.REMOTE_HOLD),e.previousState=r,i(e,n.TransferEvent.respondCallHoldUpdate_fsm);break;case n.NotificationEvent.requestFailure_JSL:case n.NotificationEvent.webrtcFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;case n.NotificationEvent.respondCallUpdate_glareCondition_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.glareCondition_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.LOCAL_HOLD:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.startCallUpdate_remoteHold_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.REMOTE_HOLDING,i(e,n.TransferEvent.remoteHolding_fsm);break;case n.NotificationEvent.startCallUpdate_remoteOffer_Notify:i(e,n.TransferEvent.remoteOfferDuringLocalHold_fsm);break;case n.NotificationEvent.unhold_GUI:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_UNHOLDING,i(e,n.TransferEvent.localUnHolding_fsm);break;case n.NotificationEvent.joining_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.JOINING,i(e,n.TransferEvent.joining_fsm);break;case n.NotificationEvent.transfering:e.previousState=e.currentState,e.currentState=n.CallFSMState.TRANSFERING,i(e,n.TransferEvent.transfering_fsm);break;case n.NotificationEvent.performReconnectWorkaround_JSL:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_REOFFER,i(e,n.TransferEvent.performReconnectWorkaround_fsm);break;case n.NotificationEvent.consultativeTransfer_GUI:e.previousState=e.currentState,e.currentState=n.CallFSMState.TRANSFERING,i(e,n.TransferEvent.transfering_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.REMOTE_HOLDING:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.remoteHoldProcessed_JSL:e.currentState=n.CallFSMState.REMOTE_HOLD,e.previousState===n.CallFSMState.LOCAL_HOLD&&(e.currentState=n.CallFSMState.BOTH_HOLD),e.previousState=r,i(e,n.TransferEvent.remoteHold_fsm);break;case n.NotificationEvent.requestFailure_JSL:case n.NotificationEvent.webrtcFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.REMOTE_UNHOLDING:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.remoteUnHoldProcessed_JSL:e.currentState=n.CallFSMState.COMPLETED,e.previousState===n.CallFSMState.BOTH_HOLD&&(e.currentState=n.CallFSMState.LOCAL_HOLD),e.previousState=r,i(e,n.TransferEvent.remoteUnHold_fsm);break;case n.NotificationEvent.requestFailure_JSL:case n.NotificationEvent.webrtcFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.REMOTE_HOLD:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.startCallUpdate_remoteHold_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.REMOTE_HOLDING,i(e,n.TransferEvent.remoteHolding_fsm);break;case n.NotificationEvent.startCallUpdate_remoteOffer_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.REMOTE_UNHOLDING,i(e,n.TransferEvent.remoteUnHolding_fsm);break;case n.NotificationEvent.startCallUpdate_slowStart_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_SLOW_START_OFFER,i(e,n.TransferEvent.slowStartOfferDuringRemoteHold_fsm);break;case n.NotificationEvent.hold_GUI:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_HOLDING,i(e,n.TransferEvent.localHolding_fsm);break;case n.NotificationEvent.joining_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.JOINING,i(e,n.TransferEvent.joining_fsm);break;case n.NotificationEvent.performReconnectWorkaround_JSL:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_REOFFER,i(e,n.TransferEvent.performReconnectWorkaround_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.BOTH_HOLD:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.startCallUpdate_remoteHold_Notify:case n.NotificationEvent.startCallUpdate_remoteOffer_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.REMOTE_UNHOLDING,i(e,n.TransferEvent.remoteUnHolding_fsm);break;case n.NotificationEvent.unhold_GUI:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_UNHOLDING,i(e,n.TransferEvent.localUnHolding_fsm);break;case n.NotificationEvent.joining_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.JOINING,i(e,n.TransferEvent.joining_fsm);break;case n.NotificationEvent.transfering:e.previousState=e.currentState,e.currentState=n.CallFSMState.TRANSFERING,i(e,n.TransferEvent.transfering_fsm);break;case n.NotificationEvent.performReconnectWorkaround_JSL:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_REOFFER,i(e,n.TransferEvent.performReconnectWorkaround_fsm);break;case n.NotificationEvent.consultativeTransfer_GUI:e.previousState=e.currentState,e.currentState=n.CallFSMState.TRANSFERING,i(e,n.TransferEvent.transfering_fsm);break;case n.NotificationEvent.startCallUpdate_slowStart_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_SLOW_START_OFFER,i(e,n.TransferEvent.slowStartOfferDuringRemoteHold_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.LOCAL_SLOW_START_OFFER:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.respondCallUpdate_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.COMPLETED,i(e,n.TransferEvent.respondCallUpdate_fsm);break;case n.NotificationEvent.requestFailure_JSL:case n.NotificationEvent.webrtcFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;case n.NotificationEvent.slowStartOfferProcessed_JSL:i(e,n.TransferEvent.slowStartOfferProcessed_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.JOINING:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.sessionComplete_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.sessionComplete_fsm);break;case n.NotificationEvent.sessionFail_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.sessionFail_fsm);break;case n.NotificationEvent.refer_JSL:e.currentState=n.CallFSMState.REFER,i(e,n.TransferEvent.refer_fsm);break;case n.NotificationEvent.revertState_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.REFER:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.sessionComplete_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.sessionComplete_fsm);break;case n.NotificationEvent.sessionFail_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.sessionFail_fsm);break;case n.NotificationEvent.accepted_Notify:i(e,n.TransferEvent.accepted_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.TRANSFERING:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.sessionComplete_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.transferSuccess_fsm);break;case n.NotificationEvent.sessionFail_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.transferFail_fsm);break;case n.NotificationEvent.accepted_Notify:i(e,n.TransferEvent.accepted_fsm);break;case n.NotificationEvent.startCallUpdate_slowStart_Notify:case n.NotificationEvent.startCallUpdate_remoteHold_Notify:case n.NotificationEvent.startCallUpdate_remoteOffer_Notify:i(e,n.TransferEvent.remoteCallUpdate_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}}}this.CallFSMState={INIT:"INIT",RINGING:"RINGING",TRYING:"TRYING",ANSWERING:"ANSWERING",COMPLETED:"COMPLETED",RINGING_SLOW:"RINGING_SLOW",LOCAL_HOLD:"LOCAL_HOLD",LOCAL_HOLDING:"LOCAL_HOLDING",LOCAL_UNHOLDING:"LOCAL_UNHOLDING",LOCAL_VIDEO_STOP_START:"LOCAL_VIDEO_STOP_START",REMOTE_OFFER:"REMOTE_OFFER",REMOTE_HOLD:"REMOTE_HOLD",REMOTE_HOLDING:"REMOTE_HOLDING",REMOTE_UNHOLDING:"REMOTE_UNHOLDING",BOTH_HOLD:"BOTH_HOLD",JOINING:"JOINING",PROVISIONRECEIVED:"PROVISIONRECEIVED",REFER:"REFER",TRANSFERING:"TRANSFERING",LOCAL_SLOW_START_OFFER:"LOCAL_SLOW_START_OFFER",LOCAL_REOFFER:"LOCAL_REOFFER"},this.TransferEvent={unknownNotification_fsm:"unknownNotification_fsm",ignoredNotification_fsm:"ignoredNotification_fsm",callStart_fsm:"callStart_fsm",callReceived_fsm:"callReceived_fsm",answer_fsm:"answer_fsm",reject_GUI:"reject_GUI",callCompleted_fsm:"callCompleted_fsm",noAnswer_fsm:"noAnswer_fsm",localEnd_fsm:"localEnd_fsm",remoteEnd_fsm:"remoteEnd_fsm",answeringRingingSlow_fsm:"answeringRingingSlow_fsm",callCompletedAnswering_fsm:"callCompletedAnswering_fsm",localHold_fsm:"localHold_fsm",localHolding_fsm:"localHolding_fsm",remoteHold_fsm:"remoteHold_fsm",remoteHolding_fsm:"remoteHolding_fsm",localUnHold_fsm:"localUnHold_fsm",localUnHolding_fsm:"localUnHolding_fsm",remoteUnHold_fsm:"remoteUnHold_fsm",remoteUnHolding_fsm:"remoteUnHolding_fsm",localVideoStopStart_fsm:"localVideoStopStart_fsm",remoteOffer_fsm:"remoteOffer_fsm",joining_fsm:"joining_fsm",sessionComplete_fsm:"sessionComplete_fsm",joiningSuccess_fsm:"joiningSuccess_fsm",sessionFail_fsm:"sessionFail_fsm",ringing_fsm:"ringing_fsm",respondCallUpdate_fsm:"respondCallUpdate_fsm",remoteCallUpdate_fsm:"remoteCallUpdate_fsm",remotePranswer_fsm:"remotePranswer_fsm",forward_fsm:"forward_fsm",refer_fsm:"refer_fsm",accepted_fsm:"accepted_fsm",transfering_fsm:"transfering_fsm",transferSuccess_fsm:"transferSuccess_fsm",transferFail_fsm:"transferFail_fsm",respondCallHoldUpdate_fsm:"respondCallHoldUpdate_fsm",remoteOfferDuringLocalHold_fsm:"remoteOfferDuringHold_fsm",renegotiationCompleted_fsm:"renegotiationCompleted_fsm",slowStartOfferDuringRemoteHold_fsm:"slowStartOfferDuringRemoteHold_fsm",slowStartOfferDuringOnCall_fsm:"slowStartOfferDuringOnCall_fsm",stateReverted_fsm:"stateReverted_fsm",glareCondition_fsm:"glareCondition_fsm",slowStartOfferProcessed_fsm:"slowStartOfferProcessed_fsm",performReconnectWorkaround_fsm:"performReconnectWorkaround_fsm",consultativeTransfer_fsm:"consultativeTransfer_fsm",performCreateNewPeerWorkaround_fsm:"performCreateNewPeerWorkaround_fsm"},this.NotificationEvent={callStart_GUI:"callStart_GUI",callNotify:"callNotify",ringing_Notify:"ringing_Notify",answer_GUI:"answer_GUI",end_GUI:"end_GUI",respondCallUpdate_Notify:"respondCallUpdate_Notify",respondCallUpdate_glareCondition_Notify:"respondCallUpdate_glareCondition_Notify",callCompleted_fsm:"callCompleted_fsm",callEnd_Notify:"callEnd_Notify",callNotify_noSDP:"callNotify_noSDP",startCallUpdate_slowStart_Notify:"startCallUpdate_slowStart_Notify",startCallUpdate_remoteHold_Notify:"startCallUpdate_remoteHold_Notify",startCallUpdate_remoteOffer_Notify:"startCallUpdate_remoteOffer_Notify",joining_Notify:"joining_Notify",sessionComplete_Notify:"sessionComplete_Notify",joiningSuccess_Notify:"joiningSuccess_Notify",sessionFail_Notify:"sessionFail_Notify",hold_GUI:"hold_GUI",unhold_GUI:"unhold_GUI",videoStopStart_GUI:"videoStopStart_GUI",sessionProgress:"sessionProgress",callCancel_Notify:"callCancel_Notify",forward_GUI:"forward_GUI",refer_JSL:"refer_JSL",accepted_Notify:"accepted_Notify",transfering:"transfering",requestFailure_JSL:"requestFailure_JSL",webrtcFailure_JSL:"webrtcFailure_JSL",remoteOfferProcessed_JSL:"remoteOfferProcessed_JSL",remoteHoldProcessed_JSL:"remoteHoldProcessed_JSL",remoteUnHoldProcessed_JSL:"remoteUnHoldProcessed_JSL",slowStartOfferProcessed_JSL:"slowStartOfferProcessed_JSL",performReconnectWorkaround_JSL:"performReconnectWorkaround_JSL",consultativeTransfer_GUI:"consultativeTransfer_GUI",performCreateNewPeerWorkaround_JSL:"performCreateNewPeerWorkaround_JSL",revertState_JSL:"revertState_JSL"};var n=this,i=e.getLogger("callFsm");n.getCurrentState=function(e){return e.currentState?e.currentState:n.CallFSMState.INIT},this.handleEvent=function(e,o,r){var a;e&&(a=n.getCurrentState(e),i.info("FSM received NotificationEvent: "+o+" @ "+a+" state. Call Id: "+e.id),t(e,o,function(e,t){i.debug("FSM handleEvent successful. (Call FSM) State Passed from "+a+" to "+n.getCurrentState(e)+". TransferEvent: "+t+". Call Id: "+e.id),r(e,t)},function(e,t){i.error("FSM handleEvent failure: "+t+" @ "+n.getCurrentState(e)+". Call Id: "+e.id),r(e,t)}))}},$e=function(e){return new Ze(e||B)},et=new $e;g&&(g.CallFSM=$e);var tt=function(e,t,n,i,o,r){function a(e){i.notification.isAnonymous()&&n.getItem("NotificationId")&&(e.callMeRequest.notifyChannelId=n.getItem("NotificationId"))}function s(e){return e&&e.responseText?JSON.parse(e.responseText).callControlResponse:void 0}function c(t,n,i,o,a){f.info("makeCallControlRequest Function : sdp : "+i);var c={callControlRequest:{type:t,sdp:i}};e.sendPutRequest({url:r(1,"/callControl/callSessions/"+n),data:c},o,a,null,s)}function d(t,n,o){var a=l();f.info("makeCallControlEndRequest Function: "+t),e.sendDeleteRequest({url:r(1,(i.notification.isAnonymous()?"/callme/callSessions/":"/callControl/callSessions/")+t+(a?"?tokenrealm="+a:"")),data:{}},n,o,null,s)}function u(t,n,i,o,a){f.info("makeRequest Function with action : "+t);var c={callDispositionRequest:{action:t,sessionData:n}};a&&(c.callDispositionRequest.address=a),e.sendPostRequest({url:r(1,"/calldisposition"),data:c},i,o,null,s)}var f=t.getLogger("callControlService");this.startCall=function(t,n,c,d,u){function p(e){var t,n=i.notification.isAnonymous()?e.callMeResponse:e.callControlResponse;return n&&(t=n.sessionData),t}function E(){var e;return i.notification.isAnonymous()?e={callMeRequest:{type:"callStart",from:t,to:n,sdp:c}}:(e={callControlRequest:{type:"callStart",from:t,to:n,sdp:c}},o.earlyMedia===!0&&(e.callControlRequest.supported=["earlymedia"])),e}f.info("Call Start Function: "+t+" --> "+n),f.info("Call Start Function: sdp : "+c);var S=E(),T=l();a(S),e.sendPostRequest({url:r(1,i.notification.isAnonymous()?"/callMe"+(T?"?tokenrealm="+T:""):"/callControl"),data:S},d,u,p,s)},this.audit=function(t,n,o){var a,c=l();a=i.notification.isAnonymous()?{callMeRequest:{type:"audit"}}:{callControlRequest:{type:"audit"}},c&&(t=t.split("%0A")[0]),e.sendPutRequest({url:r(1,(i.notification.isAnonymous()?"/callme/callSessions/":"/callControl/callSessions/")+t+(c?"?tokenrealm="+c:"")),data:a},n,o,null,s)},this.hold=function(t,n,i,o){f.info("Hold Function : sdp : "+n);var a={callControlRequest:{type:"startCallUpdate",sdp:n}};e.sendPutRequest({url:r(1,"/callControl/callSessions/"+t),data:a},i,o,null,s)},this.unhold=function(t,n,i,o){f.info("UnHold Function : sdp : "+n);var a={callControlRequest:{type:"startCallUpdate",sdp:n}};e.sendPutRequest({url:r(1,"/callControl/callSessions/"+t),data:a},i,o,null,s)},this.reinvite=function(t,n,i,o){f.info("reinvite Function : sdp : "+n);var a={callControlRequest:{type:"startCallUpdate",sdp:n}};e.sendPutRequest({url:r(1,"/callControl/callSessions/"+t),data:a},i,o,null,s)},this.respondCallUpdate=function(t,n,i,o){f.info("Respond Call Update Function : sdp : "+n);var a={callControlRequest:{type:"respondCallUpdate",sdp:n}};e.sendPutRequest({url:r(1,"/callControl/callSessions/"+t),data:a},i,o,null,s)},this.join=function(t,n,i,a,c){function d(e){var t,n=e.callControlResponse;return n&&(t=n.sessionData),t}f.info("Join Function : sdp : "+i);var l={callControlRequest:{type:"join",firstSessionData:t,secondSessionData:n,sdp:i}};"true"===o.clientControlled&&(l.callControlRequest.clientControlled="true"),e.sendPostRequest({url:r(1,"/callControl/"),data:l},a,c,d,s)},this.refer=function(t,n,i,o,a){f.info("Refer Function : refer to: "+n);var c={callControlRequest:{type:"refer",from:i,to:n}};e.sendPutRequest({url:r(1,"/callControl/callSessions/"+t),data:c},o,a,null,s)},this.endCall=function(e,t,n){f.info("endCall Function: "+e),d(e,t,n,null,s)},this.answerCall=function(e,t,n,i){f.info("Answer Call Function : sdp : "+t),c("callAnswer",e,t,n,i,null,s)},this.reject=function(e,t,n){var i;f.info("Reject Function: "+e),u("reject",e,t,n,i,s)},this.forward=function(e,t,n,i){f.info("Forward Function : address: "+t),u("forward",e,n,i,t)},this.transfer=function(t,n,i,o,a){f.info("Call Transfer Function : target address: "+n);var c={callControlRequest:{type:"transfer",address:n,sessionData:i}};e.sendPutRequest({url:r(1,"/callControl/callSessions/"+t),data:c},o,a,null,s)},this.clickToCall=function(t,n,i,o){var a={clickToCallRequest:{callingParty:t,calledParty:n}};e.sendPostRequest({url:r(1,"/clicktocall"),data:a},i,o)},this.getIMRN=function(t,n,i,o,a){function s(e){var t;return e&&e.imrnResponse&&(t=q.getProperty(e.imrnResponse,"imrn")),t}f.info("(Wam Call) getIMRN Function "),i.match("@")&&"sip"!==i.split(":")[0]&&(i="sip:"+i);var c={imrnRequest:{realm:t,sourceAddress:n,destinationAddress:i}};e.sendPostRequest({url:r(1,"/imrn"),data:c},o,a,s)}},nt=function(e,t,n,i,o,r){return new tt(e||b,t||B,n||j,i||R,o||O,r||T)},it=new nt,ot=function(e,t,n,i,o,r,a,s){function c(e,t){e.indexOf("sip:",0)>-1&&(e=e.replace("sip:",""));var n="";return void 0===t||null===t?e.indexOf("@",0)>-1?"sip:"+e:e:(t.firstName&&""!==t.firstName&&(n+=t.firstName),t.lastName&&""!==t.lastName&&(n+=""===n?t.lastName:" "+t.lastName),""===n?e.indexOf("@",0)>-1?"sip:"+e:e:n+"<"+(e.indexOf("@",0)>-1?"sip:"+e:e)+">")}function d(){L=!0}function l(t){t.call&&t.call.clearAuditTimer(),t.pendingRequestTimer&&clearTimeout(t.pendingRequestTimer),e.processEnd(t),delete N[t.id]}function u(e){h.debug("Setting notification state to BUSY for call: "+e.id),e.notificationState=F.BUSY}function f(e){h.debug("Setting notification state to IDLE for call: "+e.id),e.notificationState=F.IDLE}function p(e){return e.notificationState===F.BUSY}function E(e){if(P&&(h.debug("NOTIFICATION_QUEUE: Process completed, notification queue state changed to IDLE"),f(e),e.call.notificationQueue.size()>0)){h.debug("NOTIFICATION_QUEUE: New notification found in queue, processing it!");var t=e.call.notificationQueue.dequeue();M.onNotificationEvent(t.type,t.sessionParams)}}function S(){var e,n;if(L){L=!1;for(e in N)N.hasOwnProperty(e)&&(n=N[e],n&&t.getCurrentState(n)!==V.RINGING?(u(n),M.delegateToCallFSM(n,y.performReconnectWorkaround_JSL)):(n.call.onStateChange(w.ENDED,0),l(n)))}}function T(){var e=M.getSelectedMicrophoneId();return e&&(U.audio.optional[0].sourceId=e),U.audio}function g(e){var t,n,i,o,r=M.getSelectedCameraId();return e||(e={}),n=e.isVideoEnabled,i=e.videoQuality,o=e.videoNegotiationOnAnswer,n?(i&&"string"==typeof i&&(t=i.split("x"),isNaN(t[0])||isNaN(t[1])||(U.video.mandatory.maxWidth=t[0],U.video.mandatory.minWidth=t[0],U.video.mandatory.maxHeight=t[1],U.video.mandatory.minHeight=t[1])),r&&(U.video.optional[0].sourceId=r),U.video):!!o}function m(e){switch(e){case s.call.MediaErrors.NOT_FOUND:return s.Errors.MEDIA_NOT_FOUND;case s.call.MediaErrors.NOT_ALLOWED:return s.Errors.MEDIA_NOT_ALLOWED;case s.call.MediaErrors.INVALID_PARAMETER:return s.Errors.INVALID_PARAMETER;default:return e}}function C(e){var t={sdp:e.sdp,callerNumber:e.call.callerNumber,callerName:e.call.callerName,calleeNumber:e.call.calleeNumber,primaryContact:e.call.primaryContact,optionReject:e.call.canReject(),optionForward:e.call.canForward(),optionAnswer:e.call.canAnswer()};j.setItem(e.id,JSON.stringify(t))}function I(t,n,i,o){u(t),e.revertRtcState(t,E,E),i&&M.delegateToCallFSM(t,i),o&&o.timeout?t.pendingRequestTimer=setTimeout(function(){t.pendingRequestTimer=null,o.args.push(!0),o.handler.apply(null,o.args)},1e3*o.timeout):n&&a.callFunctionIfExist(n)}function A(e,t,n){I(e,t,y.requestFailure_JSL,n)}function _(e,t){I(e,t,y.webrtcFailure_JSL)}function D(e,t){var n=t.sessionParams;h.info("CallControl notification received "+e+" sessionData:"+n.sessionData),n.referTo&&h.info("CallControl notification received: referTo:"+n.referTo+" referredBy: "+n.referredBy),n&&M.onNotificationEvent(e,n)}var N={},h=o.getLogger("callManager"),b=3e3,L=!1,y=t.NotificationEvent,V=t.CallFSMState,M=this,P=!0,F={BUSY:0,IDLE:1},w={IN_CALL:0,ON_HOLD:1,RINGING:2,ENDED:3,REJECTED:4,OUTGOING:5,INCOMING:6,ANSWERING:7,JOINED:8,RENEGOTIATION:9,TRANSFERRED:10,ON_REMOTE_HOLD:11,CALL_IN_PROGRESS:12,EARLY_MEDIA:13,TRANSFER_FAILURE:14},k={LOCAL_HOLD:0,REMOTE_HOLD:1,BOTH_HOLD:2},U={audio:{optional:[{sourceId:""}]},video:{mandatory:{minWidth:"320",minHeight:"240",maxWidth:"320",maxHeight:"240"},optional:[{sourceId:""}]}};this.IncomingCall=function(e,t){var n,i,o=e,r=t,c=!0,d=!1,l=!1;this.notificationQueue=new a.Queue,this.onLocalStreamAdded=null,this.onStreamAdded=null,this.getRemoteVideoState=function(){return M.getRemoteVideoState(e)},this.mute=function(){var e={callid:o,mute:!0};return M.mute(e)},this.unmute=function(){var e={callid:o,mute:!1};return M.mute(e)},this.answer=function(e,t,n,i){var c={callid:o,isVideoEnabled:n,videoQuality:i};return r.answer?M.answer(c,e,t):void a.callFunctionIfExist(t,s.Errors.NOT_ALLOWED_SERVICE)},this.reject=function(e,t){var n={callid:o};return r.reject?M.reject(n,e,t):void a.callFunctionIfExist(t,s.Errors.NOT_ALLOWED_SERVICE)},this.ignore=function(e,t){var n={callid:o};return M.ignore(n,e,t)},this.forward=function(e,t,n){var i={callid:o,address:e};return r.forward?M.forward(i,t,n):void a.callFunctionIfExist(n,s.Errors.NOT_ALLOWED_SERVICE)},this.canReject=function(){return r.reject===!0},this.canForward=function(){return r.forward===!0},this.canAnswer=function(){return r.answer===!0},this.canSendVideo=function(){var e={callid:o};return M.canOriginatorSendLocalVideo(e)},this.canReceiveVideo=function(){var e={callid:o};return M.canOriginatorReceiveRemoteVideo(e)},this.getHoldState=function(){var e={callid:o};return M.getHoldStateOfCall(e)},this.getId=function(){return o},this.end=function(e,t){var n={callid:o};return M.end(n,e,t)},this.hold=function(e,t){var n={callid:o};return M.hold(n,e,t)},this.unhold=function(e,t){var n={callid:o};return M.unhold(n,e,t)},this.directTransfer=function(e,t,n){var i={callid:o,address:e};return M.directTransfer(i,t,n)},this.consultativeTransfer=function(e,t,n){var i={currentCallId:o,targetCallId:e};return M.consultativeTransfer(i,t,n)},this.videoStop=function(e,t){var n={callid:o,isVideoStart:!1};return M.videoStopStart(n,e,t)},this.videoStart=function(e,t,n){var i={callid:o,isVideoStart:!0,videoQuality:n};return M.videoStopStart(i,e,t)},this.getMediaStream=function(){return M.getMediaStream(o)},this.screenSharingStart=function(e,t,n,i){M.screenStopStart(o,e,t,n,!0,i)},this.screenSharingStop=function(e,t){M.screenStopStart(o,e,t,null,!1)},this.join=function(e,t,n,i,r){var a={callid1:o,callid2:e.getId()};return M.join(a,t,n,i,r)},this.sendDTMF=function(e){var t={callid:o,tone:e};return M.sendDTMF(t)},this.sendIntraFrame=function(){var e={callid:o};return c?M.sendIntraFrame(e):void 0},this.sendBlackFrame=function(){var e={callid:o};return M.sendBlackFrame(e)},this.refreshVideoRenderer=function(){var e={callid:o};return M.refreshVideoRenderer(e)},this.getJoin=function(){return d},this.setJoin=function(e){d=e},this.getButtonDisabler=function(){return l},this.setButtonDisabler=function(e){l=e,l&&(n=setTimeout(function(){l=!1},4e3))},this.clearBtnTimeout=function(){clearTimeout(n)},this.setAuditTimer=function(e){i=setInterval(function(){e()},O.callAuditTimer?O.callAuditTimer:3e4)},this.clearAuditTimer=function(){clearInterval(i)},this.isCallMuted=function(){var e={callid:o};return M.isCallMuted(e)},this.isVideoNegotationAvailable=function(e){var t={callid:e};return M.isVideoNegotationAvailable(t)},this.isVideoNegotiationAvailable=function(){var e={callid:o};return M.isVideoNegotiationAvailable(e)}},this.OutgoingCall=function(e){var t,n,i=e,o=!0,r=!1,s=!1;this.notificationQueue=new a.Queue,this.onLocalStreamAdded=null,this.onStreamAdded=null,this.getRemoteVideoState=function(){return M.getRemoteVideoState(e)},this.canSendVideo=function(){var e={callid:i};return M.canOriginatorSendLocalVideo(e)},this.canReceiveVideo=function(){var e={callid:i};return M.canOriginatorReceiveRemoteVideo(e)},this.getHoldState=function(){var e={callid:i};return M.getHoldStateOfCall(e)},this.getId=function(){return i},this.sendIntraFrame=function(){var e={callid:i};return o?M.sendIntraFrame(e):void 0},this.sendBlackFrame=function(){var e={callid:i};return M.sendBlackFrame(e)},this.refreshVideoRenderer=function(){var e={callid:i};return M.refreshVideoRenderer(e)},this.mute=function(){var e={callid:i,mute:!0};return M.mute(e)},this.unmute=function(){var e={callid:i,mute:!1};return M.mute(e)},this.end=function(e,t){var n={callid:i};return M.end(n,e,t)},this.hold=function(e,t){var n={callid:i};return M.hold(n,e,t)},this.unhold=function(e,t){var n={callid:i};return M.unhold(n,e,t)},this.directTransfer=function(e,t,n){var o={callid:i,address:e};return M.directTransfer(o,t,n)},this.consultativeTransfer=function(e,t,n){var o={currentCallId:i,targetCallId:e};return M.consultativeTransfer(o,t,n)},this.videoStop=function(e,t){var n={callid:i,isVideoStart:!1};return M.videoStopStart(n,e,t)},this.videoStart=function(e,t,n){var o={callid:i,isVideoStart:!0,videoQuality:n};return M.videoStopStart(o,e,t)},this.getMediaStream=function(){return M.getMediaStream(i)},this.screenSharingStart=function(e,t,n,o){M.screenStopStart(i,e,t,n,!0,o);
},this.screenSharingStop=function(e,t){M.screenStopStart(i,e,t,null,!1)},this.join=function(e,t,n,o,r){var a={callid1:i,callid2:e.getId()};return M.join(a,t,n,o,r)},this.sendDTMF=function(e){var t={callid:i,tone:e};return M.sendDTMF(t)},this.getJoin=function(){return r},this.setJoin=function(e){r=e},this.getButtonDisabler=function(){return s},this.setButtonDisabler=function(e){s=e,s&&(t=setTimeout(function(){s=!1},4e3))},this.clearBtnTimeout=function(){clearTimeout(t)},this.setAuditTimer=function(e){n=setInterval(function(){e()},O.callAuditTimer?O.callAuditTimer:3e4)},this.clearAuditTimer=function(){clearInterval(n)},this.isCallMuted=function(){var e={callid:i};return M.isCallMuted(e)},this.isVideoNegotationAvailable=function(e){var t={callid:e};return M.isVideoNegotationAvailable(t)},this.isVideoNegotiationAvailable=function(){var e={callid:i};return M.isVideoNegotiationAvailable(e)}},M.consultativeTransfer=function(e,i,o){var r,s,c=N[e.currentCallId],d=N[e.targetCallId];c.targetCallId=e.targetCallId,d.callerNumber?c.targetAddress=d.callerNumber:c.targetAddress=d.call.callerNumber,r=t.getCurrentState(c),s=t.getCurrentState(d),r!==V.LOCAL_HOLD&&r!==V.BOTH_HOLD||s!==V.LOCAL_HOLD&&s!==V.BOTH_HOLD?r===V.LOCAL_HOLDING||s===V.LOCAL_HOLDING?c.transferTrigger?a.callFunctionIfExist(o,R.Errors.STATE):c.transferTrigger=function(){M.consultativeTransfer(e,i,o)}:(h.error("Cannot consultative transfer in INIT callstate :"+R.Errors.STATE),a.callFunctionIfExist(o,R.Errors.STATE)):n.transfer(c.id,c.targetAddress,c.targetCallId,function(){h.info("consultative transfer successful. callId: "+c.id),M.delegateToCallFSM(c,y.consultativeTransfer_GUI),a.callFunctionIfExist(i)},function(e){h.error("consultative transfer failed. callId: "+c.id),a.callFunctionIfExist(o,e)})},M.CALL_STATES=w,M.CALL_HOLD_STATES=k,M.initMedia=function(t,n,i){e.initMedia(function(){a.callFunctionIfExist(n)},function(e){a.callFunctionIfExist(i,e)},t.options)},M.set_logSeverityLevel=function(t){e.set_logSeverityLevel(t.level)},M.enable_logCallback=function(){e.enable_logCallback()},M.disable_logCallback=function(){e.disable_logCallback()},M.get_audioInDeviceCount=function(){return e.get_audioInDeviceCount()},M.get_audioOutDeviceCount=function(){return e.get_audioOutDeviceCount()},M.get_videoDeviceCount=function(){return e.get_videoDeviceCount()},M.getUserMedia=function(t,n,i){if(t.privateStream){var o=T(),r=g({isVideoEnabled:!0});t.options&&(void 0!==t.options.audio&&(o=t.options.audio),void 0!==t.options.video&&(r=t.options.video)),e.privateGetUserMedia(n,function(e){a.callFunctionIfExist(i,m(e))},{audio:o,video:r,privateStream:!0})}else e.getUserMedia(n,function(e){a.callFunctionIfExist(i,m(e))},t.options)},M.showSettingsWindow=function(t,n,i){e.showSettingsWindow(function(){a.callFunctionIfExist(n)},function(e){a.callFunctionIfExist(i,e)},t.options)},M.createStreamRenderer=function(t){return e.createStreamRenderer(t.streamId,t.container,t.options)},M.disposeStreamRenderer=function(t){e.disposeStreamRenderer(t.container)},M.isPluginEnabled=function(){return e.isPluginEnabled()},M.hasGotCalls=function(){var e,n;for(e in N)if(N.hasOwnProperty(e)&&(n=N[e]))return h.info("has got call - id: "+e+" - state: "+t.getCurrentState(n)),!0;return!1},M.getCalls=function(){return N},M.sendIntraFrame=function(t){var n=N[t.callid];n&&e.sendIntraFrame(n)},M.sendBlackFrame=function(t){var n=N[t.callid];n&&e.sendBlackFrame(n)},M.delegateToCallFSM=function(e,n){t.handleEvent(e,n,M.onStateChange)},M.answer=function(i,o,r){var c=N[i.callid],d=M.isVideoNegotiationAvailable(i),l={options:{audio:T(),video:g({isVideoEnabled:i.isVideoEnabled,videoQuality:i.videoQuality,videoNegotiationOnAnswer:d})}};if(c){if(d===!1&&i.isVideoEnabled===!0)return h.error("[callManager.answer] Video Session Not Available Error "),void a.callFunctionIfExist(r,s.Errors.VIDEO_SESSION_NOT_AVAILABLE);c.sdp?t.getCurrentState(c)!==V.RINGING?a.callFunctionIfExist(r,s.Errors.STATE):M.getUserMedia(l,function(t){c.isVideoSourceAllowed=t.video,c.isVideoEnabled=i.isVideoEnabled,e.storeLocalStreamToCall(c,t.id),e.createAnswer(c,function(t){h.info("[callManager.answer : sdp ]"+t),M.delegateToCallFSM(c,y.answer_GUI),n.answerCall(c.id,t,function(){a.callFunctionIfExist(o),e.addLocalStream(c)},function(e){a.callFunctionIfExist(r,e)})},function(e){h.error("[callManager.answer] Error : "+e),M.delegateToCallFSM(c,y.end_GUI)},i.isVideoEnabled)},function(e){a.callFunctionIfExist(r,e)}):t.getCurrentState(c)!==V.RINGING_SLOW?a.callFunctionIfExist(r,s.Errors.STATE):M.getUserMedia(l,function(t){c.isVideoSourceAllowed=t.video,c.isVideoEnabled=i.isVideoEnabled,e.storeLocalStreamToCall(c,t.id),e.createOffer(c,function(e){c.sdp=e,M.delegateToCallFSM(c,y.answer_GUI),n.answerCall(c.id,e,function(){a.callFunctionIfExist(o)},function(e){a.callFunctionIfExist(r,e)})},function(e){h.error("[callManager.offer] Error : "+e),M.delegateToCallFSM(c,y.end_GUI)},i.isVideoEnabled)},function(e){a.callFunctionIfExist(r,e)})}},M.getIncomingCallById=function(e){var t,n,o=null;return t=JSON.parse(j.getItem(e.callid)),t&&(o=new M.IncomingCall(e.callid,{reject:t.optionReject,forward:t.optionForward,answer:t.optionAnswer}),o.canOrigReceiveVideo=i.isSdpHasVideo(t.sdp),o.callerNumber=t.callerNumber,o.callerName=t.callerName,o.calleeNumber=t.calleeNumber,o.primaryContact=t.primaryContact,n={call:o,sdp:t.sdp,id:e.callid},N[e.callid]=n,M.delegateToCallFSM(n,y.callNotify)),o},M.start=function(t,i,o){var r={},s={options:{audio:T(),video:g({isVideoEnabled:t.isVideoEnabled,videoQuality:t.videoQuality})}};h.info("start call... from: "+t.from+" contact: "+JSON.stringify(t.contact)+" to: "+t.to+" isVideoEnabled: "+t.isVideoEnabled+" sendInitialVideo: "+t.sendInitialVideo+" videoQuality: "+t.videoQuality),M.getUserMedia(s,function(s){r.isVideoSourceAllowed=s.video,r.isVideoEnabled=t.isVideoEnabled,e.storeLocalStreamToCall(r,s.id),e.createOffer(r,function(s){h.info("[callManager.start : sdp ]"+s),r.sdp=s,n.startCall(c(t.from,t.contact),c(t.to),s,function(n){r.call=new M.OutgoingCall(n),r.id=n,r.callerNumber=t.to,M.delegateToCallFSM(r,y.callStart_GUI),N[n]=r,setTimeout(function(){e.addLocalStream(r)},10),a.callFunctionIfExist(i,r.call)},function(e){a.callFunctionIfExist(o,e)})},function(e){h.error("[callManager.start] Error : "+e),a.callFunctionIfExist(o,e)},t.sendInitialVideo)},function(e){a.callFunctionIfExist(o,e)})},M.reject=function(e,t,i){var o=N[e.callid];return o?void n.reject(e.callid,function(){M.delegateToCallFSM(o,y.end_GUI),a.callFunctionIfExist(t)},function(e){a.callFunctionIfExist(i,e)}):void a.callFunctionIfExist(i,s.Errors.STATE)},M.ignore=function(e,t,n){var i=N[e.callid];return i?(M.delegateToCallFSM(i,y.end_GUI),void a.callFunctionIfExist(t)):void a.callFunctionIfExist(n,s.Errors.STATE)},M.forward=function(e,t,i){var o=N[e.callid];return o?void n.forward(e.callid,e.address,function(){M.delegateToCallFSM(o,y.forward_GUI),a.callFunctionIfExist(t)},function(e){a.callFunctionIfExist(i,e)}):void a.callFunctionIfExist(i,s.Errors.STATE)},M.getMediaStream=function(e){var t=N[e];return t.localMedia.originalStream},M.hold=function(i,o,r,c){var d,l=N[i.callid];return l?p(l)?void(c?a.callFunctionIfExist(r,s.Errors.NETWORK):a.callFunctionIfExist(r,s.Errors.STATE)):(d=t.getCurrentState(l),d!==V.COMPLETED&&d!==V.REMOTE_HOLD?void(c?a.callFunctionIfExist(r,s.Errors.NETWORK):a.callFunctionIfExist(r,s.Errors.STATE)):l.pendingRequestTimer?void a.callFunctionIfExist(r,s.Errors.PENDING_REQUEST):(l.lastUpdateRequest={handler:M.hold,args:[i,o,r]},u(l),M.delegateToCallFSM(l,y.hold_GUI),void e.createHoldUpdate(l,!0,d===V.REMOTE_HOLD,function(e){h.debug("[callManager.hold->createHoldUpdate : sdp ]"+e),n.hold(l.id,e,function(){f(l),a.callFunctionIfExist(o)},function(e){A(l,r,{handler:M.hold,args:[i,o,r],timeout:e.retryAfter})})},function(){_(l,r)}))):void a.callFunctionIfExist(r,s.Errors.STATE)},M.unhold=function(i,o,r,c){var d,l=N[i.callid];return l?p(l)?void(c?a.callFunctionIfExist(r,s.Errors.NETWORK):a.callFunctionIfExist(r,s.Errors.STATE)):(d=t.getCurrentState(l),d!==V.LOCAL_HOLD&&d!==V.BOTH_HOLD?void(c?a.callFunctionIfExist(r,s.Errors.NETWORK):a.callFunctionIfExist(r,s.Errors.STATE)):l.pendingRequestTimer?void a.callFunctionIfExist(r,s.Errors.PENDING_REQUEST):(l.lastUpdateRequest={handler:M.unhold,args:[i,o,r]},u(l),M.delegateToCallFSM(l,y.unhold_GUI),void e.createHoldUpdate(l,!1,d===V.BOTH_HOLD,function(t){h.debug("[callManager.unhold->createHoldUpdate : sdp ]"+t),n.unhold(l.id,t,function(){f(l),e.addLocalStream(l),a.callFunctionIfExist(o)},function(e){A(l,r,{handler:M.unhold,args:[i,o,r],timeout:e.retryAfter})})},function(){_(l,r)}))):void a.callFunctionIfExist(r,s.Errors.STATE)},M.directTransfer=function(e,i,o){var r,d=N[e.callid];return d?(r=t.getCurrentState(d),void(r===V.LOCAL_HOLD||r===V.BOTH_HOLD?(h.info("[callManager.directTransfer->sendTransfer : transfer target ]"+e.address),n.transfer(d.id,c(e.address),void 0,function(){M.delegateToCallFSM(d,y.transfering),a.callFunctionIfExist(i),h.info("[callManager.directTransfer->sentTransfer : transfer target ]"+e.address)},function(e){a.callFunctionIfExist(o,e)})):r===V.LOCAL_HOLDING?d.transferTrigger||(d.transferTrigger=function(){M.directTransfer(e,function(){a.callFunctionIfExist(i)},function(e){a.callFunctionIfExist(o,e)})}):(h.error("directTransfer call is not in correct state: "+r),q.callFunctionIfExist(o,R.Errors.STATE)))):void a.callFunctionIfExist(o,s.Errors.STATE)},M.videoUpdate=function(t,i,o){var r,s=N[t];return s?(r=s.isVideoEnabled||s.isScreenShared,s.lastUpdateRequest={handler:M.videoUpdate,args:[t,i,o]},u(s),M.delegateToCallFSM(s,y.videoStopStart_GUI),void e.createUpdate(s,function(r){n.reinvite(s.id,r,function(){f(s),e.addLocalStream(s),a.callFunctionIfExist(i)},function(e){A(s,o,{handler:M.videoUpdate,args:[t,i,o],timeout:e.retryAfter})})},function(){h.error("reinvite->createUpdate "),_(s,o)},r)):void q.callFunctionIfExist(o,R.Errors.STATE)},M.videoStopStart=function(n,i,o,r){var c,d=N[n.callid],l={options:{audio:T(),video:g({isVideoEnabled:!0,videoQuality:n.videoQuality})}};return d?p(d)?void a.callFunctionIfExist(o,s.Errors.STATE):(c=t.getCurrentState(d),c!==V.COMPLETED?void a.callFunctionIfExist(o,s.Errors.STATE):d.pendingRequestTimer?void a.callFunctionIfExist(o,s.Errors.PENDING_REQUEST):void(!d.isVideoSourceAllowed&&n.isVideoStart?M.getUserMedia(l,function(t){d.isVideoSourceAllowed=!0,d.isVideoEnabled=!0,e.storeLocalStreamToCall(d,t.id),d.isScreenShared||M.videoUpdate(n.callid,i,o)},function(e){a.callFunctionIfExist(o,e)}):(d.isVideoEnabled=n.isVideoStart,d.isScreenShared||M.videoUpdate(n.callid,i,o)))):void a.callFunctionIfExist(o,s.Errors.STATE)},M.screenStopStart=function(n,i,o,r,a,s){var c,d=N[n];if(!d)return void q.callFunctionIfExist(o,R.Errors.STATE);if(p(d))return void q.callFunctionIfExist(o,R.Errors.STATE);if(c=t.getCurrentState(d),c!==V.COMPLETED)return void q.callFunctionIfExist(o,R.Errors.STATE);if(d.pendingRequestTimer)return void q.callFunctionIfExist(o,R.Errors.PENDING_REQUEST);if(a){if(d.isStartingScreenMedia)return void q.callFunctionIfExist(o);d.isStartingScreenMedia=!0,e.startScreenMedia(function(t){d.isScreenShared=!0,d.isStartingScreenMedia=!1,e.updateLocalStreamToCall(d,t.id),M.videoUpdate(n,i,o)},function(){d.isScreenShared=!1,d.isStartingScreenMedia=!1,q.callFunctionIfExist(o)},s,function(){t.getCurrentState(d)===V.COMPLETED?M.screenStopStart(n,r,function(){h.error("Failed to stop screen properly after user stopped the stream via the browser controls")},!1):d.isScreenShared&&(d.isScreenShared=!1,e.stopScreenMedia(),q.callFunctionIfExist(r))})}else d.isScreenShared&&(d.isScreenShared=!1,e.stopScreenMedia(),M.videoUpdate(n,i,o))},M.mute=function(t){var n=N[t.callid];n&&e.muteAudioTrack(n,t.mute)},M.sendDTMF=function(t){var n=N[t.callid];n&&e.sendDTMF(n,t.tone)},M.join=function(i,o,r,c,d){var l,u,f=N[i.callid1],p=N[i.callid2],E={},S={options:{audio:T(),video:g({isVideoEnabled:c,videoQuality:d})}};if(f&&p){if(l=t.getCurrentState(f),u=t.getCurrentState(p),l===V.LOCAL_HOLDING||u===V.LOCAL_HOLDING)return void a.callFunctionIfExist(r,s.Errors.PENDING_REQUEST);l!==V.LOCAL_HOLD&&l!==V.REMOTE_HOLD&&l!==V.BOTH_HOLD||u!==V.LOCAL_HOLD&&u!==V.REMOTE_HOLD&&u!==V.BOTH_HOLD?a.callFunctionIfExist(r,s.Errors.STATE):M.getUserMedia(S,function(t){E.isVideoSourceAllowed=t.video,e.storeLocalStreamToCall(E,t.id),e.createOffer(E,function(e){h.info("join->doOffer : sdp "+e),E.sdp=e,n.join(f.id,p.id,e,function(e){E.call=new M.OutgoingCall(e),E.id=e,E.firstInternalCallId=f.id,E.secondInternalCallId=p.id,"true"===O.clientControlled&&(E.isReferer=!0,E.refer1ID=f.id,E.refer2ID=p.id),M.delegateToCallFSM(f,y.joining_Notify),M.delegateToCallFSM(p,y.joining_Notify),M.delegateToCallFSM(E,y.joiningSuccess_Notify),N[e]=E,a.callFunctionIfExist(o,E.call)},function(t){h.error("callControlService.join Failed!! sdp "+e),a.callFunctionIfExist(r,t)})},function(e){h.error("doOffer Failed!!"),a.callFunctionIfExist(r,e)},c)},function(e){a.callFunctionIfExist(r,e)})}},M.transfer=function(){},M.end=function(e,n){var i=N[e.callid];i&&(t.getCurrentState(i)===V.INIT?h.error("Cannot end call in INIT callstate :"+s.Errors.STATE):(M.delegateToCallFSM(i,y.end_GUI),l(i),a.callFunctionIfExist(n)))},M.clickToCall=function(e,t,i){n.clickToCall(e.callingParty,e.calledParty,function(){a.callFunctionIfExist(t)},function(e){a.callFunctionIfExist(i,e)})},M.getIMRN=function(e,t,i){n.getIMRN(e.realm,e.source,e.destination,function(){a.callFunctionIfExist(t)},function(e){a.callFunctionIfExist(i,e)})},M.cerateIncomingCallInFSM=function(e,t){h.info("incomingCall : sdp = "+t);var n={call:e,sdp:t,id:e.getId()};h.info("incomingCall: "+e.getId()),O.continuity&&e.canAnswer()&&C(n),N[e.getId()]=n,M.delegateToCallFSM(n,y.callNotify)},M.updateCall=function(){},M.onNotificationEvent=function(e,t){var n=t.sessionData,o=t.statusCode,r=t.reasonText,a=t.sdp,s=t.referTo,c=t.referredBy,d=t.retryAfter,l=N[n];if(h.debug("Notification received "+e+" callid:"+n),h.debug("onNotificationEvent : sdp "+a),l){if(P&&p(l)&&e!==y.callEnd_Notify&&e!==y.callCancel_Notify)return h.debug("NOTIFICATION_QUEUE: notification state is busy, adding process to the queue!"),l.call.notificationQueue.enqueue({type:e,sessionParams:t}),void h.debug("NOTIFICATION_QUEUE: queue size is now "+l.call.notificationQueue.size());P&&u(l),a&&(l.prevRemoteSdp=l.sdp,a=i.deleteGoogleIceFromSdp(a),l.sdp=a),s&&c&&(l.referTo=s,l.referredBy=c),l.retryAfter=d,l.statusCode=o,l.reasonText=r}M.delegateToCallFSM(l,e)},M.onStateChange=function(i,o){function r(e,t){h.debug("triggerCallState:  state =   "+e+"    call.statusCode =  "+i.statusCode+"   call.reasonText =  "+i.reasonText),i.call.callState=e,a.callFunctionIfExist(i.call.onStateChange,e,i.statusCode,i.reasonText),t||E(i)}function c(e){r(e,!0)}var d,u,p,S,T,g,m,C=w,R=t.TransferEvent;switch(N[i.id]=i,S=function(){setTimeout(function(){s.isConnected()&&n.audit(i.id,function(){h.info("Audit kicked off: Success for: "+i.id)},function(){h.error("Audit: Fail for: "+i.id)})},b)},T=function(){i.call.setAuditTimer(function(){s.isConnected()&&n.audit(i.id,function(){h.info("Audit: Success for: "+i.id)},function(){h.error("Audit: Fail for: "+i.id),E(i)})})},h.info("Transfer Event: "+o+". callId: "+i.id),o){case R.callStart_fsm:case R.localHolding_fsm:case R.localUnHolding_fsm:case R.localVideoStopStart_fsm:case R.slowStartOfferProcessed_fsm:case R.joiningSuccess_fsm:break;case R.ignoredNotification_fsm:case R.answeringRingingSlow_fsm:case R.localHold_fsm:case R.localUnHold_fsm:case R.answerRingingSlow_fsm:E(i);break;case R.transfering_fsm:E(i);break;case R.ringing_fsm:r(C.RINGING);break;case R.callReceived_fsm:i.sdp||M.delegateToCallFSM(i,y.callNotify_noSDP),r(C.INCOMING);break;case R.answer_fsm:S(),T(),r(C.IN_CALL);break;case R.reject_GUI:case R.forward_fsm:l(i);break;case R.sessionComplete_fsm:n.endCall(i.id,function(){h.info("callControlService.endCall successful. callId: "+i.id)},function(){h.error("callControlService.endCall FAILED!!.callId: "+i.id)}),l(i),r(C.JOINED);break;case R.sessionFail_fsm:case R.transferFail_fsm:r(C.TRANSFER_FAILURE);break;case R.callCompleted_fsm:if(e.isDtlsEnabled()&&i.peer.signalingState===v.WEBRTC.RTC_SIGNALING_STATE.STABLE){h.info("Handle answer sdp after session progress when dtls is enabled. Create new peer workaround."),M.delegateToCallFSM(i,y.performCreateNewPeerWorkaround_JSL);break}if(S(),e.processAnswer(i,function(){T(),r(C.IN_CALL)},function(e){e===v.WEBRTC.ERROR.ICE_ICELITE?(h.info("ice-lite - ice change. Create new peer workaround."),M.delegateToCallFSM(i,y.performCreateNewPeerWorkaround_JSL)):(l(i),r(C.ENDED))}),i.isReferer)for(d in N)N.hasOwnProperty(d)&&(!N[d]||N[d].id!==i.refer1ID&&N[d].id!==i.refer2ID||N[d].referCall(i.referTo,i.referredBy));break;case R.noAnswer_fsm:case R.remoteEnd_fsm:i.firstInternalCallId&&i.secondInternalCallId&&(g=N[i.firstInternalCallId],M.delegateToCallFSM(g,y.revertState_JSL),m=N[i.secondInternalCallId],M.delegateToCallFSM(m,y.revertState_JSL)),l(i),r(C.ENDED);break;case R.localEnd_fsm:n.endCall(i.id,function(){h.info("CallControlService endCall successful. callId: "+i.id)},function(){h.error("Cannot callControlService endCall. callId: "+i.id)});break;case R.callCompletedAnswering_fsm:h.info("callManager: Call Completed Answering Event. callId: "+i.id),e.processAnswer(i,function(){r(C.IN_CALL),S(),T()},function(){l(i),r(C.ENDED)});break;case R.remoteHold_fsm:switch(t.getCurrentState(i)){case V.REMOTE_HOLD:r(C.ON_REMOTE_HOLD);break;case V.BOTH_HOLD:r(C.ON_HOLD);break;default:E(i)}break;case R.remoteUnHold_fsm:switch(t.getCurrentState(i)){case V.LOCAL_HOLD:r(C.ON_HOLD);break;case V.COMPLETED:r(C.IN_CALL);break;default:E(i)}break;case R.remoteHolding_fsm:p=t.getCurrentState(i)===V.LOCAL_HOLD||t.getCurrentState(i)===V.BOTH_HOLD,e.processHold(i,!0,p,function(e){h.info("[callManager.onStateChange.transferEvent.remoteHold_fsm->processHold : sdp ]"+e),n.respondCallUpdate(i.id,e,function(){h.info("Remote Hold Transfer Event Successful. callId: "+i.id),M.delegateToCallFSM(i,y.remoteHoldProcessed_JSL)},function(e){h.error("Remote Hold Transfer Event FAILED!! - "+e),A(i)})},function(e){h.error("Remote Hold FAILED!! - "+e),_(i)});break;case R.remoteOfferDuringLocalHold_fsm:e.processRemoteOfferOnLocalHold(i,function(e){h.info("onStateChange.transferEvent.remoteOfferDuringLocalHold_fsm : sdp "+e),n.respondCallUpdate(i.id,e,function(){h.info("Remote Offer During Local Hold Transfer Event successful. callId: "+i.id),E(i)},function(e){A(i),h.error("Remote Offer During Local Hold  Transfer Event FAILED!! - "+e)})},function(e){h.error("Remote Offer During Local Hold FAILED!! - "+e),_(i)});break;case R.slowStartOfferDuringOnCall_fsm:case R.slowStartOfferDuringRemoteHold_fsm:e.createReOffer(i,function(e){h.info("onStateChange.transferEvent.createReOffer: sdp "+e),n.respondCallUpdate(i.id,e,function(){h.info("Slow Start Offer respondCallUpdate successful. callId: "+i.id),M.delegateToCallFSM(i,y.slowStartOfferProcessed_JSL),E(i)},function(e){h.error("Slow Start Offer respondCallUpdate FAILED!! - "+e),A(i)})},function(e){h.error("Slow Start Offer createReOffer FAILED!! - "+e),_(i)});break;case R.performReconnectWorkaround_fsm:e.createReOffer(i,function(t){h.info("onStateChange.transferEvent.createReOffer : sdp "+t),n.reinvite(i.id,t,function(){f(i),e.addLocalStream(i),h.info("callControlService.reinvite successful. callId: "+i.id)},function(){M.delegateToCallFSM(i,y.requestFailure_JSL)})},function(){_(i)},!0);break;case R.performCreateNewPeerWorkaround_fsm:h.info("performCreateNewPeerWorkaround_fsm"),e.createReOffer(i,function(t){h.info("createReOfferSuccessCallback: sdp "+t),n.reinvite(i.id,t,function(){h.info("reInviteSuccessCallback."),e.addLocalStream(i),T(),E(i)},function(){h.info("reInviteFailureCallback."),M.end({callid:i.id},function(){h.info("end success."),l(i),r(C.ENDED)})})},function(){M.end({callid:i.id},function(){h.info("end success."),l(i),r(C.ENDED)})},!0);break;case R.remoteUnHolding_fsm:p=i.previousState===V.LOCAL_HOLD||i.previousState===V.BOTH_HOLD,e.processHold(i,!1,p,function(e){h.info("onStateChange.transferEvent.remoteUnHold_fsm->processHold : sdp "+e),n.respondCallUpdate(i.id,e,function(){h.info("Remote UnHold Transfer Event successful. callId: "+i.id),M.delegateToCallFSM(i,y.remoteUnHoldProcessed_JSL)},function(e){h.error("Remote UnHold Transfer Event FAILED!! - "+e),A(i)})},function(e){h.error("Remote UnHold FAILED!! - "+e),_(i)});break;case R.renegotiationCompleted_fsm:r(C.RENEGOTIATION);break;case R.remoteOffer_fsm:case R.remoteCallUpdate_fsm:e.processUpdate(i,function(e){h.info("onStateChange.transferEvent.remoteCallUpdate_fsm->processUpdate : sdp "+e),n.respondCallUpdate(i.id,e,function(){h.info("Remote Call Update Transfer Event Successful. callId: "+i.id),M.delegateToCallFSM(i,y.remoteOfferProcessed_JSL)},function(e){h.error("Remote Call Update Transfer Event FAILED!! - "+e),A(i)})},function(e){h.error("Remote Call Update FAILED!! - "+e),_(i)},i.currentState===V.LOCAL_HOLD);break;case R.respondCallHoldUpdate_fsm:u=i.call.getJoin(),e.processHoldRespond(i,function(){switch(h.info("Respond Call Hold Update Event Successful. callId: "+i.id),t.getCurrentState(i)){case V.REMOTE_HOLD:r(C.ON_REMOTE_HOLD);break;case V.LOCAL_HOLD:case V.BOTH_HOLD:r(C.ON_HOLD),"function"==typeof i.transferTrigger&&i.transferTrigger();break;case V.COMPLETED:r(C.IN_CALL)}},function(e){h.error("Respond Call Hold Update Event FAILED: "+e),E(i)},u),i.call.setButtonDisabler(!1),i.call.clearBtnTimeout(),u===!0&&i.call.onJoin();break;case R.respondCallUpdate_fsm:u=i.call.getJoin(),i.call.setButtonDisabler(!1),i.call.clearBtnTimeout(),u===!0?(e.processRespond(i,function(){h.info("Respond Call Update Event Successful. callId: "+i.id),r(C.RENEGOTIATION)},function(e){h.error("Respond Call Update Event FAILED: "+e),E(i)},u),i.call.onJoin()):e.processRespond(i,function(){switch(h.info("Respond Call Update Event Successful. callId: "+i.id),t.getCurrentState(i)){case V.REMOTE_HOLD:r(C.ON_REMOTE_HOLD);break;case V.BOTH_HOLD:r(C.ON_HOLD);break;case V.LOCAL_HOLD:r(C.ON_HOLD);break;case V.COMPLETED:r(C.IN_CALL)}},function(e){h.error("Respond Call Update Event FAILED: "+e),E(i)},u);break;case R.remotePranswer_fsm:e.isDtlsEnabled()?i.peer.signalingState===v.WEBRTC.RTC_SIGNALING_STATE.STABLE?(h.info("Only first sessionProgress notification is processed, so ignoring this one."),E(i)):e.processAnswer(i,function(){r(C.EARLY_MEDIA)},function(e){h.error("Process answer for session progress FAILED: "+e),E(i)}):e.processPreAnswer(i,function(){r(C.EARLY_MEDIA)},function(e){h.error("Process pranswer FAILED: "+e),E(i)});break;case R.joining_fsm:"true"===O.clientControlled&&(i.referCall=function(e,t){n.refer(i.id,e,t,function(){h.info("Joining Event Successful. callId: "+i.id),M.delegateToCallFSM(i,y.refer_JSL)},function(e){h.error("Joining Event FAILED!!"+e)})}),E(i);break;case R.transferSuccess_fsm:n.endCall(i.id,function(){h.info("callControlService.endCall successful. callId: "+i.id)},function(){h.error("callControlService.endCall FAILED!! callId: "+i.id)}),l(i),r(C.TRANSFERRED),h.info("endCall successful. callId: "+i.id);break;case R.stateReverted_fsm:switch(i.call.setButtonDisabler(!1),i.call.clearBtnTimeout(),t.getCurrentState(i)){case V.REMOTE_HOLD:c(C.ON_REMOTE_HOLD);break;case V.BOTH_HOLD:c(C.ON_HOLD);break;case V.LOCAL_HOLD:c(C.ON_HOLD);break;case V.COMPLETED:c(C.IN_CALL);break;default:h.error("CANNOT REVERT THE STATE: "+t.getCurrentState(i)+". callId: "+i.id)}break;case R.glareCondition_fsm:I(i,null,null,{handler:i.lastUpdateRequest.handler,args:i.lastUpdateRequest.args,timeout:i.retryAfter});break;default:h.error("Undefined transition event: "+o+" for "+i.id),E(i)}},M.refreshVideoRenderer=function(t){var n=N[t.callid];n&&e.refreshVideoRenderer(n)},M.hasVideoDevice=function(){return e.isVideoSourceAvailable()},M.hasAudioDevice=function(){return e.isAudioSourceAvailable()},M.hasScreenSharing=function(){return e.isScreenSourceAvailable()},M.getLocalVideoResolutions=function(){return e.getLocalVideoResolutions()},M.getRemoteVideoResolutions=function(){return e.getRemoteVideoResolutions()},M.isCallMuted=function(t){return e.isAudioMuted(N[t.callid])},M.isVideoNegotationAvailable=function(e){var t=N[e.callid];return t.sdp?i.isSdpHasVideo(t.sdp):!1},M.isVideoNegotiationAvailable=function(e){var t=N[e.callid];return t.sdp?i.isSdpHasVideo(t.sdp):!1},M.getRemoteVideoState=function(e){var t=N[e];return t.remoteVideoState},M.getHoldStateOfCall=function(e){var n=N[e.callid];return n?k[t.getCurrentState(n)]:void 0},M.canOriginatorSendLocalVideo=function(t){var n=N[t.callid];return n?e.canOriginatorSendLocalVideo(n):!1},M.canOriginatorReceiveRemoteVideo=function(t){var n=N[t.callid];return n?e.canOriginatorReceiveRemoteVideo(n):!1},M.getStreamById=function(t){return e.getStreamById(t.streamId)},M.removeStreamById=function(t){e.removeStreamById(t.streamId)},M.setSelectedMicrophoneId=function(t){e.setSelectedMicrophoneId(t.microphoneId)},M.setSelectedSpeakerId=function(t){e.setSelectedSpeakerId(t.speakerId)},M.setSelectedCameraId=function(t){e.setSelectedCameraId(t.cameraId)},M.getSelectedMicrophoneId=function(){return e.getSelectedMicrophoneId()},M.getSelectedSpeakerId=function(){return e.getSelectedSpeakerId()},M.getSelectedCameraId=function(){return e.getSelectedCameraId()},M.getCameraList=function(t){e.getCameraList(function(e){a.callFunctionIfExist(t.onSuccess,e)})},M.getMicrophoneList=function(t){e.getMicrophoneList(function(e){a.callFunctionIfExist(t.onSuccess,e)})},M.getSpeakerList=function(t){e.getSpeakerList(function(e){a.callFunctionIfExist(t.onSuccess,e)})},Ge.call=function(e){if(!s.notification.isAnonymous()){var t,n,i,o,r=null,c=null,d={},l=e.callNotificationParams,u=e.callDispositionParams,f=e.sessionParams;if(i=f?f:u?u:null,h.info("params: "+i),i){if(n=i.actions,h.info("actions: "+n),i.sessionData){if(c=i.sessionData,o=M.getCalls(),void 0!==o[c])return void h.info("call already exists: "+c);h.info("sessionData: "+c)}n&&(d.reject=n.indexOf("reject",0)>-1,d.forward=n.indexOf("forward",0)>-1,d.answer=n.indexOf("answer",0)>-1),i.sdp&&(t=i.sdp)}r=new M.IncomingCall(c,d),r.callerNumber=a.getProperty(l,"callerDisplayNumber"),r.callerName=a.getProperty(l,"callerName"),r.calleeNumber=a.getProperty(l,"calleeDisplayNumber"),r.primaryContact=a.getProperty(l,"primaryContact"),r.primaryContact&&(r.primaryContact=r.primaryContact.split(";")[0]),M.cerateIncomingCallInFSM(r,t),a.callFunctionIfExist(s.call.onReceived,r)}},Ge.ringing=function(e){D(y.ringing_Notify,e)},Ge.sessionProgress=function(e){""!==e.sessionParams.sdp?D(y.sessionProgress,e):h.info("Warning: SDP of sessionProgress is empty.")},Ge.startCallUpdate=function(e){var t=e.sessionParams.sdp,n=y.startCallUpdate_slowStart_Notify,o=e.sessionParams.sessionData,r=e.callNotificationParams,a=N[o],s={RemoteDisplayName:"",RemoteDisplayNumber:""};t&&(i.init(t),n=i.isRemoteHold()?y.startCallUpdate_remoteHold_Notify:y.startCallUpdate_remoteOffer_Notify),a&&(a.remoteDisplayNumber||(a.remoteDisplayNumber=q.getProperty(r,"callerDisplayNumber")),a.remoteDisplayNumber!==q.getProperty(r,"callerDisplayNumber")&&(a.remoteDisplayNumber=q.getProperty(r,"callerDisplayNumber"),s.RemoteDisplayName=q.getProperty(r,"callerName"),s.RemoteDisplayNumber=q.getProperty(r,"callerDisplayNumber"),q.callFunctionIfExist(R.call.onRemoteEndPointChange,s))),D(n,e)},Ge.respondCallUpdate=function(e){e.sessionParams&&e.sessionParams.retryAfter?D(y.respondCallUpdate_glareCondition_Notify,e):D(y.respondCallUpdate_Notify,e)},Ge.sessionComplete=function(e){D(y.sessionComplete_Notify,e)},Ge.sessionFail=function(e){D(y.sessionFail_Notify,e)},Ge.callEnd=function(e){D(y.callEnd_Notify,e)},Ge.trying=function(e){D(y.trying_Notify,e)},Ge.callCancel=function(e){D(y.callCancel_Notify,e)},Ge.accepted=function(e){D(y.accepted_Notify,e)},r.subscribe(v.EVENT.DEVICE_SUBSCRIPTION_STARTED,S),r.subscribe(v.EVENT.CONNECTION_REESTABLISHED,d),r.subscribe(v.EVENT.NOTIFICATION_CHANNEL_LOST,d)},rt=function(e,t,n,i,o,r,a,s){return new ot(e||Ne,t||et,n||it,i||Z,o||B,r||I,a||q,s||R)},at=new rt;a("call","spidr",at),g&&(g.CallManager=rt),g&&(g.OutgoingCall=at.OutgoingCall),g&&(g.callManagerService=at);var st=function(e,t){var n="/collaboration/";this.retrieve=function(i,o,r,a){e.sendGetRequest({url:t(1,n+i)},r,a,o,void 0,"collaborationResponse")}},ct=function(e,t){return new st(e||b,t||T)},dt=new ct,lt=function(e,t){this.retrieveWebCollaborationHostUrl=function(n,i){e.retrieve("webcollaborationhosturl",function(e){return t.getProperty(e.collaborationResponse,"webCollaborationHostURL")},n,i)},this.retrieveVideoCollaborationHostUrl=function(n,i){e.retrieve("videocollaborationhosturl",function(e){return t.getProperty(e.collaborationResponse,"videoCollaborationHostURL")},n,i)}},ut=function(e,t){return new lt(e||dt,t||q)},ft=new ut,pt=function(e){this.retrieveWebCollaborationHostUrl=e.retrieveWebCollaborationHostUrl,this.retrieveVideoCollaborationHostUrl=e.retrieveVideoCollaborationHostUrl},Et=function(e){return new pt(e||ft)};R.collaboration=new Et;var St=function(e){this.localVideoState=0,this.remoteVideoState=0,this.onReceived=null,this.onOutgoingCall=null,this.setOnMonitorSessionLost=function(t){var n={callback:t};return n=o(n,{serviceName:"rcc"}),e.invoke("call","setOnMonitorSessionLost",n)},this.initMedia=function(t,n,i){var r={options:i};return r=o(r,{serviceName:"spidr"}),e.invoke("call","initMedia",r,t,n)},this.startCall=function(t,n,i,r,a,s,c,d,l){var u={from:t,contact:n,to:i,isVideoEnabled:s,sendInitialVideo:c,videoQuality:d};return u=o(u,l),e.invoke("call","start",u,r,a)},this.startMonitorDevice=function(t,n,i){var r={deviceID:t};return r=o(r,{serviceName:"rcc"}),e.invoke("call","startMonitorDevice",r,n,i)},this.stopMonitorDevice=function(t,n){var i={};return i=o(i,{serviceName:"rcc"}),e.invoke("call","stopMonitorDevice",i,t,n)},this.getRCCDeviceList=function(t,n){var i={};return i=o(i,{serviceName:"rcc"}),e.invoke("call","getDeviceList",i,t,n)},this.set_logSeverityLevel=function(t){var n={level:t};return n=o(n,{serviceName:"spidr"}),e.invoke("call","set_logSeverityLevel",n)},this.enable_logCallback=function(){var t={};return t=o(t,{serviceName:"spidr"}),e.invoke("call","enable_logCallback",t)},this.disable_logCallback=function(){var t={};return t=o(t,{serviceName:"spidr"}),e.invoke("call","disable_logCallback",t)},this.get_audioInDeviceCount=function(){var t={};return t=o(t,{serviceName:"spidr"}),e.invoke("call","get_audioInDeviceCount",t)},this.get_audioOutDeviceCount=function(){var t={};return t=o(t,{serviceName:"spidr"}),e.invoke("call","get_audioOutDeviceCount",t)},this.get_videoDeviceCount=function(){var t={};return t=o(t,{serviceName:"spidr"}),e.invoke("call","get_videoDeviceCount",t)},this.hasVideoDevice=function(){var t={};return t=o(t,{serviceName:"spidr"}),e.invoke("call","get_videoDeviceCount",t)},this.hasAudioDevice=function(){var t={};return t=o(t,{serviceName:"spidr"}),e.invoke("call","hasAudioDevice",t)},this.getUserMedia=function(t,n,i){var r={options:i,privateStream:!0};return r=o(r,{serviceName:"spidr",privateStream:!0}),e.invoke("call","getUserMedia",r,t,n)},this.showSettingsWindow=function(t,n,i){var r={options:i};return r=o(r,{serviceName:"spidr"}),e.invoke("call","showSettingsWindow",r,t,n)},this.getLocalVideoResolutions=function(){var t={};return t=o(t,{serviceName:"spidr"}),e.invoke("call","getLocalVideoResolutions",t)},this.getRemoteVideoResolutions=function(){var t={};return t=o(t,{serviceName:"spidr"}),e.invoke("call","getRemoteVideoResolutions",t)},this.isPluginEnabled=function(){var t={};return t=o(t,{serviceName:"spidr"}),e.invoke("call","isPluginEnabled",t)},this.hasGotCalls=function(t){var n={};return n=o(n,t),e.invoke("call","hasGotCalls",n)},this.getIncomingCallById=function(t){var n={callid:t};return n=o(n,{serviceName:"spidr"}),e.invoke("call","getIncomingCallById",n)},this.createStreamRenderer=function(t,n,i){var r={streamId:t,container:n,options:i};return r=o(r,{serviceName:"spidr"}),e.invoke("call","createStreamRenderer",r);
},this.disposeStreamRenderer=function(t){var n={container:t};return n=o(n,{serviceName:"spidr"}),e.invoke("call","disposeStreamRenderer",n)},this.States={IN_CALL:0,ON_HOLD:1,RINGING:2,ENDED:3,REJECTED:4,OUTGOING:5,INCOMING:6,ANSWERING:7,JOINED:8,RENEGOTIATION:9,TRANSFERRED:10,ON_REMOTE_HOLD:11,CALL_IN_PROGRESS:12,EARLY_MEDIA:13,TRANSFER_FAILURE:14},this.HoldStates={LOCAL_HOLD:0,REMOTE_HOLD:1,BOTH_HOLD:2},this.MediaErrors={NOT_FOUND:1,NOT_ALLOWED:2,OPTIONS:3,WRONG_VERSION:4,NOT_INITIALIZED:5,NEW_VERSION_WARNING:6,INVALID_PARAMETER:7,NO_SCREENSHARING_WARNING:8},this.clickToCall=function(t,n,i,r){var a={callingParty:t,calledParty:n};return a=o(a,{serviceName:"spidr"}),e.invoke("call","clickToCall",a,i,r)},this.getIMRN=function(t,n,i,r,a){var s={realm:t,source:n,destination:i};return s=o(s,{serviceName:"spidr"}),e.invoke("call","getIMRN",s,r,a)},this.getStreamById=function(t){var n={streamId:t};return n=o(n,{serviceName:"spidr"}),e.invoke("call","getStreamById",n)},this.removeStreamById=function(t){var n={streamId:t};n=o(n,{serviceName:"spidr"}),e.invoke("call","removeStreamById",n)},this.setSelectedMicrophoneId=function(t){var n={microphoneId:t};n=o(n,{serviceName:"spidr"}),e.invoke("call","setSelectedMicrophoneId",n)},this.setSelectedCameraId=function(t){var n={cameraId:t};n=o(n,{serviceName:"spidr"}),e.invoke("call","setSelectedCameraId",n)},this.getCameraList=function(t){var n={};return n=o(n,{onSuccess:t,serviceName:"spidr"}),e.invoke("call","getCameraList",n)},this.getMicrophoneList=function(t){var n={};return n=o(n,{onSuccess:t,serviceName:"spidr"}),e.invoke("call","getMicrophoneList",n)},this.IncomingCall=function(){},this.OutgoingCall=function(){}},Tt=function(e){return new St(e||at)};R.call=new Tt(G),g&&(g.Call=Tt);var gt=function(){},mt=function(){this.onReceived=null};mt.prototype=new gt,R.custom=new mt,Ge.custom=function(e){q.callFunctionIfExist(R.custom.onReceived,e)};var Ct,It="/presence",vt="/presenceWatcher",Rt="watch",At="stopwatch",_t="get",Dt={CONNECTED:0,UNAVAILABLE:1,AWAY:2,OUT_TO_LUNCH:3,BUSY:4,ON_VACATION:5,BE_RIGHT_BACK:6,ON_THE_PHONE:7,ACTIVE:8,INACTIVE:9,PENDING:10,OFFLINE:11,CONNECTEDNOTE:12,UNAVAILABLENOTE:13},Nt="open",ht="closed",bt="unknown",Ot="away",Lt="lunch",yt="busy",Vt="vacation",Mt="on-the-phone",Pt="other",Ft="Be Right Back",wt="Offline",kt="active",Ut="inactive",Wt=function(){var e=[];e[Dt.CONNECTED]={status:Nt,activity:bt},e[Dt.UNAVAILABLE]={status:ht,activity:bt},e[Dt.AWAY]={status:Nt,activity:Ot},e[Dt.OUT_TO_LUNCH]={status:Nt,activity:Lt},e[Dt.BUSY]={status:ht,activity:yt},e[Dt.ON_VACATION]={status:ht,activity:Vt},e[Dt.BE_RIGHT_BACK]={status:Nt,activity:Pt,note:Ft},e[Dt.ON_THE_PHONE]={status:Nt,activity:Mt},e[Dt.ACTIVE]={status:Nt,activity:bt,userInput:kt},e[Dt.INACTIVE]={status:ht,activity:bt,userInput:Ut},e[Dt.OFFLINE]={status:ht,activity:Pt,note:wt},e[Dt.CONNECTEDNOTE]={status:Nt,activity:Pt},e[Dt.UNAVAILABLENOTE]={status:ht,activity:Pt},this.getRequestObject=function(t){var n=e[t];if(n)return n;throw new Error("Invalid Presence State")},this.getState=function(e){switch(e.userInput){case kt:return Dt.ACTIVE;case Ut:return Dt.INACTIVE}switch(e.note){case Ft:return Dt.BE_RIGHT_BACK;case wt:return Dt.OFFLINE}if(e.note)return e.status===Nt?Dt.CONNECTEDNOTE:Dt.UNAVAILABLENOTE;switch(e.activity){case Ot:return Dt.AWAY;case Lt:return Dt.OUT_TO_LUNCH;case yt:return Dt.BUSY;case Vt:return Dt.ON_VACATION;case Mt:return Dt.ON_THE_PHONE;case bt:return e.status===Nt?Dt.CONNECTED:Dt.UNAVAILABLE}return Dt.CONNECTED}},xt=function(e,t,n){function i(t,n,i,o){var r={presenceWatcherRequest:{userList:t,action:o}};e.sendPostRequest({url:T(1,vt),data:r},n,i)}var o=t.getLogger("presenceService");this.onReceived=null,this.update=function(t,i,o){e.sendPostRequest({url:T(1,It),data:{presenceRequest:n.getRequestObject(t)}},i,o)},this.watch=function(e,t,n){o.info("subscribe presence status of users:",e),i(e,function(e){t&&"function"==typeof t&&t(e.presenceWatcherResponse.expiryValue)},n,Rt)},this.stopwatch=function(e,t,n){i(e,t,n,At)},this.retrieve=function(e,t,n){i(e,t,n,_t)}};Ct=new Wt;var Bt=new xt(b,B,Ct);Ge.presenceWatcher=function(e){if(!R.notification.isAnonymous()){var t=new R.presence.UpdateEvent,n=e.presenceWatcherNotificationParams;t.name=q.getProperty(n,"name"),t.type=q.getProperty(n,"type"),t.status=q.getProperty(n,"status"),t.activity=q.getProperty(n,"activity"),t.note=q.getProperty(n,"note"),t.userInput=q.getProperty(n,"userInput"),t.state=Ct.getState(t),R.logManager.getLogger("presenceService").info("presence received: ",t),q.callFunctionIfExist(R.presence.onReceived,t)}};var Ht=function(e,t,n,i,o){function r(e){var t,n=[];for(t in e)e.hasOwnProperty(t)&&-1===E.indexOf(e[t])&&n.push(e[t]);return n}function a(e){var t,n=[];for(t in e)e.hasOwnProperty(t)&&-1!==E.indexOf(e[t])&&n.push(e[t]);return n}function s(e){var t,n;for(t in e)e.hasOwnProperty(t)&&(n=E.indexOf(e[t]),E.splice(n,1))}function c(){clearInterval(S),S=null,E=[]}function d(e){S||(S=setInterval(function(){l(E,void 0,function(e){p.error("presence svc. ext. subs. fail",e),o.callFunctionIfExist(t.presence.onFailure,f.Failures.SERVICE_FAILURE)})},1e3*e/2))}function l(t,n,i){t.length>0&&e.watch(t,function(e){d(e),o.callFunctionIfExist(n)},function(e){c(),o.callFunctionIfExist(i,e)})}function u(){l(E)}var f=this,p=n.getLogger("presenceMng"),E=[],S=null;f.Failures={SERVICE_FAILURE:0},f.update=e.update,f.watch=function(e,n,i){var a;if(!Array.isArray(e)||0===e.length)return void o.callFunctionIfExist(i,t.Errors.INVALID_PARAMETER);if(E.length>0){if(a=r(e),0===a.length)return void o.callFunctionIfExist(n);E=E.concat(a)}else E=a=e;l(a,n,i)},f.stopwatch=function(n,i,r){var d;return Array.isArray(n)&&0!==n.length?0===E.length?void o.callFunctionIfExist(i):(d=a(n),0===d.length?void o.callFunctionIfExist(i):void e.stopwatch(d,function(){s(d),0===E.length&&c(),o.callFunctionIfExist(i)},function(e){o.callFunctionIfExist(r,e)})):void o.callFunctionIfExist(r,t.Errors.INVALID_PARAMETER)},f.retrieve=e.retrieve,i.subscribe(v.EVENT.DEVICE_SUBSCRIPTION_STARTED,u),i.subscribe(v.EVENT.DEVICE_SUBSCRIPTION_ENDED,c)},Gt=new Ht(Bt,R,B,I,q),Yt=function(e){this.State={CONNECTED:0,UNAVAILABLE:1,AWAY:2,OUT_TO_LUNCH:3,BUSY:4,ON_VACATION:5,BE_RIGHT_BACK:6,ON_THE_PHONE:7,ACTIVE:8,INACTIVE:9,PENDING:10,OFFLINE:11,CONNECTEDNOTE:12,UNAVAILABLENOTE:13},this.update=function(t,n,i){e.update(t,n,i)},this.watch=function(t,n,i){e.watch(t,n,i)},this.stopwatch=function(t,n,i){e.stopwatch(t,n,i)},this.retrieve=function(t,n,i){e.retrieve(t,n,i)},this.Failures=e.Failures,this.UpdateEvent=function(){}};return R.presence=new Yt(Gt),R})},function(e,t,n){(function(t){!function(n,i){function o(e,t){return(typeof t)[0]==e}function r(e,t){return t=function s(c,d,l,u,f,p){function E(e){return function(t){f&&(f=0,s(o,e,t))}}if(u=s.q,c!=o)return r(function(e,t){u.push({p:this,r:e,j:t,1:c,0:d})});if(l&&o(n,l)|o(i,l))try{f=l.then}catch(S){d=0,l=S}if(o(n,f))try{f.call(l,E(1),d=E(0))}catch(S){d(S)}else for(t=function(t,i){return o(n,t=d?t:i)?r(function(e,n){a(this,e,n,l,t)}):e},p=0;p<u.length;)f=u[p++],o(n,c=f[d])?a(f.p,f.r,f.j,l,c):(d?f.r:f.j)(l)},t.q=[],e.call(e={then:function(e,n){return t(e,n)},"catch":function(e){return t(0,e)}},function(e){t(o,1,e)},function(e){t(o,0,e)}),e}function a(e,r,a,s,c){t(function(){try{s=c(s),c=s&&o(i,s)|o(n,s)&&s.then,o(n,c)?s==e?a(TypeError()):c.call(s,r,a):r(s)}catch(t){a(t)}})}function s(e){return r(function(t){t(e)})}e.exports=r,r.resolve=s,r.reject=function(e){return r(function(t,n){n(e)})},r.all=function(e){return r(function(t,n,i,o){o=[],i=e.length||t(o),e.map(function(e,r){s(e).then(function(e){o[r]=e,--i||t(o)},n)})})}}("f","o")}).call(t,n(3).setImmediate)},function(e,t,n){(function(e,i){function o(e,t){this._id=e,this._clearFn=t}var r=n(4).nextTick,a=Function.prototype.apply,s=Array.prototype.slice,c={},d=0;t.setTimeout=function(){return new o(a.call(setTimeout,window,arguments),clearTimeout)},t.setInterval=function(){return new o(a.call(setInterval,window,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e.close()},o.prototype.unref=o.prototype.ref=function(){},o.prototype.close=function(){this._clearFn.call(window,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout(function(){e._onTimeout&&e._onTimeout()},t))},t.setImmediate="function"==typeof e?e:function(e){var n=d++,i=arguments.length<2?!1:s.call(arguments,1);return c[n]=!0,r(function(){c[n]&&(i?e.apply(null,i):e.call(null),t.clearImmediate(n))}),n},t.clearImmediate="function"==typeof i?i:function(e){delete c[e]}}).call(t,n(3).setImmediate,n(3).clearImmediate)},function(e,t){function n(){d&&a&&(d=!1,a.length?c=a.concat(c):l=-1,c.length&&i())}function i(){if(!d){var e=setTimeout(n);d=!0;for(var t=c.length;t;){for(a=c,c=[];++l<t;)a&&a[l].run();l=-1,t=c.length}a=null,d=!1,clearTimeout(e)}}function o(e,t){this.fun=e,this.array=t}function r(){}var a,s=e.exports={},c=[],d=!1,l=-1;s.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];c.push(new o(e,t)),1!==c.length||d||setTimeout(i,0)},o.prototype.run=function(){this.fun.apply(null,this.array)},s.title="browser",s.browser=!0,s.env={},s.argv=[],s.version="",s.versions={},s.on=r,s.addListener=r,s.once=r,s.off=r,s.removeListener=r,s.removeAllListeners=r,s.emit=r,s.binding=function(e){throw new Error("process.binding is not supported")},s.cwd=function(){return"/"},s.chdir=function(e){throw new Error("process.chdir is not supported")},s.umask=function(){return 0}}])});