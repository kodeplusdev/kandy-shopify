// Kandy.js
// Site: http://kandy.io
// Version: 2.3.0
// Copyright 2015 Genband
// ----------------------
!function(e,t){"function"==typeof define&&define.amd?define(t):e.kandy=e.KandyAPI=t.apply({})}(this,function(){"use strict";function e(e){var t=!1,n=!1,i=!1,o=!1;window.console&&console.warn&&console.error&&console.info&&("debug"===e&&(t=n=i=o=!0),"info"===e?t=n=i=!0:"warn"===e?t=n=!0:"error"===e&&(t=!0),o&&(R.debug=window.console.log.bind(window.console,"kandy debug: %s")),i&&(R.info=window.console.info.bind(window.console,"kandy info: %s")),n&&(R.warn=window.console.warn.bind(window.console,"kandy warn: %s")),t&&(R.error=window.console.error.bind(window.console,"kandy error: %s")))}function t(){var e=Array.prototype.shift.apply(arguments);v[e]&&v[e].apply(null,arguments)}function n(){var e=!1;return V&&(e=1===V.readyState),e}function i(){if(n()){D=setTimeout(i,3e4);var e={message_type:"ping"};try{V.send(JSON.stringify(e))}catch(t){window.console.error("Exception in sendWSPing: "+t.message)}}}function o(){window.console.log("reconnecting"),d(function(){window.console.log("reconnect success"),M=0,t("onconnectionrestored")},function(){M++,window.console.log("failed to reconnect"),r()})}function r(){var e=M>10?M>100?6e4:3e4:1e4;_=setTimeout(o,e)}function a(){window.console.log("browser going online"),clearTimeout(_),_=setTimeout(o,500)}function s(){window.console.log("browser going offline"),clearTimeout(D),V.close()}function c(e){var t=e.data_server_host,n=e.data_server_port,i=e.is_secure,o=t.match("^(?:https?://)?(?:www.)?([^/]+)"),r=n?":"+n:"";return(i?"wss":"ws")+"://"+o[1]+r}function d(e,o){return n()?void u():void window.KandyAPI.getDataChannelConfiguration(function(n){A.kandyWSUrl=c(n)+"?client_sw_type=js&client_sw_version="+C.version+"&user_access_token=";try{R.debug("Opening websocket, UAT = "+N.userAccessToken),V=new WebSocket(A.kandyWSUrl+encodeURIComponent(N.userAccessToken))}catch(d){return void(o&&o("Error opening websocket",g.wsCreateError))}null!==V&&2!==V.readyState&&3!==V.readyState?(V.onopen=function(t){window.addEventListener&&!F&&(window.addEventListener("online",a),window.addEventListener("offline",s),F=!0),e(),i()},V.onclose=function(e){D&&(h&&!_&&(window.console.log("connection closed"),clearTimeout(D),r()),0===M&&t("onconnectionlost",e))},V.onerror=function(e){t("onconnectionerror",e)},V.onmessage=function(e){var t,n,i,o,r=JSON.parse(e.data);if("response"===r.message_type)n=P[r.id],n&&(delete P[r.id],0===r.status?n.success&&n.success():n.failure&&n.failure(r.message,r.status));else if(y.hasOwnProperty(r.message_type)&&(t=y[r.message_type],t&&t.length>0))for(o=t.length,i=0;o>i;i++)"function"==typeof t[i]&&t[i](r)}):o("Error opening websocket",g.wsCreateError)},o)}function l(e,t,i){if(n()){if((t||i)&&void 0===e.id){var o=S.createUUIDv4();e.id=o,P[o]={success:t,failure:i}}try{V.send(JSON.stringify(e))}catch(r){window.console.log("Exception in sendWebSocketData: "+r.message)}}else i()}function u(){clearTimeout(D),D=null,n()&&V.close()}function p(e){if(e)for(var t in e)e.hasOwnProperty(t)&&(void 0===y[t]&&(y[t]=[]),y[t].push(e[t]))}function f(e,t,n,i,o,r){t=t.split("@")[0],b({url:"/domains/users/accesstokens",params:{key:e,user_id:t,user_password:n,client_sw_version:r.client_sw_version,client_sw_type:r.client_sw_type,kandy_device_id:r.kandy_device_id},success:function(e){i&&i(e.result)},failure:o})}var E="2.3.0";!function(e,t){"function"==typeof define&&define.amd?define(t):e.fcs=t()}(this,function(){function e(){return I.split("@")[1]}function t(){return I}function n(){return R}function i(){return _}function o(){return A}function r(){return"3.0.4"}function a(){return v}function s(e){v=e===!0?!0:!1}function c(){var e="";return C.protocol&&C.restUrl&&C.restPort?e+C.protocol+"://"+C.restUrl+":"+C.restPort:e}function d(e,t,n){var i=o(),r=t.indexOf("?")>=0;return i&&(t+=r?"&key="+i:"?key="+i),n===!1?c()+"/rest/version/"+(e?e:"latest")+t:E.notification?c()+"/rest/version/"+(e?e:"latest")+(E.notification.isAnonymous()?"/anonymous/":"/user/")+E.getUser()+t:c()+"/rest/version/"+(e?e:"latest")+"/user/"+E.getUser()+t}var l,u=function(){function e(e){var t,n,i;for(t in r)if(r[t]&&r.hasOwnProperty(t))for(n=0,i=r[t].length;i>n;n++)if(r[t][n].token===e)return r[t].splice(n,1),e;return!1}function t(e,t,n,s){var c,d=i,l=!1;if("string"!=typeof e)throw new Error("First parameter must be a string topic name.");if("function"!=typeof t)throw new Error("Second parameter must be a function.");if("undefined"!=typeof n){if("number"!=typeof n)throw new Error("Priority must be a number.");if(n>i||o>n)throw new Error("Priority must be between 1-10.");d=n}return s===!0&&(l=s),r[e]||(r[e]=[]),c=(++a).toString(),r[e].push({token:c,prio:d,func:t,temp:l}),r[e].sort(function(e,t){return parseFloat(t.prio)-parseFloat(e.prio)}),c}function n(t,n){var i,o,a,s;if(0===arguments.length)throw new Error("First parameter must be a string topic name.");for(a=Array.prototype.slice.call(arguments),s=a.shift(),i=r[s],o=i?i.length:0;o--;)i[o].func.apply(null,a),i[o].temp&&e(i[o].token)}var i=10,o=1,r={},a=-1;this.publish=n,this.subscribe=t,this.unsubscribe=e},p=new u;l&&(l.GlobalBroadcaster=u);var f={WEBRTC:{PLUGIN_ID:"fcsPlugin",MEDIA_STATE:{NOT_FOUND:"notfound",SEND_RECEIVE:"sendrecv",SEND_ONLY:"sendonly",RECEIVE_ONLY:"recvonly",INACTIVE:"inactive"},PLUGIN_MODE:{WEBRTC:"webrtc",LEGACY:"legacy",LEGACYH264:"legacyh264",AUTO:"auto"},RTC_SIGNALING_STATE:{STABLE:"stable",HAVE_LOCAL_OFFER:"have-local-offer",HAVE_REMOTE_OFFER:"have-remote-offer",HAVE_LOCAL_PRANSWER:"have-local-pranswer",HAVE_REMOTE_PRANSWER:"have-remote-pranswer",CLOSED:"closed"},RTC_SDP_TYPE:{OFFER:"offer",ANSWER:"answer",PRANSWER:"pranswer"}},STRING:{NEW_LINE:"\n",CARRIAGE_RETURN:"\r",VIDEO:"video",AUDIO:"audio"},SDP:{A_LINE:"a=",M_LINE:"m=",CRYPTO:"crypto",FINGERPRINT:"fingerprint",ICE_UFRAG:"ice-ufrag:",ICE_PWD:"ice-pwd:",NACK:"nack",NACKPLI:"nack pli"},HTTP_METHOD:{GET:"GET",POST:"POST",PUT:"PUT",DELETE:"DELETE",OPTIONS:"OPTIONS"},WEBSOCKET:{PROTOCOL:{SECURE:"wss",NONSECURE:"ws"},DEFAULT_PORT:"8581",STATUS:{OPENED:1,ALREADY_OPENED:2,CREATE_ERROR:3,CONNECTION_ERROR:4,NOT_FOUND:5,CONNECTION_CLOSED:6}},COLLABORATION:{GUEST_SUFFIX:"-guest"},EVENT:{XHR_REQUEST_NOT_INITIALIZED:"XHR_REQUEST_NOT_INITIALIZED",DEVICE_SUBSCRIPTION_STARTED:"DEVICE_SUBSCRIPTION_STARTED",DEVICE_SUBSCRIPTION_ENDED:"DEVICE_SUBSCRIPTION_ENDED",CONNECTION_REESTABLISHED:"CONNECTION_REESTABLISHED",CONNECTION_LOST:"CONNECTION_LOST",TOKEN_AUTH_STARTED:"TOKEN_AUTH_STARTED",BASIC_AUTH_STARTED:"BASIC_AUTH_STARTED",TOKEN_NOT_FOUND:"TOKEN_NOT_FOUND",SESSION_EXPIRED:"SESSION_EXPIRED",TURN_CREDENTIALS_ESTABLISHED:"TURN_CREDENTIALS_ESTABLISHED",NOTIFICATION_CHANNEL_LOST:"NOTIFICATION_CHANNEL_LOST"}};l&&(l.CONSTANTS=f);var E,S=function(){function e(){return O.getLogger("jQrestful")}function t(e,t,n,i){var o=e;return i&&(o.data=i),n&&(o.errorThrown=n),t&&(o.status=t.status,o.statusText=t.statusText,o.responseText=t.responseText,o.readyState=t.readyState),o}function n(t,n){var i,o;switch(e().error("parseError:'"+n+"' Status:'"+t.status+"' ResponseText:'"+t.responseText+"'"),t.responseText&&-1!==t.responseText.search("statusCode")&&(void 0!==JSON.parse(t.responseText).subscribeResponse?o=JSON.parse(t.responseText).subscribeResponse.statusCode:void 0!==JSON.parse(t.responseText).authorizationResponse&&(o=JSON.parse(t.responseText).authorizationResponse.statusCode)),o=o?o:t.status){case 401:i=E.Errors.AUTH;break;case 403:i=E.Errors.INCORRECT_LOGIN_PASS;break;case 19:i=E.Errors.LOGIN_LIMIT_CLIENT;break;case 20:i=E.Errors.LOGIN_LIMIT_TABLET;break;case 44:i=E.Errors.FORCE_LOGOUT_ERROR;break;case 46:i=E.Errors.TOKEN_NOT_FOUND;break;case 47:i=E.Errors.SESSION_EXPIRED;break;default:i=E.Errors.NETWORK}return i}function i(t,n,i){return e().error("parseErrorStatusCode:'"+n+"' Status:'"+t.status+"' ResponseText:'"+t.responseText+"'"),t.responseText&&-1!==t.responseText.search("statusCode")&&void 0!==JSON.parse(t.responseText)[i]?JSON.parse(t.responseText)[i].statusCode:401===t.status||403===t.status?t.status:400}var o=3e4,r=4e4,a={REQUEST_NOT_INITIALIZED:0,REQUEST_DONE:4};this.call=function(s,c,d,l,u,S,T,m){var g,I,R,v,D,_,A,N,h,O,b,L=r,y=c.url,V=e();c&&c.data&&(g=c.data),C.polling&&(L=1e3*C.polling,L+=C.longpollingTolerans?C.longpollingTolerans:o),y.split("/rest/version/")[1]&&(I=y.split("/rest/version/")[1].split("/")[3],I||(I=y.substring(y.lastIndexOf("/")+1,y.length)),I=I.split("?")[0],g?V.info("Send ajax request: "+I,g):V.info("Send ajax request: "+I)),"GET"===s&&(v=P.param(g),v.length>0&&(y=y+"?"+v),g=null),R=new XMLHttpRequest,R.open(s,y,E.isAsync()),R.withCredentials=C.cors?!0:!1,R.timeout=L,D={"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},D=P.extend(D,m);for(_ in D)R.setRequestHeader(_,D[_]);return"string"!=typeof g&&(g=JSON.stringify(g)),R.send(g),A={type:s,url:y,dataType:"json",async:E.isAsync(),jsonp:!1,crossDomain:C.cors?!0:!1,timeout:L},h=function(e){u&&"function"==typeof u&&(e=u(e)),d&&"function"==typeof d&&d(e)},O=function(){l&&"function"==typeof l?l("addressBookResponse"===T?i(R,R.statusText,T):S&&"function"==typeof S?S(R,R.statusText):n(R,R.statusText)):V.trace("Error handler is not defined or not a function")},N=function(){if(R.readyState===a.REQUEST_DONE)if(b=R.status>=200&&R.status<300||304===R.status){var e={};try{"string"==typeof R.responseText&&R.responseText.length&&(e=JSON.parse(R.responseText)),V.info("ajax success: "+R.status+" "+R.statusText,t(A,R,void 0,e)),h(e)}catch(n){n instanceof SyntaxError?V.error("Failed to parse json ajax response into object:"+R.responseText,t(A,R,void 0,e)):V.error("Unknown error:"+R.status+" "+R.statusText,t(A,R,void 0,e)),O()}}else{if(V.error("ajax error: "+R.status+" "+R.statusText,t(A,R,R.statusText)),410===R.status)return V.error("410 Gone received"),void P.callFunctionIfExist(E.notification.onGoneReceived);if(0===R.status&&"abort"===R.statusText)return void V.trace("Ajax request aborted internally. not calling failure callback");O()}else if(R.readyState===a.REQUEST_NOT_INITIALIZED){if(V.error("ajax error: "+R.status+" "+R.statusText,t(A,R,null)),0===R.status&&"abort"===R.statusText)return void V.trace("Ajax request aborted internally. not calling failure callback");p.publish(f.EVENT.XHR_REQUEST_NOT_INITIALIZED),V.debug("Ajax request cannot be sent, this is a connection problem."),O()}},E.isAsync()?4===R.readyState?setTimeout(N):R.onreadystatechange=N:N(),R}},T=new S,m=function(){function e(e){d=e.session}function t(){d=null}function n(e){s=e.username}function i(e){s=e.username,c=e.password}function o(e){return e||(e={}),e.Accept||(e.Accept="application/json"),e["Content-Type"]||(e["Content-Type"]="application/json"),d?(e["x-session"]=d,delete e.Authorization):(s&&c&&(e.Authorization="basic "+window.btoa(s+":"+c)),delete e["x-session"]),e}function r(e,t,n,i,o,r,a,s){var c=function(e){e===E.Errors.TOKEN_NOT_FOUND?(p.publish(f.EVENT.TOKEN_NOT_FOUND),d=null):e===E.Errors.SESSION_EXPIRED&&(p.publish(f.EVENT.SESSION_EXPIRED),d=null),i&&"function"==typeof i&&i(e)};return T.call(e,t,n,c,o,r,a,s)}function a(e,t,n,i,o,a,s,c){return s||(s={}),s.Accept||(s.Accept="application/json"),s["Content-Type"]||(s["Content-Type"]="application/json"),s["x-session"]&&delete s["x-session"],s.Authorization&&delete s.Authorization,s["x-token"]||(s["x-token"]=c),r(S,e,t,n,i,o,a,s)}var s,c,d,u="PUT",S="POST",m="GET",g="DELETE";this.call=function(e,t,n,i,a,s,c,d){return d=o(d),t&&t.data&&(t.data=JSON.stringify(t.data)),r(e,t,n,i,a,s,c,d)},this.sendPostRequest=function(e,t,n,i,s,c,d,l){return e&&e.data&&(e.data=JSON.stringify(e.data)),l?a(e,t,n,i,s,c,d,l):(d=o(d),r(S,e,t,n,i,s,c,d))},this.sendGetRequest=function(e,t,n,i,a,s,c){return c=o(c),r(m,e,t,n,i,a,s,c)},this.sendDeleteRequest=function(e,t,n,i,a,s,c){return c=o(c),e&&e.data&&(e.data=JSON.stringify(e.data)),r(g,e,t,n,i,a,s,c)},this.sendPutRequest=function(e,t,n,i,a,s,c){return c=o(c),e&&e.data&&(e.data=JSON.stringify(e.data)),r(u,e,t,n,i,a,s,c)},p.subscribe(f.EVENT.TOKEN_AUTH_STARTED,n,9),p.subscribe(f.EVENT.BASIC_AUTH_STARTED,i,10),p.subscribe(f.EVENT.DEVICE_SUBSCRIPTION_STARTED,e),p.subscribe(f.EVENT.DEVICE_SUBSCRIPTION_ENDED,t),l&&(this.manipulateHeader=o),l&&(this.setSession=function(e){d=e}),l&&(this.setUsernamePassword=function(e,t){s=e,c=t})},g=new m,C={polling:30},I=null,R=null,v=!0,D=null,_=null,A=null,N=function(){var i=null,o=null,s={},c=!0;this.isAsync=function(){return c},this.setAsync=function(e){c=e},this.getUser=t,this.getUserPassword=n,this.getDomain=e,this.getVersion=r,this.getDevice=function(){return i},this.setUserAuth=function(e,t){I=e,R=t,i=null,p.publish(f.EVENT.BASIC_AUTH_STARTED,{username:e,password:t})},this.setTokenAuth=function(e,t){I=e,D=t,p.publish(f.EVENT.TOKEN_AUTH_STARTED,{username:e,token:t})},this.setDeviceAuth=function(e){i=e,I=null},this.setRealm=function(e){_=e},this.setKandyUAT=function(e){A=e},this.AuthenticationType={USER:1,DEVICE:2},this.Errors={NETWORK:1,AUTH:2,STATE:3,PRIV:4,CONV_SUBS:5,UNKNOWN:9,LOGIN_LIMIT_CLIENT:10,INCORRECT_LOGIN_PASS:11,INVALID_LOGIN:12,FORCE_LOGOUT_ERROR:13,LOGIN_LIMIT_TABLET:14,TOKEN_NOT_FOUND:15,SESSION_EXPIRED:16,VIDEO_SESSION_NOT_AVAILABLE:17,PENDING_REQUEST:18},this.setup=function(e){var t;for(t in e)e.hasOwnProperty(t)&&(C[t]=e[t])},this.setPluginVersion=function(e){o=e},this.getPluginVersion=function(){return o},this.getServices=function(){return s},this.setServices=function(e){var t;if(e)for(t=0;t<e.length;t++)switch(e[t]){case"CallDisplay":s.callDisplay=!0;break;case"CallDisposition":s.callDisposition=!0;break;case"RestfulClient":s.restfulClient=!0;break;case"call":case"CallControl":s.callControl=!0;break;case"CallMe":s.callMe=!0;break;case"Directory":s.directory=!0;break;case"ClickToCall":s.clickToCall=!0;break;case"Presence":s.presence=!0;break;case"AddressBook":s.contacts=!0;break;case"CallLog":s.history=!0;break;case"Custom":s.custom=!0;break;case"IM":s.IM=!0;break;case"Route":s.routes=!0;break;case"Collaboration":s.collab=!0;break;case"conversation":case"Conversation":s.conversation=!0}},this.clearResources=function(e,t,n){n&&E.setAsync(!1),E.notification.stop(function(){window.localStorage.removeItem("SubscriptionStamp")},function(){},!0),t&&(window.localStorage.removeItem("USERNAME"),window.localStorage.removeItem("PASSWORD")),"function"==typeof e&&e()},this.getUserLocale=function(e,t){g.sendGetRequest({url:d(1,"/localization",!1)},function(t){P.callFunctionIfExist(e,t)},t)},this.isConnected=a};E=new N,E.fcsConfig=C;var h=function(){function e(){return ke?ke.getNotificationId():null}function n(n){function i(n,i,r){if(o){var c={};if(c.user=t(),c.timestamp=(new Date).getTime(),c.logger=s,c.level=n,c.notificationId=e(),c.message=i,c.args=r,a)try{a(c.logger,c.level,c)}catch(d){return void 0}}return!1}var s=n;this.getName=function(){return s},this.trace=function(e,t){return i(r.TRACE,e,t)},this.debug=function(e,t){return i(r.DEBUG,e,t)},this.info=function(e,t){return i(r.INFO,e,t)},this.warn=function(e,t){return i(r.WARN,e,t)},this.error=function(e,t){return i(r.ERROR,e,t)},this.fatal=function(e,t){return i(r.FATAL,e,t)}}var i={},o=!1,r={OFF:"OFF",FATAL:"FATAL",ERROR:"ERROR",WARN:"WARN",INFO:"INFO",DEBUG:"DEBUG",TRACE:"TRACE",ALL:"ALL"},a=null;this.initLogging=function(e,t){return e&&"function"==typeof e?(a=e,o=t===!0?!0:!1,!0):!1},this.Level=r,this.isEnabled=function(){return o},this.getLogger=function(e){var t,o;return o=e&&0!==e.trim().length?e:"Default",i[o]?t=i[o]:(t=new n(o),i[t.getName()]=t),t}};l&&(l.LogManager=h);var O=new h;E.logManager=O;var b=function(){var e,t=function(){var e,t,n,i,o,r={},a=document.cookie,s=0;if(""===a)return r;for(e=a.split("; ");s<e.length;s+=1)t=e[s],n=t.indexOf("="),i=t.substring(0,n),o=t.substring(n+1),o=decodeURIComponent(o),r[i]=o;return r}(),n=[];for(e in t)t.hasOwnProperty(e)&&n.push(e);this.length=n.length,this.key=function(e){return 0>e||e>=n.length?null:n[e]},this.getItem=function(e){if(1!==arguments.length)throw new Error("Provide one argument");return t[e]||null},this.setItem=function(e,i){if(2!==arguments.length)throw new Error("Provide two arguments");void 0===t[e]&&(n.push(e),this.length++),t[e]=i;var o=e+"="+encodeURIComponent(i),r=new Date,a=new Date(r.getTime()+2592e6);o+="; max-age="+a,o+="; path=/",document.cookie=o},this.removeItem=function(e){if(1!==arguments.length)throw new Error("Provide one argument");var i,o=0;if(void 0!==t[e]){for(delete t[e],i=n.length;i>o;o+=1)if(n[o]===e){n.splice(o,1);break}this.length--,document.cookie=e+"=; max-age=0"}},this.clear=function(){for(var e=0;e<n.length;e++)document.cookie=n[e]+"=; max-age=0";t={},n=[],this.length=0}},L="undefined"!=typeof window.localStorage?window.localStorage:new b;window.cache=L;var y=function(){function e(t,n){var i,o;if(t){for(i in t)if(t.hasOwnProperty(i)&&(i===n?o=t[i]:"object"==typeof t[i]&&(o=e(t[i],n)),o))break;return o}}var t=O.getLogger("utils");this.getProperty=function(e,t){return"undefined"==typeof e[t]?null:e[t]},this.callFunctionIfExist=function(){var e,n=Array.prototype.slice.call(arguments);if(e=n.shift(),"function"!=typeof e)return t.info("Not a function:"+e),-1;try{return e.apply(null,n),!0}catch(i){return void t.error("Exception occured:\n"+i.stack)}},this.s4=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},this.extend=function(e,t){var n;for(n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},this.compose=function(e,t){var n;for(n in e)"function"!=typeof e[n]||t[n]||(t[n]=e[n].bind(e))},this.param=function(e){var t,n="";for(t in e)e.hasOwnProperty(t)&&(n.length>0&&(n+="&"),n+=encodeURI(t+"="+e[t]));return n},this.getTimestamp=function(){return(new Date).getTime()},this.getPropertyValueIfExistsInObject=e,this.Queue=function(){var e;this.enqueue=function(t){"undefined"==typeof e&&(e=[]),e.push(t)},this.dequeue=function(){return e.shift()},this.peek=function(){return e[0]},this.size=function(){return"undefined"==typeof e?0:e.length}},this.getQueue=function(){return new this.Queue}},P=new y;Function.prototype.bind||(Function.prototype.bind=function(e){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var t=Array.prototype.slice.call(arguments,1),n=this,i=function(){},o=function(){return n.apply(this instanceof i&&e?this:e,t.concat(Array.prototype.slice.call(arguments)))};return i.prototype=this.prototype,o.prototype=new i,o}),l&&(l.UtilsQueue=P.Queue);var V=function(){var e,t=O.getLogger("sdpParser"),n="\n",i="\r";this.init=function(t){e=this,e.sessionDescription={},e.mediaDescriptions=[],e.sdp=t,e.parseSDP(),e.setSessionDescriptionAttributes(),e.setMediaDescriptionsAttributes()},this.parseSDP=function(){var t,n=[],i=1;for(n=e.sdp.split(/^(?=m=)/m),e.sessionDescription.data=n[0],i;i<n.length;i++)t={},t.data=n[i],e.mediaDescriptions.push(t)},this.setSessionDescriptionAttributes=function(){var t,n=0,i=e.sessionDescription.data.split(/\r\n|\r|\n/);for(n;n<i.length;n++)i[n].match("^e=")?e.sessionDescription.email=i[n].split("=")[1]:i[n].match("^c=")&&(t=i[n].split("=")[1],e.sessionDescription.connection=t,e.sessionDescription.ip=t.split(" ")[2])},this.setMediaDescriptionsAttributes=function(){var t,n,i,o,r=0;for(t in e.mediaDescriptions)if(e.mediaDescriptions.hasOwnProperty(t)){n=e.mediaDescriptions[t].data.split(/\r\n|\r|\n/),this.mediaDescriptions[t].direction="sendrecv";for(r in n)n.hasOwnProperty(r)&&(n[r].match("^m=")?(i=n[r].split("=")[1],e.mediaDescriptions[t].media=i,e.mediaDescriptions[t].port=i.split(" ")[1]):n[r].match("^a=sendrecv")||n[r].match("^a=sendonly")||n[r].match("^a=recvonly")||n[r].match("^a=inactive")?e.mediaDescriptions[t].direction=n[r].split("=")[1]:n[r].match("^c=")&&(o=n[r].split("=")[1],e.mediaDescriptions[t].connection=o,e.mediaDescriptions[t].ip=o.split(" ")[2]))}},this.isHold=function(t){var n,i,o=!1,r=0;for(r in e.mediaDescriptions)if(e.mediaDescriptions.hasOwnProperty(r)&&(i=this.mediaDescriptions[r],i.ip?n=i.ip:e.sessionDescription.ip&&(n=e.sessionDescription.ip),0!==i.port)){if(!("inactive"===i.direction||"sendonly"===i.direction&&t||"recvonly"===i.direction&&!t||"0.0.0.0"===n)){o=!1;break}o=!0}return o},this.isRemoteHold=function(){return this.isHold(!0)},this.isLocalHold=function(){return this.isHold(!1)},this.getSessionDescription=function(){return e.sessionDescription},this.getMediaDescriptions=function(){return e.mediaDescriptions},this.isSdpHas=function(e,t){var n=!1;return-1!==e.indexOf(f.SDP.M_LINE+t)?n=!0:n},this.isSdpHasAudio=function(e){return this.isSdpHas(e,f.STRING.AUDIO)},this.isSdpHasVideo=function(e){return this.isSdpHas(e,f.STRING.VIDEO)},this.isSdpHasMediaWithExpectedPort=function(e,t,n){return-1!==e.indexOf(f.SDP.M_LINE+t+" "+n)},this.isSdpHasAudioWithZeroPort=function(e){return this.isSdpHasMediaWithExpectedPort(e,f.STRING.AUDIO,0)},this.isSdpHasVideoWithZeroPort=function(e){return this.isSdpHasMediaWithExpectedPort(e,f.STRING.VIDEO,0)},this.isSdpHasAudioWithOnePort=function(e){return this.isSdpHasMediaWithExpectedPort(e,f.STRING.AUDIO,1)},this.isSdpHasVideoWithOnePort=function(e){return this.isSdpHasMediaWithExpectedPort(e,f.STRING.VIDEO,1)},this.isSdpHasAudioWithNinePort=function(e){return this.isSdpHasMediaWithExpectedPort(e,f.STRING.AUDIO,9)},this.isSdpHasVideoWithNinePort=function(e){return this.isSdpHasMediaWithExpectedPort(e,f.STRING.VIDEO,9)},this.replaceZeroVideoPortWithOne=function(e){return this.isSdpHasVideoWithZeroPort(e)&&(e=e.replace(f.SDP.M_LINE+f.STRING.VIDEO+" 0 ",f.SDP.M_LINE+f.STRING.VIDEO+" 1 ")),e},this.getSdpDirection=function(e,n){var i,o,r="",a=[],s=f.WEBRTC.MEDIA_STATE.INACTIVE;if(o=function(e){t.info("getSdpDirection: type= "+n+" state= "+e)},!this.isSdpHas(e,n))return o(s),s;if(this.isSdpHasMediaWithExpectedPort(e,n,0))return o(s),s;for(a=e.split(/^(?=m=)/m),i=0;i<a.length;i++)if(r=a[i],-1!==r.indexOf(f.SDP.M_LINE+n))return-1!==r.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.SEND_RECEIVE)?(s=f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,o(s),s):-1!==r.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.SEND_ONLY)?(s=f.WEBRTC.MEDIA_STATE.SEND_ONLY,o(s),s):-1!==r.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)?(s=f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,o(s),s):-1!==r.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.INACTIVE)?(o(s),s):s=f.WEBRTC.MEDIA_STATE.SEND_RECEIVE;return s=f.WEBRTC.MEDIA_STATE.NOT_FOUND,o(s),s},this.getAudioSdpDirection=function(e){return this.getSdpDirection(e,f.STRING.AUDIO)},this.getVideoSdpDirection=function(e){return this.getSdpDirection(e,f.STRING.VIDEO)},this.isAudioSdpDirectionInactive=function(e){return this.getAudioSdpDirection(e)===f.WEBRTC.MEDIA_STATE.INACTIVE},this.isAudioSdpDirectionSendrecv=function(e){return this.getAudioSdpDirection(e)===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE},this.isAudioSdpDirectionSendonly=function(e){return this.getAudioSdpDirection(e)===f.WEBRTC.MEDIA_STATE.SEND_ONLY},this.isAudioSdpDirectionRecvonly=function(e){return this.getAudioSdpDirection(e)===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY},this.isSdpContainsAudioDirection=function(e){return this.getAudioSdpDirection(e)!==f.WEBRTC.MEDIA_STATE.NOT_FOUND},this.isVideoSdpDirectionInactive=function(e){return this.getVideoSdpDirection(e)===f.WEBRTC.MEDIA_STATE.INACTIVE},this.isVideoSdpDirectionSendrecv=function(e){return this.getVideoSdpDirection(e)===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE},this.isVideoSdpDirectionSendonly=function(e){return this.getVideoSdpDirection(e)===f.WEBRTC.MEDIA_STATE.SEND_ONLY},this.isVideoSdpDirectionRecvonly=function(e){return this.getVideoSdpDirection(e)===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY},this.isSdpContainsVideoDirection=function(e){return this.getVideoSdpDirection(e)!==f.WEBRTC.MEDIA_STATE.NOT_FOUND},this.changeDirection=function(e,n,i,o){var r,a,s="",c=[],d="changeDirection: before= "+n+" after= "+i;if(n===i)return e;if(void 0===o||null===o)t.info(d+" for all media types");else{if(n!==this.getSdpDirection(e,o))return e;t.info(d+" type= "+o)}for(c=e.split(/^(?=m=)/m),a=0;a<c.length;a++)r=c[a],(void 0===o||null===o||-1!==r.indexOf(f.SDP.M_LINE+o))&&(r=r.replace(f.SDP.A_LINE+n,f.SDP.A_LINE+i)),s+=r;return s},this.updateSdpDirection=function(e,n,i){t.info("updateSdpDirection: type= "+n+" direction= "+i);var o=this.getSdpDirection(e,n);return this.changeDirection(e,o,i,n)},this.updateAudioSdpDirection=function(e,n){t.info("updateSdpDirection: type= "+f.STRING.AUDIO+" direction= "+n);var i=this.getSdpDirection(e,f.STRING.AUDIO);return this.changeDirection(e,i,n,f.STRING.AUDIO)},this.updateVideoSdpDirection=function(e,n){t.info("updateSdpDirection: type= "+f.STRING.VIDEO+" direction= "+n);var i=this.getSdpDirection(e,f.STRING.VIDEO);return this.changeDirection(e,i,n,f.STRING.VIDEO)},this.updateAudioSdpDirectionToInactive=function(e){return this.updateAudioSdpDirection(e,f.WEBRTC.MEDIA_STATE.INACTIVE)},this.updateVideoSdpDirectionToInactive=function(e){return this.updateVideoSdpDirection(e,f.WEBRTC.MEDIA_STATE.INACTIVE)},this.isSdpHasDirection=function(e){var t,n,i,o;return t=e.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,0),n=e.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.SEND_ONLY,0),i=e.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,0),o=e.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.INACTIVE,0),t+1+(n+1)+(i+1)+(o+1)===0?!1:!0},this.isSdpEnabled=function(e,n){var i,o="isSdpEnabled for type "+n+": ",r=!1;return this.isSdpHasMediaWithExpectedPort(e,n,0)?(t.info(o+r),r):n===f.STRING.VIDEO&&(i=this.getVideoSdpDirection(e),i===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY||i===f.WEBRTC.MEDIA_STATE.INACTIVE)?(t.info(o+r),r):(this.isSdpHas(e,n)&&(r=!0),t.info(o+r),r)},this.isAudioSdpEnabled=function(e){return this.isSdpEnabled(e,f.STRING.AUDIO)},this.isVideoSdpEnabled=function(e){return this.isSdpEnabled(e,f.STRING.VIDEO)},this.isSdpVideoReceiveEnabled=function(e){var n,i="isSdpVideoReceiveEnabled: ",o=!1;return-1!==e.indexOf(f.SDP.M_LINE+f.STRING.VIDEO+" 0")?(t.info(i+o),o):(n=this.getVideoSdpDirection(e),n===f.WEBRTC.MEDIA_STATE.SEND_ONLY||n===f.WEBRTC.MEDIA_STATE.INACTIVE?(t.info(i+o),o):-1!==e.indexOf(f.SDP.M_LINE+f.STRING.VIDEO)?(o=!0,t.info(i+o),o):(t.info(i+o),o))},this.updateH264Level=function(e){var t,n,i,o,r,a="",s="",c=[],d=/\r\n|\r|\n/m,l="";for(c=e.split(/^(?=m=)/m),t=0;t<c.length;t++){if(s=c[t],-1!==s.indexOf(f.SDP.M_LINE+f.STRING.VIDEO)){for(n=s.split(d),i=0;i<n.length;i++)o=n[i],o&&-1!==o.indexOf("a=rtpmap:")&&-1!==o.indexOf("H264")?(r=o.split(/\:| /m),o=o+f.STRING.CARRIAGE_RETURN+f.STRING.NEW_LINE,o=o+"a=fmtp:"+r[1]+" profile-level-id=428014;",o=o+f.STRING.CARRIAGE_RETURN+f.STRING.NEW_LINE):o&&""!==o&&(o=o+f.STRING.CARRIAGE_RETURN+f.STRING.NEW_LINE),l+=o;s=l}a+=s}return a},this.isSdpVideoCandidateEnabled=function(e){var n="isSdpVideoCandidateEnabled: ",i=!1;return this.isSdpHasVideoWithZeroPort(e)?(t.info(n+i),i):this.isVideoSdpDirectionInactive(e)?(t.info(n+i),i):this.isSdpHasVideo(e)?(t.info(n+i),i):(i=!0,t.info(n+i),!0)},this.deleteFingerprintFromSdp=function(e,t){if(t)return e;for(;-1!==e.indexOf("a=fingerprint:");)e=e.replace(/(a=fingerprint:[\w\W]*?(:\r|\n))/,"");return e},this.deleteCryptoFromSdp=function(e,t){if(!t)return e;for(;-1!==e.indexOf("a=crypto:");)e=e.replace(/(a=crypto:[\w\W]*?(:\r|\n))/,"");return e},this.deleteCryptoZeroFromSdp=function(e){for(;-1!==e.indexOf("a=crypto:0");)e=e.replace(/(a=crypto:0[\w\W]*?(:\r|\n))/,"");return e},this.performVP8RTCPParameterWorkaround=function(e){var n,i,o,r;return-1===e.indexOf("VP8/90000")?e:(r=this.getVP8PayloadType(e),o=e.replace("a=rtcp-fb:"+r+" nack pli","a=rtcp-fb:"+r+" no_ack_pli"),o=o.replace("a=rtcp-fb:"+r+" nack","a=rtcp-fb:"+r+" none_ack"),n=e.split("VP8/90000"),n.length<=1?e:(i=n[0]+"VP8/90000",-1===e.indexOf("a=rtcp-fb:"+r+" ccm fir")&&(t.debug("performVP8RTCPParameterWorkaround : Adding a=rtcp-fb:"+r+" ccm fir"),i=i+"\r\na=rtcp-fb:"+r+" ccm fir"),-1===o.indexOf("a=rtcp-fb:"+r+" no_ack_pli")&&(t.debug("performVP8RTCPParameterWorkaround : Adding a=rtcp-fb:"+r+" nack pli"),i=i+"\r\na=rtcp-fb:"+r+" nack pli"),-1===o.indexOf("a=rtcp-fb:"+r+" none_ack")&&(t.debug("performVP8RTCPParameterWorkaround : Adding a=rtcp-fb:"+r+" nack"),i=i+"\r\na=rtcp-fb:"+r+" nack"),-1===e.indexOf("a=rtcp-fb:"+r+" goog-remb")&&(t.debug("performVP8RTCPParameterWorkaround : Adding a=rtcp-fb:"+r+" goog-remb"),i=i+"\r\na=rtcp-fb:"+r+" goog-remb"),e=i+n[1]))},this.updateAudioCodec=function(e){var t,o,r,a,s,c,d,l,u="",p="",f=[],E=/\r\n|\r|\n/m,S="",T=[];for(l="",f=e.split(/^(?=m=)/m),t=0;t<f.length;t++){if(p=f[t],this.isSdpHasAudio(p)){for(o=p.split(E),r=0;r<o.length;r++){if(a=o[r],a&&this.isSdpHasAudio(a)){if(T=C.codecsToRemove,void 0!==T)for(d=0;d<T.length;d++)s=T[d],c=new RegExp(" "+s,"g"),a=a.replace(c,""),0!==d&&(l+="|"),l+=s;a=a+i+n}else a&&-1!==a.indexOf("a=fmtp")?a=a.replace(/a=fmtp[\w\W]*/,""):a&&""!==a&&(a=a+i+n);S+=a}p=S}u+=p}return""!==l&&(c=new RegExp("a=rtpmap:(?:"+l+").*\r\n","g"),u=u.replace(c,"")),u},this.removeAudioCodec=function(e,t){var o,r,a,s,c,d,l="",u="",p=[],f=/\r\n|\r|\n/m,E="";for(p=e.split(/^(?=m=)/m),o=0;o<p.length;o++){if(u=p[o],this.isSdpHasAudio(u)){for(r=u.split(f),a=0;a<r.length;a++)s=r[a],s&&this.isSdpHasAudio(s)?(d=new RegExp(" "+t+"($| )","m"),c=r[a].split(/RTP[\w\W]*/),s=s.replace(/(\m=audio+)\s(\w+)/,""),s=s.trim(),s=s.replace(d," "),s=c[0]+s+i+n):s&&-1!==s.indexOf("a=fmtp:"+t)?s=s.replace(/a=fmtp[\w\W]*/,""):s&&-1!==s.indexOf("a=rtpmap:"+t)?s=s.replace(/a=rtpmap[\w\W]*/,""):s&&-1!==s.indexOf("a=rtcp-fb:"+t)?s=s.replace(/a=rtcp-fb[\w\W]*/,""):s&&""!==s&&(s=s+i+n),E+=s;u=E}l+=u}return l},this.removeRTXCodec=function(e){var n,i,o;return i=this.getVp8Ssrc(e),t.debug("vp8SSRC = "+i),o=this.getRtxSsrc(e),t.debug("rtxSSRC = "+o),e=this.removeSsrcId(e,o),e=e.replace(/(a=ssrc-group:FID[\w\W]*?(:\r|\n))/g,""),-1===e.indexOf("rtx/90000")?e:(n=this.getRTXPayloadType(e),t.debug("removeRTXCodec : Removing rtx video codec "+n),e=this.removeVideoCodec(e,n))},this.getVp8Ssrc=function(e){var n,i,o,r,a=/\r\n|\r|\n/m;if(-1===e.indexOf("a=ssrc-group:FID "))return-1;for(n=e.split("a=ssrc-group:FID "),i=n[1].split(a),o=i[0].split(" "),r=0;r<o.length;r++)t.debug("ssrcArray["+r+"] : "+o[r]);return o[0]},this.getRtxSsrc=function(e){var n,i,o,r,a=/\r\n|\r|\n/m;if(-1===e.indexOf("a=ssrc-group:FID "))return-1;for(n=e.split("a=ssrc-group:FID "),i=n[1].split(a),o=i[0].split(" "),r=0;r<o.length;r++)t.debug("ssrcArray["+r+"] : "+o[r]);return o[1]},this.removeSsrcId=function(e,t){var o,r,a,s="",c=/\r\n|\r|\n/m,d="";for(o=e.split(c),r=0;r<o.length;r++)a=o[r],a&&-1!==a.indexOf("a=ssrc:"+t)?a=a.replace(/a=ssrc:[\w\W]*/,""):a&&""!==a&&(a=a+i+n),d+=a;return s=d},this.removeG722Codec=function(e){return e},this.setMediaActPass=function(e,n){if(!n)return e;for(t.debug("setMediaActPass: ");-1!==e.indexOf("a=setup:active");)t.debug("a=setup:active to a=setup:actpass"),e=e.replace("a=setup:active","a=setup:actpass");for(;-1!==e.indexOf("a=setup:passive");)t.debug("a=setup:passive to a=setup:actpass"),e=e.replace("a=setup:passive","a=setup:actpass");return e},this.fixLocalTelephoneEventPayloadType=function(e,t){var n;return e.localTelephoneEvent8000PayloadType=this.getTelephoneEventCode(t,"8000",e.localTelephoneEvent8000PayloadType),e.localTelephoneEvent16000PayloadType=this.getTelephoneEventCode(t,"16000",e.localTelephoneEvent16000PayloadType),n=this.fixTelephoneEventPayloadType(t,"8000",e.localTelephoneEvent8000PayloadType),n=this.fixTelephoneEventPayloadType(n,"16000",e.localTelephoneEvent16000PayloadType)},this.fixRemoteTelephoneEventPayloadType=function(e,t){var n;return e.remoteTelephoneEvent8000PayloadType=this.getTelephoneEventCode(t,"8000",e.remoteTelephoneEvent8000PayloadType),e.remoteTelephoneEvent16000PayloadType=this.getTelephoneEventCode(t,"16000",e.remoteTelephoneEvent16000PayloadType),n=this.fixTelephoneEventPayloadType(t,"8000",e.remoteTelephoneEvent8000PayloadType),n=this.fixTelephoneEventPayloadType(n,"16000",e.remoteTelephoneEvent16000PayloadType)},this.getTelephoneEventCode=function(e,t,n){var i;return this.isSdpHasTelephoneEvent(e,t)?(i=this.getTelephoneEventPayloadType(e,t),n?n:i):null},this.fixTelephoneEventPayloadType=function(e,t,n){var i,o;if(this.isSdpHasTelephoneEvent(e,t))if(i=this.getTelephoneEventPayloadType(e,t),n){if(n!==i)return o=this.replaceTelephoneEventPayloadType(e,n,i);

}else n=i;return e},this.getTelephoneEventPayloadType=function(e,t){return this.getPayloadTypeOf("telephone-event/"+t,e)},this.getPayloadTypeOf=function(e,n){var i,o,r;return-1===n.indexOf(e)?-1:(i=n.split(e),o=i[0].split("a=rtpmap:"),r=o[o.length-1].split(" "),t.debug("getPayloadTypeOf("+e+") = "+r[0]),r[0])},this.replaceTelephoneEventPayloadType=function(e,n,i){var o,r,a,s,c,d,l,u="",p="";if(!e||-1===e.indexOf("telephone-event"))return e;if(r=/^\.*(a=rtpmap:)(\d*)( telephone-event[ \w+ ]*[ \/+ ]*[ \w+ ]*)\r\n?/m,n===i)return e;for(o=e,r=new RegExp("^\\.*a=rtpmap:"+i+" telephone-event[ \\/+ ]*([ \\w+ ]*)\\r\n","m"),a=o.match(r),p=null!==a&&a.length>=2&&""!==a[1]?a[1]:8e3,o=o.replace(r,"a=rtpmap:"+n+" telephone-event/"+p+"\r\n"),r=new RegExp("^\\.*(m=audio )[ \\w+ ]*[ \\/+ ]*[ \\w+ ]*( "+i+")","mg"),a=o.match(r),null!==a&&a.length>=1&&""!==a[0]&&(s=a[0],s=s.replace(i,n),o=o.replace(r,s)),c=o.split(/^(?=m=)/m),d=0;d<c.length;d++)l=c[d],this.isSdpHasAudio(l)&&(r=new RegExp("^\\.*a=fmtp:"+i,"mg"),l=l.replace(r,"a=fmtp:"+n)),u+=l;return""!==u&&(o=u),t.debug("replaceTelephoneEventPayloadType: newcode "+i+" is replaced with oldcode "+n),o},this.replaceOpusCodec=function(e){var n,i,o,r,a,s,c="",d=109,l="";if(!e||-1===e.indexOf("opus"))return e;for(n=/^\.*(a=rtpmap:)(\d*)( opus)/m,i=e.match(n),null!==i&&i.length>=3&&""!==i[2]?c=i[2]:t.warn("sdp has opus without codec number"),e=e.replace(n,"a=rtpmap:"+d+" opus"),n=new RegExp("^\\.*(m=audio )[ \\w+ ]*[ \\/+ ]*[ \\w+ ]*( "+c+")","mg"),i=e.match(n),null!==i&&i.length>=1&&""!==i[0]&&(o=i[0],o=o.replace(c,d),e=e.replace(n,o)),r=e.split(/^(?=m=)/m),a=0;a<r.length;a++)s=r[a],this.isSdpHasAudio(s)&&(n=new RegExp("^\\.*a=fmtp:"+c,"mg"),s=s.replace(n,"a=fmtp:"+d)),l+=s;return""!==l&&(e=l),t.debug("replaceOpusCodec: new codec= "+d),e},this.getG7228000PayloadType=function(e){return this.getPayloadTypeOf("G722/8000",e)},this.getVP8PayloadType=function(e){return this.getPayloadTypeOf("VP8/90000",e)},this.getG72216000PayloadType=function(e){return this.getPayloadTypeOf("G722/16000",e)},this.getRTXPayloadType=function(e){return this.getPayloadTypeOf("rtx/90000",e)},this.isSdpHasTelephoneEvent=function(e,t){return-1!==e.indexOf("telephone-event/"+t)},this.isSdpHasVP8Codec=function(e){return-1!==e.indexOf("VP8/90000")},this.performG722ParameterWorkaround=function(e){return e},this.checkSupportedVideoCodecs=function(e,t){var n;return this.isVideoCodecsSupported(e)?e:(t?(n=this.removeAllVideoCodecs(e),n=this.addVP8Codec(n,t),n=this.updateSdpVideoPort(n,!1),n=this.performVideoPortZeroWorkaround(n)):this.isSdpHasVP8Codec(e)?n=this.removeVideoDescription(e):-1!==e.indexOf(f.SDP.M_LINE+f.STRING.VIDEO+" 0 ",0)?n=this.addVP8Codec(e,n):(n=this.updateSdpVideoPort(e,!1),n=this.addVP8Codec(n,n)),n)},this.isVideoCodecsSupported=function(e){return this.isSdpHasVP8Codec(e)?!0:!1},this.removeAllVideoCodecs=function(e){var n,i,o,r,a;if(n=new RegExp("^\\.*(m=video )(\\d*)( RTP/SAVPF )([ \\w+ ]*[ \\/+ ]*[ \\w+ ])\\r\n","m"),r=e,i=r.match(n),null!==i&&i.length>=5&&""!==i[0])for(o=i[4].split(" "),a=0;a<o.length;a++)t.debug("codec["+a+"] : "+o[a]),r=this.removeVideoCodec(r,o[a]);return r},this.removeVideoCodec=function(e,t){var o,r,a,s,c,d="",l="",u=[],p=/\r\n|\r|\n/m,f="";for(u=e.split(/^(?=m=)/m),o=0;o<u.length;o++){if(l=u[o],this.isSdpHasVideo(l)){for(r=l.split(p),a=0;a<r.length;a++)s=r[a],s&&this.isSdpHasVideo(s)?(c=new RegExp(" "+t,"g"),s=s.replace(c,""),s=s+i+n):s&&-1!==s.indexOf("a=fmtp:"+t)?s=s.replace(/a=fmtp[\w\W]*/,""):s&&-1!==s.indexOf("a=rtpmap:"+t)?s=s.replace(/a=rtpmap[\w\W]*/,""):s&&-1!==s.indexOf("a=rtcp-fb:"+t)?s=s.replace(/a=rtcp-fb[\w\W]*/,""):s&&""!==s&&(s=s+i+n),f+=s;l=f}d+=l}return d},this.addVP8Codec=function(e,t){var o,r,a,s,c,d,l,u,p,E,S="",T="",m=[],g=/\r\n|\r|\n/m,C="";if(this.isSdpHasVP8Codec(e))return e;for(m=e.split(/^(?=m=)/m),o=0;o<m.length;o++){if(T=m[o],this.isSdpHasVideo(T)){if(t&&this.isSdpHasVideo(t)&&this.isSdpHasVP8Codec(t))s=this.getVP8PayloadType(t),-1!==T.indexOf("a=rtpmap:"+s)&&this.removeSdpLineContainingText(T,"a=rtpmap:"+s);else{for(c=100;-1!==T.indexOf("a=rtpmap:"+c);)c+=1;s=c}for(r=T.split(g),a=0;a<r.length;a++)d=r[a],d&&this.isSdpHasVideo(d)?(-1===d.indexOf(s)&&(d=d+" "+s),d=d+i+n+"a=rtpmap:"+s+" VP8/90000"+i+n):d&&""!==d&&(d=d+i+n),C+=d;T=C}S+=T}return l=this.checkICEParams(S,"video",f.SDP.ICE_UFRAG),2>l&&(p=this.getICEParams(S,f.SDP.ICE_UFRAG,!1),p&&(S=this.restoreICEParams(S,"video",f.SDP.ICE_UFRAG,p))),u=this.checkICEParams(S,"video",f.SDP.ICE_PWD),2>u&&(E=this.getICEParams(S,f.SDP.ICE_PWD,!1),E&&(S=this.restoreICEParams(S,"video",f.SDP.ICE_PWD,E))),this.performVP8RTCPParameterWorkaround(S)},this.removeSdpLineContainingText=function(e,i){var o,r=e.split(n);for(e=r[0]+n,o=1;o<r.length-1;o++)-1!==r[o].indexOf(i)?t.debug("removed line which contains "+i):e+=r[o]+n;return e},this.removeVideoDescription=function(e){var n,i="",o="",r=[];for(r=e.split(/^(?=m=)/m),n=0;n<r.length;n++)o=r[n],this.isSdpHasVideo(o)?t.debug("removeVideoDescription : m=video description removed"):i+=o;return i},this.updateSdpVideoPort=function(e,n){var i,o;return t.debug("updateSdpVideoPort: status= "+n),i=e,n?o=f.SDP.M_LINE+f.STRING.VIDEO+" 1":(o=f.SDP.M_LINE+f.STRING.VIDEO+" 0",i=this.updateSdpDirection(i,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.INACTIVE)),this.isSdpHasVideo(i)&&(i=i.replace(/m=video [0-9]+/,o)),i},this.performVideoPortZeroWorkaround=function(e){return this.isSdpHasVideoWithZeroPort(e)?(e=this.addSdpMissingCryptoLine(e),e=this.replaceZeroVideoPortWithOne(e),e=this.updateVideoSdpDirectionToInactive(e)):e},this.addSdpMissingCryptoLine=function(e){var n,i,o,r=null,a=/\r\n|\r|\n/m;if(-1===e.indexOf(f.SDP.M_LINE+f.STRING.VIDEO+" 0 ",0))return e;for(n=e.split(f.SDP.M_LINE+f.STRING.VIDEO),i=n[0].split(a),o=0;o<i.length;o++)if(-1!==i[o].indexOf(f.SDP.A_LINE+f.SDP.CRYPTO)||-1!==i[o].indexOf(f.SDP.A_LINE+f.SDP.FINGERPRINT)){r=i[o];break}return null===r?e:(-1!==n[0].indexOf(f.SDP.A_LINE+f.SDP.CRYPTO)?-1===n[1].indexOf(f.SDP.A_LINE+f.SDP.CRYPTO,0)&&(n[1]+=r+"\n",t.debug("addSdpMissingCryptoLine : crypto line is added : "+r)):-1!==n[0].indexOf(f.SDP.A_LINE+f.SDP.FINGERPRINT,0)&&-1===n[1].indexOf(f.SDP.A_LINE+f.SDP.FINGERPRINT,0)&&(n[1]+=r+"\na=setup:passive\n",t.debug("addSdpMissingCryptoLine : dtls lines are added : "+r+"and a=setup:passive"),t.debug("dtls enabled: known issue by webrtc may be fixed! Check it")),e=n.join(f.SDP.M_LINE+f.STRING.VIDEO))},this.checkICEParams=function(e,t,n){var i,o;if(i=e.split("m=video"),i.length<2)return 0;switch(n){case f.SDP.ICE_UFRAG:o="audio"===t?i[0].split("a=ice-ufrag:"):i[1].split("a=ice-ufrag:");break;case f.SDP.ICE_PWD:o="audio"===t?i[0].split("a=ice-pwd:"):i[1].split("a=ice-pwd:");break;default:return 0}return o.length},this.getICEParams=function(e,t,n){var i,o,r,a;switch(t){case f.SDP.ICE_UFRAG:i=e.split("a=ice-ufrag:");break;case f.SDP.ICE_PWD:i=e.split("a=ice-pwd:");break;default:return void 0}return n?void 0!==i[2]?(o=i[2],r=o.split("a="),a=r[0]):void 0:void 0!==i[1]?(o=i[1],r=o.split("a="),a=r[0]):void 0},this.restoreICEParams=function(e,t,n,i){var o,r,a,s="";if(a=e.split("m=video"),a.length<2)return e;for(r=0;r<a.length;r++)o=a[r],0===r&&("audio"===t&&(o=o+"a="+n+i),s+=o),1===r&&("video"===t&&(o=o+"a="+n+i),s=s+"m=video"+o);return s},this.updateICEParams=function(e,t,n){var i,o,r,a,s,c,d="",l="";switch(t){case f.SDP.ICE_UFRAG:a=e.split("a=ice-ufrag:");break;case f.SDP.ICE_PWD:a=e.split("a=ice-pwd:");break;default:return e}for(o=0;o<a.length;o++)if(i=a[o],2===o){for(s=i.split("a="),r=0;r<s.length;r++)c=s[r],0===r?(s[r]=n,l+=s[r]):l=l+"a="+s[r];i=l,d+=i}else d=d+i+"a="+t;return d},this.checkIceParamsLengths=function(e,t){var n,i;return n=this.getICEParams(e,f.SDP.ICE_UFRAG,!0),i=this.getICEParams(e,f.SDP.ICE_PWD,!0),n&&n.length<4&&(n=this.getICEParams(t,f.SDP.ICE_UFRAG,!0),n&&(e=this.updateICEParams(e,f.SDP.ICE_UFRAG,n))),i&&i.length<22&&(i=this.getICEParams(t,f.SDP.ICE_PWD,!0),22>i&&(e=this.updateICEParams(e,f.SDP.ICE_PWD,i))),e},this.isSdpVideoSendEnabled=function(e){var n,i="isSdpVideoSendEnabled: ",o=!1;return this.isSdpEnabled(e,f.STRING.VIDEO)?(n=this.getSdpDirectionLogging(e,f.STRING.VIDEO,!1),n===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE||n===f.WEBRTC.MEDIA_STATE.SEND_ONLY?(o=!0,t.debug(i+o),o):(t.debug(i+o),o)):(t.debug(i+o),o)},this.getSdpDirectionLogging=function(e,n,i){var o,r,a="",s=[],c=f.WEBRTC.MEDIA_STATE.INACTIVE;if(r=function(e){i&&t.debug("getSdpDirection: type= "+n+" state= "+e)},-1===e.indexOf(f.SDP.M_LINE+n))return r(c),c;if(-1!==e.indexOf(f.SDP.M_LINE+n+" 0"))return r(c),c;for(s=e.split(/^(?=m=)/m),o=0;o<s.length;o++)if(a=s[o],-1!==a.indexOf(f.SDP.M_LINE+n))return-1!==a.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.SEND_RECEIVE)?(c=f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,r(c),c):-1!==a.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.SEND_ONLY)?(c=f.WEBRTC.MEDIA_STATE.SEND_ONLY,r(c),c):-1!==a.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)?(c=f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,r(c),c):-1!==a.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.INACTIVE)?(r(c),c):c=f.WEBRTC.MEDIA_STATE.SEND_RECEIVE;return c=f.WEBRTC.MEDIA_STATE.NOT_FOUND,r(c),c},this.deleteInactiveVideoSsrc=function(e){var t=[];return this.isSdpHas(e,f.STRING.VIDEO)?(t=e.split(f.SDP.M_LINE+f.STRING.VIDEO),null!==t[1]&&(t[1]=this.deleteSsrcFromSdp(t[1])),t[0]+f.SDP.M_LINE+f.STRING.VIDEO+t[1]):e},this.deleteSsrcFromSdp=function(e){for(;-1!==e.indexOf("a=ssrc");)e=e.replace(/(a=ssrc[\w\W]*?(:\r|\n))/,"");return e},this.setMediaPassive=function(e,n){if(!n)return e;for(t.debug("setMediaPassive: ");-1!==e.indexOf("a=setup:actpass");)t.debug("a=setup:actpass to a=setup:passive"),e=e.replace("a=setup:actpass","a=setup:passive");return e},this.removeSdpPli=function(e){var i,o=e.split(n);for(e=o[0]+n,i=1;i<o.length-1;i++)o[i-1]===o[i]&&-1!==o[i].indexOf(f.SDP.NACKPLI)?t.debug("removed extra nack pli line"):e+=o[i]+n;return e},this.performVP8BandwidthWorkaround=function(e){return this.isSdpHasVP8Codec(e)?(-1!==e.indexOf("b=AS:0")&&(t.debug("performVP8BandwidthWorkaround : Removing b=AS:0"),e=this.removeSdpLineContainingText(e,"b=AS:0")),e):e},this.checkAndRestoreICEParams=function(e,t){var n,i,o,r,a,s;return n=this.checkICEParams(e,f.STRING.AUDIO,f.SDP.ICE_UFRAG),2>n&&(a=this.getICEParams(t,f.SDP.ICE_UFRAG,!1),a&&(e=this.restoreICEParams(e,f.STRING.AUDIO,f.SDP.ICE_UFRAG,a))),i=this.checkICEParams(e,f.STRING.AUDIO,f.SDP.ICE_PWD),2>i&&(s=this.getICEParams(t,f.SDP.ICE_PWD,!1),s&&(e=this.restoreICEParams(e,f.STRING.AUDIO,f.SDP.ICE_PWD,s))),o=this.checkICEParams(e,f.STRING.VIDEO,f.SDP.ICE_UFRAG),2>o&&(a=this.getICEParams(t,f.SDP.ICE_UFRAG,!1),a&&(e=this.restoreICEParams(e,f.STRING.VIDEO,f.SDP.ICE_UFRAG,a))),r=this.checkICEParams(e,f.STRING.VIDEO,f.SDP.ICE_PWD),2>r&&(s=this.getICEParams(t,f.SDP.ICE_PWD,!1),s&&(e=this.restoreICEParams(e,f.STRING.VIDEO,f.SDP.ICE_PWD,s))),e},this.incrementVersion=function(e){var n,i,o,r=[],a="",s=[];for(t.debug(" incrementVersion"),r=e.match("o=(?:.+?[\\s.,;]+){2}([^\\s.,;]+)"),i=r[1],i=+i,i+=1,s=r[0].split(" "),s[s.length-1]=i,n=0;n<s.length;n++)0!==n&&(a+=" "),a+=s[n];return o=new RegExp(r[0],"g"),e=e.replace(o,a)},this.escalateSdpDirection=function(e,n){var i=this.getSdpDirectionLogging(e,n,!1);return t.debug("escalateSdpDirection: type= "+n+" direction= "+i),i===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY?this.changeDirection(e,i,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,n):i===f.WEBRTC.MEDIA_STATE.INACTIVE?this.changeDirection(e,i,f.WEBRTC.MEDIA_STATE.SEND_ONLY,n):e},this.deescalateSdpDirection=function(e,n){var i=this.getSdpDirectionLogging(e,n,!1);return t.debug("deescalateSdpDirection: type= "+n+" direction= "+i),i===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE?this.changeDirection(e,i,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,n):i===f.WEBRTC.MEDIA_STATE.SEND_ONLY?this.changeDirection(e,i,f.WEBRTC.MEDIA_STATE.INACTIVE,n):e},this.isIceLite=function(e){return e&&-1!==e.indexOf("a=ice-lite")?!0:!1},this.updateVersion=function(e,n){var i,o,r,a=[],s=[],c="",d=[];if(t.debug(" updateVersion called..."),a=e.match("o=(?:.+?[\\s.,;]+){2}([^\\s.,;]+)"),s=n.match("o=(?:.+?[\\s.,;]+){2}([^\\s.,;]+)"),!a)return t.warn("updateVersion called with wrong fromSdp!!"),n;for(o=a[1],o=+o,o+=1,t.debug(" updateVersion fromVersion incremented: "+o),d=s[0].split(" "),d[d.length-1]=o,i=0;i<d.length;i++)0!==i&&(c+=" "),c+=d[i];return r=new RegExp(s[0],"g"),n=n.replace(r,c)},this.copyCandidatesToTheNewLocalSdp=function(e,t){var n,i,o,r,a=[],s=[];return a=e.split(f.SDP.M_LINE+f.STRING.VIDEO),s=t.split(f.SDP.M_LINE+f.STRING.VIDEO),o=a[0],n=void 0!==a[1]?f.SDP.M_LINE+f.STRING.VIDEO+a[1]:void 0,r=s[0],i=void 0!==s[1]?f.SDP.M_LINE+f.STRING.VIDEO+s[1]:void 0,r=this.copyCandidates(o,r),void 0!==n&&void 0!==i&&(i=this.copyCandidates(n,i)),void 0!==i?r+i:r},this.copyCandidates=function(e,t){var n,i,o,r=/\r\n|\r|\n/m;for(n=e.split(r),i=0;i<n.length;i++)-1!==n[i].indexOf("a=candidate")&&t.indexOf(!1)?t+=n[i]+"\r\n":-1!==n[i].indexOf("c=IN")&&t.indexOf(!0)?t=t.replace(/(c=[\w\W]*?(:\r|\n))/,n[i]+"\r\n"):-1===n[i].indexOf("m=audio")||-1===t.indexOf(f.SDP.M_LINE+f.STRING.AUDIO+" 1 ")&&-1===t.indexOf(f.SDP.M_LINE+f.STRING.AUDIO+" 9 ")?-1===n[i].indexOf("m=video")||-1===t.indexOf(f.SDP.M_LINE+f.STRING.VIDEO+" 1 ")&&-1===t.indexOf(f.SDP.M_LINE+f.STRING.VIDEO+" 9 ")||(o=n[i].split(" ")[1],t=t.replace(/m=video \d/,f.SDP.M_LINE+f.STRING.VIDEO+" "+o)):(o=n[i].split(" ")[1],t=t.replace(/m=audio \d/,f.SDP.M_LINE+f.STRING.AUDIO+" "+o));return t},this.getSdpFromObject=function(e){var t;return t=e.sdp,t=this.updateAudioSdpDirection(t,e.audioDirection),t=this.updateVideoSdpDirection(t,e.videoDirection)},this.deleteGoogleIceFromSdp=function(e){return e=e.replace(/(a=ice-options:google-ice[\w\W]*?(:\r|\n))/g,"")},this.respondToRemoteSdpDirections=function(e,t){return e=this.respondToRemoteMediaSdpDirection(e,t,f.STRING.AUDIO),e=this.respondToRemoteMediaSdpDirection(e,t,f.STRING.VIDEO)},this.respondToRemoteMediaSdpDirection=function(e,n,i){var o;return this.isSdpHas(n,i)&&(o=this.getSdpDirection(n,i),o===f.WEBRTC.MEDIA_STATE.SEND_ONLY?(t.debug(i+" sendonly -> recvonly"),e=this.updateSdpDirection(e,i,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)):o===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY?(t.debug(i+" recvonly -> sendonly"),e=this.updateSdpDirection(e,i,f.WEBRTC.MEDIA_STATE.SEND_ONLY)):o===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE?(t.debug(i+" sendrecv -> sendrecv"),e=this.updateSdpDirection(e,i,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE)):o===f.WEBRTC.MEDIA_STATE.INACTIVE&&(t.debug(i+" inactive -> inactive"),e=this.updateSdpDirection(e,i,f.WEBRTC.MEDIA_STATE.INACTIVE))),e},this.isMediaPortReady=function(e){if(!this.isSdpHasAudioWithOnePort(e)&&!this.isSdpHasAudioWithNinePort(e)){if(!this.isSdpHasVideo(e))return!0;if(!this.isSdpHasVideoWithOnePort(e)&&!this.isSdpHasVideoWithNinePort(e))return!0}return!1},this.deleteFingerprintOrCrypto=function(e,t){return e?-1===e.indexOf("a=crypto:")||-1===e.indexOf("a=fingerprint:")?e:(e=this.deleteCryptoFromSdp(e,t),e=this.deleteFingerprintFromSdp(e,t)):e}},M=new V;l&&(l.SDPParser=V);var F=function(){var e="/rest/version/latest/isAlive";this.checkConnectivity=function(t,n){g.sendGetRequest({url:c()+e+"?"+P.getTimestamp()},t,n)}},w=new F,k=function(){function e(){a.info("check connectivity timer is stopped."),clearInterval(r)}function t(){l||(l=!0,s(l),a.trace("Connectivity re-established..."),p.publish(f.EVENT.CONNECTION_REESTABLISHED))}function n(){l&&(l=!1,s(l),a.trace("Connectivity is lost..."),p.publish(f.EVENT.CONNECTION_LOST))}function i(){try{u()}catch(e){a.trace("Exception occured while executing connecitivy handler: ",e)}w.checkConnectivity(t,n)}function o(t){var n=d,o=t.connectivity?t.connectivity.handler:null,a=t.connectivity?t.connectivity.interval:null;o&&"function"==typeof o&&(u=o),a&&(n=a),e(),r=setInterval(i,n)}var r,a=O.getLogger("connectivityManager"),c=1,d=1e4,l=!0,u=null;p.subscribe(f.EVENT.DEVICE_SUBSCRIPTION_STARTED,o,c),p.subscribe(f.EVENT.DEVICE_SUBSCRIPTION_ENDED,e,c),p.subscribe(f.EVENT.XHR_REQUEST_NOT_INITIALIZED,n,c)},W=(new k,function(){var e,t,n=this,i=!1,o="",r={video:"",localVideo:"",remoteVideo:"",defaultVideo:""},a={audio:!1,video:!1},s={video:{available:!1,width:"320",height:"240"},audio:{available:!1}},c=!1,d={},l=4,u=0,p=!1,f=!1;n.getH264Enabled=function(){return f},n.setH264Enabled=function(e){f=e},n.getIceServerUrl=function(){return o},n.setIceServerUrl=function(e){o=e},n.isDtlsEnabled=function(){return i},n.setDtlsEnabled=function(e){i=e},n.getVideoContainer=function(){return r.video},n.setVideoContainer=function(e){r.video=e},n.getLocalVideoContainer=function(){return r.localVideo},n.setLocalVideoContainer=function(e){r.localVideo=e},n.getRemoteVideoContainer=function(){return r.remoteVideo},n.setRemoteVideoContainer=function(e){r.remoteVideo=e},n.getDefaultVideoContainer=function(){return r.defaultVideo},n.setDefaultVideoContainer=function(e){r.defaultVideo=e},n.isInitialized=function(){return c},n.setInitialized=function(e){c=e===!0?!0:!1},n.getRtcLibrary=function(){return d},n.setRtcLibrary=function(e){d=e},n.getLocalStream=function(){return t},n.setLocalStream=function(e){t=e},n.getLogLevel=function(){return l},n.setLogLevel=function(e){l=e},n.getLanguage=function(){return e},n.setLanguage=function(t){e=t},n.getMediaAudio=function(){return a.audio},n.setMediaAudio=function(e){a.audio=e},n.getMediaVideo=function(){return a.video},n.setMediaVideo=function(e){a.video=e},n.getVideoWidth=function(){return s.video.width},n.setVideoWidth=function(e){s.video.width=e},n.getVideoHeight=function(){return s.video.height},n.setVideoHeight=function(e){s.video.height=e},n.getVideoSourceAvailable=function(){return s.video.available},n.setVideoSourceAvailable=function(e){s.video.available=e},n.getAudioSourceAvailable=function(){return s.audio.available},n.setAudioSourceAvailable=function(e){s.audio.available=e},n.getPeerCount=function(){return u},n.setPeerCount=function(e){u=e},n.isPluginEnabled=function(){return p},n.setPluginEnabled=function(e){p=e}});l&&(l.WebRtcAdaptorModel=W);var U=function(){};U.prototype=new W,l&&(l.WebRtcChromeAdaptorModel=U);var x=function(){};x.prototype=new W,l&&(l.WebRtcFirefoxAdaptorModel=x);var H=function(){var e=this,t={major:0,minor:0,min_revision:0,min_build:0,current_revision:0,current_build:0};e.getPluginVersion=function(){return t},e.setPluginVersion=function(e){t=e}};H.prototype=new W,l&&(l.WebRtcPluginAdaptorModel=H);var B=function(e,t){var n={};return n.getUserMedia=e.getUserMedia,n.showSettingsWindow=e.showSettingsWindow,n.getURLFromStream=e.getURLFromStream,n.createRTCSessionDescription=function(t,n){return e.createSessionDescription(t,n)},n.createRTCIceCandidate=function(t,n,i){return e.createIceCandidate(t,n,i)},n.createRTCPeerConnection=function(t,n){return e.createPeerConnection(t,n)},n.setLang=function(t){e.language=t||"en"},n.checkMediaSourceAvailability=function(t){P.callFunctionIfExist(t,{videoSourceAvailable:e.getVideoDeviceNames().length>0?!0:!1,audioSourceAvailable:e.getAudioOutDeviceNames().length>0?!0:!1})},n.get_audioInDeviceCount=function(){return e.getAudioInDeviceNames().length},n.get_audioOutDeviceCount=function(){return e.getAudioOutDeviceNames().length},n.get_videoDeviceCount=function(){return e.getVideoDeviceNames().length},n.set_logSeverityLevel=function(t){return e.logSeverityLevel=t,!0},n.get_logSeverityLevel=function(){return e.logSeverityLevel},n.setType=function(t){e.type=t},n.getType=function(){return e.type},n.getVersion=function(){return e.version},n.getCurrentPluginVersionObject=function(){var t,n=e.version.split(".");return t={major:parseInt(n[0],10),minor:parseInt(n[1],10),revision:parseInt(n[2],10),build:parseInt(n[3],10)}},n},G=function(e,t){return B(e||{},t)};l&&(l.webRtcLibraryDecorator=G);var Y=function(e,t,n,i){t(e),e.getUserMedia=function(e,t,n){i.mozGetUserMedia(e,t,n)},e.showSettingsWindow=function(){},e.createRTCSessionDescription=function(e,t){return new n.mozRTCSessionDescription({type:e,sdp:t})},e.createRTCIceCandidate=function(e){return new n.mozRTCIceCandidate(e)},e.getURLFromStream=function(e){return n.URL.createObjectURL(e)},e.createRTCPeerConnection=function(e,t){return new n.mozRTCPeerConnection(e,t)},e.checkMediaSourceAvailability=function(e){var t=!0,n=!0;P.callFunctionIfExist(e,{videoSourceAvailable:t,audioSourceAvailable:n})},e.get_audioInDeviceCount=function(){return 1},e.get_audioOutDeviceCount=function(){return 1},e.get_videoDeviceCount=function(){return 1},e.set_logSeverityLevel=function(){return!1},e.get_logSeverityLevel=function(){}},j=function(e,t,n,i){Y(e||{},t||G,n||window,i||navigator)};l&&(l.webRtcLibraryFirefoxDecorator=j);var J=function(e,t,n,i){t(e),e.getUserMedia=function(e,t,n){i.webkitGetUserMedia(e,t,n)},e.showSettingsWindow=function(){},e.createRTCSessionDescription=function(e,t){return new n.RTCSessionDescription({type:e,sdp:t})},e.createRTCIceCandidate=function(e){return new n.RTCIceCandidate(e)},e.getURLFromStream=function(e){return n.URL.createObjectURL(e)},e.createRTCPeerConnection=function(e,t){return new n.webkitRTCPeerConnection(e,t)},e.checkMediaSourceAvailability=function(e){var t,i,o,r;i=n.MediaStreamTrack,"undefined"!=typeof i&&i.getSources(function(n){for(t=0;t<n.length;t++)"video"===n[t].kind?o=!0:"audio"===n[t].kind&&(r=!0);P.callFunctionIfExist(e,{videoSourceAvailable:o,audioSourceAvailable:r})})},e.get_audioInDeviceCount=function(){return 1},e.get_audioOutDeviceCount=function(){return 1},e.get_videoDeviceCount=function(){return 1},e.set_logSeverityLevel=function(){return!1},e.get_logSeverityLevel=function(){}},q=function(e,t,n,i){J(e||{},t||G,n||window,i||navigator)};l&&(l.webRtcLibraryChromeDecorator=q);var K=function(e,t,n,i){var o=this,r=i.getLogger("WebRtcAdaptorImpl");r.debug("WebRtcAdaptor initializing"),P.compose(n,o),o.performReconnectWorkaround=function(e,t,n){var i,a,s,c,d=e.peer;r.debug("performReconnectWorkaround:"+e.id),i=M.deleteGoogleIceFromSdp(d.localDescription.sdp),s=M.getAudioSdpDirection(i),c=M.getVideoSdpDirection(i),o.createNewPeerForCall(e)&&(d=e.peer),d.createOffer(function(t){t.sdp=M.updateAudioSdpDirection(t.sdp,s),t.sdp=M.updateVideoSdpDirection(t.sdp,c),t.sdp=M.deleteCryptoZeroFromSdp(t.sdp),t.sdp=M.performVP8RTCPParameterWorkaround(t.sdp),t.sdp=M.updateAudioCodec(t.sdp),t.sdp=M.removeG722Codec(t.sdp),t.sdp=M.deleteCryptoFromSdp(t.sdp,o.isDtlsEnabled()),t.sdp=M.setMediaActPass(t.sdp,o.isDtlsEnabled()),t.sdp=M.fixLocalTelephoneEventPayloadType(e,t.sdp),t.sdp=M.replaceOpusCodec(t.sdp),t.sdp=M.updateVersion(i,t.sdp),a=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,t.sdp),d.setLocalDescription(a,function(){r.debug("performReconnectWorkaround: setLocalDescription success"+e.id)},function(t){r.debug("performReconnectWorkaround: setLocalDescription failed!!"+t+e.id),P.callFunctionIfExist(n)})},function(e){r.error("performReconnectWorkaround: createOffer failed!! "+e),P.callFunctionIfExist(n)},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},o.getLocalAudioTrack=function(e){r.debug("getLocalAudioTrack");var t;if(e.localStreams&&e.localStreams[0].audioTracks){if(e.localStreams[0].audioTracks.length>0)return e.localStreams[0].audioTracks[0]}else if(e.getLocalStreams&&(t=e.getLocalStreams()[0].getAudioTracks(),t&&t.length>0))return t[0];return null},o.getLocalVideoTrack=function(e){r.debug("getLocalVideoTrack");var t;if(e.localStreams&&e.localStreams[0].videoTracks){if(e.localStreams[0].videoTracks.length>0)return e.localStreams[0].videoTracks[0]}else if(e.getLocalStreams&&(t=e.getLocalStreams(),t&&t[0].getVideoTracks()&&t[0].getVideoTracks().length>0))return t[0].getVideoTracks()[0];return null},o.muteOnHold=function(e,t){var n,i;return r.info("Mute on Hold called, mute="+t),o.isInitialized()?void(e.peer&&(n=o.getLocalAudioTrack(e.peer),n&&(n.enabled=!t,e.audioMuted=t),i=o.getLocalVideoTrack(e.peer),i&&(i.enabled=!t,e.videoMuted=t))):void r.warn("Plugin is not installed")},o.performOrigAudioWorkaround=function(e,t,n){r.debug("Workaround for orig side to hear audio"),e.sdp=M.setMediaPassive(e.sdp,o.isDtlsEnabled()),e.peer.setRemoteDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),function(){r.debug("performNativeOrigAudioWorkaround: setRemoteDescription success"),P.callFunctionIfExist(t)},function(e){r.debug("performNativeOrigAudioWorkaround: setRemoteDescription failed: "+e),P.callFunctionIfExist(n)})},o.restoreActualSdp=function(e,t,n,i,a){r.debug("Restore manipulated local and remote sdp's");var s=e.peer.localDescription.sdp;s=M.updateSdpDirection(s,f.STRING.VIDEO,i),s=M.setMediaActPass(s,o.isDtlsEnabled()),e.sdp=M.setMediaPassive(e.sdp,o.isDtlsEnabled()),s=M.fixLocalTelephoneEventPayloadType(e,s),e.peer.setLocalDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,s),function(){r.debug("restoreNativeActualSdp: setLocalDescription success"),e.sdp=M.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY,a,f.STRING.VIDEO),e.sdp=M.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.VIDEO),fe.callSetReceiveVideo(e),e.peer.setRemoteDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),function(){r.debug("restoreNativeActualSdp: setRemoteDescription success"),P.callFunctionIfExist(t)},function(e){r.debug("restoreNativeActualSdp: setRemoteDescription failed: "+e),P.callFunctionIfExist(n)})},function(e){r.debug("restoreNativeActualSdp: setLocalDescription failed: "+e),P.callFunctionIfExist(n)})},o.setMediaSources=function(e){e&&(o.setVideoSourceAvailable(e.videoSourceAvailable),o.setAudioSourceAvailable(e.audioSourceAvailable))},o.initMedia=function(e,n,i){o.setInitialized(!0),t(o.getRtcLibrary()),o.getRtcLibrary().checkMediaSourceAvailability(function(e){o.setMediaSources(e)}),i&&(i.localVideoContainer&&o.setLocalVideoContainer(i.localVideoContainer),i.remoteVideoContainer&&o.setRemoteVideoContainer(i.remoteVideoContainer),i.videoContainer&&o.setDefaultVideoContainer(i.videoContainer)),e()},o.addCandidates=function(e){var t,n,i,r,a,s,c="",d="",l=/\r\n|\r|\n/;if(t=e.sdp.indexOf(f.SDP.M_LINE+f.STRING.AUDIO,0),n=e.sdp.indexOf(f.SDP.M_LINE+f.STRING.VIDEO,0),-1!==t&&-1!==n?n>t?(c=e.sdp.substring(t,n),d=e.sdp.substring(n)):(d=e.sdp.substring(n,t),c=e.sdp.substring(t)):-1!==t?c=e.sdp.substring(t):-1!==n&&(d=e.sdp.substring(n)),""!==c&&(i=c.indexOf("a=candidate",0),-1!==i))for(c=c.substring(i),a=c.split(l),s=0;a[s]&&-1!==a[s].indexOf("a=candidate");)r=o.getRtcLibrary().createRTCIceCandidate({sdpMLineIndex:0,candidate:a[s]}),e.peer.addIceCandidate(r),s++;if(""!==d&&(i=d.indexOf("a=candidate",0),-1!==i))for(d=d.substring(i),a=d.split(l),s=0;a[s]&&-1!==a[s].indexOf("a=candidate");)r=o.getRtcLibrary().createRTCIceCandidate({sdpMLineIndex:1,candidate:a[s]}),e.peer.addIceCandidate(r),s++},o.performVideoStartWorkaround=function(e,t,n){var i,a,s,c=e.peer;r.debug("Workaround to play video"),e.sdp=M.addSdpMissingCryptoLine(e.sdp),i=M.getAudioSdpDirection(e.sdp),a=M.getVideoSdpDirection(e.sdp),e.sdp=M.updateAudioSdpDirectionToInactive(e.sdp),e.sdp=M.updateVideoSdpDirectionToInactive(e.sdp),e.sdp=M.setMediaActPass(e.sdp,o.isDtlsEnabled()),s=M.deleteSsrcFromSdp(e.sdp),c.setRemoteDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,s),function(){r.debug("performVideoStartWorkaround: first setRemoteDescription success"),e.sdp=M.updateAudioSdpDirection(e.sdp,i),e.sdp=M.updateVideoSdpDirection(e.sdp,a),c.setRemoteDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),function(){r.debug("performVideoStartWorkaround: second setRemoteDescription success"),c.createAnswer(function(s){i===f.WEBRTC.MEDIA_STATE.INACTIVE&&(s.sdp=M.updateAudioSdpDirectionToInactive(s.sdp)),s.sdp=a===f.WEBRTC.MEDIA_STATE.INACTIVE?M.updateVideoSdpDirectionToInactive(s.sdp):fe.callCanLocalSendVideo(e)?M.updateVideoSdpDirection(s.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):M.updateVideoSdpDirection(s.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),s.sdp=M.performVP8RTCPParameterWorkaround(s.sdp),o.fireOnStreamAddedEvent(e),s.sdp=M.checkAndRestoreICEParams(s.sdp,e.sdp),s.sdp=M.setMediaPassive(s.sdp,o.isDtlsEnabled()),s.sdp=M.fixLocalTelephoneEventPayloadType(e,s.sdp),c.setLocalDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,s.sdp),function(){r.debug("performVideoStartWorkaround: setlocalDescription success"),P.callFunctionIfExist(t)},function(e){r.debug("performVideoStartWorkaround: setlocalDescription failed!!"+e),P.callFunctionIfExist(n,"performVideoStartWorkaround: setlocalDescription failed!!")})},function(e){r.debug("performVideoStartWorkaround: createAnswer failed!! "+e),P.callFunctionIfExist(n,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},function(e){r.debug("performVideoStartWorkaround: second setRemoteDescription failed!!"+e),P.callFunctionIfExist(n,"performVideoStartWorkaround: second setRemoteDescription failed!!")})},function(e){r.debug("performVideoStartWorkaround: first setRemoteDescription failed!!"+e),P.callFunctionIfExist(n,"performVideoStartWorkaround: first setRemoteDescription failed!!")})},o.getUserMedia=function(e,t){o.getRtcLibrary().checkMediaSourceAvailability(function(n){var i;o.setMediaSources(n),i=o.getMediaVideo()&&o.getVideoSourceAvailable()?{mandatory:{maxWidth:o.getVideoWidth(),maxHeight:o.getVideoHeight(),minWidth:o.getVideoWidth(),minHeight:o.getVideoHeight()}}:!1,o.getRtcLibrary().getUserMedia({audio:o.getMediaAudio(),video:i},function(t){var n;r.debug("user has granted access to local media."),o.setLocalStream(t),o.setInitialized(!0),n={audio:o.getMediaAudio(),video:o.getMediaVideo()},P.callFunctionIfExist(e,n)},function(e){r.debug("Failed to get access to local media. Error code was "+e.code),P.callFunctionIfExist(t,E.call.MediaErrors.NOT_ALLOWED)})})},o.createOffer=function(e,t,n,i){r.debug("createOffer: sendInitialVideo= "+i+" state= "+e.peer.signalingState);var a=e.peer;a.addStream(o.getLocalStream()),e.localStream=o.getLocalStream(),a.createOffer(function(t){i=i&&o.getVideoSourceAvailable(),t.sdp=i?M.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):M.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),t.sdp=M.deleteCryptoZeroFromSdp(t.sdp),t.sdp=M.performVP8RTCPParameterWorkaround(t.sdp),t.sdp=M.updateAudioCodec(t.sdp),t.sdp=M.removeG722Codec(t.sdp),t.sdp=M.deleteCryptoFromSdp(t.sdp,o.isDtlsEnabled()),t.sdp=M.setMediaActPass(t.sdp,o.isDtlsEnabled()),t.sdp=M.fixLocalTelephoneEventPayloadType(e,t.sdp),t.sdp=M.replaceOpusCodec(t.sdp),a.setLocalDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,t.sdp),function(){fe.setLocalStreamVideoSendStatus(e,i)},function(e){r.error("createOffer: setLocalDescription failed : "+e),P.callFunctionIfExist(n,"createOffer: setLocalDescription failed")})},function(e){r.error("createOffer: createOffer failed!! "+e),P.callFunctionIfExist(n)},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},o.createAnswer=function(e,t,n,i){r.debug("createAnswer: isVideoEnabled= "+i+" state= "+e.peer.signalingState);var a=e.peer;a.addStream(o.getLocalStream()),e.localStream=o.getLocalStream(),e.sdp=M.removeG722Codec(e.sdp),e.sdp=M.performG722ParameterWorkaround(e.sdp),e.sdp=M.performVP8RTCPParameterWorkaround(e.sdp),e.sdp=M.checkSupportedVideoCodecs(e.sdp,null),e.sdp=M.fixRemoteTelephoneEventPayloadType(e,e.sdp),e.sdp=M.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.INACTIVE,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.AUDIO),e.sdp=M.setMediaActPass(e.sdp,o.isDtlsEnabled()),e.sdp=M.deleteFingerprintOrCrypto(e.sdp,o.isDtlsEnabled()),M.isSdpVideoSendEnabled(e.sdp)||(e.sdp=M.deleteInactiveVideoSsrc(e.sdp)),a.setRemoteDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),function(){fe.callSetReceiveVideo(e),o.addCandidates(e),e.remoteVideoState=M.getSdpDirection(e.sdp,f.STRING.VIDEO),a.createAnswer(function(t){i=i&&o.getVideoSourceAvailable()&&M.isSdpHasVideo(e.sdp),
fe.setLocalStreamVideoSendStatus(e,i),t.sdp=i?M.isSdpVideoSendEnabled(e.sdp)?M.updateSdpDirection(t.sdp,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):M.updateSdpDirection(t.sdp,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.SEND_ONLY):M.isSdpVideoSendEnabled(e.sdp)?M.updateSdpDirection(t.sdp,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY):M.updateSdpDirection(t.sdp,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.INACTIVE),t.sdp=M.performVP8RTCPParameterWorkaround(t.sdp),o.muteOnHold(e,!1),t.sdp=M.setMediaPassive(t.sdp,o.isDtlsEnabled()),t.sdp=M.fixLocalTelephoneEventPayloadType(e,t.sdp),a.setLocalDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,t.sdp),function(){e.videoOfferSent=M.isSdpHasVideo(t.sdp)},function(e){r.error("createAnswer: setLocalDescription failed : "+e),P.callFunctionIfExist(n,"createNativeAnswer setLocalDescription failed")})},function(e){r.error("createAnswer: failed!! Error: "+e),P.callFunctionIfExist(n,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},function(e){r.error("createAnswer: setremotedescription failed!! Error: "+e)})},o.createUpdate=function(e,t,n,i){r.debug("createUpdate: isVideoStart= "+i+" state= "+e.peer.signalingState);var a,s;e.stableRemoteSdp=e.peer.remoteDescription.sdp,e.stableLocalSdp=e.peer.localDescription.sdp,a=e.peer.localDescription.sdp,s=e.isIceLite,a=M.fixLocalTelephoneEventPayloadType(e,a),a=M.incrementVersion(a),a=M.setMediaActPass(a,o.isDtlsEnabled()),fe.setLocalStreamVideoSendStatus(e,i),s?M.isSdpHasVideo(a)?o.createUpdateWithSetLocalDescription(e,t,n,i,a):o.createUpdateWithCreateOffer(e,t,n,i,a,s):e.videoOfferSent?o.createUpdateWithSetLocalDescription(e,t,n,i,a):o.createUpdateWithCreateOffer(e,t,n,i,a,s)},o.revertRtcState=function(e,t,n){var i,a=e.peer,s=e.stableLocalSdp,c=e.stableRemoteSdp,d=a.signalingState;switch(c=M.deleteGoogleIceFromSdp(c),d){case f.WEBRTC.RTC_SIGNALING_STATE.STABLE:case f.WEBRTC.RTC_SIGNALING_STATE.HAVE_LOCAL_OFFER:s=M.setMediaActPass(s,o.isDtlsEnabled()),i=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,s),a.setLocalDescription(i,function(){r.debug("revertRtcState[stable|local_offer]: setLocalDescription success"),c=M.setMediaPassive(c,o.isDtlsEnabled()),i=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,c),a.setRemoteDescription(i,function(){r.debug("revertRtcState[stable|local_offer]: setRemoteDescription success"),P.callFunctionIfExist(t,e)},function(t){r.error("revertRtcState[stable|local_offer]: setRemoteDescription failed: "+t),P.callFunctionIfExist(n,e)})},function(t){r.error("revertRtcState[stable|local_offer]: setLocalDescription failed: "+t),P.callFunctionIfExist(n,e)});break;case f.WEBRTC.RTC_SIGNALING_STATE.HAVE_REMOTE_OFFER:c=M.setMediaActPass(c,o.isDtlsEnabled()),i=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,c),a.setRemoteDescription(i,function(){r.debug("revertRtcState[remote_offer]: setLocalDescription success"),s=M.setMediaPassive(s,o.isDtlsEnabled()),i=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,s),a.setLocalDescription(i,function(){r.debug("revertRtcState[remote_offer]: setRemoteDescription success"),P.callFunctionIfExist(t,e)},function(t){r.error("revertRtcState[remote_offer]: setRemoteDescription failed: "+t),P.callFunctionIfExist(n,e)})},function(t){r.error("revertRtcState[remote_offer]: setLocalDescription failed: "+t),P.callFunctionIfExist(n,e)});break;default:r.debug("revertRtcState: not applicible for state: "+d)}},o.createHoldUpdate=function(e,t,n,i,a){r.debug("createHoldUpdate: local hold= "+t+" remote hold= "+n+" state= "+e.peer.signalingState);var s,c,d,l,u,p,E,S=e.peer;e.stableRemoteSdp=S.remoteDescription.sdp,e.stableLocalSdp=S.localDescription.sdp,u=M.incrementVersion(e.peer.localDescription.sdp),u=M.setMediaActPass(u,o.isDtlsEnabled()),l=u,d=u,t||n?(s=M.getAudioSdpDirection(l),l=s===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE?M.updateAudioSdpDirection(l,f.WEBRTC.MEDIA_STATE.SEND_ONLY):!t&&n?M.updateAudioSdpDirection(l,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):M.updateAudioSdpDirectionToInactive(l),c=M.getVideoSdpDirection(l),l=c===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE?M.updateVideoSdpDirection(l,f.WEBRTC.MEDIA_STATE.SEND_ONLY):!t&&n?M.updateVideoSdpDirection(l,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):M.updateVideoSdpDirectionToInactive(l),d=M.updateAudioSdpDirectionToInactive(l),d=M.updateVideoSdpDirectionToInactive(d),p=!0):(l=M.updateAudioSdpDirection(l,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE),l=fe.callCanLocalSendVideo(e)?M.updateVideoSdpDirection(l,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):M.updateVideoSdpDirection(l,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),d=l,p=!1),d=M.fixLocalTelephoneEventPayloadType(e,d),E=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,d),S.setLocalDescription(E,function(){r.debug("createHoldUpdate: setLocalDescription success"),o.muteOnHold(e,p),P.callFunctionIfExist(i,l)},function(e){r.error("createHoldUpdate: setLocalDescription failed: "+e),P.callFunctionIfExist(a)})},o.createReOffer=function(e,t,n,i){var a,s=e.peer;s.createOffer(function(i){i.sdp=M.deleteCryptoZeroFromSdp(i.sdp),i.sdp=M.performVP8RTCPParameterWorkaround(i.sdp),i.sdp=M.updateAudioCodec(i.sdp),i.sdp=M.removeG722Codec(i.sdp),i.sdp=M.deleteCryptoFromSdp(i.sdp,o.isDtlsEnabled()),i.sdp=M.setMediaActPass(i.sdp,o.isDtlsEnabled()),i.sdp=M.fixLocalTelephoneEventPayloadType(e,i.sdp),i.sdp=M.replaceOpusCodec(i.sdp),a=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,i.sdp),s.setLocalDescription(a,function(){r.debug("create ReOffer setLocalDescription success"),M.isMediaPortReady(i.sdp)&&(P.callFunctionIfExist(t,i.sdp),e.successCallback=null)},function(e){P.callFunctionIfExist(n,"create ReOffer setLocalDescription failed: "+e)})},function(e){r.error("create ReOffer failed!! "+e),P.callFunctionIfExist(n)},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo(),IceRestart:i}})},o.processHold=function(e,t,n,i,a){r.debug("processHold: local hold= "+n+" remote hold= "+t+" state= "+e.peer.signalingState);var s,c,d,l,u,p,E=e.peer,S=!1;e.stableRemoteSdp=E.remoteDescription.sdp,e.stableLocalSdp=E.localDescription.sdp,n||t||o.muteOnHold(e,!1),e.sdp=M.checkSupportedVideoCodecs(e.sdp,null),e.sdp=M.performVideoPortZeroWorkaround(e.sdp),e.sdp=M.checkAndRestoreICEParams(e.sdp,e.peer.localDescription.sdp),e.sdp=M.removeG722Codec(e.sdp),e.sdp=M.performG722ParameterWorkaround(e.sdp),e.sdp=M.performVP8RTCPParameterWorkaround(e.sdp),e.sdp=M.fixRemoteTelephoneEventPayloadType(e,e.sdp),e.sdp=M.performVP8BandwidthWorkaround(e.sdp),e.sdp=M.setMediaActPass(e.sdp,o.isDtlsEnabled()),c=M.getAudioSdpDirection(e.sdp),d=M.getVideoSdpDirection(e.sdp),l=e.prevRemoteSdp,u=E.localDescription.sdp,s=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),p=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,s.sdp),p.sdp=M.updateAudioSdpDirectionToInactive(p.sdp),p.sdp=M.updateVideoSdpDirectionToInactive(p.sdp),o.createNewPeerForCallIfIceChangedInRemoteSdp(e,e.sdp,l)&&(E=e.peer,S=!0),p.sdp=M.deleteSsrcFromSdp(p.sdp),E.setRemoteDescription(p,function(){s.sdp=M.updateAudioSdpDirection(s.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE),(M.getVideoSdpDirection(s.sdp)===f.WEBRTC.MEDIA_STATE.INACTIVE||M.getVideoSdpDirection(s.sdp)===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)&&(s.sdp=M.deleteInactiveVideoSsrc(s.sdp)),E.setRemoteDescription(s,function(){e.remoteVideoState=t||n||d!==f.WEBRTC.MEDIA_STATE.INACTIVE?M.getVideoSdpDirection(s.sdp):f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,fe.callSetReceiveVideo(e),E.createAnswer(function(o){r.debug("processHold: isSdpEnabled audio= "+M.isAudioSdpEnabled(o.sdp)),r.debug("processHold: isSdpEnabled video= "+M.isVideoSdpEnabled(o.sdp)),t?(r.debug("processHold: Remote HOLD"),o.sdp=M.respondToRemoteSdpDirections(o.sdp,e.sdp)):n?n&&!t&&(r.debug("processHold: Remote UNHOLD on local hold"),o.sdp=c===f.WEBRTC.MEDIA_STATE.INACTIVE?M.updateAudioSdpDirectionToInactive(o.sdp):M.updateAudioSdpDirection(o.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY),o.sdp=fe.callCanLocalSendVideo(e)?M.updateVideoSdpDirection(o.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY):M.updateVideoSdpDirectionToInactive(o.sdp)):(r.debug("processHold: Remote UNHOLD: direction left as it is"),o.sdp=fe.callCanLocalSendVideo(e)?M.isSdpVideoSendEnabled(e.sdp)?M.updateVideoSdpDirection(o.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):d===f.WEBRTC.MEDIA_STATE.INACTIVE?M.updateVideoSdpDirection(o.sdp,f.WEBRTC.MEDIA_STATE.INACTIVE):M.updateVideoSdpDirection(o.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY):M.isSdpVideoSendEnabled(e.sdp)?M.updateVideoSdpDirection(o.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY):M.updateVideoSdpDirection(o.sdp,f.WEBRTC.MEDIA_STATE.INACTIVE),o.sdp=M.changeDirection(o.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.AUDIO)),o.sdp=M.performVP8RTCPParameterWorkaround(o.sdp),o.sdp=M.updateVersion(u,o.sdp),o.sdp=M.checkIceParamsLengths(o.sdp,s.sdp),o.sdp=M.fixLocalTelephoneEventPayloadType(e,o.sdp),S&&(o.sdp=M.copyCandidatesToTheNewLocalSdp(u,o.sdp),S=!1),e.answer=o.sdp,E.setLocalDescription(o,function(){M.isMediaPortReady(o.sdp)&&(P.callFunctionIfExist(i,o.sdp),e.successCallback=null,e.answer=null)},function(t){r.debug("processHold: setLocalDescription failed!! "+t),P.callFunctionIfExist(a,"Session cannot be created"),e.answer=null})},function(e){r.debug("processHold: createAnswer failed!!: "+e),P.callFunctionIfExist(a,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},function(e){r.debug("processHold: second setRemoteDescription failed!! "+e),P.callFunctionIfExist(a,"Session cannot be created")})},function(e){r.debug("processHold: first setRemoteDescription failed!! "+e),P.callFunctionIfExist(a,"Session cannot be created")})},o.processUpdate=function(e,t,n,i){r.debug("processUpdate: state= "+e.peer.signalingState);var a,s,c,d,l,u,p,E,S,T=e.peer;if(e.stableRemoteSdp=T.remoteDescription.sdp,e.stableLocalSdp=T.localDescription.sdp,e.sdp=M.addSdpMissingCryptoLine(e.sdp),e.sdp=M.removeSdpPli(e.sdp),e.sdp=M.removeG722Codec(e.sdp),e.sdp=M.performG722ParameterWorkaround(e.sdp),e.sdp=M.performVP8RTCPParameterWorkaround(e.sdp),e.sdp=M.fixRemoteTelephoneEventPayloadType(e,e.sdp),e.sdp=M.checkAndRestoreICEParams(e.sdp,e.peer.localDescription.sdp),c=M.getVideoSdpDirection(e.sdp),o.setMediaVideo(M.isSdpHasVideo(e.sdp)),c===f.WEBRTC.MEDIA_STATE.INACTIVE&&"COMPLETED"===e.currentState)switch(e.remoteVideoState){case f.WEBRTC.MEDIA_STATE.INACTIVE:e.sdp=M.updateVideoSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE);break;case f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY:e.sdp=M.updateVideoSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE);break;case f.WEBRTC.MEDIA_STATE.SEND_RECEIVE:e.sdp=M.updateVideoSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)}i&&(e.sdp=M.updateAudioSdpDirectionToInactive(e.sdp),e.sdp=M.updateVideoSdpDirectionToInactive(e.sdp)),e.sdp=M.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.VIDEO),fe.callSetReceiveVideo(e),T.signalingState===f.WEBRTC.RTC_SIGNALING_STATE.HAVE_LOCAL_OFFER?(e.sdp=M.checkSupportedVideoCodecs(e.sdp,e.peer.localDescription.sdp),e.sdp=M.setMediaPassive(e.sdp,o.isDtlsEnabled()),l=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),T.setRemoteDescription(l,function(){e.remoteVideoState=M.getVideoSdpDirection(e.sdp),o.addCandidates(e),P.callFunctionIfExist(t,e.sdp),e.successCallback=null},function(e){r.debug("processUpdate: setRemoteDescription failed!!"+e),P.callFunctionIfExist(n,"processUpdate: setRemoteDescription failed!!")})):(e.sdp=M.checkSupportedVideoCodecs(e.sdp,null),a=M.getAudioSdpDirection(e.sdp),s=M.getVideoSdpDirection(e.sdp),e.sdp=M.updateAudioSdpDirectionToInactive(e.sdp),e.sdp=M.updateVideoSdpDirectionToInactive(e.sdp),e.sdp=M.setMediaActPass(e.sdp,o.isDtlsEnabled()),(s===f.WEBRTC.MEDIA_STATE.INACTIVE||s===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)&&(e.sdp=M.deleteInactiveVideoSsrc(e.sdp)),p=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.prevRemoteSdp),E=T.localDescription.sdp,o.createNewPeerForCallIfIceChangedInRemoteSdp(e,e.sdp,p.sdp)&&(T=e.peer,S=!0),d=M.deleteSsrcFromSdp(e.sdp),l=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,d),T.setRemoteDescription(l,function(){r.debug("processUpdate: workaround setRemoteDescription success"),e.sdp=M.updateAudioSdpDirection(e.sdp,a),e.sdp=M.updateVideoSdpDirection(e.sdp,s),l=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),T.setRemoteDescription(l,function(){r.debug("processUpdate: setRemoteDescription success"),e.remoteVideoState=M.getVideoSdpDirection(e.sdp),o.addCandidates(e),T.createAnswer(function(i){r.debug("processUpdate: isSdpEnabled audio= "+M.isAudioSdpEnabled(i.sdp)),r.debug("processUpdate: isSdpEnabled video= "+M.isVideoSdpEnabled(i.sdp)),a===f.WEBRTC.MEDIA_STATE.INACTIVE&&(i.sdp=M.updateAudioSdpDirectionToInactive(i.sdp)),i.sdp=e.remoteVideoState===f.WEBRTC.MEDIA_STATE.INACTIVE?M.updateVideoSdpDirectionToInactive(i.sdp):fe.callCanLocalSendVideo(e)?M.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):M.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),i.sdp=M.performVP8RTCPParameterWorkaround(i.sdp),i.sdp=M.updateVersion(E,i.sdp),i.sdp=M.fixLocalTelephoneEventPayloadType(e,i.sdp),o.fireOnStreamAddedEvent(e),i.sdp=M.checkIceParamsLengths(i.sdp,l.sdp),i.sdp=M.setMediaPassive(i.sdp,o.isDtlsEnabled()),S&&(i.sdp=M.copyCandidatesToTheNewLocalSdp(E,i.sdp),S=!1),u=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,i.sdp),T.setLocalDescription(u,function(){M.isMediaPortReady(i.sdp)&&(r.debug("processUpdate: setlocalDescription success"),P.callFunctionIfExist(t,i.sdp),e.successCallback=null)},function(e){r.debug("processUpdate: setlocalDescription failed!!"+e),P.callFunctionIfExist(n,"processUpdate: setlocalDescription failed!!")})},function(e){r.debug("processUpdate: createAnswer failed!! "+e),P.callFunctionIfExist(n,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},function(e){r.debug("processUpdate: setRemoteDescription failed!!"+e),P.callFunctionIfExist(n,"processUpdate: setRemoteDescription failed!!")})},function(e){r.debug("processUpdate: workaround setRemoteDescription failed!!"+e),P.callFunctionIfExist(n,"processUpdate: workaround setRemoteDescription failed!!")}))},o.processAnswer=function(e,t,n){r.debug("processAnswer: state= "+e.peer.signalingState);var i,a,s,c,d,l=e.peer;s=function(){e.remoteVideoState=M.getVideoSdpDirection(e.sdp),e.videoOfferSent=M.isSdpHasVideo(e.sdp),o.addCandidates(e),P.callFunctionIfExist(t)},e.sdp=M.checkSupportedVideoCodecs(e.sdp,l.localDescription.sdp),e.sdp=M.performVideoPortZeroWorkaround(e.sdp),e.sdp=M.removeSdpPli(e.sdp),e.sdp=M.removeG722Codec(e.sdp),e.sdp=M.performG722ParameterWorkaround(e.sdp),e.sdp=M.performVP8RTCPParameterWorkaround(e.sdp),e.sdp=M.performVP8BandwidthWorkaround(e.sdp),e.sdp=M.fixRemoteTelephoneEventPayloadType(e,e.sdp),fe.callSetReceiveVideo(e),c=M.getVideoSdpDirection(e.sdp),d=M.getVideoSdpDirection(e.peer.localDescription.sdp),r.debug("processAnswer: ice-lite: do remote video escalation"),e.sdp=M.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE),d!==f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY||c!==f.WEBRTC.MEDIA_STATE.INACTIVE&&c!==f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY?d!==f.WEBRTC.MEDIA_STATE.SEND_RECEIVE||c!==f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY&&c!==f.WEBRTC.MEDIA_STATE.INACTIVE?d!==f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY||c!==f.WEBRTC.MEDIA_STATE.SEND_ONLY&&c!==f.WEBRTC.MEDIA_STATE.SEND_RECEIVE?(e.sdp=M.setMediaPassive(e.sdp,o.isDtlsEnabled()),l.setRemoteDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),function(){r.debug("processAnswer: setRemoteDescription success"),s()},function(e){r.debug("processAnswer: setRemoteDescription failed: "+e),P.callFunctionIfExist(n)})):(i=function(){o.performVideoStartWorkaround(e,s,n)},a=function(){o.restoreActualSdp(e,i,n,d,c)},o.performOrigAudioWorkaround(e,i,n)):(e.sdp=M.deleteInactiveVideoSsrc(e.sdp),a=function(){o.restoreActualSdp(e,s,n,d,c)},o.performOrigAudioWorkaround(e,s,n)):(e.sdp=M.deleteInactiveVideoSsrc(e.sdp),o.performOrigAudioWorkaround(e,s,n))},o.processPreAnswer=function(e){r.debug("processPreAnswer: state= "+e.peer.signalingState);var t,n=e.peer;e.sdp=M.checkSupportedVideoCodecs(e.sdp,e.peer.localDescription.sdp),e.sdp=M.removeG722Codec(e.sdp),e.sdp=M.performG722ParameterWorkaround(e.sdp),e.sdp=M.performVP8RTCPParameterWorkaround(e.sdp),e.sdp=M.fixRemoteTelephoneEventPayloadType(e,e.sdp),fe.callSetReceiveVideo(e),t=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),o.addCandidates(e),n.setRemoteDescription(t,function(){e.remoteVideoState=M.getVideoSdpDirection(e.sdp),r.debug("processPreAnswer: setRemoteDescription success")},function(e){r.debug("processPreAnswer: setRemoteDescription failed: "+e)})},o.processRespond=function(e,t,n,i){var a,s,c,d=e.peer;if(r.debug("processRespond: state= "+e.peer.signalingState),e.sdp=M.checkSupportedVideoCodecs(e.sdp,d.localDescription.sdp),e.sdp=M.removeSdpPli(e.sdp),e.sdp=M.removeG722Codec(e.sdp),e.sdp=M.performG722ParameterWorkaround(e.sdp),e.sdp=M.performVP8RTCPParameterWorkaround(e.sdp),e.sdp=M.performVP8BandwidthWorkaround(e.sdp),e.sdp=M.fixRemoteTelephoneEventPayloadType(e,e.sdp),a=M.getVideoSdpDirection(e.sdp),fe.callSetReceiveVideo(e),a===f.WEBRTC.MEDIA_STATE.INACTIVE&&"COMPLETED"===e.currentState)switch(e.remoteVideoState){case f.WEBRTC.MEDIA_STATE.INACTIVE:e.sdp=M.updateVideoSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY);break;case f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY:e.sdp=M.updateVideoSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)}return e.remoteVideoState=M.getVideoSdpDirection(e.sdp),e.sdp=M.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.VIDEO),i&&(e.sdp=M.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.AUDIO),o.muteOnHold(e,!1)),e.peer.signalingState===f.WEBRTC.RTC_SIGNALING_STATE.STABLE?void P.callFunctionIfExist(t):(e.sdp=M.setMediaPassive(e.sdp,o.isDtlsEnabled()),(M.getVideoSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.INACTIVE||M.getVideoSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)&&(e.sdp=M.deleteInactiveVideoSsrc(e.sdp)),s=M.deleteSsrcFromSdp(e.sdp),c=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,s),void d.setRemoteDescription(c,function(){r.debug("processRespond: setRemoteDescription success");var i=function(){e.remoteVideoState=M.getVideoSdpDirection(e.sdp),e.videoOfferSent=!0,o.addCandidates(e),P.callFunctionIfExist(t)};o.performVideoStartWorkaround(e,i,n)},function(e){r.debug("processRespond: setRemoteDescription failed: "+e),P.callFunctionIfExist(n)}))},o.processHoldRespond=function(e,t,n,i){var a,s,c,d,l,u=!1,p=!1;return d=function(){o.addCandidates(e),P.callFunctionIfExist(t)},r.debug("processHoldRespond: state= "+e.peer.signalingState+" call.currentState= "+e.currentState),e.sdp=M.checkSupportedVideoCodecs(e.sdp,e.peer.localDescription.sdp),e.sdp=M.removeSdpPli(e.sdp),e.sdp=M.removeG722Codec(e.sdp),e.sdp=M.performG722ParameterWorkaround(e.sdp),e.sdp=M.performVP8RTCPParameterWorkaround(e.sdp),e.sdp=M.performVP8BandwidthWorkaround(e.sdp),e.sdp=M.fixRemoteTelephoneEventPayloadType(e,e.sdp),M.init(e.sdp),p=M.isRemoteHold(),u="LOCAL_HOLD"===e.currentState,a=M.getAudioSdpDirection(e.sdp),s=M.getVideoSdpDirection(e.sdp),e.remoteVideoState=s,c=M.getVideoSdpDirection(e.peer.localDescription.sdp),r.debug("processHoldRespond: localHold= "+u+" remoteHold= "+p),p===!1?a===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE&&"REMOTE_HOLD"===e.currentState&&(r.debug("set current web state to COMPLETED"),e.previousState=e.currentState,e.currentState="COMPLETED"):"COMPLETED"===e.currentState&&(r.debug("set current web state to REMOTE_HOLD"),e.previousState=e.currentState,e.currentState="REMOTE_HOLD"),(u||p)&&(r.debug("processHoldRespond: "+e.currentState+" : video -> inactive"),e.sdp=M.updateVideoSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.INACTIVE)),s===f.WEBRTC.MEDIA_STATE.INACTIVE&&"COMPLETED"===e.currentState&&(r.debug("processHoldRespond: video inactive -> recvonly"),e.sdp=M.updateVideoSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)),i&&o.muteOnHold(e,!1),fe.callSetReceiveVideo(e),e.peer.signalingState===f.WEBRTC.RTC_SIGNALING_STATE.STABLE?void P.callFunctionIfExist(t):(e.sdp=M.setMediaPassive(e.sdp,o.isDtlsEnabled()),e.sdp=M.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE),(M.getVideoSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.INACTIVE||M.getVideoSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)&&(e.sdp=M.deleteInactiveVideoSsrc(e.sdp)),l=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),void e.peer.setRemoteDescription(l,function(){r.debug("processHoldRespond: setRemoteDescription typeAns success"),a===f.WEBRTC.MEDIA_STATE.INACTIVE||a===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY?d():o.performVideoStartWorkaround(e,d,n)},function(e){r.debug("processHoldRespond: setRemoteDescription typeAns failed: "+e),P.callFunctionIfExist(n)}))},o.processRemoteOfferOnLocalHold=function(e,t,n){r.info("processRemoteOfferOnLocalHold"),e.peer?P.callFunctionIfExist(t,e.peer.localDescription.sdp):P.callFunctionIfExist(n,"we dont have a peer object somehow")},o.processEnd=function(e){e.peer&&(r.info("close peer connection "+e.id),e.peer&&e.peer.close(),e.localStream&&(e.localStream.stop(),e.localStream=null),o.getDefaultVideoContainer()?o.getDefaultVideoContainer().firstElementChild&&o.disposeStreamRenderer(o.getDefaultVideoContainer().firstElementChild):o.getRemoteVideoContainer()&&o.disposeStreamRenderer(o.getRemoteVideoContainer()),o.setPeerCount(o.getPeerCount()-1),o.getPeerCount()<=0&&(o.getLocalStream()&&o.getLocalStream().stop&&(o.getLocalStream().stop(),o.getDefaultVideoContainer()?o.disposeStreamRenderer(o.getDefaultVideoContainer().lastElementChild):o.getLocalVideoContainer()&&o.disposeStreamRenderer(o.getLocalVideoContainer())),o.setLocalStream(null)))},o.createUpdateWithSetLocalDescription=function(e,t,n,i,a){var s,c=e.peer;r.debug("set local description to start the video"),e.isVideoSourceAllowed||o.replaceLocalStream(e),o.getLocalVideoTrack(e.peer)&&(o.getLocalVideoTrack(e.peer).enabled=i),a=i?M.updateSdpDirection(a,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):M.deescalateSdpDirection(a,f.STRING.VIDEO),s=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,a),c.setLocalDescription(s,function(){r.debug("createUpdate: setLocalDescription success "),P.callFunctionIfExist(t,s.sdp)},function(e){r.error("createUpdate: setLocalDescription failed : "+e),P.callFunctionIfExist(n)})},o.createUpdateWithCreateOffer=function(e,t,n,i,a,s){var c,d=e.peer;r.debug("create new offer to start the video: isIceLite = "+s),o.replaceLocalStream(e),o.setMediaVideo(M.isSdpHasVideo(a)),d.createOffer(function(t){i=i&&o.getVideoSourceAvailable(),t.sdp=i?M.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):M.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),t.sdp=M.performVP8RTCPParameterWorkaround(t.sdp),t.sdp=M.setMediaActPass(t.sdp,o.isDtlsEnabled()),t.sdp=M.fixLocalTelephoneEventPayloadType(e,t.sdp),t.sdp=M.replaceOpusCodec(t.sdp),t.sdp=M.deleteCryptoZeroFromSdp(t.sdp),t.sdp=M.updateAudioCodec(t.sdp),t.sdp=M.removeG722Codec(t.sdp),t.sdp=M.deleteCryptoFromSdp(t.sdp,o.isDtlsEnabled()),c=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,t.sdp),d.setLocalDescription(c,function(){r.debug("createUpdate: createOffer setLocalDescription success "),fe.setLocalStreamVideoSendStatus(e,i)},function(e){r.debug("createUpdate: createOffer setLocalDescription failed: "+e),P.callFunctionIfExist(n)})},function(e){r.debug("createUpdate: createOffer failed!!: "+e),n()},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo(),IceRestart:!s}})},o.onSessionConnecting=function(e,t){r.debug("onSessionConnecting")},o.onSessionOpened=function(e,t){r.debug("onSessionOpened")},o.onSignalingStateChange=function(e,t){r.debug("Signalling state changed: state= "+t.srcElement.signalingState)},o.useDefaultRenderer=function(e,t){var n;o.getDefaultVideoContainer()&&0===o.getDefaultVideoContainer().children.length&&(o.getDefaultVideoContainer().innerHTML="<div style='height:100%;width:100%'></div><div style='position:absolute;bottom:10px;right:10px;height:30%; width:30%;'></div>"),n=t?o.getLocalVideoContainer()?o.getLocalVideoContainer():o.getDefaultVideoContainer().lastElementChild:o.getRemoteVideoContainer()?o.getRemoteVideoContainer():o.getDefaultVideoContainer().firstElementChild,o.createStreamRenderer(e,n,{muted:t})},o.createStreamRenderer=function(e,t,n){var i;if(e&&t)return t.innerHTML="",i=document.createElement("video"),i.src=e,i.style.width="100%",i.style.height="100%",i.autoplay="true",n&&n.muted&&(i.muted="true"),t.appendChild(i),i},o.onRemoteStreamAdded=function(e,t){var n;r.debug("onRemoteStreamAdded"),t.stream&&(n=o.getRtcLibrary().getURLFromStream(t.stream),t.stream.getVideoTracks()&&r.info("Accessed Video Track"),n&&(r.debug("onRemoteStreamAdded: "+n),o.getDefaultVideoContainer()?o.useDefaultRenderer(n,!1):o.getRemoteVideoContainer()?o.createStreamRenderer(n,o.getRemoteVideoContainer()):o.fireOnStreamAddedEvent(e,n)))},o.fireOnStreamAddedEvent=function(e,t){e&&e.call&&e.call.onStreamAdded&&(fe.callSetReceiveVideo(e),P.callFunctionIfExist(e.call.onStreamAdded,t))},o.onRemoteStreamRemoved=function(e,t){r.debug("onRemoteStreamRemoved")},o.clearIceCandidateCollectionTimer=function(e){clearTimeout(e.iceCandidateCollectionTimer),e.iceCandidateCollectionTimer=null},o.onIceCandidate=function(e,t){var n;null===t.candidate?(o.clearIceCandidateCollectionTimer(e),e.successCallback&&(r.debug("Null candidate received, invoking successCallback."),n=e.peer.localDescription.sdp,e.successCallback(n),e.successCallback=null)):(e.iceCandidateReceived=!0,r.debug("ICE candidate received: sdpMLineIndex = "+t.candidate.sdpMLineIndex+", candidate = "+t.candidate.candidate+" for call : "+e.id))},o.onIceComplete=function(e){var t;r.debug("All ICE candidates received for call : "+e.id),o.clearIceCandidateCollectionTimer(e),e.successCallback&&(e.offer?(t=e.offer.sdp,t=t.replace("s=","s=genband"),e.offer=null):e.answer&&(t=e.answer.sdp,e.answer=null),t=M.updateH264Level(t),r.debug("onIceComplete sdp : "+t),e.successCallback(t),e.successCallback=null)},o.iceCandidateCollectionTimeoutHandler=function(e){var t=e.peer.localDescription.sdp;return o.clearIceCandidateCollectionTimer(e),M.isSdpHasAudio(t)&&M.isSdpHasAudioWithZeroPort(t)||M.isSdpHasVideo(t)&&M.isSdpHasVideoWithZeroPort(t)?(r.debug("Re-setting ice candidate collection timeout: "+C.iceCandidateCollectionTimeoutInterval),void(e.iceCandidateCollectionTimer=setTimeout(function(){o.iceCandidateCollectionTimeoutHandler(e)},C.iceCandidateCollectionTimeoutInterval))):void(e.successCallback&&(r.debug("Ice candidate collection interrupted after given timeout, invoking successCallback."),e.successCallback(t),e.successCallback=null))},o.setupIceCandidateCollectionTimer=function(e){C.iceCandidateCollectionTimeoutInterval&&(e.iceCandidateCollectionTimer?r.trace("Ice candidate collection timer exists."):(r.debug("Setting ice candidate collection timeout: "+C.iceCandidateCollectionTimeoutInterval),e.iceCandidateCollectionTimer=setTimeout(function(){o.iceCandidateCollectionTimeoutHandler(e)},C.iceCandidateCollectionTimeoutInterval)))},o.oniceconnectionstatechange=function(e,t){r.debug("ICE connection state change : "+t.currentTarget.iceConnectionState),"failed"===e.peer.iceConnectionState&&P.callFunctionIfExist(e.onIceStateFailure,e)},o.createPeer=function(e,t,n){try{var i,a,s,c,d=[],l=o.getIceServerUrl();if(l instanceof Array)for(s=0;s<l.length;s++)d[s]=l[s];else null===l||""===l?d=[]:d[0]=l;c={iceServers:d},a={optional:[{DtlsSrtpKeyAgreement:o.isDtlsEnabled()}]},i=o.getRtcLibrary().createRTCPeerConnection(c,a),o.setPeerCount(o.getPeerCount()+1),e.peer=i,i.onconnecting=function(t){o.onSessionConnecting(e,t)},i.onopen=function(t){o.onSessionOpened(e,t)},i.onsignalingstatechange=function(t){o.onSignalingStateChange(e,t)},i.onaddstream=function(t){o.onRemoteStreamAdded(e,t)},i.onremovestream=function(t){o.onRemoteStreamRemoved(e,t)},i.onicecandidate=function(t){o.setupIceCandidateCollectionTimer(e),o.onIceCandidate(e,t)},i.onicecomplete=function(){o.onIceComplete(e)},i.oniceconnectionstatechange=function(t){o.oniceconnectionstatechange(e,t)},r.info("create PeerConnection successfully."),t(e)}catch(u){r.error("Failed to create PeerConnection, exception: "+u.message),n()}},o.createNewPeerForCall=function(e){var t=!1,n=o.getPeerCount();return e.peer&&(e.peer.close(),o.setPeerCount(n-1)),r.trace("Creating new peer for call: "+e.id),o.createPeer(e,function(){r.trace("New peer has created for call: "+e.id),e.peer.addStream(o.getLocalStream()),t=!0},function(){r.error("New peer creation has failed!: "+e.id)}),t},o.createNewPeerForCallIfIceChangedInRemoteSdp=function(e,t,n){var i=M.isIceLite(t),a=M.isIceLite(n),s=!1;return i!==a?(r.trace("Ice - Ice-Lite change detected in call: "+e.id),o.createNewPeerForCall(e)):s},o.getRemoteVideoResolutions=function(){return[]},o.getLocalVideoResolutions=function(){return[]},o.refreshVideoRenderer=function(){},o.sendIntraFrame=function(){},o.sendBlackFrame=function(){},o.fireOnLocalStreamAddedEvent=function(e){e&&e.call&&e.call.onLocalStreamAdded&&P.callFunctionIfExist(e.call.onLocalStreamAdded)},o.addLocalStream=function(e){var t,n=!1;r.debug("addLocalStream"),e.localStream&&(fe.callCanLocalSendVideo(e)?(t=o.getRtcLibrary().getURLFromStream(e.localStream),t&&(r.debug("addLocalStream: "+t),o.getDefaultVideoContainer()?o.useDefaultRenderer(t,!0):o.getLocalVideoContainer()?o.createStreamRenderer(t,o.getLocalVideoContainer(),{muted:!0}):e.call.localStreamURL=t,n=!0)):o.getDefaultVideoContainer()?o.getDefaultVideoContainer().lastElementChild&&(o.disposeStreamRenderer(o.getDefaultVideoContainer().lastElementChild),n=!0):o.getLocalVideoContainer()&&(o.disposeStreamRenderer(o.getLocalVideoContainer()),n=!0),n&&o.fireOnLocalStreamAddedEvent(e))},o.replaceLocalStream=function(e){r.debug("replaceLocalStream"),e.peer.getLocalStreams().length>0&&e.peer.removeStream(e.peer.getLocalStreams()[0]),e.peer.addStream(o.getLocalStream()),e.localStream=o.getLocalStream()},o.disposeStreamRenderer=function(e){e&&(e.innerHTML="")},o.sendDTMF=function(e,t){if(r.info("sending DTMF tone : "+t),!e.dtmfSender){var n=o.getLocalAudioTrack(e.peer);if(!n)return;if(e.dtmfSender=e.peer.createDTMFSender(n),!e.dtmfSender)return}e.dtmfSender.canInsertDTMF===!0?e.dtmfSender.insertDTMF(t,400):r.error("Failed to execute 'insertDTMF' on 'RTCDTMFSender': The 'canInsertDTMF' attribute is false: this sender cannot send DTMF")},r.debug("WebRtcAdaptor initialized")},z=function(e,t,n){return new K(e,t,n,O)};l&&(l.WebRtcAdaptor=z);var Z=function(e,t,n,i){var o=this,r=i.getLogger("WebRtcPluginAdaptorImpl");r.debug("WebRtcPluginAdaptor initializing"),P.compose(e,o),P.compose(n,o),o.setPluginEnabled(!0),o.initMedia=function(e,n,i){var a,s,c,d=document.body,l={},u=!0,p=E.call.MediaErrors,f="1px",S="fcsPlugin",T="application/x-gcfwenabler",m=o.getPluginVersion();if(r.debug("Configured plugin version: "+m.major+"."+m.minor+"."+m.current_revision),i&&(i.localVideoContainer&&o.setLocalVideoContainer(i.localVideoContainer),i.remoteVideoContainer&&o.setRemoteVideoContainer(i.remoteVideoContainer),i.videoContainer&&o.setDefaultVideoContainer(i.videoContainer),i.pluginLogLevel&&o.setLogLevel(i.pluginLogLevel),i.language&&o.setLanguage(i.language)),o.onFCSPLoaded=function(){
o.setRtcLibrary(t(l)),o.getRtcLibrary().checkMediaSourceAvailability(function(e){o.setMediaSources(e)}),s=o.getRtcLibrary().getCurrentPluginVersionObject(),c=o.getRtcLibrary().getVersion(),!o.isInitialized()&&u&&(u=!1,r.debug("Plugin callback"),E.setPluginVersion(c),r.debug("Installed plugin version: "+c),c.length<1||s.major!==m.major||s.minor!==m.minor||s.revision<m.min_revision||s.revision===m.min_revision&&s.build<m.min_build?(r.debug("Plugin version not supported"),P.callFunctionIfExist(n,p.WRONG_VERSION)):(o.setInitialized(!0),s.revision<m.current_revision||s.revision===m.current_revision&&s.build<m.current_build?(r.debug("New plugin version warning"),P.callFunctionIfExist(n,p.NEW_VERSION_WARNING)):P.callFunctionIfExist(e,{pluginVersion:l.version}),o.getRtcLibrary().setLang(o.getLanguage())),o.setLocalStream(null),o.getRtcLibrary().checkMediaSourceAvailability())},"undefined"==typeof d.appendChild)return r.debug("Could not inject plugin in container"),void P.callFunctionIfExist(n,p.OPTIONS);l=document.createElement("object"),a=document.createElement("param"),a.setAttribute("name","onload"),a.setAttribute("value","onFCSPLoaded"),l.appendChild(a),l.id=S,l.width=l.height=f;try{"Microsoft Internet Explorer"===navigator.appName?(d.appendChild(l),l.type=T):(l.type=T,d.appendChild(l))}catch(g){u=!1,P.callFunctionIfExist(n,p.NOT_FOUND)}u&&("undefined"!=typeof document.getElementById(S).createPeerConnection?o.onFCSPLoaded():setTimeout(function(){o.isInitialized()||("undefined"==typeof document.getElementById(S).createPeerConnection?P.callFunctionIfExist(n,p.NOT_FOUND):o.onFCSPLoaded())},7e3))},o.getUserMedia=function(e,t){o.getRtcLibrary().checkMediaSourceAvailability(function(n){var i,a;return r.debug("Plugin version:"+o.getRtcLibrary().version),n&&(o.setVideoSourceAvailable(n.videoSourceAvailable),o.setAudioSourceAvailable(n.audioSourceAvailable)),i=o.getMediaVideo()&&o.getVideoSourceAvailable()?{mandatory:{maxWidth:o.getVideoWidth(),maxHeight:o.getVideoHeight()}}:!1,n&&n.localStream?(a={audio:o.getMediaAudio(),video:o.getMediaVideo()&&o.getVideoSourceAvailable()},void P.callFunctionIfExist(e,a)):void o.getRtcLibrary().getUserMedia({audio:o.getMediaAudio(),video:i},function(t){r.debug("user has granted access to local media."),o.setLocalStream(t),o.setInitialized(!0),a={audio:o.getMediaAudio(),video:o.getMediaVideo()&&o.getVideoSourceAvailable()},P.callFunctionIfExist(e,a)},function(e){r.debug("Failed to get access to local media. Error code was "+e.code),P.callFunctionIfExist(t,E.call.MediaErrors.NOT_ALLOWED)})})},o.addCandidates=function(e){var t,n,i,r,a,s,c="",d="",l=/\r\n|\r|\n/;if(t=e.sdp.indexOf(f.SDP.M_LINE+f.STRING.AUDIO,0),n=e.sdp.indexOf(f.SDP.M_LINE+f.STRING.VIDEO,0),-1!==t&&-1!==n?n>t?(c=e.sdp.substring(t,n),d=e.sdp.substring(n)):(d=e.sdp.substring(n,t),c=e.sdp.substring(t)):-1!==t?c=e.sdp.substring(t):-1!==n&&(d=e.sdp.substring(n)),""!==c&&(i=c.indexOf("a=candidate",0),-1!==i))for(c=c.substring(i),a=c.split(l),s=0;a[s]&&-1!==a[s].indexOf("a=candidate");)r=o.getRtcLibrary().createRTCIceCandidate(a[s],f.STRING.AUDIO,0),e.peer.addIceCandidate(r),s++;if(""!==d&&(i=d.indexOf("a=candidate",0),-1!==i))for(d=d.substring(i),a=d.split(l),s=0;a[s]&&-1!==a[s].indexOf("a=candidate");)r=o.getRtcLibrary().createRTCIceCandidate(a[s],f.STRING.VIDEO,1),e.peer.addIceCandidate(r),s++},o.createOffer=function(e,t,n,i){r.debug("createOffer: sendInitialVideo= "+i+" state= "+e.peer.signalingState);var a,s=e.peer;s.addStream(o.getLocalStream()),e.localStream=o.getLocalStream(),s.createOffer(function(t){i=i&&o.getVideoSourceAvailable(),a=M.getSdpFromObject(t),t=null,a=i?M.updateVideoSdpDirection(a,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):M.updateVideoSdpDirection(a,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),a=M.deleteCryptoZeroFromSdp(a),a=M.performVP8RTCPParameterWorkaround(a),a=M.updateAudioCodec(a),a=M.removeG722Codec(a),a=M.deleteCryptoFromSdp(a,o.isDtlsEnabled()),a=M.setMediaActPass(a,o.isDtlsEnabled()),a=M.fixLocalTelephoneEventPayloadType(e,a),a=M.replaceOpusCodec(a),o.muteOnHold(e,!1),e.offer=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,a),s.setLocalDescription(e.offer,function(){fe.setLocalStreamVideoSendStatus(e,i)},function(e){r.error("createOffer: setLocalDescription failed : "+e),P.callFunctionIfExist(n,"createOffer: setLocalDescription failed")})},function(e){r.error("createOffer: createOffer failed!! "+e),P.callFunctionIfExist(n)},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},o.createAnswer=function(e,t,n,i){r.debug("createAnswer: isVideoEnabled= "+i+" state= "+e.peer.signalingState);var a,s,c=e.peer;e.sdp=M.performVP8RTCPParameterWorkaround(e.sdp),e.sdp=M.checkSupportedVideoCodecs(e.sdp,null),e.sdp=M.removeRTXCodec(e.sdp),e.sdp=M.removeG722Codec(e.sdp),e.sdp=M.performG722ParameterWorkaround(e.sdp),e.sdp=M.fixRemoteTelephoneEventPayloadType(e,e.sdp),e.sdp=M.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.INACTIVE,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.AUDIO),e.sdp=M.setMediaActPass(e.sdp,o.isDtlsEnabled()),e.sdp=M.deleteFingerprintOrCrypto(e.sdp,o.isDtlsEnabled()),M.isSdpVideoSendEnabled(e.sdp)||(e.sdp=M.deleteInactiveVideoSsrc(e.sdp)),c.setRemoteDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),function(){c.addStream(o.getLocalStream()),e.localStream=o.getLocalStream(),e.remoteVideoState=M.getVideoSdpDirection(e.sdp),fe.callSetReceiveVideo(e),o.addCandidates(e),c.createAnswer(c.remoteDescription,function(t){a=M.getSdpFromObject(t),t=null,i=i&&o.getVideoSourceAvailable()&&M.isSdpHasVideo(e.sdp),fe.setLocalStreamVideoSendStatus(e,i),a=i?M.isSdpVideoSendEnabled(e.sdp)?M.updateVideoSdpDirection(a,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):M.updateVideoSdpDirection(a,f.WEBRTC.MEDIA_STATE.SEND_ONLY):M.isSdpVideoSendEnabled(e.sdp)?M.updateVideoSdpDirection(a,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY):M.updateVideoSdpDirection(a,f.WEBRTC.MEDIA_STATE.INACTIVE),r.debug("doAnswer(plugin) - isSdpEnabled audio : "+M.isAudioSdpEnabled(a)),r.debug("doAnswer(plugin) - isSdpEnabled video : "+M.isVideoSdpEnabled(a)),M.isSdpHasAudio(a)||M.isSdpHasVideo(a)?(a=M.performVP8RTCPParameterWorkaround(a),a=M.setMediaPassive(a,o.isDtlsEnabled()),a=M.fixLocalTelephoneEventPayloadType(e,a),s=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,a),e.answer=s,o.muteOnHold(e,!1),c.setLocalDescription(s,function(){e.videoOfferSent=M.isSdpHasVideo(a)},function(e){r.error("createAnswer: setLocalDescription failed : "+e),P.callFunctionIfExist(n,"createAnswer setLocalDescription failed")})):(r.error("createrAnswer: createAnswer failed!!"),P.callFunctionIfExist(n,"No codec negotiation"))},function(e){r.error("createAnswer: failed!!"+e),P.callFunctionIfExist(n,"Session cannot be created ")},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},function(e){r.error("createAnswer setRemoteDescription failed : "+e)})},o.createUpdate=function(e,t,n,i){r.debug("createEnablerUpdate: isVideoStart= "+i+" state= "+e.peer.signalingState);var a,s;e.stableRemoteSdp=e.peer.remoteDescription.sdp,e.stableLocalSdp=e.peer.localDescription.sdp,a=M.getSdpFromObject(e.peer.localDescription),s=e.isIceLite,a=M.incrementVersion(a),a=M.deleteCryptoFromSdp(a,o.isDtlsEnabled()),a=M.setMediaActPass(a,o.isDtlsEnabled()),a=M.fixLocalTelephoneEventPayloadType(e,a),fe.setLocalStreamVideoSendStatus(e,i),s?M.isSdpHasVideo(a)?o.createUpdateWithSetLocalDescription(e,t,n,i,a):o.createUpdateWithCreateOffer(e,t,n,i,a,s):e.videoOfferSent?o.createUpdateWithSetLocalDescription(e,t,n,i,a):o.createUpdateWithCreateOffer(e,t,n,i,a,s)},o.createHoldUpdate=function(e,t,n,i,a){r.debug("createHoldUpdate: local hold= "+t+" remote hold= "+n+" state= "+e.peer.signalingState);var s,c,d,l,u,p,E,S,T=e.peer;e.stableRemoteSdp=T.remoteDescription.sdp,e.stableLocalSdp=T.localDescription.sdp,u=M.incrementVersion(e.peer.localDescription.sdp),u=M.setMediaActPass(u,o.isDtlsEnabled()),l=u,d=u,t||n?(s=M.getAudioSdpDirection(l),l=s===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE?M.updateAudioSdpDirection(l,f.WEBRTC.MEDIA_STATE.SEND_ONLY):!t&&n?M.updateAudioSdpDirection(l,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):M.updateAudioSdpDirection(l,f.WEBRTC.MEDIA_STATE.INACTIVE),c=M.getVideoSdpDirection(l),l=c===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE?M.updateVideoSdpDirection(l,f.WEBRTC.MEDIA_STATE.SEND_ONLY):!t&&n?M.updateVideoSdpDirection(l,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):M.updateVideoSdpDirection(l,f.WEBRTC.MEDIA_STATE.INACTIVE),d=M.updateAudioSdpDirection(l,f.WEBRTC.MEDIA_STATE.INACTIVE),d=M.updateVideoSdpDirection(d,f.WEBRTC.MEDIA_STATE.INACTIVE),E=!0):(l=M.updateAudioSdpDirection(l,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE),fe.callCanLocalSendVideo(e)?(l=M.updateVideoSdpDirection(l,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE),fe.setLocalStreamVideoSendStatus(e,!0)):(l=M.updateVideoSdpDirection(l,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),fe.setLocalStreamVideoSendStatus(e,!1)),d=l,E=!1),d=M.fixLocalTelephoneEventPayloadType(e,d),S=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,d),T.setLocalDescription(S,function(){r.debug("createHoldUpdate: setLocalDescription success"),p=M.updateH264Level(l),o.muteOnHold(e,E),P.callFunctionIfExist(i,l)},function(e){r.error("createHoldUpdate: setLocalDescription failed : "+e),P.callFunctionIfExist(a)})},o.processUpdate=function(e,t,n,i){r.debug("processUpdate: state= "+e.peer.signalingState);var a,s,c,d,l,u,p,E,S,T=e.peer,m=!1;if(e.stableRemoteSdp=T.remoteDescription.sdp,e.stableLocalSdp=T.localDescription.sdp,e.sdp=M.addSdpMissingCryptoLine(e.sdp),e.sdp=M.removeSdpPli(e.sdp),e.sdp=M.removeG722Codec(e.sdp),e.sdp=M.performG722ParameterWorkaround(e.sdp),e.sdp=M.performVP8RTCPParameterWorkaround(e.sdp),e.sdp=M.removeRTXCodec(e.sdp),e.sdp=M.fixRemoteTelephoneEventPayloadType(e,e.sdp),e.sdp=M.checkAndRestoreICEParams(e.sdp,e.peer.localDescription.sdp),E=M.getVideoSdpDirection(e.sdp),o.setMediaVideo(M.isSdpHasVideo(e.sdp)),E===f.WEBRTC.MEDIA_STATE.INACTIVE&&"COMPLETED"===e.currentState)switch(e.remoteVideoState){case f.WEBRTC.MEDIA_STATE.INACTIVE:e.sdp=M.updateVideoSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE);break;case f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY:e.sdp=M.updateVideoSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE);break;case f.WEBRTC.MEDIA_STATE.SEND_RECEIVE:e.sdp=M.updateVideoSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)}i&&(e.sdp=M.updateAudioSdpDirectionToInactive(e.sdp),e.sdp=M.updateVideoSdpDirectionToInactive(e.sdp)),e.sdp=M.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.VIDEO),fe.callSetReceiveVideo(e),T.signalingState===f.WEBRTC.RTC_SIGNALING_STATE.HAVE_LOCAL_OFFER?(e.sdp=M.checkSupportedVideoCodecs(e.sdp,M.getSdpFromObject(e.peer.localDescription)),e.sdp=M.setMediaPassive(e.sdp,o.isDtlsEnabled()),u=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),T.setRemoteDescription(u,function(){e.remoteVideoState=M.getVideoSdpDirection(e.sdp),o.addCandidates(e),P.callFunctionIfExist(t,e.sdp),e.successCallback=null},function(e){r.debug("processUpdate: setRemoteDescription failed!!"+e),P.callFunctionIfExist(n,"processUpdate: setRemoteDescription failed!!")})):(e.sdp=M.checkSupportedVideoCodecs(e.sdp,null),c=M.getAudioSdpDirection(e.sdp),d=M.getVideoSdpDirection(e.sdp),(M.getVideoSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.INACTIVE||M.getVideoSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)&&(e.sdp=M.deleteInactiveVideoSsrc(e.sdp)),e.sdp=M.updateAudioSdpDirectionToInactive(e.sdp),e.sdp=M.updateVideoSdpDirectionToInactive(e.sdp),e.sdp=M.setMediaActPass(e.sdp,o.isDtlsEnabled()),l=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.prevRemoteSdp),p=T.localDescription.sdp,o.createNewPeerForCallIfIceChangedInRemoteSdp(e,e.sdp,e.prevRemoteSdp)&&(T=e.peer,m=!0),S=M.deleteSsrcFromSdp(e.sdp),u=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,S),T.setRemoteDescription(u,function(){r.debug("processUpdate: workaround setRemoteDescription success"),e.sdp=M.updateAudioSdpDirection(e.sdp,c),e.sdp=M.updateVideoSdpDirection(e.sdp,d),u=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),T.setRemoteDescription(u,function(){r.debug("processUpdate: setRemoteDescription success"),e.remoteVideoState=M.getVideoSdpDirection(e.sdp),o.addCandidates(e),T.createAnswer(T.remoteDescription,function(c){r.debug("processUpdate: isSdpEnabled audio= "+M.isAudioSdpEnabled(c.sdp)),r.debug("processUpdate: isSdpEnabled video= "+M.isVideoSdpEnabled(c.sdp)),M.isAudioSdpEnabled(c.sdp)||M.isVideoSdpEnabled(c.sdp)?(M.getAudioSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.SEND_ONLY&&(r.debug("processUpdate: audio sendonly -> recvonly"),c.audioDirection=f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),M.getAudioSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.INACTIVE&&(c.audioDirection=f.WEBRTC.MEDIA_STATE.INACTIVE),M.getVideoSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.INACTIVE&&(c.videoDirection=f.WEBRTC.MEDIA_STATE.INACTIVE),c.videoDirection=M.getVideoSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY?fe.callCanLocalSendVideo(e)?f.WEBRTC.MEDIA_STATE.SEND_ONLY:f.WEBRTC.MEDIA_STATE.INACTIVE:fe.callCanLocalSendVideo(e)?f.WEBRTC.MEDIA_STATE.SEND_RECEIVE:f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,a=M.getSdpFromObject(c),c=null,a=M.updateVersion(p,a),a=M.performVP8RTCPParameterWorkaround(a),a=M.checkIceParamsLengths(a,e.sdp),a=M.setMediaPassive(a,o.isDtlsEnabled()),a=M.fixLocalTelephoneEventPayloadType(e,a),m&&(a=M.copyCandidatesToTheNewLocalSdp(p,a),m=!1),e.answer=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,a),T.setLocalDescription(e.answer,function(){M.isMediaPortReady(a)&&(r.debug("processUpdate: setLocalDescription success"),s=M.updateH264Level(a),i&&(s=M.updateAudioSdpDirection(s,f.WEBRTC.MEDIA_STATE.INACTIVE),s=M.updateVideoSdpDirection(s,f.WEBRTC.MEDIA_STATE.INACTIVE)),P.callFunctionIfExist(t,s),e.successCallback=null,e.answer=null)},function(t){r.debug("processUpdate: setLocalDescription failed: "+t),P.callFunctionIfExist(n,"processUpdate: setlocalDescription failed!!"),e.answer=null})):(r.debug("processUpdate: createAnswer failed!!"),P.callFunctionIfExist(n,"No codec negotiation"))},function(e){r.debug("processUpdate: createAnswer failed!! "+e),P.callFunctionIfExist(n,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},function(e){r.debug("processUpdate: setRemoteDescription failed: "+e),P.callFunctionIfExist(n,"processUpdate: setRemoteDescription failed!!")})},function(e){r.debug("processUpdate: workaround setRemoteDescription failed!!"+e),P.callFunctionIfExist(n,"processUpdate: workaround setRemoteDescription failed!!")}))},o.processAnswer=function(e,t,n){r.debug("processAnswer: state= "+e.peer.signalingState);var i,a,s,c,d;s=function(){e.remoteVideoState=M.getVideoSdpDirection(e.sdp),e.videoOfferSent=M.isSdpHasVideo(e.sdp),o.addCandidates(e),P.callFunctionIfExist(t)},e.sdp=M.checkSupportedVideoCodecs(e.sdp,M.getSdpFromObject(e.peer.localDescription)),e.sdp=M.performVideoPortZeroWorkaround(e.sdp),e.sdp=M.removeSdpPli(e.sdp),e.sdp=M.removeG722Codec(e.sdp),e.sdp=M.performG722ParameterWorkaround(e.sdp),e.sdp=M.performVP8RTCPParameterWorkaround(e.sdp),e.sdp=M.performVP8BandwidthWorkaround(e.sdp),e.sdp=M.removeRTXCodec(e.sdp),e.sdp=M.fixRemoteTelephoneEventPayloadType(e,e.sdp),fe.callSetReceiveVideo(e),c=M.getVideoSdpDirection(e.sdp),d=M.getVideoSdpDirection(M.getSdpFromObject(e.peer.localDescription)),r.debug("processAnswer: ice-lite: do remote video escalation"),e.sdp=M.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE),d!==f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY||c!==f.WEBRTC.MEDIA_STATE.INACTIVE&&c!==f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY?d!==f.WEBRTC.MEDIA_STATE.SEND_RECEIVE||c!==f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY&&c!==f.WEBRTC.MEDIA_STATE.INACTIVE?d!==f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY||c!==f.WEBRTC.MEDIA_STATE.SEND_ONLY&&c!==f.WEBRTC.MEDIA_STATE.SEND_RECEIVE?(e.sdp=M.setMediaPassive(e.sdp,o.isDtlsEnabled()),e.peer.setRemoteDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),function(){r.debug("processAnswer: setRemoteDescription success"),P.callFunctionIfExist(s)},function(e){r.debug("processAnswer: setRemoteDescription failed: "+e),P.callFunctionIfExist(n)})):(i=function(){o.performVideoStartWorkaround(e,s,n)},a=function(){o.restoreActualSdp(e,i,n,d,c)},o.performOrigAudioWorkaround(e,i,n)):(e.sdp=M.deleteInactiveVideoSsrc(e.sdp),a=function(){o.restoreActualSdp(e,s,n,d,c)},o.performOrigAudioWorkaround(e,s,n)):(e.sdp=M.deleteInactiveVideoSsrc(e.sdp),o.performOrigAudioWorkaround(e,s,n))},o.performOrigAudioWorkaround=function(e,t,n){r.debug("Workaround for orig side to hear audio"),e.sdp=M.setMediaPassive(e.sdp,o.isDtlsEnabled()),e.peer.setRemoteDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),function(){r.debug("performNativeOrigAudioWorkaround: setRemoteDescription success"),P.callFunctionIfExist(t)},function(e){r.debug("performNativeOrigAudioWorkaround: setRemoteDescription failed: "+e),P.callFunctionIfExist(n)})},o.restoreActualSdp=function(e,t,n,i,a){r.debug("Restore manipulated local and remote sdp's");var s=M.getSdpFromObject(e.peer.localDescription);s=M.updateSdpDirection(s,f.STRING.VIDEO,i),s=M.setMediaActPass(s,o.isDtlsEnabled()),e.sdp=M.setMediaPassive(e.sdp,o.isDtlsEnabled()),s=M.fixLocalTelephoneEventPayloadType(e,s),e.peer.setLocalDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,s),function(){r.debug("restoreActualSdp: setLocalDescription success"),e.sdp=M.changeDirection(e.sdp,f.WEBRTC.RTC_SDP_TYPE.SEND_ONLY,a,f.STRING.VIDEO),e.sdp=M.changeDirection(e.sdp,f.WEBRTC.RTC_SDP_TYPE.SEND_ONLY,f.WEBRTC.RTC_SDP_TYPE.SEND_RECEIVE,f.STRING.VIDEO),fe.callSetReceiveVideo(e),e.peer.setRemoteDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),function(){r.debug("restoreActualSdp: setRemoteDescription success"),P.callFunctionIfExist(t)},function(e){r.debug("restoreActualSdp: setRemoteDescription failed: "+e),P.callFunctionIfExist(n)})},function(e){r.debug("restoreActualSdp: setLocalDescription failed: "+e),P.callFunctionIfExist(n)})},o.performVideoStartWorkaround=function(e,t,n){var i,a,s,c=e.peer;r.debug("Workaround to play video"),e.sdp=M.addSdpMissingCryptoLine(e.sdp),i=M.getSdpDirectionLogging(e.sdp,f.STRING.AUDIO,!1),a=M.getSdpDirectionLogging(e.sdp,f.STRING.VIDEO,!1),e.sdp=M.updateSdpDirection(e.sdp,f.STRING.AUDIO,f.WEBRTC.MEDIA_STATE.INACTIVE),e.sdp=M.updateSdpDirection(e.sdp,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.INACTIVE),e.sdp=M.setMediaActPass(e.sdp,o.isDtlsEnabled()),s=M.deleteSsrcFromSdp(e.sdp),c.setRemoteDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,s),function(){r.debug("performVideoStartWorkaround: first setRemoteDescription success"),e.sdp=M.updateSdpDirection(e.sdp,f.STRING.AUDIO,i),e.sdp=M.updateSdpDirection(e.sdp,f.STRING.VIDEO,a),c.setRemoteDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),function(){r.debug("performVideoStartWorkaround: second setRemoteDescription success"),c.createAnswer(c.remoteDescription,function(i){var a=M.getSdpFromObject(i);M.getSdpDirectionLogging(e.sdp,f.STRING.AUDIO,!1)===f.WEBRTC.MEDIA_STATE.INACTIVE&&(a=M.updateSdpDirection(a,f.STRING.AUDIO,f.WEBRTC.MEDIA_STATE.INACTIVE)),a=e.remoteVideoState===f.WEBRTC.MEDIA_STATE.INACTIVE?M.updateSdpDirection(a,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.INACTIVE):fe.callCanLocalSendVideo(e)?M.updateSdpDirection(a,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):M.updateSdpDirection(a,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),a=M.performVP8RTCPParameterWorkaround(a),o.fireOnStreamAddedEvent(e),a=M.checkAndRestoreICEParams(a,e.sdp),a=M.setMediaPassive(a,o.isDtlsEnabled()),a=M.fixLocalTelephoneEventPayloadType(e,a),c.setLocalDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,a),function(){r.debug("performVideoStartWorkaround: setlocalDescription success"),P.callFunctionIfExist(t)},function(e){r.debug("performVideoStartWorkaround: setlocalDescription failed!!"+e),P.callFunctionIfExist(n,"performVideoStartWorkaround: setlocalDescription failed!!")})},function(e){r.debug("performVideoStartWorkaround: createAnswer failed!! "+e),P.callFunctionIfExist(n,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},function(e){r.debug("performVideoStartWorkaround: second setRemoteDescription failed!!"+e),P.callFunctionIfExist(n,"performVideoStartWorkaround: second setRemoteDescription failed!!")})},function(e){r.debug("performVideoStartWorkaround: first setRemoteDescription failed!!"+e),P.callFunctionIfExist(n,"performVideoStartWorkaround: first setRemoteDescription failed!!")})},o.processPreAnswer=function(e){var t;r.debug("processPreAnswer: state= "+e.peer.signalingState),e.sdp=M.checkSupportedVideoCodecs(e.sdp,M.getSdpFromObject(e.peer.localDescription)),e.sdp=M.removeG722Codec(e.sdp),e.sdp=M.performG722ParameterWorkaround(e.sdp),e.sdp=M.performVP8RTCPParameterWorkaround(e.sdp),e.sdp=M.removeRTXCodec(e.sdp),e.sdp=M.fixRemoteTelephoneEventPayloadType(e,e.sdp),fe.callSetReceiveVideo(e),o.addCandidates(e),t=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.PRANSWER,e.sdp),e.peer.setRemoteDescription(t,function(){e.remoteVideoState=M.getVideoSdpDirection(e.sdp),r.debug("processPreAnswer: setRemoteDescription success")},function(e){r.debug("processPreAnswer: setRemoteDescription failed: "+e)})},o.processRespond=function(e,t,n,i){var a;if(r.debug("processRespond: state= "+e.peer.signalingState),e.sdp=M.checkSupportedVideoCodecs(e.sdp,M.getSdpFromObject(e.peer.localDescription)),e.sdp=M.removeSdpPli(e.sdp),e.sdp=M.removeG722Codec(e.sdp),e.sdp=M.performG722ParameterWorkaround(e.sdp),e.sdp=M.performVP8RTCPParameterWorkaround(e.sdp),e.sdp=M.performVP8BandwidthWorkaround(e.sdp),e.sdp=M.removeRTXCodec(e.sdp),e.sdp=M.fixRemoteTelephoneEventPayloadType(e,e.sdp),a=M.getVideoSdpDirection(e.sdp),fe.callSetReceiveVideo(e),a===f.WEBRTC.MEDIA_STATE.INACTIVE&&"COMPLETED"===e.currentState)switch(e.remoteVideoState){case f.WEBRTC.MEDIA_STATE.INACTIVE:e.sdp=M.updateSdpDirection(e.sdp,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY);break;case f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY:e.sdp=M.updateSdpDirection(e.sdp,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)}return e.remoteVideoState=M.getVideoSdpDirection(e.sdp),e.sdp=M.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.VIDEO),i&&(e.sdp=M.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.AUDIO),o.muteOnHold(e,!1)),e.peer.signalingState===f.WEBRTC.RTC_SIGNALING_STATE.STABLE?void P.callFunctionIfExist(t):(e.sdp=M.setMediaPassive(e.sdp,o.isDtlsEnabled()),(M.getVideoSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.INACTIVE||M.getVideoSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)&&(e.sdp=M.deleteInactiveVideoSsrc(e.sdp)),void e.peer.setRemoteDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),function(){r.debug("processRespond: setRemoteDescription success");var i=function(){e.remoteVideoState=M.getVideoSdpDirection(e.sdp),e.videoOfferSent=!0,o.addCandidates(e),P.callFunctionIfExist(t)};o.performVideoStartWorkaround(e,i,n)},function(e){r.debug("processRespond: setRemoteDescription failed: "+e),P.callFunctionIfExist(n)}))},o.createReOffer=function(e,t,n,i){var a,s,c,d=e.peer;d.createOffer(function(i){a=M.getSdpFromObject(i),i=null,a=M.deleteCryptoZeroFromSdp(a),a=M.performVP8RTCPParameterWorkaround(a),a=M.updateAudioCodec(a),a=M.removeG722Codec(a),a=M.deleteCryptoFromSdp(a,o.isDtlsEnabled()),a=M.setMediaActPass(a,o.isDtlsEnabled()),a=M.fixLocalTelephoneEventPayloadType(e,a),a=M.replaceOpusCodec(a),c=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,a),e.offer=c,d.setLocalDescription(c,function(){r.debug("create ReOffer setLocalDescription success"),s=M.getSdpFromObject(c),M.isMediaPortReady(s)&&e.successCallback&&(P.callFunctionIfExist(t,s),e.successCallback=null,e.offer=null,e.answer=null)},function(e){P.callFunctionIfExist(n,"screate ReOffer setLocalDescription failed: "+e)})},function(e){r.error("create ReOffer failed!! "+e),P.callFunctionIfExist(n)},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo(),IceRestart:i}})},o.processHold=function(e,t,n,i,a){function s(){d.audioDirection=f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,(M.getVideoSdpDirection(d.sdp)===f.WEBRTC.MEDIA_STATE.INACTIVE||M.getVideoSdpDirection(d.sdp)===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)&&(d.sdp=M.deleteInactiveVideoSsrc(d.sdp)),C.setRemoteDescription(d,function(){e.remoteVideoState=t||n||u!==f.WEBRTC.MEDIA_STATE.INACTIVE?d.videoDirection:f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,fe.callSetReceiveVideo(e),C.createAnswer(C.remoteDescription,function(s){g=M.getSdpFromObject(s),r.debug("processHold: isSdpEnabled audio= "+M.isAudioSdpEnabled(s.sdp)),r.debug("processHold: isSdpEnabled video= "+M.isVideoSdpEnabled(s.sdp)),s=null,t?(r.debug("processHold: Remote HOLD"),g=M.respondToRemoteSdpDirections(g,e.sdp)):n?n&&!t&&(r.debug("processHold: Remote UNHOLD on local hold"),g=l===f.WEBRTC.MEDIA_STATE.INACTIVE?M.updateAudioSdpDirectionToInactive(g):M.updateAudioSdpDirection(g,f.WEBRTC.MEDIA_STATE.SEND_ONLY),g=fe.callCanLocalSendVideo(e)?M.updateVideoSdpDirection(g,f.WEBRTC.MEDIA_STATE.SEND_ONLY):M.updateVideoSdpDirectionToInactive(g)):(r.debug("processHold: Remote UNHOLD: direction left as it is"),g=fe.callCanLocalSendVideo(e)?M.isSdpVideoSendEnabled(e.sdp)?M.updateVideoSdpDirection(g,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):u===f.WEBRTC.MEDIA_STATE.INACTIVE?M.updateVideoSdpDirection(g,f.WEBRTC.MEDIA_STATE.INACTIVE):M.updateVideoSdpDirection(g,f.WEBRTC.MEDIA_STATE.SEND_ONLY):M.isSdpVideoSendEnabled(e.sdp)?M.updateVideoSdpDirection(g,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY):M.updateVideoSdpDirection(g,f.WEBRTC.MEDIA_STATE.INACTIVE),g=M.changeDirection(g,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.AUDIO)),g=M.performVP8RTCPParameterWorkaround(g),g=M.updateVersion(m,g),g=M.checkIceParamsLengths(g,d.sdp),g=M.fixLocalTelephoneEventPayloadType(e,g),g=M.setMediaPassive(g,o.isDtlsEnabled()),g=M.updateH264Level(g),I&&(g=M.copyCandidatesToTheNewLocalSdp(m,g),I=!1,e.offer=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,m)),p=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,g),e.answer=p,C.setLocalDescription(p,function(){E=M.getSdpFromObject(p),M.isMediaPortReady(E)&&e.successCallback&&(P.callFunctionIfExist(i,E),e.successCallback=null,e.offer=null,e.answer=null)},function(t){r.debug("processHold: setLocalDescription failed!! "+t),P.callFunctionIfExist(a,"Session cannot be created"),e.answer=null})},function(e){r.debug("processHold: createAnswer failed!!: "+e),P.callFunctionIfExist(a,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},function(e){r.debug("processHold: second setRemoteDescription failed!! "+e),P.callFunctionIfExist(a,"Session cannot be created")})}function c(e){r.debug("processHold: first setRemoteDescription failed!! "+e),P.callFunctionIfExist(a,"Session cannot be created")}r.debug("processHold: local hold= "+n+" remote hold= "+t+" state= "+e.peer.signalingState);var d,l,u,p,E,S,T,m,g,C=e.peer,I=!1;e.stableRemoteSdp=C.remoteDescription.sdp,e.stableLocalSdp=C.localDescription.sdp,n||t||o.muteOnHold(e,!1),e.sdp=M.checkSupportedVideoCodecs(e.sdp,null),e.sdp=M.performVideoPortZeroWorkaround(e.sdp),e.sdp=M.checkAndRestoreICEParams(e.sdp,M.getSdpFromObject(e.peer.localDescription)),e.sdp=M.removeG722Codec(e.sdp),e.sdp=M.performG722ParameterWorkaround(e.sdp),e.sdp=M.performVP8RTCPParameterWorkaround(e.sdp),e.sdp=M.fixRemoteTelephoneEventPayloadType(e,e.sdp),e.sdp=M.performVP8BandwidthWorkaround(e.sdp),e.sdp=M.setMediaActPass(e.sdp,o.isDtlsEnabled()),l=M.getAudioSdpDirection(e.sdp),u=M.getVideoSdpDirection(e.sdp),d=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),m=M.getSdpFromObject(C.localDescription),T=M.deleteSsrcFromSdp(e.prevRemoteSdp),S=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,M.getSdpFromObject(d)),S.audioDirection=f.WEBRTC.MEDIA_STATE.INACTIVE,S.videoDirection=f.WEBRTC.MEDIA_STATE.INACTIVE,o.createNewPeerForCallIfIceChangedInRemoteSdp(e,e.sdp,e.prevRemoteSdp)&&(C=e.peer,I=!0),I?s():C.setRemoteDescription(S,s,c)},o.processHoldRespond=function(e,t,n,i){var a,s,c=!1,d=!1;r.debug("processHoldRespond: state= "+e.peer.signalingState+" call.currentState= "+e.currentState),e.sdp=M.checkSupportedVideoCodecs(e.sdp,M.getSdpFromObject(e.peer.localDescription)),e.sdp=M.removeRTXCodec(e.sdp),e.sdp=M.fixRemoteTelephoneEventPayloadType(e,e.sdp),e.sdp=M.removeG722Codec(e.sdp),e.sdp=M.performG722ParameterWorkaround(e.sdp),e.sdp=M.performVP8BandwidthWorkaround(e.sdp),M.init(e.sdp),d=M.isRemoteHold(),c="LOCAL_HOLD"===e.currentState,a=M.getAudioSdpDirection(e.sdp),s=M.getVideoSdpDirection(e.sdp),r.debug("processHoldRespond: localHold= "+c+" remoteHold= "+d),d===!1?a===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE&&"REMOTE_HOLD"===e.currentState&&(e.previousState=e.currentState,e.currentState="COMPLETED"):"COMPLETED"===e.currentState&&(e.previousState=e.currentState,e.currentState="REMOTE_HOLD"),(c||d)&&(r.debug("processHoldRespond: "+e.currentState+" : video -> inactive"),e.sdp=M.updateSdpDirection(e.sdp,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.INACTIVE)),s===f.WEBRTC.MEDIA_STATE.INACTIVE&&"COMPLETED"===e.currentState&&(r.debug("processHoldRespond: video inactive -> recvonly"),e.sdp=M.updateSdpDirection(e.sdp,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)),o.processRespond(e,t,n,i)},o.createUpdateWithSetLocalDescription=function(e,t,n,i,a){var s,c,d=e.peer;r.debug("set local description to start the video"),e.isVideoSourceAllowed||o.replaceLocalStream(e),o.getLocalVideoTrack(e.peer)&&(o.getLocalVideoTrack(e.peer).enabled=i),s=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,a),s.videoDirection=i?f.WEBRTC.MEDIA_STATE.SEND_RECEIVE:f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,d.setLocalDescription(s,function(){r.debug("createUpdate: setLocalDescription success "),c=M.updateH264Level(M.getSdpFromObject(s)),P.callFunctionIfExist(t,c),e.successCallback=null},function(e){r.error("createUpdate: setLocalDescription failed : "+e),P.callFunctionIfExist(n)})},o.createUpdateWithCreateOffer=function(e,t,n,i,a,s){var c,d=e.peer;r.debug("create new offer to start the video: isIceLite = "+s),o.replaceLocalStream(e),o.setMediaVideo(M.isSdpHasVideo(a)),d.createOffer(function(t){i=i&&o.getVideoSourceAvailable(),t.videoDirection=i?f.WEBRTC.MEDIA_STATE.SEND_RECEIVE:f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,c=M.performVP8RTCPParameterWorkaround(M.getSdpFromObject(t)),t=null,c=M.updateH264Level(c),c=M.deleteCryptoZeroFromSdp(c),c=M.performVP8RTCPParameterWorkaround(c),c=M.updateAudioCodec(c),c=M.removeG722Codec(c),c=M.deleteCryptoFromSdp(c,o.isDtlsEnabled()),c=M.setMediaActPass(c,o.isDtlsEnabled()),c=M.fixLocalTelephoneEventPayloadType(e,c),c=M.replaceOpusCodec(c),e.offer=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,c),d.setLocalDescription(e.offer,function(){r.debug("createUpdate: createOffer setLocalDescription success "),fe.setLocalStreamVideoSendStatus(e,i)},function(e){r.debug("createUpdate: createOffer setLocalDescription failed: "+e),P.callFunctionIfExist(n)})},function(e){r.debug("createUpdate: createOffer failed!!: "+e),n()},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo(),IceRestart:!s}})},o.createPeer=function(e,t,n){try{var i,a,s,c,d=[],l=o.getIceServerUrl();if(l instanceof Array)for(s=0;s<l.length;s++)d[s]=l[s];
else null===l||""===l?d=[]:d[0]=l;c={iceServers:d},a={optional:{DtlsSrtpKeyAgreement:o.isDtlsEnabled()}},i=o.getRtcLibrary().createRTCPeerConnection(c,a),o.setPeerCount(o.getPeerCount()+1),e.peer=i,i.onconnecting=function(t){o.onSessionConnecting(e,t)},i.onopen=function(t){o.onSessionOpened(e,t)},i.onsignalingstatechange=function(t){o.onSignalingStateChange(e,t)},i.onaddstream=function(t){o.onRemoteStreamAdded(e,t)},i.onremovestream=function(t){o.onRemoteStreamRemoved(e,t)},i.onicecandidate=function(t){o.setupIceCandidateCollectionTimer(e),o.onIceCandidate(e,t)},i.onicecomplete=function(){o.onIceComplete(e)},i.oniceconnectionstatechange=function(t){o.oniceconnectionstatechange(e,t)},r.info("create PeerConnection successfully."),P.callFunctionIfExist(t)}catch(u){r.error("Failed to create PeerConnection, exception: "+u.message),P.callFunctionIfExist(n)}},o.createNewPeerForCall=function(e){var t=!1,n=o.getPeerCount();return e.peer&&(e.peer.close(),o.setPeerCount(n-1)),r.trace("Creating new peer for call: "+e.id),o.createPeer(e,function(){r.trace("New peer has created for call: "+e.id),e.peer.addStream(o.getLocalStream()),t=!0},function(){r.error("New peer creation has failed!: "+e.id)}),t},o.createNewPeerForCallIfIceChangedInRemoteSdp=function(e,t,n){var i=M.isIceLite(t),a=M.isIceLite(n),s=!1;return i!==a?(r.trace("Ice - Ice-Lite change detected in call: "+e.id),o.createNewPeerForCall(e)):s},o.onRemoteStreamAdded=function(e,t){var n;r.debug("onRemoteStreamAdded"),t.stream&&(n=o.getRtcLibrary().getURLFromStream(t.stream),n&&(r.debug("onRemoteStreamAdded: "+n),o.getDefaultVideoContainer()?o.useDefaultRenderer(n,!1):o.getRemoteVideoContainer()?o.createStreamRenderer(n,o.getRemoteVideoContainer()):o.fireOnStreamAddedEvent(e,n)))},o.iceCandidateCollectionTimeoutHandler=function(e){var t=e.peer.localDescription.sdp;return o.clearIceCandidateCollectionTimer(e),M.isSdpHasAudio(t)&&M.isSdpHasAudioWithZeroPort(t)||M.isSdpHasVideo(t)&&M.isSdpHasVideoWithZeroPort(t)?(r.debug("Re-setting ice candidate collection timeout: "+C.iceCandidateCollectionTimeoutInterval),void(e.iceCandidateCollectionTimer=setTimeout(function(){o.iceCandidateCollectionTimeoutHandler(e)},C.iceCandidateCollectionTimeoutInterval))):void(e.successCallback&&(r.debug("Ice candidate collection interrupted after given timeout, invoking successCallback."),t=M.updateH264Level(t),e.successCallback(t),e.successCallback=null))},o.setupIceCandidateCollectionTimer=function(e){C.iceCandidateCollectionTimeoutInterval&&(e.iceCandidateCollectionTimer?r.trace("Ice candidate collection timer exists."):(r.debug("Setting ice candidate collection timeout: "+C.iceCandidateCollectionTimeoutInterval),e.iceCandidateCollectionTimer=setTimeout(function(){o.iceCandidateCollectionTimeoutHandler(e)},C.iceCandidateCollectionTimeoutInterval)))},o.onIceCandidate=function(e,t){var n;null===t.candidate?e.successCallback&&(r.debug("All ICE candidates received for call : "+e.id),n=M.getSdpFromObject(e.peer.localDescription),n=M.updateH264Level(n),e.successCallback(n),e.successCallback=null):(e.iceCandidateReceived=!0,r.debug("ICE candidate received : sdpMLineIndex = "+t.candidate.sdpMLineIndex+", candidate = "+t.candidate.candidate+" for call : "+e.id))},o.getRemoteVideoResolutions=function(){var e,t,n=[];if(o.getRemoteVideoContainer()){if(!o.getRemoteVideoContainer().firstChild)return n;e=o.getRemoteVideoContainer().firstChild.videoHeight,t=o.getRemoteVideoContainer().firstChild.videoWidth}else{if(!o.getDefaultVideoContainer().firstElementChild.firstChild)return n;e=o.getDefaultVideoContainer().firstElementChild.firstChild.videoHeight,t=o.getDefaultVideoContainer().firstElementChild.firstChild.videoWidth}return r.debug("remote video resolutions of plugin webrtc..."),r.debug("remoteVideoWidth  : "+t),r.debug("remoteVideoHeight : "+e),n.push(e),n.push(t),o.getLocalVideoResolutions(),n},o.getLocalVideoResolutions=function(){var e,t,n=[];if(o.getLocalVideoContainer()){if(!o.getLocalVideoContainer().firstChild)return n;e=o.getLocalVideoContainer().firstChild.videoHeight,t=o.getLocalVideoContainer().firstChild.videoWidth}else{if(!o.getDefaultVideoContainer().lastElementChild.firstChild)return n;e=o.getDefaultVideoContainer().lastElementChild.firstChild.videoHeight,t=o.getDefaultVideoContainer().lastElementChild.firstChild.videoWidth}return r.debug("local video resolutions of plugin webrtc..."),r.debug("localVideoWidth  : "+t),r.debug("localVideoHeight : "+e),n.push(e),n.push(t),n},o.useDefaultRenderer=function(e,t){var n;o.getDefaultVideoContainer()&&0===o.getDefaultVideoContainer().children.length&&(o.getDefaultVideoContainer().innerHTML="<div style='height:100%;width:100%'></div><div style='position:absolute;bottom:10px;right:10px;height:30%; width:30%;'></div>"),n=t?o.getLocalVideoContainer()?o.getLocalVideoContainer():o.getDefaultVideoContainer().lastElementChild:o.getRemoteVideoContainer()?o.getRemoteVideoContainer():o.getDefaultVideoContainer().firstElementChild,o.createStreamRenderer(e,n,{muted:t})},o.createStreamRenderer=function(e,t,n){var i;if(e&&t)return t.innerHTML="<object width='100%' height='100%' type='application/x-gcfwenabler-video'><param name='autoplay' value='true' /><param name='videosrc' value='"+e+"' /></object>",i},o.addLocalStream=function(e){var t,n=!1;r.debug("addLocalStream"),e.localStream&&(fe.callCanLocalSendVideo(e)?(t=o.getRtcLibrary().getURLFromStream(e.localStream),t&&(r.debug("addLocalStream: "+t),o.getDefaultVideoContainer()?o.useDefaultRenderer(t,!0):o.getLocalVideoContainer()?o.createStreamRenderer(t,o.getLocalVideoContainer(),{muted:!0}):e.call.localStreamURL=t,n=!0)):o.getDefaultVideoContainer()?o.getDefaultVideoContainer().lastElementChild&&(o.disposeStreamRenderer(o.getDefaultVideoContainer().lastElementChild),n=!0):o.getLocalVideoContainer()&&(o.disposeStreamRenderer(o.getLocalVideoContainer()),n=!0),n&&o.fireOnLocalStreamAddedEvent(e))},o.replaceLocalStream=function(e){r.debug("replaceLocalStream"),e.peer.localStreams.length>0&&e.peer.removeStream(e.peer.localStreams[0]),e.peer.addStream(o.getLocalStream()),e.localStream=o.getLocalStream()},o.sendIntraFrame=function(e){e.peer&&(fe.callCanLocalSendVideo(e)?e.peer.sendIntraFrame():e.peer.sendBlackFrame())},o.sendBlackFrame=function(e){e.peer&&e.peer.sendBlackFrame()},o.performReconnectWorkaround=function(e,t,n){P.callFunctionIfExist(n)},r.debug("WebRtcPluginAdaptor initialized")},Q=function(e,t,n){var i=t||G,o=n||new H;return new Z(e||new z({},i,o),i,o,O)};l&&(l.WebRtcPluginAdaptor=Q);var X=function(e,t,n,i){var o=this,r={major:2,minor:1,min_revision:343,min_build:0,current_revision:376,current_build:0},a=i.getLogger("WebRtcPluginv21AdaptorImpl");a.debug("WebRtcPluginv21Adaptor initializing"),P.compose(e,o),P.compose(n,o),o.setPluginVersion(r),a.debug("WebRtcPluginv21Adaptor initialized")},$=function(e,t,n){var i=t||G,o=n||new H;return new X(e||new Q(void 0,i,o),i,o,O)};l&&(l.WebRtcPluginv21Adaptor=$);var ee=function(e,t,n,i){var o=this,r={major:2,minor:2,min_revision:477,min_build:0,current_revision:477,current_build:0},a=i.getLogger("WebRtcPluginv22AdaptorImpl");a.debug("WebRtcPluginv22Adaptor initializing"),P.compose(e,o),P.compose(n,o),o.setPluginVersion(r),a.debug("WebRtcPluginv22Adaptor initialized")},te=function(e,t,n){var i=t||G,o=n||new H;return new ee(e||new Q(void 0,i,o),i,o,O)};l&&(l.WebRtcPluginv22Adaptor=te);var ne=function(e,t,n,i){var o=this,r={major:3,minor:0,min_revision:476,min_build:0,current_revision:476,current_build:0},a=i.getLogger("WebRtcPluginv30AdaptorImpl");a.debug("WebRtcPluginv30Adaptor initializing"),P.compose(e,o),P.compose(n,o),o.setPluginVersion(r),a.debug("WebRtcPluginv30Adaptor initialized")},ie=function(e,t,n){var i=t||G,o=n||new H;return new ne(e||new Q(void 0,i,o),i,o,O)};l&&(l.WebRtcPluginv30Adaptor=ie);var oe=function(e,t,n,i){var o=this,r=i.getLogger("WebRtcChromeAdaptorImpl");r.debug("WebRtcChromeAdaptor initializing"),P.compose(e,o),r.debug("WebRtcChromeAdaptor initialized")},re=function(e,t,n){var i=t||q,o=n||new U;return new oe(e||new z({},i,o),i,o,O)};l&&(l.WebRtcChromeAdaptor=re);var ae=function(e,t,n,i){var o=this,r=i.getLogger("WebRtcFirefoxAdaptorImpl");r.debug("WebRtcFirefoxAdaptor initializing"),P.compose(e,o),r.debug("WebRtcFirefoxAdaptor initialized")},se=function(e,t,n){var i=t||j,o=n||new x;return new ae(e||new z({},i,o),i,o,O)};l&&(l.WebRtcFirefoxAdaptor=se);var ce=function(e,t,n,i,o,r,a,s){function c(){return t.webkitGetUserMedia?f.CHROME:t.mozGetUserMedia?f.FIREFOX:f.PLUGIN}function d(e){var t;if(!e||!e.pluginMode)return E.AUTO;for(t in E)if(E[t]===e.pluginMode)return E[t];return E.AUTO}function l(e,t){var n=d(e);return m[t][n]||n}var u,p=n.getLogger("WebRtcAdaptorFactory"),f={CHROME:"chrome",FIREFOX:"firefox",PLUGIN:"plugin"},E={WEBRTCH264:"webrtch264",WEBRTC22:"webrtc22",WEBRTC21:"webrtc21",WEBRTC:"webrtc",AUTO:"auto",AUTO21:"auto21",AUTO22:"auto22",AUTOH264:"autoh264",AUTOFIREFOX:"autofirefox"},S=E.WEBRTC22,T=o,m={chrome:{webrtc:S,autofirefox:E.AUTO,autoh264:E.AUTO,webrtch264:E.WEBRTCH264},firefox:{webrtc:S,auto:S,auto21:E.WEBRTC21,auto22:E.WEBRTC22,autoh264:E.WEBRTCH264,autofirefox:E.AUTO},plugin:{auto:S,auto21:E.WEBRTC21,auto22:E.WEBRTC22,autoh264:E.WEBRTCH264,autofirefox:S,webrtc:S}},g={chrome:{auto:a,autoh264:a,webrtc21:i,webrtc22:o,webrtch264:r},firefox:{auto:s,webrtc21:i,webrtc22:o,webrtch264:r},plugin:{webrtc21:i,webrtc22:o,webrtch264:r}};this.getWebRtcAdaptor=function(t){var n,i=c();return u=l(t,i),n=g[i][u],n||(p.debug("Invalid Plugin Mode Detected, Treated as WEBRTC"),u=S,n=T),p.debug("Adaptor initializing from "+i+" browser and "+u+" plugIn mode"),e.pluginMode=u,new n},this.getPluginModes=function(){return E},this.getDefaultRtcPluginMode=function(){return S},this.getDefaultRtcAdaptor=function(){return T}},de=new ce(window,navigator,O,$,te,ie,re,se);l&&(l.WebRtcAdaptorFactory=ce);var le=function(e,t,n,i){function o(e){s=e}function r(e){var t,n;if(e instanceof Array)for(t=0;t<e.length;t++)n=e[t].url.substring(0,e[t].url.indexOf(":")),("turn"===n||"turns"===n)&&(e[t].credential=s.credential,e[t].username=s.username);return e}var a,s,c=this,d=t.getLogger("WebRtcManager");c.initMedia=function(t,n,i){var o="";d.info("Initializing media for call"),a=e.getWebRtcAdaptor(i),i&&(i.iceserver&&(o=i.iceserver,s&&(o=r(o)),a.setIceServerUrl(o)),i.webrtcdtls&&a.setDtlsEnabled(i.webrtcdtls)),a.initMedia(t,n,i)},c.getUserMedia=function(e,t,n){var o;d.info("getting user media for call: started - userAgent: "+i.userAgent),n&&(void 0!==n.audio&&a.setMediaAudio(n.audio),void 0!==n.video&&a.setMediaVideo(n.video),n.videoResolution&&(o=n.videoResolution.split("x"),o[0]&&o[1]&&(a.setVideoWidth(o[0]),a.setVideoHeight(o[1])))),a.getUserMedia(e,t)},c.createOffer=function(e,t,n,i){d.info("create offer SDP: sendInitialVideo= "+i),e.successCallback=t,e.failureCallback=n,e.peer||a.createPeer(e,function(){},function(){P.callFunctionIfExist(n,2)}),a.createOffer(e,t,n,i)},c.createAnswer=function(e,t,n,i){d.info("creating answer SDP: callid= "+e.id),d.info("creating answer SDP: isVideoEnabled= "+i),e.successCallback=t,e.failureCallback=n,e.peer||a.createPeer(e,function(){},function(){P.callFunctionIfExist(n,2)}),a.createAnswer(e,t,n,i)},c.processAnswer=function(e,t,n){e.peer&&a.processAnswer(e,t,n)},c.processRespond=function(e,t,n,i){e.peer&&a.processRespond(e,t,n,i)},c.createUpdate=function(e,t,n,i){d.info("createUpdate: isVideoStart= "+i),e.successCallback=t,e.failureCallback=n,e.peer&&a.createUpdate(e,t,n,i)},c.processUpdate=function(e,t,n,i){d.info("processUpdate: local_hold_status:"+i),e.successCallback=t,e.failureCallback=n,e.peer&&a.processUpdate(e,t,n,i)},c.createReOffer=function(e,t,n,i){e.successCallback=t,e.failureCallback=n,e.peer&&a.createReOffer(e,t,n,i)},c.createHoldUpdate=function(e,t,n,i,o){d.info("create hold update local hold= "+t+" remote hold= "+n),e.peer&&a.createHoldUpdate(e,t,n,i,o)},c.processRemoteOfferOnLocalHold=function(e,t,n){e.peer&&a.processRemoteOfferOnLocalHold(e,t,n)},c.processEnd=function(e){e.peer&&a.processEnd(e)},c.processHold=function(e,t,n,i,o){d.info("processHold: local hold= "+n+" remote hold= "+t),e.peer&&(e.successCallback=i,a.processHold(e,t,n,i,o))},c.processHoldRespond=function(e,t,n,i){d.info("Processing response to hold offer sent"),e.peer&&a.processHoldRespond(e,t,n,i)},c.processPreAnswer=function(e){d.info("processing preanswer from the offer we sent"),e.peer&&a.processPreAnswer(e)},c.revertRtcState=function(e,t,n){a.revertRtcState(e,t,n)},c.getRemoteVideoResolutions=function(){return a.getRemoteVideoResolutions()},c.getLocalVideoResolutions=function(){return a.getLocalVideoResolutions()},c.isAudioSourceAvailable=function(){return a.getAudioSourceAvailable()},c.isVideoSourceAvailable=function(){return a.getVideoSourceAvailable()},c.refreshVideoRenderer=function(){a.refreshVideoRenderer()},c.performReconnectWorkaround=function(e,t){e.successCallback=t,a.performReconnectWorkaround(e)},c.sendIntraFrame=function(e){a.sendIntraFrame(e)},c.sendBlackFrame=function(e){a.sendBlackFrame(e)},c.getLocalAudioTrack=function(e){return a.getLocalAudioTrack(e)},c.addLocalStream=function(e){a.addLocalStream(e)},c.isPluginEnabled=function(){return a.isPluginEnabled()},c.sendDTMF=function(e,t){a.sendDTMF(e,t)},c.showSettingsWindow=function(){a.getRtcLibrary().showSettingsWindow()},n.subscribe(f.EVENT.TURN_CREDENTIALS_ESTABLISHED,o),l&&(c.setRtcLibrary=function(e){a=e})},ue=new le(de,O,p,navigator);l&&(l.WebRtcManager=le);var pe=function(){var e=O.getLogger("webRtcAdaptorUtils");this.setLocalStreamVideoSendStatus=function(t,n){e.debug("setLocalStreamVideoSendStatus= "+n),t.call&&t.call.setSendVideo(n),t.peer.showLocalVideo=n},this.callSetReceiveVideo=function(t){var n=M.getVideoSdpDirection(t.sdp);e.debug("callSetReceiveVideo: status= "+n),t.call.setReceiveVideo(M.isSdpVideoSendEnabled(t.sdp)),t.call.setReceivingVideo(M.isSdpVideoReceiveEnabled(t.sdp))},this.callCanLocalSendVideo=function(e){return e.call.canSendVideo()}},fe=new pe,Ee=function(){},Se={},Te=function(e){function t(e,t,i,o){var r="sessionProgress",a=n.getCurrentState(e);switch(a){case n.CallFSMState.INIT:switch(t){case n.NotificationEvent.callStart_GUI:e.currentState=n.CallFSMState.TRYING,i(e,n.TransferEvent.callStart_fsm);break;case n.NotificationEvent.callNotify:e.currentState=n.CallFSMState.RINGING,i(e,n.TransferEvent.callReceived_fsm);break;case n.NotificationEvent.callNotify_noSDP:e.currentState=n.CallFSMState.RINGING_SLOW,i(e,n.TransferEvent.callReceived_fsm);break;case n.NotificationEvent.joiningSuccess_Notify:e.currentState=n.CallFSMState.PROVISIONRECEIVED,i(e,n.TransferEvent.joiningSuccess_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.RINGING:switch(t){case n.NotificationEvent.answer_GUI:e.currentState=n.CallFSMState.COMPLETED,i(e,n.TransferEvent.answer_fsm);break;case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.reject_GUI);break;case n.NotificationEvent.callNotify_noSDP:e.currentState=n.CallFSMState.RINGING_SLOW,i(e,n.TransferEvent.callReceived_fsm);break;case n.NotificationEvent.callEnd_Notify:case n.NotificationEvent.callCancel_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.forward_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.forward_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.RINGING_SLOW:switch(t){case n.NotificationEvent.answer_GUI:e.currentState=n.CallFSMState.ANSWERING,i(e,n.TransferEvent.answerRingingSlow_fsm);break;case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.reject_GUI);break;case n.NotificationEvent.callEnd_Notify:case n.NotificationEvent.callCancel_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.forward_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.forward_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.ANSWERING:switch(t){case n.NotificationEvent.respondCallUpdate_Notify:e.currentState=n.CallFSMState.COMPLETED,i(e,n.TransferEvent.callCompletedAnswering_fsm);break;case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.TRYING:switch(t){case n.NotificationEvent.sessionProgress:case r:e.currentState=n.CallFSMState.PROVISIONRECEIVED,i(e,n.TransferEvent.preCallResponse_fsm);break;case n.NotificationEvent.ringing_Notify:e.currentState=n.CallFSMState.PROVISIONRECEIVED,i(e,n.TransferEvent.ringing_fsm);break;case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.noAnswer_fsm);break;case n.NotificationEvent.respondCallUpdate_Notify:e.currentState=n.CallFSMState.COMPLETED,i(e,n.TransferEvent.callCompleted_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.PROVISIONRECEIVED:switch(t){case n.NotificationEvent.respondCallUpdate_Notify:e.currentState=n.CallFSMState.COMPLETED,i(e,n.TransferEvent.callCompleted_fsm);break;case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.ringing_Notify:i(e,n.TransferEvent.ringing_fsm);break;case n.NotificationEvent.sessionProgress:case r:i(e,n.TransferEvent.preCallResponse_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.COMPLETED:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.startCallUpdate_remoteHold_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.REMOTE_HOLDING,i(e,n.TransferEvent.remoteHolding_fsm);break;case n.NotificationEvent.startCallUpdate_slowStart_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_SLOW_START_OFFER,i(e,n.TransferEvent.slowStartOfferDuringOnCall_fsm);break;case n.NotificationEvent.hold_GUI:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_HOLDING,i(e,n.TransferEvent.localHolding_fsm);break;case n.NotificationEvent.videoStopStart_GUI:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_VIDEO_STOP_START,i(e,n.TransferEvent.localVideoStopStart_fsm);break;case n.NotificationEvent.startCallUpdate_remoteOffer_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.REMOTE_OFFER,i(e,n.TransferEvent.remoteOffer_fsm);break;case n.NotificationEvent.transfering:e.previousState=e.currentState,e.currentState=n.CallFSMState.TRANSFERING,i(e,n.TransferEvent.transfering_fsm);break;case n.NotificationEvent.callCancel_Notify:i(e,n.TransferEvent.ignoredNotification_fsm);break;case n.NotificationEvent.performReconnectWorkaround_JSL:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_REOFFER,i(e,n.TransferEvent.performReconnectWorkaround_fsm);break;case n.NotificationEvent.sendReInvite_JSL:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_REOFFER,i(e,n.TransferEvent.sendReInvite_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.LOCAL_REOFFER:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.respondCallUpdate_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.respondCallUpdate_fsm);break;case n.NotificationEvent.webrtcFailure_JSL:case n.NotificationEvent.requestFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.REMOTE_OFFER:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.remoteOfferProcessed_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.renegotiationCompleted_fsm);break;case n.NotificationEvent.requestFailure_JSL:case n.NotificationEvent.webrtcFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.LOCAL_VIDEO_STOP_START:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.respondCallUpdate_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.respondCallUpdate_fsm);break;case n.NotificationEvent.requestFailure_JSL:case n.NotificationEvent.webrtcFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;case n.NotificationEvent.respondCallUpdate_glareCondition_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.glareCondition_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.LOCAL_HOLDING:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.respondCallUpdate_Notify:e.currentState=n.CallFSMState.LOCAL_HOLD,e.previousState===n.CallFSMState.REMOTE_HOLD&&(e.currentState=n.CallFSMState.BOTH_HOLD),e.previousState=a,i(e,n.TransferEvent.respondCallHoldUpdate_fsm);break;case n.NotificationEvent.requestFailure_JSL:case n.NotificationEvent.webrtcFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;case n.NotificationEvent.respondCallUpdate_glareCondition_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.glareCondition_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.LOCAL_UNHOLDING:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.respondCallUpdate_Notify:e.currentState=n.CallFSMState.COMPLETED,e.previousState===n.CallFSMState.BOTH_HOLD&&(e.currentState=n.CallFSMState.REMOTE_HOLD),e.previousState=a,i(e,n.TransferEvent.respondCallHoldUpdate_fsm);break;case n.NotificationEvent.requestFailure_JSL:case n.NotificationEvent.webrtcFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;case n.NotificationEvent.respondCallUpdate_glareCondition_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.glareCondition_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.LOCAL_HOLD:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.startCallUpdate_remoteHold_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.REMOTE_HOLDING,i(e,n.TransferEvent.remoteHolding_fsm);break;case n.NotificationEvent.startCallUpdate_remoteOffer_Notify:i(e,n.TransferEvent.remoteOfferDuringLocalHold_fsm);break;case n.NotificationEvent.unhold_GUI:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_UNHOLDING,i(e,n.TransferEvent.localUnHolding_fsm);break;case n.NotificationEvent.joining_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.JOINING,i(e,n.TransferEvent.joining_fsm);break;case n.NotificationEvent.transfering:e.previousState=e.currentState,e.currentState=n.CallFSMState.TRANSFERING,i(e,n.TransferEvent.transfering_fsm);break;case n.NotificationEvent.performReconnectWorkaround_JSL:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_REOFFER,i(e,n.TransferEvent.performReconnectWorkaround_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.REMOTE_HOLDING:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.remoteHoldProcessed_JSL:e.currentState=n.CallFSMState.REMOTE_HOLD,e.previousState===n.CallFSMState.LOCAL_HOLD&&(e.currentState=n.CallFSMState.BOTH_HOLD),e.previousState=a,i(e,n.TransferEvent.remoteHold_fsm);break;case n.NotificationEvent.requestFailure_JSL:case n.NotificationEvent.webrtcFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.REMOTE_UNHOLDING:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.remoteUnHoldProcessed_JSL:e.currentState=n.CallFSMState.COMPLETED,e.previousState===n.CallFSMState.BOTH_HOLD&&(e.currentState=n.CallFSMState.LOCAL_HOLD),e.previousState=a,i(e,n.TransferEvent.remoteUnHold_fsm);break;case n.NotificationEvent.requestFailure_JSL:case n.NotificationEvent.webrtcFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.REMOTE_HOLD:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.startCallUpdate_remoteHold_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.REMOTE_HOLDING,i(e,n.TransferEvent.remoteHolding_fsm);break;case n.NotificationEvent.startCallUpdate_remoteOffer_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.REMOTE_UNHOLDING,i(e,n.TransferEvent.remoteUnHolding_fsm);break;case n.NotificationEvent.startCallUpdate_slowStart_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_SLOW_START_OFFER,i(e,n.TransferEvent.slowStartOfferDuringRemoteHold_fsm);break;case n.NotificationEvent.hold_GUI:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_HOLDING,i(e,n.TransferEvent.localHolding_fsm);break;case n.NotificationEvent.joining_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.JOINING,i(e,n.TransferEvent.joining_fsm);break;case n.NotificationEvent.performReconnectWorkaround_JSL:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_REOFFER,i(e,n.TransferEvent.performReconnectWorkaround_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.BOTH_HOLD:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.startCallUpdate_remoteHold_Notify:case n.NotificationEvent.startCallUpdate_remoteOffer_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.REMOTE_UNHOLDING,i(e,n.TransferEvent.remoteUnHolding_fsm);break;case n.NotificationEvent.unhold_GUI:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_UNHOLDING,i(e,n.TransferEvent.localUnHolding_fsm);break;case n.NotificationEvent.joining_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.JOINING,i(e,n.TransferEvent.joining_fsm);break;case n.NotificationEvent.transfering:e.previousState=e.currentState,e.currentState=n.CallFSMState.TRANSFERING,i(e,n.TransferEvent.transfering_fsm);break;case n.NotificationEvent.performReconnectWorkaround_JSL:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_REOFFER,i(e,n.TransferEvent.performReconnectWorkaround_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.LOCAL_SLOW_START_OFFER:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.respondCallUpdate_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.COMPLETED,i(e,n.TransferEvent.respondCallUpdate_fsm);break;case n.NotificationEvent.requestFailure_JSL:case n.NotificationEvent.webrtcFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;case n.NotificationEvent.slowStartOfferProcessed_JSL:i(e,n.TransferEvent.slowStartOfferProcessed_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.JOINING:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.sessionComplete_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.sessionComplete_fsm);break;case n.NotificationEvent.sessionFail_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.sessionFail_fsm);break;case n.NotificationEvent.refer_JSL:e.currentState=n.CallFSMState.REFER,i(e,n.TransferEvent.refer_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.REFER:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.sessionComplete_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.sessionComplete_fsm);break;case n.NotificationEvent.sessionFail_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.sessionFail_fsm);break;case n.NotificationEvent.accepted_Notify:i(e,n.TransferEvent.accepted_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.TRANSFERING:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.sessionComplete_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.transferSuccess_fsm);break;case n.NotificationEvent.sessionFail_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.transferFail_fsm);break;case n.NotificationEvent.accepted_Notify:i(e,n.TransferEvent.accepted_fsm);break;case n.NotificationEvent.startCallUpdate_slowStart_Notify:case n.NotificationEvent.startCallUpdate_remoteHold_Notify:case n.NotificationEvent.startCallUpdate_remoteOffer_Notify:i(e,n.TransferEvent.remoteCallUpdate_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}}}this.CallFSMState={INIT:"INIT",RINGING:"RINGING",TRYING:"TRYING",ANSWERING:"ANSWERING",COMPLETED:"COMPLETED",RINGING_SLOW:"RINGING_SLOW",LOCAL_HOLD:"LOCAL_HOLD",LOCAL_HOLDING:"LOCAL_HOLDING",LOCAL_UNHOLDING:"LOCAL_UNHOLDING",LOCAL_VIDEO_STOP_START:"LOCAL_VIDEO_STOP_START",
REMOTE_OFFER:"REMOTE_OFFER",REMOTE_HOLD:"REMOTE_HOLD",REMOTE_HOLDING:"REMOTE_HOLDING",REMOTE_UNHOLDING:"REMOTE_UNHOLDING",BOTH_HOLD:"BOTH_HOLD",JOINING:"JOINING",PROVISIONRECEIVED:"PROVISIONRECEIVED",REFER:"REFER",TRANSFERING:"TRANSFERING",LOCAL_SLOW_START_OFFER:"LOCAL_SLOW_START_OFFER",LOCAL_REOFFER:"LOCAL_REOFFER"},this.TransferEvent={unknownNotification_fsm:"unknownNotification_fsm",ignoredNotification_fsm:"ignoredNotification_fsm",callStart_fsm:"callStart_fsm",callReceived_fsm:"callReceived_fsm",answer_fsm:"answer_fsm",reject_GUI:"reject_GUI",callCompleted_fsm:"callCompleted_fsm",noAnswer_fsm:"noAnswer_fsm",localEnd_fsm:"localEnd_fsm",remoteEnd_fsm:"remoteEnd_fsm",answeringRingingSlow_fsm:"answeringRingingSlow_fsm",callCompletedAnswering_fsm:"callCompletedAnswering_fsm",localHold_fsm:"localHold_fsm",localHolding_fsm:"localHolding_fsm",remoteHold_fsm:"remoteHold_fsm",remoteHolding_fsm:"remoteHolding_fsm",localUnHold_fsm:"localUnHold_fsm",localUnHolding_fsm:"localUnHolding_fsm",remoteUnHold_fsm:"remoteUnHold_fsm",remoteUnHolding_fsm:"remoteUnHolding_fsm",localVideoStopStart_fsm:"localVideoStopStart_fsm",remoteOffer_fsm:"remoteOffer_fsm",joining_fsm:"joining_fsm",sessionComplete_fsm:"sessionComplete_fsm",joiningSuccess_fsm:"joiningSuccess_fsm",sessionFail_fsm:"sessionFail_fsm",ringing_fsm:"ringing_fsm",respondCallUpdate_fsm:"respondCallUpdate_fsm",remoteCallUpdate_fsm:"remoteCallUpdate_fsm",preCallResponse_fsm:"preCallResponse_fsm",forward_fsm:"forward_fsm",refer_fsm:"refer_fsm",accepted_fsm:"accepted_fsm",transfering_fsm:"transfering_fsm",transferSuccess_fsm:"transferSuccess_fsm",transferFail_fsm:"transferFail_fsm",respondCallHoldUpdate_fsm:"respondCallHoldUpdate_fsm",remoteOfferDuringLocalHold_fsm:"remoteOfferDuringHold_fsm",renegotiationCompleted_fsm:"renegotiationCompleted_fsm",slowStartOfferDuringRemoteHold_fsm:"slowStartOfferDuringRemoteHold_fsm",slowStartOfferDuringOnCall_fsm:"slowStartOfferDuringOnCall_fsm",stateReverted_fsm:"stateReverted_fsm",glareCondition_fsm:"glareCondition_fsm",sendReInvite_fsm:"sendReInvite_fsm",slowStartOfferProcessed_fsm:"slowStartOfferProcessed_fsm",performReconnectWorkaround_fsm:"performReconnectWorkaround_fsm"},this.NotificationEvent={callStart_GUI:"callStart_GUI",callNotify:"callNotify",ringing_Notify:"ringing_Notify",answer_GUI:"answer_GUI",end_GUI:"end_GUI",respondCallUpdate_Notify:"respondCallUpdate_Notify",respondCallUpdate_glareCondition_Notify:"respondCallUpdate_glareCondition_Notify",callCompleted_fsm:"callCompleted_fsm",callEnd_Notify:"callEnd_Notify",callNotify_noSDP:"callNotify_noSDP",startCallUpdate_slowStart_Notify:"startCallUpdate_slowStart_Notify",startCallUpdate_remoteHold_Notify:"startCallUpdate_remoteHold_Notify",startCallUpdate_remoteOffer_Notify:"startCallUpdate_remoteOffer_Notify",joining_Notify:"joining_Notify",sessionComplete_Notify:"sessionComplete_Notify",joiningSuccess_Notify:"joiningSuccess_Notify",sessionFail_Notify:"sessionFail_Notify",hold_GUI:"hold_GUI",unhold_GUI:"unhold_GUI",videoStopStart_GUI:"videoStopStart_GUI",sessionProgress:"sessionProgress",callCancel_Notify:"callCancel_Notify",forward_GUI:"forward_GUI",refer_JSL:"refer_JSL",accepted_Notify:"accepted_Notify",transfering:"transfering",requestFailure_JSL:"requestFailure_JSL",webrtcFailure_JSL:"webrtcFailure_JSL",remoteOfferProcessed_JSL:"remoteOfferProcessed_JSL",remoteHoldProcessed_JSL:"remoteHoldProcessed_JSL",remoteUnHoldProcessed_JSL:"remoteUnHoldProcessed_JSL",slowStartOfferProcessed_JSL:"slowStartOfferProcessed_JSL",performReconnectWorkaround_JSL:"performReconnectWorkaround_JSL",sendReInvite_JSL:"sendReInvite_JSL"};var n=this,i=e.getLogger("callFsm");n.getCurrentState=function(e){return e.currentState?e.currentState:n.CallFSMState.INIT},this.handleEvent=function(e,o,r){var a;e&&(a=n.getCurrentState(e),i.info("FSM received NotificationEvent: "+o+" @ "+a+" state. Call Id: "+e.id),t(e,o,function(e,t){i.debug("FSM handleEvent successful. (Call FSM) State Passed from "+a+" to "+n.getCurrentState(e)+". TransferEvent: "+t+". Call Id: "+e.id),r(e,t)},function(e,t){i.error("FSM handleEvent failure: "+t+" @ "+n.getCurrentState(e)+". Call Id: "+e.id),r(e,t)}))}},me=new Te(O);l&&(l.CallFSM=Te);var ge=function(){function e(e){E.notification.isAnonymous()&&window.cache.getItem("NotificationId")&&(e.callMeRequest.notifyChannelId=window.cache.getItem("NotificationId"))}function t(e){return e&&e.responseText?JSON.parse(e.responseText).callControlResponse:void 0}function n(e,n,i,o,r){a.info("makeCallControlRequest Function : sdp : "+i);var s={callControlRequest:{type:e,sdp:i}};g.sendPutRequest({url:d(1,"/callControl/callSessions/"+n),data:s},o,r,null,t)}function o(e,n,o){var r=i();a.info("makeCallControlEndRequest Function: "+e),g.sendDeleteRequest({url:d(1,E.notification.isAnonymous()?"/callme/callSessions/":"/callControl/callSessions/"+e+(r?"?tokenrealm="+r:"")),data:{}},n,o,null,t)}function r(e,n,i,o,r){a.info("makeRequest Function with action : "+e);var s={callDispositionRequest:{action:e,sessionData:n}};r&&(s.callDispositionRequest.address=r),g.sendPostRequest({url:d(1,"/calldisposition"),data:s},i,o,null,t)}var a=O.getLogger("callControlService");this.startCall=function(n,o,r,s,c,l){function u(e){var t,n=E.notification.isAnonymous()?e.callMeResponse:e.callControlResponse;return n&&(t=n.sessionData),t}function p(){var e;return e=E.notification.isAnonymous()?{callMeRequest:{type:"callStart",from:n,to:o,sdp:r}}:{callControlRequest:{type:"callStart",from:n,to:o,sdp:r}}}a.info("Call Start Function: "+n+" --> "+o),a.info("Call Start Function: sdp : "+r);var f=p(),S=i();e(f),l&&(f.callControlRequest.conversation="convid="+l),g.sendPostRequest({url:d(1,E.notification.isAnonymous()?"/callme"+(S?"?tokenrealm="+S:""):"/callControl"),data:f},s,c,u,t)},this.audit=function(e,n,o){var r,a=i();r=E.notification.isAnonymous()?{callMeRequest:{type:"audit"}}:{callControlRequest:{type:"audit"}},a&&(e=e.split("%0A")[0]),g.sendPutRequest({url:d(1,(E.notification.isAnonymous()?"/callme/callSessions/":"/callControl/callSessions/")+e+(a?"?tokenrealm="+a:"")),data:r},n,o,null,t)},this.hold=function(e,n,i,o){a.info("Hold Function : sdp : "+n);var r={callControlRequest:{type:"startCallUpdate",sdp:n}};g.sendPutRequest({url:d(1,"/callControl/callSessions/"+e),data:r},i,o,null,t)},this.unhold=function(e,n,i,o){a.info("UnHold Function : sdp : "+n);var r={callControlRequest:{type:"startCallUpdate",sdp:n}};g.sendPutRequest({url:d(1,"/callControl/callSessions/"+e),data:r},i,o,null,t)},this.reinvite=function(e,n,i,o){a.info("reinvite Function : sdp : "+n);var r={callControlRequest:{type:"startCallUpdate",sdp:n}};g.sendPutRequest({url:d(1,"/callControl/callSessions/"+e),data:r},i,o,null,t)},this.respondCallUpdate=function(e,n,i,o){a.info("Respond Call Update Function : sdp : "+n);var r={callControlRequest:{type:"respondCallUpdate",sdp:n}};g.sendPutRequest({url:d(1,"/callControl/callSessions/"+e),data:r},i,o,null,t)},this.join=function(e,n,i,o,r){function s(e){var t,n=e.callControlResponse;return n&&(t=n.sessionData),t}a.info("Join Function : sdp : "+i);var c={callControlRequest:{type:"join",firstSessionData:e,secondSessionData:n,sdp:i}};"true"===C.clientControlled&&(c.callControlRequest.clientControlled="true"),g.sendPostRequest({url:d(1,"/callControl/"),data:c},o,r,s,t)},this.refer=function(e,n,i,o,r){a.info("Refer Function : refer to: "+n);var s={callControlRequest:{type:"refer",from:i,to:n}};g.sendPutRequest({url:d(1,"/callControl/callSessions/"+e),data:s},o,r,null,t)},this.endCall=function(e,n,i){a.info("endCall Function: "+e),o(e,n,i,null,t)},this.answerCall=function(e,i,o,r){a.info("Answer Call Function : sdp : "+i),n("callAnswer",e,i,o,r,null,t)},this.reject=function(e,n,i){var o;a.info("Reject Function: "+e),r("reject",e,n,i,o,t)},this.forward=function(e,t,n,i){a.info("Forward Function : address: "+t),r("forward",e,n,i,t)},this.transfer=function(e,n,i,o){a.info("Call Transfer Function : target address: "+n);var r={callControlRequest:{type:"transfer",address:n}};g.sendPutRequest({url:d(1,"/callControl/callSessions/"+e),data:r},i,o,null,t)}},Ce=new ge,Ie=function(e,t,n,i,o){function r(e,t){e.indexOf("sip:",0)>-1&&(e=e.replace("sip:",""));var n="";return void 0===t||null===t?e.indexOf("@",0)>-1?"sip:"+e:e:(t.firstName&&""!==t.firstName&&(n+=t.firstName),t.lastName&&""!==t.lastName&&(n+=""===n?t.lastName:" "+t.lastName),""===n?e.indexOf("@",0)>-1?"sip:"+e:e:n+"<"+(e.indexOf("@",0)>-1?"sip:"+e:e)+">")}function a(){N=!0}function s(t){t.call&&t.call.clearAuditTimer(),t.pendingRequestTimer&&clearTimeout(t.pendingRequestTimer),e.processEnd(t),delete D[t.id]}function c(e){_.debug("Setting notification state to BUSY for call: "+e.id),e.notificationState=V.BUSY}function d(e){_.debug("Setting notification state to IDLE for call: "+e.id),e.notificationState=V.IDLE}function u(e){return e.notificationState===V.BUSY}function S(e){if(y&&(_.debug("NOTIFICATION_QUEUE: Process completed, notification queue state changed to IDLE"),d(e),e.call.notificationQueue.size()>0)){_.debug("NOTIFICATION_QUEUE: New notification found in queue, processing it!");var t=e.call.notificationQueue.dequeue();b.onNotificationEvent(t.type,t.sessionParams)}}function T(){var e,n;if(N){N=!1;for(e in D)D.hasOwnProperty(e)&&(n=D[e],n&&t.getCurrentState(n)!==O.RINGING?(c(n),b.delegateToCallFSM(n,h.performReconnectWorkaround_JSL)):(n.call.onStateChange(M.ENDED,0),s(n)))}}function m(e){var t={sdp:e.sdp,remoteConversationId:e.call.remoteConversationId,callerNumber:e.call.callerNumber,callerName:e.call.callerName,calleeNumber:e.call.calleeNumber,primaryContact:e.call.primaryContact,optionReject:e.call.canReject(),optionForward:e.call.canForward(),optionAnswer:e.call.canAnswer()};L.setItem(e.id,JSON.stringify(t))}function g(t,n,i,o){c(t),e.revertRtcState(t,S,S),i&&b.delegateToCallFSM(t,i),o&&o.timeout?t.pendingRequestTimer=setTimeout(function(){t.pendingRequestTimer=null,o.args.push(!0),o.handler.apply(null,o.args)},1e3*o.timeout):n&&P.callFunctionIfExist(n)}function I(e,t,n){g(e,t,h.requestFailure_JSL,n)}function R(e,t){g(e,t,h.webrtcFailure_JSL)}function v(e,t){var n=t.sessionParams;_.info("CallControl notification received "+e+" sessionData:"+n.sessionData),n.referTo&&_.info("CallControl notification received: referTo:"+n.referTo+" referredBy: "+n.referredBy),n&&b.onNotificationEvent(e,n)}var D={},_=o.getLogger("callManager"),A=3e3,N=!1,h=t.NotificationEvent,O=t.CallFSMState,b=this,y=!0,V={BUSY:0,IDLE:1},M={IN_CALL:0,ON_HOLD:1,RINGING:2,ENDED:3,REJECTED:4,OUTGOING:5,INCOMING:6,ANSWERING:7,JOINED:8,RENEGOTIATION:9,TRANSFERRED:10,ON_REMOTE_HOLD:11},F={LOCAL_HOLD:0,REMOTE_HOLD:1,BOTH_HOLD:2};b.CALL_STATES=M,b.CALL_HOLD_STATES=F,b.initMedia=function(t,n,i){e.initMedia(t,n,i)},b.set_logSeverityLevel=function(t){e.set_logSeverityLevel(t)},b.enable_logCallback=function(){e.enable_logCallback()},b.disable_logCallback=function(){e.disable_logCallback()},b.get_audioInDeviceCount=function(){e.get_audioInDeviceCount()},b.get_audioOutDeviceCount=function(){e.get_audioOutDeviceCount()},b.get_videoDeviceCount=function(){e.get_videoDeviceCount()},b.getUserMedia=function(t,n,i){e.getUserMedia(t,n,i)},b.showSettingsWindow=function(t,n,i){e.showSettingsWindow(t,n,i)},b.getVideoResolutions=function(){e.getVideoResolutions()},b.createStreamRenderer=function(t,n,i){return e.createStreamRenderer(t,n,i)},b.disposeStreamRenderer=function(t){e.disposeStreamRenderer(t)},b.isPluginEnabled=function(){return e.isPluginEnabled()},b.hasGotCalls=function(){var e,n;for(e in D)if(D.hasOwnProperty(e)&&(n=D[e]))return _.info("has got call - id: "+e+" - state: "+t.getCurrentState(n)),!0;return!1},b.getCalls=function(){return D},b.sendIntraFrame=function(t){var n=D[t];n&&e.sendIntraFrame(n)},b.sendBlackFrame=function(t){var n=D[t];n&&e.sendBlackFrame(n)},b.delegateToCallFSM=function(e,n){t.handleEvent(e,n,b.onStateChange)},b.answer=function(i,o,r,a,s){var c=D[i],d=b.isVideoNegotationAvailable(i);if(c){if(d===!1&&a===!0)return _.error("[callManager.answer] Video Session Not Available Error "),void P.callFunctionIfExist(r,E.Errors.VIDEO_SESSION_NOT_AVAILABLE);c.onIceStateFailure=function(e){b.onIceStateFailure(c,e)},c.sdp?t.getCurrentState(c)!==O.RINGING?P.callFunctionIfExist(r,E.Errors.STATE):b.getUserMedia(function(t){c.isVideoSourceAllowed=t.video,e.createAnswer(c,function(t){_.info("[callManager.answer : sdp ]"+t),b.delegateToCallFSM(c,h.answer_GUI),n.answerCall(c.id,t,function(){e.addLocalStream(c),P.callFunctionIfExist(o)},r)},function(e){_.error("[callManager.answer] Error : "+e),b.delegateToCallFSM(c,h.end_GUI)},a)},function(e){P.callFunctionIfExist(r,e)},{audio:!0,video:d?!0:!1,audioIndex:0,videoIndex:d?0:-1,videoResolution:s}):t.getCurrentState(c)!==O.RINGING_SLOW?P.callFunctionIfExist(r,E.Errors.STATE):b.getUserMedia(function(t){c.isVideoSourceAllowed=t.video,e.createOffer(c,function(e){c.sdp=e,b.delegateToCallFSM(c,h.answer_GUI),n.answerCall(c.id,e,o,r)},function(){b.delegateToCallFSM(c,h.end_GUI)},a)},function(e){P.callFunctionIfExist(r,e)},{audio:!0,video:d?!0:!1,audioIndex:0,videoIndex:d?0:-1,videoResolution:s})}},b.getIncomingCallById=function(e){var t,n,o=null;return t=JSON.parse(L.getItem(e)),t&&(o=new E.call.IncomingCall(e,{reject:t.optionReject,forward:t.optionForward,answer:t.optionAnswer}),o.setReceiveVideo(i.isSdpHasVideo(t.sdp)),o.remoteConversationId=t.remoteConversationId,o.callerNumber=t.callerNumber,o.callerName=t.callerName,o.calleeNumber=t.calleeNumber,o.primaryContact=t.primaryContact,n={call:o,sdp:t.sdp,id:e},n.onIceStateFailure=function(e){b.onIceStateFailure(n,e)},D[e]=n,b.delegateToCallFSM(n,h.callNotify)),o},b.start=function(t,i,o,a,s,c,d,l,u){var p={};_.info("start call... from: "+t+" contact: "+JSON.stringify(i)+" to: "+o+" isVideoEnabled: "+c+" sendInitialVideo: "+d+" videoQuality: "+l+" convID: "+u),b.getUserMedia(function(c){p.isVideoSourceAllowed=c.video,e.createOffer(p,function(c){_.info("[callManager.start : sdp ]"+c),p.sdp=c,n.startCall(r(t,i),r(o),c,function(t){p.call=new E.call.OutgoingCall(t),p.id=t,p.onIceStateFailure=function(e){b.onIceStateFailure(p,e)},b.delegateToCallFSM(p,h.callStart_GUI),D[t]=p,p.call.setSendVideo(d),e.addLocalStream(p),P.callFunctionIfExist(a,p.call)},function(e){P.callFunctionIfExist(s,e)},u)},function(e){_.error("doOffer failed: "+e),P.callFunctionIfExist(s,e)},d)},function(){P.callFunctionIfExist(s)},{audio:!0,video:c?!0:!1,audioIndex:0,videoIndex:c?0:-1,videoResolution:l})},b.reject=function(e,t,i){var o=D[e];return o?void n.reject(e,function(){b.delegateToCallFSM(o,h.end_GUI),P.callFunctionIfExist(t)},function(){P.callFunctionIfExist(i)}):void P.callFunctionIfExist(i,E.Errors.STATE)},b.ignore=function(e,t,n){var i=D[e];return i?(b.delegateToCallFSM(i,h.end_GUI),void P.callFunctionIfExist(t)):void P.callFunctionIfExist(n,E.Errors.STATE)},b.forward=function(e,t,i,o){var r=D[e];return r?void n.forward(e,t,function(){b.delegateToCallFSM(r,h.forward_GUI),P.callFunctionIfExist(i)},function(){P.callFunctionIfExist(o)}):void P.callFunctionIfExist(o,E.Errors.STATE)},b.hold=function(i,o,r,a){var s,l=D[i];return l?u(l)?void(a?P.callFunctionIfExist(r,E.Errors.NETWORK):P.callFunctionIfExist(r,E.Errors.STATE)):(s=t.getCurrentState(l),s!==O.COMPLETED&&s!==O.REMOTE_HOLD?void(a?P.callFunctionIfExist(r,E.Errors.NETWORK):P.callFunctionIfExist(r,E.Errors.STATE)):l.pendingRequestTimer?void P.callFunctionIfExist(r,E.Errors.PENDING_REQUEST):(l.lastUpdateRequest={handler:b.hold,args:[i,o,r]},c(l),b.delegateToCallFSM(l,h.hold_GUI),void e.createHoldUpdate(l,!0,s===O.REMOTE_HOLD,function(e){_.debug("[callManager.hold->createHoldUpdate : sdp ]"+e),n.hold(l.id,e,function(){d(l),l.call.setHold(!0),l.call.setHoldState(s),P.callFunctionIfExist(o)},function(e){I(l,r,{handler:b.hold,args:[i,o,r],timeout:e.retryAfter})})},function(){R(l,r)}))):void P.callFunctionIfExist(r,E.Errors.STATE)},b.unhold=function(i,o,r,a){var s,l=D[i];return l?u(l)?void(a?P.callFunctionIfExist(r,E.Errors.NETWORK):P.callFunctionIfExist(r,E.Errors.STATE)):(s=t.getCurrentState(l),s!==O.LOCAL_HOLD&&s!==O.BOTH_HOLD?void(a?P.callFunctionIfExist(r,E.Errors.NETWORK):P.callFunctionIfExist(r,E.Errors.STATE)):l.pendingRequestTimer?void P.callFunctionIfExist(r,E.Errors.PENDING_REQUEST):(l.lastUpdateRequest={handler:b.unhold,args:[i,o,r]},c(l),b.delegateToCallFSM(l,h.unhold_GUI),void e.createHoldUpdate(l,!1,s===O.BOTH_HOLD,function(t){_.debug("[callManager.unhold->createHoldUpdate : sdp ]"+t),n.unhold(l.id,t,function(){d(l),l.call.setHold(!1),l.call.setHoldState(s),e.addLocalStream(l),P.callFunctionIfExist(o)},function(e){I(l,r,{handler:b.unhold,args:[i,o,r],timeout:e.retryAfter})})},function(){R(l,r)}))):void P.callFunctionIfExist(r,E.Errors.STATE)},b.directTransfer=function(e,i,o,r){var a,s=D[e];return s?(a=t.getCurrentState(s),void(a===O.LOCAL_HOLD||a===O.COMPLETED||a===O.BOTH_HOLD?(_.info("[callManager.directTransfer->sendTransfer : transfer target ]"+i),n.transfer(s.id,i,function(){b.delegateToCallFSM(s,h.transfering),_.info("[callManager.directTransfer->sentTransfer : transfer target ]"+i)},r)):_.error("directTransfer call is not in correct state: "+a))):void P.callFunctionIfExist(r,E.Errors.STATE)},b.videoStopStart=function(i,o,r,a,s,l){var p,f,S,T,m=D[i];return T=function(){b.delegateToCallFSM(m,h.videoStopStart_GUI),e.createUpdate(m,function(t){m.isVideoSourceAllowed=f,n.reinvite(m.id,t,function(){d(m),e.addLocalStream(m),P.callFunctionIfExist(o)},function(e){I(m,r,{handler:b.videoStopStart,args:[i,o,r,a,s],timeout:e.retryAfter})})},function(){_.error("reinvite->createUpdate : sdp "+p),R(m,r)},a)},m?u(m)?void(l?P.callFunctionIfExist(r,E.Errors.NETWORK):P.callFunctionIfExist(r,E.Errors.STATE)):(S=t.getCurrentState(m),S!==O.COMPLETED?void(l?P.callFunctionIfExist(r,E.Errors.NETWORK):P.callFunctionIfExist(r,E.Errors.STATE)):m.pendingRequestTimer?void P.callFunctionIfExist(r,E.Errors.PENDING_REQUEST):(m.lastUpdateRequest={handler:b.videoStopStart,args:[i,o,r,a]},c(m),void(!m.isVideoSourceAllowed&&a?b.getUserMedia(function(e){f=e.video,T()},function(){P.callFunctionIfExist(r)},{audio:!0,video:!0,audioIndex:0,videoIndex:0,videoResolution:s}):(f=!0,T())))):void P.callFunctionIfExist(r,E.Errors.STATE)},b.mute=function(t,n){var i,o=D[t];if(o){if(!o.peer)return;_.info("mute "+n),i=e.getLocalAudioTrack(o.peer),i&&(i.enabled=!n,o.audioMuted=n)}},b.sendDTMF=function(t,n){var i=D[t];i&&e.sendDTMF(i,n)},b.join=function(i,o,r,a){var s,c,d=D[i],l=D[o],u={},p=!0;d&&l&&(s=t.getCurrentState(d),c=t.getCurrentState(l),s!==O.LOCAL_HOLD&&s!==O.REMOTE_HOLD&&s!==O.BOTH_HOLD||c!==O.LOCAL_HOLD&&c!==O.REMOTE_HOLD&&c!==O.BOTH_HOLD||b.getUserMedia(function(){e.createOffer(u,function(e){_.info("join->doOffer : sdp "+e),u.sdp=e,n.join(d.id,l.id,e,function(e){u.call=new E.call.OutgoingCall(e),u.id=e,u.onIceStateFailure=function(e){b.onIceStateFailure(u,e)},"true"===C.clientControlled&&(u.isReferer=!0,u.refer1ID=d.id,u.refer2ID=l.id),b.delegateToCallFSM(d,h.joining_Notify),b.delegateToCallFSM(l,h.joining_Notify),b.delegateToCallFSM(u,h.joiningSuccess_Notify),D[e]=u,P.callFunctionIfExist(r,u.call)},function(){_.error("callControlService.join Failed!! sdp "+e),P.callFunctionIfExist(a)})},function(){_.error("doOffer Failed!!"),P.callFunctionIfExist(a)},!1)},function(){P.callFunctionIfExist(a)},{audio:!0,video:p?!0:!1,audioIndex:0,videoIndex:p?0:-1}))},b.transfer=function(e,t,n,i){},b.end=function(e,n){var i=D[e];i&&(t.getCurrentState(i)===O.INIT?_.error("Cannot end call in INIT callstate :"+E.Errors.STATE):(b.delegateToCallFSM(i,h.end_GUI),s(i),P.callFunctionIfExist(n)))},b.incomingCall=function(e,t){_.info("incomingCall : sdp = "+t);var n={call:e,sdp:t,id:e.getId()};_.info("incomingCall: "+e.getId()),C.continuity&&e.canAnswer()&&m(n),D[e.getId()]=n,e.isIceLite=i.isIceLite(t),b.delegateToCallFSM(n,h.callNotify)},b.updateCall=function(){},b.onNotificationEvent=function(e,t){var n=t.sessionData,o=t.statusCode,r=t.reasonText,a=t.sdp,s=t.referTo,d=t.referredBy,l=t.retryAfter;if(_.debug("Notification received "+e+" callid:"+n),_.debug("onNotificationEvent : sdp "+a),D[n]){if(y&&u(D[n]))return _.debug("NOTIFICATION_QUEUE: notification state is busy, adding process to the queue!"),D[n].call.notificationQueue.enqueue({type:e,sessionParams:t}),void _.debug("NOTIFICATION_QUEUE: queue size is now "+D[n].call.notificationQueue.size());y&&c(D[n]),a&&(D[n].prevRemoteSdp=D[n].sdp,a=i.deleteGoogleIceFromSdp(a),D[n].sdp=a),s&&d&&(D[n].referTo=s,D[n].referredBy=d),D[n].isIceLite=i.isIceLite(a),D[n].retryAfter=l,D[n].statusCode=o,D[n].reasonText=r}b.delegateToCallFSM(D[n],e)},b.onStateChange=function(i,o){function r(e,t){_.debug("triggerCallState:  state =   "+e+"    call.statusCode =  "+i.statusCode+"   call.reasonText =  "+i.reasonText),i.call.callState=e,P.callFunctionIfExist(i.call.onStateChange,e,i.statusCode,i.reasonText),t||S(i)}function a(e){r(e,!0)}var c,l,u,p,f,T=M,m=t.TransferEvent;switch(D[i.id]=i,p=function(){setTimeout(function(){E.isConnected()&&n.audit(i.id,function(){_.info("Audit kicked off: Success for: "+i.id)},function(){_.error("Audit: Fail for: "+i.id)})},A)},f=function(){i.call.setAuditTimer(function(){E.isConnected()&&n.audit(i.id,function(){_.info("Audit: Success for: "+i.id)},function(){_.error("Audit: Fail for: "+i.id),S(i)})})},_.info("Transfer Event: "+o+". callId: "+i.id),o){case m.callStart_fsm:case m.localHolding_fsm:case m.localUnHolding_fsm:case m.localVideoStopStart_fsm:case m.slowStartOfferProcessed_fsm:case m.joiningSuccess_fsm:break;case m.ignoredNotification_fsm:case m.answeringRingingSlow_fsm:case m.transfering_fsm:case m.localHold_fsm:case m.localUnHold_fsm:S(i);break;case m.ringing_fsm:r(T.RINGING);break;case m.callReceived_fsm:i.sdp||b.delegateToCallFSM(i,h.callNotify_noSDP),r(T.INCOMING);break;case m.answer_fsm:p(),f();break;case m.answerRingingSlow_fsm:S(i);break;case m.reject_GUI:s(i);break;case m.sessionComplete_fsm:n.endCall(i.id,function(){_.info("callControlService.endCall successful. callId: "+i.id)},function(){_.error("callControlService.endCall FAILED!!.callId: "+i.id)}),s(i),r(T.JOINED);break;case m.sessionFail_fsm:r(T.ON_HOLD);break;case m.callCompleted_fsm:if(p(),e.processAnswer(i,function(){f(),r(T.IN_CALL)},function(){s(i),r(T.ENDED)}),i.isReferer)for(c in D)D.hasOwnProperty(c)&&(!D[c]||D[c].id!==i.refer1ID&&D[c].id!==i.refer2ID||D[c].referCall(i.referTo,i.referredBy));break;case m.noAnswer_fsm:s(i),r(T.ENDED);break;case m.localEnd_fsm:n.endCall(i.id,function(){_.info("CallControlService endCall successful. callId: "+i.id)},function(){_.error("Cannot callControlService endCall. callId: "+i.id)});break;case m.callCompletedAnswering_fsm:_.info("callManager: Call Completed Answering Event. callId: "+i.id),e.processAnswer(i,function(){r(T.IN_CALL),p(),f()},function(){s(i),r(T.ENDED)});break;case m.remoteEnd_fsm:s(i),r(T.ENDED);break;case m.remoteHold_fsm:switch(i.call.setHold(!0),i.call.setHoldState(t.getCurrentState(i)),t.getCurrentState(i)){case O.REMOTE_HOLD:r(T.ON_REMOTE_HOLD);break;case O.BOTH_HOLD:r(T.ON_HOLD);break;default:S(i)}break;case m.remoteUnHold_fsm:switch(i.call.setHold(!1),i.call.setHoldState(t.getCurrentState(i)),t.getCurrentState(i)){case O.LOCAL_HOLD:r(T.ON_HOLD);break;case O.COMPLETED:r(T.IN_CALL);break;default:S(i)}break;case m.remoteHolding_fsm:u=t.getCurrentState(i)===O.LOCAL_HOLD||t.getCurrentState(i)===O.BOTH_HOLD,e.processHold(i,!0,u,function(e){_.info("[callManager.onStateChange.transferEvent.remoteHold_fsm->processHold : sdp ]"+e),n.respondCallUpdate(i.id,e,function(){_.info("Remote Hold Transfer Event Successful. callId: "+i.id),b.delegateToCallFSM(i,h.remoteHoldProcessed_JSL)},function(e){_.error("Remote Hold Transfer Event FAILED!! - "+e),I(i)})},function(e){_.error("Remote Hold FAILED!! - "+e),R(i)});break;case m.remoteOfferDuringLocalHold_fsm:e.processRemoteOfferOnLocalHold(i,function(e){_.info("onStateChange.transferEvent.remoteOfferDuringLocalHold_fsm : sdp "+e),n.respondCallUpdate(i.id,e,function(){_.info("Remote Offer During Local Hold Transfer Event successful. callId: "+i.id),S(i)},function(e){I(i),_.error("Remote Offer During Local Hold  Transfer Event FAILED!! - "+e)})},function(e){_.error("Remote Offer During Local Hold FAILED!! - "+e),R(i)});break;case m.slowStartOfferDuringOnCall_fsm:case m.slowStartOfferDuringRemoteHold_fsm:e.createReOffer(i,function(e){_.info("onStateChange.transferEvent.createReOffer: sdp "+e),n.respondCallUpdate(i.id,e,function(){_.info("Slow Start Offer respondCallUpdate successful. callId: "+i.id),b.delegateToCallFSM(i,h.slowStartOfferProcessed_JSL),S(i)},function(e){_.error("Slow Start Offer respondCallUpdate FAILED!! - "+e),I(i)})},function(e){_.error("Slow Start Offer createReOffer FAILED!! - "+e),R(i)},!0);break;case m.sendReInvite_fsm:e.createReOffer(i,function(e){_.info("onStateChange.transferEvent.createReOffer : sdp "+e),n.reinvite(i.id,e,function(){d(i),_.info("callControlService.reinvite successful. callId: "+i.id)},function(){b.delegateToCallFSM(i,h.requestFailure_JSL)})},function(e){R(i)},!0);break;case m.performReconnectWorkaround_fsm:e.performReconnectWorkaround(i,function(t){_.info("onStateChange.transferEvent.performReconnectWorkaround : sdp "+t),n.reinvite(i.id,t,function(){d(i),e.addLocalStream(i),_.info("callControlService.reinvite successful. callId: "+i.id)},function(){b.delegateToCallFSM(i,h.requestFailure_JSL)})},function(e){R(i)});break;case m.remoteUnHolding_fsm:u=i.previousState===O.LOCAL_HOLD||i.previousState===O.BOTH_HOLD,e.processHold(i,!1,u,function(e){_.info("onStateChange.transferEvent.remoteUnHold_fsm->processHold : sdp "+e),n.respondCallUpdate(i.id,e,function(){_.info("Remote UnHold Transfer Event successful. callId: "+i.id),b.delegateToCallFSM(i,h.remoteUnHoldProcessed_JSL)},function(e){_.error("Remote UnHold Transfer Event FAILED!! - "+e),I(i)})},function(e){_.error("Remote UnHold FAILED!! - "+e),R(i)});break;case m.renegotiationCompleted_fsm:r(T.RENEGOTIATION);break;case m.remoteOffer_fsm:case m.remoteCallUpdate_fsm:e.processUpdate(i,function(e){_.info("onStateChange.transferEvent.remoteCallUpdate_fsm->processUpdate : sdp "+e),n.respondCallUpdate(i.id,e,function(){_.info("Remote Call Update Transfer Event Successful. callId: "+i.id),b.delegateToCallFSM(i,h.remoteOfferProcessed_JSL)},function(e){_.error("Remote Call Update Transfer Event FAILED!! - "+e),I(i)})},function(e){_.error("Remote Call Update FAILED!! - "+e),R(i)},i.currentState===O.LOCAL_HOLD?!0:!1);break;case m.respondCallHoldUpdate_fsm:l=i.call.getJoin(),e.processHoldRespond(i,function(){switch(_.info("Respond Call Hold Update Event Successful. callId: "+i.id),i.call.setHold(!0),i.call.setHoldState(t.getCurrentState(i)),t.getCurrentState(i)){case O.REMOTE_HOLD:r(T.ON_REMOTE_HOLD);break;case O.LOCAL_HOLD:case O.BOTH_HOLD:r(T.ON_HOLD);break;case O.COMPLETED:i.call.setHold(!1),i.call.setHoldState(null),r(T.IN_CALL)}},function(e){_.error("Respond Call Hold Update Event FAILED: "+e),S(i)},l),i.call.setButtonDisabler(!1),i.call.clearBtnTimeout(),l===!0&&i.call.onJoin();break;case m.respondCallUpdate_fsm:l=i.call.getJoin(),i.call.setButtonDisabler(!1),i.call.clearBtnTimeout(),l===!0?(e.processRespond(i,function(){_.info("Respond Call Update Event Successful. callId: "+i.id),r(T.RENEGOTIATION)},function(e){_.error("Respond Call Update Event FAILED: "+e),S(i)},l),i.call.onJoin()):e.processRespond(i,function(){_.info("Respond Call Update Event Successful. callId: "+i.id),r(T.IN_CALL)},function(e){_.error("Respond Call Update Event FAILED: "+e),S(i)},l);break;case m.preCallResponse_fsm:e.processPreAnswer(i),r(T.RINGING);break;case m.forward_fsm:s(i);break;case m.joining_fsm:"true"===C.clientControlled&&(i.referCall=function(e,t){n.refer(i.id,e,t,function(){_.info("Joining Event Successful. callId: "+i.id),b.delegateToCallFSM(i,h.refer_JSL)},function(e){_.error("Joining Event FAILED!!"+e)})}),S(i);break;case m.transferSuccess_fsm:n.endCall(i.id,function(){_.info("callControlService.endCall successful. callId: "+i.id)},function(){_.error("callControlService.endCall FAILED!! callId: "+i.id)}),s(i),r(T.TRANSFERRED),_.info("endCall successful. callId: "+i.id);break;case m.transferFail_fsm:r(T.ON_HOLD);break;case m.stateReverted_fsm:switch(i.call.setButtonDisabler(!1),i.call.clearBtnTimeout(),i.call.setHold(!1),i.call.setHoldState(null),t.getCurrentState(i)){case O.REMOTE_HOLD:i.call.setHold(!0),i.call.setHoldState(t.getCurrentState(i)),a(T.ON_REMOTE_HOLD);break;case O.BOTH_HOLD:i.call.setHold(!0),i.call.setHoldState(t.getCurrentState(i)),a(T.ON_HOLD);break;case O.LOCAL_HOLD:i.call.setHold(!0),i.call.setHoldState(t.getCurrentState(i)),a(T.ON_HOLD);break;case O.COMPLETED:a(T.IN_CALL);break;default:_.error("CANNOT REVERT THE STATE: "+t.getCurrentState(i)+". callId: "+i.id)}break;case m.glareCondition_fsm:g(i,null,null,{handler:i.lastUpdateRequest.handler,args:i.lastUpdateRequest.args,timeout:i.retryAfter});break;default:_.error("Undefined transition event: "+o+" for "+i.id),S(i)}},b.refreshVideoRenderer=function(t){var n=D[t];n&&e.refreshVideoRenderer(n)},b.hasVideoDevice=function(){return e.isVideoSourceAvailable()},b.hasAudioDevice=function(){return e.isAudioSourceAvailable()},b.getLocalVideoResolutions=function(){return e.getLocalVideoResolutions()},b.getRemoteVideoResolutions=function(){return e.getRemoteVideoResolutions()},b.isCallMuted=function(e){var t=D[e];return t&&t.audioMuted?t.audioMuted:!1},b.isVideoNegotationAvailable=function(e){var t=D[e];return t.sdp?i.isSdpHasVideo(t.sdp):!1},b.getRemoteVideoState=function(e){var t=D[e];return t.remoteVideoState},b.onIceStateFailure=function(e){e&&(c(e),b.delegateToCallFSM(e,h.sendReInvite_JSL))},b.getHoldStateOfCall=function(e){var n=D[e];return n?F[t.getCurrentState(n)]:void 0},Se.call=function(e){if(!E.notification.isAnonymous()){var t,n,i,o,r,a=null,s=null,c={},d=e.callNotificationParams,l=e.callDispositionParams,u=e.sessionParams;if(i=u?u:l?l:null,_.info("params: "+i),i){if(n=i.actions,_.info("actions: "+n),i.sessionData){if(s=i.sessionData,o=b.getCalls(),void 0!==o[s])return void _.info("call already exists: "+s);_.info("sessionData: "+s)}n&&(c.reject=n.indexOf("reject",0)>-1,c.forward=n.indexOf("forward",0)>-1,c.answer=n.indexOf("answer",0)>-1),i.sdp&&(t=i.sdp),i.conversation&&(r=i.conversation)}a=new E.call.IncomingCall(s,c),r&&r.indexOf("convid=")>-1&&(a.remoteConversationId=r.split("convid=")[1].split(",")[0]),a.callerNumber=P.getProperty(d,"callerDisplayNumber"),a.callerName=P.getProperty(d,"callerName"),a.calleeNumber=P.getProperty(d,"calleeDisplayNumber"),a.primaryContact=P.getProperty(d,"primaryContact"),a.primaryContact&&(a.primaryContact=a.primaryContact.split(";")[0]),b.incomingCall(a,t),P.callFunctionIfExist(E.call.onReceived,a)}},Se.ringing=function(e){v(h.ringing_Notify,e)},Se.sessionProgress=function(e){""!==e.sessionParams.sdp?v(h.sessionProgress,e):_.info("Warning: SDP of sessionProgress is empty.")},Se.startCallUpdate=function(e){var t=e.sessionParams.sdp,n=h.startCallUpdate_slowStart_Notify;t&&(i.init(t),n=i.isRemoteHold()?h.startCallUpdate_remoteHold_Notify:h.startCallUpdate_remoteOffer_Notify),v(n,e)},Se.respondCallUpdate=function(e){e.sessionParams&&e.sessionParams.retryAfter?v(h.respondCallUpdate_glareCondition_Notify,e):v(h.respondCallUpdate_Notify,e)},Se.sessionComplete=function(e){v(h.sessionComplete_Notify,e)},Se.sessionFail=function(e){v(h.sessionFail_Notify,e)},Se.callEnd=function(e){v(h.callEnd_Notify,e)},Se.trying=function(e){v(h.trying_Notify,e)},Se.callCancel=function(e){v(h.callCancel_Notify,e)},Se.accepted=function(e){v(h.accepted_Notify,e)},p.subscribe(f.EVENT.DEVICE_SUBSCRIPTION_STARTED,T),p.subscribe(f.EVENT.CONNECTION_REESTABLISHED,a),p.subscribe(f.EVENT.NOTIFICATION_CHANNEL_LOST,a),l&&(b.setCalls=function(e){D=e})},Re=new Ie(ue,me,Ce,M,O);E.callManager=Re,l&&(l.CallManager=Ie);var ve=function(){this.CallTypes={INCOMING:0,MISSED:1,OUTGOING:2},this.Entry=function(){}},De=function(){function e(e){var t,n,i,r,a,s=[];if(e&&e.logHistory&&e.logHistory.logItems){for(t=0;t<e.logHistory.logItems.length;t++)i=e.logHistory.logItems[t].params,
n=new E.calllog.Entry(i),n.id=P.getProperty(i,"recordId"),n.address=P.getProperty(i,"callerDisplayNumber"),n.name=P.getProperty(i,"callerName"),n.duration=P.getProperty(i,"duration"),a=parseInt(i.startTime,10),n.startTime=isNaN(a)?null:new Date(a),n.type=null,r=P.getProperty(i,"direction"),null!==r&&void 0!==o[r]&&(n.type=o[r]),s.push(n);s=s.sort(function(e,t){return t.startTime-e.startTime})}return s}function t(e,t){var n={startIndex:a,count:s};return e&&(e.trim&&e.trim(),isFinite(e)&&e>=0&&""!==e&&(n.startIndex=e)),t&&(t.trim&&t.trim(),isFinite(t)&&t>=0&&""!==t&&(n.count=t)),n}var n="/logHistory",i="/logRecord/",o={},r=this.CallTypes,a=0,s=100;o.incoming=r.INCOMING,o.outgoing=r.OUTGOING,o.missed=r.MISSED,this.retrieve=function(i,o,r,a){g.sendGetRequest({url:d(1,n),data:t(r,a)},i,o,e)},this.retrievePartial=function(i,o,r,a){g.sendGetRequest({url:d(1,n),data:t(i,o)},r,a,e)},this.removeAll=function(e,t){g.sendDeleteRequest({url:d(1,n)},e,t)},this.remove=function(e,t,n){g.sendDeleteRequest({url:d(1,i+e)},t,n)}};De.prototype=new ve,E.calllog=new De;var _e=function(){this.retrieve=function(e,t,n){g.sendGetRequest({url:d(1,"/addressbook")},t,n,e,void 0,"addressBookResponse")},this.searchDirectory=function(e,t,n,i,o){g.sendGetRequest({url:d(1,"/directory"),data:{criteria:e,criteriaType:t}},i,o,n)}},Ae=new _e,Ne=function(){function e(e){var t,i,o,r,a=[];if(e&&(e.directory?r=e.directory.directoryItems:e.addressBookResponse&&(r=e.addressBookResponse.addressBookEntries),r))for(t=0;t<r.length;t++)o=r[t],i=new n,i.id=P.getProperty(o,"entryId"),i.nickname=P.getProperty(o,"nickname"),i.primaryContact=P.getProperty(o,"primaryContact"),i.firstName=P.getProperty(o,"firstName"),i.lastName=P.getProperty(o,"lastName"),i.photoUrl=P.getProperty(o,"photoUrl"),i.email=P.getProperty(o,"emailAddress"),i.homePhone=P.getProperty(o,"homePhone"),i.mobilePhone=P.getProperty(o,"mobilePhone"),i.workPhone=P.getProperty(o,o.workPhone?"workPhone":"businessPhone"),i.friendStatus=P.getProperty(o,"friendStatus"),i.accessCode=P.getProperty(o,"conferenceURL"),i.friendStatus||(i.friendStatus=!1),i.fax=P.getProperty(o,"fax"),i.pager=P.getProperty(o,"pager"),a.push(i);return a}var t={FIRSTNAME:0,LASTNAME:1,NAME:2,PHONENUMBER:3,USERNAME:4,NA:5},n=function(){},i={};i[t.FIRSTNAME]="1",i[t.LASTNAME]="2",i[t.NAME]="3",i[t.PHONENUMBER]="4",i[t.USERNAME]="5",i[t.NA]="-1",this.Entry=n,this.SearchType=t,this.retrieve=function(t,n){Ae.retrieve(e,t,n)},this.searchDirectory=function(t,n,o,r){var a=void 0===i[n]?"-1":i[n];Ae.searchDirectory(t,a,e,o,r)}},he=new Ne,Oe=function(){this.Entry=he.Entry,this.SearchType=he.SearchType,this.retrieve=he.retrieve,this.searchDirectory=he.searchDirectory};E.addressbook=new Oe;var be=function(){var e=O.getLogger("callTriggerService");this.clickToCall=function(e,t,n,i){var o={clickToCallRequest:{callingParty:e,calledParty:t}};g.sendPostRequest({url:d(1,"/clicktocall"),data:o},n,i)},this.getIMRN=function(t,n,i,o,r){function a(e){var t;return e&&e.imrnResponse&&(t=P.getProperty(e.imrnResponse,"imrn")),t}e.info("(Wam Call) getIMRN Function "),i.match("@")&&"sip"!==i.split(":")[0]&&(i="sip:"+i);var s={imrnRequest:{realm:t,sourceAddress:n,destinationAddress:i}};g.sendPostRequest({url:d(1,"/imrn"),data:s},o,r,a)}},Le=new be,ye=function(){this.clickToCall=Le.clickToCall,this.getIMRN=Le.getIMRN};E.call=new ye;var Pe=function(){var e=!0;this.localVideoState=0,this.remoteVideoState=0,this.onReceived=null,this.initMedia=Re.initMedia,this.startCall=Re.start,this.set_logSeverityLevel=Re.set_logSeverityLevel,this.enable_logCallback=Re.enable_logCallback,this.disable_logCallback=Re.disable_logCallback,this.get_audioInDeviceCount=Re.get_audioInDeviceCount,this.get_audioOutDeviceCount=Re.get_audioOutDeviceCount,this.get_videoDeviceCount=Re.get_videoDeviceCount,this.initVideoDeviceStatus=function(){e=Re.hasVideoDevice},this.hasVideoDevice=Re.hasVideoDevice,this.hasAudioDevice=Re.hasAudioDevice,this.getUserMedia=Re.getUserMedia,this.showSettingsWindow=Re.showSettingsWindow,this.getVideoResolutions=Re.getVideoResolutions,this.getLocalVideoResolutions=Re.getLocalVideoResolutions,this.getRemoteVideoResolutions=Re.getRemoteVideoResolutions,this.isPluginEnabled=Re.isPluginEnabled,this.hasGotCalls=Re.hasGotCalls,this.getIncomingCallById=function(e){return Re.getIncomingCallById(e)},this.createStreamRenderer=Re.createStreamRenderer,this.disposeStreamRenderer=Re.disposeStreamRenderer,this.States=Re.CALL_STATES,this.HoldStates=Re.CALL_HOLD_STATES,this.MediaErrors={NOT_FOUND:1,NOT_ALLOWED:2,OPTIONS:3,WRONG_VERSION:4,NOT_INITIALIZED:5,NEW_VERSION_WARNING:6},this.Call=function(e){},this.IncomingCall=function(t,n){var i,o,r=t,a=n,s=!0,c=!0,d=!1,l=!1,u=!1,p=!1,f=null;this.notificationQueue=new P.Queue,this.onLocalStreamAdded=null,this.onStreamAdded=null,this.mute=function(){Re.mute(r,!0)},this.unmute=function(){Re.mute(r,!1)},this.answer=function(e,t,n,i){a.answer?Re.answer(r,e,t,n,i):t()},this.reject=function(e,t){a.reject?Re.reject(r,e,t):t()},this.ignore=function(e,t){Re.ignore(r,e,t)},this.forward=function(e,t,n){a.forward?Re.forward(r,e,t,n):n()},this.canReject=function(){return a.reject===!0},this.canForward=function(){return a.forward===!0},this.canAnswer=function(){return a.answer===!0},this.canSendVideo=function(){return s},this.canReceiveVideo=function(){return c},this.canReceivingVideo=function(){return d},this.setSendVideo=function(t){s=e&&t},this.setReceiveVideo=function(e){c=e},this.setReceivingVideo=function(e){d=e},this.setHold=function(e){p=e},this.getHold=function(){return p},this.setHoldState=function(e){f=e},this.getHoldState=function(){return Re.getHoldStateOfCall(r)},this.getId=function(){return r},this.end=function(e){Re.end(r,e)},this.hold=function(e,n){Re.hold(t,e,n)},this.unhold=function(e,t){Re.unhold(r,e,t)},this.directTransfer=function(e,t,n){Re.directTransfer(r,e,t,n)},this.videoStop=function(e,n){Re.videoStopStart(t,e,n,!1)},this.videoStart=function(e,n,i){Re.videoStopStart(t,e,n,!0,i)},this.join=function(e,t,n){Re.join(r,e.getId(),t,n)},this.sendDTMF=function(e){Re.sendDTMF(r,e)},this.sendIntraFrame=function(){s&&Re.sendIntraFrame(r)},this.sendBlackFrame=function(){Re.sendBlackFrame(r)},this.refreshVideoRenderer=function(){Re.refreshVideoRenderer(r)},this.getJoin=function(){return l},this.setJoin=function(e){l=e},this.getButtonDisabler=function(){return u},this.setButtonDisabler=function(e){u=e,u&&(i=setTimeout(function(){u=!1},4e3))},this.clearBtnTimeout=function(){clearTimeout(i)},this.setAuditTimer=function(e){o=setInterval(function(){e()},C.callAuditTimer?C.callAuditTimer:3e4)},this.clearAuditTimer=function(){clearInterval(o)},this.isCallMuted=function(e){return Re.isCallMuted(e)},this.isVideoNegotationAvailable=function(e){return Re.isVideoNegotationAvailable(e)},this.getRemoteVideoState=function(){return Re.getRemoteVideoState(this.getId())}},this.IncomingCall.prototype=new this.Call,this.OutgoingCall=function(t){var n,i,o=t,r=!0,a=!0,s=!1,c=!1,d=!1,l=!1,u=null;this.notificationQueue=new P.Queue,this.onLocalStreamAdded=null,this.onStreamAdded=null,this.canSendVideo=function(){return r},this.canReceiveVideo=function(){return a},this.canReceivingVideo=function(){return s},this.setSendVideo=function(t){r=e&&t},this.setReceiveVideo=function(e){a=e},this.setReceivingVideo=function(e){s=e},this.setHold=function(e){l=e},this.getHold=function(){return l},this.setHoldState=function(e){u=e},this.getHoldState=function(){return Re.getHoldStateOfCall(o)},this.getId=function(){return o},this.sendIntraFrame=function(){r&&Re.sendIntraFrame(o)},this.sendBlackFrame=function(){Re.sendBlackFrame(o)},this.refreshVideoRenderer=function(){Re.refreshVideoRenderer(o)},this.mute=function(){Re.mute(o,!0)},this.unmute=function(){Re.mute(o,!1)},this.end=function(e){Re.end(o,e)},this.hold=function(e,n){Re.hold(t,e,n)},this.unhold=function(e,t){Re.unhold(o,e,t)},this.directTransfer=function(e,t,n){Re.directTransfer(o,e,t,n)},this.videoStop=function(e,n){Re.videoStopStart(t,e,n,!1)},this.videoStart=function(e,n,i){Re.videoStopStart(t,e,n,!0,i)},this.join=function(e,t,n){Re.join(o,e.getId(),t,n)},this.sendDTMF=function(e){Re.sendDTMF(o,e)},this.getJoin=function(){return c},this.setJoin=function(e){c=e},this.getButtonDisabler=function(){return d},this.setButtonDisabler=function(e){d=e,d&&(n=setTimeout(function(){d=!1},4e3))},this.clearBtnTimeout=function(){clearTimeout(n)},this.setAuditTimer=function(e){i=setInterval(function(){e()},C.callAuditTimer?C.callAuditTimer:3e4)},this.clearAuditTimer=function(){clearInterval(i)},this.isCallMuted=function(e){return Re.isCallMuted(e)},this.isVideoNegotationAvailable=function(e){return Re.isVideoNegotationAvailable(e)},this.getRemoteVideoState=function(){return Re.getRemoteVideoState(this.getId())}},this.OutgoingCall.prototype=new this.Call,l&&(this.setNotificationState=function(e){this.notificationState=e})};ye.prototype=new Pe,E.call=new ye,l&&(l.Call=Pe),l&&(l.OutgoingCall=E.call.OutgoingCall);var Ve=function(){},Me=function(){this.onReceived=null};Me.prototype=new Ve,E.custom=new Me,Se.custom=function(e){P.callFunctionIfExist(E.custom.onReceived,e)};var Fe=function(){function e(){return C.notificationType===E.notification.NotificationTypes.WEBSOCKET&&window.WebSocket?{notificationType:"WebSocket",clientIp:C.clientIp}:(C.notificationType="longpolling",{notificationType:"LongPolling",pollingTimer:C.polling})}function t(e){var t,n=[];for(t in r)r.hasOwnProperty(t)&&-1!==e.indexOf(t)&&n.push(r[t]);return n}function n(n,i){var o,r,c=e();E.notification.isAnonymous()?C.anonymousServices||(C.anonymousServices=s):C.services||(C.services=a),r={expires:Math.floor(C.expires),service:t(E.notification.isAnonymous()?C.anonymousServices:C.services),localization:"English_US"},i&&C.serverProvidedTurnCredentials&&(r.useTurn=C.serverProvidedTurnCredentials===!0?!0:!1),n===!0&&(r.forceLogOut="true");for(o in c)c.hasOwnProperty(o)&&(r[o]=c[o]);return r}var o="/subscription",r={CallControl:"call",call:"call",IM:"IM",Presence:"Presence",custom:"custom",callMe:"callMe",Conversation:"conversation",conversation:"conversation"},a=[r.IM,r.Presence,r.CallControl],s=[r.callMe],u=3600;this.extendSubscription=function(e,t,i){0===C.expires&&(C.expires=u),g.sendPutRequest({url:c()+e,data:{subscribeRequest:n()}},function(e){var n=e.subscribeResponse,i=n.subscriptionParams;t(i.notificationChannel,i.assignedService,i.service)},i)},this.retrieveNotification=function(e,t,n){return g.sendGetRequest({url:c()+e},function(e){var n,i=null;null!==e&&(n=e.notificationMessage,n&&(i=n.eventType)),t(i,n)},n)},this.subscribe=function(e,t,r,a){var s,c=i();C.expires=u,g.sendPostRequest({url:d(1,o+(c?"?tokenrealm="+c:"")),data:{subscribeRequest:n(r,!0)}},function(t){var n,i=t.subscribeResponse,o=i.subscriptionParams;o.turnActive===!0&&o.turnCredentials&&o.turnCredentials.username&&o.turnCredentials.password&&(n={username:o.turnCredentials.username,credential:o.turnCredentials.password},p.publish(f.EVENT.TURN_CREDENTIALS_ESTABLISHED,n)),e(i.subscription,o.notificationChannel,o.expires,o.pollingTimer,o.assignedService,o.service,o.sessionId)},t,s,s,s,s,a)},this.deleteSubscription=function(e,t,n,i){g.sendDeleteRequest({url:c()+e},t,n)},l&&(this.composeSubscribeRequestData=n)};Fe.prototype=new Ee,Se.gone=function(e){ke.onGoneNotificationReceived(e)};var we=function(){function e(e){Re=e.token}function t(){Ce&&(Y.trace("aborting last long polling request."),Ce.abort(),Ce=null)}function n(){oe=null,fe=!1,L.removeItem(ge+J),L.removeItem(ge+q),L.removeItem(ge+j),L.removeItem(ge+K),L.removeItem(ge+z),L.removeItem(ge+Q),this.onGoneNotificationReceived(),t()}function i(e){p.publish(f.EVENT.DEVICE_SUBSCRIPTION_STARTED,e)}function o(){p.publish(f.EVENT.DEVICE_SUBSCRIPTION_ENDED)}function r(){if(me.length>0){var e=me.shift();Y.info("notification events queue clearing audit timer has expired, removing first eventId: "+e)}}function a(){var e;for(e in ae.NotificationTypes)if(ae.NotificationTypes.hasOwnProperty(e)&&C.notificationType===ae.NotificationTypes[e])return C.notificationType;return ae.NotificationTypes.WEBSOCKET}function s(){return a()===ae.NotificationTypes.LONGPOLLING}function c(){return window.WebSocket&&a()===ae.NotificationTypes.WEBSOCKET}function d(){clearTimeout(B),B=null}function u(e){d(),B=setTimeout(function(){return E.isConnected()?(Y.debug("Restarting subscription..."),e&&(Y.debug("Switching to Long Polling notification..."),C.notificationType=ae.NotificationTypes.LONGPOLLING),void ae.start(Ee,Te,se,void 0,void 0,!0)):void Y.debug("Connection is lost, no need to restart subscription...")},te)}function S(){return re&&re.readyState===re.OPEN?!0:!1}function T(){return S()&&oe&&oe.notificationUrl?-1===re.url.indexOf(oe.notificationUrl)?!1:!0:!1}function m(){S()&&re.send("test")}function g(){if(oe){if(Ce)return void Y.info("longpolling request exists, no need to trigger new one.");Ce=ce.retrieveNotification(oe.notificationUrl,F,w)}else Y.error("notifier is undefined, cannot fetch notification")}function I(){clearTimeout(G),G=null}function R(){re&&(re.onmessage=null,re.onopen=null,re.onclose=null,re.onerror=null,re.close&&re.close(),re=null)}function v(){i({connectivity:{handler:m,interval:ee},session:ve,notificationId:oe?oe.notificationId:""}),Ee&&(P.callFunctionIfExist(Ee),Ee=null)}function D(e){E.isConnected()&&P.callFunctionIfExist(Te,e)}function _(){Y.info("extend notification subscription timer is stopped."),clearInterval(pe),pe=null}function A(e){return E.isConnected()?(Y.debug("Subscribing..."),void ce.subscribe(function(e,n,i,o,r,a,s){Re=null,E.setServices(r),C.services=r,C.servicesReceivingNotification=a,C.polling=o,C.expires=i,C.extendInterval=i/2,oe={},oe.subscribeUrl=e,oe.notificationUrl=n,oe.notificationId=n.substr(n.lastIndexOf("/")+1),_(),pe=setInterval(M,1e3*C.extendInterval),L.setItem(ge+J,n),L.setItem(ge+q,oe.notificationId),L.setItem(ge+j,e),L.setItem(ge+K,C.expires),L.setItem(ge+z,C.extendInterval),L.setItem(ge+Z,E.getUser()),s&&(ve=s,L.setItem(ge+Q,ve)),Y.debug("Subscription successfull - notifier: ",oe),c()?k(function(){Ie=ae.NotificationTypes.WEBSOCKET,t(),v()},function(){u(!0)}):(Ie=ae.NotificationTypes.LONGPOLLING,t(),v(),g())},function(e){Y.error("Subscription is failed - error: "+e),D(e)},e,Re)):void Y.debug("Connection is lost, no need to subscribe...")}function N(){return E.isConnected()?(Y.debug("Extending subscription... - notifier: ",oe),void ce.extendSubscription(oe.subscribeUrl,function(e,n,i){E.setServices(n),C.services=n,C.servicesReceivingNotification=i,oe.notificationUrl=e,L.setItem(ge+J,e),_(),pe=setInterval(M,1e3*C.extendInterval),Y.debug("Extending subscription successful - notifier: ",oe),c()?k(function(){t(),v()},function(){u(!0)}):(t(),g(),v())},function(e){Y.error("Extending subscription is failed - error: "+e),Y.error("Fail reusing existing subscription, re-subscribing."),t(),A()})):void Y.debug("Connection is lost, no need to extend subscribe...")}function h(e,t,n,i,o,r){if(Ee=e,Te=t,se=n,i&&(ge=i),!E.isConnected())return void Y.debug("Connection is lost, no need to subscribe...");Y.debug("start - notification subscription...");var a=L.getItem(ge+J),s=L.getItem(ge+q),c=L.getItem(ge+j),d=L.getItem(ge+K),l=L.getItem(ge+z),u=L.getItem(ge+Z);Y.debug("start - cached data - nurl: "+a+" nid: "+s+" surl: "+c+" exp: "+d+" extendInterval: "+l+" user: "+u),a&&s&&c&&d&&l&&E.getUser()===u?(oe={},oe.subscribeUrl=c,oe.notificationUrl=a,oe.notificationId=s,C.expires=d,C.extendInterval=l,M(void 0,void 0,r)):A(o)}function b(){clearTimeout(H),H=null}function y(){var e;e=Math.random()*te,Y.info("starting notification after timeout: "+e),b(),H=setTimeout(function(){h(Ee,Te),E.isConnected()&&P.callFunctionIfExist(U)},e)}function V(e){_(),b(),s()&&t(),P.callFunctionIfExist(W)}var M,F,w,k,W,U,x,H,B,G,Y=O.getLogger("notificationManager"),j="SubscriptionUrl",J="NotificationUrl",q="NotificationId",K="SubscriptionExpiry",z="SubscriptionExtendInterval",Z="USERNAME",Q="SESSION",X=50,$=600,ee=1e4,te=ee+1e3,ne=4e3,ie=f.WEBSOCKET,oe=null,re=null,ae=this,se=!1,ce=new Fe,de=null,le=null,ue=!1,pe=null,fe=!1,Ee=null,Te=null,me=[],ge="",Ce=null,Ie=null,Re=null,ve=null;x=setInterval(r,1e3*$),this.NotificationTypes={LONGPOLLING:"longpolling",SNMP:"snmp",WEBSOCKET:"websocket"},this.isAnonymous=function(){return se},F=function(e,t){var n;t&&e&&(Y.info("received notification event:"+e,t),-1!==me.indexOf(t.eventId)?Y.info("previously received notification eventId: "+t.eventId+", do not execute notification callback function."):(Y.info("newly received notification eventId: "+t.eventId),me.push(t.eventId),me.length===X&&(n=me.shift(),Y.info("notification events queue is full, remove first eventId: "+n)),P.callFunctionIfExist(Se[e],t))),s()&&(Ce=null,g()),ue&&(ue=!1,P.callFunctionIfExist(le))},w=function(e){return Y.error("received notification error:"+e),p.publish(f.EVENT.NOTIFICATION_CHANNEL_LOST),E.isConnected()?(ue=!0,s()&&(I(),G=setTimeout(function(){u()},ne)),void P.callFunctionIfExist(de,e)):void Y.debug("Connection is lost, no need to handle notification failure...")},k=function(e,t){function n(t){Y.trace("websocket connection created successfully: "+t),"function"==typeof e&&e(t)}function i(e){Y.trace("websocket connection failed: "+e),R(),"function"==typeof t&&t(e)}var o=ie.PROTOCOL.NONSECURE;if(S()){if(T())return Y.info("WebSocket is already opened, no need to open new one."),void n(ie.STATUS.ALREADY_OPENED);Y.error("websocket connection with invalid url is found!"),R()}else R();try{C.websocketProtocol&&C.websocketProtocol===ie.PROTOCOL.SECURE&&(o=ie.PROTOCOL.SECURE),re=new window.WebSocket(o+"://"+(C.websocketIP?C.websocketIP:window.location.hostname)+":"+(C.websocketPort?C.websocketPort:ie.DEFAULT_PORT)+oe.notificationUrl)}catch(r){return Y.error("WebSocket create error: ",r),void i(ie.STATUS.CREATE_ERROR)}null!==re?(re.onmessage=function(e){var t,n,i=JSON.parse(e.data);i&&(t=i.notificationMessage,t&&(n=t.eventType,F(n,t)))},re.onopen=function(e){Y.info("WebSocket opened"),n(ie.STATUS.OPENED)},re.onclose=function(e){Y.info("WebSocket closed"),w(ie.STATUS.CONNECTION_CLOSED),i(ie.STATUS.CONNECTION_CLOSED)},re.onerror=function(e){Y.error("Error on Web Socket connection."),w(ie.STATUS.CONNECTION_ERROR),i(ie.STATUS.CONNECTION_ERROR)}):i(ie.STATUS.NOT_FOUND)},M=function(e,t,n){return E.isConnected()?(e&&(Ee=e,Te=t),void(oe?n?(Y.trace("subscription restart is triggered..."),N()):Ie===ae.NotificationTypes.WEBSOCKET&&s()?(Y.trace("original notification type is websocket, try websocket connection again."),oe.notificationUrl.replace("/notification/","/websocket/"),k(function(){Y.trace("websocket connection created successfully, use websocket from now on."),L.setItem(ge+J,oe.notificationUrl),C.notificationType=ae.NotificationTypes.WEBSOCKET,N()},function(){Y.trace("websocket connection failed, keep using long polling."),oe.notificationUrl.replace("/websocket/","/notification/"),N()})):N():(Y.debug("Cannot reuse existing subscription, re-subscribing."),A()))):void Y.debug("Connection is lost, no need to extend subscribe...")},this.stop=function(e,n,i){return E.isConnected()?(Y.debug("Unsubscribing... - notifier: ",oe),void(oe?ce.deleteSubscription(oe.subscribeUrl,function(){Y.debug("Unsubscription successfull"),_(),o(),t(),oe=null,fe=!1,L.removeItem(ge+J),L.removeItem(ge+q),L.removeItem(ge+j),L.removeItem(ge+K),L.removeItem(ge+z),L.removeItem(ge+Q),"function"==typeof e&&e()},function(e){Y.error("Unsubscribe if failed - error:"+e),fe=!1,"function"==typeof n&&n()},i):(Y.error("notifier is unknown, cannot send unsubscribe request."),fe=!1,"function"==typeof n&&n()))):void Y.debug("Connection is lost, no need to unsubscribe...")},this.start=h,this.extend=h,this.setOnError=function(e){de=e},this.setOnSuccess=function(e){le=e},this.setOnConnectionLost=function(e){W=e},this.setOnConnectionEstablished=function(e){U=e},this.trigger=function(){if(!fe)try{g(),fe=!0}catch(e){throw e}},this.onGoneNotificationReceived=function(e){L.removeItem("USERNAME"),L.removeItem("PASSWORD"),L.removeItem(ge+Q),_(),o(),P.callFunctionIfExist(E.notification.onGoneReceived,e)},this.getNotificationId=function(){return oe?oe.notificationId:void 0},p.subscribe(f.EVENT.CONNECTION_REESTABLISHED,y),p.subscribe(f.EVENT.CONNECTION_LOST,V),p.subscribe(f.EVENT.TOKEN_AUTH_STARTED,e,10),p.subscribe(f.EVENT.TOKEN_NOT_FOUND,n),p.subscribe(f.EVENT.SESSION_EXPIRED,n),l&&(this.getWebSocket=function(){return re}),l&&(this.webSocketConnect=k),l&&(this.websocketDisconnect=R),l&&(this.WEBSOCKET_CONSTANTS=ie),l&&(this.setNotifier=function(e){oe=e})},ke=new we;E.notification=ke;var We,Ue=function(){this.State={CONNECTED:0,UNAVAILABLE:1,AWAY:2,OUT_TO_LUNCH:3,BUSY:4,ON_VACATION:5,BE_RIGHT_BACK:6,ON_THE_PHONE:7,ACTIVE:8,INACTIVE:9,PENDING:10,OFFLINE:11,CONNECTEDNOTE:12,UNAVAILABLENOTE:13},this.UpdateEvent=function(){}},xe="/presence",He="/presenceWatcher",Be="watch",Ge="stopwatch",Ye="get",je=new Ue,Je=je.State,qe="open",Ke="closed",ze="unknown",Ze="away",Qe="lunch",Xe="busy",$e="vacation",et="on-the-phone",tt="other",nt="Be Right Back",it="Offline",ot="active",rt="inactive",at=function(){var e=[];e[Je.CONNECTED]={status:qe,activity:ze},e[Je.UNAVAILABLE]={status:Ke,activity:ze},e[Je.AWAY]={status:qe,activity:Ze},e[Je.OUT_TO_LUNCH]={status:qe,activity:Qe},e[Je.BUSY]={status:Ke,activity:Xe},e[Je.ON_VACATION]={status:Ke,activity:$e},e[Je.BE_RIGHT_BACK]={status:qe,activity:tt,note:nt},e[Je.ON_THE_PHONE]={status:qe,activity:et},e[Je.ACTIVE]={status:qe,activity:ze,userInput:ot},e[Je.INACTIVE]={status:Ke,activity:ze,userInput:rt},e[Je.OFFLINE]={status:Ke,activity:tt,note:it},e[Je.CONNECTEDNOTE]={status:qe,activity:tt},e[Je.UNAVAILABLENOTE]={status:Ke,activity:tt},this.getRequestObject=function(t){var n=e[t];if(n)return n;throw new Error("Invalid Presence State")},this.getState=function(e){switch(e.userInput){case ot:return Je.ACTIVE;case rt:return Je.INACTIVE}switch(e.note){case nt:return Je.BE_RIGHT_BACK;case it:return Je.OFFLINE}if(e.note)return e.status===qe?Je.CONNECTEDNOTE:Je.UNAVAILABLENOTE;switch(e.activity){case Ze:return Je.AWAY;case Qe:return Je.OUT_TO_LUNCH;case Xe:return Je.BUSY;case $e:return Je.ON_VACATION;case et:return Je.ON_THE_PHONE;case ze:return e.status===qe?Je.CONNECTED:Je.UNAVAILABLE}return Je.CONNECTED}},st=function(){function e(e,t,n,i){var o={presenceWatcherRequest:{userList:e,action:i}};g.sendPostRequest({url:d(1,He),data:o},t,n)}function t(){r&&(c.trace("presence watch timer is stopped: "+r),clearTimeout(r),r=null)}function n(n,i,d){var u=this,p=P.getTimestamp();if(!n){if(!o)return void c.trace("presence service subscription has not been initialized, do not trigger service subscription.");c.trace("watchedUserList is empty, use lastWatchedUserList."),n=o}return c.info("presence service subscription, currentTimestamp: "+p+" expiryTimestamp: "+l),0>p-l?void c.trace("previous presence service subscription is still valid, do not trigger service subscription."):(i&&(a=i),d&&(s=d),c.info("subscribe presence status of users:",n),void e(n,function(e){var i,d;e&&(i=e.presenceWatcherResponse,i&&(d=i.expiryValue/2,d&&(l=P.getTimestamp()+1e3*d,t(),r=setTimeout(function(){u.watch(n,null,s)},1e3*d),c.trace("presence watch, timer: "+r+" expiryTimestamp: "+l)))),o=n,a&&"function"==typeof a&&a(e)},s,Be))}function i(){n(void 0,a,s)}var o=null,r=null,a=null,s=null,c=O.getLogger("presenceService"),l=0;this.getLastWatchedUserList=function(){return o},this.onReceived=null,this.update=function(e,t,n){g.sendPostRequest({url:d(1,xe),data:{presenceRequest:We.getRequestObject(e)}},t,n)},this.watch=n,this.stopwatch=function(t,n,i){e(t,n,i,Ge)},this.retrieve=function(t,n,i){e(t,n,i,Ye)},p.subscribe(f.EVENT.DEVICE_SUBSCRIPTION_STARTED,i),p.subscribe(f.EVENT.DEVICE_SUBSCRIPTION_ENDED,t)};st.prototype=new Ue;var ct=new st;return E.presence=ct,We=new at,Se.presenceWatcher=function(e){if(!E.notification.isAnonymous()){var t=new E.presence.UpdateEvent,n=e.presenceWatcherNotificationParams;t.name=P.getProperty(n,"name"),t.type=P.getProperty(n,"type"),t.status=P.getProperty(n,"status"),t.activity=P.getProperty(n,"activity"),t.note=P.getProperty(n,"note"),t.userInput=P.getProperty(n,"userInput"),t.state=We.getState(t),P.callFunctionIfExist(E.presence.onReceived,t)}},E});var S=function(){var e={};return e.createUUIDv4=function(){for(var e=[],t="0123456789ABCDEF",n=0;36>n;n++)e[n]=Math.floor(16*Math.random());for(e[14]=4,e[19]=3&e[19]|8,n=0;36>n;n++)e[n]=t[e[n]];return e[8]=e[13]=e[18]=e[23]="-",e.join("")},e.extend=function(e){e=e||{};for(var t=1;t<arguments.length;t++)if(arguments[t])for(var n in arguments[t])arguments[t].hasOwnProperty(n)&&(e[n]=arguments[t][n]);return e},e.defaults=function(e){e=e||{};for(var t=1;t<arguments.length;t++)if(arguments[t])for(var n in arguments[t])!e[n]&&arguments[t].hasOwnProperty(n)&&(e[n]=arguments[t][n]);return e},e.param=function(e){var t,n="";for(t in e)if(e.hasOwnProperty(t)){var i=e[t];if(void 0===i)continue;null===i&&(i=""),"string"!=typeof i&&(i=JSON.stringify(i)),n.length>0&&(n+="&"),n+=encodeURIComponent(t)+"="+encodeURIComponent(i)}return n},e}(),T=function(e){var t=function(n){n=e.defaults(n,t.defaultOptions),n.headers=e.defaults(n.headers,t.defaultHeaders);var i=e.param(n.params);i.length>0&&(-1===n.url.indexOf("?")&&(n.url+="?"),n.url+=i);var o=new XMLHttpRequest;o.open(n.type,n.url,!0),o.withCredentials=n.withCredentials;var r;for(r in n.headers)o.setRequestHeader(r,n.headers[r]);n.data&&"string"!=typeof n.data&&(n.data=JSON.stringify(n.data)),o.onreadystatechange=function(){if(4===o.readyState){var e=o.status>=200&&o.status<300||304===o.status;if(e){if("function"==typeof n.success){var t=o.responseText;"json"===n.dataType&&"string"==typeof t&&(t=t.length?JSON.parse(t):{}),n.success({status:o.status,response:t})}}else"function"==typeof n.failure&&n.failure({status:o.status,statusText:o.statusText,response:o.responseText})}else 0===o.readyState&&"function"==typeof n.failure&&n.failure({status:o.status,statusText:o.statusText,response:"Call aborted."})},o.send(n.data)};return t.defaultHeaders={"Content-Type":"application/json",Accept:"application/json"},t.defaultOptions={type:"GET",url:"",withCredentials:!1,dataType:"json"},t}(S),m=this.fcs,g={OK:0,internalServerError:1,tokenExpired:10,permissionDenied:11,usageQuotaExceeded:12,insufficientFunds:13,validationFailed:14,missingParameter:15,invalidParameterValue:16,badParameterValue:17,unknownRequest:18,noData:19,alreadyExists:50,invalidIdentifier:51,invalidPassword:52,doesNotExist:53,invalidCountryCode:54,invalidCredentials:55,ajaxError:5e3,wsError:6e3,wsAlreadyOpened:6001,wsNotFound:6002,wsCreateError:6003,wsNotAuth:6004},C={version:E,responseCodes:JSON.parse(JSON.stringify(g))},I=function(){},R={info:I,warn:I,error:I,debug:I};e("warn");var v={};v={},v.callinitiated=null,v.callinitiatefailed=null,v.callincoming=null,v.callended=null,v.callendfailed=null,v.callanswered=null,v.callanswerfailed=null,v.oncall=null,v.callstatechanged=null,v.media=null,v.presencenotification=null,v.loginsuccess=null,v.setupsuccess=null,v.setupfailed=null,v.loginfailed=null,v.callrejected=null,v.callrejectfailed=null,v.callignored=null,v.callignorefailed=null,v.remotehold=null,v.remoteunhold=null,v.onconnectionlost=null,v.messagesavailable=null;var D,_,A={listeners:{},kandyApiUrl:"https://api.kandy.io/v1.2",mediatorUrl:"http://service.kandy.io:8080/kandywrapper-1.0-SNAPSHOT",messageProvider:"fring",pstnOutNumber:"71",sipOutNumber:"72",allowAutoLogin:!1,kandyWSUrl:null,fcsConfig:{restPlatform:"kandy",kandyApiUrl:"https://api.kandy.io/v1.1/users/gateway",useInternalJquery:!1},spidrApi:{cors:!0,disableNotifications:null,notificationType:m.notification.NotificationTypes.WEBSOCKET,useInternalJquery:!1,websocketProtocol:"wss"},spidrMedia:{pluginMode:"auto",pluginLogLevel:2,screenSharing:!1}},N=null,h=!0,O=!0,b=function(e){void 0!==e.type&&e.type||(e.type="GET"),e.url=(e.kandyApiUrl||A.kandyApiUrl)+e.url,e.params=e.params||{},e.params.key||(e.params.key=N.userAccessToken),"DELETE"!==e.type||e.data||(e.headers=e.headers||{},e.headers["Content-Type"]="text/html");var t=e.success,n=e.failure;e.success=function(e){e.response.status===g.OK?t&&t(e.response):n&&n(e.statusText,g.ajaxError)},e.failure=function(e){403===e.status||401===e.status?console.log("Unauthorized Error !!!"):426===e.status&&console.log("Kandy upgrade required!"),n&&n(e.statusText,g.ajaxError)},T(e)},L=function(){try{m.logManager.initLogging(function(e,t,n){window.console.log("ERROR"===n.message?n.message:n.message)},!0),R=m.logManager.getLogger("kandy_js")}catch(e){}},y={},P={},V=null,M=0,F=!1;C.setup=function(t){if(A=S.extend(A,t),t.hasOwnProperty("listeners"))for(var n in t.listeners)v[n]=t.listeners[n];t.hasOwnProperty("autoreconnect")&&(h=t.autoreconnect),t.hasOwnProperty("registerforcalls")&&(O=t.registerforcalls),t.hasOwnProperty("loglevel")&&e(t.loglevel),O&&W&&W(t),t.hasOwnProperty("exposeFcs")&&(C._fcs=m)},C.getUserAccessToken=f,C.getLimitedUserDetails=function(e,t,n){b({url:"/users/details/limited",params:{key:e},success:function(e){t&&t(e.result.user)},failure:n})},C.getLimitedDomainDetails=function(e,t,n){b({url:"/domains/details/limited",params:{key:e},success:function(e){t&&t(e.result)},failure:n})},C.getDevices=function(e,t,n){b({url:"/users/devices",params:{key:e},success:function(e){t&&t(e.result)},failure:n})},C.getLastSeen=function(e,t,n){b({url:"/users/presence/last_seen",params:{users:e},success:function(e){t&&t(e.result)},failure:n})},C.getDataChannelConfiguration=function(e,t){b({url:"/users/configurations/data_channel",success:function(t){e&&e(t.result)},failure:t})},C.getAnonymousUser=function(e,t,n){b({url:"/domains/access_token/users/user/anonymous",params:{key:e},success:function(e){t&&t(e.result)},failure:n})},C.login=function(e,t,n,i,o){var r=function(){N=null,o&&"function"==typeof o&&o()},a={client_sw_version:C.version,client_sw_type:"JS",kandy_device_id:null};f(e,t,n,function(e){var t=e.user_access_token;C.getLimitedUserDetails(t,function(o){N=o,N.userPassword=n,N.userAccessToken=t,d(function(){N.devices=[],C.getDevices(t,function(t){N.devices=t.devices,O&&w?w(function(){i&&i(e)},r):i&&i(e)},r)},r)},r)},r,a)},C.loginSSO=function(e,t,n,i){R.info("loginSSO is not supported for calls at the moment, unless provided with the password");var o=function(){N=null,n&&"function"==typeof n&&n()};C.getLimitedUserDetails(e,function(n){N=n,N.userAccessToken=e,N.userPassword=i,d(function(){N.devices=[],C.getDevices(e,function(e){N.devices=e.devices,O&&w?w(function(){t&&t(n)},o):t&&t(n)},o)},o)},o)},C.logout=function(e){u(),k(e)},C.reconnect=function(e,t){d(e,t)},C.Session=C.session=function(){var e={},t={},n=function(e){var n,i,o,r=0;if("sessionNotification"===e.message_type&&(e=e.payload),window.console.log("Session message recvd: "+e.message_type),n=e.message_type.replace(/^session/,"on"),i=t[e.session_id]){var a=i.length;for(r;a>r;r++)if(o=i[r],o&&o.hasOwnProperty(n))try{o[n](e)}catch(s){console.log("could not execute listner: "+s)}}};return p({sessionData:n,sessionNotification:n}),e.setListeners=function(e,n){void 0===t[e]&&(t[e]=[]),t[e].push(n)},e.create=function(e,t,n){b({type:"POST",url:"/users/sessions/session",data:e,success:function(e){t&&t(e.result)},failure:n})},e.activate=function(e,t,n){b({type:"POST",url:"/users/sessions/session/id/start",data:{session_id:e},success:function(e){t&&t()},failure:n})},e.inactivate=function(e,t,n){b({type:"POST",url:"/users/sessions/session/id/stop",data:{session_id:e},success:function(e){t&&t()},failure:n})},e.sendData=function(e,t,n,i,o){l({message_type:"sessionData",session_id:e,destination:o,payload:t},n,i)},e.terminate=function(e,t,n){b({type:"DELETE",url:"/users/sessions/session/id",data:{session_id:e},success:function(e){t&&t()},failure:n})},e.getInfoById=function(e,t,n){b({url:"/users/sessions/session/id",params:{session_id:e},success:function(e){t&&t(e.result)},failure:n})},e.getInfoByName=function(e,t,n){b({url:"/users/sessions/session/name",params:{session_name:e},success:function(e){t&&t(e.result)},failure:n})},e.getOpenSessions=function(e,t){
b({url:"/users/sessions",success:function(t){e&&e(t.result)},failure:t})},e.getOpenSessionsByType=function(e,t,n){b({url:"/users/sessions",params:{session_type:e},success:function(e){t&&t(e.result)},failure:n})},e.getOpenSessionsCreatedByUser=function(e,t){b({url:"/users/sessions/user",success:function(t){e&&e(t.result)},failure:t})},e.join=function(e,t,n,i){b({type:"POST",url:"/users/sessions/session/id/participants/participant",data:{session_id:e},success:function(e){n&&n(e.result)},failure:i})},e.leave=function(e,t,n,i){b({type:"DELETE",url:"/users/sessions/session/id/participants/participant",data:{session_id:e,leave_reason:t},success:function(e){n&&n()},failure:i})},e.acceptJoinRequest=function(e,t,n,i){b({type:"POST",url:"/users/sessions/session/id/admin/participants/participant/join",data:{session_id:e,full_user_id:t},success:function(e){n&&n()},failure:i})},e.rejectJoinRequest=function(e,t,n,i,o){b({type:"DELETE",url:"/users/sessions/session/id/admin/participants/participant/join",data:{session_id:e,full_user_id:t,reject_reason:n},success:function(e){i&&i()},failure:o})},e.bootUser=function(e,t,n,i,o){b({type:"DELETE",url:"/users/sessions/session/id/admin/participants/participant",data:{session_id:e,full_user_id:t,boot_reason:n},success:function(e){i&&i()},failure:o})},e}(),C.messaging=function(){function e(e,t,n,i,o,r,a){var s,c,d=a&&a.uuid||S.createUUIDv4(),l={message:{contentType:t,UUID:d,message:n}};return r?(S.extend(l.message,{group_id:e}),s="/users/chatgroups/chatgroup/messages"):(l.message.destination=e,l.messageType="chat",s="/devices/messages",c={device_id:N.devices[0].id}),b({type:"POST",url:s,params:c,data:l,success:function(e){i&&i(l.message)},failure:o}),d}function n(t,n,i,o,r,a,s){if("fring"===A.messageProvider){var c=S.createUUIDv4();return s=s||{},d.uploadFile(n,function(d){var l={mimeType:n.type,content_uuid:d,content_name:n.name};return s&&Object.keys(s).forEach(function(e){l[e]=s[e]}),e(t,i,l,o,r,a,{uuid:c})},r),c}R.error("NOT SUPPORTED"),r&&r()}function i(t,n,i,o,r){return e(t,c.LOCATION,{mimeType:"location/utm",media_map_zoom:10,location_latitude:n.location_latitude,location_longitude:n.location_longitude},i,o,r)}function o(t,n,i,o,r){return e(t,"text",{mimeType:"application/json",json:JSON.stringify(n)},i,o,r)}function r(e,t,n,i){b({type:"PUT",url:"/users/chatgroups/chatgroup/mute",params:{mute:i,group_id:e},success:function(e){t&&t(e.result)},failure:n})}function a(e,t,n,i,o){var r={members:t,mute:o,group_id:e};b({type:"PUT",data:r,url:"/users/chatgroups/chatgroup/members/mute",success:function(e){n&&n(e.result)},failure:i})}function s(e){var n=e.message;if(n){var i=n.messageType;"chat"===i?t("message",n):"groupChat"===i?t("chatGroupMessage",n):"chatGroupInvite"===i?t("chatGroupInvite",n):"chatGroupBoot"===i?t("chatGroupBoot",n):"chatGroupLeave"===i?t("chatGroupLeave",n):"chatGroupUpdate"===i?t("chatGroupUpdate",n):"chatGroupDelete"===i&&t("chatGroupDelete",n)}}var c={VIDEO:"video",AUDIO:"audio",IMAGE:"image",FILE:"file",LOCATION:"location",CONTACT:"contact"},d={};return d.sendSMS=function(e,t,n,i,o){b({type:"POST",url:"/devices/smss",params:{device_id:N.devices[0].id},data:{message:{source:t,destination:e,message:{text:n}}},success:i,failure:o})},d.sendIm=function(t,n,i,o){if("fring"===A.messageProvider)return e(t,"text",{mimeType:"text/plain",text:n},i,o,!1);if("spidr"===A.messageProvider){var r=new m.im.Message;return r.primaryContact=t,r.type="A2",r.msgText=n,r.charset="UTF-8",m.im.send(r,i,o),0}},d.sendJSON=function(e,t,n,i){return o(e,t,n,i)},d.sendImWithFile=function(e,t,i,o){return n(e,t,c.FILE,i,o)},d.sendImWithImage=function(e,t,i,o){return n(e,t,c.IMAGE,i,o)},d.sendImWithAudio=function(e,t,i,o){return n(e,t,c.AUDIO,i,o)},d.sendImWithVideo=function(e,t,i,o){return n(e,t,c.VIDEO,i,o)},d.sendImWithContact=function(e,t,i,o,r){return n(e,t,c.CONTACT,i,o,null,{contact_display_name:r})},d.sendImWithLocation=function(e,t,n,o){return i(e,t,n,o)},d.uploadFile=function(e,t,n){var i=S.createUUIDv4(),o=new FormData;o.append("file",e,e.name);var r=new XMLHttpRequest,a=A.kandyApiUrl+"/devices/content?key="+N.userAccessToken+"&content_uuid="+encodeURIComponent(i)+"&device_id="+N.devices[0].id+"&content_type="+encodeURIComponent(e.type);return r.open("POST",a,!0),r.onload=function(){if(200===r.status){var e=JSON.parse(r.responseText);e.status===g.OK?t&&t(i):n&&n(e.message,e.status)}else n&&n("Request Error","500")},r.send(o),i},d.buildFileUrl=function(e){return A.kandyApiUrl+"/devices/content?key="+N.userAccessToken+"&content_uuid="+encodeURIComponent(e)+"&device_id="+N.devices[0].id},d.buildFileThumbnailUrl=function(e,t){return void 0!==t&&t||(t="500x500"),A.kandyApiUrl+"/devices/content/thumbnail?key="+N.userAccessToken+"&content_uuid="+encodeURIComponent(e)+"&device_id="+N.devices[0].id+"&thumbnail_size="+t},d.getIm=function(e,t,n){R.info("Consider using the message event instead of fetching messages"),void 0===n&&(n=!0),b({url:"/devices/messages",params:{device_id:N.devices[0].id},success:function(t){if(e){if(t.result.messages.length){var i=t.result.messages.map(function(e){return e.UUID});t.result.messages=t.result.messages.map(function(e){return-1===e.UUID.indexOf("-")&&(e.UUID=[e.UUID.substring(0,8),e.UUID.substring(8,12),e.UUID.substring(12,16),e.UUID.substring(16,20),e.UUID.substring(20,e.UUID.length)].join("-")),e})}e(t.result),n&&t.result.messages.length&&d.clearIm(i)}},failure:t})},d.clearIm=function(e,t,n){for(var i=0;i<e.length;i+=10)b({type:"DELETE",url:"/devices/messages",params:{messages:e.slice(i,i+10),device_id:N.devices[0].id},failure:n})},d.getGroups=function(e,t){b({url:"/users/chatgroups",success:function(t){e&&e(t.result)},failure:t})},d.createGroup=function(e,t,n,i){var o={group_name:e,group_image:{}};b({type:"POST",data:o,url:"/users/chatgroups",success:function(e){n&&n(e.result)},failure:i})},d.getGroupById=function(e,t,n){b({url:"/users/chatgroups/chatgroup",params:{group_id:e},success:function(e){t&&t(e.result)},failure:n})},d.deleteGroup=function(e,t,n){b({type:"DELETE",url:"/users/chatgroups/chatgroup",params:{group_id:e},success:function(e){t&&t(e.result)},failure:n})},d.updateGroup=function(e,t,n,i,o){var r={group_id:e,group_name:t,group_image:{}};b({type:"PUT",data:r,url:"/users/chatgroups/chatgroup",success:function(e){i&&i(e.result)},failure:o})},d.addGroupMembers=function(e,t,n,i){var o={members:t};b({type:"POST",url:"/users/chatgroups/chatgroup/members",params:{group_id:e},data:o,success:function(e){n&&n(e.result)},failure:i})},d.removeGroupMembers=function(e,t,n,i){b({type:"DELETE",url:"/users/chatgroups/chatgroup/members",params:{group_id:e,members:t},success:function(e){n&&n(e.result)},failure:i})},d.leaveGroup=function(e,t,n){b({type:"DELETE",url:"/users/chatgroups/chatgroup/members/membership",params:{group_id:e},success:function(e){t&&t(e.result)},failure:n})},d.muteGroup=function(e,t,n){r(e,t,n,!0)},d.unmuteGroup=function(e,t,n){r(e,t,n,!1)},d.muteGroupMember=function(e,t,n,i){a(e,t,n,i,!0)},d.unmuteGroupMember=function(e,t,n,i){a(e,t,n,i,!1)},d.sendGroupIm=function(t,n,i,o){return e(t,"text",{mimeType:"text/plain",text:n},i,o,!0)},d.sendGroupImWithFile=function(e,t,i,o){return n(e,t,c.FILE,i,o,!0)},d.sendGroupImWithImage=function(e,t,i,o){return n(e,t,c.IMAGE,i,o,!0)},d.sendGroupImWithAudio=function(e,t,i,o){return n(e,t,c.AUDIO,i,o,!0)},d.sendGroupImWithVideo=function(e,t,i,o){return n(e,t,c.VIDEO,i,o,!0)},d.sendGroupJSON=function(e,t,n,i){return o(e,t,n,i,!0)},d.sendGroupImWithLocation=function(e,t,n,o){return i(e,t,n,o,!0)},p({notification:s}),d}();var w,k,W;return C.Phone=C.call=C.voice=function(){function e(e){e.intraframe=setInterval(function(){e?e.sendIntraFrame():n(e)},5e3)}function n(e){e.intraframe&&clearInterval(e.intraframe)}function i(e){y[e.getId()]=e,e.isAnonymous=-1!==e.callerNumber.indexOf("concierge"),t("callincoming",e,e.isAnonymous)}function o(i,o){var r,a=i.getId();i.isIncoming=!0,i.isOutgoing=!1;var s=y[a];s||(y[a]=s=i),r=i.getHoldState(),"REMOTE_HOLD"===r?(R.info("CALL HELD REMOTELY"),i.remoteHold=!0,t("remotehold",i)):(void 0!==i.remoteHold&&i.remoteHold&&(R.info("CALL REMOTE HOLD RELEASED"),t("remoteunhold",i)),i.remoteHold=!1),o===V.IN_CALL?(R.info("LOCAL_HOLD"===r?"ON HOLD":"ON CALL"),i.canSendVideo()&&e(s)):o===V.RENEGOTIATION?t("callstatechanged",i):o===V.ON_HOLD?R.info("CALL HELD REMOTELY"):o===V.RINGING?(R.info("RINGING"),t("ringing",i.getId())):o===V.ENDED?i&&(n(s),0===i.statusCode||void 0===i.statusCode?R.info("CALL END"):R.error(i.statusCode>=100&&i.statusCode<=300?"WebRTC ERROR":"ERROR"),delete y[a],t("callended",i)):o===V.REJECTED?R.info("REJECTED"):o===V.OUTGOING?R.info("DIALING"):o===V.INCOMING&&R.info("INCOMING")}function r(i,o){var r,a=i.getId(),s=y[a];s.isOutgoing=!0,s.isIncoming=!1,r=i.getHoldState(),"REMOTE_HOLD"===r?(R.info("CALL HELD REMOTELY"),i.remoteHold=!0,t("remotehold",i)):(void 0!==i.remoteHold&&i.remoteHold&&(R.info("CALL REMOTE HOLD RELEASED"),t("remoteunhold",i)),i.remoteHold=!1),o===V.IN_CALL?(R.info("LOCAL_HOLD"===r?"ON HOLD":"ON CALL"),i.canSendVideo()&&e(s),t("oncall",i)):o===V.RENEGOTIATION?t("callstatechanged",i):o===V.ON_HOLD?R.info("CALL HELD REMOTELY"):o===V.RINGING?(R.info("RINGING"),t("ringing",i.getId())):o===V.ENDED?i&&(n(s),0===i.statusCode||void 0===i.statusCode?R.info("CALL END"):R.error(i.statusCode>=100&&i.statusCode<=300?"WebRTC ERROR":"ERROR"),s.isAnonymous&&s.isOutgoing&&D.logout(),delete y[a],t("callended",i)):o===V.REJECTED?R.info("REJECTED"):o===V.OUTGOING?R.info("DIALING"):o===V.INCOMING?R.info("INCOMING"):o===V.JOINED&&R.info("JOINED")}function a(e){return null===e.state?void R.info("State is empty."):null===e.name?void R.info("Name is empty."):void t("presencenotification",e.name,e.state,O[e.state],e.activity)}function s(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}}function c(e){return localStorage["kandyphone.userinformation"]=_+";"+N.full_user_id+";"+e,!0}function d(){return localStorage["kandyphone.userinformation"]}function l(){return localStorage.removeItem("kandyphone.userinformation"),!0}function u(e){return e.fcsApi?e.fcsApi:{notificationType:m.notification.NotificationTypes.WEBSOCKET,restUrl:e.REST_server_address,restPort:e.REST_server_port,websocketIP:e.webSocket_server_address,websocketPort:e.webSocket_server_port,websocketProtocol:e.webSocket_secure!==!1?"wss":"ws",protocol:e.REST_protocol,serverProvidedTurnCredentials:e.serverProvidedTurnCredentials}}function f(e){return e.fcsMedia?e.fcsMedia:(e.ICE_servers&&S.extend(e,{ICE_server_address:e.ICE_servers[0],ICE_server_port:""}),{iceserver:e.ICE_server_address,iceserverPort:e.ICE_server_port,webrtcdtls:e.use_DTLS})}function E(e){A.spidrApi=S.defaults(u(e),A.spidrApi),A.spidrMedia=S.defaults(f(e),A.spidrMedia),A.remoteVideoContainer&&(A.spidrMedia.remoteVideoContainer=A.remoteVideoContainer),A.localVideoContainer&&(A.spidrMedia.localVideoContainer=A.localVideoContainer),A.screenSharing&&(A.spidrMedia.screenSharing=A.screenSharing),A.screenSharingChromeExtensionId&&(A.spidrMedia.screenSharingChromeExtensionId=A.screenSharingChromeExtensionId)}function T(e,t,n){E(e),m.setup(A.spidrApi),m.setUserAuth(N.full_user_id,N.userPassword),m.notification.start(function(){V=m.call.States,A.allowAutoLogin&&s()&&c(N.userPassword),t()},function(e){R.error("login failed: unable to start spidr notification"),n(e)},!1)}function g(e){e=e.message,e=e&&(e.kandyType||e.message_type),e&&"gofetch"!==e?"incomingCall"===e&&D._onIncommingCall("CALLavailable",e.call_id):t("messagesavailable")}function I(e,n,i,o,a,s){function c(e){E(e.result.spidr_configuration),m.setup(A.spidrApi),m.setUserAuth(n,""),m.notification.start(function(){R.info("Notification started"),V=m.call.States,D.initMedia(function(){R.info("Call init successfully"),setTimeout(function(){m.call.startCall(i,a,o,function(e){e.onStateChange=function(t,n){e.statusCode=n,r(e,t)},e.isAnonymous=!0,y[e.getId()]=e,t("callinitiated",e,o)},function(e){R.error("call failed"),t("callinitiatefailed","error code: "+e)},!1,s)},100)},function(e){R.error("Call init failed"),C.logout(),t("callinitiatefailed","Init media failed: "+e)})},function(){console.error("Notification failed"),t("callinitiatefailed","Auth failed")},!0)}L(),b({url:"/domains/configurations/communications/spidr",params:{key:e},success:c,failure:function(){t("callinitiatefailed","Failed to retrieve domain configuration"),R.error("Call Failed: Failed to retrieve domain configuration")}})}function v(e,t){b({url:"/users/configurations/communications/spidr",params:{secure:!0},success:function(t){e&&e(t.result.spidr_configuration)},failure:t})}var D={},_=null,h={INCOMING_CALL:1,OUTGOING_CALL:2},O={0:"Available",1:"Unavailable",2:"Away",3:"Out To Lunch",4:"Busy",5:"On Vacation",6:"Be Right Back",7:"On The Phone",8:"Active",9:"Inactive",10:"Pending",11:"Offline"},y=[],P=!1,V=null,M=!1;return D.MediaErrors=m.call.MediaErrors,w=function(e,t){v(function(n){T(n,e,t)},function(e){R.error("login failed: unable to get spidr configuration"),t()})},p({notification:g}),D.setup=function(e){R.warn("Deprecated method KandyAPI.Phone.setup use kandy.setup"),C.setup(e)},W=function(e){A=S.extend(A,e),m.notification.setOnConnectionEstablished(function(){R.info("Connection established"),t("onconnectionestablished","spider")}),m.notification.setOnConnectionLost(function(){R.info("Connection Lost"),t("onconnectionlost","spider")}),A.allowAutoLogin&&s()&&d()&&C.login(d().split(";")[0],d().split(";")[1],d().split(";")[2],function(){t("loginsuccess",N)},function(e,n){t("loginfailed",e,n)}),m.presence.onReceived=function(e){a(e)},m.call.onReceived=function(e){R.info("incoming call"),e.onStateChange=function(t){o(e,t)},i(e)}},D.login=function(e,n,i){R.warn("Deprecated method KandyAPI.Phone.login use kandy.login"),C.login(e,n,i,function(){t("loginsuccess",N)},function(e){t("loginfailed","",e)})},D.initMedia=function(e,n,i){return void 0!==i&&i||!M?void m.call.initMedia(function(){R.info("media initiated"),P=!0,window.addEventListener("beforeunload",function(e){for(var t in y)D.endCall(t)}),M=!0,e()},function(e){switch(R.error("Problem occurred while initiating media"),e){case m.call.MediaErrors.WRONG_VERSION:R.error("Media Plugin Version Not Supported"),t("media",{type:D.MediaErrors.WRONG_VERSION});break;case m.call.MediaErrors.NEW_VERSION_WARNING:R.error("New Plugin Version is available"),t("media",{type:D.MediaErrors.NEW_VERSION_WARNING,urlWin32bit:"https://kandy-portal.s3.amazonaws.com/public/plugin/3.0.476/Kandy_Plugin_3.0.476.exe",urlWin64bit:"https://kandy-portal.s3.amazonaws.com/public/plugin/3.0.476/Kandy_Plugin_3.0.476_x86_64.exe",urlMacUnix:"https://kandy-portal.s3.amazonaws.com/public/plugin/3.0.476/Kandy_Plugin_3.0.476.pkg"});break;case m.call.MediaErrors.NOT_INITIALIZED:R.error("Media couldn't be initialized"),t("media",{type:D.MediaErrors.NOT_INITIALIZED});break;case m.call.MediaErrors.NOT_FOUND:R.error("Plugin couldn't be found!"),t("media",{type:D.MediaErrors.NOT_FOUND,urlWin32bit:"https://kandy-portal.s3.amazonaws.com/public/plugin/3.0.476/Kandy_Plugin_3.0.476.exe",urlWin64bit:"https://kandy-portal.s3.amazonaws.com/public/plugin/3.0.476/Kandy_Plugin_3.0.476_x86_64.exe",urlMacUnix:"https://kandy-portal.s3.amazonaws.com/public/plugin/3.0.476/Kandy_Plugin_3.0.476.pkg"});break;case m.call.MediaErrors.NO_SCREEN:R.info("ScreenShare extension could not be found"),t("media",{type:D.MediaErrors.NO_SCREEN}),M=!0}n(e)},S.defaults({remoteVideoContainer:A.spidrMedia.remoteVideoContainer,localVideoContainer:A.spidrMedia.localVideoContainer},A.spidrMedia)):void e()},k=function(e){s()&&l(),m.clearResources(function(){e&&e()},!0)},D.logout=function(e){R.info("KandyAPI.Phone.logout is deprecated use kandy.logout"),C.logout(e)},D.hasStoredLogin=function(){s()&&d()},D.isMediaInitiated=function(){return P},D.isIncoming=function(e){var t=y[e];return t.isIncoming},D.isOutgoing=function(e){var t=y[e];return t.isOutgoing},D.callTypes=function(){return h},D.getAnonymousData=function(e){var t=_call[e];return t&&t.isAnonymous?t.callerName:null},D.callType=function(e){var t=y[e];return t.isIncoming?h.INCOMING_CALL:t.isOutgoing?h.OUTGOING_CALL:void 0},D.makeSIPCall=function(e,t){D.makeCall(A.sipOutNumber+e+"@"+N.domain_name,!1,t)},D.makePSTNCall=function(e,t){D.makeCall(A.pstnOutNumber+e+"@"+N.domain_name,!1,t)},D.makeCall=function(e,n,i){R.info("making voice call"),D.initMedia(function(){return e===N.full_user_id?void t("callinitiatefailed","You cannot call yourself"):void m.call.startCall(m.getUser(),{firstName:i},e,function(n){n.onStateChange=function(e,t){n.statusCode=t,r(n,e)},n.isAnonymous=!1,y[n.getId()]=n,t("callinitiated",n,e)},function(e){R.error("call failed"),t("callinitiatefailed","Start call failed: "+e)},!0,n)},function(e){R.error("call failed"),t("callinitiatefailed","Init media failed: "+e)})},D.makeAnonymousCallWithToken=function(e,t,n,i,o,r){m.setRealm(t),I(e,n,i,o,null,r)},D.makeAnonymousCall=function(e,t,n,i,o){var r={firstName:n};i=i||"anonymous@concierge.com",I(e,i,i,t,r,o)},D.rejectCall=function(e){var n=y[e];n.reject(function(){t("callrejected",n)},function(e){R.info("reject failed"),t("callrejectfailed",n,e)})},D.ignoreCall=function(e){var n=y[e];n.ignore(function(){t("callignored",n)},function(e){t("callignorefailed",n,e),R.info("ignore failed")})},D.answerCall=function(e,n){D.initMedia(function(){var i=y[e];i.answer(function(){t("callanswered",i,i.isAnonymous)},function(e){R.info("answer failed"),t("callanswerfailed",i,e)},n)},function(e){R.info("answer failed"),t("callanswerfailed")})},D.muteCall=function(e){var t=y[e];t&&(t.mute(),t.isMuted=!0)},D.unMuteCall=function(e){var t=y[e];t&&(t.unmute(),t.isMuted=!1)},D.holdCall=function(e,t,n){var i=y[e];i&&(i.hold(t,n),i.held=!0)},D.unHoldCall=function(e,t,n){var i=y[e];i&&(i.unhold(t,n),i.held=!1)},D.startCallVideo=function(e,t,n){var i=y[e];i&&i.videoStart(t,n)},D.stopCallVideo=function(e,t,n){var i=y[e];i&&i.videoStop(t,n)},D.startScreenSharing=function(e,t,n,i,o,r){var a=y[e];a&&a.screenSharingStart(t,n,i,o,r)},D.stopScreenSharing=function(e,t,n){var i=y[e];i&&i.screenSharingStop(t,n)},D.sendDTMF=function(e,t){var n=y[e];n&&n.sendDTMF(t)},D.endCall=function(e){var i=y[e];i&&(R.info("ending call"),i.end(function(){n(i),delete y[e],i.isAnonymous&&i.isOutgoing&&m.clearResources(function(){},!0),t("callended",i)},function(e){R.error("COULD NOT END CALL"),t("callendfailed",i,e)}))},D.watchPresence=function(e,t,n){R.warn("KandyAPI.Phone.watchPresence is deprecated please use kandy.getLastSeen");m.presence.watch(e.map(function(e){return e.full_user_id}),function(){R.info("Watch presence successful"),t&&t()},function(){R.error("Watch presence error"),n&&n()})},D.updatePresence=function(e){R.warn("KandyAPI.Phone.updatePresence is deprecated please use kandy.getLastSeen"),m.getServices().presence===!0?m.presence.update(parseInt(e),function(){R.info("Presence update success")},function(){R.error("Presence update failed")}):R.error("Presence service not available for account")},D.normalizeNumber=function(e,t,n,i){b({url:"/users/services/normalize/phone_number",params:{phone_number:e,countryCode:t},success:function(e){n&&n(e.result)},failure:i})},D.getSpidrConfiguration=v,D}(),C.addressbook=function(){var e={};return e.searchDirectoryByPhoneNumber=function(e,t,n){b({url:"/users/directories/native/searches/phone_number",params:{search_string:e},success:function(e){t&&t(e.result.contacts)},failure:n})},e.searchDirectoryByName=function(e,t,n){b({url:"/users/directories/native/searches/name",params:{search_string:e},success:function(e){t&&t(e.result.contacts)},failure:n})},e.searchDirectoryByUserName=function(e,t,n){b({url:"/users/directories/native/searches/user_id",params:{search_string:e},success:function(e){t&&t(e.result.contacts)},failure:n})},e.searchDirectory=function(e,t,n){b({url:"/users/directories/native/search/",params:{search_string:e},success:function(e){t&&t(e.result.contacts)},failure:n})},e.retrieveDirectory=function(e,t){b({url:"/users/directories/native",success:function(t){e&&t.result&&t.result.contacts&&(t.result.contacts.forEach(function(e){e.firstName=e.user_first_name,e.lastName=e.user_last_name,e.number=e.user_phone_number,e.hintType="community",delete e.user_first_name,delete e.user_last_name}),e(t.result))},failure:t})},e.retrievePersonalAddressBook=function(e,t){b({url:"/users/addressbooks/personal",success:function(t){e&&e(t.result.contacts)},failure:t})},e.addToPersonalAddressBook=function(e,t,n){b({type:"POST",url:"/users/addressbooks/personal",data:{contact:e},success:function(e){t&&t(e.result)},failure:n})},e.removeFromPersonalAddressBook=function(e,t,n){b({type:"DELETE",url:"/users/addressbooks/personal",params:{contact_id:e},success:function(e){t&&t()},failure:n})},e.retrieveUserDeviceAddressBook=function(e,t){b({url:"/users/addressbooks/device",success:function(t){e&&e(t.result)},failure:t})},e}(),C.Registration=C.registration=function(){var e={};return e.setup=function(t){A=S.extend(A,t),e._domainAccessToken=t.domainAccessToken,R=m.logManager.getLogger()},e.retrieveCountryCode=function(t,n){b({url:"/domains/countrycodes",params:{key:e._domainAccessToken},success:function(e){t&&t(e.result)},failure:n})},e.sendValidationCode=function(t,n,i,o){b({type:"POST",url:"/domains/verifications/smss",params:{key:e._domainAccessToken},data:{user_phone_number:t,user_country_code:n},success:i,failure:o})},e.validateCode=function(t,n,i){encodeURIComponent(e._domainAccessToken);b({url:"/domains/verifications/codes",params:{key:e._domainAccessToken,validation_code:t},success:function(e){n&&n(e.result.valid)},failure:i})},e.getUserInfo=function(e,t){b({url:"/users/billing/packages/status/active",success:function(t){e&&e(t.result)},failure:t})},e.getProfileInfo=function(e,t,n,i){b({url:"/users/profiles/user_profiles/user_profile",params:{user_id:e,domain_name:t},success:function(e){n&&n(e.result)},failure:i})},e.setProfileInfo=function(e,t,n){b({type:"POST",url:"/users/profiles/user_profiles",params:{first_name:e.first_name,last_name:e.last_name,status_text:e.status_text,image_details:e.image_details,user_data:e.user_data},success:function(e){t&&t()},failure:n})},e.register=function(t,n,i){b({type:"POST",url:"/api_wrappers/registrations",params:{key:e._domainAccessToken},data:{user_phone_number:t.userPhoneNumber,user_country_code:t.userCountryCode,validation_code:t.validationCode,device_native_id:t.deviceNativeId},success:function(e){n&&n(e.result)},failure:i})},e.getConfiguration=function(e,t,n){b({url:"/api_wrappers/configurations",params:{key:e.domainApiKey,domain_api_secret:e.domainApiSecret},success:function(e){t&&t({domainName:e.result.domain_name,domainAccessToken:e.result.domain_access_token,spidrConfiguration:{restUrl:e.result.spidr_configuration.REST_server_address,restPort:e.result.spidr_configuration.REST_server_port,protocol:e.result.spidr_configuration.REST_protocol,websocketIP:e.result.spidr_configuration.webSocket_server_address,websocketPort:e.result.spidr_configuration.webSocket_server_port,spidr_env:{iceserver:"stun:"+e.result.spidr_configuration.ICE_server_address+":"+e.result.spidr_configuration.ICE_server_port,ice:"STUN stun:"+e.result.spidr_configuration.ICE_server_address+":"+e.result.spidr_configuration.ICE_server_port}}})},failure:n})},e}(),C.Phone.sendSMS=function(){return R.warn("KandyAPI.Phone.sendSMS is deprecated please use kandy.messaging.sendSMS"),C.messaging.sendSMS.apply(null,arguments)},C.Phone.sendIm=function(){return R.warn("KandyAPI.Phone.sendIm is deprecated please use kandy.messaging.sendIm"),C.messaging.sendIm.apply(null,arguments)},C.Phone.sendJSON=function(){return R.warn("KandyAPI.Phone.sendJSON is deprecated please use kandy.messaging.sendJSON"),C.messaging.sendJSON.apply(null,arguments)},C.Phone.sendImWithFile=function(){return R.warn("KandyAPI.Phone.sendImWithFile is deprecated please use kandy.messaging.sendImWithFile"),C.messaging.sendImWithFile.apply(null,arguments)},C.Phone.sendImWithImage=function(){return R.warn("KandyAPI.Phone.sendImWithImage is deprecated please use kandy.messaging.sendImWithImage"),C.messaging.sendImWithImage.apply(null,arguments)},C.Phone.sendImWithAudio=function(){return R.warn("KandyAPI.Phone.sendImWithAudio is deprecated please use kandy.messaging.sendImWithAudio"),C.messaging.sendImWithAudio.apply(null,arguments)},C.Phone.sendImWithVideo=function(){return R.warn("KandyAPI.Phone.sendImWithVideo is deprecated please use kandy.messaging.sendImWithVideo"),C.messaging.sendImWithVideo.apply(null,arguments)},C.Phone.uploadFile=function(){return R.warn("KandyAPI.Phone.uploadFile is deprecated please use kandy.messaging.uploadFile"),C.messaging.uploadFile.apply(null,arguments)},C.Phone.buildFileUrl=function(){return R.warn("KandyAPI.Phone.buildFileUrl is deprecated please use kandy.messaging.buildFileUrl"),C.messaging.buildFileUrl.apply(null,arguments)},C.Phone.buildFileThumbnailUrl=function(){return R.warn("KandyAPI.Phone.buildFileThumbnailUrl is deprecated please use kandy.messaging.buildFileThumbnailUrl"),C.messaging.buildFileThumbnailUrl.apply(null,arguments)},C.Phone.getIm=function(){return R.warn("KandyAPI.Phone.getIm is deprecated please use kandy.messaging.getIm"),C.messaging.getIm.apply(null,arguments)},C.Phone.clearIm=function(){return R.warn("KandyAPI.Phone.clearIm is deprecated please use kandy.messaging.clearIm"),C.messaging.clearIm.apply(null,arguments)},C.Phone.searchDirectoryByPhoneNumber=function(){return R.warn("KandyAPI.Phone.searchDirectoryByPhoneNumber is deprecated please use kandy.addressbook.searchDirectoryByPhoneNumber"),C.addressbook.searchDirectoryByPhoneNumber.apply(null,arguments)},C.Phone.searchDirectoryByName=function(){return R.warn("KandyAPI.Phone.searchDirectoryByName is deprecated please use kandy.addressbook.searchDirectoryByName"),C.addressbook.searchDirectoryByName.apply(null,arguments)},C.Phone.searchDirectoryByUserName=function(){return R.warn("KandyAPI.Phone.searchDirectoryByUserName is deprecated please use kandy.addressbook.searchDirectoryByUserName"),C.addressbook.searchDirectoryByUserName.apply(null,arguments)},C.Phone.searchDirectory=function(){return R.warn("KandyAPI.Phone.searchDirectory is deprecated please use kandy.addressbook.searchDirectory"),C.addressbook.searchDirectory.apply(null,arguments)},C.Phone.retrievePersonalAddressBook=function(){R.warn("KandyAPI.Phone.retrievePersonalAddressBook is deprecated please use kandy.addressbook.retrievePersonalAddressBook"),C.addressbook.retrievePersonalAddressBook.apply(null,arguments)},C.Phone.addToPersonalAddressBook=function(){return R.warn("KandyAPI.Phone.addToPersonalAddressBook is deprecated please use kandy.addressbook.addToPersonalAddressBook"),C.addressbook.addToPersonalAddressBook.apply(null,arguments)},C.Phone.removeFromPersonalAddressBook=function(){return R.warn("KandyAPI.Phone.removeFromPersonalAddressBook is deprecated please use kandy.addressbook.removeFromPersonalAddressBook"),C.addressbook.removeFromPersonalAddressBook.apply(null,arguments)},C.Phone.retrieveUserDeviceAddressBook=function(){return R.warn("KandyAPI.Phone.retrieveUserDeviceAddressBook is deprecated please use kandy.addressbook.retrieveUserDeviceAddressBook"),C.addressbook.retrieveUserDeviceAddressBook.apply(null,arguments)},C});