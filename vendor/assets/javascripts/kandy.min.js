// Kandy.js
// Site: http://kandy.io
// Version: 2.4.2
// Copyright 2015 Genband
// ----------------------
!function(e,t){"function"==typeof define&&define.amd?define("fcs",t):e.fcs=t()}(this,function(){function e(){return R.split("@")[1]}function t(){return R}function n(){return D}function i(){return h}function o(){return N}function r(){return"3.0.5.1"}function a(){return A}function s(e){A=e===!0?!0:!1}function c(){var e="";return v.protocol&&v.restUrl&&v.restPort?e+v.protocol+"://"+v.restUrl+":"+v.restPort:e}function d(e,t,n){return n===!1?c()+"/rest/version/"+(e?e:"latest")+t:E.notification?c()+"/rest/version/"+(e?e:"latest")+(E.notification.isAnonymous()?"/anonymous/":"/user/")+E.getUser()+t:c()+"/rest/version/"+(e?e:"latest")+"/user/"+E.getUser()+t}var l,u=function(){function e(e){var t,n,i;for(t in r)if(r[t]&&r.hasOwnProperty(t))for(n=0,i=r[t].length;i>n;n++)if(r[t][n].token===e)return r[t].splice(n,1),e;return!1}function t(e,t,n,s){var c,d=i,l=!1;if("string"!=typeof e)throw new Error("First parameter must be a string topic name.");if("function"!=typeof t)throw new Error("Second parameter must be a function.");if("undefined"!=typeof n){if("number"!=typeof n)throw new Error("Priority must be a number.");if(n>i||o>n)throw new Error("Priority must be between 1-10.");d=n}return s===!0&&(l=s),r[e]||(r[e]=[]),c=(++a).toString(),r[e].push({token:c,prio:d,func:t,temp:l}),r[e].sort(function(e,t){return parseFloat(t.prio)-parseFloat(e.prio)}),c}function n(t,n){var i,o,a,s;if(0===arguments.length)throw new Error("First parameter must be a string topic name.");for(a=Array.prototype.slice.call(arguments),s=a.shift(),i=r[s],o=i?i.length:0;o--;)i[o].func.apply(null,a),i[o].temp&&e(i[o].token)}var i=10,o=1,r={},a=-1;this.publish=n,this.subscribe=t,this.unsubscribe=e},p=new u;l&&(l.GlobalBroadcaster=u);var f={WEBRTC:{PLUGIN_ID:"fcsPlugin",MEDIA_STATE:{NOT_FOUND:"notfound",SEND_RECEIVE:"sendrecv",SEND_ONLY:"sendonly",RECEIVE_ONLY:"recvonly",INACTIVE:"inactive"},PLUGIN_MODE:{WEBRTC:"webrtc",LEGACY:"legacy",LEGACYH264:"legacyh264",AUTO:"auto"},RTC_SIGNALING_STATE:{STABLE:"stable",HAVE_LOCAL_OFFER:"have-local-offer",HAVE_REMOTE_OFFER:"have-remote-offer",HAVE_LOCAL_PRANSWER:"have-local-pranswer",HAVE_REMOTE_PRANSWER:"have-remote-pranswer",CLOSED:"closed"},RTC_SDP_TYPE:{OFFER:"offer",ANSWER:"answer",PRANSWER:"pranswer"}},STRING:{NEW_LINE:"\n",CARRIAGE_RETURN:"\r",VIDEO:"video",AUDIO:"audio"},SDP:{A_LINE:"a=",M_LINE:"m=",CRYPTO:"crypto",FINGERPRINT:"fingerprint",ICE_UFRAG:"ice-ufrag:",ICE_PWD:"ice-pwd:",NACK:"nack",NACKPLI:"nack pli",SETUP_ACTIVE:"a=setup:active",SETUP_PASSIVE:"a=setup:passive",SETUP_ACTPASS:"a=setup:actpass"},HTTP_METHOD:{GET:"GET",POST:"POST",PUT:"PUT",DELETE:"DELETE",OPTIONS:"OPTIONS"},WEBSOCKET:{PROTOCOL:{SECURE:"wss",NONSECURE:"ws"},DEFAULT_PORT:"8581",STATUS:{OPENED:1,ALREADY_OPENED:2,CREATE_ERROR:3,CONNECTION_ERROR:4,NOT_FOUND:5,CONNECTION_CLOSED:6}},EVENT:{XHR_REQUEST_NOT_INITIALIZED:"XHR_REQUEST_NOT_INITIALIZED",DEVICE_SUBSCRIPTION_STARTED:"DEVICE_SUBSCRIPTION_STARTED",DEVICE_SUBSCRIPTION_ENDED:"DEVICE_SUBSCRIPTION_ENDED",CONNECTION_REESTABLISHED:"CONNECTION_REESTABLISHED",CONNECTION_LOST:"CONNECTION_LOST",TOKEN_AUTH_STARTED:"TOKEN_AUTH_STARTED",BASIC_AUTH_STARTED:"BASIC_AUTH_STARTED",TOKEN_NOT_FOUND:"TOKEN_NOT_FOUND",SESSION_EXPIRED:"SESSION_EXPIRED",TURN_CREDENTIALS_ESTABLISHED:"TURN_CREDENTIALS_ESTABLISHED",NOTIFICATION_CHANNEL_LOST:"NOTIFICATION_CHANNEL_LOST"}};l&&(l.CONSTANTS=f);var E,E,S=function(e,t,n){function i(){return V.getLogger("jQrestful")}function o(e,t,n,i){var o=e;return i&&(o.data=i),n&&(o.errorThrown=n),t&&(o.status=t.status,o.statusText=t.statusText,o.responseText=t.responseText,o.readyState=t.readyState),o}function r(e,t){var n,o;switch(i().error("parseError:'"+t+"' Status:'"+e.status+"' ResponseText:'"+e.responseText+"'"),e.responseText&&-1!==e.responseText.search("statusCode")&&(void 0!==JSON.parse(e.responseText).subscribeResponse?o=JSON.parse(e.responseText).subscribeResponse.statusCode:void 0!==JSON.parse(e.responseText).authorizationResponse&&(o=JSON.parse(e.responseText).authorizationResponse.statusCode)),o=o?o:e.status){case 401:n=E.Errors.AUTH;break;case 403:n=E.Errors.INCORRECT_LOGIN_PASS;break;case 19:n=E.Errors.LOGIN_LIMIT_CLIENT;break;case 20:n=E.Errors.LOGIN_LIMIT_TABLET;break;case 44:n=E.Errors.FORCE_LOGOUT_ERROR;break;case 46:n=E.Errors.TOKEN_NOT_FOUND;break;case 47:n=E.Errors.SESSION_EXPIRED;break;default:n=E.Errors.NETWORK}return n}function a(e,t,n){return i().error("parseErrorStatusCode:'"+t+"' Status:'"+e.status+"' ResponseText:'"+e.responseText+"'"),e.responseText&&-1!==e.responseText.search("statusCode")&&void 0!==JSON.parse(e.responseText)[n]?JSON.parse(e.responseText)[n].statusCode:401===e.status||403===e.status?e.status:400}var s=3e4,c=4e4,d={REQUEST_NOT_INITIALIZED:0,REQUEST_DONE:4};this.call=function(e,t,n,l,u,S,T,g){var m,C,I,R,D,A,_,h,N,b,O,y=c,L=t.url,V=i();t&&t.data&&(m=t.data),v.polling&&(y=1e3*v.polling,y+=v.longpollingTolerans?v.longpollingTolerans:s),L.split("/rest/version/")[1]&&(C=L.split("/rest/version/")[1].split("/")[3],C||(C=L.substring(L.lastIndexOf("/")+1,L.length)),C=C.split("?")[0],m?V.info("Send ajax request: "+C,m):V.info("Send ajax request: "+C)),"GET"===e&&(R=U.param(m),R.length>0&&(L+=-1===L.indexOf("?")?"?"+R:"&"+R),m=null),I=new XMLHttpRequest,I.open(e,L,E.isAsync()),I.withCredentials=v.cors?!0:!1,I.timeout=y,D={"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},D=U.extend(D,g);for(A in D)I.setRequestHeader(A,D[A]);return"string"!=typeof m&&(m=JSON.stringify(m)),I.send(m),_={type:e,url:L,dataType:"json",async:E.isAsync(),jsonp:!1,crossDomain:v.cors?!0:!1,timeout:y},N=function(e){u&&"function"==typeof u&&(e=u(e)),n&&"function"==typeof n&&n(e)},b=function(){l&&"function"==typeof l?l("addressBookResponse"===T?a(I,I.statusText,T):S&&"function"==typeof S?S(I,I.statusText):r(I,I.statusText)):V.trace("Error handler is not defined or not a function")},h=function(){if(I.readyState===d.REQUEST_DONE)if(O=I.status>=200&&I.status<300||304===I.status){var e={};try{"string"==typeof I.responseText&&I.responseText.length&&(e=JSON.parse(I.responseText)),V.info("ajax success: "+I.status+" "+I.statusText,o(_,I,void 0,e)),N(e)}catch(t){t instanceof SyntaxError?V.error("Failed to parse json ajax response into object:"+I.responseText,o(_,I,void 0,e)):V.error("Unknown error:"+I.status+" "+I.statusText,o(_,I,void 0,e)),b()}}else{if(V.error("ajax error: "+I.status+" "+I.statusText,o(_,I,I.statusText)),410===I.status)return V.error("410 Gone received"),void U.callFunctionIfExist(E.notification.onGoneReceived);if(0===I.status&&"abort"===I.statusText)return void V.trace("Ajax request aborted internally. not calling failure callback");b()}else if(I.readyState===d.REQUEST_NOT_INITIALIZED){if(V.error("ajax error: "+I.status+" "+I.statusText,o(_,I,null)),0===I.status&&"abort"===I.statusText)return void V.trace("Ajax request aborted internally. not calling failure callback");p.publish(f.EVENT.XHR_REQUEST_NOT_INITIALIZED),V.debug("Ajax request cannot be sent, this is a connection problem."),b()}},E.isAsync()?4===I.readyState?setTimeout(h):I.onreadystatechange=h:h(),I}},T=function(e,t){return new S(e||window,t||p)},g=new T,m=function(e,t){function n(e){S=e.session}function i(){S=null}function r(e){u=e.username}function a(e){u=e.username,p=e.password}function s(e){return e||(e={}),e.Accept||(e.Accept="application/json"),e["Content-Type"]||(e["Content-Type"]="application/json"),o()||(S?(e["x-session"]=S,delete e.Authorization):(u&&p&&(e.Authorization="basic "+window.btoa(u+":"+p)),delete e["x-session"])),e}function c(n,i,r,a,s,c,d,l){var u=function(e){e===E.Errors.TOKEN_NOT_FOUND?(t.publish(f.EVENT.TOKEN_NOT_FOUND),S=null):e===E.Errors.SESSION_EXPIRED&&(t.publish(f.EVENT.SESSION_EXPIRED),S=null),a&&"function"==typeof a&&a(e)},p=o();return p&&(-1===i.url.indexOf("?")?i.url+="?key="+p:i.url+="&key="+p),e.call(n,i,r,u,s,c,d,l)}function d(e,t,n,i,o,r,a,s){return a||(a={}),a.Accept||(a.Accept="application/json"),a["Content-Type"]||(a["Content-Type"]="application/json"),a["x-session"]&&delete a["x-session"],a.Authorization&&delete a.Authorization,a["x-token"]||(a["x-token"]=s),c(g,e,t,n,i,o,r,a)}var u,p,S,T="PUT",g="POST",m="GET",C="DELETE";this.call=function(e,t,n,i,o,r,a,d){return d=s(d),t&&t.data&&(t.data=JSON.stringify(t.data)),c(e,t,n,i,o,r,a,d)},this.sendPostRequest=function(e,t,n,i,o,r,a,l){return e&&e.data&&(e.data=JSON.stringify(e.data)),l?d(e,t,n,i,o,r,a,l):(a=s(a),c(g,e,t,n,i,o,r,a))},this.sendGetRequest=function(e,t,n,i,o,r,a){return a=s(a),c(m,e,t,n,i,o,r,a)},this.sendDeleteRequest=function(e,t,n,i,o,r,a){return a=s(a),e&&e.data&&(e.data=JSON.stringify(e.data)),c(C,e,t,n,i,o,r,a)},this.sendPutRequest=function(e,t,n,i,o,r,a){return a=s(a),e&&e.data&&(e.data=JSON.stringify(e.data)),c(T,e,t,n,i,o,r,a)},t.subscribe(f.EVENT.TOKEN_AUTH_STARTED,r,9),t.subscribe(f.EVENT.BASIC_AUTH_STARTED,a,10),t.subscribe(f.EVENT.DEVICE_SUBSCRIPTION_STARTED,n),t.subscribe(f.EVENT.DEVICE_SUBSCRIPTION_ENDED,i),l&&(this.manipulateHeader=s),l&&(this.setSession=function(e){S=e}),l&&(this.setUsernamePassword=function(e,t){u=e,p=t})},C=function(e,t){return new m(e||g,t||p)},I=new C,v={polling:30,iceCandidateCollectionTimeoutInterval:3e3,codecsToReplace:[{name:"opus",value:"109"}]},R=null,D=null,A=!0,_=null,h=null,N=null,b=function(i,o,s){var c=null,l=null,u={},p=!0;this.isAsync=function(){return p},this.setAsync=function(e){p=e},this.getUser=t,this.getUserPassword=n,this.getDomain=e,this.getVersion=r,this.getDevice=function(){return c},this.setUserAuth=function(e,t){R=e,D=t,c=null,o.publish(f.EVENT.BASIC_AUTH_STARTED,{username:e,password:t})},this.setTokenAuth=function(e,t){R=e,_=t,o.publish(f.EVENT.TOKEN_AUTH_STARTED,{username:e,token:t})},this.setDeviceAuth=function(e){c=e,R=null},this.setRealm=function(e){h=e},this.setKandyUAT=function(e){N=e},this.AuthenticationType={USER:1,DEVICE:2},this.Errors={NETWORK:1,AUTH:2,STATE:3,PRIV:4,UNKNOWN:9,LOGIN_LIMIT_CLIENT:10,INCORRECT_LOGIN_PASS:11,INVALID_LOGIN:12,FORCE_LOGOUT_ERROR:13,LOGIN_LIMIT_TABLET:14,TOKEN_NOT_FOUND:15,SESSION_EXPIRED:16,VIDEO_SESSION_NOT_AVAILABLE:17,PENDING_REQUEST:18},this.setup=function(e){var t;for(t in e)e.hasOwnProperty(t)&&(v[t]=e[t])},this.setPluginVersion=function(e){l=e},this.getPluginVersion=function(){return l},this.getServices=function(){return u},this.setServices=function(e){var t;if(e)for(t=0;t<e.length;t++)switch(e[t]){case"CallDisplay":u.callDisplay=!0;break;case"CallDisposition":u.callDisposition=!0;break;case"RestfulClient":u.restfulClient=!0;break;case"call":case"CallControl":u.callControl=!0;break;case"CallMe":u.callMe=!0;break;case"Directory":u.directory=!0;break;case"ClickToCall":u.clickToCall=!0;break;case"Presence":u.presence=!0;break;case"AddressBook":u.contacts=!0;break;case"CallLog":u.history=!0;break;case"Custom":u.custom=!0;break;case"IM":u.IM=!0;break;case"Route":u.routes=!0}},this.clearResources=function(e,t,n){n&&E.setAsync(!1),E.notification.stop(function(){s.localStorage.removeItem("SubscriptionStamp")},function(){},!0),t&&(s.localStorage.removeItem("USERNAME"),s.localStorage.removeItem("PASSWORD")),"function"==typeof e&&e()},this.getUserLocale=function(e,t){i.sendGetRequest({url:d(1,"/localization",!1)},function(t){U.callFunctionIfExist(e,t)},t)},this.isConnected=a},O=function(e,t,n){return new b(e||I,t||p,n||window)};E=new O,E.fcsConfig=v,l&&(l.Core=O);var y=function(e){function n(){return Ne?Ne.getNotificationId():null}function i(e){function i(e,i,a){if(r){var c={};if(c.user=t(),c.timestamp=(new Date).getTime(),c.logger=o,c.level=e,c.notificationId=n(),c.message=i,c.args=a,s)try{s(c.logger,c.level,c)}catch(d){return void 0}}return!1}var o=e;this.getName=function(){return o},this.trace=function(e,t){return i(a.TRACE,e,t)},this.debug=function(e,t){return i(a.DEBUG,e,t)},this.info=function(e,t){return i(a.INFO,e,t)},this.warn=function(e,t){return i(a.WARN,e,t)},this.error=function(e,t){return i(a.ERROR,e,t)},this.fatal=function(e,t){return i(a.FATAL,e,t)}}var o={},r=!1,a={OFF:"OFF",FATAL:"FATAL",ERROR:"ERROR",WARN:"WARN",INFO:"INFO",DEBUG:"DEBUG",TRACE:"TRACE",ALL:"ALL"},s=null;this.initLogging=function(e,t){return e&&"function"==typeof e?(s=e,r=t===!0?!0:!1,!0):!1},this.Level=a,this.isEnabled=function(){return r},this.getLogger=function(e){var t,n;return n=e&&0!==e.trim().length?e:"Default",o[n]?t=o[n]:(t=new i(n),o[t.getName()]=t),t}},L=function(){return new y};l&&(l.LogManager=L);var V=new L;E.logManager=V;var P,M=function(){function e(e,t,n,i){P.authenticate(e,t),P.subscribe(n.onLoginSuccess,n.onLoginFailure,n.onCallNotification,n.onImNotification,n.onPresenceNotification,i)}function t(e,t,n,o,r,a){E.call.startCall(E.getUser(),e,t,function(e){e.onStateChange=function(t,n){e.statusCode=n,-1===U.callFunctionIfExist(P.onOutgoingCallStateChange,e,t)&&i.error("Assign a function to spidr.onOutgoingCallStateChange")},e.onStreamAdded=function(t){-1===U.callFunctionIfExist(P.onOutgoingCallStreamAdded,e,t)&&i.error("Assign a function to spidr.onOutgoingCallStreamAdded")},P.outgoingCall=e,U.callFunctionIfExist(n,e)},function(){i.error("CALL FAILED!!!"),U.callFunctionIfExist(o)},r,a)}function n(e,t,n,i){e.answer(t,n,i)}var i=V.getLogger("jslFacade");this.configurationData={notificationType:null,restUrl:null,restPort:null,websocketIP:null,websocketPort:null,disableNotifications:null,protocol:null},this.notificationHandler={onLoginSuccess:null,onLoginFailure:null,onCallNotification:null,onImNotification:null,onPresenceNotification:null},this.environmentVariables={iceserver:null,webrtcdtls:null,pluginMode:null,pluginLogLevel:null,ice:null,videoContainer:""},this.incomingCall=null,this.outgoingCall=null,this.onCallNotification=null,this.onImNotification=null,this.onPresenceNotification=null,this.mediaInitiated=!1,this.callStates=null,this.onIncomingCallStateChange=null,this.onOutgoingCallStateChange=null,this.onIncomingCallStreamAdded=null,this.onOutgoingCallStreamAdded=null,this.rejectSuccess=null,this.rejectFailure=null,this.downloadPlugin=null,this.makeConnection=function(e){E.setup(e)},this.authenticate=function(e,t){E.setUserAuth(e,t)},this.subscribe=function(e,t,n,o,r,a){E.notification.start(function(){-1===U.callFunctionIfExist(e)&&i.error("onLoginSuccess is not defined"),P.callStates=E.call.States,E.call.initMedia(function(){i.info("Media Initiated"),P.mediaInitiated=!0},function(){i.error("Problem occured while initiating media"),U.callFunctionIfExist(P.downloadPlugin)},{pluginLogLevel:P.environmentVariables.pluginLogLevel,ice:P.environmentVariables.ice,videoContainer:P.environmentVariables.videoContainer,pluginMode:P.environmentVariables.pluginMode,iceserver:P.environmentVariables.iceserver,webrtcdtls:P.environmentVariables.webrtcdtls}),a||(E.call.onReceived=function(e){i.info("incoming call"),P.incomingCall=e,P.incomingCall.onStateChange=function(t){-1===U.callFunctionIfExist(P.onIncomingCallStateChange,e,t)&&i.error("Assign a function to spidr.onIncomingCallStateChange")},P.incomingCall.onStreamAdded=function(t){-1===U.callFunctionIfExist(P.onIncomingCallStreamAdded,e,t)&&i.error("Assign a function to spidr.onIncomingCallStreamAdded")},-1===U.callFunctionIfExist(n,e)&&i.error("onCallNotification is not defined")},E.im.onReceived=function(e){-1===U.callFunctionIfExist(o,e)&&i.error("onIMNotification is not defined")},E.presence.onReceived=function(e){-1===U.callFunctionIfExist(r,e)&&i.error("onIMNotification is not defined")})},t,a)},this.loginNamed=function(t,n,i){e(t,n,i,!1)},this.loginAnonymous=function(t){var n=P.notificationHandler;n.onLoginSuccess=function(){i.info("Anonymous login is successful")},n.onLoginFailure=function(){i.error("Anonymous login is failed")},e(t,"abcd1234",n,!0)},this.logout=function(e,t){E.clearResources(function(){},!0,!0)},this.makeVideoCall=function(e,n,i,o){t(e,n,i,o,!1,!0)},this.makeVoiceCall=function(e,n,i,o){t(e,n,i,o,!1,!1)},this.receiveVoiceCall=function(){},this.makeThreeWayCall=function(){},this.makeVoiceToVideoCall=function(){},this.sendIm=function(e,t,n,i,o,r){var a=new E.im.Message;a.primaryContact=e,a.type=t,a.msgText=n,a.charset=i,E.im.send(a,o,r)},this.receiveIm=function(){},this.retrieveContacts=function(e,t){E.addressbook.retrieve(e,t)},this.watchPresence=function(e,t,n){E.presence.watch(e,t,n)},this.unWatchPresence=function(e,t,n){E.presence.stopwatch(e,t,n)},this.receivePresence=function(e,t,n){E.presence.retrieve(e,t,n)},this.updatePresence=function(e){if(E.getServices().presence===!0)switch(E.presence.update(e,function(){i.info("Presence update success")},function(){i.error("Presence update failed")}),e){case 0:i.info("CONNECTED");break;case 1:i.info("UNAVAILABLE");break;case 2:i.info("AWAY");break;case 3:i.info("OUT_TO_LUNCH");break;case 4:i.info("BUSY");break;case 5:i.info("ON_VACATION");break;case 6:i.info("BE_RIGHT_BACK");break;case 7:i.info("ON_THE_PHONE");break;case 8:i.info("ACTIVE");break;case 9:i.info("INACTIVE");break;case 10:i.info("PENDING");break;case 11:i.info("OFFLINE");break;case 12:i.info("CONNECTEDNOTE");break;case 13:i.info("UNAVAILABLENOTE");break;default:i.info("WRONG STATE")}else i.fatal("PRESENCE SERVICE NOT ASSIGNED FOR THIS USER")},this.searchAddress=function(e,t){},this.answerVoiceCall=function(e,t,i){n(e,t,i,!1)},this.answerVideoCall=function(e,t,i){n(e,t,i,!0)},this.endCall=function(e,t,n){e.end(t,n),i.info("Call is ended.")},this.rejectCall=function(e,t,n){e.reject(t,n),i.info("Incoming call is rejected.")},this.startVideo=function(e,t,n){i.info("Start video"),e.videoStart(t,n)},this.stopVideo=function(e,t,n){i.info("Stop video"),e.videoStop(t,n)},this.mute=function(e){e.mute(),i.info("Mute")},this.unMute=function(e){e.unmute(),i.info("Unmute")},this.hold=function(e,t,n){e.hold(t,n),i.info("Hold")},this.unHold=function(e,t,n){e.unhold(t,n),i.info("Unhold")},this.sendDTMF=function(e){var t=P.incomingCall||P.outgoingCall;t.sendDTMF(e)},this.getServices=function(){var e;return e=E.getServices()},this.getUser=function(){var e;return e=E.getUser()}};P=new M,window.spidr=P;var w=function(){var e,t=function(){var e,t,n,i,o,r={},a=document.cookie,s=0;if(""===a)return r;for(e=a.split("; ");s<e.length;s+=1)t=e[s],n=t.indexOf("="),i=t.substring(0,n),o=t.substring(n+1),o=decodeURIComponent(o),r[i]=o;return r}(),n=[];for(e in t)t.hasOwnProperty(e)&&n.push(e);this.length=n.length,this.key=function(e){return 0>e||e>=n.length?null:n[e]},this.getItem=function(e){if(1!==arguments.length)throw new Error("Provide one argument");return t[e]||null},this.setItem=function(e,i){if(2!==arguments.length)throw new Error("Provide two arguments");void 0===t[e]&&(n.push(e),this.length++),t[e]=i;var o=e+"="+encodeURIComponent(i),r=new Date,a=new Date(r.getTime()+2592e6);o+="; max-age="+a,o+="; path=/",document.cookie=o},this.removeItem=function(e){if(1!==arguments.length)throw new Error("Provide one argument");var i,o=0;if(void 0!==t[e]){for(delete t[e],i=n.length;i>o;o+=1)if(n[o]===e){n.splice(o,1);break}this.length--,document.cookie=e+"=; max-age=0"}},this.clear=function(){for(var e=0;e<n.length;e++)document.cookie=n[e]+"=; max-age=0";t={},n=[],this.length=0}};l&&(l.CookieStorage=w);var F="undefined"!=typeof window.localStorage?window.localStorage:new w;window.cache=F;var k=function(){function e(t,n){var i,o;if(t){for(i in t)if(t.hasOwnProperty(i)&&(i===n?o=t[i]:"object"==typeof t[i]&&(o=e(t[i],n)),o))break;return o}}var t=V.getLogger("utils");this.getProperty=function(e,t){return"undefined"==typeof e[t]?null:e[t]},this.callFunctionIfExist=function(){var e,n=Array.prototype.slice.call(arguments);if(e=n.shift(),"function"!=typeof e)return t.info("Not a function:"+e),-1;try{return e.apply(null,n),!0}catch(i){return void t.error("Exception occured:\n"+i.stack)}},this.s4=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},this.extend=function(e,t){var n;for(n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},this.compose=function(e,t){var n;for(n in e)"function"!=typeof e[n]||t[n]||(t[n]=e[n].bind(e))},this.param=function(e){var t,n="";for(t in e)e.hasOwnProperty(t)&&(n.length>0&&(n+="&"),n+=encodeURI(t+"="+e[t]));return n},this.getTimestamp=function(){return(new Date).getTime()},this.getPropertyValueIfExistsInObject=e,this.Queue=function(){var e;this.enqueue=function(t){"undefined"==typeof e&&(e=[]),e.push(t)},this.dequeue=function(){return e.shift()},this.peek=function(){return e[0]},this.size=function(){return"undefined"==typeof e?0:e.length}},this.getQueue=function(){return new this.Queue},this.Map=function(){var e={},t=0;this.size=function(){return t},this.add=function(n,i){return t++,e[n]=i,this},this.get=function(t){return e[t]},this.remove=function(n){return t--,delete e[n]},this.clear=function(){var n;for(n in e)e.hasOwnProperty(n)&&delete e[n]&&t--},this.entries=function(){return e}}},U=new k;Function.prototype.bind||(Function.prototype.bind=function(e){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var t=Array.prototype.slice.call(arguments,1),n=this,i=function(){},o=function(){return n.apply(this instanceof i&&e?this:e,t.concat(Array.prototype.slice.call(arguments)))};return i.prototype=this.prototype,o.prototype=new i,o}),l&&(l.UtilsQueue=U.Queue);var W=function(e){function t(e,t,n){var i;if(e)return(i=e.match(/m=audio [\w\W]*?(\r|\n)/))?(i=i[0].split(" "),i.shift(),i.shift(),i.shift(),-1===i.indexOf(t)?e:-1!==e.indexOf(n)?e:(e=e.split(f.SDP.M_LINE+f.STRING.VIDEO),e[0]=e[0]+n+r+o,e=e[1]?e[0]+f.SDP.M_LINE+f.STRING.VIDEO+e[1]:e[0])):e}var n,i=e.getLogger("sdpParser"),o="\n",r="\r";this.init=function(e){n=this,n.sessionDescription={},n.mediaDescriptions=[],n.sdp=e,n.parseSDP(),n.setSessionDescriptionAttributes(),n.setMediaDescriptionsAttributes()},this.parseSDP=function(){var e,t=[],i=1;for(t=n.sdp.split(/^(?=m=)/m),n.sessionDescription.data=t[0],i;i<t.length;i++)e={},e.data=t[i],n.mediaDescriptions.push(e)},this.setSessionDescriptionAttributes=function(){var e,t=0,i=n.sessionDescription.data.split(/\r\n|\r|\n/);for(t;t<i.length;t++)i[t].match("^e=")?n.sessionDescription.email=i[t].split("=")[1]:i[t].match("^c=")&&(e=i[t].split("=")[1],n.sessionDescription.connection=e,n.sessionDescription.ip=e.split(" ")[2])},this.setMediaDescriptionsAttributes=function(){var e,t,i,o,r=0;for(e in n.mediaDescriptions)if(n.mediaDescriptions.hasOwnProperty(e)){t=n.mediaDescriptions[e].data.split(/\r\n|\r|\n/),this.mediaDescriptions[e].direction="sendrecv";for(r in t)t.hasOwnProperty(r)&&(t[r].match("^m=")?(i=t[r].split("=")[1],n.mediaDescriptions[e].media=i,n.mediaDescriptions[e].port=i.split(" ")[1]):t[r].match("^a=sendrecv")||t[r].match("^a=sendonly")||t[r].match("^a=recvonly")||t[r].match("^a=inactive")?n.mediaDescriptions[e].direction=t[r].split("=")[1]:t[r].match("^c=")&&(o=t[r].split("=")[1],n.mediaDescriptions[e].connection=o,n.mediaDescriptions[e].ip=o.split(" ")[2]))}},this.isHold=function(e){var t,i,o=!1,r=0;for(r in n.mediaDescriptions)if(n.mediaDescriptions.hasOwnProperty(r)&&(i=this.mediaDescriptions[r],i.ip?t=i.ip:n.sessionDescription.ip&&(t=n.sessionDescription.ip),0!==i.port)){if(!("inactive"===i.direction||"sendonly"===i.direction&&e||"recvonly"===i.direction&&!e||"0.0.0.0"===t)){o=!1;break}o=!0}return o},this.isRemoteHold=function(){return this.isHold(!0)},this.isLocalHold=function(){return this.isHold(!1)},this.getSessionDescription=function(){return n.sessionDescription},this.getMediaDescriptions=function(){return n.mediaDescriptions},this.isSdpHas=function(e,t){var n=!1;return e&&-1!==e.indexOf(f.SDP.M_LINE+t)?n=!0:n},this.isSdpHasAudio=function(e){return this.isSdpHas(e,f.STRING.AUDIO)},this.isSdpHasVideo=function(e){return this.isSdpHas(e,f.STRING.VIDEO)},this.isSdpHasUfrag=function(e){var t=!1;return e&&-1!==e.indexOf(f.SDP.A_LINE+f.SDP.ICE_UFRAG)?t=!0:t},this.isSdpHasMediaWithExpectedPort=function(e,t,n){return-1!==e.indexOf(f.SDP.M_LINE+t+" "+n)},this.isSdpHasAudioWithZeroPort=function(e){return this.isSdpHasMediaWithExpectedPort(e,f.STRING.AUDIO,0)},this.isSdpHasVideoWithZeroPort=function(e){return this.isSdpHasMediaWithExpectedPort(e,f.STRING.VIDEO,0)},this.isSdpHasAudioWithOnePort=function(e){return this.isSdpHasMediaWithExpectedPort(e,f.STRING.AUDIO,1)},this.isSdpHasVideoWithOnePort=function(e){return this.isSdpHasMediaWithExpectedPort(e,f.STRING.VIDEO,1)},this.isSdpHasAudioWithNinePort=function(e){return this.isSdpHasMediaWithExpectedPort(e,f.STRING.AUDIO,9)},this.isSdpHasVideoWithNinePort=function(e){return this.isSdpHasMediaWithExpectedPort(e,f.STRING.VIDEO,9)},this.replaceZeroVideoPortWithOne=function(e){return this.isSdpHasVideoWithZeroPort(e)&&(e=e.replace(f.SDP.M_LINE+f.STRING.VIDEO+" 0 ",f.SDP.M_LINE+f.STRING.VIDEO+" 1 ")),e},this.getSdpDirection=function(e,t){var n,o,r="",a=[],s=f.WEBRTC.MEDIA_STATE.INACTIVE;if(o=function(e){i.info("getSdpDirection: type= "+t+" state= "+e)},!this.isSdpHas(e,t))return o(s),s;if(this.isSdpHasMediaWithExpectedPort(e,t,0))return o(s),s;for(a=e.split(/^(?=m=)/m),n=0;n<a.length;n++)if(r=a[n],-1!==r.indexOf(f.SDP.M_LINE+t))return-1!==r.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.SEND_RECEIVE)?(s=f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,o(s),s):-1!==r.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.SEND_ONLY)?(s=f.WEBRTC.MEDIA_STATE.SEND_ONLY,o(s),s):-1!==r.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)?(s=f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,o(s),s):-1!==r.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.INACTIVE)?(o(s),s):s=f.WEBRTC.MEDIA_STATE.SEND_RECEIVE;return s=f.WEBRTC.MEDIA_STATE.NOT_FOUND,o(s),s},this.getAudioSdpDirection=function(e){return this.getSdpDirection(e,f.STRING.AUDIO)},this.getVideoSdpDirection=function(e){return this.getSdpDirection(e,f.STRING.VIDEO)},this.isAudioSdpDirectionInactive=function(e){return this.getAudioSdpDirection(e)===f.WEBRTC.MEDIA_STATE.INACTIVE},this.isAudioSdpDirectionSendrecv=function(e){return this.getAudioSdpDirection(e)===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE},this.isAudioSdpDirectionSendonly=function(e){return this.getAudioSdpDirection(e)===f.WEBRTC.MEDIA_STATE.SEND_ONLY},this.isAudioSdpDirectionRecvonly=function(e){return this.getAudioSdpDirection(e)===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY},this.isSdpContainsAudioDirection=function(e){return this.getAudioSdpDirection(e)!==f.WEBRTC.MEDIA_STATE.NOT_FOUND},this.isVideoSdpDirectionInactive=function(e){return this.getVideoSdpDirection(e)===f.WEBRTC.MEDIA_STATE.INACTIVE},this.isVideoSdpDirectionSendrecv=function(e){return this.getVideoSdpDirection(e)===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE},this.isVideoSdpDirectionSendonly=function(e){return this.getVideoSdpDirection(e)===f.WEBRTC.MEDIA_STATE.SEND_ONLY},this.isVideoSdpDirectionRecvonly=function(e){return this.getVideoSdpDirection(e)===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY},this.isSdpContainsVideoDirection=function(e){return this.getVideoSdpDirection(e)!==f.WEBRTC.MEDIA_STATE.NOT_FOUND},this.changeDirection=function(e,t,n,o){var r,a,s="",c=[],d="changeDirection: before= "+t+" after= "+n;if(t===n)return e;if(void 0===o||null===o)i.info(d+" for all media types");else{if(t!==this.getSdpDirection(e,o))return e;i.info(d+" type= "+o)}for(c=e.split(/^(?=m=)/m),a=0;a<c.length;a++)r=c[a],(void 0===o||null===o||-1!==r.indexOf(f.SDP.M_LINE+o))&&(r=r.replace(f.SDP.A_LINE+t,f.SDP.A_LINE+n)),s+=r;return s},this.updateSdpDirection=function(e,t,n){i.info("updateSdpDirection: type= "+t+" direction= "+n);var o=this.getSdpDirection(e,t);return this.changeDirection(e,o,n,t)},this.updateAudioSdpDirection=function(e,t){i.info("updateSdpDirection: type= "+f.STRING.AUDIO+" direction= "+t);var n=this.getSdpDirection(e,f.STRING.AUDIO);return this.changeDirection(e,n,t,f.STRING.AUDIO)},this.updateVideoSdpDirection=function(e,t){i.info("updateSdpDirection: type= "+f.STRING.VIDEO+" direction= "+t);var n=this.getSdpDirection(e,f.STRING.VIDEO);return this.changeDirection(e,n,t,f.STRING.VIDEO)},this.updateAudioSdpDirectionToInactive=function(e){return this.updateAudioSdpDirection(e,f.WEBRTC.MEDIA_STATE.INACTIVE)},this.updateVideoSdpDirectionToInactive=function(e){return this.updateVideoSdpDirection(e,f.WEBRTC.MEDIA_STATE.INACTIVE)},this.isSdpHasDirection=function(e){var t,n,i,o;return t=e.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,0),n=e.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.SEND_ONLY,0),i=e.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,0),o=e.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.INACTIVE,0),t+1+(n+1)+(i+1)+(o+1)===0?!1:!0},this.isSdpEnabled=function(e,t){var n,o="isSdpEnabled for type "+t+": ",r=!1;return this.isSdpHasMediaWithExpectedPort(e,t,0)?(i.info(o+r),r):t===f.STRING.VIDEO&&(n=this.getVideoSdpDirection(e),n===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY||n===f.WEBRTC.MEDIA_STATE.INACTIVE)?(i.info(o+r),r):(this.isSdpHas(e,t)&&(r=!0),i.info(o+r),r)},this.isAudioSdpEnabled=function(e){return this.isSdpEnabled(e,f.STRING.AUDIO)},this.isVideoSdpEnabled=function(e){return this.isSdpEnabled(e,f.STRING.VIDEO)},this.isSdpVideoReceiveEnabled=function(e){var t,n="isSdpVideoReceiveEnabled: ",o=!1;return-1!==e.indexOf(f.SDP.M_LINE+f.STRING.VIDEO+" 0")?(i.info(n+o),o):(t=this.getVideoSdpDirection(e),t===f.WEBRTC.MEDIA_STATE.SEND_ONLY||t===f.WEBRTC.MEDIA_STATE.INACTIVE?(i.info(n+o),o):-1!==e.indexOf(f.SDP.M_LINE+f.STRING.VIDEO)?(o=!0,i.info(n+o),o):(i.info(n+o),o))},this.updateH264Level=function(e){var t,n,i,o,r,a="",s="",c=[],d=/\r\n|\r|\n/m,l="";for(c=e.split(/^(?=m=)/m),t=0;t<c.length;t++){if(s=c[t],-1!==s.indexOf(f.SDP.M_LINE+f.STRING.VIDEO)){for(n=s.split(d),i=0;i<n.length;i++)o=n[i],o&&-1!==o.indexOf("a=rtpmap:")&&-1!==o.indexOf("H264")?(r=o.split(/\:| /m),o=o+f.STRING.CARRIAGE_RETURN+f.STRING.NEW_LINE,o=o+"a=fmtp:"+r[1]+" profile-level-id=428014;",o=o+f.STRING.CARRIAGE_RETURN+f.STRING.NEW_LINE):o&&""!==o&&(o=o+f.STRING.CARRIAGE_RETURN+f.STRING.NEW_LINE),l+=o;s=l}a+=s}return a},this.updateH264LevelTo42E01F=function(e,t){return t&&(i.debug("Updating the H264 profile-level-id to 42e01f"),e=e.replace(/profile-level-id=4280/g,"profile-level-id=42e0")),e},this.isSdpVideoCandidateEnabled=function(e){var t="isSdpVideoCandidateEnabled: ",n=!1;return this.isSdpHasVideoWithZeroPort(e)?(i.info(t+n),n):this.isVideoSdpDirectionInactive(e)?(i.info(t+n),n):this.isSdpHasVideo(e)?(i.info(t+n),n):(n=!0,i.info(t+n),!0)},this.deleteFingerprintFromSdp=function(e,t){if(t)return e;for(;-1!==e.indexOf("a=fingerprint:");)e=e.replace(/(a=fingerprint:[\w\W]*?(:\r|\n))/,"");for(;-1!==e.indexOf("a=setup:");)e=e.replace(/(a=setup:[\w\W]*?(:\r|\n))/,"");return e},this.deleteCryptoFromSdp=function(e,t){if(!t)return e;for(;-1!==e.indexOf("a=crypto:");)e=e.replace(/(a=crypto:[\w\W]*?(:\r|\n))/,"");return e},this.deleteCryptoZeroFromSdp=function(e){for(;-1!==e.indexOf("a=crypto:0");)e=e.replace(/(a=crypto:0[\w\W]*?(:\r|\n))/,"");return e},this.updateAudioCodec=function(e){var t,n,i,a,s,c,d,l,u="",p="",f=[],E=/\r\n|\r|\n/m,S="",T=[];for(l="",f=e.split(/^(?=m=)/m),t=0;t<f.length;t++){if(p=f[t],this.isSdpHasAudio(p)){for(n=p.split(E),i=0;i<n.length;i++){if(a=n[i],a&&this.isSdpHasAudio(a)){if(T=v.codecsToRemove,void 0!==T)for(d=0;d<T.length;d++)s=T[d],c=new RegExp(" "+s,"g"),a=a.replace(c,""),0!==d&&(l+="|"),l+=s;a=a+r+o}else a&&-1!==a.indexOf("a=fmtp")?a=a.replace(/a=fmtp[\w\W]*/,""):a&&""!==a&&(a=a+r+o);S+=a}p=S}u+=p}return""!==l&&(c=new RegExp("a=rtpmap:(?:"+l+").*\r\n","g"),u=u.replace(c,"")),u},this.removeAudioCodec=function(e,t){var n,i,a,s,c,d,l="",u="",p=[],f=/\r\n|\r|\n/m,E="";for(p=e.split(/^(?=m=)/m),n=0;n<p.length;n++){if(u=p[n],this.isSdpHasAudio(u)){for(i=u.split(f),a=0;a<i.length;a++)s=i[a],s&&this.isSdpHasAudio(s)?(d=new RegExp(" "+t+"($| )","m"),c=i[a].split(/RTP[\w\W]*/),s=s.replace(/(\m=audio+)\s(\w+)/,""),s=s.trim(),s=s.replace(d," "),s=c[0]+s+r+o):s&&-1!==s.indexOf("a=fmtp:"+t)?s=s.replace(/a=fmtp[\w\W]*/,""):s&&-1!==s.indexOf("a=rtpmap:"+t)?s=s.replace(/a=rtpmap[\w\W]*/,""):s&&-1!==s.indexOf("a=rtcp-fb:"+t)?s=s.replace(/a=rtcp-fb[\w\W]*/,""):s&&""!==s&&(s=s+r+o),E+=s;u=E}l+=u}return l},this.removeRTXCodec=function(e){var t,n,o;return n=this.getVp8Ssrc(e),i.debug("vp8SSRC = "+n),o=this.getRtxSsrc(e),i.debug("rtxSSRC = "+o),e=this.removeSsrcId(e,o),e=e.replace(/(a=ssrc-group:FID[\w\W]*?(:\r|\n))/g,""),
-1===e.indexOf("rtx/90000")?e:(t=this.getRTXPayloadType(e),i.debug("removeRTXCodec : Removing rtx video codec "+t),e=this.removeVideoCodec(e,t))},this.getVp8Ssrc=function(e){var t,n,o,r,a=/\r\n|\r|\n/m;if(-1===e.indexOf("a=ssrc-group:FID "))return-1;for(t=e.split("a=ssrc-group:FID "),n=t[1].split(a),o=n[0].split(" "),r=0;r<o.length;r++)i.debug("ssrcArray["+r+"] : "+o[r]);return o[0]},this.getRtxSsrc=function(e){var t,n,o,r,a=/\r\n|\r|\n/m;if(-1===e.indexOf("a=ssrc-group:FID "))return-1;for(t=e.split("a=ssrc-group:FID "),n=t[1].split(a),o=n[0].split(" "),r=0;r<o.length;r++)i.debug("ssrcArray["+r+"] : "+o[r]);return o[1]},this.removeSsrcId=function(e,t){var n,i,a,s="",c=/\r\n|\r|\n/m,d="";for(n=e.split(c),i=0;i<n.length;i++)a=n[i],a&&-1!==a.indexOf("a=ssrc:"+t)?a=a.replace(/a=ssrc:[\w\W]*/,""):a&&""!==a&&(a=a+r+o),d+=a;return s=d},this.removeG722Codec=function(e){return e},this.fixLocalTelephoneEventPayloadType=function(e,t){var n;return e.localTelephoneEvent8000PayloadType=this.getTelephoneEventCode(t,"8000",e.localTelephoneEvent8000PayloadType),e.localTelephoneEvent16000PayloadType=this.getTelephoneEventCode(t,"16000",e.localTelephoneEvent16000PayloadType),n=this.fixTelephoneEventPayloadType(t,"8000",e.localTelephoneEvent8000PayloadType),n=this.fixTelephoneEventPayloadType(n,"16000",e.localTelephoneEvent16000PayloadType)},this.fixRemoteTelephoneEventPayloadType=function(e,t){var n;return e.remoteTelephoneEvent8000PayloadType=this.getTelephoneEventCode(t,"8000",e.remoteTelephoneEvent8000PayloadType),e.remoteTelephoneEvent16000PayloadType=this.getTelephoneEventCode(t,"16000",e.remoteTelephoneEvent16000PayloadType),n=this.fixTelephoneEventPayloadType(t,"8000",e.remoteTelephoneEvent8000PayloadType),n=this.fixTelephoneEventPayloadType(n,"16000",e.remoteTelephoneEvent16000PayloadType)},this.getTelephoneEventCode=function(e,t,n){var i;return this.isSdpHasTelephoneEventWithRate(e,t)?(i=this.getTelephoneEventPayloadType(e,t),n?n:i):null},this.fixTelephoneEventPayloadType=function(e,t,n){var i,o;if(this.isSdpHasTelephoneEventWithRate(e,t))if(i=this.getTelephoneEventPayloadType(e,t),n){if(n!==i)return o=this.replaceTelephoneEventPayloadType(e,n,i)}else n=i;return e},this.getTelephoneEventPayloadType=function(e,t){return this.getPayloadTypeOf("telephone-event/"+t,e)},this.getPayloadTypeOf=function(e,t){var n,o,r,a=[];if(-1===t.indexOf(e))return-1;for(o=t.match(/(a=rtpmap[\w\W]*?(:\r|\n))/g),r=0;r<o.length;r++)-1!==o[r].search(new RegExp(e,"i"))&&(n=o[r].match(/^[^\d]*(\d+)/g),n=n[0].split(":"),a.push(n[1]));return i.debug("getPayloadTypeOf("+e+") = "+a[0]),a.length<2?a[0]:a},this.replaceTelephoneEventPayloadType=function(e,t,n){var o,r,a,s,c,d,l,u="",p="";if(!e||-1===e.indexOf("telephone-event"))return e;if(r=/^\.*(a=rtpmap:)(\d*)( telephone-event[ \w+ ]*[ \/+ ]*[ \w+ ]*)\r\n?/m,t===n)return e;for(o=e,r=new RegExp("^\\.*a=rtpmap:"+n+" telephone-event[ \\/+ ]*([ \\w+ ]*)\\r\n","m"),a=o.match(r),p=null!==a&&a.length>=2&&""!==a[1]?a[1]:8e3,o=o.replace(r,"a=rtpmap:"+t+" telephone-event/"+p+"\r\n"),r=new RegExp("^\\.*(m=audio )[ \\w+ ]*[ \\/+ ]*[ \\w+ ]*( "+n+")","mg"),a=o.match(r),null!==a&&a.length>=1&&""!==a[0]&&(s=a[0],s=s.replace(n,t),o=o.replace(r,s)),c=o.split(/^(?=m=)/m),d=0;d<c.length;d++)l=c[d],this.isSdpHasAudio(l)&&(r=new RegExp("^\\.*a=fmtp:"+n,"mg"),l=l.replace(r,"a=fmtp:"+t)),u+=l;return""!==u&&(o=u),i.debug("replaceTelephoneEventPayloadType: newcode "+n+" is replaced with oldcode "+t),o},this.replaceOpusCodec=function(e){var t,n,o,r,a,s,c="",d=109,l="";if(!e||-1===e.indexOf("opus"))return e;for(t=/^\.*(a=rtpmap:)(\d*)( opus)/m,n=e.match(t),null!==n&&n.length>=3&&""!==n[2]?c=n[2]:i.warn("sdp has opus without codec number"),e=e.replace(t,"a=rtpmap:"+d+" opus"),t=new RegExp("^\\.*(m=audio )[ \\w+ ]*[ \\/+ ]*[ \\w+ ]*( "+c+")","mg"),n=e.match(t),null!==n&&n.length>=1&&""!==n[0]&&(o=n[0],o=o.replace(c,d),e=e.replace(t,o)),r=e.split(/^(?=m=)/m),a=0;a<r.length;a++)s=r[a],this.isSdpHasAudio(s)&&(t=new RegExp("^\\.*a=fmtp:"+c,"mg"),s=s.replace(t,"a=fmtp:"+d)),l+=s;return""!==l&&(e=l),i.debug("replaceOpusCodec: new codec= "+d),e},this.getG7228000PayloadType=function(e){return this.getPayloadTypeOf("G722/8000",e)},this.getVP8PayloadType=function(e){return this.getPayloadTypeOf("VP8/90000",e)},this.getG72216000PayloadType=function(e){return this.getPayloadTypeOf("G722/16000",e)},this.getRTXPayloadType=function(e){return this.getPayloadTypeOf("rtx/90000",e)},this.getH264PayloadType=function(e){return this.getPayloadTypeOf("H264/90000",e)},this.isSdpHasTelephoneEventWithRate=function(e,t){return-1!==e.indexOf("telephone-event/"+t)},this.isSdpHasTelephoneEvent=function(e){return-1!==e.indexOf("telephone-event/")},this.isSdpHasVP8Codec=function(e){return-1!==e.indexOf("VP8/90000")},this.isSdpHasH264Codec=function(e){return-1!==e.indexOf("H264/90000")},this.checkSupportedVideoCodecs=function(e,t,n){var i;return this.isVideoCodecsSupported(e,n)?e:(t?(i=this.removeAllVideoCodecs(e),i=this.addVP8Codec(i,t),i=this.updateSdpVideoPort(i,!1),i=this.performVideoPortZeroWorkaround(i)):this.isSdpHasVP8Codec(e)?i=this.removeVideoDescription(e):-1!==e.indexOf(f.SDP.M_LINE+f.STRING.VIDEO+" 0 ",0)?i=this.addVP8Codec(e,i):(i=this.updateSdpVideoPort(e,!1),i=this.addVP8Codec(i,i)),i)},this.isVideoCodecsSupported=function(e,t){return this.isSdpHasVP8Codec(e)?!0:t&&this.isSdpHasH264Codec(e)?!0:!1},this.removeAllVideoCodecs=function(e){var t,n,o,r,a;if(t=new RegExp("^\\.*(m=video )(\\d*)( RTP/SAVPF )([ \\w+ ]*[ \\/+ ]*[ \\w+ ])\\r\n","m"),r=e,n=r.match(t),null!==n&&n.length>=5&&""!==n[0])for(o=n[4].split(" "),a=0;a<o.length;a++)i.debug("codec["+a+"] : "+o[a]),r=this.removeVideoCodec(r,o[a]);return r},this.removeVideoCodec=function(e,t){var n,i,a,s,c,d="",l="",u=[],p=/\r\n|\r|\n/m,f="";for(u=e.split(/^(?=m=)/m),n=0;n<u.length;n++){if(l=u[n],this.isSdpHasVideo(l)){for(i=l.split(p),a=0;a<i.length;a++)s=i[a],s&&this.isSdpHasVideo(s)?(c=new RegExp(" "+t,"g"),s=s.replace(c,""),s=s+r+o):s&&-1!==s.indexOf("a=fmtp:"+t)?s=s.replace(/a=fmtp[\w\W]*/,""):s&&-1!==s.indexOf("a=rtpmap:"+t)?s=s.replace(/a=rtpmap[\w\W]*/,""):s&&-1!==s.indexOf("a=rtcp-fb:"+t)?s=s.replace(/a=rtcp-fb[\w\W]*/,""):s&&""!==s&&(s=s+r+o),f+=s;l=f}d+=l}return d},this.addVP8Codec=function(e,t){var n,i,a,s,c,d,l,u,p,E,S="",T="",g=[],m=/\r\n|\r|\n/m,C="";if(this.isSdpHasVP8Codec(e))return e;for(g=e.split(/^(?=m=)/m),n=0;n<g.length;n++){if(T=g[n],this.isSdpHasVideo(T)){if(t&&this.isSdpHasVideo(t)&&this.isSdpHasVP8Codec(t))s=this.getVP8PayloadType(t),-1!==T.indexOf("a=rtpmap:"+s)&&this.removeSdpLineContainingText(T,"a=rtpmap:"+s);else{for(c=100;-1!==T.indexOf("a=rtpmap:"+c);)c+=1;s=c}for(i=T.split(m),a=0;a<i.length;a++)d=i[a],d&&this.isSdpHasVideo(d)?(-1===d.indexOf(s)&&(d=d+" "+s),d=d+r+o+"a=rtpmap:"+s+" VP8/90000"+r+o):d&&""!==d&&(d=d+r+o),C+=d;T=C}S+=T}return l=this.checkICEParams(S,"video",f.SDP.ICE_UFRAG),2>l&&(p=this.getICEParams(S,f.SDP.ICE_UFRAG,!1),p&&(S=this.restoreICEParams(S,"video",f.SDP.ICE_UFRAG,p))),u=this.checkICEParams(S,"video",f.SDP.ICE_PWD),2>u&&(E=this.getICEParams(S,f.SDP.ICE_PWD,!1),E&&(S=this.restoreICEParams(S,"video",f.SDP.ICE_PWD,E))),S},this.removeSdpLineContainingText=function(e,t){var n,r=e.split(o);for(e=r[0]+o,n=1;n<r.length-1;n++)-1!==r[n].indexOf(t)?i.debug("removed line which contains "+t):e+=r[n]+o;return e},this.removeVideoDescription=function(e){var t,n="",o="",r=[];for(r=e.split(/^(?=m=)/m),t=0;t<r.length;t++)o=r[t],this.isSdpHasVideo(o)?i.debug("removeVideoDescription : m=video description removed"):n+=o;return n},this.updateSdpVideoPort=function(e,t){var n,o;return i.debug("updateSdpVideoPort: status= "+t),n=e,t?o=f.SDP.M_LINE+f.STRING.VIDEO+" 1":(o=f.SDP.M_LINE+f.STRING.VIDEO+" 0",n=this.updateSdpDirection(n,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.INACTIVE)),this.isSdpHasVideo(n)&&(n=n.replace(/m=video [0-9]+/,o)),n},this.performVideoPortZeroWorkaround=function(e){return this.isSdpHasVideoWithZeroPort(e)?(e=this.addSdpMissingCryptoLine(e),e=this.replaceZeroVideoPortWithOne(e),e=this.updateVideoSdpDirectionToInactive(e)):e},this.addSdpMissingCryptoLine=function(e){var t,n,o,r=null,a=/\r\n|\r|\n/m;if(-1===e.indexOf(f.SDP.M_LINE+f.STRING.VIDEO+" 0 ",0))return e;for(t=e.split(f.SDP.M_LINE+f.STRING.VIDEO),n=t[0].split(a),o=0;o<n.length;o++)if(-1!==n[o].indexOf(f.SDP.A_LINE+f.SDP.CRYPTO)||-1!==n[o].indexOf(f.SDP.A_LINE+f.SDP.FINGERPRINT)){r=n[o];break}return null===r?e:(-1!==t[0].indexOf(f.SDP.A_LINE+f.SDP.CRYPTO)?-1===t[1].indexOf(f.SDP.A_LINE+f.SDP.CRYPTO,0)&&(t[1]+=r+"\n",i.debug("addSdpMissingCryptoLine : crypto line is added : "+r)):-1!==t[0].indexOf(f.SDP.A_LINE+f.SDP.FINGERPRINT,0)&&-1===t[1].indexOf(f.SDP.A_LINE+f.SDP.FINGERPRINT,0)&&(t[1]+=r+"\na=setup:passive\n",i.debug("addSdpMissingCryptoLine : dtls lines are added : "+r+"and a=setup:passive"),i.debug("dtls enabled: known issue by webrtc may be fixed! Check it")),e=t.join(f.SDP.M_LINE+f.STRING.VIDEO))},this.checkICEParams=function(e,t,n){var i,o;if(i=e.split("m=video"),i.length<2)return 0;switch(n){case f.SDP.ICE_UFRAG:o="audio"===t?i[0].split("a=ice-ufrag:"):i[1].split("a=ice-ufrag:");break;case f.SDP.ICE_PWD:o="audio"===t?i[0].split("a=ice-pwd:"):i[1].split("a=ice-pwd:");break;default:return 0}return o.length},this.getICEParams=function(e,t,n){var i,o,r,a;switch(t){case f.SDP.ICE_UFRAG:i=e.split("a=ice-ufrag:");break;case f.SDP.ICE_PWD:i=e.split("a=ice-pwd:");break;default:return void 0}return n?void 0!==i[2]?(o=i[2],r=o.split("a="),a=r[0]):void 0:void 0!==i[1]?(o=i[1],r=o.split("a="),a=r[0]):void 0},this.restoreICEParams=function(e,t,n,i){var o,r,a,s="";if(a=e.split("m=video"),a.length<2)return e;for(r=0;r<a.length;r++)o=a[r],0===r&&("audio"===t&&(o=o+"a="+n+i),s+=o),1===r&&("video"===t&&(o=o+"a="+n+i),s=s+"m=video"+o);return s},this.updateICEParams=function(e,t,n){var i,o,r,a,s,c,d="",l="";switch(t){case f.SDP.ICE_UFRAG:a=e.split("a=ice-ufrag:");break;case f.SDP.ICE_PWD:a=e.split("a=ice-pwd:");break;default:return e}for(o=0;o<a.length;o++)if(i=a[o],2===o){for(s=i.split("a="),r=0;r<s.length;r++)c=s[r],0===r?(s[r]=n,l+=s[r]):l=l+"a="+s[r];i=l,d+=i}else d=d+i+"a="+t;return d},this.checkIceParamsLengths=function(e,t){var n,i;return n=this.getICEParams(e,f.SDP.ICE_UFRAG,!0),i=this.getICEParams(e,f.SDP.ICE_PWD,!0),n&&n.length<4&&(n=this.getICEParams(t,f.SDP.ICE_UFRAG,!0),n&&(e=this.updateICEParams(e,f.SDP.ICE_UFRAG,n))),i&&i.length<22&&(i=this.getICEParams(t,f.SDP.ICE_PWD,!0),i&&(e=this.updateICEParams(e,f.SDP.ICE_PWD,i))),e},this.isSdpVideoSendEnabled=function(e){var t,n="isSdpVideoSendEnabled: ",o=!1;return this.isSdpEnabled(e,f.STRING.VIDEO)?(t=this.getSdpDirectionLogging(e,f.STRING.VIDEO,!1),t===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE||t===f.WEBRTC.MEDIA_STATE.SEND_ONLY?(o=!0,i.debug(n+o),o):(i.debug(n+o),o)):(i.debug(n+o),o)},this.getSdpDirectionLogging=function(e,t,n){var o,r,a="",s=[],c=f.WEBRTC.MEDIA_STATE.INACTIVE;if(r=function(e){n&&i.debug("getSdpDirection: type= "+t+" state= "+e)},-1===e.indexOf(f.SDP.M_LINE+t))return r(c),c;if(-1!==e.indexOf(f.SDP.M_LINE+t+" 0"))return r(c),c;for(s=e.split(/^(?=m=)/m),o=0;o<s.length;o++)if(a=s[o],-1!==a.indexOf(f.SDP.M_LINE+t))return-1!==a.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.SEND_RECEIVE)?(c=f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,r(c),c):-1!==a.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.SEND_ONLY)?(c=f.WEBRTC.MEDIA_STATE.SEND_ONLY,r(c),c):-1!==a.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)?(c=f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,r(c),c):-1!==a.indexOf(f.SDP.A_LINE+f.WEBRTC.MEDIA_STATE.INACTIVE)?(r(c),c):c=f.WEBRTC.MEDIA_STATE.SEND_RECEIVE;return c=f.WEBRTC.MEDIA_STATE.NOT_FOUND,r(c),c},this.deleteInactiveVideoSsrc=function(e){var t=[];return this.isSdpHas(e,f.STRING.VIDEO)?(t=e.split(f.SDP.M_LINE+f.STRING.VIDEO),null!==t[1]&&(t[1]=this.deleteSsrcFromSdp(t[1])),t[0]+f.SDP.M_LINE+f.STRING.VIDEO+t[1]):e},this.deleteSsrcFromSdp=function(e){for(;-1!==e.indexOf("a=ssrc");)e=e.replace(/(a=ssrc[\w\W]*?(:\r|\n))/,"");return e},this.getTcpSetupAttribute=function(e){var t;return-1!==e.indexOf(f.SDP.SETUP_ACTIVE)?t=f.SDP.SETUP_ACTIVE:-1!==e.indexOf(f.SDP.SETUP_PASSIVE)?t=f.SDP.SETUP_PASSIVE:-1!==e.indexOf(f.SDP.SETUP_ACTPASS)&&(t=f.SDP.SETUP_ACTPASS),t},this.setTcpSetupAttributeTo=function(e,t,n){if(!n)return e;if(t!==f.SDP.SETUP_ACTIVE)for(;-1!==e.indexOf(f.SDP.SETUP_ACTIVE);)i.debug("a=setup:active to "+t),e=e.replace(f.SDP.SETUP_ACTIVE,t);if(t!==f.SDP.SETUP_PASSIVE)for(;-1!==e.indexOf(f.SDP.SETUP_PASSIVE);)i.debug("a=setup:passive to "+t),e=e.replace(f.SDP.SETUP_PASSIVE,t);if(t!==f.SDP.SETUP_ACTPASS)for(;-1!==e.indexOf(f.SDP.SETUP_ACTPASS);)i.debug("a=setup:passive to "+t),e=e.replace(f.SDP.SETUP_ACTPASS,t);return e},this.setTcpSetupAttributeToActpass=function(e,t){return this.setTcpSetupAttributeTo(e,f.SDP.SETUP_ACTPASS,t)},this.checkAndRestoreICEParams=function(e,t){var n,i,o,r,a,s;return n=this.checkICEParams(e,f.STRING.AUDIO,f.SDP.ICE_UFRAG),2>n&&(a=this.getICEParams(t,f.SDP.ICE_UFRAG,!1),a&&(e=this.restoreICEParams(e,f.STRING.AUDIO,f.SDP.ICE_UFRAG,a))),i=this.checkICEParams(e,f.STRING.AUDIO,f.SDP.ICE_PWD),2>i&&(s=this.getICEParams(t,f.SDP.ICE_PWD,!1),s&&(e=this.restoreICEParams(e,f.STRING.AUDIO,f.SDP.ICE_PWD,s))),o=this.checkICEParams(e,f.STRING.VIDEO,f.SDP.ICE_UFRAG),2>o&&(a=this.getICEParams(t,f.SDP.ICE_UFRAG,!1),a&&(e=this.restoreICEParams(e,f.STRING.VIDEO,f.SDP.ICE_UFRAG,a))),r=this.checkICEParams(e,f.STRING.VIDEO,f.SDP.ICE_PWD),2>r&&(s=this.getICEParams(t,f.SDP.ICE_PWD,!1),s&&(e=this.restoreICEParams(e,f.STRING.VIDEO,f.SDP.ICE_PWD,s))),e},this.incrementVersion=function(e){var t,n,o,r=[],a="";if(i.debug("incrementVersion"),!e)return e;if(o=e.match(/(o=[\w\W]*?(:\r|\n))/),!o)return e;for(r=o[0].split(" "),n=+r[2],n+=1,t=0;t<r.length;t++)0!==t&&(a+=" "),a+=2===t?n:r[t];return e=e.replace(o[0],a)},this.escalateSdpDirection=function(e,t){var n=this.getSdpDirectionLogging(e,t,!1);return i.debug("escalateSdpDirection: type= "+t+" direction= "+n),n===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY?this.changeDirection(e,n,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,t):n===f.WEBRTC.MEDIA_STATE.INACTIVE?this.changeDirection(e,n,f.WEBRTC.MEDIA_STATE.SEND_ONLY,t):e},this.deescalateSdpDirection=function(e,t){var n=this.getSdpDirectionLogging(e,t,!1);return i.debug("deescalateSdpDirection: type= "+t+" direction= "+n),n===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE?this.changeDirection(e,n,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,t):n===f.WEBRTC.MEDIA_STATE.SEND_ONLY?this.changeDirection(e,n,f.WEBRTC.MEDIA_STATE.INACTIVE,t):e},this.isIceLite=function(e){return e&&-1!==e.indexOf("a=ice-lite")?!0:!1},this.updateVersion=function(e,t){var n,o,r=[],a=[],s="",c="";if(!e)return t;if(i.debug(" updateVersion called..."),r=e.match(/(o=[\w\W]*?(:\r|\n))/),!r)return t;if(r=r[0].split(" "),c=t.match(/(o=[\w\W]*?(:\r|\n))/),a=c[0].split(" "),!r)return i.warn("updateVersion called with wrong fromSdp!!"),t;for(o=r[2],o=+o+1,i.debug(" updateVersion fromVersion incremented: "+o),n=0;n<a.length;n++)0!==n&&(s+=" "),s+=2===n?o:a[n];return t=t.replace(c[0],s)},this.copyCandidatesToTheNewLocalSdp=function(e,t){var n,i,o,r,a=[],s=[];return a=e.split(f.SDP.M_LINE+f.STRING.VIDEO),s=t.split(f.SDP.M_LINE+f.STRING.VIDEO),o=a[0],n=void 0!==a[1]?f.SDP.M_LINE+f.STRING.VIDEO+a[1]:void 0,r=s[0],i=void 0!==s[1]?f.SDP.M_LINE+f.STRING.VIDEO+s[1]:void 0,r=this.copyCandidates(o,r),void 0!==n&&void 0!==i&&(i=this.copyCandidates(n,i)),void 0!==i?r+i:r},this.copyCandidates=function(e,t){var n,i,o,r=/\r\n|\r|\n/m;for(n=e.split(r),i=0;i<n.length;i++)-1!==n[i].indexOf("a=candidate")&&t.indexOf(!1)?t+=n[i]+"\r\n":-1!==n[i].indexOf("c=IN")&&t.indexOf(!0)?t=t.replace(/(c=[\w\W]*?(:\r|\n))/,n[i]+"\r\n"):-1===n[i].indexOf("m=audio")||-1===t.indexOf(f.SDP.M_LINE+f.STRING.AUDIO+" 1 ")&&-1===t.indexOf(f.SDP.M_LINE+f.STRING.AUDIO+" 9 ")?-1===n[i].indexOf("m=video")||-1===t.indexOf(f.SDP.M_LINE+f.STRING.VIDEO+" 1 ")&&-1===t.indexOf(f.SDP.M_LINE+f.STRING.VIDEO+" 9 ")||(o=n[i].split(" ")[1],t=t.replace(/m=video \d/,f.SDP.M_LINE+f.STRING.VIDEO+" "+o)):(o=n[i].split(" ")[1],t=t.replace(/m=audio \d/,f.SDP.M_LINE+f.STRING.AUDIO+" "+o));return t},this.getSdpFromObject=function(e){var t;return t=e.sdp},this.deleteGoogleIceFromSdp=function(e){return e=e.replace(/(a=ice-options:google-ice[\w\W]*?(:\r|\n))/g,"")},this.respondToRemoteSdpDirections=function(e,t){return e=this.respondToRemoteMediaSdpDirection(e,t,f.STRING.AUDIO),e=this.respondToRemoteMediaSdpDirection(e,t,f.STRING.VIDEO)},this.respondToRemoteMediaSdpDirection=function(e,t,n){var o;return this.isSdpHas(t,n)&&(o=this.getSdpDirection(t,n),o===f.WEBRTC.MEDIA_STATE.SEND_ONLY?(i.debug(n+" sendonly -> recvonly"),e=this.updateSdpDirection(e,n,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)):o===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY?(i.debug(n+" recvonly -> sendonly"),e=this.updateSdpDirection(e,n,f.WEBRTC.MEDIA_STATE.SEND_ONLY)):o===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE?(i.debug(n+" sendrecv -> sendrecv"),e=this.updateSdpDirection(e,n,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE)):o===f.WEBRTC.MEDIA_STATE.INACTIVE&&(i.debug(n+" inactive -> inactive"),e=this.updateSdpDirection(e,n,f.WEBRTC.MEDIA_STATE.INACTIVE))),e},this.hasCandidates=function(e,t,n){var i,o,r;return r=this.getCandidateType(t,n),this.isSdpHasAudio(e)?(i=e.split("m=audio"),-1===i[1].indexOf(r)?!1:!this.isSdpHasVideo(e)||this.isVideoSdpDirectionInactive(e)||this.isVideoSdpDirectionRecvonly(e)?!0:(o=e.split("m=video"),-1===o[1].indexOf(r)?!1:!0)):!1},this.getCandidateType=function(e,t){var n;return n=e&&t>=e?"relay":"a=candidate"},this.deleteFingerprintOrCrypto=function(e,t){return e?-1===e.indexOf("a=crypto:")||-1===e.indexOf("a=fingerprint:")?e:(e=this.deleteCryptoFromSdp(e,t),e=this.deleteFingerprintFromSdp(e,t)):e},this.addRtpmapForPCMU=function(e){return t(e,"0","a=rtpmap:0 PCMU/8000")},this.addRtpmapForPCMA=function(e){return t(e,"8","a=rtpmap:8 PCMA/8000")},this.deleteCurlyBracketsSDP=function(e){return i.debug("Deleting curly brackets from sdp"),e=e.replace(/(\{|\})/g,"")},this.deleteBandwidthLineFromSdp=function(e){return this.isVideoSdpDirectionInactive(e)&&(i.debug("Deleting b:AS line from SDP"),e=e.replace(/(b=AS:[\w\W]*?(:\r|\n))/g,"")),e},this.setOpusCodecToLowerCase=function(e){return i.debug("Setting OPUS codec to lower case"),e.replace("OPUS","opus")},this.replaceAudioMlineOfCodec=function(e,t,n){return this.isSdpHasAudio(e)&&(e=this.replaceMlineOfCodec(e,f.STRING.AUDIO,t,n)),e},this.replaceVideoMlineOfCodec=function(e,t,n){return this.isSdpHasVideo(e)&&(e=this.replaceMlineOfCodec(e,f.STRING.VIDEO,t,n)),e},this.replaceMlineOfCodec=function(e,t,n,i){var o,r,a,s="";for(r=new RegExp("m="+t+" [\\w\\W]*?(\\r|\\n)","g"),o=e.match(r),o=o[0].split(" "),a=0;a<o.length;a++)1!==a&&o[a]&&-1!==o[a].indexOf(n)&&(o[a]=o[a].replace(n,i)),s+=a===o.length-1?o[a]:o[a]+" ";return e.replace(r,s)},this.replaceRTPMapOfCodec=function(e,t,n){var i=new RegExp("a=rtpmap:"+t,"g");return e.replace(i,"a=rtpmap:"+n)},this.replaceRTCPOfCodec=function(e,t,n){var i=new RegExp("a=rtcp-fb:"+t,"g");return e.replace(i,"a=rtcp-fb:"+n)},this.replaceFMTPOfCodec=function(e,t,n){var i=new RegExp("a=fmtp:"+t,"g");return e.replace(i,"a=fmtp:"+n)},this.replaceCodecValue=function(e,t,n){var i,o;return i=this.getPayloadTypeOf(t,e),i&&(o="array"==typeof i?i[0]:i,e=this.replaceAudioMlineOfCodec(e,o,n),e=this.replaceVideoMlineOfCodec(e,o,n),e=this.replaceRTPMapOfCodec(e,o,n),e=this.replaceRTCPOfCodec(e,o,n),e=this.replaceFMTPOfCodec(e,o,n)),e},this.replaceCodecs=function(e,t){var n;if(t&&t.length)for(n=0;n<t.length;n++)e=this.replaceCodecValue(e,t[n].name,t[n].value);return e},this.removeH264Codec=function(e){i.debug("Removing H264 codec from SDP");var t,n;if(-1===e.indexOf("H264/90000"))return e;if(t=this.getH264PayloadType(e),-1!==t)for(n=0;n<t.length;n++)i.debug("removeH264Codec : Removing H264/90000 video codec "+t[n]),e=this.removeVideoCodec(e,t[n]);return e}},x=function(e){return new W(e||V)},H=new x;l&&(l.SDPParser=x);var B=function(e){var t="/rest/version/latest/isAlive";this.checkConnectivity=function(n,i){e.sendGetRequest({url:c()+t+"?"+U.getTimestamp()},n,i)}},G=function(e){return new B(e||I)},Y=new G,j=function(e,t,n){function i(){l.info("check connectivity timer is stopped."),clearInterval(d)}function o(){E||(E=!0,s(E),l.trace("Connectivity re-established..."),n.publish(f.EVENT.CONNECTION_REESTABLISHED))}function r(){E&&(E=!1,s(E),l.trace("Connectivity is lost..."),n.publish(f.EVENT.CONNECTION_LOST))}function a(){try{S()}catch(t){l.trace("Exception occured while executing connecitivy handler: ",t)}e.checkConnectivity(o,r)}function c(e){var t=p,n=e.connectivity?e.connectivity.handler:null,o=e.connectivity?e.connectivity.interval:null;n&&"function"==typeof n&&(S=n),o&&(t=o),i(),d=setInterval(a,t)}var d,l=t.getLogger("connectivityManager"),u=1,p=1e4,E=!0,S=null;n.subscribe(f.EVENT.DEVICE_SUBSCRIPTION_STARTED,c,u),n.subscribe(f.EVENT.DEVICE_SUBSCRIPTION_ENDED,i,u),n.subscribe(f.EVENT.XHR_REQUEST_NOT_INITIALIZED,r,u)},q=function(e,t,n){return new j(e||Y,t||V,n||p)},J=(new q,function(){var e,t,n,i,o,r=this,a=!1,s="",c={video:null,localVideo:null,remoteVideo:null,defaultVideo:null},d={audio:!1,video:!1},l={video:{available:!1,width:"320",height:"240"},audio:{available:!1},screen:{available:!1,width:"1024",height:"768",rate:15}},u=!1,p={},f=4,E=0,S=!1,T=!1,g=new U.Map;r.getLocalStreamMap=function(){return g},r.getUserMediaStream=function(){return i},r.setUserMediaStream=function(e){i=e},r.getScreenStream=function(){return o},r.setScreenStream=function(e){o=e},r.isH264Enabled=function(){return T},r.setH264Enabled=function(e){T=e===!0?!0:!1},r.getIceServerUrl=function(){return s},r.setIceServerUrl=function(e){s=e},r.isDtlsEnabled=function(){return a},r.setDtlsEnabled=function(e){a=e},r.getVideoContainer=function(){return c.video},r.setVideoContainer=function(e){c.video=e},r.getLocalVideoContainer=function(){return c.localVideo},r.setLocalVideoContainer=function(e){c.localVideo=e},r.getRemoteVideoContainer=function(){return c.remoteVideo},r.setRemoteVideoContainer=function(e){c.remoteVideo=e},r.getDefaultVideoContainer=function(){return c.defaultVideo},r.setDefaultVideoContainer=function(e){c.defaultVideo=e},r.isInitialized=function(){return u},r.setInitialized=function(e){u=e===!0?!0:!1},r.getRtcLibrary=function(){return p},r.setRtcLibrary=function(e){p=e},r.getLogLevel=function(){return f},r.setLogLevel=function(e){f=e},r.getLanguage=function(){return e},r.setLanguage=function(t){e=t},r.getMediaAudio=function(){return d.audio},r.setMediaAudio=function(e){d.audio=e},r.getMediaVideo=function(){return d.video},r.setMediaVideo=function(e){d.video=e},r.getVideoWidth=function(){return l.video.width},r.setVideoWidth=function(e){l.video.width=e},r.getVideoHeight=function(){return l.video.height},r.setVideoHeight=function(e){l.video.height=e},r.getVideoSourceAvailable=function(){return l.video.available},r.setVideoSourceAvailable=function(e){l.video.available=e},r.getAudioSourceAvailable=function(){return l.audio.available},r.setAudioSourceAvailable=function(e){l.audio.available=e},r.getScreenSourceAvailable=function(){return l.screen.available},r.setScreenSourceAvailable=function(e){l.screen.available=e},r.getScreenWidth=function(){return l.screen.width},r.setScreenWidth=function(e){l.screen.width=e},r.getScreenHeight=function(){return l.screen.height},r.setScreenHeight=function(e){l.screen.height=e},r.getScreenFrameRate=function(){return l.screen.rate},r.setScreenFrameRate=function(e){l.screen.rate=e},r.getPeerCount=function(){return E},r.setPeerCount=function(e){E=e},r.isPluginEnabled=function(){return S},r.setPluginEnabled=function(e){S=e},r.initAudioContext=function(){window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext,t=new window.AudioContext},r.getAudioContext=function(){return t},r.initMediaStreamDestination=function(){n=r.getAudioContext().createMediaStreamDestination()},r.getMediaStreamDestination=function(){return n}});l&&(l.WebRtcAdaptorModel=J);var K=function(){};K.prototype=new J,l&&(l.WebRtcChromeAdaptorModel=K);var z=function(){var e=this,t=!0;e.isH264Enabled=function(){return t},e.setH264Enabled=function(e){t=e===!0?!0:!1}};z.prototype=new J,l&&(l.WebRtcFirefoxAdaptorModel=z);var Q=function(){var e=this,t={major:0,minor:0,min_revision:0,min_build:0,current_revision:0,current_build:0};e.getPluginVersion=function(){return t},e.setPluginVersion=function(e){t=e}};Q.prototype=new J,l&&(l.WebRtcPluginAdaptorModel=Q);var Z=function(e,t){var n={};return n.getUserMedia=e.getUserMedia,n.showSettingsWindow=e.showSettingsWindow,n.getURLFromStream=e.getURLFromStream,n.enableH264=e.enableH264,n.createRTCSessionDescription=function(t,n){return e.createSessionDescription(t,n)},n.createRTCIceCandidate=function(t,n,i){return e.createIceCandidate(t,n,i)},n.createRTCPeerConnection=function(t,n){return e.createPeerConnection(t,n)},n.setLang=function(t){e.setLanguage(t||"en")},n.checkMediaSourceAvailability=function(t){U.callFunctionIfExist(t,{videoSourceAvailable:e.getVideoDeviceNames().length>0?!0:!1,audioSourceAvailable:e.getAudioOutDeviceNames().length>0?!0:!1,screenSourceAvailable:!1})},n.get_audioInDeviceCount=function(){return e.getAudioInDeviceNames().length},n.get_audioOutDeviceCount=function(){return e.getAudioOutDeviceNames().length},n.get_videoDeviceCount=function(){return e.getVideoDeviceNames().length},n.set_logSeverityLevel=function(t){return e.logSeverityLevel=t,!0},n.get_logSeverityLevel=function(){return e.logSeverityLevel},n.enable_logCallback=function(t){return e.logCallback=t,!0},n.disable_logCallback=function(){e.logCallback=null},n.setType=function(t){e.type=t},n.getType=function(){return e.type},n.getVersion=function(){return e.version},n.setH264CodecStateChangeHandler=function(t){e.onh264codecstatechange=t},n.getCurrentPluginVersionObject=function(){var t,n=e.version.split(".");return t={major:parseInt(n[0],10),minor:parseInt(n[1],10),revision:parseInt(n[2],10),build:parseInt(n[3],10)}},n},X=function(e,t){return Z(e||{},t)};l&&(l.webRtcLibraryDecorator=X);var $=function(e,t,n,i){t(e),e.getUserMedia=function(e,t,n){i.mozGetUserMedia(e,t,n)},e.getScreenMedia=function(e,t,n){U.callFunctionIfExist(n,E.call.MediaErrors.NO_SCREENSHARING_WARNING)},e.initScreenSharing=function(e,t){U.callFunctionIfExist(t,E.call.MediaErrors.NO_SCREENSHARING_WARNING)},e.showSettingsWindow=function(){},e.createRTCSessionDescription=function(e,t){return new n.mozRTCSessionDescription({type:e,sdp:t})},e.createRTCIceCandidate=function(e){return new n.mozRTCIceCandidate(e)},e.getURLFromStream=function(e){return n.URL.createObjectURL(e)},e.createRTCPeerConnection=function(e,t){return new n.mozRTCPeerConnection(e,t)},e.checkMediaSourceAvailability=function(e){var t=!0,n=!0;U.callFunctionIfExist(e,{videoSourceAvailable:t,audioSourceAvailable:n,screenSourceAvailable:!1})},e.get_audioInDeviceCount=function(){return 1},e.get_audioOutDeviceCount=function(){return 1},e.get_videoDeviceCount=function(){return 1},e.set_logSeverityLevel=function(){return!1},e.get_logSeverityLevel=function(){},e.enable_logCallback=function(){},e.disable_logCallback=function(){}},ee=function(e,t,n,i){$(e||{},t||X,n||window,i||navigator)};l&&(l.webRtcLibraryFirefoxDecorator=ee);var te=function(e,t,n,i){var o,r=!1;t(e),e.getUserMedia=function(e,t,n){i.webkitGetUserMedia(e,t,n)},e.getScreenMedia=function(t,n,i){var a=function(o){o&&o.mediaSourceId?(t.audio=!1,t.video.mandatory.chromeMediaSource="desktop",t.video.mandatory.chromeMediaSourceId=o.mediaSourceId,e.getUserMedia(t,n,i)):U.callFunctionIfExist(i)};r&&window.chrome.runtime.sendMessage(o,{message:"chooseDesktopMedia"},a)},e.initScreenSharing=function(e,t,n){var i=n.screenSharing;if(i&&i.chromeExtensionId){o=i.chromeExtensionId;try{window.chrome.runtime.sendMessage(o,{message:"version"},function(n){n&&n.version?(r=!0,U.callFunctionIfExist(e)):U.callFunctionIfExist(t,E.call.MediaErrors.NO_SCREENSHARING_WARNING)})}catch(a){U.callFunctionIfExist(t,E.call.MediaErrors.NO_SCREENSHARING_WARNING)}}else U.callFunctionIfExist(e)},e.showSettingsWindow=function(){},e.createRTCSessionDescription=function(e,t){return new n.RTCSessionDescription({type:e,sdp:t})},e.createRTCIceCandidate=function(e){return new n.RTCIceCandidate(e)},e.getURLFromStream=function(e){return n.URL.createObjectURL(e)},e.createRTCPeerConnection=function(e,t){return new n.webkitRTCPeerConnection(e,t)},e.checkMediaSourceAvailability=function(e){var t,i,o,a;i=n.MediaStreamTrack,"undefined"!=typeof i&&i.getSources(function(n){for(t=0;t<n.length;t++)"video"===n[t].kind?o=!0:"audio"===n[t].kind&&(a=!0);U.callFunctionIfExist(e,{videoSourceAvailable:o,audioSourceAvailable:a,screenSourceAvailable:r})})},e.get_audioInDeviceCount=function(){return 1},e.get_audioOutDeviceCount=function(){return 1},e.get_videoDeviceCount=function(){return 1},e.set_logSeverityLevel=function(){return!1},e.get_logSeverityLevel=function(){},e.enable_logCallback=function(){},e.disable_logCallback=function(){}},ne=function(e,t,n,i){te(e||{},t||X,n||window,i||navigator)};l&&(l.webRtcLibraryChromeDecorator=ne);var ie=function(e,t,n,i){function o(e){e&&e.getTracks?e.getTracks().forEach(function(e){e.stop()}):e&&e.stop&&e.stop()}function r(e){e.stream&&(s.info("stopping local media "+e.stream.id),a.getLocalStreamMap().remove(e.stream.id),e.audioContext.close(),e.mediaStreamDestination.disconnect(),o(e.stream),e.stream=null,e.audioContext=null,e.mediaStreamDestination=null)}var a=this,s=i.getLogger("WebRtcAdaptorImpl"),c="0";s.debug("WebRtcAdaptor initializing"),U.compose(n,a),a.storeStableRemoteAndLocalSdpInCall=function(e){e&&e.peer&&e.peer.signalingState===f.WEBRTC.RTC_SIGNALING_STATE.STABLE&&(e.stableRemoteSdp=e.peer.remoteDescription.sdp,e.stableLocalSdp=e.peer.localDescription.sdp)},a.performSdpWorkaroundsAfterCreateOffer=function(e,t){return t.sdp=H.replaceCodecs(t.sdp,e.codecsToReplace?e.codecsToReplace:v.codecsToReplace),t},a.overrideConfiguredCodecValues=function(e,t){var n,i;if(e.codecsToReplace=e.codecsToReplace?e.codecsToReplace:JSON.parse(JSON.stringify(v.codecsToReplace)),e.codecsToReplace)for(n=0;n<e.codecsToReplace.length;n++)i=H.getPayloadTypeOf(e.codecsToReplace[n].name,t),i&&-1!==i&&("array"==typeof i&&(i=i[0]),e.codecsToReplace[n].value=i)},a.addLocalStream=function(e){var t,n=!1,i=a.canOriginatorSendLocalVideo(e);e.localMedia.stream&&(i?(t=a.getRtcLibrary().getURLFromStream(e.localMedia.stream),t&&(a.getDefaultVideoContainer()?n=a.useDefaultRenderer(t,!0,!0):a.getLocalVideoContainer()?n=a.createStreamRenderer(t,a.getLocalVideoContainer(),{muted:!0}):(e.call.localStreamURL=t,n=!0))):a.getDefaultVideoContainer()?a.getDefaultVideoContainer().lastElementChild&&a.disposeStreamRenderer(a.getDefaultVideoContainer().lastElementChild):a.getLocalVideoContainer()&&a.disposeStreamRenderer(a.getLocalVideoContainer()),s.debug("onLocalStreamAdded: "+t),n&&a.fireOnLocalStreamAddedEvent(e,t))},a.fireOnLocalStreamAddedEvent=function(e,t){e&&e.call&&e.call.onLocalStreamAdded&&U.callFunctionIfExist(e.call.onLocalStreamAdded,t)},a.storeLocalStreamToCall=function(e,t){s.debug("assigning local stream ["+t+"] to call: "+e.id),e.localMedia=a.getLocalStreamMap().get(t)},a.performSdpWorkaroundsBeforeProcessingIncomingSdp=function(e){e.sdp=H.deleteBandwidthLineFromSdp(e.sdp),e.sdp=H.removeG722Codec(e.sdp),e.sdp=H.fixRemoteTelephoneEventPayloadType(e,e.sdp)},a.createReOffer=function(e,t,n,i){var o,r,c,d=e.peer,l=e.peer.localDescription.sdp;s.debug("createReOffer:"+e.id),a.createNewPeerForCall(e)&&(d=e.peer),d.createOffer(function(t){c=H.getVideoSdpDirection(l),t.sdp=H.updateVideoSdpDirection(t.sdp,c),i&&(r=H.getAudioSdpDirection(l),t.sdp=H.updateAudioSdpDirection(t.sdp,r)),t.sdp=H.deleteCryptoZeroFromSdp(t.sdp),t.sdp=H.updateAudioCodec(t.sdp),t.sdp=H.removeG722Codec(t.sdp),t.sdp=H.deleteCryptoFromSdp(t.sdp,a.isDtlsEnabled()),t.sdp=H.setTcpSetupAttributeToActpass(t.sdp,a.isDtlsEnabled()),t.sdp=H.fixLocalTelephoneEventPayloadType(e,t.sdp),t.sdp=H.updateVersion(l,t.sdp),t=a.performSdpWorkaroundsAfterCreateOffer(e,t),o=a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,t.sdp),
d.setLocalDescription(o,function(){s.debug("createReOffer: setLocalDescription success"+e.id)},function(t){s.debug("createReOffer: setLocalDescription failed!!"+t+e.id),U.callFunctionIfExist(n)})},function(e){s.error("createReOffer: createOffer failed!! "+e),U.callFunctionIfExist(n)},{mandatory:{OfferToReceiveAudio:a.getMediaAudio(),OfferToReceiveVideo:a.getMediaVideo()}})},a.getLocalAudioTrack=function(e){s.debug("getLocalAudioTrack");var t;if(e.localStreams&&e.localStreams[c].audioTracks){if(e.localStreams[c].audioTracks.length>0)return e.localStreams[c].audioTracks[c]}else if(e.getLocalStreams&&(t=e.getLocalStreams()[c].getAudioTracks(),t&&t.length>0))return t[c];return null},a.getLocalVideoTrack=function(e){s.debug("getLocalVideoTrack");var t;if(e.localStreams&&e.localStreams[c].videoTracks){if(e.localStreams[c].videoTracks.length>0)return e.localStreams[c].videoTracks[c]}else if(e.getLocalStreams&&(t=e.getLocalStreams(),t&&t[c].getVideoTracks()&&t[c].getVideoTracks().length>0))return t[c].getVideoTracks()[c];return null},a.muteAudioTrack=function(e,t){var n;return a.isInitialized()?void(e.peer&&(n=a.getLocalAudioTrack(e.peer),n&&(s.info("mute Audio Track ["+n.id+"], call ["+e.id+"] mute="+t),n.enabled=!t,e.audioMuted=t))):void s.warn("muteAudioTrack: Plugin is not installed")},a.muteVideoTrack=function(e,t){var n;return a.isInitialized()?void(e.peer&&(n=a.getLocalVideoTrack(e.peer),n&&(s.info("mute Video Track ["+n.id+"], call ["+e.id+"] mute="+t),n.enabled=!t,e.videoMuted=t))):void s.warn("muteVideoTrack: Plugin is not installed")},a.muteOnHold=function(e,t){a.muteAudioTrack(e,t),a.muteVideoTrack(e,t)},a.setMediaSources=function(e){e&&(a.setVideoSourceAvailable(e.videoSourceAvailable),a.setAudioSourceAvailable(e.audioSourceAvailable),a.setScreenSourceAvailable(e.screenSourceAvailable))},a.initMedia=function(e,n,i){function o(){a.getRtcLibrary().checkMediaSourceAvailability(function(e){a.setMediaSources(e)})}a.setInitialized(!0),t(a.getRtcLibrary()),i&&(i.localVideoContainer&&a.setLocalVideoContainer(i.localVideoContainer),i.remoteVideoContainer&&a.setRemoteVideoContainer(i.remoteVideoContainer),i.videoContainer&&a.setDefaultVideoContainer(i.videoContainer)),a.getRtcLibrary().initScreenSharing(function(){o(),U.callFunctionIfExist(e)},function(e){o(),U.callFunctionIfExist(n,e)},i)},a.performVideoStartWorkaround=function(e,t,n){var i,o,r,c=e.peer;s.debug("Workaround to play video"),e.sdp=H.addSdpMissingCryptoLine(e.sdp),i=H.getAudioSdpDirection(e.sdp),o=H.getVideoSdpDirection(e.sdp),e.sdp=H.updateAudioSdpDirectionToInactive(e.sdp),e.sdp=H.updateVideoSdpDirectionToInactive(e.sdp),e.sdp=H.setTcpSetupAttributeToActpass(e.sdp,a.isDtlsEnabled()),r=H.deleteSsrcFromSdp(e.sdp),c.setRemoteDescription(a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,r),function(){s.debug("performVideoStartWorkaround: first setRemoteDescription success"),e.sdp=H.updateAudioSdpDirection(e.sdp,i),e.sdp=H.updateVideoSdpDirection(e.sdp,o),c.setRemoteDescription(a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),function(){s.debug("performVideoStartWorkaround: second setRemoteDescription success"),c.createAnswer(function(r){i===f.WEBRTC.MEDIA_STATE.INACTIVE&&(r.sdp=H.updateAudioSdpDirectionToInactive(r.sdp)),o===f.WEBRTC.MEDIA_STATE.INACTIVE?r.sdp=H.updateVideoSdpDirectionToInactive(r.sdp):a.canOriginatorSendLocalVideo(e)?r.sdp=H.updateVideoSdpDirection(r.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):r.sdp=H.updateVideoSdpDirection(r.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),r.sdp=H.checkAndRestoreICEParams(r.sdp,e.sdp),r.sdp=H.setTcpSetupAttributeTo(r.sdp,e.localTcpSetupAttribute,a.isDtlsEnabled()),r.sdp=H.fixLocalTelephoneEventPayloadType(e,r.sdp),c.setLocalDescription(a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,r.sdp),function(){s.debug("performVideoStartWorkaround: setlocalDescription success"),U.callFunctionIfExist(t)},function(e){s.debug("performVideoStartWorkaround: setlocalDescription failed!!"+e),U.callFunctionIfExist(n,"performVideoStartWorkaround: setlocalDescription failed!!")})},function(e){s.debug("performVideoStartWorkaround: createAnswer failed!! "+e),U.callFunctionIfExist(n,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:a.getMediaAudio(),OfferToReceiveVideo:a.getMediaVideo()}})},function(e){s.debug("performVideoStartWorkaround: second setRemoteDescription failed!!"+e),U.callFunctionIfExist(n,"performVideoStartWorkaround: second setRemoteDescription failed!!")})},function(e){s.debug("performVideoStartWorkaround: first setRemoteDescription failed!!"+e),U.callFunctionIfExist(n,"performVideoStartWorkaround: first setRemoteDescription failed!!")})},a.getUserMedia=function(e,t){a.getRtcLibrary().checkMediaSourceAvailability(function(n){var i;a.setMediaSources(n),i=a.getMediaVideo()&&a.getVideoSourceAvailable()?{mandatory:{maxWidth:a.getVideoWidth(),maxHeight:a.getVideoHeight(),minWidth:a.getVideoWidth(),minHeight:a.getVideoHeight()}}:!1,a.getRtcLibrary().getUserMedia({audio:a.getMediaAudio(),video:i},function(t){var n,i,o={};a.initAudioContext(),i=a.getAudioContext().createMediaStreamSource(t),a.initMediaStreamDestination(),i.connect(a.getMediaStreamDestination()),t.getVideoTracks()&&t.getVideoTracks()[c]&&a.getMediaStreamDestination().stream.addTrack(t.getVideoTracks()[c]),a.setUserMediaStream(t),o.audioContext=a.getAudioContext(),o.mediaStreamDestination=a.getMediaStreamDestination(),o.stream=a.getMediaStreamDestination().stream,a.getLocalStreamMap().add(o.stream.id,o),a.setInitialized(!0),n={audio:a.getMediaAudio(),video:a.getMediaVideo(),id:o.stream.id},s.debug("user hcreateOfferas granted access to local media: ",o),U.callFunctionIfExist(e,n)},function(e){s.debug("Failed to get access to local media. Error code was "+e.code),U.callFunctionIfExist(t,E.call.MediaErrors.NOT_ALLOWED)})})},a.replaceVideoStream=function(e){var t,n,i,o=a.getMediaStreamDestination(),r=0;if(o&&(t=o.stream)){for(n=t.id,i=t.getVideoTracks();r<i.length;++r)t.removeTrack(i[r]);e&&e.getVideoTracks()&&e.getVideoTracks()[c]&&t.addTrack(e.getVideoTracks()[c])}return{audio:a.getMediaAudio(),video:a.getMediaVideo(),id:n}},a.startScreenMedia=function(e,t,n){a.getRtcLibrary().checkMediaSourceAvailability(function(i){var r;a.setMediaSources(i),a.getScreenSourceAvailable()?(r={mandatory:{maxFrameRate:a.getScreenFrameRate(),maxWidth:a.getScreenWidth(),maxHeight:a.getScreenHeight()}},a.getRtcLibrary().getScreenMedia({video:r},function(t){var i=a.replaceVideoStream(t),r=a.getScreenStream();r&&(r.onended=null,o(r)),t.onended=n,a.setScreenStream(t),s.debug("user granted access to local media."),U.callFunctionIfExist(e,i)},function(){s.debug("Failed to get access to screen media."),U.callFunctionIfExist(t,E.call.MediaErrors.NOT_ALLOWED)},n)):U.callFunctionIfExist(t,E.call.MediaErrors.NOT_FOUND)})},a.stopScreenMedia=function(){var e=a.getScreenStream();a.replaceVideoStream(a.getUserMediaStream()),e&&(o(e),a.setScreenStream(null))},a.createOffer=function(e,t,n,i){s.debug("createOffer: sendInitialVideo= "+i+" state= "+e.peer.signalingState);var o=e.peer;e.peer.addStream(e.localMedia.stream),a.addCallIdInPluginContainer(e),o.createOffer(function(t){i=i&&a.getVideoSourceAvailable(),i?t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),t.sdp=H.deleteCryptoZeroFromSdp(t.sdp),t.sdp=H.updateAudioCodec(t.sdp),t.sdp=H.removeG722Codec(t.sdp),t.sdp=H.deleteCryptoFromSdp(t.sdp,a.isDtlsEnabled()),t.sdp=H.setTcpSetupAttributeToActpass(t.sdp,a.isDtlsEnabled()),t.sdp=H.fixLocalTelephoneEventPayloadType(e,t.sdp),t=a.performSdpWorkaroundsAfterCreateOffer(e,t),o.setLocalDescription(a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,t.sdp),function(){},function(e){s.error("createOffer: setLocalDescription failed : "+e),U.callFunctionIfExist(n,"createOffer: setLocalDescription failed")})},function(e){s.error("createOffer: createOffer failed!! "+e),U.callFunctionIfExist(n)},{mandatory:{OfferToReceiveAudio:a.getMediaAudio(),OfferToReceiveVideo:a.getMediaVideo()}})},a.createAnswer=function(e,t,n,i){s.debug("createAnswer: isVideoEnabled= "+i+" state= "+e.peer.signalingState);var o=e.peer;e.peer.addStream(e.localMedia.stream),e.sdp=H.checkSupportedVideoCodecs(e.sdp,null,a.isH264Enabled()),e.sdp=H.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.INACTIVE,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.AUDIO),e.sdp=H.deleteFingerprintOrCrypto(e.sdp,a.isDtlsEnabled()),a.addCallIdInPluginContainer(e),H.isSdpVideoSendEnabled(e.sdp)||(e.sdp=H.deleteInactiveVideoSsrc(e.sdp)),o.setRemoteDescription(a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),function(){e.remoteVideoState=H.getSdpDirection(e.sdp,f.STRING.VIDEO),o.createAnswer(function(t){i=i&&a.getVideoSourceAvailable()&&H.isSdpHasVideo(e.sdp),i?H.isSdpVideoSendEnabled(e.sdp)?t.sdp=H.updateSdpDirection(t.sdp,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):H.getVideoSdpDirection(e.sdp)!==f.WEBRTC.MEDIA_STATE.INACTIVE?t.sdp=H.updateSdpDirection(t.sdp,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.SEND_ONLY):t.sdp=H.updateSdpDirection(t.sdp,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.INACTIVE):H.isSdpVideoSendEnabled(e.sdp)?t.sdp=H.updateSdpDirection(t.sdp,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY):t.sdp=H.updateSdpDirection(t.sdp,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.INACTIVE),a.muteOnHold(e,!1),t.sdp=H.fixLocalTelephoneEventPayloadType(e,t.sdp),t.sdp=H.checkAndRestoreICEParams(t.sdp,e.sdp),o.setLocalDescription(a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,t.sdp),function(){e.videoOfferSent=H.isSdpHasVideo(t.sdp),a.setTcpSetupAttiributesOnCreateAnswer(e,t.sdp)},function(e){s.error("createAnswer: setLocalDescription failed : "+e),U.callFunctionIfExist(n,"createNativeAnswer setLocalDescription failed")})},function(e){s.error("createAnswer: failed!! Error: "+e),U.callFunctionIfExist(n,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:a.getMediaAudio(),OfferToReceiveVideo:a.getMediaVideo()}})},function(e){s.error("createAnswer: setremotedescription failed!! Error: "+e)})},a.createUpdate=function(e,t,n,i){s.debug("createUpdate: isVideoStart= "+i+" state= "+e.peer.signalingState);var o,r,c=e.peer;o=e.peer.localDescription.sdp,o=H.fixLocalTelephoneEventPayloadType(e,o),o=H.incrementVersion(o),s.debug("create new offer to start the video"),a.createNewPeerForCall(e)&&(c=e.peer),a.setMediaVideo(!0),c.createOffer(function(t){i=i&&a.getVideoSourceAvailable(),i?t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):H.isVideoSdpDirectionInactive(e.stableRemoteSdp)?t.sdp=H.updateVideoSdpDirectionToInactive(t.sdp):t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),t.sdp=H.setTcpSetupAttributeToActpass(t.sdp,a.isDtlsEnabled()),t.sdp=H.fixLocalTelephoneEventPayloadType(e,t.sdp),t.sdp=H.deleteCryptoZeroFromSdp(t.sdp),t.sdp=H.updateAudioCodec(t.sdp),t.sdp=H.removeG722Codec(t.sdp),t.sdp=H.deleteCryptoFromSdp(t.sdp,a.isDtlsEnabled()),t=a.performSdpWorkaroundsAfterCreateOffer(e,t),r=a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,t.sdp),c.setLocalDescription(r,function(){s.debug("createUpdate: createOffer setLocalDescription success ")},function(e){s.debug("createUpdate: createOffer setLocalDescription failed: "+e),U.callFunctionIfExist(n)})},function(e){s.debug("createUpdate: createOffer failed!!: "+e),n()},{mandatory:{OfferToReceiveAudio:a.getMediaAudio(),OfferToReceiveVideo:a.getMediaVideo()}})},a.revertRtcState=function(e,t,n){var i,o=e.peer,r=e.stableLocalSdp,c=e.stableRemoteSdp,d=o.signalingState;switch(c=H.deleteGoogleIceFromSdp(c),d){case f.WEBRTC.RTC_SIGNALING_STATE.STABLE:case f.WEBRTC.RTC_SIGNALING_STATE.HAVE_LOCAL_OFFER:r=H.setTcpSetupAttributeToActpass(r,a.isDtlsEnabled()),i=a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,r),o.setLocalDescription(i,function(){s.debug("revertRtcState[stable|local_offer]: setLocalDescription success"),c=H.setTcpSetupAttributeTo(c,e.remoteTcpSetupAttribute,a.isDtlsEnabled()),i=a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,c),o.setRemoteDescription(i,function(){s.debug("revertRtcState[stable|local_offer]: setRemoteDescription success"),U.callFunctionIfExist(t,e)},function(t){s.error("revertRtcState[stable|local_offer]: setRemoteDescription failed: "+t),U.callFunctionIfExist(n,e)})},function(t){s.error("revertRtcState[stable|local_offer]: setLocalDescription failed: "+t),U.callFunctionIfExist(n,e)});break;case f.WEBRTC.RTC_SIGNALING_STATE.HAVE_REMOTE_OFFER:c=H.setTcpSetupAttributeToActpass(c,a.isDtlsEnabled()),i=a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,c),o.setRemoteDescription(i,function(){s.debug("revertRtcState[remote_offer]: setLocalDescription success"),r=H.setTcpSetupAttributeTo(r,e.localTcpSetupAttribute,a.isDtlsEnabled()),i=a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,r),o.setLocalDescription(i,function(){s.debug("revertRtcState[remote_offer]: setRemoteDescription success"),U.callFunctionIfExist(t,e)},function(t){s.error("revertRtcState[remote_offer]: setRemoteDescription failed: "+t),U.callFunctionIfExist(n,e)})},function(t){s.error("revertRtcState[remote_offer]: setLocalDescription failed: "+t),U.callFunctionIfExist(n,e)});break;default:s.debug("revertRtcState: not applicible for state: "+d)}},a.createHoldUpdate=function(e,t,n,i,o){s.debug("createHoldUpdate: local hold= "+t+" remote hold= "+n+" state= "+e.peer.signalingState);var r,c,d,l,u=e.peer;r=H.getAudioSdpDirection(u.localDescription.sdp),c=H.getVideoSdpDirection(u.localDescription.sdp),a.createNewPeerForCall(e)&&(u=e.peer),u.createOffer(function(i){i.sdp=H.incrementVersion(i.sdp),i.sdp=H.deleteCryptoZeroFromSdp(i.sdp),i.sdp=H.setTcpSetupAttributeToActpass(i.sdp,a.isDtlsEnabled()),i=a.performSdpWorkaroundsAfterCreateOffer(e,i),t||n?(r===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE?i.sdp=H.updateAudioSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY):!t&&n?i.sdp=H.updateAudioSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):i.sdp=H.updateAudioSdpDirectionToInactive(i.sdp),c===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE?i.sdp=H.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY):!t&&n?i.sdp=H.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):i.sdp=H.updateVideoSdpDirectionToInactive(i.sdp),d=!0):(i.sdp=H.updateAudioSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE),a.canOriginatorSendLocalVideo(e)?i.sdp=H.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):i.sdp=H.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),d=!1),i.sdp=H.fixLocalTelephoneEventPayloadType(e,i.sdp),l=a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,i.sdp),u.setLocalDescription(l,function(){s.debug("createHoldUpdate: setLocalDescription success"),a.muteOnHold(e,d)},function(e){s.error("createHoldUpdate: setLocalDescription failed: "+e.message),U.callFunctionIfExist(o)})},function(e){s.error("createHoldUpdate: createOffer failed: "+e.message),U.callFunctionIfExist(o)},{mandatory:{OfferToReceiveAudio:a.getMediaAudio(),OfferToReceiveVideo:a.getMediaVideo()}})},a.processHold=function(e,t,n,i,o){s.debug("processHold: local hold= "+n+" remote hold= "+t+" state= "+e.peer.signalingState);var r,c,d,l,u,p,E=e.peer;n||t||a.muteOnHold(e,!1),e.sdp=H.checkSupportedVideoCodecs(e.sdp,null,a.isH264Enabled()),e.sdp=H.performVideoPortZeroWorkaround(e.sdp),e.sdp=H.checkAndRestoreICEParams(e.sdp,e.peer.localDescription.sdp),c=H.getAudioSdpDirection(e.sdp),d=H.getVideoSdpDirection(e.sdp),l=e.prevRemoteSdp,u=E.localDescription.sdp,r=a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),p=a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,r.sdp),p.sdp=H.updateAudioSdpDirectionToInactive(p.sdp),p.sdp=H.updateVideoSdpDirectionToInactive(p.sdp),a.createNewPeerForCall(e)&&(E=e.peer),p.sdp=H.deleteSsrcFromSdp(p.sdp),E.setRemoteDescription(p,function(){r.sdp=H.updateAudioSdpDirection(r.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE),(H.getVideoSdpDirection(r.sdp)===f.WEBRTC.MEDIA_STATE.INACTIVE||H.getVideoSdpDirection(r.sdp)===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)&&(r.sdp=H.deleteInactiveVideoSsrc(r.sdp)),E.setRemoteDescription(r,function(){t||n||d!==f.WEBRTC.MEDIA_STATE.INACTIVE?e.remoteVideoState=H.getVideoSdpDirection(r.sdp):e.remoteVideoState=f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,E.createAnswer(function(i){s.debug("processHold: isSdpEnabled audio= "+H.isAudioSdpEnabled(i.sdp)),s.debug("processHold: isSdpEnabled video= "+H.isVideoSdpEnabled(i.sdp)),t?(s.debug("processHold: Remote HOLD"),i.sdp=H.respondToRemoteSdpDirections(i.sdp,e.sdp)):n?n&&!t&&(s.debug("processHold: Remote UNHOLD on local hold"),c===f.WEBRTC.MEDIA_STATE.INACTIVE?i.sdp=H.updateAudioSdpDirectionToInactive(i.sdp):i.sdp=H.updateAudioSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY),a.canOriginatorSendLocalVideo(e)?i.sdp=H.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY):i.sdp=H.updateVideoSdpDirectionToInactive(i.sdp)):(s.debug("processHold: Remote UNHOLD: direction left as it is"),H.isSdpVideoSendEnabled(e.sdp)?a.canOriginatorSendLocalVideo(e)?i.sdp=H.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):i.sdp=H.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY):a.canOriginatorSendLocalVideo(e)&&!H.isVideoSdpDirectionInactive(e.sdp)?i.sdp=H.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY):i.sdp=H.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.INACTIVE),i.sdp=H.changeDirection(i.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.AUDIO)),i.sdp=H.updateVersion(u,i.sdp),i.sdp=H.checkIceParamsLengths(i.sdp,r.sdp),i.sdp=H.fixLocalTelephoneEventPayloadType(e,i.sdp),i.sdp=H.setTcpSetupAttributeTo(i.sdp,e.localTcpSetupAttribute,a.isDtlsEnabled()),E.setLocalDescription(i,function(){s.debug("processHold: setLocalDescription success!! ")},function(e){s.error("processHold: setLocalDescription failed!! "+e),U.callFunctionIfExist(o,"Session cannot be created")})},function(e){s.error("processHold: createAnswer failed!!: "+e),U.callFunctionIfExist(o,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:a.getMediaAudio(),OfferToReceiveVideo:a.getMediaVideo()}})},function(e){s.error("processHold: second setRemoteDescription failed!! "+e),U.callFunctionIfExist(o,"Session cannot be created")})},function(e){s.debug("processHold: first setRemoteDescription failed!! "+e),U.callFunctionIfExist(o,"Session cannot be created")})},a.processUpdate=function(e,t,n,i){s.debug("processUpdate: state= "+e.peer.signalingState);var o,r,c,d,l,u,p,E,S,T=e.peer;if(e.sdp=H.addSdpMissingCryptoLine(e.sdp),e.sdp=H.checkAndRestoreICEParams(e.sdp,e.peer.localDescription.sdp),c=H.getVideoSdpDirection(e.sdp),d=H.getVideoSdpDirection(T.localDescription.sdp),a.setMediaVideo(H.isSdpHasVideo(e.sdp)),c===f.WEBRTC.MEDIA_STATE.INACTIVE&&"COMPLETED"===e.currentState)switch(e.remoteVideoState){case f.WEBRTC.MEDIA_STATE.INACTIVE:e.sdp=H.updateVideoSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE);break;case f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY:e.sdp=H.updateVideoSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE);break;case f.WEBRTC.MEDIA_STATE.SEND_RECEIVE:e.sdp=H.updateVideoSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)}e.sdp=H.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.VIDEO),e.sdp=H.checkSupportedVideoCodecs(e.sdp,null,a.isH264Enabled()),o=H.getAudioSdpDirection(e.sdp),r=H.getVideoSdpDirection(e.sdp),e.sdp=H.setTcpSetupAttributeToActpass(e.sdp,a.isDtlsEnabled()),(r===f.WEBRTC.MEDIA_STATE.INACTIVE||r===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)&&(e.sdp=H.deleteInactiveVideoSsrc(e.sdp)),E=a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.prevRemoteSdp),S=T.localDescription.sdp,a.createNewPeerForCall(e)&&(T=e.peer),H.isSdpHas(e.prevRemoteSdp,f.STRING.VIDEO)||H.isIceLite(e.sdp)||i?(e.sdp=H.updateAudioSdpDirectionToInactive(e.sdp),e.sdp=H.updateVideoSdpDirectionToInactive(e.sdp),l=H.deleteSsrcFromSdp(e.sdp),u=a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,l),T.setRemoteDescription(u,function(){s.debug("processUpdate: workaround setRemoteDescription success"),e.sdp=H.updateAudioSdpDirection(e.sdp,o),e.sdp=H.updateVideoSdpDirection(e.sdp,r),u=a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),T.setRemoteDescription(u,function(){s.debug("processUpdate: setRemoteDescription success"),e.remoteVideoState=H.getVideoSdpDirection(e.sdp),T.createAnswer(function(t){s.debug("processUpdate: isSdpEnabled audio= "+H.isAudioSdpEnabled(t.sdp)),s.debug("processUpdate: isSdpEnabled video= "+H.isVideoSdpEnabled(t.sdp)),H.isSdpVideoSendEnabled(e.sdp)?a.canOriginatorSendLocalVideo(e)?t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY):a.canOriginatorSendLocalVideo(e)&&!H.isVideoSdpDirectionInactive(e.sdp)?t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY):t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.INACTIVE),t.sdp=H.updateVersion(S,t.sdp),t.sdp=H.fixLocalTelephoneEventPayloadType(e,t.sdp),t.sdp=H.checkIceParamsLengths(t.sdp,u.sdp),t.sdp=H.setTcpSetupAttributeTo(t.sdp,e.localTcpSetupAttribute,a.isDtlsEnabled()),p=a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,t.sdp),T.setLocalDescription(p,function(){s.debug("processUpdate: setlocalDescription success")},function(e){s.debug("processUpdate: setlocalDescription failed!!"+e),U.callFunctionIfExist(n,"processUpdate: setlocalDescription failed!!")})},function(e){s.debug("processUpdate: createAnswer failed!! "+e),U.callFunctionIfExist(n,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:a.getMediaAudio(),OfferToReceiveVideo:a.getMediaVideo()}})},function(e){s.debug("processUpdate: setRemoteDescription failed!!"+e),U.callFunctionIfExist(n,"processUpdate: setRemoteDescription failed!!")})},function(e){s.debug("processUpdate: workaround setRemoteDescription failed!!"+e),U.callFunctionIfExist(n,"processUpdate: workaround setRemoteDescription failed!!")})):(u=a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),T.setRemoteDescription(u,function(){s.debug("processUpdate: setRemoteDescription success"),e.remoteVideoState=H.getVideoSdpDirection(e.sdp),T.createAnswer(function(t){s.debug("processUpdate: isSdpEnabled audio= "+H.isAudioSdpEnabled(t.sdp)),s.debug("processUpdate: isSdpEnabled video= "+H.isVideoSdpEnabled(t.sdp)),H.isSdpVideoSendEnabled(e.sdp)?a.canOriginatorSendLocalVideo(e)?t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY):a.canOriginatorSendLocalVideo(e)&&!H.isVideoSdpDirectionInactive(e.sdp)?t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY):t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.INACTIVE),t.sdp=H.updateVersion(S,t.sdp),t.sdp=H.fixLocalTelephoneEventPayloadType(e,t.sdp),t.sdp=H.checkIceParamsLengths(t.sdp,u.sdp),t.sdp=H.setTcpSetupAttributeTo(t.sdp,e.localTcpSetupAttribute,a.isDtlsEnabled()),p=a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,t.sdp),T.setLocalDescription(p,function(){s.debug("processUpdate: setlocalDescription success")},function(e){s.debug("processUpdate: setlocalDescription failed!!"+e),U.callFunctionIfExist(n,"processUpdate: setlocalDescription failed!!")})},function(e){s.debug("processUpdate: createAnswer failed!! "+e),U.callFunctionIfExist(n,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:a.getMediaAudio(),OfferToReceiveVideo:a.getMediaVideo()}})},function(e){s.debug("processUpdate: setRemoteDescription failed!!"+e),U.callFunctionIfExist(n,"processUpdate: setRemoteDescription failed!!")}))},a.processAnswer=function(e,t,n){s.debug("processAnswer: state= "+e.peer.signalingState);var i,o,r,c,d=e.peer;i=function(){e.remoteVideoState=H.getVideoSdpDirection(e.sdp),e.videoOfferSent=H.isSdpHasVideo(e.sdp),U.callFunctionIfExist(t)},o=function(e,t,n){e.peer.setRemoteDescription(a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),function(){s.debug("processAnswer: setRemoteDescription success"),t()},function(e){s.debug("processAnswer: setRemoteDescription failed: "+e),n()})},a.setTcpSetupAttiributesOnProcessAnswer(e,e.sdp),e.sdp=H.checkSupportedVideoCodecs(e.sdp,d.localDescription.sdp,a.isH264Enabled()),e.sdp=H.performVideoPortZeroWorkaround(e.sdp),r=H.getVideoSdpDirection(e.sdp),c=H.getVideoSdpDirection(e.peer.localDescription.sdp),s.debug("processAnswer: ice-lite: do remote video escalation"),e.sdp=H.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE),(c!==f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY||r!==f.WEBRTC.MEDIA_STATE.INACTIVE&&r!==f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)&&(c!==f.WEBRTC.MEDIA_STATE.SEND_RECEIVE||r!==f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY&&r!==f.WEBRTC.MEDIA_STATE.INACTIVE)?c!==f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY||r!==f.WEBRTC.MEDIA_STATE.SEND_ONLY&&r!==f.WEBRTC.MEDIA_STATE.SEND_RECEIVE?o(e,i,n):o(e,function(){a.performVideoStartWorkaround(e,i,n)},n):(e.sdp=H.deleteInactiveVideoSsrc(e.sdp),o(e,i,n))},a.processPreAnswer=function(e){s.debug("processPreAnswer: state= "+e.peer.signalingState);var t,n=e.peer;e.sdp=H.checkSupportedVideoCodecs(e.sdp,e.peer.localDescription.sdp,a.isH264Enabled()),e.sdp=H.removeG722Codec(e.sdp),e.sdp=H.fixRemoteTelephoneEventPayloadType(e,e.sdp),t=a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),n.setRemoteDescription(t,function(){a.setOriginatorReceiveRemoteVideo(e),e.remoteVideoState=H.getVideoSdpDirection(e.sdp),s.debug("processPreAnswer: setRemoteDescription success")},function(e){s.debug("processPreAnswer: setRemoteDescription failed: "+e)})},a.processRespond=function(e,t,n,i){var o,r,c,d=e.peer;if(s.debug("processRespond: state= "+e.peer.signalingState),e.sdp=H.checkSupportedVideoCodecs(e.sdp,d.localDescription.sdp,a.isH264Enabled()),o=H.getVideoSdpDirection(e.sdp),o===f.WEBRTC.MEDIA_STATE.INACTIVE&&"COMPLETED"===e.currentState)switch(e.remoteVideoState){case f.WEBRTC.MEDIA_STATE.INACTIVE:e.sdp=H.updateVideoSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY);break;case f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY:e.sdp=H.updateVideoSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)}return e.sdp=H.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.VIDEO),i&&(e.sdp=H.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.AUDIO),a.muteOnHold(e,!1)),e.peer.signalingState===f.WEBRTC.RTC_SIGNALING_STATE.STABLE?void U.callFunctionIfExist(t):((H.getVideoSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.INACTIVE||H.getVideoSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)&&(e.sdp=H.deleteInactiveVideoSsrc(e.sdp)),r=H.deleteSsrcFromSdp(e.sdp),c=a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,r),void d.setRemoteDescription(c,function(){s.debug("processRespond: setRemoteDescription success");var i=function(){e.remoteVideoState=H.getVideoSdpDirection(e.sdp),e.videoOfferSent=!0,U.callFunctionIfExist(t)};a.performVideoStartWorkaround(e,i,n)},function(e){s.debug("processRespond: setRemoteDescription failed: "+e),U.callFunctionIfExist(n)}))},a.processHoldRespond=function(e,t,n,i){var o,r,c,d,l,u=!1,p=!1;return d=function(){U.callFunctionIfExist(t)},s.debug("processHoldRespond: state= "+e.peer.signalingState+" call.currentState= "+e.currentState),e.sdp=H.checkSupportedVideoCodecs(e.sdp,e.peer.localDescription.sdp,a.isH264Enabled()),H.init(e.sdp),p=H.isRemoteHold(),u="LOCAL_HOLD"===e.currentState,u||a.addCallIdInPluginContainer(e),o=H.getAudioSdpDirection(e.sdp),r=H.getVideoSdpDirection(e.sdp),e.remoteVideoState=r,c=H.getVideoSdpDirection(e.peer.localDescription.sdp),s.debug("processHoldRespond: localHold= "+u+" remoteHold= "+p),p===!1?o===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE&&"REMOTE_HOLD"===e.currentState&&(s.debug("set current web state to COMPLETED"),e.previousState=e.currentState,e.currentState="COMPLETED"):"COMPLETED"===e.currentState&&(s.debug("set current web state to REMOTE_HOLD"),e.previousState=e.currentState,e.currentState="REMOTE_HOLD"),(u||p)&&(s.debug("processHoldRespond: "+e.currentState+" : video -> inactive"),e.sdp=H.updateVideoSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.INACTIVE)),r===f.WEBRTC.MEDIA_STATE.INACTIVE&&"COMPLETED"===e.currentState&&(s.debug("processHoldRespond: video inactive -> recvonly"),e.sdp=H.updateVideoSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)),i&&a.muteOnHold(e,!1),e.peer.signalingState===f.WEBRTC.RTC_SIGNALING_STATE.STABLE?void U.callFunctionIfExist(t):(e.sdp=H.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE),(H.getVideoSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.INACTIVE||H.getVideoSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)&&(e.sdp=H.deleteInactiveVideoSsrc(e.sdp)),l=a.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),void e.peer.setRemoteDescription(l,function(){s.debug("processHoldRespond: setRemoteDescription typeAns success"),o===f.WEBRTC.MEDIA_STATE.INACTIVE||o===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY?d():a.performVideoStartWorkaround(e,d,n)},function(e){s.debug("processHoldRespond: setRemoteDescription typeAns failed: "+e),U.callFunctionIfExist(n)}))},a.processRemoteOfferOnLocalHold=function(e,t,n){s.info("processRemoteOfferOnLocalHold"),e.peer?U.callFunctionIfExist(t,e.peer.localDescription.sdp):U.callFunctionIfExist(n,"we dont have a peer object somehow")},a.removeJslIdFromContainer=function(){a.getDefaultVideoContainer()?(a.getDefaultVideoContainer().removeAttribute("jsl-id"),a.disposeStreamRenderer(a.getDefaultVideoContainer().lastElementChild)):a.getLocalVideoContainer()&&(a.getLocalVideoContainer().removeAttribute("jsl-id"),a.disposeStreamRenderer(a.getLocalVideoContainer()))},a.processEnd=function(e){var t,n,i,c;if(a.clearIceCandidateCollectionTimer(e),a.clearWebrtcLogCollectionInterval(e),e.peer&&(s.info("close peer connection "+e.id),e.peer.close(),r(e.localMedia),n=a.getScreenStream(),n&&(o(n),a.setScreenStream(null)),i=a.getUserMediaStream(),i&&(o(i),a.setUserMediaStream(null)),a.setPeerCount(a.getPeerCount()-1),a.getPeerCount()<=0)){a.removeJslIdFromContainer(),c=a.getLocalStreamMap().entries();for(t in c)c.hasOwnProperty(t)&&r(a.getLocalStreamMap().get(t))}},a.onSessionConnecting=function(e,t){s.debug("onSessionConnecting")},a.onSessionOpened=function(e,t){s.debug("onSessionOpened")},a.onSignalingStateChange=function(e,t){s.debug("Signalling state changed: state= "+e.peer.signalingState)},a.useDefaultRenderer=function(e,t,n){var i;return a.getDefaultVideoContainer()&&0===a.getDefaultVideoContainer().children.length&&(a.getDefaultVideoContainer().innerHTML="<div style='height:100%;width:100%'></div><div style='position:absolute;bottom:10px;right:10px;height:30%; width:30%;'></div>"),t?i=a.getDefaultVideoContainer().lastElementChild:(i=a.getDefaultVideoContainer().firstElementChild,n?i.style.width="100%":i.style.width="0%"),a.createStreamRenderer(e,i,{muted:t})},a.createStreamRenderer=function(e,t,n){var i;if(e&&t)return t.innerHTML="",i=document.createElement("video"),i.src=e,i.style.width="100%",i.style.height="100%",i.autoplay="true",n&&n.muted&&(i.muted="true"),t.appendChild(i),i},a.addCallIdInPluginContainer=function(e){s.info("addCallIdInPluginContainer Call ID= "+e.id),a.getDefaultVideoContainer()?a.getDefaultVideoContainer().setAttribute("jsl-id",e.id):a.getRemoteVideoContainer()&&a.getRemoteVideoContainer().setAttribute("jsl-id",e.id)},a.isActiveCallInVideoContainer=function(e,t){return s.info("isActiveCallInVideoContainer Call ID= "+t.id),"undefined"!==e.getAttribute("jsl-id")&&(s.info("isActiveCallInVideoContainer Jsl Id= "+e.getAttribute("jsl-id")),
t.id!==e.getAttribute("jsl-id"))?!1:!0},a.onRemoteStreamAdded=function(e,t){var n,i,o=[],r=!1;if(a.getDefaultVideoContainer()){if(!a.isActiveCallInVideoContainer(a.getDefaultVideoContainer(),e))return void s.debug("onRemoteStreamAdded: It is not active call. Call Id: "+e.id)}else if(a.getRemoteVideoContainer()&&!a.isActiveCallInVideoContainer(a.getRemoteVideoContainer(),e))return void s.debug("onRemoteStreamAdded: It is not active call. Call Id: "+e.id);t.stream&&(n=a.getRtcLibrary().getURLFromStream(t.stream),n&&(o=t.stream.getVideoTracks(),o&&o.length>0&&(r=!0),i=a.getDefaultVideoContainer()?a.useDefaultRenderer(n,!1,r):a.getRemoteVideoContainer()?a.createStreamRenderer(n,a.getRemoteVideoContainer()):!0),s.debug("onRemoteStreamAdded: "+n),i&&a.fireOnStreamAddedEvent(e,n))},a.fireOnStreamAddedEvent=function(e,t){e&&e.call&&e.call.onStreamAdded&&(a.setOriginatorReceiveRemoteVideo(e),U.callFunctionIfExist(e.call.onStreamAdded,t))},a.onRemoteStreamRemoved=function(e,t){s.debug("onRemoteStreamRemoved")},a.clearIceCandidateCollectionTimer=function(e){clearTimeout(e.iceCandidateCollectionTimer),e.iceCandidateCollectionTimer=null},a.onIceCandidate=function(e,t){var n;null===t.candidate?(s.debug("Null candidate received."),e.successCallback&&(n=e.peer.localDescription.sdp,H.hasCandidates(n,e.relayCandidateCycle,v.relayCandidateCollectionTimeoutCycle)?(a.clearIceCandidateCollectionTimer(e),s.debug("Candidates received, invoking successCallback."),e.successCallback(n)):s.trace("Sdp does not have candidates."))):s.debug("ICE candidate received: sdpMLineIndex = "+t.candidate.sdpMLineIndex+", candidate = "+t.candidate.candidate+" for call : "+e.id)},a.onIceComplete=function(e){var t;s.debug("All ICE candidates received for call : "+e.id),a.clearIceCandidateCollectionTimer(e),e.successCallback&&(t=e.peer.localDescription.sdp,s.debug("onIceComplete sdp : "+t),e.successCallback(t))},a.iceCandidateCollectionTimeoutHandler=function(e){var t=e.peer.localDescription.sdp;return a.clearIceCandidateCollectionTimer(e),v.relayCandidateCollectionTimeoutCycle&&e.relayCandidateCycle++,H.hasCandidates(t,e.relayCandidateCycle,v.relayCandidateCollectionTimeoutCycle)?void(e.successCallback&&(s.debug("Ice candidate collection interrupted after given timeout, invoking successCallback."),e.successCallback(t))):(s.debug("Re-setting ice candidate collection timeout: "+v.iceCandidateCollectionTimeoutInterval),void(e.iceCandidateCollectionTimer=setTimeout(function(){a.iceCandidateCollectionTimeoutHandler(e)},v.iceCandidateCollectionTimeoutInterval)))},a.setupIceCandidateCollectionTimer=function(e){v.iceCandidateCollectionTimeoutInterval&&(e.iceCandidateCollectionTimer?s.trace("Ice candidate collection timer exists."):(s.debug("Setting ice candidate collection timeout: "+v.iceCandidateCollectionTimeoutInterval),v.relayCandidateCollectionTimeoutCycle&&(e.relayCandidateCycle=1),e.iceCandidateCollectionTimer=setTimeout(function(){a.iceCandidateCollectionTimeoutHandler(e)},v.iceCandidateCollectionTimeoutInterval)))},a.clearWebrtcLogCollectionInterval=function(e){clearInterval(e.webrtcLogCollectionInterval),e.webrtcLogCollectionInterval=null},a.webrtcLogCollectionTimeoutHandler=function(e){e&&e.peer&&"closed"!==e.peer.signalingState?e.peer.getStats(function(e){var t,n,i,o,r,a,c,d=e.result();for(a=d.length,t=0;a>t;++t)if(i=d[t],!i.local||i.local===i){if(r={},r.timestamp=i.timestamp,i.id&&(r.id=i.id),i.type&&(r.type=i.type),i.names)for(o=i.names(),c=o.length,n=0;c>n;++n)r[o[n]]=i.stat(o[n]);else i.stat("audioOutputLevel")&&(r.audioOutputLevel=i.stat("audioOutputLevel"));s.trace("Peer connection stats, report["+t+"]: ",r)}}):a.clearWebrtcLogCollectionInterval(e)},a.setupWebrtcLogCollectionTimer=function(e){if(v.webrtcLogCollectionInterval){a.clearWebrtcLogCollectionInterval(e);var t=1e3*v.webrtcLogCollectionInterval;s.debug("Setting webrtc log collection interval: "+t),e.webrtcLogCollectionInterval=setInterval(function(){a.webrtcLogCollectionTimeoutHandler(e)},t)}},a.oniceconnectionstatechange=function(e,t){s.debug("ICE connection state change : "+e.peer.iceConnectionState)},a.createPeer=function(e,t,n){try{var i,o,r,c,d=[],l=a.getIceServerUrl();if(l instanceof Array)for(r=0;r<l.length;r++)d[r]=l[r];else null===l||""===l?d=[]:d[0]=l;c={iceServers:d},o={optional:[{DtlsSrtpKeyAgreement:a.isDtlsEnabled()}]},i=a.getRtcLibrary().createRTCPeerConnection(c,o),a.setPeerCount(a.getPeerCount()+1),e.peer=i,i.onconnecting=function(t){a.onSessionConnecting(e,t)},i.onopen=function(t){a.onSessionOpened(e,t)},i.onsignalingstatechange=function(t){a.onSignalingStateChange(e,t)},i.onaddstream=function(t){a.onRemoteStreamAdded(e,t)},i.onremovestream=function(t){a.onRemoteStreamRemoved(e,t)},i.onicecandidate=function(t){"complete"===t.currentTarget.iceGatheringState?(s.debug("Ice gathering complete"),a.onIceComplete(e)):(a.setupIceCandidateCollectionTimer(e),a.onIceCandidate(e,t))},i.onicecomplete=function(){a.onIceComplete(e)},i.oniceconnectionstatechange=function(t){a.oniceconnectionstatechange(e,t)},s.info("create PeerConnection successfully."),a.setupWebrtcLogCollectionTimer(e),t(e)}catch(u){s.error("Failed to create PeerConnection, exception: "+u.message),n()}},a.createNewPeerForCall=function(e){var t=!1,n=a.getPeerCount();return e.peer&&(e.peer.close(),a.setPeerCount(n-1)),s.trace("Creating new peer for call: "+e.id),a.createPeer(e,function(){s.trace("New peer has created for call: "+e.id),e.peer.addStream(e.localMedia.stream),t=!0},function(){s.error("New peer creation has failed!: "+e.id)}),t},a.createNewPeerForCallIfIceChangedInRemoteSdp=function(e,t,n){var i=H.isIceLite(t),o=H.isIceLite(n),r=!1;return i!==o?(s.trace("Ice - Ice-Lite change detected in call: "+e.id),a.createNewPeerForCall(e)):r},a.getRemoteVideoResolutions=function(){var e,t,n=[];if(a.getRemoteVideoContainer()){if(!a.getRemoteVideoContainer().firstChild)return n;e=a.getRemoteVideoContainer().firstChild.videoHeight,t=a.getRemoteVideoContainer().firstChild.videoWidth}else{if(!a.getDefaultVideoContainer().firstElementChild.firstChild)return n;e=a.getDefaultVideoContainer().firstElementChild.firstChild.videoHeight,t=a.getDefaultVideoContainer().firstElementChild.firstChild.videoWidth}return s.debug("remote video resolutions of plugin webrtc..."),s.debug("remoteVideoWidth  : "+t),s.debug("remoteVideoHeight : "+e),n.push(e),n.push(t),a.getLocalVideoResolutions(),n},a.getLocalVideoResolutions=function(){var e,t,n=[];if(a.getLocalVideoContainer()){if(!a.getLocalVideoContainer().firstChild)return n;e=a.getLocalVideoContainer().firstChild.videoHeight,t=a.getLocalVideoContainer().firstChild.videoWidth}else{if(!a.getDefaultVideoContainer().lastElementChild.firstChild)return n;e=a.getDefaultVideoContainer().lastElementChild.firstChild.videoHeight,t=a.getDefaultVideoContainer().lastElementChild.firstChild.videoWidth}return s.debug("local video resolutions of plugin webrtc..."),s.debug("localVideoWidth  : "+t),s.debug("localVideoHeight : "+e),n.push(e),n.push(t),n},a.refreshVideoRenderer=function(){},a.sendIntraFrame=function(){},a.sendBlackFrame=function(){},a.disposeStreamRenderer=function(e){e&&(e.innerHTML="")},a.sendDTMF=function(e,t){var n,i,o,r,c,d,l,u;if(H.isSdpHasTelephoneEvent(e.peer.remoteDescription.sdp)){if(s.info("sending outband DTMF tone: "+t),!e.dtmfSender){if(d=a.getLocalAudioTrack(e.peer),!d)return;if(e.dtmfSender=e.peer.createDTMFSender(d),!e.dtmfSender)return}e.dtmfSender.canInsertDTMF===!0?e.dtmfSender.insertDTMF(t,400):s.error("Failed to execute 'insertDTMF' on 'RTCDTMFSender': The 'canInsertDTMF' attribute is false: this sender cannot send DTMF")}else s.info("sending inband DTMF tone: "+t),"1"===t&&(o="697",r="1209"),"2"===t&&(o="697",r="1336"),"3"===t&&(o="697",r="1477"),"4"===t&&(o="770",r="1209"),"5"===t&&(o="770",r="1336"),"6"===t&&(o="770",r="1477"),"7"===t&&(o="852",r="1209"),"8"===t&&(o="852",r="1336"),"9"===t&&(o="852",r="1477"),"*"===t&&(o="941",r="1209"),"0"===t&&(o="941",r="1336"),"#"===t&&(o="941",r="1477"),l=e.localMedia.audioContext,u=e.localMedia.mediaStreamDestination,n=l.createOscillator(),n.type="sine",n.frequency.value=o,c=l.createGain?l.createGain():l.createGainNode(),n.connect(c,0,0),c.connect(u),c.gain.value=.1,n.start(),i=l.createOscillator(),i.type="sine",i.frequency.value=r,c=l.createGain?l.createGain():l.createGainNode(),i.connect(c),c.connect(u),c.gain.value=.1,i.start(),setTimeout(function(){n.disconnect(),i.disconnect()},100)},a.showSettingsWindow=function(){a.getRtcLibrary().showSettingsWindow()},a.set_logSeverityLevel=function(e){a.getRtcLibrary().set_logSeverityLevel(e)},a.enable_logCallback=function(){var e=i.getLogger("rtcPlugin");a.getRtcLibrary().enable_logCallback(e)},a.disable_logCallback=function(){a.getRtcLibrary().disable_logCallback()},a.get_audioInDeviceCount=function(){a.getRtcLibrary().get_audioInDeviceCount()},a.get_audioOutDeviceCount=function(){a.getRtcLibrary().get_audioOutDeviceCount()},a.get_videoDeviceCount=function(){a.getRtcLibrary().get_videoDeviceCount()},a.setOriginatorSendLocalVideo=function(e,t){var n=H.isVideoSdpEnabled(e.peer.localDescription.sdp);e.canOrigSendVideo=t&&n},a.canOriginatorSendLocalVideo=function(e){return e.canOrigSendVideo},a.setOriginatorReceiveRemoteVideo=function(e){e.canOrigReceiveVideo=H.isVideoSdpEnabled(e.sdp)},a.canOriginatorReceiveRemoteVideo=function(e){return e.canOrigReceiveVideo},a.setTcpSetupAttiributesOnProcessAnswer=function(e,t){e.remoteTcpSetupAttribute=H.getTcpSetupAttribute(t),e.remoteTcpSetupAttribute===f.SDP.SETUP_ACTIVE?e.localTcpSetupAttribute=f.SDP.SETUP_PASSIVE:e.remoteTcpSetupAttribute===f.SDP.SETUP_PASSIVE?e.localTcpSetupAttribute=f.SDP.SETUP_ACTIVE:s.debug("Not handling remote TCP setup attribute: "+e.remoteTcpSetupAttribute)},a.setTcpSetupAttiributesOnCreateAnswer=function(e,t){e.localTcpSetupAttribute=H.getTcpSetupAttribute(t),e.localTcpSetupAttribute===f.SDP.SETUP_ACTIVE?e.remoteTcpSetupAttribute=f.SDP.SETUP_PASSIVE:e.localTcpSetupAttribute===f.SDP.SETUP_PASSIVE?e.remoteTcpSetupAttribute=f.SDP.SETUP_ACTIVE:s.debug("Not handling remote TCP setup attribute: "+e.remoteTcpSetupAttribute)},s.debug("WebRtcAdaptor initialized")},oe=function(e,t,n){return new ie(e,t,n,V)};l&&(l.WebRtcAdaptor=oe);var re=function(e,t,n,i){var o=this,r=i.getLogger("WebRtcPluginAdaptorImpl");r.debug("WebRtcPluginAdaptor initializing"),U.compose(e,o),U.compose(n,o),o.setPluginEnabled(!0),o.performSdpWorkaroundsAfterCreateOffer=function(e,t){return t=H.replaceCodecs(t,e.codecsToReplace?e.codecsToReplace:v.codecsToReplace)},o.addLocalStream=function(e){var t,n=!1,i=o.canOriginatorSendLocalVideo(e);e.localMedia.stream&&(i?(t=o.getRtcLibrary().getURLFromStream(e.localMedia.stream),t&&(o.getDefaultVideoContainer()?n=o.useDefaultRenderer(t,!0):o.getLocalVideoContainer()?n=o.createStreamRenderer(t,o.getLocalVideoContainer(),{muted:!0}):(e.call.localStreamURL=t,n=!0))):o.getDefaultVideoContainer()?o.getDefaultVideoContainer().lastElementChild&&o.disposeStreamRenderer(o.getDefaultVideoContainer().lastElementChild):o.getLocalVideoContainer()&&o.disposeStreamRenderer(o.getLocalVideoContainer()),r.debug("onLocalStreamAdded: "+t),n&&o.fireOnLocalStreamAddedEvent(e,t))},o.performSdpWorkaroundsBeforeProcessingIncomingSdp=function(e){e.sdp=H.deleteBandwidthLineFromSdp(e.sdp),e.sdp=H.removeRTXCodec(e.sdp),e.sdp=H.removeG722Codec(e.sdp),e.sdp=H.fixRemoteTelephoneEventPayloadType(e,e.sdp)},o.initMedia=function(e,n,i){var a,s,c,d=document.body,l={},u=!0,p=E.call.MediaErrors,f="1px",S="fcsPlugin",T="application/x-gcfwenabler",g=o.getPluginVersion();if(r.debug("Configured plugin version: "+g.major+"."+g.minor+"."+g.current_revision),i&&(i.pluginLogLevel&&o.setLogLevel(i.pluginLogLevel),i.language&&o.setLanguage(i.language)),o.onFCSPLoaded=function(){o.setRtcLibrary(t(l)),o.isH264Enabled()&&o.getRtcLibrary().enableH264(),o.getRtcLibrary().checkMediaSourceAvailability(function(e){o.setMediaSources(e)}),o.getRtcLibrary().setH264CodecStateChangeHandler(function(e){o.setH264Enabled(e.state)}),s=o.getRtcLibrary().getCurrentPluginVersionObject(),c=o.getRtcLibrary().getVersion(),!o.isInitialized()&&u&&(u=!1,r.debug("Plugin callback"),E.setPluginVersion(c),r.debug("Installed plugin version: "+c),c.length<1||s.major!==g.major||s.minor!==g.minor||s.revision<g.min_revision||s.revision===g.min_revision&&s.build<g.min_build?(r.debug("Plugin version not supported"),U.callFunctionIfExist(n,p.WRONG_VERSION)):(o.setInitialized(!0),s.revision<g.current_revision||s.revision===g.current_revision&&s.build<g.current_build?(r.debug("New plugin version warning"),U.callFunctionIfExist(n,p.NEW_VERSION_WARNING)):U.callFunctionIfExist(e,{pluginVersion:l.version}),o.getRtcLibrary().setLang(o.getLanguage())),o.setUserMediaStream(null),o.getRtcLibrary().checkMediaSourceAvailability())},"undefined"==typeof d.appendChild)return r.debug("Could not inject plugin in container"),void U.callFunctionIfExist(n,p.OPTIONS);l=document.createElement("object"),a=document.createElement("param"),a.setAttribute("name","onload"),a.setAttribute("value","onFCSPLoaded"),l.appendChild(a),l.id=S,l.width=l.height=f;try{"Microsoft Internet Explorer"===navigator.appName?(d.appendChild(l),l.type=T):(l.type=T,d.appendChild(l))}catch(m){u=!1,U.callFunctionIfExist(n,p.NOT_FOUND)}u&&("undefined"!=typeof document.getElementById(S).createPeerConnection?o.onFCSPLoaded():setTimeout(function(){o.isInitialized()||("undefined"==typeof document.getElementById(S).createPeerConnection?U.callFunctionIfExist(n,p.NOT_FOUND):o.onFCSPLoaded())},7e3))},o.getUserMedia=function(e,t){o.getRtcLibrary().checkMediaSourceAvailability(function(n){var i,a;r.debug("Plugin version:"+o.getRtcLibrary().version),n&&(o.setVideoSourceAvailable(n.videoSourceAvailable),o.setAudioSourceAvailable(n.audioSourceAvailable)),i=o.getMediaVideo()&&o.getVideoSourceAvailable()?{mandatory:{maxWidth:o.getVideoWidth(),maxHeight:o.getVideoHeight()}}:!1,o.getRtcLibrary().getUserMedia({audio:o.getMediaAudio(),video:i},function(t){var n={};o.setUserMediaStream(t),n.audioContext={close:function(){}},n.mediaStreamDestination={disconnect:function(){}},n.stream=t,o.getLocalStreamMap().add(n.stream.id,n),o.setInitialized(!0),a={audio:o.getMediaAudio(),video:o.getMediaVideo()&&o.getVideoSourceAvailable(),id:n.stream.id},r.debug("user has granted access to local media: ",n),U.callFunctionIfExist(e,a)},function(e){r.debug("Failed to get access to local media. Error code was "+e.code),U.callFunctionIfExist(t,E.call.MediaErrors.NOT_ALLOWED)})})},o.createOffer=function(e,t,n,i){r.debug("createOffer: sendInitialVideo= "+i+" state= "+e.peer.signalingState);var a,s=e.peer;e.peer.addStream(e.localMedia.stream),o.addCallIdInPluginContainer(e),s.createOffer(function(t){i=i&&o.getVideoSourceAvailable(),a=H.getSdpFromObject(t),t=null,a=i?H.updateVideoSdpDirection(a,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):H.updateVideoSdpDirection(a,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),a=H.deleteCryptoZeroFromSdp(a),a=H.updateAudioCodec(a),a=H.removeG722Codec(a),a=H.deleteCryptoFromSdp(a,o.isDtlsEnabled()),a=H.setTcpSetupAttributeToActpass(a,o.isDtlsEnabled()),a=H.fixLocalTelephoneEventPayloadType(e,a),a=o.performSdpWorkaroundsAfterCreateOffer(e,a),o.muteOnHold(e,!1),s.setLocalDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,a),function(){},function(e){r.error("createOffer: setLocalDescription failed : "+e),U.callFunctionIfExist(n,"createOffer: setLocalDescription failed")})},function(e){r.error("createOffer: createOffer failed!! "+e),U.callFunctionIfExist(n)},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},o.createAnswer=function(e,t,n,i){r.debug("createAnswer: isVideoEnabled= "+i+" state= "+e.peer.signalingState);var a,s=e.peer;e.sdp=H.checkSupportedVideoCodecs(e.sdp,null,o.isH264Enabled()),e.sdp=H.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.INACTIVE,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.AUDIO),e.sdp=H.deleteFingerprintOrCrypto(e.sdp,o.isDtlsEnabled()),H.isSdpVideoSendEnabled(e.sdp)||(e.sdp=H.deleteInactiveVideoSsrc(e.sdp)),o.addCallIdInPluginContainer(e),s.setRemoteDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),function(){e.peer.addStream(e.localMedia.stream),e.remoteVideoState=H.getVideoSdpDirection(e.sdp),s.createAnswer(s.remoteDescription,function(t){a=H.getSdpFromObject(t),t=null,i=i&&o.getVideoSourceAvailable()&&H.isSdpHasVideo(e.sdp),a=i?H.isSdpVideoSendEnabled(e.sdp)?H.updateVideoSdpDirection(a,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):H.getVideoSdpDirection(e.sdp)!==f.WEBRTC.MEDIA_STATE.INACTIVE?H.updateVideoSdpDirection(a,f.WEBRTC.MEDIA_STATE.SEND_ONLY):H.updateVideoSdpDirection(a,f.WEBRTC.MEDIA_STATE.INACTIVE):H.isSdpVideoSendEnabled(e.sdp)?H.updateVideoSdpDirection(a,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY):H.updateVideoSdpDirection(a,f.WEBRTC.MEDIA_STATE.INACTIVE),r.debug("doAnswer(plugin) - isSdpEnabled audio : "+H.isAudioSdpEnabled(a)),r.debug("doAnswer(plugin) - isSdpEnabled video : "+H.isVideoSdpEnabled(a)),H.isSdpHasAudio(a)||H.isSdpHasVideo(a)?(a=H.fixLocalTelephoneEventPayloadType(e,a),a=H.checkAndRestoreICEParams(a,e.sdp),o.muteOnHold(e,!1),s.setLocalDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,a),function(){e.videoOfferSent=H.isSdpHasVideo(a),o.setTcpSetupAttiributesOnCreateAnswer(e,a)},function(e){r.error("createAnswer: setLocalDescription failed : "+e),U.callFunctionIfExist(n,"createAnswer setLocalDescription failed")})):(r.error("createrAnswer: createAnswer failed!!"),U.callFunctionIfExist(n,"No codec negotiation"))},function(e){r.error("createAnswer: failed!!"+e),U.callFunctionIfExist(n,"Session cannot be created ")},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},function(e){r.error("createAnswer setRemoteDescription failed : "+e)})},o.createUpdate=function(e,t,n,i){r.debug("createEnablerUpdate: isVideoStart= "+i+" state= "+e.peer.signalingState);var a,s,c=e.peer;a=H.getSdpFromObject(e.peer.localDescription),a=H.incrementVersion(a),a=H.deleteCryptoFromSdp(a,o.isDtlsEnabled()),a=H.fixLocalTelephoneEventPayloadType(e,a),r.debug("create new offer to start the video"),o.createNewPeerForCall(e)&&(c=e.peer),o.setMediaVideo(!0),c.createOffer(function(t){i=i&&o.getVideoSourceAvailable(),i?t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):H.isVideoSdpDirectionInactive(e.stableRemoteSdp)?t.sdp=H.updateVideoSdpDirectionToInactive(t.sdp):t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),s=t.sdp,t=null,s=H.updateH264Level(s),s=H.deleteCryptoZeroFromSdp(s),s=H.updateAudioCodec(s),s=H.removeG722Codec(s),s=H.deleteCryptoFromSdp(s,o.isDtlsEnabled()),s=H.setTcpSetupAttributeToActpass(s,o.isDtlsEnabled()),s=H.fixLocalTelephoneEventPayloadType(e,s),s=o.performSdpWorkaroundsAfterCreateOffer(e,s),c.setLocalDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,s),function(){r.debug("createUpdate: createOffer setLocalDescription success ")},function(e){r.debug("createUpdate: createOffer setLocalDescription failed: "+e),U.callFunctionIfExist(n)})},function(e){r.debug("createUpdate: createOffer failed!!: "+e),n()},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},o.createHoldUpdate=function(e,t,n,i,a){r.debug("createHoldUpdate: local hold= "+t+" remote hold= "+n+" state= "+e.peer.signalingState);var s,c,d,l,u=e.peer;s=H.getAudioSdpDirection(u.localDescription.sdp),c=H.getVideoSdpDirection(u.localDescription.sdp),o.createNewPeerForCall(e)&&(u=e.peer),u.createOffer(function(i){i.sdp=H.incrementVersion(i.sdp),i.sdp=H.setTcpSetupAttributeToActpass(i.sdp,o.isDtlsEnabled()),i.sdp=o.performSdpWorkaroundsAfterCreateOffer(e,i.sdp),t||n?(s===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE?i.sdp=H.updateAudioSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY):!t&&n?i.sdp=H.updateAudioSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):i.sdp=H.updateAudioSdpDirectionToInactive(i.sdp),c===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE?i.sdp=H.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY):!t&&n?i.sdp=H.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):i.sdp=H.updateVideoSdpDirectionToInactive(i.sdp),d=!0):(i.sdp=H.updateAudioSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE),o.canOriginatorSendLocalVideo(e)?i.sdp=H.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):i.sdp=H.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),d=!1),i.sdp=H.fixLocalTelephoneEventPayloadType(e,i.sdp),l=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,i.sdp),u.setLocalDescription(l,function(){r.debug("createHoldUpdate: setLocalDescription success"),o.muteOnHold(e,d)},function(e){r.error("createHoldUpdate: setLocalDescription failed: "+e.message),U.callFunctionIfExist(a)})},function(e){r.error("createHoldUpdate: createOffer failed: "+e.message),U.callFunctionIfExist(a)},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},o.processUpdate=function(e,t,n,i){r.debug("processUpdate: state= "+e.peer.signalingState);var a,s,c,d,l,u,p,E,S=e.peer;if(e.sdp=H.addSdpMissingCryptoLine(e.sdp),e.sdp=H.checkAndRestoreICEParams(e.sdp,e.peer.localDescription.sdp),p=H.getVideoSdpDirection(e.sdp),o.setMediaVideo(H.isSdpHasVideo(e.sdp)),p===f.WEBRTC.MEDIA_STATE.INACTIVE&&"COMPLETED"===e.currentState)switch(e.remoteVideoState){case f.WEBRTC.MEDIA_STATE.INACTIVE:e.sdp=H.updateVideoSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE);break;case f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY:e.sdp=H.updateVideoSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE);break;case f.WEBRTC.MEDIA_STATE.SEND_RECEIVE:e.sdp=H.updateVideoSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)}e.sdp=H.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.VIDEO),e.sdp=H.checkSupportedVideoCodecs(e.sdp,null,o.isH264Enabled()),s=H.getAudioSdpDirection(e.sdp),c=H.getVideoSdpDirection(e.sdp),(H.getVideoSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.INACTIVE||H.getVideoSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)&&(e.sdp=H.deleteInactiveVideoSsrc(e.sdp)),e.sdp=H.setTcpSetupAttributeToActpass(e.sdp,o.isDtlsEnabled()),d=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.prevRemoteSdp),u=S.localDescription.sdp,o.createNewPeerForCall(e)&&(S=e.peer),H.isSdpHas(e.prevRemoteSdp,f.STRING.VIDEO)||H.isIceLite(e.sdp)||i?(e.sdp=H.updateAudioSdpDirectionToInactive(e.sdp),e.sdp=H.updateVideoSdpDirectionToInactive(e.sdp),E=H.deleteSsrcFromSdp(e.sdp),l=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,E),S.setRemoteDescription(l,function(){r.debug("processUpdate: workaround setRemoteDescription success"),e.sdp=H.updateAudioSdpDirection(e.sdp,s),e.sdp=H.updateVideoSdpDirection(e.sdp,c),l=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),S.setRemoteDescription(l,function(){r.debug("processUpdate: setRemoteDescription success"),e.remoteVideoState=H.getVideoSdpDirection(e.sdp),S.createAnswer(S.remoteDescription,function(t){r.debug("processUpdate: isSdpEnabled audio= "+H.isAudioSdpEnabled(t.sdp)),r.debug("processUpdate: isSdpEnabled video= "+H.isVideoSdpEnabled(t.sdp)),H.isAudioSdpEnabled(t.sdp)||H.isVideoSdpEnabled(t.sdp)?(H.isSdpVideoSendEnabled(e.sdp)?o.canOriginatorSendLocalVideo(e)?t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY):o.canOriginatorSendLocalVideo(e)&&!H.isVideoSdpDirectionInactive(e.sdp)?t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY):t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.INACTIVE),a=H.getSdpFromObject(t),t=null,a=H.updateVersion(u,a),a=H.checkIceParamsLengths(a,e.sdp),a=H.setTcpSetupAttributeTo(a,e.localTcpSetupAttribute,o.isDtlsEnabled()),a=H.fixLocalTelephoneEventPayloadType(e,a),S.setLocalDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,a),function(){r.debug("processUpdate: setLocalDescription success")},function(e){r.debug("processUpdate: setLocalDescription failed: "+e),U.callFunctionIfExist(n,"processUpdate: setlocalDescription failed!!")})):(r.debug("processUpdate: createAnswer failed!!"),U.callFunctionIfExist(n,"No codec negotiation"))},function(e){r.debug("processUpdate: createAnswer failed!! "+e),U.callFunctionIfExist(n,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},function(e){r.debug("processUpdate: setRemoteDescription failed: "+e),U.callFunctionIfExist(n,"processUpdate: setRemoteDescription failed!!")})},function(e){r.debug("processUpdate: workaround setRemoteDescription failed!!"+e),U.callFunctionIfExist(n,"processUpdate: workaround setRemoteDescription failed!!")})):(l=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,E),S.setRemoteDescription(l,function(){r.debug("processUpdate: workaround setRemoteDescription success"),e.sdp=H.updateAudioSdpDirection(e.sdp,s),e.sdp=H.updateVideoSdpDirection(e.sdp,c),l=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),S.setRemoteDescription(l,function(){r.debug("processUpdate: setRemoteDescription success"),e.remoteVideoState=H.getVideoSdpDirection(e.sdp),S.createAnswer(S.remoteDescription,function(t){r.debug("processUpdate: isSdpEnabled audio= "+H.isAudioSdpEnabled(t.sdp)),r.debug("processUpdate: isSdpEnabled video= "+H.isVideoSdpEnabled(t.sdp)),H.isAudioSdpEnabled(t.sdp)||H.isVideoSdpEnabled(t.sdp)?(H.isSdpVideoSendEnabled(e.sdp)?o.canOriginatorSendLocalVideo(e)?t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY):o.canOriginatorSendLocalVideo(e)&&!H.isVideoSdpDirectionInactive(e.sdp)?t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY):t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.INACTIVE),a=H.getSdpFromObject(t),t=null,a=H.updateVersion(u,a),a=H.checkIceParamsLengths(a,e.sdp),a=H.setTcpSetupAttributeTo(a,e.localTcpSetupAttribute,o.isDtlsEnabled()),a=H.fixLocalTelephoneEventPayloadType(e,a),S.setLocalDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,a),function(){r.debug("processUpdate: setLocalDescription success")},function(e){r.debug("processUpdate: setLocalDescription failed: "+e),U.callFunctionIfExist(n,"processUpdate: setlocalDescription failed!!")})):(r.debug("processUpdate: createAnswer failed!!"),U.callFunctionIfExist(n,"No codec negotiation"))},function(e){r.debug("processUpdate: createAnswer failed!! "+e),U.callFunctionIfExist(n,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},function(e){r.debug("processUpdate: setRemoteDescription failed: "+e),U.callFunctionIfExist(n,"processUpdate: setRemoteDescription failed!!")})},function(e){r.debug("processUpdate: workaround setRemoteDescription failed!!"+e),U.callFunctionIfExist(n,"processUpdate: workaround setRemoteDescription failed!!")}))},o.processAnswer=function(e,t,n){r.debug("processAnswer: state= "+e.peer.signalingState);var i,a,s,c;i=function(){e.remoteVideoState=H.getVideoSdpDirection(e.sdp),e.videoOfferSent=H.isSdpHasVideo(e.sdp),U.callFunctionIfExist(t)},a=function(e,t,n){e.peer.setRemoteDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),function(){r.debug("processAnswer: setRemoteDescription success"),t()},function(e){r.debug("processAnswer: setRemoteDescription failed: "+e),n()})},o.setTcpSetupAttiributesOnProcessAnswer(e,e.sdp),e.sdp=H.checkSupportedVideoCodecs(e.sdp,H.getSdpFromObject(e.peer.localDescription),o.isH264Enabled()),e.sdp=H.performVideoPortZeroWorkaround(e.sdp),s=H.getVideoSdpDirection(e.sdp),c=H.getVideoSdpDirection(H.getSdpFromObject(e.peer.localDescription)),r.debug("processAnswer: ice-lite: do remote video escalation"),e.sdp=H.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE),(c!==f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY||s!==f.WEBRTC.MEDIA_STATE.INACTIVE&&s!==f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)&&(c!==f.WEBRTC.MEDIA_STATE.SEND_RECEIVE||s!==f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY&&s!==f.WEBRTC.MEDIA_STATE.INACTIVE)?c!==f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY||s!==f.WEBRTC.MEDIA_STATE.SEND_ONLY&&s!==f.WEBRTC.MEDIA_STATE.SEND_RECEIVE?a(e,i,n):a(e,function(){o.performVideoStartWorkaround(e,i,n)},n):(e.sdp=H.deleteInactiveVideoSsrc(e.sdp),a(e,i,n))},o.performVideoStartWorkaround=function(e,t,n){var i,a,s,c=e.peer;r.debug("Workaround to play video"),e.sdp=H.addSdpMissingCryptoLine(e.sdp),i=H.getSdpDirectionLogging(e.sdp,f.STRING.AUDIO,!1),a=H.getSdpDirectionLogging(e.sdp,f.STRING.VIDEO,!1),e.sdp=H.updateSdpDirection(e.sdp,f.STRING.AUDIO,f.WEBRTC.MEDIA_STATE.INACTIVE),e.sdp=H.updateSdpDirection(e.sdp,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.INACTIVE),e.sdp=H.setTcpSetupAttributeToActpass(e.sdp,o.isDtlsEnabled()),s=H.deleteSsrcFromSdp(e.sdp),c.setRemoteDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,s),function(){r.debug("performVideoStartWorkaround: first setRemoteDescription success"),e.sdp=H.updateSdpDirection(e.sdp,f.STRING.AUDIO,i),e.sdp=H.updateSdpDirection(e.sdp,f.STRING.VIDEO,a),c.setRemoteDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),function(){r.debug("performVideoStartWorkaround: second setRemoteDescription success"),c.createAnswer(c.remoteDescription,function(i){var a=H.getSdpFromObject(i);H.getSdpDirectionLogging(e.sdp,f.STRING.AUDIO,!1)===f.WEBRTC.MEDIA_STATE.INACTIVE&&(a=H.updateSdpDirection(a,f.STRING.AUDIO,f.WEBRTC.MEDIA_STATE.INACTIVE)),a=e.remoteVideoState===f.WEBRTC.MEDIA_STATE.INACTIVE?H.updateSdpDirection(a,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.INACTIVE):o.canOriginatorSendLocalVideo(e)?H.updateSdpDirection(a,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):H.updateSdpDirection(a,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),a=H.checkAndRestoreICEParams(a,e.sdp),a=H.setTcpSetupAttributeTo(a,e.localTcpSetupAttribute,o.isDtlsEnabled()),a=H.fixLocalTelephoneEventPayloadType(e,a),c.setLocalDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,a),function(){r.debug("performVideoStartWorkaround: setlocalDescription success"),U.callFunctionIfExist(t)},function(e){r.debug("performVideoStartWorkaround: setlocalDescription failed!!"+e),U.callFunctionIfExist(n,"performVideoStartWorkaround: setlocalDescription failed!!")})},function(e){r.debug("performVideoStartWorkaround: createAnswer failed!! "+e),U.callFunctionIfExist(n,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},function(e){r.debug("performVideoStartWorkaround: second setRemoteDescription failed!!"+e),U.callFunctionIfExist(n,"performVideoStartWorkaround: second setRemoteDescription failed!!")})},function(e){r.debug("performVideoStartWorkaround: first setRemoteDescription failed!!"+e),U.callFunctionIfExist(n,"performVideoStartWorkaround: first setRemoteDescription failed!!")})},o.processPreAnswer=function(e){var t;r.debug("processPreAnswer: state= "+e.peer.signalingState),e.sdp=H.checkSupportedVideoCodecs(e.sdp,H.getSdpFromObject(e.peer.localDescription),o.isH264Enabled()),e.sdp=H.removeG722Codec(e.sdp),e.sdp=H.removeRTXCodec(e.sdp),e.sdp=H.fixRemoteTelephoneEventPayloadType(e,e.sdp),t=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.PRANSWER,e.sdp),e.peer.setRemoteDescription(t,function(){o.setOriginatorReceiveRemoteVideo(e),e.remoteVideoState=H.getVideoSdpDirection(e.sdp),r.debug("processPreAnswer: setRemoteDescription success")},function(e){r.debug("processPreAnswer: setRemoteDescription failed: "+e)})},o.processRespond=function(e,t,n,i){var a;if(r.debug("processRespond: state= "+e.peer.signalingState),e.sdp=H.checkSupportedVideoCodecs(e.sdp,H.getSdpFromObject(e.peer.localDescription),o.isH264Enabled()),
a=H.getVideoSdpDirection(e.sdp),a===f.WEBRTC.MEDIA_STATE.INACTIVE&&"COMPLETED"===e.currentState)switch(e.remoteVideoState){case f.WEBRTC.MEDIA_STATE.INACTIVE:e.sdp=H.updateSdpDirection(e.sdp,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY);break;case f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY:e.sdp=H.updateSdpDirection(e.sdp,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)}return e.remoteVideoState=H.getVideoSdpDirection(e.sdp),e.sdp=H.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.VIDEO),i&&(e.sdp=H.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.AUDIO),o.muteOnHold(e,!1)),e.peer.signalingState===f.WEBRTC.RTC_SIGNALING_STATE.STABLE?void U.callFunctionIfExist(t):((H.getVideoSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.INACTIVE||H.getVideoSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)&&(e.sdp=H.deleteInactiveVideoSsrc(e.sdp)),void e.peer.setRemoteDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),function(){r.debug("processRespond: setRemoteDescription success");var i=function(){e.remoteVideoState=H.getVideoSdpDirection(e.sdp),e.videoOfferSent=!0,U.callFunctionIfExist(t)};o.performVideoStartWorkaround(e,i,n)},function(e){r.debug("processRespond: setRemoteDescription failed: "+e),U.callFunctionIfExist(n)}))},o.createReOffer=function(e,t,n,i){var a,s,c,d=e.peer,l=e.peer.localDescription.sdp;r.debug("createReOffer:"+e.id),o.createNewPeerForCall(e)&&(d=e.peer),d.createOffer(function(t){a=H.getSdpFromObject(t),t=null,c=H.getVideoSdpDirection(l),a=H.updateVideoSdpDirection(a,c),i&&(s=H.getAudioSdpDirection(l),a=H.updateAudioSdpDirection(a,s)),a=H.deleteCryptoZeroFromSdp(a),a=H.updateAudioCodec(a),a=H.removeG722Codec(a),a=H.deleteCryptoFromSdp(a,o.isDtlsEnabled()),a=H.setTcpSetupAttributeToActpass(a,o.isDtlsEnabled()),a=H.fixLocalTelephoneEventPayloadType(e,a),a=o.performSdpWorkaroundsAfterCreateOffer(e,a),d.setLocalDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,a),function(){r.debug("createReOffer: setLocalDescription success"+e.id)},function(t){r.debug("createReOffer: setLocalDescription failed!!"+t+e.id),U.callFunctionIfExist(n)})},function(e){r.error("createReOffer: createOffer failed!! "+e),U.callFunctionIfExist(n)},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},o.processHold=function(e,t,n,i,a){r.debug("processHold: local hold= "+n+" remote hold= "+t+" state= "+e.peer.signalingState);var s,c,d,l,u,p=e.peer;n||t||o.muteOnHold(e,!1),e.sdp=H.checkSupportedVideoCodecs(e.sdp,null,o.isH264Enabled()),e.sdp=H.performVideoPortZeroWorkaround(e.sdp),e.sdp=H.checkAndRestoreICEParams(e.sdp,H.getSdpFromObject(e.peer.localDescription)),c=H.getAudioSdpDirection(e.sdp),d=H.getVideoSdpDirection(e.sdp),s=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),l=H.getSdpFromObject(p.localDescription),o.createNewPeerForCall(e)&&(p=e.peer),s.sdp=H.updateAudioSdpDirection(s.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE),(H.getVideoSdpDirection(s.sdp)===f.WEBRTC.MEDIA_STATE.INACTIVE||H.getVideoSdpDirection(s.sdp)===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)&&(s.sdp=H.deleteInactiveVideoSsrc(s.sdp)),p.setRemoteDescription(s,function(){t||n||d!==f.WEBRTC.MEDIA_STATE.INACTIVE?e.remoteVideoState=H.getVideoSdpDirection(s.sdp):e.remoteVideoState=f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,p.createAnswer(p.remoteDescription,function(i){u=H.getSdpFromObject(i),r.debug("processHold: isSdpEnabled audio= "+H.isAudioSdpEnabled(i.sdp)),r.debug("processHold: isSdpEnabled video= "+H.isVideoSdpEnabled(i.sdp)),i=null,t?(r.debug("processHold: Remote HOLD"),u=H.respondToRemoteSdpDirections(u,e.sdp)):n?n&&!t&&(r.debug("processHold: Remote UNHOLD on local hold"),u=c===f.WEBRTC.MEDIA_STATE.INACTIVE?H.updateAudioSdpDirectionToInactive(u):H.updateAudioSdpDirection(u,f.WEBRTC.MEDIA_STATE.SEND_ONLY),u=o.canOriginatorSendLocalVideo(e)?H.updateVideoSdpDirection(u,f.WEBRTC.MEDIA_STATE.SEND_ONLY):H.updateVideoSdpDirectionToInactive(u)):(r.debug("processHold: Remote UNHOLD: direction left as it is"),u=H.isSdpVideoSendEnabled(e.sdp)?o.canOriginatorSendLocalVideo(e)?H.updateVideoSdpDirection(u,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):H.updateVideoSdpDirection(u,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY):o.canOriginatorSendLocalVideo(e)&&!H.isVideoSdpDirectionInactive(e.sdp)?H.updateVideoSdpDirection(u,f.WEBRTC.MEDIA_STATE.SEND_ONLY):H.updateVideoSdpDirection(u,f.WEBRTC.MEDIA_STATE.INACTIVE),u=H.changeDirection(u,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.AUDIO)),u=H.updateVersion(l,u),u=H.checkIceParamsLengths(u,s.sdp),u=H.fixLocalTelephoneEventPayloadType(e,u),u=H.setTcpSetupAttributeTo(u,e.localTcpSetupAttribute,o.isDtlsEnabled()),u=H.updateH264Level(u),p.setLocalDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,u),function(){r.debug("processHold: setLocalDescription success!! ")},function(e){r.error("processHold: setLocalDescription failed!! "+e),U.callFunctionIfExist(a,"Session cannot be created")})},function(e){r.error("processHold: createAnswer failed!!: "+e),U.callFunctionIfExist(a,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},function(e){r.error("processHold: second setRemoteDescription failed!! "+e),U.callFunctionIfExist(a,"Session cannot be created")})},o.processHoldRespond=function(e,t,n,i){var a,s,c=!1,d=!1;r.debug("processHoldRespond: state= "+e.peer.signalingState+" call.currentState= "+e.currentState),e.sdp=H.checkSupportedVideoCodecs(e.sdp,H.getSdpFromObject(e.peer.localDescription),o.isH264Enabled()),H.init(e.sdp),d=H.isRemoteHold(),c="LOCAL_HOLD"===e.currentState,c||o.addCallIdInPluginContainer(e),a=H.getAudioSdpDirection(e.sdp),s=H.getVideoSdpDirection(e.sdp),r.debug("processHoldRespond: localHold= "+c+" remoteHold= "+d),d===!1?a===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE&&"REMOTE_HOLD"===e.currentState&&(e.previousState=e.currentState,e.currentState="COMPLETED"):"COMPLETED"===e.currentState&&(e.previousState=e.currentState,e.currentState="REMOTE_HOLD"),(c||d)&&(r.debug("processHoldRespond: "+e.currentState+" : video -> inactive"),e.sdp=H.updateSdpDirection(e.sdp,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.INACTIVE)),s===f.WEBRTC.MEDIA_STATE.INACTIVE&&"COMPLETED"===e.currentState&&(r.debug("processHoldRespond: video inactive -> recvonly"),e.sdp=H.updateSdpDirection(e.sdp,f.STRING.VIDEO,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)),o.processRespond(e,t,n,i)},o.createPeer=function(e,t,n){try{var i,a,s,c,d=[],l=o.getIceServerUrl();if(l instanceof Array)for(s=0;s<l.length;s++)d[s]=l[s];else null===l||""===l?d=[]:d[0]=l;c={iceServers:d},a={optional:{DtlsSrtpKeyAgreement:o.isDtlsEnabled()}},i=o.getRtcLibrary().createRTCPeerConnection(c,a),o.setPeerCount(o.getPeerCount()+1),e.peer=i,i.onconnecting=function(t){o.onSessionConnecting(e,t)},i.onopen=function(t){o.onSessionOpened(e,t)},i.onsignalingstatechange=function(t){o.onSignalingStateChange(e,t)},i.onaddstream=function(t){o.onRemoteStreamAdded(e,t)},i.onremovestream=function(t){o.onRemoteStreamRemoved(e,t)},i.onicecandidate=function(t){o.setupIceCandidateCollectionTimer(e),o.onIceCandidate(e,t)},i.onicecomplete=function(){o.onIceComplete(e)},i.oniceconnectionstatechange=function(t){o.oniceconnectionstatechange(e,t)},r.info("create PeerConnection successfully."),o.setupWebrtcLogCollectionTimer(e),U.callFunctionIfExist(t)}catch(u){r.error("Failed to create PeerConnection, exception: "+u.message),U.callFunctionIfExist(n)}},o.createNewPeerForCall=function(e){var t=!1,n=o.getPeerCount();return e.peer&&(e.peer.close(),o.setPeerCount(n-1)),r.trace("Creating new peer for call: "+e.id),o.createPeer(e,function(){r.trace("New peer has created for call: "+e.id),e.peer.addStream(e.localMedia.stream),t=!0},function(){r.error("New peer creation has failed!: "+e.id)}),t},o.createNewPeerForCallIfIceChangedInRemoteSdp=function(e,t,n){var i=H.isIceLite(t),a=H.isIceLite(n),s=!1;return i!==a?(r.trace("Ice - Ice-Lite change detected in call: "+e.id),o.createNewPeerForCall(e)):s},o.onRemoteStreamAdded=function(e,t){var n,i,a=[],s=!1;if(o.getDefaultVideoContainer()){if(!o.isActiveCallInVideoContainer(o.getDefaultVideoContainer(),e))return void r.debug("onRemoteStreamAdded: It is not active call. Call Id: "+e.id)}else if(o.getRemoteVideoContainer()&&!o.isActiveCallInVideoContainer(o.getRemoteVideoContainer(),e))return void r.debug("onRemoteStreamAdded: It is not active call. Call Id: "+e.id);t.stream&&(n=o.getRtcLibrary().getURLFromStream(t.stream),n&&(a=t.stream.getVideoTracks(),a&&a.length>0&&(s=!0),i=o.getDefaultVideoContainer()?o.useDefaultRenderer(n,!1,s):o.getRemoteVideoContainer()?o.createStreamRenderer(n,o.getRemoteVideoContainer()):!0),r.debug("onRemoteStreamAdded: "+n),i&&o.fireOnStreamAddedEvent(e,n))},o.iceCandidateCollectionTimeoutHandler=function(e){var t=e.peer.localDescription.sdp;return o.clearIceCandidateCollectionTimer(e),v.relayCandidateCollectionTimeoutCycle&&e.relayCandidateCycle++,H.hasCandidates(t,e.relayCandidateCycle,v.relayCandidateCollectionTimeoutCycle)?void(e.successCallback&&(r.debug("Ice candidate collection interrupted after given timeout, invoking successCallback."),t=H.updateH264Level(t),e.successCallback(t))):(r.debug("Re-setting ice candidate collection timeout: "+v.iceCandidateCollectionTimeoutInterval),void(e.iceCandidateCollectionTimer=setTimeout(function(){o.iceCandidateCollectionTimeoutHandler(e)},v.iceCandidateCollectionTimeoutInterval)))},o.setupIceCandidateCollectionTimer=function(e){v.iceCandidateCollectionTimeoutInterval&&(e.iceCandidateCollectionTimer?r.trace("Ice candidate collection timer exists."):(r.debug("Setting ice candidate collection timeout: "+v.iceCandidateCollectionTimeoutInterval),v.relayCandidateCollectionTimeoutCycle&&(e.relayCandidateCycle=1),e.iceCandidateCollectionTimer=setTimeout(function(){o.iceCandidateCollectionTimeoutHandler(e)},v.iceCandidateCollectionTimeoutInterval)))},o.onIceCandidate=function(e,t){var n;null===t.candidate?(r.debug("Null candidate received."),e.successCallback&&(n=H.getSdpFromObject(e.peer.localDescription),H.hasCandidates(n,e.relayCandidateCycle,v.relayCandidateCollectionTimeoutCycle)?(o.clearIceCandidateCollectionTimer(e),r.debug("Candidates received, invoking successCallback."),n=H.updateH264Level(n),e.successCallback(n)):r.trace("Sdp does not have candidates."))):r.debug("ICE candidate received : sdpMLineIndex = "+t.candidate.sdpMLineIndex+", candidate = "+t.candidate.candidate+" for call : "+e.id)},o.useDefaultRenderer=function(e,t,n){var i;return o.getDefaultVideoContainer()&&0===o.getDefaultVideoContainer().children.length&&(o.getDefaultVideoContainer().innerHTML="<div style='height:100%;width:100%'></div><div style='position:absolute;bottom:10px;right:10px;height:30%; width:30%;'></div>"),t?i=o.getDefaultVideoContainer().lastElementChild:(i=o.getDefaultVideoContainer().firstElementChild,n?i.style.width="100%":i.style.width="0%"),o.createStreamRenderer(e,i,{muted:t})},o.createStreamRenderer=function(e,t,n){var i;if(e&&t)return t.innerHTML="<object width='100%' height='100%' type='application/x-gcfwenabler-video'><param name='autoplay' value='true' /><param name='videosrc' value='"+e+"' /></object>",i},o.sendIntraFrame=function(e){e.peer&&o.canOriginatorSendLocalVideo(e)&&e.peer.sendIntraFrame()},o.sendBlackFrame=function(e){!e.peer},o.sendDTMF=function(e,t){var n;if(!e.dtmfSender){if(n=o.getLocalAudioTrack(e.peer),!n)return;if(e.dtmfSender=e.peer.createDTMFSender(n),!e.dtmfSender)return}e.dtmfSender.canInsertDTMF===!0?(e.dtmfSender.insertDTMF(t,400),r.info("sending outband DTMF tone: "+t)):r.error("Failed to execute 'insertDTMF' on 'RTCDTMFSender': The 'canInsertDTMF' attribute is false: this sender cannot send DTMF")},r.debug("WebRtcPluginAdaptor initialized")},ae=function(e,t,n){var i=t||X,o=n||new Q;return new re(e||new oe({},i,o),i,o,V)};l&&(l.WebRtcPluginAdaptor=ae);var se=function(e,t,n,i){var o=this,r={major:2,minor:1,min_revision:343,min_build:0,current_revision:376,current_build:0},a=i.getLogger("WebRtcPluginv21AdaptorImpl");a.debug("WebRtcPluginv21Adaptor initializing"),U.compose(e,o),U.compose(n,o),o.setPluginVersion(r),a.debug("WebRtcPluginv21Adaptor initialized")},ce=function(e,t,n){var i=t||X,o=n||new Q;return new se(e||new ae(void 0,i,o),i,o,V)};l&&(l.WebRtcPluginv21Adaptor=ce);var de=function(e,t,n,i){var o=this,r={major:2,minor:2,min_revision:477,min_build:0,current_revision:477,current_build:0},a=i.getLogger("WebRtcPluginv22AdaptorImpl");a.debug("WebRtcPluginv22Adaptor initializing"),U.compose(e,o),U.compose(n,o),o.setPluginVersion(r),a.debug("WebRtcPluginv22Adaptor initialized")},le=function(e,t,n){var i=t||X,o=n||new Q;return new de(e||new ae(void 0,i,o),i,o,V)};l&&(l.WebRtcPluginv22Adaptor=le);var ue=function(e,t,n,i){var o=this,r={major:3,minor:0,min_revision:498,min_build:0,current_revision:498,current_build:0},a=i.getLogger("WebRtcPluginv30AdaptorImpl");a.debug("WebRtcPluginv30Adaptor initializing"),U.compose(e,o),U.compose(n,o),o.setPluginVersion(r),o.sendDTMF=function(e,t){var n;if(!e.dtmfSender){if(n=o.getLocalAudioTrack(e.peer),!n)return;if(e.dtmfSender=e.peer.createDTMFSender(n),!e.dtmfSender)return}H.isSdpHasTelephoneEvent(e.peer.remoteDescription.sdp)?e.dtmfSender.canInsertDTMF===!0?(e.dtmfSender.insertDTMF(t,400),a.info("sending outband DTMF tone: "+t)):a.error("Failed to execute 'insertDTMF' on 'RTCDTMFSender': The 'canInsertDTMF' attribute is false: this sender cannot send DTMF"):(e.dtmfSender.insertDTMF(t,400,100,!0),a.info("sending inband DTMF tone: "+t))},a.debug("WebRtcPluginv30Adaptor initialized")},pe=function(e,t,n){var i=t||X,o=n||new Q;return new ue(e||new ae(void 0,i,o),i,o,V)};l&&(l.WebRtcPluginv30Adaptor=pe);var fe=function(e,t,n,i){var o=this,r=i.getLogger("WebRtcChromeAdaptorImpl");r.debug("WebRtcChromeAdaptor initializing"),U.compose(e,o),r.debug("WebRtcChromeAdaptor initialized")},Ee=function(e,t,n){var i=t||ne,o=n||new K;return new fe(e||new oe({},i,o),i,o,V)};l&&(l.WebRtcChromeAdaptor=Ee);var Se=function(e,t,n,i){var o=this,r=i.getLogger("WebRtcFirefoxAdaptorImpl");r.debug("WebRtcFirefoxAdaptor initializing"),U.compose(e,o),U.compose(n,o),o.performSdpWorkaroundsBeforeProcessingIncomingSdp=function(e){e.sdp=H.updateH264LevelTo42E01F(e.sdp,o.isH264Enabled()),e.sdp=H.deleteBandwidthLineFromSdp(e.sdp),e.sdp=H.addRtpmapForPCMU(e.sdp),e.sdp=H.addRtpmapForPCMA(e.sdp),e.sdp=H.removeG722Codec(e.sdp),e.sdp=H.fixRemoteTelephoneEventPayloadType(e,e.sdp),e.sdp=H.setOpusCodecToLowerCase(e.sdp)},o.getUserMedia=function(e,t){o.getRtcLibrary().checkMediaSourceAvailability(function(n){var i;o.setMediaSources(n),i=o.getMediaVideo()&&o.getVideoSourceAvailable()?{mandatory:{maxWidth:o.getVideoWidth(),maxHeight:o.getVideoHeight(),minWidth:o.getVideoWidth(),minHeight:o.getVideoHeight()}}:!1,o.getRtcLibrary().getUserMedia({audio:o.getMediaAudio(),video:i},function(t){var n,i={};r.debug("user has granted access to local media."),o.setUserMediaStream(t),i.audioContext={close:function(){}},i.mediaStreamDestination={disconnect:function(){}},i.stream=t,o.getLocalStreamMap().add(i.stream.id,i),o.setInitialized(!0),n={audio:o.getMediaAudio(),video:o.getMediaVideo()&&o.getVideoSourceAvailable(),id:i.stream.id},r.debug("user has granted access to local media: ",i),U.callFunctionIfExist(e,n)},function(e){r.debug("Failed to get access to local media. Error code was "+e.code),U.callFunctionIfExist(t,E.call.MediaErrors.NOT_ALLOWED)})})},o.createOffer=function(e,t,n,i){r.debug("createOffer: sendInitialVideo= "+i+" state= "+e.peer.signalingState);var a=e.peer;e.peer.addStream(e.localMedia.stream),o.addCallIdInPluginContainer(e),a.createOffer(function(t){i=i&&o.getVideoSourceAvailable(),i?t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),t.sdp=H.deleteCryptoZeroFromSdp(t.sdp),t.sdp=H.updateAudioCodec(t.sdp),t.sdp=H.removeG722Codec(t.sdp),t.sdp=H.deleteCryptoFromSdp(t.sdp,o.isDtlsEnabled()),t.sdp=H.setTcpSetupAttributeToActpass(t.sdp,o.isDtlsEnabled()),t.sdp=H.fixLocalTelephoneEventPayloadType(e,t.sdp),t=o.performSdpWorkaroundsAfterCreateOffer(e,t),a.setLocalDescription(o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,t.sdp),function(){},function(e){r.error("createOffer: setLocalDescription failed : "+e),U.callFunctionIfExist(n,"createOffer: setLocalDescription failed")})},function(e){r.error("createOffer: createOffer failed!! "+e),U.callFunctionIfExist(n)},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},o.createReOffer=function(e,t,n,i){var a,s,c,d=e.peer,l=e.peer.localDescription.sdp;r.debug("createReOffer:"+e.id),o.createNewPeerForCall(e)&&(d=e.peer),d.createOffer(function(t){c=H.getVideoSdpDirection(l),t.sdp=H.updateVideoSdpDirection(t.sdp,c),i&&(s=H.getAudioSdpDirection(l),t.sdp=H.updateAudioSdpDirection(t.sdp,s)),t.sdp=H.deleteCryptoZeroFromSdp(t.sdp),t.sdp=H.updateAudioCodec(t.sdp),t.sdp=H.removeG722Codec(t.sdp),t.sdp=H.deleteCryptoFromSdp(t.sdp,o.isDtlsEnabled()),t.sdp=H.setTcpSetupAttributeToActpass(t.sdp,o.isDtlsEnabled()),t.sdp=H.fixLocalTelephoneEventPayloadType(e,t.sdp),t.sdp=H.updateVersion(l,t.sdp),t=o.performSdpWorkaroundsAfterCreateOffer(e,t),a=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,t.sdp),d.setLocalDescription(a,function(){r.debug("createReOffer: setLocalDescription success"+e.id)},function(t){r.debug("createReOffer: setLocalDescription failed!!"+t+e.id),U.callFunctionIfExist(n)})},function(e){r.error("createReOffer: createOffer failed!! "+e),U.callFunctionIfExist(n)},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},o.processAnswer=function(e,t,n){var i,a,s,c=e.peer;r.debug("processAnswer: state= "+c.signalingState),o.setTcpSetupAttiributesOnProcessAnswer(e,e.sdp),e.sdp=H.checkSupportedVideoCodecs(e.sdp,c.localDescription.sdp,o.isH264Enabled()),e.sdp=H.performVideoPortZeroWorkaround(e.sdp),i=H.getVideoSdpDirection(e.sdp),a=H.getVideoSdpDirection(e.peer.localDescription.sdp),s=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),c.setRemoteDescription(s,function(){r.debug("processAnswer: setRemoteDescription success"),e.remoteVideoState=H.getVideoSdpDirection(e.sdp),e.videoOfferSent=H.isSdpHasVideo(e.sdp),U.callFunctionIfExist(t)},function(e){r.error("processAnswer: setRemoteDescription failed: "+e.message),U.callFunctionIfExist(n)})},o.revertRtcState=function(e,t,n){setTimeout(function(){U.callFunctionIfExist(t,e)},0)},o.createHoldUpdate=function(e,t,n,i,a){r.debug("createHoldUpdate: local hold= "+t+" remote hold= "+n+" state= "+e.peer.signalingState);var s,c,d,l,u,p,E=e.peer;u=function(){s=H.getAudioSdpDirection(e.stableLocalSdp),c=H.getVideoSdpDirection(e.stableLocalSdp),o.createNewPeerForCall(e)&&(E=e.peer),E.createOffer(function(i){i.sdp=H.incrementVersion(i.sdp),i.sdp=H.setTcpSetupAttributeToActpass(i.sdp,o.isDtlsEnabled()),i=o.performSdpWorkaroundsAfterCreateOffer(e,i),t||n?(s===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE?i.sdp=H.updateAudioSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY):!t&&n?i.sdp=H.updateAudioSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):i.sdp=H.updateAudioSdpDirectionToInactive(i.sdp),c===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE?i.sdp=H.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY):!t&&n?i.sdp=H.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):i.sdp=H.updateVideoSdpDirectionToInactive(i.sdp),d=!0):(i.sdp=H.updateAudioSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE),o.canOriginatorSendLocalVideo(e)?i.sdp=H.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):i.sdp=H.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),d=!1),i.sdp=H.fixLocalTelephoneEventPayloadType(e,i.sdp),l=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,i.sdp),E.setLocalDescription(l,function(){r.debug("createHoldUpdate: setLocalDescription success"),o.muteOnHold(e,d)},function(e){r.error("createHoldUpdate: setLocalDescription failed: "+e.message),U.callFunctionIfExist(a)})},function(e){r.error("createHoldUpdate: createOffer failed: "+e.message),U.callFunctionIfExist(a)},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},p=H.isSdpHasVideo(e.sdp)&&!H.isVideoSdpDirectionInactive(E.localDescription.sdp),!e.isVideoSourceAllowed&&p?(o.setMediaAudio(!0),o.setMediaVideo(!0),o.getUserMedia(function(t){o.storeLocalStreamToCall(e,t.id),e.isVideoSourceAllowed=t.video,u()},function(){U.callFunctionIfExist(a)})):(p&&(e.isVideoSourceAllowed=!0),u())},o.processHold=function(e,t,n,i,a){r.debug("processHold: local hold= "+n+" remote hold= "+t+" state= "+e.peer.signalingState);var s,c,d,l=e.peer;n||t||o.muteOnHold(e,!1),d=H.getAudioSdpDirection(e.sdp),e.sdp=H.checkSupportedVideoCodecs(e.sdp,null),e.sdp=H.performVideoPortZeroWorkaround(e.sdp),e.sdp=H.setTcpSetupAttributeToActpass(e.sdp,o.isDtlsEnabled()),c=e.prevRemoteSdp,s=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),o.createNewPeerForCall(e)&&(l=e.peer),l.setRemoteDescription(s,function(){l.createAnswer(function(i){r.debug("processHold: isSdpEnabled audio= "+H.isAudioSdpEnabled(i.sdp)),r.debug("processHold: isSdpEnabled video= "+H.isVideoSdpEnabled(i.sdp)),t?(r.debug("processHold: Remote HOLD"),i.sdp=H.respondToRemoteSdpDirections(i.sdp,e.sdp)):n?n&&!t&&(r.debug("processHold: Remote UNHOLD on local hold"),d===f.WEBRTC.MEDIA_STATE.INACTIVE?i.sdp=H.updateAudioSdpDirectionToInactive(i.sdp):i.sdp=H.updateAudioSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY),o.canOriginatorSendLocalVideo(e)?i.sdp=H.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY):i.sdp=H.updateVideoSdpDirectionToInactive(i.sdp)):(r.debug("processHold: Remote UNHOLD: direction left as it is"),H.isSdpVideoSendEnabled(e.sdp)?o.canOriginatorSendLocalVideo(e)?i.sdp=H.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):i.sdp=H.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY):o.canOriginatorSendLocalVideo(e)&&!H.isVideoSdpDirectionInactive(e.sdp)?i.sdp=H.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY):i.sdp=H.updateVideoSdpDirection(i.sdp,f.WEBRTC.MEDIA_STATE.INACTIVE),i.sdp=H.changeDirection(i.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.AUDIO)),i.sdp=H.setTcpSetupAttributeTo(i.sdp,e.localTcpSetupAttribute,o.isDtlsEnabled()),l.setLocalDescription(i,function(){r.debug("processHold: setLocalDescription succeeded")},function(e){r.error("processHold: setLocalDescription failed!! "+e),U.callFunctionIfExist(a,"Session cannot be created")})},function(){r.debug("FAIL")})},function(e){r.error("processHold: setRemoteDescription failed: "+e.message),U.callFunctionIfExist(a,"Session cannot be created")})},o.processHoldRespond=function(e,t,n,i){var a,s,c,d,l=!1,u=!1;return r.debug("processHoldRespond: state= "+e.peer.signalingState+" call.currentState= "+e.currentState),e.sdp=H.checkSupportedVideoCodecs(e.sdp,e.peer.localDescription.sdp,o.isH264Enabled()),H.init(e.sdp),u=H.isRemoteHold(),l="LOCAL_HOLD"===e.currentState,l||o.addCallIdInPluginContainer(e),a=H.getAudioSdpDirection(e.sdp),s=H.getVideoSdpDirection(e.sdp),e.remoteVideoState=s,c=H.getVideoSdpDirection(e.peer.localDescription.sdp),r.debug("processHoldRespond: localHold= "+l+" remoteHold= "+u),u===!1?a===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE&&"REMOTE_HOLD"===e.currentState&&(r.debug("set current web state to COMPLETED"),e.previousState=e.currentState,e.currentState="COMPLETED"):"COMPLETED"===e.currentState&&(r.debug("set current web state to REMOTE_HOLD"),e.previousState=e.currentState,e.currentState="REMOTE_HOLD"),(l||u)&&(r.debug("processHoldRespond: "+e.currentState+" : video -> inactive"),e.sdp=H.updateVideoSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.INACTIVE)),l&&(H.getAudioSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE&&(e.sdp=H.updateAudioSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)),H.getVideoSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.SEND_RECEIVE&&(e.sdp=H.updateVideoSdpDirection(e.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY))),i&&o.muteOnHold(e,!1),e.peer.signalingState===f.WEBRTC.RTC_SIGNALING_STATE.STABLE?void U.callFunctionIfExist(t):((H.getVideoSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.INACTIVE||H.getVideoSdpDirection(e.sdp)===f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY)&&(e.sdp=H.deleteInactiveVideoSsrc(e.sdp)),d=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),void e.peer.setRemoteDescription(d,function(){r.debug("processHoldRespond: setRemoteDescription typeAns success"),U.callFunctionIfExist(t)},function(e){r.debug("processHoldRespond: setRemoteDescription typeAns failed: "+e),U.callFunctionIfExist(n)}))},o.createUpdate=function(e,t,n,i){r.debug("createUpdate: isVideoStart= "+i+" state= "+e.peer.signalingState);var a,s,c=e.peer;a=e.peer.localDescription.sdp,a=H.fixLocalTelephoneEventPayloadType(e,a),a=H.incrementVersion(a),r.debug("create new offer to start the video"),o.createNewPeerForCall(e)&&(c=e.peer),o.setMediaVideo(!0),c.createOffer(function(t){i=i&&o.getVideoSourceAvailable(),i?t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):H.isVideoSdpDirectionInactive(e.stableRemoteSdp)?t.sdp=H.updateVideoSdpDirectionToInactive(t.sdp):t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY),t.sdp=H.setTcpSetupAttributeToActpass(t.sdp,o.isDtlsEnabled()),t.sdp=H.fixLocalTelephoneEventPayloadType(e,t.sdp),t.sdp=H.deleteCryptoZeroFromSdp(t.sdp),t.sdp=H.updateAudioCodec(t.sdp),t.sdp=H.removeG722Codec(t.sdp),t.sdp=H.deleteCryptoFromSdp(t.sdp,o.isDtlsEnabled()),t=o.performSdpWorkaroundsAfterCreateOffer(e,t),s=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,t.sdp),c.setLocalDescription(s,function(){r.debug("createUpdate: createOffer setLocalDescription success ")},function(e){r.debug("createUpdate: createOffer setLocalDescription failed: "+e),U.callFunctionIfExist(n)})},function(e){r.debug("createUpdate: createOffer failed!!: "+e),n()},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},o.processUpdate=function(e,t,n){r.debug("processUpdate: state= "+e.peer.signalingState);var i,a,s,c,d,l=e.peer;e.sdp=H.addSdpMissingCryptoLine(e.sdp),e.sdp=H.checkAndRestoreICEParams(e.sdp,e.stableLocalSdp),i=H.getVideoSdpDirection(e.sdp),a=H.getVideoSdpDirection(e.stableLocalSdp),e.sdp=H.checkSupportedVideoCodecs(e.sdp,null,o.isH264Enabled()),e.sdp=H.setTcpSetupAttributeToActpass(e.sdp,o.isDtlsEnabled()),d=e.stableLocalSdp,o.createNewPeerForCall(e)&&(l=e.peer),s=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.OFFER,e.sdp),l.setRemoteDescription(s,function(){r.debug("processUpdate: setRemoteDescription success"),e.remoteVideoState=H.getVideoSdpDirection(e.sdp),l.createAnswer(function(t){r.debug("processUpdate: isSdpEnabled audio= "+H.isAudioSdpEnabled(t.sdp)),r.debug("processUpdate: isSdpEnabled video= "+H.isVideoSdpEnabled(t.sdp)),H.isSdpVideoSendEnabled(e.sdp)?o.canOriginatorSendLocalVideo(e)?t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE):t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY):o.canOriginatorSendLocalVideo(e)&&!H.isVideoSdpDirectionInactive(e.sdp)?t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.SEND_ONLY):t.sdp=H.updateVideoSdpDirection(t.sdp,f.WEBRTC.MEDIA_STATE.INACTIVE),t.sdp=H.updateVersion(d,t.sdp),t.sdp=H.fixLocalTelephoneEventPayloadType(e,t.sdp),t.sdp=H.checkIceParamsLengths(t.sdp,s.sdp),t.sdp=H.setTcpSetupAttributeTo(t.sdp,e.localTcpSetupAttribute,o.isDtlsEnabled()),c=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,t.sdp),l.setLocalDescription(c,function(){r.debug("processUpdate: setlocalDescription success")},function(e){r.debug("processUpdate: setlocalDescription failed!!"+e),U.callFunctionIfExist(n,"processUpdate: setlocalDescription failed!!")})},function(e){r.debug("processUpdate: createAnswer failed!! "+e),U.callFunctionIfExist(n,"Session cannot be created")},{mandatory:{OfferToReceiveAudio:o.getMediaAudio(),OfferToReceiveVideo:o.getMediaVideo()}})},function(e){r.debug("processUpdate: setRemoteDescription failed!!"+e),U.callFunctionIfExist(n,"processUpdate: setRemoteDescription failed!!")})},o.processRespond=function(e,t,n,i){var a,s,c=e.peer;return r.debug("processRespond: state= "+e.peer.signalingState),e.sdp=H.checkSupportedVideoCodecs(e.sdp,c.localDescription.sdp,o.isH264Enabled()),a=H.getVideoSdpDirection(e.sdp),e.remoteVideoState=H.getVideoSdpDirection(e.sdp),i&&(e.sdp=H.changeDirection(e.sdp,f.WEBRTC.MEDIA_STATE.RECEIVE_ONLY,f.WEBRTC.MEDIA_STATE.SEND_RECEIVE,f.STRING.AUDIO),o.muteOnHold(e,!1)),e.peer.signalingState===f.WEBRTC.RTC_SIGNALING_STATE.STABLE?void U.callFunctionIfExist(t):(s=o.getRtcLibrary().createRTCSessionDescription(f.WEBRTC.RTC_SDP_TYPE.ANSWER,e.sdp),void c.setRemoteDescription(s,function(){r.debug("processRespond: setRemoteDescription success"),e.remoteVideoState=H.getVideoSdpDirection(e.sdp),e.videoOfferSent=!0,U.callFunctionIfExist(t)},function(e){r.debug("processRespond: setRemoteDescription failed: "+e),U.callFunctionIfExist(n)}))},o.sendDTMF=function(e,t){r.debug("DMTF IS NOT SUPPORTED FOR FIREFOX")},o.iceCandidateCollectionTimeoutHandler=function(e){var t=e.peer.localDescription.sdp;return o.clearIceCandidateCollectionTimer(e),v.relayCandidateCollectionTimeoutCycle&&e.relayCandidateCycle++,H.hasCandidates(t,e.relayCandidateCycle,v.relayCandidateCollectionTimeoutCycle)?void(e.successCallback&&(r.debug("Ice candidate collection interrupted after given timeout, invoking successCallback."),t=H.deleteCurlyBracketsSDP(t),o.isH264Enabled()||(t=H.removeH264Codec(t)),H.isSdpHasUfrag(t)||(t=H.checkAndRestoreICEParams(t,e.stableLocalSdp),r.debug("Absent ufrag due to inactive video direction is restored from that in stable local sdp")),e.successCallback(t))):(r.debug("Re-setting ice candidate collection timeout: "+v.iceCandidateCollectionTimeoutInterval),void(e.iceCandidateCollectionTimer=setTimeout(function(){o.iceCandidateCollectionTimeoutHandler(e)},v.iceCandidateCollectionTimeoutInterval)))},o.setupIceCandidateCollectionTimer=function(e){v.iceCandidateCollectionTimeoutInterval&&(e.iceCandidateCollectionTimer?r.trace("Ice candidate collection timer exists."):(r.debug("Setting ice candidate collection timeout: "+v.iceCandidateCollectionTimeoutInterval),v.relayCandidateCollectionTimeoutCycle&&(e.relayCandidateCycle=1),e.iceCandidateCollectionTimer=setTimeout(function(){o.iceCandidateCollectionTimeoutHandler(e)},v.iceCandidateCollectionTimeoutInterval)))},o.onIceCandidate=function(e,t){var n;null===t.candidate?(r.debug("Null candidate received."),e.successCallback&&(n=e.peer.localDescription.sdp,o.clearIceCandidateCollectionTimer(e),r.debug("Candidates received, invoking successCallback."),n=H.deleteCurlyBracketsSDP(n),o.isH264Enabled()||(n=H.removeH264Codec(n)),H.isSdpHasUfrag(n)||(n=H.checkAndRestoreICEParams(n,e.stableLocalSdp),r.debug("Absent ufrag due to inactive video direction is restored from that in stable local sdp")),e.successCallback(n))):r.debug("ICE candidate received: sdpMLineIndex = "+t.candidate.sdpMLineIndex+", candidate = "+t.candidate.candidate+" for call : "+e.id)},o.onIceComplete=function(e){var t;r.debug("All ICE candidates received for call : "+e.id),o.clearIceCandidateCollectionTimer(e),e.successCallback&&(t=e.peer.localDescription.sdp,t=H.deleteCurlyBracketsSDP(t),o.isH264Enabled()||(t=H.removeH264Codec(t)),H.isSdpHasUfrag(t)||(t=H.checkAndRestoreICEParams(t,e.stableLocalSdp),r.debug("Absent ufrag due to inactive video direction is restored from that in stable local sdp")),r.debug("onIceComplete sdp : "+t),e.successCallback(t))},o.createNewPeerForCall=function(e){var t=!1,n=o.getPeerCount();return e.peer&&(e.peer.close(),
o.setPeerCount(n-1)),r.trace("Creating new peer for call: "+e.id),o.createPeer(e,function(){r.trace("New peer has created for call: "+e.id),e.peer.addStream(e.localMedia.stream),t=!0},function(){r.error("New peer creation has failed!: "+e.id)}),t},o.createPeer=function(e,t,n){try{var i,a,s,c,d=[],l=o.getIceServerUrl();if(l instanceof Array)for(s=0;s<l.length;s++)d[s]=l[s];else null===l||""===l?d=[]:d[0]=l;c={iceServers:d},a={optional:[{DtlsSrtpKeyAgreement:o.isDtlsEnabled()}]},i=o.getRtcLibrary().createRTCPeerConnection(c,a),o.setPeerCount(o.getPeerCount()+1),e.peer=i,i.onconnecting=function(t){o.onSessionConnecting(e,t)},i.onopen=function(t){o.onSessionOpened(e,t)},i.onsignalingstatechange=function(t){o.onSignalingStateChange(e,t)},i.onaddstream=function(t){o.onRemoteStreamAdded(e,t)},i.onremovestream=function(t){o.onRemoteStreamRemoved(e,t)},i.onicecandidate=function(t){o.setupIceCandidateCollectionTimer(e),o.onIceCandidate(e,t)},i.onicecomplete=function(){o.onIceComplete(e)},i.oniceconnectionstatechange=function(t){o.oniceconnectionstatechange(e,t)},r.info("create PeerConnection successfully."),t(e)}catch(u){r.error("Failed to create PeerConnection, exception: "+u.message),n()}},r.debug("WebRtcFirefoxAdaptor initialized")},Te=function(e,t,n){var i=t||ee,o=n||new z;return new Se(e||new oe({},i,o),i,o,V)};l&&(l.WebRtcFirefoxAdaptor=Te);var ge=function(e,t,n,i,o,r,a,s){function c(){var e,n,i;return t.webkitGetUserMedia?(e=S.CHROME,i=new RegExp(/\Chrome\/(\d*)/)):t.mozGetUserMedia?(e=S.FIREFOX,i=new RegExp(/\Firefox\/(\d*)/)):e=S.PLUGIN,i&&t.userAgent&&(n=parseInt(t.userAgent.match(i).pop(),10)),{type:e,version:n}}function d(e){var t;if(!e||!e.pluginMode)return T.AUTO;for(t in T)if(T[t]===e.pluginMode)return T[t];return T.AUTO}function u(e){var t,n,i,o,r,a=T.AUTO,s=!1,c=v.pluginMode[e.type];c?(r=new RegExp(/^\d+\+$/),c.version&&r.test(c.version)&&(n=parseInt(c.version.replace(/\+/,""),10)),i=e.version,c.mode&&(!n||i>=n)?a=c.mode:v.pluginMode.mode&&(a=v.pluginMode.mode),t="undefined"!=typeof c.h264&&(!n||i>=n)?c.h264:v.pluginMode.h264):(a=v.pluginMode.mode,t=v.pluginMode.h264);for(o in R)R[o]===a&&(s=!0);return s||(a=T.AUTO),t!==!0&&t!==!1&&(t=void 0),{pluginMode:a,h264Enabled:t}}function p(e,t){var n=d(e);return C[t.type][n]||n}var f,E=n.getLogger("WebRtcAdaptorFactory"),S={CHROME:"chrome",FIREFOX:"firefox",PLUGIN:"plugin"},T={WEBRTCH264:"webrtch264",WEBRTC22:"webrtc22",WEBRTC21:"webrtc21",WEBRTC:"webrtc",AUTO:"auto",AUTO21:"auto21",AUTO22:"auto22",AUTOH264:"autoh264",AUTOFIREFOX:"autofirefox"},g=T.WEBRTCH264,m=r,C={chrome:{webrtc:g,autofirefox:T.AUTO,autoh264:T.AUTO,webrtch264:T.WEBRTCH264},firefox:{webrtc:g,auto:g,auto21:T.WEBRTC21,auto22:T.WEBRTC22,autoh264:T.WEBRTCH264,autofirefox:T.AUTO},plugin:{auto:g,auto21:T.WEBRTC21,auto22:T.WEBRTC22,autoh264:T.WEBRTCH264,autofirefox:g,webrtc:g}},I={chrome:{auto:a,autoh264:a,webrtc21:i,webrtc22:o,webrtch264:r},firefox:{auto:s,webrtc21:i,webrtc22:o,webrtch264:r},plugin:{webrtc21:i,webrtc22:o,webrtch264:r}},R={WEBRTC:"webrtc",AUTO:"auto"},D={chrome:{auto:a,webrtc:m},firefox:{auto:s,webrtc:m},plugin:{auto:m,webrtc:m}};l&&(this.getNavigatorType=c),this.getWebRtcAdaptor=function(t){var n,i,o,r,a=c();return v.pluginMode?(o=u(a),f=o.pluginMode,r=o.h264Enabled,n=D[a.type][f]):(f=p(t,a),n=I[a.type][f]),n||(E.debug("Invalid Plugin Mode Detected, Treated as WEBRTC"),f=g,n=m),E.debug("Adaptor initializing from "+a+" browser and "+f+" plugIn mode"),e.pluginMode=f,i=new n,"undefined"!=typeof r&&i.setH264Enabled(r),i},this.getPluginModes=function(){return T},this.getDefaultRtcPluginMode=function(){return g},this.getDefaultRtcAdaptor=function(){return m}},me=new ge(window,navigator,V,ce,le,pe,Ee,Te);l&&(l.WebRtcAdaptorFactory=ge);var Ce=function(e,t,n,i){function o(e){d=e}function r(e){var t,n;if(e instanceof Array)for(t=0;t<e.length;t++)n=e[t].url.substring(0,e[t].url.indexOf(":")),("turn"===n||"turns"===n)&&(e[t].credential=d.credential,e[t].username=d.username);return e}function a(e,t){e.successCallback=t}function s(e){e.successCallback=null}var c,d,u=this,p=t.getLogger("WebRtcManager");u.canOriginatorSendLocalVideo=function(e){return c.canOriginatorSendLocalVideo(e)},u.canOriginatorReceiveRemoteVideo=function(e){return c.canOriginatorReceiveRemoteVideo(e)},u.initMedia=function(t,n,i){var o="";p.info("Initializing media for call"),c=e.getWebRtcAdaptor(i),i&&(i.iceserver&&(o=i.iceserver,d&&(o=r(o)),c.setIceServerUrl(o)),i.webrtcdtls&&c.setDtlsEnabled(i.webrtcdtls),i.localVideoContainer&&c.setLocalVideoContainer(i.localVideoContainer),i.remoteVideoContainer&&c.setRemoteVideoContainer(i.remoteVideoContainer),i.videoContainer&&c.setDefaultVideoContainer(i.videoContainer)),c.initMedia(t,n,i)},u.getUserMedia=function(e,t,n){var o;p.info("getting user media for call: started - userAgent: "+i.userAgent),n&&(void 0!==n.audio&&c.setMediaAudio(n.audio),void 0!==n.video&&c.setMediaVideo(n.video),n.videoResolution&&(o=n.videoResolution.split("x"),o[0]&&o[1]&&(c.setVideoWidth(o[0]),c.setVideoHeight(o[1])))),c.getUserMedia(e,t)},u.startScreenMedia=function(e,t,n,o){p.info("getting screen media for call: started - userAgent: "+i.userAgent),n&&(n.width&&c.setScreenWidth(n.width),n.height&&c.setScreenHeight(n.height),n.frameRate&&c.setScreenFrameRate(n.frameRate)),c.startScreenMedia(e,t,o)},u.stopScreenMedia=function(){c.stopScreenMedia()},u.createOffer=function(e,t,n,i){p.info("create offer SDP: sendInitialVideo= "+i);var o=function(n){s(e),c.setOriginatorSendLocalVideo(e,i),"function"==typeof t&&t(n)};a(e,o),e.peer||c.createPeer(e,function(){c.createOffer(e,o,function(t){s(e),"function"==typeof n&&n(t)},i)},function(){U.callFunctionIfExist(n,2)})},u.createAnswer=function(e,t,n,i){p.info("creating answer SDP: callid= "+e.id),p.info("creating answer SDP: isVideoEnabled= "+i);var o=function(n){s(e),c.setOriginatorSendLocalVideo(e,i),c.setOriginatorReceiveRemoteVideo(e),"function"==typeof t&&t(n)};a(e,o),e.peer||c.createPeer(e,function(){c.performSdpWorkaroundsBeforeProcessingIncomingSdp(e),c.createAnswer(e,o,function(t){s(e),"function"==typeof n&&n(t)},i)},function(){U.callFunctionIfExist(n,2)})},u.processAnswer=function(e,t,n){if(e.peer){var i=function(){s(e),c.setOriginatorReceiveRemoteVideo(e),"function"==typeof t&&t()};a(e,i),c.performSdpWorkaroundsBeforeProcessingIncomingSdp(e),c.processAnswer(e,i,function(t){s(e),"function"==typeof n&&n(t)})}},u.processRespond=function(e,t,n,i){if(e.peer){var o=function(){s(e),c.setOriginatorReceiveRemoteVideo(e),"function"==typeof t&&t()};a(e,o),c.performSdpWorkaroundsBeforeProcessingIncomingSdp(e),c.processRespond(e,o,function(t){s(e),"function"==typeof n&&n(t)},i)}},u.createUpdate=function(e,t,n,i){if(p.info("createUpdate: isVideoStart= "+i),e.peer){var o=function(n){s(e),c.setOriginatorSendLocalVideo(e,i),"function"==typeof t&&t(n)};a(e,o),c.storeStableRemoteAndLocalSdpInCall(e),c.createUpdate(e,o,n,i)}},u.processUpdate=function(e,t,n,i){if(p.info("processUpdate: local_hold_status:"+i),e.peer){var o=function(n){s(e),c.setOriginatorReceiveRemoteVideo(e),"function"==typeof t&&t(n)};a(e,o),c.performSdpWorkaroundsBeforeProcessingIncomingSdp(e),c.storeStableRemoteAndLocalSdpInCall(e),c.processUpdate(e,o,function(t){s(e),"function"==typeof n&&n(t)},i)}},u.createReOffer=function(e,t,n,i){if(e.peer){var o=function(n){s(e),"function"==typeof t&&t(n)};a(e,o),c.createReOffer(e,o,function(t){s(e),"function"==typeof n&&n(t)},i)}},u.createHoldUpdate=function(e,t,n,i,o){if(p.info("create hold update local hold= "+t+" remote hold= "+n),e.peer){var r=function(t){s(e),"function"==typeof i&&i(t)};a(e,r),c.storeStableRemoteAndLocalSdpInCall(e),c.createHoldUpdate(e,t,n,r,function(t){s(e),"function"==typeof o&&o(t)})}},u.processRemoteOfferOnLocalHold=function(e,t,n){if(e.peer){var i=function(n){s(e),"function"==typeof t&&t(n)};a(e,i),c.processRemoteOfferOnLocalHold(e,i,function(t){s(e),"function"==typeof n&&n(t)})}},u.processEnd=function(e){e.peer&&c.processEnd(e)},u.processHold=function(e,t,n,i,o){if(p.info("processHold: local hold= "+n+" remote hold= "+t),e.peer){var r=function(t){s(e),c.setOriginatorReceiveRemoteVideo(e),"function"==typeof i&&i(t)};a(e,r),c.performSdpWorkaroundsBeforeProcessingIncomingSdp(e),c.storeStableRemoteAndLocalSdpInCall(e),c.processHold(e,t,n,r,function(t){s(e),"function"==typeof o&&o(t)})}},u.processHoldRespond=function(e,t,n,i){if(p.info("Processing response to hold offer sent"),e.peer){var o=function(){s(e),c.setOriginatorReceiveRemoteVideo(e),"function"==typeof t&&t()};a(e,o),c.performSdpWorkaroundsBeforeProcessingIncomingSdp(e),c.processHoldRespond(e,o,function(t){s(e),"function"==typeof n&&n(t)},i)}},u.processPreAnswer=function(e){p.info("processing preanswer from the offer we sent"),e.peer&&c.processPreAnswer(e)},u.revertRtcState=function(e,t,n){c.revertRtcState(e,t,n)},u.getRemoteVideoResolutions=function(){return c.getRemoteVideoResolutions()},u.getLocalVideoResolutions=function(){return c.getLocalVideoResolutions()},u.isAudioSourceAvailable=function(){return c.getAudioSourceAvailable()},u.isVideoSourceAvailable=function(){return c.getVideoSourceAvailable()},u.refreshVideoRenderer=function(){c.refreshVideoRenderer()},u.sendIntraFrame=function(e){c.sendIntraFrame(e)},u.sendBlackFrame=function(e){c.sendBlackFrame(e)},u.muteAudioTrack=function(e,t){return c.muteAudioTrack(e,t)},u.addLocalStream=function(e){c.addLocalStream(e)},u.isPluginEnabled=function(){return c.isPluginEnabled()},u.sendDTMF=function(e,t){c.sendDTMF(e,t)},u.showSettingsWindow=function(){c.showSettingsWindow()},u.createStreamRenderer=function(e,t,n){return c.createStreamRenderer(e,t,n)},u.disposeStreamRenderer=function(e){c.disposeStreamRenderer(e)},u.set_logSeverityLevel=function(e){c.set_logSeverityLevel(e)},u.enable_logCallback=function(){c.enable_logCallback()},u.disable_logCallback=function(){c.disable_logCallback()},u.get_audioInDeviceCount=function(){c.get_audioInDeviceCount()},u.get_audioOutDeviceCount=function(){c.get_audioOutDeviceCount()},u.get_videoDeviceCount=function(){c.get_videoDeviceCount()},u.storeLocalStreamToCall=function(e,t){c.storeLocalStreamToCall(e,t)},n.subscribe(f.EVENT.TURN_CREDENTIALS_ESTABLISHED,o),l&&(u.setRtcLibrary=function(e){c=e})},Ie=new Ce(me,V,p,navigator);l&&(l.WebRtcManager=Ce);var ve=function(e,t){function n(){return v.notificationType===E.notification.NotificationTypes.WEBSOCKET&&window.WebSocket?{notificationType:"WebSocket",clientIp:v.clientIp}:(v.notificationType="longpolling",{notificationType:"LongPolling",pollingTimer:v.polling})}function o(e){var t,n=[];for(t in s)s.hasOwnProperty(t)&&-1!==e.indexOf(t)&&n.push(s[t]);return n}function r(e,t){var i,r,a=n();E.notification.isAnonymous()?v.anonymousServices||(v.anonymousServices=p):v.services||(v.services=u),r={expires:Math.floor(v.expires),service:o(E.notification.isAnonymous()?v.anonymousServices:v.services),localization:"English_US"},t&&v.serverProvidedTurnCredentials&&(r.useTurn=v.serverProvidedTurnCredentials===!0?!0:!1),e===!0&&(r.forceLogOut="true");for(i in a)a.hasOwnProperty(i)&&(r[i]=a[i]);return r}var a="/subscription",s={CallControl:"call",call:"call",IM:"IM",Presence:"Presence",custom:"custom",callMe:"callMe"},u=[s.IM,s.Presence,s.CallControl],p=[s.callMe],S=3600;this.extendSubscription=function(t,n,i){0===v.expires&&(v.expires=S),e.sendPutRequest({url:c()+t,data:{subscribeRequest:r()}},function(e){var t=e.subscribeResponse,i=t.subscriptionParams;n(i.notificationChannel,i.assignedService,i.service)},i)},this.retrieveNotification=function(t,n,i){return e.sendGetRequest({url:c()+t},function(e){var t,i=null;null!==e&&(t=e.notificationMessage,t&&(i=t.eventType)),n(i,t)},i)},this.subscribe=function(n,o,s,c){var l,u=i();v.expires=S,e.sendPostRequest({url:d(1,a+(u?"?tokenrealm="+u:"")),data:{subscribeRequest:r(s,!0)}},function(e){var i,o=e.subscribeResponse,r=o.subscriptionParams;r.turnActive===!0&&r.turnCredentials&&r.turnCredentials.username&&r.turnCredentials.password&&(i={username:r.turnCredentials.username,credential:r.turnCredentials.password},t.publish(f.EVENT.TURN_CREDENTIALS_ESTABLISHED,i)),n(o.subscription,r.notificationChannel,r.expires,r.pollingTimer,r.assignedService,r.service,r.sessionId)},o,l,l,l,l,c)},this.deleteSubscription=function(t,n,i,o){e.sendDeleteRequest({url:c()+t},n,i)},l&&(this.composeSubscribeRequestData=r)},Re=function(e,t){return new ve(e||I,t||p)},De=new Re;l&&(l.NotificationService=Re);var Ae={},_e=function(e,t,n,i,o){function r(e){Re=e.token}function a(){Ie&&(J.trace("aborting last long polling request."),Ie.abort(),Ie=null)}function s(){se=null,Se=!1,o.removeItem(Ce+z),o.removeItem(Ce+Q),o.removeItem(Ce+K),o.removeItem(Ce+Z),o.removeItem(Ce+X),o.removeItem(Ce+ee),this.onGoneNotificationReceived(),a()}function c(e){i.publish(f.EVENT.DEVICE_SUBSCRIPTION_STARTED,e)}function d(){i.publish(f.EVENT.DEVICE_SUBSCRIPTION_ENDED)}function u(){if(me.length>0){var e=me.shift();J.info("notification events queue clearing audit timer has expired, removing first eventId: "+e)}}function p(){var e;for(e in de.NotificationTypes)if(de.NotificationTypes.hasOwnProperty(e)&&v.notificationType===de.NotificationTypes[e])return v.notificationType;return de.NotificationTypes.WEBSOCKET}function S(){return p()===de.NotificationTypes.LONGPOLLING}function T(){return t.WebSocket&&p()===de.NotificationTypes.WEBSOCKET}function g(){clearTimeout(j),j=null}function m(e){g(),j=setTimeout(function(){return E.isConnected()?(J.debug("Restarting subscription..."),e&&(J.debug("Switching to Long Polling notification..."),v.notificationType=de.NotificationTypes.LONGPOLLING),void de.start(Te,ge,le,void 0,void 0,!0)):void J.debug("Connection is lost, no need to restart subscription...")},oe)}function C(){return ce&&ce.readyState===ce.OPEN?!0:!1}function I(){return C()&&se&&se.notificationUrl?-1===ce.url.indexOf(se.notificationUrl)?!1:!0:!1}function R(){C()&&ce.send("test")}function D(){if(se){if(Ie)return void J.info("longpolling request exists, no need to trigger new one.");Ie=e.retrieveNotification(se.notificationUrl,k,W)}else J.error("notifier is undefined, cannot fetch notification")}function A(){clearTimeout(q),q=null}function _(){ce&&(ce.onmessage=null,ce.onopen=null,ce.onclose=null,ce.onerror=null,ce.close&&ce.close(),ce=null)}function h(){c({connectivity:{handler:R,interval:ie},session:De,notificationId:se?se.notificationId:""}),Te&&(U.callFunctionIfExist(Te),Te=null)}function N(e){E.isConnected()&&U.callFunctionIfExist(ge,e)}function b(){J.info("extend notification subscription timer is stopped."),clearInterval(Ee),Ee=null}function O(t){return E.isConnected()?(J.debug("Subscribing..."),void e.subscribe(function(e,t,n,i,r,s,c){Re=null,E.setServices(r),v.services=r,v.servicesReceivingNotification=s,v.polling=i,v.expires=n,v.extendInterval=n/2,se={},se.subscribeUrl=e,se.notificationUrl=t,se.notificationId=t.substr(t.lastIndexOf("/")+1),b(),Ee=setInterval(F,1e3*v.extendInterval),o.setItem(Ce+z,t),o.setItem(Ce+Q,se.notificationId),o.setItem(Ce+K,e),o.setItem(Ce+Z,v.expires),o.setItem(Ce+X,v.extendInterval),o.setItem(Ce+$,E.getUser()),c&&(De=c,o.setItem(Ce+ee,De)),J.debug("Subscription successfull - notifier: ",se),T()?x(function(){ve=de.NotificationTypes.WEBSOCKET,a(),h()},function(){m(!0)}):(ve=de.NotificationTypes.LONGPOLLING,a(),h(),D())},function(e){J.error("Subscription is failed - error: "+e),N(e)},t,Re)):void J.debug("Connection is lost, no need to subscribe...")}function y(){return E.isConnected()?(J.debug("Extending subscription... - notifier: ",se),void e.extendSubscription(se.subscribeUrl,function(e,t,n){E.setServices(t),v.services=t,v.servicesReceivingNotification=n,se.notificationUrl=e,o.setItem(Ce+z,e),b(),Ee=setInterval(F,1e3*v.extendInterval),J.debug("Extending subscription successful - notifier: ",se),T()?x(function(){a(),h()},function(){m(!0)}):(a(),D(),h())},function(e){J.error("Extending subscription is failed - error: "+e),J.error("Fail reusing existing subscription, re-subscribing."),a(),O()})):void J.debug("Connection is lost, no need to extend subscribe...")}function L(e,t,n,i,r,a){if(Te=e,ge=t,le=n,i&&(Ce=i),!E.isConnected())return void J.debug("Connection is lost, no need to subscribe...");J.debug("start - notification subscription...");var s=o.getItem(Ce+z),c=o.getItem(Ce+Q),d=o.getItem(Ce+K),l=o.getItem(Ce+Z),u=o.getItem(Ce+X),p=o.getItem(Ce+$);J.debug("start - cached data - nurl: "+s+" nid: "+c+" surl: "+d+" exp: "+l+" extendInterval: "+u+" user: "+p),s&&c&&d&&l&&u&&E.getUser()===p?(se={},se.subscribeUrl=d,se.notificationUrl=s,se.notificationId=c,v.expires=l,v.extendInterval=u,F(void 0,void 0,a)):O(r)}function V(){clearTimeout(Y),Y=null}function P(){var e;e=Math.random()*oe,J.info("starting notification after timeout: "+e),V(),Y=setTimeout(function(){L(Te,ge),E.isConnected()&&U.callFunctionIfExist(B)},e)}function M(e){b(),V(),S()&&a(),U.callFunctionIfExist(H)}function w(e){o.removeItem("USERNAME"),o.removeItem("PASSWORD"),o.removeItem(Ce+ee),b(),d(),U.callFunctionIfExist(E.notification.onGoneReceived,e)}var F,k,W,x,H,B,G,Y,j,q,J=n.getLogger("notificationManager"),K="SubscriptionUrl",z="NotificationUrl",Q="NotificationId",Z="SubscriptionExpiry",X="SubscriptionExtendInterval",$="USERNAME",ee="SESSION",te=50,ne=600,ie=1e4,oe=ie+1e3,re=4e3,ae=f.WEBSOCKET,se=null,ce=null,de=this,le=!1,ue=null,pe=null,fe=!1,Ee=null,Se=!1,Te=null,ge=null,me=[],Ce="",Ie=null,ve=null,Re=null,De=null;G=setInterval(u,1e3*ne),this.NotificationTypes={LONGPOLLING:"longpolling",SNMP:"snmp",WEBSOCKET:"websocket"},this.isAnonymous=function(){return le},k=function(e,t){var n;t&&e&&(J.info("received notification event:"+e,t),-1!==me.indexOf(t.eventId)?J.info("previously received notification eventId: "+t.eventId+", do not execute notification callback function."):(J.info("newly received notification eventId: "+t.eventId),me.push(t.eventId),me.length===te&&(n=me.shift(),J.info("notification events queue is full, remove first eventId: "+n)),U.callFunctionIfExist(Ae[e],t))),S()&&(Ie=null,D()),fe&&(fe=!1,U.callFunctionIfExist(pe))},W=function(e){return J.error("received notification error:"+e),i.publish(f.EVENT.NOTIFICATION_CHANNEL_LOST),E.isConnected()?(fe=!0,S()&&(A(),q=setTimeout(function(){m()},re)),void U.callFunctionIfExist(ue,e)):void J.debug("Connection is lost, no need to handle notification failure...")},x=function(e,n){function i(t){J.trace("websocket connection created successfully: "+t),"function"==typeof e&&e(t)}function o(e){J.trace("websocket connection failed: "+e),_(),"function"==typeof n&&n(e)}var r=ae.PROTOCOL.NONSECURE;if(C()){if(I())return J.info("WebSocket is already opened, no need to open new one."),void i(ae.STATUS.ALREADY_OPENED);J.error("websocket connection with invalid url is found!"),_()}else _();try{v.websocketProtocol&&v.websocketProtocol===ae.PROTOCOL.SECURE&&(r=ae.PROTOCOL.SECURE),ce=new t.WebSocket(r+"://"+(v.websocketIP?v.websocketIP:t.location.hostname)+":"+(v.websocketPort?v.websocketPort:ae.DEFAULT_PORT)+se.notificationUrl)}catch(a){return J.error("WebSocket create error: ",a),void o(ae.STATUS.CREATE_ERROR)}null!==ce?(ce.onmessage=function(e){var t,n,i=JSON.parse(e.data);i&&(t=i.notificationMessage,t&&(n=t.eventType,k(n,t)))},ce.onopen=function(e){J.info("WebSocket opened"),i(ae.STATUS.OPENED)},ce.onclose=function(e){J.info("WebSocket closed"),W(ae.STATUS.CONNECTION_CLOSED),o(ae.STATUS.CONNECTION_CLOSED)},ce.onerror=function(e){J.error("Error on Web Socket connection."),W(ae.STATUS.CONNECTION_ERROR),o(ae.STATUS.CONNECTION_ERROR)}):o(ae.STATUS.NOT_FOUND)},F=function(e,t,n){return E.isConnected()?(e&&(Te=e,ge=t),void(se?n?(J.trace("subscription restart is triggered..."),y()):ve===de.NotificationTypes.WEBSOCKET&&S()?(J.trace("original notification type is websocket, try websocket connection again."),se.notificationUrl.replace("/notification/","/websocket/"),x(function(){J.trace("websocket connection created successfully, use websocket from now on."),o.setItem(Ce+z,se.notificationUrl),v.notificationType=de.NotificationTypes.WEBSOCKET,y()},function(){J.trace("websocket connection failed, keep using long polling."),se.notificationUrl.replace("/websocket/","/notification/"),y()})):y():(J.debug("Cannot reuse existing subscription, re-subscribing."),O()))):void J.debug("Connection is lost, no need to extend subscribe...")},this.stop=function(t,n,i){return E.isConnected()?(J.debug("Unsubscribing... - notifier: ",se),void(se?e.deleteSubscription(se.subscribeUrl,function(){J.debug("Unsubscription successfull"),b(),d(),a(),_(),se=null,Se=!1,o.removeItem(Ce+z),o.removeItem(Ce+Q),o.removeItem(Ce+K),o.removeItem(Ce+Z),o.removeItem(Ce+X),o.removeItem(Ce+ee),"function"==typeof t&&t()},function(e){J.error("Unsubscribe if failed - error:"+e),Se=!1,"function"==typeof n&&n()},i):(J.error("notifier is unknown, cannot send unsubscribe request."),Se=!1,"function"==typeof n&&n()))):void J.debug("Connection is lost, no need to unsubscribe...")},this.start=L,this.extend=L,this.setOnError=function(e){ue=e},this.setOnSuccess=function(e){pe=e},this.setOnConnectionLost=function(e){H=e},this.setOnConnectionEstablished=function(e){B=e},this.trigger=function(){if(!Se)try{D(),Se=!0}catch(e){throw e}},this.getNotificationId=function(){return se?se.notificationId:void 0},Ae.gone=function(e){w(e)},i.subscribe(f.EVENT.CONNECTION_REESTABLISHED,P),i.subscribe(f.EVENT.CONNECTION_LOST,M),i.subscribe(f.EVENT.TOKEN_AUTH_STARTED,r,10),i.subscribe(f.EVENT.TOKEN_NOT_FOUND,s),i.subscribe(f.EVENT.SESSION_EXPIRED,s),l&&(this.getWebSocket=function(){return ce}),l&&(this.webSocketConnect=x),l&&(this.websocketDisconnect=_),l&&(this.WEBSOCKET_CONSTANTS=ae),l&&(this.setNotifier=function(e){se=e})},he=function(e,t,n,i,o){return new _e(e||De,t||window,n||V,i||p,o||F)},Ne=new he;l&&(l.NotificationManager=he);var be=function(e){this.onGoneReceived=null,this.NotificationTypes={LONGPOLLING:"longpolling",WEBSOCKET:"websocket"},this.isAnonymous=function(){return e.isAnonymous()},this.stop=function(t,n,i){e.stop(t,n,i)},this.start=function(t,n,i,o,r){e.start(t,n,i,o,r)},this.extend=function(t,n){e.extend(t,n)},this.setOnError=function(t){e.setOnError(t)},this.setOnSuccess=function(t){e.setOnSuccess(t)},this.setOnConnectionLost=function(t){e.setOnConnectionLost(t)},this.setOnConnectionEstablished=function(t){e.setOnConnectionEstablished(t)},this.trigger=function(){e.trigger()}},Oe=function(e){return new be(e||Ne)};E.notification=new Oe(Ne);var ye=function(e){function t(e,t,i,o){var r="sessionProgress",a=n.getCurrentState(e);switch(a){case n.CallFSMState.INIT:switch(t){case n.NotificationEvent.callStart_GUI:e.currentState=n.CallFSMState.TRYING,i(e,n.TransferEvent.callStart_fsm);break;case n.NotificationEvent.callNotify:e.currentState=n.CallFSMState.RINGING,i(e,n.TransferEvent.callReceived_fsm);break;case n.NotificationEvent.callNotify_noSDP:e.currentState=n.CallFSMState.RINGING_SLOW,i(e,n.TransferEvent.callReceived_fsm);break;case n.NotificationEvent.joiningSuccess_Notify:e.currentState=n.CallFSMState.PROVISIONRECEIVED,i(e,n.TransferEvent.joiningSuccess_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.RINGING:switch(t){case n.NotificationEvent.answer_GUI:e.currentState=n.CallFSMState.COMPLETED,i(e,n.TransferEvent.answer_fsm);break;case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.reject_GUI);break;case n.NotificationEvent.callNotify_noSDP:e.currentState=n.CallFSMState.RINGING_SLOW,i(e,n.TransferEvent.callReceived_fsm);break;case n.NotificationEvent.callEnd_Notify:case n.NotificationEvent.callCancel_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.forward_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.forward_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.RINGING_SLOW:switch(t){case n.NotificationEvent.answer_GUI:e.currentState=n.CallFSMState.ANSWERING,i(e,n.TransferEvent.answerRingingSlow_fsm);break;case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.reject_GUI);break;case n.NotificationEvent.callEnd_Notify:case n.NotificationEvent.callCancel_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.forward_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.forward_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.ANSWERING:switch(t){case n.NotificationEvent.respondCallUpdate_Notify:e.currentState=n.CallFSMState.COMPLETED,i(e,n.TransferEvent.callCompletedAnswering_fsm);break;case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.TRYING:switch(t){case n.NotificationEvent.sessionProgress:case r:e.currentState=n.CallFSMState.PROVISIONRECEIVED,i(e,n.TransferEvent.preCallResponse_fsm);break;case n.NotificationEvent.ringing_Notify:e.currentState=n.CallFSMState.PROVISIONRECEIVED,i(e,n.TransferEvent.ringing_fsm);break;case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.noAnswer_fsm);break;case n.NotificationEvent.respondCallUpdate_Notify:e.currentState=n.CallFSMState.COMPLETED,i(e,n.TransferEvent.callCompleted_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.PROVISIONRECEIVED:switch(t){case n.NotificationEvent.respondCallUpdate_Notify:e.currentState=n.CallFSMState.COMPLETED,i(e,n.TransferEvent.callCompleted_fsm);break;case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.ringing_Notify:i(e,n.TransferEvent.ringing_fsm);break;case n.NotificationEvent.sessionProgress:case r:i(e,n.TransferEvent.preCallResponse_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.COMPLETED:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.startCallUpdate_remoteHold_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.REMOTE_HOLDING,i(e,n.TransferEvent.remoteHolding_fsm);break;case n.NotificationEvent.startCallUpdate_slowStart_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_SLOW_START_OFFER,i(e,n.TransferEvent.slowStartOfferDuringOnCall_fsm);break;case n.NotificationEvent.hold_GUI:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_HOLDING,i(e,n.TransferEvent.localHolding_fsm);break;case n.NotificationEvent.videoStopStart_GUI:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_VIDEO_STOP_START,i(e,n.TransferEvent.localVideoStopStart_fsm);break;case n.NotificationEvent.startCallUpdate_remoteOffer_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.REMOTE_OFFER,i(e,n.TransferEvent.remoteOffer_fsm);break;case n.NotificationEvent.transfering:e.previousState=e.currentState,e.currentState=n.CallFSMState.TRANSFERING,i(e,n.TransferEvent.transfering_fsm);break;case n.NotificationEvent.callCancel_Notify:i(e,n.TransferEvent.ignoredNotification_fsm);break;case n.NotificationEvent.performReconnectWorkaround_JSL:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_REOFFER,i(e,n.TransferEvent.performReconnectWorkaround_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.LOCAL_REOFFER:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.respondCallUpdate_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.respondCallUpdate_fsm);break;case n.NotificationEvent.webrtcFailure_JSL:case n.NotificationEvent.requestFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.REMOTE_OFFER:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.remoteOfferProcessed_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.renegotiationCompleted_fsm);break;case n.NotificationEvent.requestFailure_JSL:case n.NotificationEvent.webrtcFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.LOCAL_VIDEO_STOP_START:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.respondCallUpdate_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.respondCallUpdate_fsm);break;case n.NotificationEvent.requestFailure_JSL:case n.NotificationEvent.webrtcFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;case n.NotificationEvent.respondCallUpdate_glareCondition_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.glareCondition_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.LOCAL_HOLDING:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.respondCallUpdate_Notify:e.currentState=n.CallFSMState.LOCAL_HOLD,e.previousState===n.CallFSMState.REMOTE_HOLD&&(e.currentState=n.CallFSMState.BOTH_HOLD),e.previousState=a,i(e,n.TransferEvent.respondCallHoldUpdate_fsm);break;case n.NotificationEvent.requestFailure_JSL:case n.NotificationEvent.webrtcFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;case n.NotificationEvent.respondCallUpdate_glareCondition_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.glareCondition_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.LOCAL_UNHOLDING:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.respondCallUpdate_Notify:e.currentState=n.CallFSMState.COMPLETED,e.previousState===n.CallFSMState.BOTH_HOLD&&(e.currentState=n.CallFSMState.REMOTE_HOLD),e.previousState=a,i(e,n.TransferEvent.respondCallHoldUpdate_fsm);break;case n.NotificationEvent.requestFailure_JSL:case n.NotificationEvent.webrtcFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;case n.NotificationEvent.respondCallUpdate_glareCondition_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.glareCondition_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.LOCAL_HOLD:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.startCallUpdate_remoteHold_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.REMOTE_HOLDING,
i(e,n.TransferEvent.remoteHolding_fsm);break;case n.NotificationEvent.startCallUpdate_remoteOffer_Notify:i(e,n.TransferEvent.remoteOfferDuringLocalHold_fsm);break;case n.NotificationEvent.unhold_GUI:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_UNHOLDING,i(e,n.TransferEvent.localUnHolding_fsm);break;case n.NotificationEvent.joining_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.JOINING,i(e,n.TransferEvent.joining_fsm);break;case n.NotificationEvent.transfering:e.previousState=e.currentState,e.currentState=n.CallFSMState.TRANSFERING,i(e,n.TransferEvent.transfering_fsm);break;case n.NotificationEvent.performReconnectWorkaround_JSL:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_REOFFER,i(e,n.TransferEvent.performReconnectWorkaround_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.REMOTE_HOLDING:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.remoteHoldProcessed_JSL:e.currentState=n.CallFSMState.REMOTE_HOLD,e.previousState===n.CallFSMState.LOCAL_HOLD&&(e.currentState=n.CallFSMState.BOTH_HOLD),e.previousState=a,i(e,n.TransferEvent.remoteHold_fsm);break;case n.NotificationEvent.requestFailure_JSL:case n.NotificationEvent.webrtcFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.REMOTE_UNHOLDING:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.remoteUnHoldProcessed_JSL:e.currentState=n.CallFSMState.COMPLETED,e.previousState===n.CallFSMState.BOTH_HOLD&&(e.currentState=n.CallFSMState.LOCAL_HOLD),e.previousState=a,i(e,n.TransferEvent.remoteUnHold_fsm);break;case n.NotificationEvent.requestFailure_JSL:case n.NotificationEvent.webrtcFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.REMOTE_HOLD:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.startCallUpdate_remoteHold_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.REMOTE_HOLDING,i(e,n.TransferEvent.remoteHolding_fsm);break;case n.NotificationEvent.startCallUpdate_remoteOffer_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.REMOTE_UNHOLDING,i(e,n.TransferEvent.remoteUnHolding_fsm);break;case n.NotificationEvent.startCallUpdate_slowStart_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_SLOW_START_OFFER,i(e,n.TransferEvent.slowStartOfferDuringRemoteHold_fsm);break;case n.NotificationEvent.hold_GUI:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_HOLDING,i(e,n.TransferEvent.localHolding_fsm);break;case n.NotificationEvent.joining_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.JOINING,i(e,n.TransferEvent.joining_fsm);break;case n.NotificationEvent.performReconnectWorkaround_JSL:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_REOFFER,i(e,n.TransferEvent.performReconnectWorkaround_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.BOTH_HOLD:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.startCallUpdate_remoteHold_Notify:case n.NotificationEvent.startCallUpdate_remoteOffer_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.REMOTE_UNHOLDING,i(e,n.TransferEvent.remoteUnHolding_fsm);break;case n.NotificationEvent.unhold_GUI:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_UNHOLDING,i(e,n.TransferEvent.localUnHolding_fsm);break;case n.NotificationEvent.joining_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.JOINING,i(e,n.TransferEvent.joining_fsm);break;case n.NotificationEvent.transfering:e.previousState=e.currentState,e.currentState=n.CallFSMState.TRANSFERING,i(e,n.TransferEvent.transfering_fsm);break;case n.NotificationEvent.performReconnectWorkaround_JSL:e.previousState=e.currentState,e.currentState=n.CallFSMState.LOCAL_REOFFER,i(e,n.TransferEvent.performReconnectWorkaround_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.LOCAL_SLOW_START_OFFER:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.respondCallUpdate_Notify:e.previousState=e.currentState,e.currentState=n.CallFSMState.COMPLETED,i(e,n.TransferEvent.respondCallUpdate_fsm);break;case n.NotificationEvent.requestFailure_JSL:case n.NotificationEvent.webrtcFailure_JSL:e.currentState=e.previousState,i(e,n.TransferEvent.stateReverted_fsm);break;case n.NotificationEvent.slowStartOfferProcessed_JSL:i(e,n.TransferEvent.slowStartOfferProcessed_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.JOINING:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.sessionComplete_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.sessionComplete_fsm);break;case n.NotificationEvent.sessionFail_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.sessionFail_fsm);break;case n.NotificationEvent.refer_JSL:e.currentState=n.CallFSMState.REFER,i(e,n.TransferEvent.refer_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.REFER:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.sessionComplete_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.sessionComplete_fsm);break;case n.NotificationEvent.sessionFail_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.sessionFail_fsm);break;case n.NotificationEvent.accepted_Notify:i(e,n.TransferEvent.accepted_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}break;case n.CallFSMState.TRANSFERING:switch(t){case n.NotificationEvent.end_GUI:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.localEnd_fsm);break;case n.NotificationEvent.callEnd_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.remoteEnd_fsm);break;case n.NotificationEvent.sessionComplete_Notify:e.currentState=n.CallFSMState.INIT,i(e,n.TransferEvent.transferSuccess_fsm);break;case n.NotificationEvent.sessionFail_Notify:e.currentState=e.previousState,i(e,n.TransferEvent.transferFail_fsm);break;case n.NotificationEvent.accepted_Notify:i(e,n.TransferEvent.accepted_fsm);break;case n.NotificationEvent.startCallUpdate_slowStart_Notify:case n.NotificationEvent.startCallUpdate_remoteHold_Notify:case n.NotificationEvent.startCallUpdate_remoteOffer_Notify:i(e,n.TransferEvent.remoteCallUpdate_fsm);break;default:o(e,n.TransferEvent.unknownNotification_fsm)}}}this.CallFSMState={INIT:"INIT",RINGING:"RINGING",TRYING:"TRYING",ANSWERING:"ANSWERING",COMPLETED:"COMPLETED",RINGING_SLOW:"RINGING_SLOW",LOCAL_HOLD:"LOCAL_HOLD",LOCAL_HOLDING:"LOCAL_HOLDING",LOCAL_UNHOLDING:"LOCAL_UNHOLDING",LOCAL_VIDEO_STOP_START:"LOCAL_VIDEO_STOP_START",REMOTE_OFFER:"REMOTE_OFFER",REMOTE_HOLD:"REMOTE_HOLD",REMOTE_HOLDING:"REMOTE_HOLDING",REMOTE_UNHOLDING:"REMOTE_UNHOLDING",BOTH_HOLD:"BOTH_HOLD",JOINING:"JOINING",PROVISIONRECEIVED:"PROVISIONRECEIVED",REFER:"REFER",TRANSFERING:"TRANSFERING",LOCAL_SLOW_START_OFFER:"LOCAL_SLOW_START_OFFER",LOCAL_REOFFER:"LOCAL_REOFFER"},this.TransferEvent={unknownNotification_fsm:"unknownNotification_fsm",ignoredNotification_fsm:"ignoredNotification_fsm",callStart_fsm:"callStart_fsm",callReceived_fsm:"callReceived_fsm",answer_fsm:"answer_fsm",reject_GUI:"reject_GUI",callCompleted_fsm:"callCompleted_fsm",noAnswer_fsm:"noAnswer_fsm",localEnd_fsm:"localEnd_fsm",remoteEnd_fsm:"remoteEnd_fsm",answeringRingingSlow_fsm:"answeringRingingSlow_fsm",callCompletedAnswering_fsm:"callCompletedAnswering_fsm",localHold_fsm:"localHold_fsm",localHolding_fsm:"localHolding_fsm",remoteHold_fsm:"remoteHold_fsm",remoteHolding_fsm:"remoteHolding_fsm",localUnHold_fsm:"localUnHold_fsm",localUnHolding_fsm:"localUnHolding_fsm",remoteUnHold_fsm:"remoteUnHold_fsm",remoteUnHolding_fsm:"remoteUnHolding_fsm",localVideoStopStart_fsm:"localVideoStopStart_fsm",remoteOffer_fsm:"remoteOffer_fsm",joining_fsm:"joining_fsm",sessionComplete_fsm:"sessionComplete_fsm",joiningSuccess_fsm:"joiningSuccess_fsm",sessionFail_fsm:"sessionFail_fsm",ringing_fsm:"ringing_fsm",respondCallUpdate_fsm:"respondCallUpdate_fsm",remoteCallUpdate_fsm:"remoteCallUpdate_fsm",preCallResponse_fsm:"preCallResponse_fsm",forward_fsm:"forward_fsm",refer_fsm:"refer_fsm",accepted_fsm:"accepted_fsm",transfering_fsm:"transfering_fsm",transferSuccess_fsm:"transferSuccess_fsm",transferFail_fsm:"transferFail_fsm",respondCallHoldUpdate_fsm:"respondCallHoldUpdate_fsm",remoteOfferDuringLocalHold_fsm:"remoteOfferDuringHold_fsm",renegotiationCompleted_fsm:"renegotiationCompleted_fsm",slowStartOfferDuringRemoteHold_fsm:"slowStartOfferDuringRemoteHold_fsm",slowStartOfferDuringOnCall_fsm:"slowStartOfferDuringOnCall_fsm",stateReverted_fsm:"stateReverted_fsm",glareCondition_fsm:"glareCondition_fsm",slowStartOfferProcessed_fsm:"slowStartOfferProcessed_fsm",performReconnectWorkaround_fsm:"performReconnectWorkaround_fsm"},this.NotificationEvent={callStart_GUI:"callStart_GUI",callNotify:"callNotify",ringing_Notify:"ringing_Notify",answer_GUI:"answer_GUI",end_GUI:"end_GUI",respondCallUpdate_Notify:"respondCallUpdate_Notify",respondCallUpdate_glareCondition_Notify:"respondCallUpdate_glareCondition_Notify",callCompleted_fsm:"callCompleted_fsm",callEnd_Notify:"callEnd_Notify",callNotify_noSDP:"callNotify_noSDP",startCallUpdate_slowStart_Notify:"startCallUpdate_slowStart_Notify",startCallUpdate_remoteHold_Notify:"startCallUpdate_remoteHold_Notify",startCallUpdate_remoteOffer_Notify:"startCallUpdate_remoteOffer_Notify",joining_Notify:"joining_Notify",sessionComplete_Notify:"sessionComplete_Notify",joiningSuccess_Notify:"joiningSuccess_Notify",sessionFail_Notify:"sessionFail_Notify",hold_GUI:"hold_GUI",unhold_GUI:"unhold_GUI",videoStopStart_GUI:"videoStopStart_GUI",sessionProgress:"sessionProgress",callCancel_Notify:"callCancel_Notify",forward_GUI:"forward_GUI",refer_JSL:"refer_JSL",accepted_Notify:"accepted_Notify",transfering:"transfering",requestFailure_JSL:"requestFailure_JSL",webrtcFailure_JSL:"webrtcFailure_JSL",remoteOfferProcessed_JSL:"remoteOfferProcessed_JSL",remoteHoldProcessed_JSL:"remoteHoldProcessed_JSL",remoteUnHoldProcessed_JSL:"remoteUnHoldProcessed_JSL",slowStartOfferProcessed_JSL:"slowStartOfferProcessed_JSL",performReconnectWorkaround_JSL:"performReconnectWorkaround_JSL"};var n=this,i=e.getLogger("callFsm");n.getCurrentState=function(e){return e.currentState?e.currentState:n.CallFSMState.INIT},this.handleEvent=function(e,o,r){var a;e&&(a=n.getCurrentState(e),i.info("FSM received NotificationEvent: "+o+" @ "+a+" state. Call Id: "+e.id),t(e,o,function(e,t){i.debug("FSM handleEvent successful. (Call FSM) State Passed from "+a+" to "+n.getCurrentState(e)+". TransferEvent: "+t+". Call Id: "+e.id),r(e,t)},function(e,t){i.error("FSM handleEvent failure: "+t+" @ "+n.getCurrentState(e)+". Call Id: "+e.id),r(e,t)}))}},Le=function(e){return new ye(e||V)},Ve=new Le;l&&(l.CallFSM=Le);var Pe=function(e,t,n){function o(e){E.notification.isAnonymous()&&n.getItem("NotificationId")&&(e.callMeRequest.notifyChannelId=n.getItem("NotificationId"))}function r(e){return e&&e.responseText?JSON.parse(e.responseText).callControlResponse:void 0}function a(t,n,i,o,a){l.info("makeCallControlRequest Function : sdp : "+i);var s={callControlRequest:{type:t,sdp:i}};e.sendPutRequest({url:d(1,"/callControl/callSessions/"+n),data:s},o,a,null,r)}function s(t,n,o){var a=i();l.info("makeCallControlEndRequest Function: "+t),e.sendDeleteRequest({url:d(1,(E.notification.isAnonymous()?"/callme/callSessions/":"/callControl/callSessions/")+t+(a?"?tokenrealm="+a:"")),data:{}},n,o,null,r)}function c(t,n,i,o,a){l.info("makeRequest Function with action : "+t);var s={callDispositionRequest:{action:t,sessionData:n}};a&&(s.callDispositionRequest.address=a),e.sendPostRequest({url:d(1,"/calldisposition"),data:s},i,o,null,r)}var l=t.getLogger("callControlService");this.startCall=function(t,n,a,s,c){function u(e){var t,n=E.notification.isAnonymous()?e.callMeResponse:e.callControlResponse;return n&&(t=n.sessionData),t}function p(){var e;return e=E.notification.isAnonymous()?{callMeRequest:{type:"callStart",from:t,to:n,sdp:a}}:{callControlRequest:{type:"callStart",from:t,to:n,sdp:a}}}l.info("Call Start Function: "+t+" --> "+n),l.info("Call Start Function: sdp : "+a);var f=p(),S=i();o(f),e.sendPostRequest({url:d(1,E.notification.isAnonymous()?"/callme"+(S?"?tokenrealm="+S:""):"/callControl"),data:f},s,c,u,r)},this.audit=function(t,n,o){var a,s=i();a=E.notification.isAnonymous()?{callMeRequest:{type:"audit"}}:{callControlRequest:{type:"audit"}},s&&(t=t.split("%0A")[0]),e.sendPutRequest({url:d(1,(E.notification.isAnonymous()?"/callme/callSessions/":"/callControl/callSessions/")+t+(s?"?tokenrealm="+s:"")),data:a},n,o,null,r)},this.hold=function(t,n,i,o){l.info("Hold Function : sdp : "+n);var a={callControlRequest:{type:"startCallUpdate",sdp:n}};e.sendPutRequest({url:d(1,"/callControl/callSessions/"+t),data:a},i,o,null,r)},this.unhold=function(t,n,i,o){l.info("UnHold Function : sdp : "+n);var a={callControlRequest:{type:"startCallUpdate",sdp:n}};e.sendPutRequest({url:d(1,"/callControl/callSessions/"+t),data:a},i,o,null,r)},this.reinvite=function(t,n,i,o){l.info("reinvite Function : sdp : "+n);var a={callControlRequest:{type:"startCallUpdate",sdp:n}};e.sendPutRequest({url:d(1,"/callControl/callSessions/"+t),data:a},i,o,null,r)},this.respondCallUpdate=function(t,n,i,o){l.info("Respond Call Update Function : sdp : "+n);var a={callControlRequest:{type:"respondCallUpdate",sdp:n}};e.sendPutRequest({url:d(1,"/callControl/callSessions/"+t),data:a},i,o,null,r)},this.join=function(t,n,i,o,a){function s(e){var t,n=e.callControlResponse;return n&&(t=n.sessionData),t}l.info("Join Function : sdp : "+i);var c={callControlRequest:{type:"join",firstSessionData:t,secondSessionData:n,sdp:i}};"true"===v.clientControlled&&(c.callControlRequest.clientControlled="true"),e.sendPostRequest({url:d(1,"/callControl/"),data:c},o,a,s,r)},this.refer=function(t,n,i,o,a){l.info("Refer Function : refer to: "+n);var s={callControlRequest:{type:"refer",from:i,to:n}};e.sendPutRequest({url:d(1,"/callControl/callSessions/"+t),data:s},o,a,null,r)},this.endCall=function(e,t,n){l.info("endCall Function: "+e),s(e,t,n,null,r)},this.answerCall=function(e,t,n,i){l.info("Answer Call Function : sdp : "+t),a("callAnswer",e,t,n,i,null,r)},this.reject=function(e,t,n){var i;l.info("Reject Function: "+e),c("reject",e,t,n,i,r)},this.forward=function(e,t,n,i){l.info("Forward Function : address: "+t),c("forward",e,n,i,t)},this.transfer=function(t,n,i,o){l.info("Call Transfer Function : target address: "+n);var a={callControlRequest:{type:"transfer",address:n}};e.sendPutRequest({url:d(1,"/callControl/callSessions/"+t),data:a},i,o,null,r)},this.clickToCall=function(t,n,i,o){var r={clickToCallRequest:{callingParty:t,calledParty:n}};e.sendPostRequest({url:d(1,"/clicktocall"),data:r},i,o)},this.getIMRN=function(t,n,i,o,r){function a(e){var t;return e&&e.imrnResponse&&(t=U.getProperty(e.imrnResponse,"imrn")),t}l.info("(Wam Call) getIMRN Function "),i.match("@")&&"sip"!==i.split(":")[0]&&(i="sip:"+i);var s={imrnRequest:{realm:t,sourceAddress:n,destinationAddress:i}};e.sendPostRequest({url:d(1,"/imrn"),data:s},o,r,a)}},Me=function(e,t,n){return new Pe(e||I,t||V,n||F)},we=new Me,Fe=function(e,t,n,i,o){function r(e,t){e.indexOf("sip:",0)>-1&&(e=e.replace("sip:",""));var n="";return void 0===t||null===t?e.indexOf("@",0)>-1?"sip:"+e:e:(t.firstName&&""!==t.firstName&&(n+=t.firstName),t.lastName&&""!==t.lastName&&(n+=""===n?t.lastName:" "+t.lastName),""===n?e.indexOf("@",0)>-1?"sip:"+e:e:n+"<"+(e.indexOf("@",0)>-1?"sip:"+e:e)+">")}function a(){h=!0}function s(t){t.call&&t.call.clearAuditTimer(),t.pendingRequestTimer&&clearTimeout(t.pendingRequestTimer),e.processEnd(t),delete D[t.id]}function c(e){A.debug("Setting notification state to BUSY for call: "+e.id),e.notificationState=L.BUSY}function d(e){A.debug("Setting notification state to IDLE for call: "+e.id),e.notificationState=L.IDLE}function u(e){return e.notificationState===L.BUSY}function S(e){if(y&&(A.debug("NOTIFICATION_QUEUE: Process completed, notification queue state changed to IDLE"),d(e),e.call.notificationQueue.size()>0)){A.debug("NOTIFICATION_QUEUE: New notification found in queue, processing it!");var t=e.call.notificationQueue.dequeue();O.onNotificationEvent(t.type,t.sessionParams)}}function T(){var e,n;if(h){h=!1;for(e in D)D.hasOwnProperty(e)&&(n=D[e],n&&t.getCurrentState(n)!==b.RINGING?(c(n),O.delegateToCallFSM(n,N.performReconnectWorkaround_JSL)):(n.call.onStateChange(V.ENDED,0),s(n)))}}function g(e){var t={sdp:e.sdp,callerNumber:e.call.callerNumber,callerName:e.call.callerName,calleeNumber:e.call.calleeNumber,primaryContact:e.call.primaryContact,optionReject:e.call.canReject(),optionForward:e.call.canForward(),optionAnswer:e.call.canAnswer()};F.setItem(e.id,JSON.stringify(t))}function m(t,n,i,o){c(t),e.revertRtcState(t,S,S),i&&O.delegateToCallFSM(t,i),o&&o.timeout?t.pendingRequestTimer=setTimeout(function(){t.pendingRequestTimer=null,o.args.push(!0),o.handler.apply(null,o.args)},1e3*o.timeout):n&&U.callFunctionIfExist(n)}function C(e,t,n){m(e,t,N.requestFailure_JSL,n)}function I(e,t){m(e,t,N.webrtcFailure_JSL)}function R(e,t){var n=t.sessionParams;A.info("CallControl notification received "+e+" sessionData:"+n.sessionData),n.referTo&&A.info("CallControl notification received: referTo:"+n.referTo+" referredBy: "+n.referredBy),n&&O.onNotificationEvent(e,n)}var D={},A=o.getLogger("callManager"),_=3e3,h=!1,N=t.NotificationEvent,b=t.CallFSMState,O=this,y=!0,L={BUSY:0,IDLE:1},V={IN_CALL:0,ON_HOLD:1,RINGING:2,ENDED:3,REJECTED:4,OUTGOING:5,INCOMING:6,ANSWERING:7,JOINED:8,RENEGOTIATION:9,TRANSFERRED:10,ON_REMOTE_HOLD:11},P={LOCAL_HOLD:0,REMOTE_HOLD:1,BOTH_HOLD:2};O.CALL_STATES=V,O.CALL_HOLD_STATES=P,O.initMedia=function(t,n,i){e.initMedia(t,n,i)},O.set_logSeverityLevel=function(t){e.set_logSeverityLevel(t)},O.enable_logCallback=function(){e.enable_logCallback()},O.disable_logCallback=function(){e.disable_logCallback()},O.get_audioInDeviceCount=function(){e.get_audioInDeviceCount()},O.get_audioOutDeviceCount=function(){e.get_audioOutDeviceCount()},O.get_videoDeviceCount=function(){e.get_videoDeviceCount()},O.getUserMedia=function(t,n,i){e.getUserMedia(t,n,i)},O.showSettingsWindow=function(t,n,i){e.showSettingsWindow(t,n,i)},O.createStreamRenderer=function(t,n,i){return e.createStreamRenderer(t,n,i)},O.disposeStreamRenderer=function(t){e.disposeStreamRenderer(t)},O.isPluginEnabled=function(){return e.isPluginEnabled()},O.hasGotCalls=function(){var e,n;for(e in D)if(D.hasOwnProperty(e)&&(n=D[e]))return A.info("has got call - id: "+e+" - state: "+t.getCurrentState(n)),!0;return!1},O.getCalls=function(){return D},O.sendIntraFrame=function(t){var n=D[t];n&&e.sendIntraFrame(n)},O.sendBlackFrame=function(t){var n=D[t];n&&e.sendBlackFrame(n)},O.delegateToCallFSM=function(e,n){t.handleEvent(e,n,O.onStateChange)},O.answer=function(i,o,r,a,s){var c=D[i],d=O.isVideoNegotationAvailable(i);if(c){if(d===!1&&a===!0)return A.error("[callManager.answer] Video Session Not Available Error "),void U.callFunctionIfExist(r,E.Errors.VIDEO_SESSION_NOT_AVAILABLE);c.sdp?t.getCurrentState(c)!==b.RINGING?U.callFunctionIfExist(r,E.Errors.STATE):O.getUserMedia(function(t){c.isVideoSourceAllowed=t.video,c.isVideoEnabled=a,e.storeLocalStreamToCall(c,t.id),e.createAnswer(c,function(t){A.info("[callManager.answer : sdp ]"+t),O.delegateToCallFSM(c,N.answer_GUI),n.answerCall(c.id,t,function(){e.addLocalStream(c),U.callFunctionIfExist(o)},r)},function(e){A.error("[callManager.answer] Error : "+e),O.delegateToCallFSM(c,N.end_GUI)},a)},function(e){U.callFunctionIfExist(r,e)},{audio:!0,video:d?!0:!1,audioIndex:0,videoIndex:d?0:-1,videoResolution:s}):t.getCurrentState(c)!==b.RINGING_SLOW?U.callFunctionIfExist(r,E.Errors.STATE):O.getUserMedia(function(t){c.isVideoSourceAllowed=t.video,c.isVideoEnabled=a,e.storeLocalStreamToCall(c,t.id),e.createOffer(c,function(e){c.sdp=e,O.delegateToCallFSM(c,N.answer_GUI),n.answerCall(c.id,e,o,r)},function(){O.delegateToCallFSM(c,N.end_GUI)},a)},function(e){U.callFunctionIfExist(r,e)},{audio:!0,video:d?!0:!1,audioIndex:0,videoIndex:d?0:-1,videoResolution:s})}},O.getIncomingCallById=function(e){var t,n,o=null;return t=JSON.parse(F.getItem(e)),t&&(o=new E.call.IncomingCall(e,{reject:t.optionReject,forward:t.optionForward,answer:t.optionAnswer}),o.canOrigReceiveVideo=i.isSdpHasVideo(t.sdp),o.callerNumber=t.callerNumber,o.callerName=t.callerName,o.calleeNumber=t.calleeNumber,o.primaryContact=t.primaryContact,n={call:o,sdp:t.sdp,id:e},D[e]=n,O.delegateToCallFSM(n,N.callNotify)),o},O.start=function(t,i,o,a,s,c,d,l){var u={};A.info("start call... from: "+t+" contact: "+JSON.stringify(i)+" to: "+o+" isVideoEnabled: "+c+" sendInitialVideo: "+d+" videoQuality: "+l),O.getUserMedia(function(l){u.isVideoSourceAllowed=l.video,u.isVideoEnabled=c,e.storeLocalStreamToCall(u,l.id),e.createOffer(u,function(c){A.info("[callManager.start : sdp ]"+c),u.sdp=c,n.startCall(r(t,i),r(o),c,function(t){u.call=new E.call.OutgoingCall(t),u.id=t,O.delegateToCallFSM(u,N.callStart_GUI),D[t]=u,e.addLocalStream(u),U.callFunctionIfExist(a,u.call)},function(e){U.callFunctionIfExist(s,e)})},function(e){A.error("doOffer failed: "+e),U.callFunctionIfExist(s,e)},d)},function(){U.callFunctionIfExist(s)},{audio:!0,video:c?!0:!1,audioIndex:0,videoIndex:c?0:-1,videoResolution:l})},O.reject=function(e,t,i){var o=D[e];return o?void n.reject(e,function(){O.delegateToCallFSM(o,N.end_GUI),U.callFunctionIfExist(t)},function(){U.callFunctionIfExist(i)}):void U.callFunctionIfExist(i,E.Errors.STATE)},O.ignore=function(e,t,n){var i=D[e];return i?(O.delegateToCallFSM(i,N.end_GUI),void U.callFunctionIfExist(t)):void U.callFunctionIfExist(n,E.Errors.STATE)},O.forward=function(e,t,i,o){var r=D[e];return r?void n.forward(e,t,function(){O.delegateToCallFSM(r,N.forward_GUI),U.callFunctionIfExist(i)},function(){U.callFunctionIfExist(o)}):void U.callFunctionIfExist(o,E.Errors.STATE)},O.hold=function(i,o,r,a){var s,l=D[i];return l?u(l)?void(a?U.callFunctionIfExist(r,E.Errors.NETWORK):U.callFunctionIfExist(r,E.Errors.STATE)):(s=t.getCurrentState(l),s!==b.COMPLETED&&s!==b.REMOTE_HOLD?void(a?U.callFunctionIfExist(r,E.Errors.NETWORK):U.callFunctionIfExist(r,E.Errors.STATE)):l.pendingRequestTimer?void U.callFunctionIfExist(r,E.Errors.PENDING_REQUEST):(l.lastUpdateRequest={handler:O.hold,args:[i,o,r]},c(l),O.delegateToCallFSM(l,N.hold_GUI),void e.createHoldUpdate(l,!0,s===b.REMOTE_HOLD,function(e){A.debug("[callManager.hold->createHoldUpdate : sdp ]"+e),n.hold(l.id,e,function(){d(l),U.callFunctionIfExist(o)},function(e){C(l,r,{handler:O.hold,args:[i,o,r],timeout:e.retryAfter})})},function(){I(l,r)}))):void U.callFunctionIfExist(r,E.Errors.STATE)},O.unhold=function(i,o,r,a){var s,l=D[i];return l?u(l)?void(a?U.callFunctionIfExist(r,E.Errors.NETWORK):U.callFunctionIfExist(r,E.Errors.STATE)):(s=t.getCurrentState(l),s!==b.LOCAL_HOLD&&s!==b.BOTH_HOLD?void(a?U.callFunctionIfExist(r,E.Errors.NETWORK):U.callFunctionIfExist(r,E.Errors.STATE)):l.pendingRequestTimer?void U.callFunctionIfExist(r,E.Errors.PENDING_REQUEST):(l.lastUpdateRequest={handler:O.unhold,args:[i,o,r]},c(l),O.delegateToCallFSM(l,N.unhold_GUI),void e.createHoldUpdate(l,!1,s===b.BOTH_HOLD,function(t){A.debug("[callManager.unhold->createHoldUpdate : sdp ]"+t),n.unhold(l.id,t,function(){d(l),e.addLocalStream(l),U.callFunctionIfExist(o)},function(e){C(l,r,{handler:O.unhold,args:[i,o,r],timeout:e.retryAfter})})},function(){I(l,r)}))):void U.callFunctionIfExist(r,E.Errors.STATE)},O.directTransfer=function(e,i,o,r){var a,s=D[e];return s?(a=t.getCurrentState(s),void(a===b.LOCAL_HOLD||a===b.COMPLETED||a===b.BOTH_HOLD?(A.info("[callManager.directTransfer->sendTransfer : transfer target ]"+i),n.transfer(s.id,i,function(){O.delegateToCallFSM(s,N.transfering),A.info("[callManager.directTransfer->sentTransfer : transfer target ]"+i)},r)):A.error("directTransfer call is not in correct state: "+a))):void U.callFunctionIfExist(r,E.Errors.STATE)},O.videoUpdate=function(t,i,o){var r,a=D[t];return a?(r=a.isVideoEnabled||a.isScreenShared,a.lastUpdateRequest={handler:O.videoUpdate,args:[t,i,o]},c(a),O.delegateToCallFSM(a,N.videoStopStart_GUI),void e.createUpdate(a,function(r){n.reinvite(a.id,r,function(){d(a),e.addLocalStream(a),U.callFunctionIfExist(i)},function(e){C(a,o,{handler:O.videoUpdate,args:[t,i,o],timeout:e.retryAfter})})},function(){A.error("reinvite->createUpdate"),I(a,o)},r)):void U.callFunctionIfExist(o,E.Errors.STATE)},O.videoStopStart=function(n,i,o,r,a,s){var c,d=D[n];return d?u(d)?void U.callFunctionIfExist(o,E.Errors.STATE):(c=t.getCurrentState(d),c!==b.COMPLETED?void U.callFunctionIfExist(o,E.Errors.STATE):d.pendingRequestTimer?void U.callFunctionIfExist(o,E.Errors.PENDING_REQUEST):void(!d.isVideoSourceAllowed&&r?O.getUserMedia(function(t){d.isVideoSourceAllowed=!0,d.isVideoEnabled=!0,e.storeLocalStreamToCall(d,t.id),d.isScreenShared||O.videoUpdate(n,i,o)},function(){U.callFunctionIfExist(o)},{audio:!0,video:!0,audioIndex:0,videoIndex:0,videoResolution:a}):(d.isVideoEnabled=r,d.isScreenShared||O.videoUpdate(n,i,o)))):void U.callFunctionIfExist(o,E.Errors.STATE)},O.screenStopStart=function(n,i,o,r,a,s){var c,d=D[n];if(!d)return void U.callFunctionIfExist(o,E.Errors.STATE);if(u(d))return void U.callFunctionIfExist(o,E.Errors.STATE);if(c=t.getCurrentState(d),c!==b.COMPLETED)return void U.callFunctionIfExist(o,E.Errors.STATE);if(d.pendingRequestTimer)return void U.callFunctionIfExist(o,E.Errors.PENDING_REQUEST);if(a){if(d.isStartingScreenMedia)return void U.callFunctionIfExist(o);d.isStartingScreenMedia=!0,e.startScreenMedia(function(t){d.isScreenShared=!0,d.isStartingScreenMedia=!1,e.storeLocalStreamToCall(d,t.id),O.videoUpdate(n,i,o)},function(){d.isScreenShared=!1,d.isStartingScreenMedia=!1,U.callFunctionIfExist(o)},s,function(){t.getCurrentState(d)===b.COMPLETED?O.screenStopStart(n,r,function(){A.error("Failed to stop screen properly after user stopped the stream via the browser controls")},!1):d.isScreenShared&&(d.isScreenShared=!1,e.stopScreenMedia(),U.callFunctionIfExist(r))})}else d.isScreenShared&&(d.isScreenShared=!1,e.stopScreenMedia(),O.videoUpdate(n,i,o))},O.mute=function(t,n){var i=D[t];i&&e.muteAudioTrack(i,n)},O.sendDTMF=function(t,n){var i=D[t];i&&e.sendDTMF(i,n)},O.join=function(i,o,r,a){var s,c,d=D[i],l=D[o],u={},p=!0;d&&l&&(s=t.getCurrentState(d),c=t.getCurrentState(l),s!==b.LOCAL_HOLD&&s!==b.REMOTE_HOLD&&s!==b.BOTH_HOLD||c!==b.LOCAL_HOLD&&c!==b.REMOTE_HOLD&&c!==b.BOTH_HOLD||O.getUserMedia(function(t){e.storeLocalStreamToCall(u,t.id),e.createOffer(u,function(e){A.info("join->doOffer : sdp "+e),u.sdp=e,n.join(d.id,l.id,e,function(e){u.call=new E.call.OutgoingCall(e),u.id=e,"true"===v.clientControlled&&(u.isReferer=!0,u.refer1ID=d.id,u.refer2ID=l.id),O.delegateToCallFSM(d,N.joining_Notify),O.delegateToCallFSM(l,N.joining_Notify),O.delegateToCallFSM(u,N.joiningSuccess_Notify),D[e]=u,U.callFunctionIfExist(r,u.call)},function(){A.error("callControlService.join Failed!! sdp "+e),U.callFunctionIfExist(a)})},function(){A.error("doOffer Failed!!"),U.callFunctionIfExist(a)},!1)},function(){U.callFunctionIfExist(a)},{audio:!0,video:p?!0:!1,audioIndex:0,videoIndex:p?0:-1}))},O.transfer=function(e,t,n,i){},O.end=function(e,n){var i=D[e];i&&(t.getCurrentState(i)===b.INIT?A.error("Cannot end call in INIT callstate :"+E.Errors.STATE):(O.delegateToCallFSM(i,N.end_GUI),s(i),U.callFunctionIfExist(n)))},O.clickToCall=function(e,t,i,o){n.clickToCall(e,t,i,o)},O.getIMRN=function(e,t,i,o,r){n.getIMRN(e,t,i,o,r)},O.incomingCall=function(e,t){A.info("incomingCall : sdp = "+t);var n={call:e,sdp:t,id:e.getId()};A.info("incomingCall: "+e.getId()),v.continuity&&e.canAnswer()&&g(n),D[e.getId()]=n,O.delegateToCallFSM(n,N.callNotify)},O.updateCall=function(){},O.onNotificationEvent=function(e,t){var n=t.sessionData,o=t.statusCode,r=t.reasonText,a=t.sdp,s=t.referTo,d=t.referredBy,l=t.retryAfter,p=D[n];if(A.debug("Notification received "+e+" callid:"+n),A.debug("onNotificationEvent : sdp "+a),p){if(y&&u(p)&&e!==N.callEnd_Notify&&e!==N.callCancel_Notify)return A.debug("NOTIFICATION_QUEUE: notification state is busy, adding process to the queue!"),p.call.notificationQueue.enqueue({type:e,sessionParams:t}),void A.debug("NOTIFICATION_QUEUE: queue size is now "+p.call.notificationQueue.size());y&&c(p),a&&(p.prevRemoteSdp=p.sdp,a=i.deleteGoogleIceFromSdp(a),p.sdp=a),s&&d&&(p.referTo=s,p.referredBy=d),p.retryAfter=l,p.statusCode=o,p.reasonText=r}O.delegateToCallFSM(p,e)},O.onStateChange=function(i,o){function r(e,t){A.debug("triggerCallState:  state =   "+e+"    call.statusCode =  "+i.statusCode+"   call.reasonText =  "+i.reasonText),i.call.callState=e,U.callFunctionIfExist(i.call.onStateChange,e,i.statusCode,i.reasonText),t||S(i)}function a(e){r(e,!0)}var c,l,u,p,f,T=V,g=t.TransferEvent;switch(D[i.id]=i,p=function(){setTimeout(function(){E.isConnected()&&n.audit(i.id,function(){A.info("Audit kicked off: Success for: "+i.id)},function(){A.error("Audit: Fail for: "+i.id)})},_)},f=function(){i.call.setAuditTimer(function(){E.isConnected()&&n.audit(i.id,function(){A.info("Audit: Success for: "+i.id)},function(){A.error("Audit: Fail for: "+i.id),S(i)})})},A.info("Transfer Event: "+o+". callId: "+i.id),o){case g.callStart_fsm:case g.localHolding_fsm:case g.localUnHolding_fsm:case g.localVideoStopStart_fsm:case g.slowStartOfferProcessed_fsm:case g.joiningSuccess_fsm:break;case g.ignoredNotification_fsm:case g.answeringRingingSlow_fsm:case g.transfering_fsm:case g.localHold_fsm:case g.localUnHold_fsm:S(i);break;case g.ringing_fsm:r(T.RINGING);break;case g.callReceived_fsm:i.sdp||O.delegateToCallFSM(i,N.callNotify_noSDP),r(T.INCOMING);break;case g.answer_fsm:p(),f();break;case g.answerRingingSlow_fsm:S(i);break;case g.reject_GUI:s(i);break;case g.sessionComplete_fsm:n.endCall(i.id,function(){A.info("callControlService.endCall successful. callId: "+i.id)},function(){A.error("callControlService.endCall FAILED!!.callId: "+i.id)}),s(i),r(T.JOINED);break;case g.sessionFail_fsm:r(T.ON_HOLD);break;case g.callCompleted_fsm:if(p(),e.processAnswer(i,function(){f(),r(T.IN_CALL)},function(){s(i),r(T.ENDED)}),i.isReferer)for(c in D)D.hasOwnProperty(c)&&(!D[c]||D[c].id!==i.refer1ID&&D[c].id!==i.refer2ID||D[c].referCall(i.referTo,i.referredBy));break;case g.noAnswer_fsm:s(i),r(T.ENDED);break;case g.localEnd_fsm:n.endCall(i.id,function(){A.info("CallControlService endCall successful. callId: "+i.id)},function(){A.error("Cannot callControlService endCall. callId: "+i.id)});break;case g.callCompletedAnswering_fsm:
A.info("callManager: Call Completed Answering Event. callId: "+i.id),e.processAnswer(i,function(){r(T.IN_CALL),p(),f()},function(){s(i),r(T.ENDED)});break;case g.remoteEnd_fsm:s(i),r(T.ENDED);break;case g.remoteHold_fsm:switch(t.getCurrentState(i)){case b.REMOTE_HOLD:r(T.ON_REMOTE_HOLD);break;case b.BOTH_HOLD:r(T.ON_HOLD);break;default:S(i)}break;case g.remoteUnHold_fsm:switch(t.getCurrentState(i)){case b.LOCAL_HOLD:r(T.ON_HOLD);break;case b.COMPLETED:r(T.IN_CALL);break;default:S(i)}break;case g.remoteHolding_fsm:u=t.getCurrentState(i)===b.LOCAL_HOLD||t.getCurrentState(i)===b.BOTH_HOLD,e.processHold(i,!0,u,function(e){A.info("[callManager.onStateChange.transferEvent.remoteHold_fsm->processHold : sdp ]"+e),n.respondCallUpdate(i.id,e,function(){A.info("Remote Hold Transfer Event Successful. callId: "+i.id),O.delegateToCallFSM(i,N.remoteHoldProcessed_JSL)},function(e){A.error("Remote Hold Transfer Event FAILED!! - "+e),C(i)})},function(e){A.error("Remote Hold FAILED!! - "+e),I(i)});break;case g.remoteOfferDuringLocalHold_fsm:e.processRemoteOfferOnLocalHold(i,function(e){A.info("onStateChange.transferEvent.remoteOfferDuringLocalHold_fsm : sdp "+e),n.respondCallUpdate(i.id,e,function(){A.info("Remote Offer During Local Hold Transfer Event successful. callId: "+i.id),S(i)},function(e){C(i),A.error("Remote Offer During Local Hold  Transfer Event FAILED!! - "+e)})},function(e){A.error("Remote Offer During Local Hold FAILED!! - "+e),I(i)});break;case g.slowStartOfferDuringOnCall_fsm:case g.slowStartOfferDuringRemoteHold_fsm:e.createReOffer(i,function(e){A.info("onStateChange.transferEvent.createReOffer: sdp "+e),n.respondCallUpdate(i.id,e,function(){A.info("Slow Start Offer respondCallUpdate successful. callId: "+i.id),O.delegateToCallFSM(i,N.slowStartOfferProcessed_JSL),S(i)},function(e){A.error("Slow Start Offer respondCallUpdate FAILED!! - "+e),C(i)})},function(e){A.error("Slow Start Offer createReOffer FAILED!! - "+e),I(i)});break;case g.performReconnectWorkaround_fsm:e.createReOffer(i,function(t){A.info("onStateChange.transferEvent.createReOffer : sdp "+t),n.reinvite(i.id,t,function(){d(i),e.addLocalStream(i),A.info("callControlService.reinvite successful. callId: "+i.id)},function(){O.delegateToCallFSM(i,N.requestFailure_JSL)})},function(e){I(i)},!0);break;case g.remoteUnHolding_fsm:u=i.previousState===b.LOCAL_HOLD||i.previousState===b.BOTH_HOLD,e.processHold(i,!1,u,function(e){A.info("onStateChange.transferEvent.remoteUnHold_fsm->processHold : sdp "+e),n.respondCallUpdate(i.id,e,function(){A.info("Remote UnHold Transfer Event successful. callId: "+i.id),O.delegateToCallFSM(i,N.remoteUnHoldProcessed_JSL)},function(e){A.error("Remote UnHold Transfer Event FAILED!! - "+e),C(i)})},function(e){A.error("Remote UnHold FAILED!! - "+e),I(i)});break;case g.renegotiationCompleted_fsm:r(T.RENEGOTIATION);break;case g.remoteOffer_fsm:case g.remoteCallUpdate_fsm:e.processUpdate(i,function(e){A.info("onStateChange.transferEvent.remoteCallUpdate_fsm->processUpdate : sdp "+e),n.respondCallUpdate(i.id,e,function(){A.info("Remote Call Update Transfer Event Successful. callId: "+i.id),O.delegateToCallFSM(i,N.remoteOfferProcessed_JSL)},function(e){A.error("Remote Call Update Transfer Event FAILED!! - "+e),C(i)})},function(e){A.error("Remote Call Update FAILED!! - "+e),I(i)},i.currentState===b.LOCAL_HOLD?!0:!1);break;case g.respondCallHoldUpdate_fsm:l=i.call.getJoin(),e.processHoldRespond(i,function(){switch(A.info("Respond Call Hold Update Event Successful. callId: "+i.id),t.getCurrentState(i)){case b.REMOTE_HOLD:r(T.ON_REMOTE_HOLD);break;case b.LOCAL_HOLD:case b.BOTH_HOLD:r(T.ON_HOLD);break;case b.COMPLETED:r(T.IN_CALL)}},function(e){A.error("Respond Call Hold Update Event FAILED: "+e),S(i)},l),i.call.setButtonDisabler(!1),i.call.clearBtnTimeout(),l===!0&&i.call.onJoin();break;case g.respondCallUpdate_fsm:l=i.call.getJoin(),i.call.setButtonDisabler(!1),i.call.clearBtnTimeout(),l===!0?(e.processRespond(i,function(){A.info("Respond Call Update Event Successful. callId: "+i.id),r(T.RENEGOTIATION)},function(e){A.error("Respond Call Update Event FAILED: "+e),S(i)},l),i.call.onJoin()):e.processRespond(i,function(){switch(A.info("Respond Call Update Event Successful. callId: "+i.id),t.getCurrentState(i)){case b.REMOTE_HOLD:r(T.ON_REMOTE_HOLD);break;case b.BOTH_HOLD:r(T.ON_HOLD);break;case b.LOCAL_HOLD:r(T.ON_HOLD);break;case b.COMPLETED:r(T.IN_CALL)}},function(e){A.error("Respond Call Update Event FAILED: "+e),S(i)},l);break;case g.preCallResponse_fsm:e.processPreAnswer(i),r(T.RINGING);break;case g.forward_fsm:s(i);break;case g.joining_fsm:"true"===v.clientControlled&&(i.referCall=function(e,t){n.refer(i.id,e,t,function(){A.info("Joining Event Successful. callId: "+i.id),O.delegateToCallFSM(i,N.refer_JSL)},function(e){A.error("Joining Event FAILED!!"+e)})}),S(i);break;case g.transferSuccess_fsm:n.endCall(i.id,function(){A.info("callControlService.endCall successful. callId: "+i.id)},function(){A.error("callControlService.endCall FAILED!! callId: "+i.id)}),s(i),r(T.TRANSFERRED),A.info("endCall successful. callId: "+i.id);break;case g.transferFail_fsm:r(T.ON_HOLD);break;case g.stateReverted_fsm:switch(i.call.setButtonDisabler(!1),i.call.clearBtnTimeout(),t.getCurrentState(i)){case b.REMOTE_HOLD:a(T.ON_REMOTE_HOLD);break;case b.BOTH_HOLD:a(T.ON_HOLD);break;case b.LOCAL_HOLD:a(T.ON_HOLD);break;case b.COMPLETED:a(T.IN_CALL);break;default:A.error("CANNOT REVERT THE STATE: "+t.getCurrentState(i)+". callId: "+i.id)}break;case g.glareCondition_fsm:m(i,null,null,{handler:i.lastUpdateRequest.handler,args:i.lastUpdateRequest.args,timeout:i.retryAfter});break;default:A.error("Undefined transition event: "+o+" for "+i.id),S(i)}},O.refreshVideoRenderer=function(t){var n=D[t];n&&e.refreshVideoRenderer(n)},O.hasVideoDevice=function(){return e.isVideoSourceAvailable()},O.hasAudioDevice=function(){return e.isAudioSourceAvailable()},O.hasScreenSharing=function(){return e.isScreenSourceAvailable()},O.getLocalVideoResolutions=function(){return e.getLocalVideoResolutions()},O.getRemoteVideoResolutions=function(){return e.getRemoteVideoResolutions()},O.isCallMuted=function(e){var t=D[e];return t&&t.audioMuted?t.audioMuted:!1},O.isVideoNegotationAvailable=function(e){var t=D[e];return t.sdp?i.isSdpHasVideo(t.sdp):!1},O.getRemoteVideoState=function(e){var t=D[e];return t.remoteVideoState},O.getHoldStateOfCall=function(e){var n=D[e];return n?P[t.getCurrentState(n)]:void 0},O.canOriginatorSendLocalVideo=function(t){var n=D[t];return n?e.canOriginatorSendLocalVideo(n):!1},O.canOriginatorReceiveRemoteVideo=function(t){var n=D[t];return n?e.canOriginatorReceiveRemoteVideo(n):!1},Ae.call=function(e){if(!E.notification.isAnonymous()){var t,n,i,o,r=null,a=null,s={},c=e.callNotificationParams,d=e.callDispositionParams,l=e.sessionParams;if(i=l?l:d?d:null,A.info("params: "+i),i){if(n=i.actions,A.info("actions: "+n),i.sessionData){if(a=i.sessionData,o=O.getCalls(),void 0!==o[a])return void A.info("call already exists: "+a);A.info("sessionData: "+a)}n&&(s.reject=n.indexOf("reject",0)>-1,s.forward=n.indexOf("forward",0)>-1,s.answer=n.indexOf("answer",0)>-1),i.sdp&&(t=i.sdp)}r=new E.call.IncomingCall(a,s),r.callerNumber=U.getProperty(c,"callerDisplayNumber"),r.callerName=U.getProperty(c,"callerName"),r.calleeNumber=U.getProperty(c,"calleeDisplayNumber"),r.primaryContact=U.getProperty(c,"primaryContact"),r.primaryContact&&(r.primaryContact=r.primaryContact.split(";")[0]),O.incomingCall(r,t),U.callFunctionIfExist(E.call.onReceived,r)}},Ae.ringing=function(e){R(N.ringing_Notify,e)},Ae.sessionProgress=function(e){""!==e.sessionParams.sdp?R(N.sessionProgress,e):A.info("Warning: SDP of sessionProgress is empty.")},Ae.startCallUpdate=function(e){var t=e.sessionParams.sdp,n=N.startCallUpdate_slowStart_Notify;t&&(i.init(t),n=i.isRemoteHold()?N.startCallUpdate_remoteHold_Notify:N.startCallUpdate_remoteOffer_Notify),R(n,e)},Ae.respondCallUpdate=function(e){e.sessionParams&&e.sessionParams.retryAfter?R(N.respondCallUpdate_glareCondition_Notify,e):R(N.respondCallUpdate_Notify,e)},Ae.sessionComplete=function(e){R(N.sessionComplete_Notify,e)},Ae.sessionFail=function(e){R(N.sessionFail_Notify,e)},Ae.callEnd=function(e){R(N.callEnd_Notify,e)},Ae.trying=function(e){R(N.trying_Notify,e)},Ae.callCancel=function(e){R(N.callCancel_Notify,e)},Ae.accepted=function(e){R(N.accepted_Notify,e)},p.subscribe(f.EVENT.DEVICE_SUBSCRIPTION_STARTED,T),p.subscribe(f.EVENT.CONNECTION_REESTABLISHED,a),p.subscribe(f.EVENT.NOTIFICATION_CHANNEL_LOST,a),l&&(O.setCalls=function(e){D=e})},ke=function(e,t,n,i,o){return new Fe(e||Ie,t||Ve,n||we,i||H,o||V)},Ue=new ke;E.asd=Ue,l&&(l.CallManager=ke);var We=function(e){var t=!0;this.localVideoState=0,this.remoteVideoState=0,this.onReceived=null,this.initMedia=e.initMedia,this.startCall=e.start,this.set_logSeverityLevel=e.set_logSeverityLevel,this.enable_logCallback=e.enable_logCallback,this.disable_logCallback=e.disable_logCallback,this.get_audioInDeviceCount=e.get_audioInDeviceCount,this.get_audioOutDeviceCount=e.get_audioOutDeviceCount,this.get_videoDeviceCount=e.get_videoDeviceCount,this.hasVideoDevice=e.hasVideoDevice,this.hasAudioDevice=e.hasAudioDevice,this.getUserMedia=e.getUserMedia,this.showSettingsWindow=e.showSettingsWindow,this.getLocalVideoResolutions=e.getLocalVideoResolutions,this.getRemoteVideoResolutions=e.getRemoteVideoResolutions,this.isPluginEnabled=e.isPluginEnabled,this.hasGotCalls=e.hasGotCalls,this.getIncomingCallById=function(t){return e.getIncomingCallById(t)},this.createStreamRenderer=e.createStreamRenderer,this.disposeStreamRenderer=e.disposeStreamRenderer,this.States=e.CALL_STATES,this.HoldStates=e.CALL_HOLD_STATES,this.MediaErrors={NOT_FOUND:1,NOT_ALLOWED:2,OPTIONS:3,WRONG_VERSION:4,NOT_INITIALIZED:5,NEW_VERSION_WARNING:6,NO_SCREENSHARING_WARNING:7},this.clickToCall=e.clickToCall,this.getIMRN=e.getIMRN,this.Call=function(e){},this.IncomingCall=function(n,i){var o,r,a=n,s=i,c=!0,d=!0,l=!1,u=!1,p=!1;this.notificationQueue=new U.Queue,this.onLocalStreamAdded=null,this.onStreamAdded=null,this.mute=function(){e.mute(a,!0)},this.unmute=function(){e.mute(a,!1)},this.answer=function(t,n,i,o){s.answer?e.answer(a,t,n,i,o):n()},this.reject=function(t,n){s.reject?e.reject(a,t,n):n()},this.ignore=function(t,n){e.ignore(a,t,n)},this.forward=function(t,n,i){s.forward?e.forward(a,t,n,i):i()},this.canReject=function(){return s.reject===!0},this.canForward=function(){return s.forward===!0},this.canAnswer=function(){return s.answer===!0},this.canSendVideo=function(){return e.canOriginatorSendLocalVideo(a)},this.canReceiveVideo=function(){return e.canOriginatorReceiveRemoteVideo(a)},this.canReceivingVideo=function(){return l},this.setSendVideo=function(e){c=t&&e},this.setReceiveVideo=function(e){d=e},this.setReceivingVideo=function(e){l=e},this.getHoldState=function(){return e.getHoldStateOfCall(a)},this.getId=function(){return a},this.end=function(t){e.end(a,t)},this.hold=function(t,i){e.hold(n,t,i)},this.unhold=function(t,n){e.unhold(a,t,n)},this.directTransfer=function(t,n,i){e.directTransfer(a,t,n,i)},this.videoStop=function(t,i){e.videoStopStart(n,t,i,!1)},this.videoStart=function(t,i,o){e.videoStopStart(n,t,i,!0,o)},this.screenSharingStart=function(e,t,i,o){Ue.screenStopStart(n,e,t,i,!0,o)},this.screenSharingStop=function(e,t){Ue.screenStopStart(n,e,t,null,!1)},this.join=function(t,n,i){e.join(a,t.getId(),n,i)},this.sendDTMF=function(t){e.sendDTMF(a,t)},this.sendIntraFrame=function(){c&&e.sendIntraFrame(a)},this.sendBlackFrame=function(){e.sendBlackFrame(a)},this.refreshVideoRenderer=function(){e.refreshVideoRenderer(a)},this.getJoin=function(){return u},this.setJoin=function(e){u=e},this.getButtonDisabler=function(){return p},this.setButtonDisabler=function(e){p=e,p&&(o=setTimeout(function(){p=!1},4e3))},this.clearBtnTimeout=function(){clearTimeout(o)},this.setAuditTimer=function(e){r=setInterval(function(){e()},v.callAuditTimer?v.callAuditTimer:3e4)},this.clearAuditTimer=function(){clearInterval(r)},this.isCallMuted=function(){return e.isCallMuted(a)},this.isVideoNegotationAvailable=function(t){return e.isVideoNegotationAvailable(t)},this.getRemoteVideoState=function(){return Ue.getRemoteVideoState(this.getId())}},this.IncomingCall.prototype=new this.Call,this.OutgoingCall=function(n){var i,o,r=n,a=!0,s=!0,c=!1,d=!1,l=!1;this.notificationQueue=new U.Queue,this.onLocalStreamAdded=null,this.onStreamAdded=null,this.canSendVideo=function(){return e.canOriginatorSendLocalVideo(r)},this.canReceiveVideo=function(){return e.canOriginatorReceiveRemoteVideo(r)},this.canReceivingVideo=function(){return c},this.setSendVideo=function(e){a=t&&e},this.setReceiveVideo=function(e){s=e},this.setReceivingVideo=function(e){c=e},this.getHoldState=function(){return e.getHoldStateOfCall(r)},this.getId=function(){return r},this.sendIntraFrame=function(){a&&e.sendIntraFrame(r)},this.sendBlackFrame=function(){e.sendBlackFrame(r)},this.refreshVideoRenderer=function(){e.refreshVideoRenderer(r)},this.mute=function(){e.mute(r,!0)},this.unmute=function(){e.mute(r,!1)},this.end=function(t){e.end(r,t)},this.hold=function(t,i){e.hold(n,t,i)},this.unhold=function(t,n){e.unhold(r,t,n)},this.directTransfer=function(t,n,i){e.directTransfer(r,t,n,i)},this.videoStop=function(t,i){e.videoStopStart(n,t,i,!1)},this.videoStart=function(t,i,o){e.videoStopStart(n,t,i,!0,o)},this.screenSharingStart=function(e,t,i,o){Ue.screenStopStart(n,e,t,i,!0,o)},this.screenSharingStop=function(e,t){Ue.screenStopStart(n,e,t,null,!1)},this.join=function(t,n,i){e.join(r,t.getId(),n,i)},this.sendDTMF=function(t){e.sendDTMF(r,t)},this.getJoin=function(){return d},this.setJoin=function(e){d=e},this.getButtonDisabler=function(){return l},this.setButtonDisabler=function(e){l=e,l&&(i=setTimeout(function(){l=!1},4e3))},this.clearBtnTimeout=function(){clearTimeout(i)},this.setAuditTimer=function(e){o=setInterval(function(){e()},v.callAuditTimer?v.callAuditTimer:3e4)},this.clearAuditTimer=function(){clearInterval(o)},this.isCallMuted=function(){return e.isCallMuted(r)},this.isVideoNegotationAvailable=function(t){return e.isVideoNegotationAvailable(t)},this.getRemoteVideoState=function(){return Ue.getRemoteVideoState(this.getId())}},this.OutgoingCall.prototype=new this.Call,l&&(this.setNotificationState=function(e){this.notificationState=e})},xe=function(e){return new We(e||Ue)};E.call=new xe(Ue),l&&(l.Call=xe),l&&(l.OutgoingCall=E.call.OutgoingCall);var He=function(){},Be=function(){this.onReceived=null};Be.prototype=new He,E.custom=new Be,Ae.custom=function(e){U.callFunctionIfExist(E.custom.onReceived,e)};var Ge,Ye="/presence",je="/presenceWatcher",qe="watch",Je="stopwatch",Ke="get",ze={CONNECTED:0,UNAVAILABLE:1,AWAY:2,OUT_TO_LUNCH:3,BUSY:4,ON_VACATION:5,BE_RIGHT_BACK:6,ON_THE_PHONE:7,ACTIVE:8,INACTIVE:9,PENDING:10,OFFLINE:11,CONNECTEDNOTE:12,UNAVAILABLENOTE:13},Qe="open",Ze="closed",Xe="unknown",$e="away",et="lunch",tt="busy",nt="vacation",it="on-the-phone",ot="other",rt="Be Right Back",at="Offline",st="active",ct="inactive",dt=function(){var e=[];e[ze.CONNECTED]={status:Qe,activity:Xe},e[ze.UNAVAILABLE]={status:Ze,activity:Xe},e[ze.AWAY]={status:Qe,activity:$e},e[ze.OUT_TO_LUNCH]={status:Qe,activity:et},e[ze.BUSY]={status:Ze,activity:tt},e[ze.ON_VACATION]={status:Ze,activity:nt},e[ze.BE_RIGHT_BACK]={status:Qe,activity:ot,note:rt},e[ze.ON_THE_PHONE]={status:Qe,activity:it},e[ze.ACTIVE]={status:Qe,activity:Xe,userInput:st},e[ze.INACTIVE]={status:Ze,activity:Xe,userInput:ct},e[ze.OFFLINE]={status:Ze,activity:ot,note:at},e[ze.CONNECTEDNOTE]={status:Qe,activity:ot},e[ze.UNAVAILABLENOTE]={status:Ze,activity:ot},this.getRequestObject=function(t){var n=e[t];if(n)return n;throw new Error("Invalid Presence State")},this.getState=function(e){switch(e.userInput){case st:return ze.ACTIVE;case ct:return ze.INACTIVE}switch(e.note){case rt:return ze.BE_RIGHT_BACK;case at:return ze.OFFLINE}if(e.note)return e.status===Qe?ze.CONNECTEDNOTE:ze.UNAVAILABLENOTE;switch(e.activity){case $e:return ze.AWAY;case et:return ze.OUT_TO_LUNCH;case tt:return ze.BUSY;case nt:return ze.ON_VACATION;case it:return ze.ON_THE_PHONE;case Xe:return e.status===Qe?ze.CONNECTED:ze.UNAVAILABLE}return ze.CONNECTED}},lt=function(e,t,n){function i(t,n,i,o){var r={presenceWatcherRequest:{userList:t,action:o}};e.sendPostRequest({url:d(1,je),data:r},n,i)}function o(){c&&(p.trace("presence watch timer is stopped: "+c),clearTimeout(c),c=null)}function r(e,t,n){var r=this,a=U.getTimestamp();if(!e){if(!s)return void p.trace("presence service subscription has not been initialized, do not trigger service subscription.");p.trace("watchedUserList is empty, use lastWatchedUserList."),e=s}return p.info("presence service subscription, currentTimestamp: "+a+" expiryTimestamp: "+E),0>a-E?void p.trace("previous presence service subscription is still valid, do not trigger service subscription."):(t&&(l=t),n&&(u=n),p.info("subscribe presence status of users:",e),void i(e,function(t){var n,i;t&&(n=t.presenceWatcherResponse,n&&(i=n.expiryValue/2,i&&(E=U.getTimestamp()+1e3*i,o(),c=setTimeout(function(){r.watch(e,null,u)},1e3*i),p.trace("presence watch, timer: "+c+" expiryTimestamp: "+E)))),s=e,l&&"function"==typeof l&&l(t)},u,qe))}function a(){r(void 0,l,u)}var s=null,c=null,l=null,u=null,p=n.getLogger("presenceService"),E=0;this.getLastWatchedUserList=function(){return s},this.onReceived=null,this.update=function(t,n,i){e.sendPostRequest({url:d(1,Ye),data:{presenceRequest:Ge.getRequestObject(t)}},n,i)},this.watch=r,this.stopwatch=function(e,t,n){i(e,t,n,Je)},this.retrieve=function(e,t,n){i(e,t,n,Ke)},t.subscribe(f.EVENT.DEVICE_SUBSCRIPTION_STARTED,a),t.subscribe(f.EVENT.DEVICE_SUBSCRIPTION_ENDED,o)},ut=function(e,t,n){return new lt(e||I,t||p,n||V)},pt=new ut;Ge=new dt,Ae.presenceWatcher=function(e){if(!E.notification.isAnonymous()){var t=new E.presence.UpdateEvent,n=e.presenceWatcherNotificationParams;t.name=U.getProperty(n,"name"),t.type=U.getProperty(n,"type"),t.status=U.getProperty(n,"status"),t.activity=U.getProperty(n,"activity"),t.note=U.getProperty(n,"note"),t.userInput=U.getProperty(n,"userInput"),t.state=Ge.getState(t),U.callFunctionIfExist(E.presence.onReceived,t)}};var ft=function(e){this.update=function(t,n,i){e.update(t,n,i)},this.watch=function(t,n,i){e.watch(t,n,i)},this.stopwatch=function(t,n,i){e.stopwatch(t,n,i)},this.retrieve=function(t,n,i){e.retrieve(t,n,i)}},Et=function(e){return new ft(e||pt)},St=new Et,Tt=function(e){this.State={CONNECTED:0,UNAVAILABLE:1,AWAY:2,OUT_TO_LUNCH:3,BUSY:4,ON_VACATION:5,BE_RIGHT_BACK:6,ON_THE_PHONE:7,ACTIVE:8,INACTIVE:9,PENDING:10,OFFLINE:11,CONNECTEDNOTE:12,UNAVAILABLENOTE:13},this.update=function(t,n,i){e.update(t,n,i)},this.watch=function(t,n,i){e.watch(t,n,i)},this.stopwatch=function(t,n,i){e.stopwatch(t,n,i)},this.retrieve=function(t,n,i){e.retrieve(t,n,i)},this.UpdateEvent=function(){}},gt=function(e){return new Tt(e||St)};return E.presence=new gt,E}),function(e,t){"function"==typeof define&&define.amd?(define(["fcs"],t),define("kandy",["fcs"],t)):e.kandy=e.KandyAPI=t(e.fcs)}(this,function(e){"use strict";function t(e){var t=!1,n=!1,i=!1,o=!1;window.console&&console.warn&&console.error&&console.info&&("debug"===e&&(t=n=i=o=!0),"info"===e?t=n=i=!0:"warn"===e?t=n=!0:"error"===e&&(t=!0),o&&(D.debug=window.console.log.bind(window.console,"kandy debug: %s")),i&&(D.info=window.console.info.bind(window.console,"kandy info: %s")),n&&(D.warn=window.console.warn.bind(window.console,"kandy warn: %s")),t&&(D.error=window.console.error.bind(window.console,"kandy error: %s")))}function n(){var e=!1;return w&&(e=1===w.readyState),e}function i(){if(n()){A=setTimeout(i,3e4);var e={message_type:"ping"};try{w.send(JSON.stringify(e))}catch(t){window.console.error("Exception in sendWSPing: "+t.message)}}}function o(){window.console.log("reconnecting"),l(function(){window.console.log("reconnect success"),F=0,V.emit("onconnectionrestored")},function(){F++,window.console.log("failed to reconnect"),r()})}function r(){var e=F>10?F>100?6e4:3e4:1e4;_=setTimeout(o,e)}function a(){window.console.log("browser going online"),clearTimeout(_),_=setTimeout(o,500)}function s(){window.console.log("browser going offline"),clearTimeout(A),w&&w.onclose&&(w.onclose(),f(),w.close())}function c(e){var t=e.data_server_host,n=e.data_server_port,i=e.is_secure,o=t.match("^(?:https?://)?(?:www.)?([^/]+)"),r=n?":"+n:"";return(i?"wss":"ws")+"://"+o[1]+r}function d(e,t){y({url:"/users/configurations/data_channel",success:function(t){e&&e(t.result)},failure:t})}function l(e,t){return n()?void p():void d(function(n){h.kandyWSUrl=c(n)+"?client_sw_type=js&client_sw_version="+v.version+"&user_access_token=";try{D.debug("Opening websocket, UAT = "+N.userAccessToken),w&&f(),w=new WebSocket(h.kandyWSUrl+encodeURIComponent(N.userAccessToken))}catch(o){return void(t&&t("Error opening websocket",I.wsCreateError))}null!==w&&2!==w.readyState&&3!==w.readyState?(w.onopen=function(t){window.addEventListener&&!k&&(window.addEventListener("online",a),window.addEventListener("offline",s),k=!0),e(),i()},w.onclose=function(e){A&&(b&&!_&&(window.console.log("connection closed"),clearTimeout(A),r()),0===F&&V.emit("onconnectionlost",e))},w.onerror=function(e){V.emit("onconnectionerror",e)},w.onmessage=function(e){var t,n,i,o,r=JSON.parse(e.data);if("response"===r.message_type)n=M[r.id],n&&(delete M[r.id],0===r.status?n.success&&n.success():n.failure&&n.failure(r.message,r.status));else if(P.hasOwnProperty(r.message_type)&&(t=P[r.message_type],t&&t.length>0))for(o=t.length,i=0;o>i;i++)"function"==typeof t[i]&&t[i](r)}):t("Error opening websocket",I.wsCreateError)},t)}function u(e,t,i){if(n()){if((t||i)&&void 0===e.id){var o=g.createUUIDv4();e.id=o,M[o]={success:t,failure:i}}try{w.send(JSON.stringify(e))}catch(r){window.console.log("Exception in sendWebSocketData: "+r.message)}}else i()}function p(){clearTimeout(A),A=null,n()&&w.close()}function f(){w.onclose=null,w.onopen=null,w.onerror=null,w.onmessage=null}function E(e){if(e)for(var t in e)e.hasOwnProperty(t)&&(void 0===P[t]&&(P[t]=[]),P[t].push(e[t]))}function S(e,t,n,i,o,r){t=t.split("@")[0],y({url:"/domains/users/accesstokens",params:{key:e,user_id:t,user_password:n,client_sw_version:r&&r.client_sw_version,client_sw_type:r&&r.client_sw_type,kandy_device_id:r&&r.kandy_device_id},success:function(e){i&&i(e.result)},failure:o})}var T="2.4.2",g=function(){var e={};return e.createUUIDv4=function(){for(var e=[],t="0123456789ABCDEF",n=0;36>n;n++)e[n]=Math.floor(16*Math.random());for(e[14]=4,e[19]=3&e[19]|8,n=0;36>n;n++)e[n]=t[e[n]];return e[8]=e[13]=e[18]=e[23]="-",e.join("")},e.extend=function(e){e=e||{};for(var t=1;t<arguments.length;t++)if(arguments[t])for(var n in arguments[t])arguments[t].hasOwnProperty(n)&&(e[n]=arguments[t][n]);return e},e.defaults=function(e){e=e||{};for(var t=1;t<arguments.length;t++)if(arguments[t])for(var n in arguments[t])!e[n]&&arguments[t].hasOwnProperty(n)&&(e[n]=arguments[t][n]);return e},e.param=function(e){var t,n="";for(t in e)if(e.hasOwnProperty(t)){var i=e[t];if(void 0===i)continue;null===i&&(i=""),"string"!=typeof i&&(i=JSON.stringify(i)),n.length>0&&(n+="&"),n+=encodeURIComponent(t)+"="+encodeURIComponent(i)}return n},e.isPlainObject=function(e){return!!e&&"object"==typeof e&&e.constructor===Object},e.deepExtend=function(t){var n=Array.prototype.slice.call(arguments,1);return n.forEach(function(n){e.isPlainObject(n)&&Object.keys(n).forEach(function(i){var o=t[i],r=n[i];e.isPlainObject(r)?e.isPlainObject(o)?t[i]=e.deepExtend(o,r):t[i]=e.deepExtend({},r):t[i]=r})}),t},e}(),m=function(e){var t=function(n){n=e.defaults(n,t.defaultOptions),n.headers=e.defaults(n.headers,t.defaultHeaders);var i=e.param(n.params);i.length>0&&(-1===n.url.indexOf("?")&&(n.url+="?"),n.url+=i);var o=new XMLHttpRequest;o.open(n.type,n.url,!0),o.withCredentials=n.withCredentials;var r;for(r in n.headers)o.setRequestHeader(r,n.headers[r]);n.data&&"string"!=typeof n.data&&(n.data=JSON.stringify(n.data)),o.onreadystatechange=function(){if(4===o.readyState){var e=o.status>=200&&o.status<300||304===o.status;if(e){if("function"==typeof n.success){var t=o.responseText;"json"===n.dataType&&"string"==typeof t&&(t=t.length?JSON.parse(t):{}),n.success({status:o.status,response:t})}}else"function"==typeof n.failure&&n.failure({status:o.status,statusText:o.statusText,response:o.responseText})}else 0===o.readyState&&"function"==typeof n.failure&&n.failure({status:o.status,statusText:o.statusText,response:"Call aborted."})},o.send(n.data)};return t.defaultHeaders={"Content-Type":"application/json",Accept:"application/json"},t.defaultOptions={type:"GET",url:"",withCredentials:!1,dataType:"json"},t}(g),C=function(e){return function(t){function n(e){if(o&&!i[e])throw new Error("Invalid event type: "+e)}var i=[],o=!1;return e.extend(t,{define:function(e){i[e]=i[e]||[]},alias:function(e,t){n(e),i[t]=i[e]=i[e]||[]},on:function(e,t){n(e),(i[e]=i[e]||[]).push(t)},off:function(e,t){n(e);for(var o=i[e]||[],r=o.length;r--;)t===o[r]&&o.splice(r,1)},emit:function(e){n(e);for(var t=Array.prototype.slice.call(arguments,1),o=i[e]||[],r=0;r<o.length;r++)o[r].apply(void 0,t)},setStrictMode:function(e){o=e}})}}(g),I={OK:0,internalServerError:1,tokenExpired:10,permissionDenied:11,usageQuotaExceeded:12,insufficientFunds:13,validationFailed:14,missingParameter:15,invalidParameterValue:16,badParameterValue:17,unknownRequest:18,noData:19,alreadyExists:50,invalidIdentifier:51,invalidPassword:52,doesNotExist:53,invalidCountryCode:54,invalidCredentials:55,ajaxError:5e3,wsError:6e3,wsAlreadyOpened:6001,wsNotFound:6002,wsCreateError:6003,wsNotAuth:6004},v={version:"undefined"!=typeof T?T:"dev",responseCodes:JSON.parse(JSON.stringify(I))},R=function(){},D={info:R,warn:R,error:R,debug:R};t("warn");var A,_,h={version:0,listeners:{},kandyApiUrl:"https://api.kandy.io/v1.2",mediatorUrl:"http://service.kandy.io:8080/kandywrapper-1.0-SNAPSHOT",messageProvider:"fring",pstnOutNumber:"71",sipOutNumber:"72",allowAutoLogin:!1,kandyWSUrl:null,fcsConfig:{restPlatform:"kandy",kandyApiUrl:"https://api.kandy.io/v1.1/users/gateway",useInternalJquery:!1},spidrApi:{cors:!1,disableNotifications:null,notificationType:e.notification.NotificationTypes.WEBSOCKET,websocketProtocol:"wss"},spidrMedia:{pluginLogLevel:2,screenSharing:{chromeExtensionId:"daohbhpgnnlgkipndobecbmahalalhcp"}}},N=null,b=!0,O=!0,y=function(e){void 0!==e.type&&e.type||(e.type="GET"),e.url=(e.kandyApiUrl||h.kandyApiUrl)+e.url,e.params=e.params||{},e.params.key||(e.params.key=N.userAccessToken),"DELETE"!==e.type||e.data||(e.headers=e.headers||{},e.headers["Content-Type"]="text/html");var t=e.success,n=e.failure;e.success=function(e){e.response.status===I.OK?t&&t(e.response):n&&n(e.statusText,I.ajaxError)},e.failure=function(e){403===e.status||401===e.status?console.log("Unauthorized Error !!!"):426===e.status&&console.log("Kandy upgrade required!"),n&&n(e.statusText,I.ajaxError)},m(e)},L=function(){try{e.logManager.initLogging(function(e,t,n){"ERROR"===n.message?window.console.log(n.message):window.console.log(n.message)},!0),D=e.logManager.getLogger("kandy_js")}catch(t){}},V=function(e,t){var n=t();return e.on=n.on.bind(n),e.off=n.off.bind(n),n.define("callinitiated"),n.define("callinitiatefailed"),n.define("callincoming"),n.define("callended"),n.define("callendfailed"),n.define("callanswered"),n.define("callanswerfailed"),n.define("oncall"),n.define("callestablished"),n.define("callstatechanged"),n.define("media"),n.define("presencenotification"),n.define("loginsuccess"),n.define("loginfailed"),n.define("callrejected"),n.define("callrejectfailed"),n.define("callignored"),n.define("callignorefailed"),n.define("callhold"),n.alias("callhold","remotehold"),n.define("callunhold"),n.alias("callunhold","remoteunhold"),n.define("callscreenstopped"),n.define("onconnectionlost"),n.define("message"),n.define("messagesavailable"),n}(v,C),P={},M={},w=null,F=0,k=!1;v.setup=function(n){if(n=n||{},h=g.extend(h,n),h.screenSharing&&(h.spidrMedia.screenSharing=g.extend(h.spidrMedia.screenSharing,n.screenSharing)),n.listeners)for(var i in n.listeners)n.listeners.hasOwnProperty(i)&&V.on(i,n.listeners[i]);n.hasOwnProperty("autoreconnect")&&(b=n.autoreconnect),n.hasOwnProperty("registerforcalls")&&(O=n.registerforcalls),n.hasOwnProperty("loglevel")&&t(n.loglevel),O&&x&&x(n),n.hasOwnProperty("exposeFcs")&&(v._fcs=e)},v.getUserAccessToken=S,v.getLimitedUserDetails=function(e,t,n){y({url:"/users/details/limited",params:{key:e},success:function(e){t&&t(e.result.user)},failure:n})},v.getDevices=function(e,t,n){y({url:"/users/devices",params:{key:e},success:function(e){t&&t(e.result)},failure:n})},v.getLastSeen=function(e,t,n){y({url:"/users/presence/last_seen",params:{users:e},success:function(e){t&&t(e.result)},failure:n})},v.login=function(e,t,n,i,o){var r=function(){N=null,o&&"function"==typeof o&&o()},a={client_sw_version:v.version,client_sw_type:"JS",kandy_device_id:null};S(e,t,n,function(e){var t=e.user_access_token;v.getLimitedUserDetails(t,function(o){N=o,N.userPassword=n,N.userAccessToken=t,l(function(){N.devices=[],v.getDevices(t,function(t){N.devices=t.devices,O&&U?U(function(){i&&i(e)},r):i&&i(e)},r)},r)},r)},r,a)},v.loginSSO=function(e,t,n,i){D.info("loginSSO is not supported for calls at the moment, unless provided with the password");var o=function(){N=null,n&&"function"==typeof n&&n()};v.getLimitedUserDetails(e,function(n){N=n,N.userAccessToken=e,N.userPassword=i,l(function(){N.devices=[],v.getDevices(e,function(e){N.devices=e.devices,O&&U?U(function(){t&&t(n)},o):t&&t(n)},o)},o)},o)},v.logout=function(e){p(),W(e)},v.reconnect=function(e,t){D.warn("Deprecated method KandyAPI.reconnet."),l(e,t)},v.Session=v.session=function(){var e={},t={},n=function(e){var n,i,o,r=0;if("sessionNotification"===e.message_type&&(e=e.payload),window.console.log("Session message recvd: "+e.message_type),n=e.message_type.replace(/^session/,"on"),i=t[e.session_id]){var a=i.length;for(r;a>r;r++)if(o=i[r],o&&o.hasOwnProperty(n))try{o[n](e)}catch(s){console.log("could not execute listner: "+s)}}};return E({sessionData:n,sessionNotification:n}),e.setListeners=function(e,n){void 0===t[e]&&(t[e]=[]),t[e].push(n)},e.create=function(e,t,n){y({type:"POST",url:"/users/sessions/session",data:e,success:function(e){t&&t(e.result)},failure:n})},e.activate=function(e,t,n){y({type:"POST",url:"/users/sessions/session/id/start",data:{session_id:e},success:function(e){t&&t()},failure:n})},e.inactivate=function(e,t,n){y({type:"POST",url:"/users/sessions/session/id/stop",data:{session_id:e},success:function(e){t&&t()},failure:n})},e.sendData=function(e,t,n,i,o){u({message_type:"sessionData",session_id:e,destination:o,payload:t},n,i)},e.terminate=function(e,t,n){y({type:"DELETE",url:"/users/sessions/session/id",data:{session_id:e},success:function(e){t&&t()},failure:n})},e.getInfoById=function(e,t,n){y({url:"/users/sessions/session/id",params:{session_id:e},success:function(e){t&&t(e.result)},failure:n})},e.getInfoByName=function(e,t,n){y({url:"/users/sessions/session/name",params:{session_name:e},success:function(e){t&&t(e.result)},failure:n})},e.getOpenSessions=function(e,t){y({url:"/users/sessions",success:function(t){e&&e(t.result)},failure:t})},e.getOpenSessionsByType=function(e,t,n){y({url:"/users/sessions/type",params:{session_type:e},success:function(e){t&&t(e.result)},failure:n})},e.getOpenSessionsCreatedByUser=function(e,t){y({url:"/users/sessions/user",success:function(t){e&&e(t.result)},failure:t})},e.join=function(e,t,n,i){var o=t||{};o.session_id=e,y({type:"POST",url:"/users/sessions/session/id/participants/participant",data:o,success:function(e){n&&n(e.result)},failure:i})},e.leave=function(e,t,n,i){y({type:"DELETE",url:"/users/sessions/session/id/participants/participant",data:{session_id:e,leave_reason:t},success:function(e){n&&n()},failure:i})},e.acceptJoinRequest=function(e,t,n,i){y({type:"POST",url:"/users/sessions/session/id/admin/participants/participant/join",data:{session_id:e,full_user_id:t},success:function(e){n&&n()},failure:i})},e.rejectJoinRequest=function(e,t,n,i,o){
y({type:"DELETE",url:"/users/sessions/session/id/admin/participants/participant/join",data:{session_id:e,full_user_id:t,reject_reason:n},success:function(e){i&&i()},failure:o})},e.bootUser=function(e,t,n,i,o){y({type:"DELETE",url:"/users/sessions/session/id/admin/participants/participant",data:{session_id:e,full_user_id:t,boot_reason:n},success:function(e){i&&i()},failure:o})},e}(),v.coBrowsing=v.CoBrowse=function(){var e,t,n,i,o,r,a,s={},c=!1,d=!1,l=!0,u=!0,p=-1,f="",E="",S="",T="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAMAAAAbzM5ZAAABNVBMVEUAvuf///8AvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucBveYCuuECuuIDuN8Ett0FtdsGstcHsNUIr9MJrdEKqs0Kq80Kq84LqMoMpsgPocEQnr0RnbwSm7kWkq0XkasYj6kaiqIdhJoeg5kgf5MhfJAkdogkd4kldYcmcoMqa3oraXYsaHQwYGoxXmc0WGA1VVw1Vl06TFA7Sk07Sk48R0o8SEo+Q0Q+REU/QUE/QkNAQEBAQEFG5UD4AAAANHRSTlMAAAIEBggKHCMnKS0uNTk7PEBCSUpLU1dcX2tsbnFzdXeAhYuSk5aho63Fz9XZ29/l6uv9gq4ZTAAAAQBJREFUeAFdzmcjQmEAR/EngwzZkSSyR0aOvUe2DMoW8u/7fwRuV7r3OS9/r44xJhhpMG6Bv4wZBhbCfgwCQNSHETjbBRJeHILMRxqYsFCfJ8BUsx9VvASSLX6Urpcg1WahsstAl4V6WAN6LdTzFhC1UK8HQMJCucMWusOtFpaGBy0s5NLQ7sO3zAZAtReLe1Ca+sfHgpSB2YG68tLX3T456X0FGp35OFzcbgPHkk5hxMEQ5V6kJ1is+kUzDjA/BueSDqHPQROKj/aYJljNS/cwV0K3abiRvjehvoJh2CkqfwQdFTQpyF6tAzUejOHWH/BgbRJgptv59GhsMtEZcPoBmRFquUFm5kkAAAAASUVORK5CYII=",g=function(e){if(c!==!1)switch(e.payload.type){case"screenUpdate":I(e.payload.data);break;case"userMousePosition":h(e.payload.data);break;case"userWindowScroll":N(e.payload.data);break;case"userWindowResize":b(e.payload.data);break;case"closeCoBrowse":s.stopBrowsingAgent()}},m=function(e){if(c!==!1)switch(e.payload.type){case"agentWindowScroll":P(e.payload.data);break;case"agentMouseMove":V(e.payload.data);break;case"agentClick":L(e.payload.data);break;case"agentInputChange":k(e.payload.data);break;case"requestFullPage":U("HTML",e.full_user_id)}},C=function(e,n,i){c!==!1&&kandy.session.sendData(t,{type:e,data:n},null,null,i)},I=function(e){("undefined"==typeof o||null==o)&&y();var t=B(e.html);if(("HTML"==e.element||"HEAD"==e.element)&&"string"==typeof e.baseURI&&!t.head.getElementsByTagName("base")[0]){var n=document.createElement("base");n.href=e.baseURI,t.head.firstChild?t.head.insertBefore(n,t.head.firstChild):t.head.appendChild(n)}if("HTML"==e.element){o.width=e.screenx+"px",o.height=e.screeny+"px",d=!0;var i=G(t);a.open(),a.write(i),a.close(),"complete"===a.readyState?(d=!1,r.scroll(e.scrollx,e.scrolly)):a.onreadystatechange=function(){"complete"===a.readyState&&(l=!1,d=!1,r.scroll(e.scrollx,e.scrolly))},R()}else if("HEAD"==e.element)a.documentElement.replaceChild(t.head.cloneNode(!0),a.head);else if("BODY"==e.element)a.documentElement.replaceChild(t.body.cloneNode(!0),a.body);else{var s=e.element.substr(1),c=a.getElementById(s);c.parentNode.replaceChild(t.getElementById(s).cloneNode(!0),c)}if("string"==typeof e.css){for(var u=a.getElementsByTagName("style"),p=0;p<u.length;p++)u[p].parentNode.removeChild(u[p]);var f=document.createElement("style");f.type="text/css",f.appendChild(document.createTextNode(e.css)),a.head.appendChild(f)}r.focus(),console.log(Math.floor(Date.now()/1e3)+" Changed "+e.element)},v=function(){"undefined"!=typeof r&&(r.removeEventListener("mousemove",A),r.removeEventListener("scroll",_),r.removeEventListener("click",D),r.removeEventListener("input",O))},R=function(){v(),r.addEventListener("mousemove",A),r.addEventListener("scroll",_),r.addEventListener("click",D),r.addEventListener("input",O)},D=function(e){e.preventDefault(),null!=e.target.id&&""!=e.target.id&&C("agentClick",e.target.id)},A=function(e){C("agentMouseMove",{x:e.clientX,y:e.clientY})},_=function(e){l&&!d&&C("agentWindowScroll",{x:0!=e.target.documentElement.scrollLeft?e.target.documentElement.scrollLeft:e.target.body.scrollLeft,y:0!=e.target.documentElement.scrollTop?e.target.documentElement.scrollTop:e.target.body.scrollTop}),l=!0},h=function(e){if("undefined"!=typeof i){var n=document.getElementById("coBrowsingCursor-"+t);null==n&&(n=document.createElement("img"),n.id="coBrowsingCursor-"+t,n.src=T,n.style.position="absolute",n.style.zIndex="2147483647",i.appendChild(n)),n.style.left=e.x+"px",n.style.top=e.y+"px"}},N=function(e){"undefined"!=typeof i&&(l=!1,r.scroll(e.x,e.y))},b=function(e){o.width=e.x+"px",o.height=e.y+"px"},O=function(e){var t=e.target,n={id:t.id,type:t.nodeName};switch(t.nodeName){case"INPUT":switch(t.type){case"password":for(var i="";i.length<t.value.length;)i+="*";n.value=i;break;default:n.value=t.value}break;case"SELECT":n.options={};for(var o=t.options.length-1;o>=0;o--)t.options[o].selected&&(n.options[o]=t.options[o].selected);break;case"TEXTAREA":n.value=t.value}C("agentInputChange",n)},y=function(){n.innerHTML='<div id="coBrowsingDiv-'+t+'" style="position: relative;"></div>',i=document.getElementById("coBrowsingDiv-"+t),i.innerHTML='<iframe id="coBrowsingIframe-'+t+'" sandbox="allow-same-origin allow-scripts" src="javascript:;" style="border: none;"></iframe>',o=document.getElementById("coBrowsingIframe-"+t),r=o.contentWindow,a=r.document};s.startBrowsingAgent=function(e,i){t=e,n=i,c=!0,kandy.session.setListeners(t,{onData:g}),C("requestFullPage",!0)},s.stopBrowsingAgent=function(){for(v(),i=o=r=a=null;n.firstChild;)n.removeChild(n.firstChild);t=n=null,c=!1};var L=function(e){document.getElementById(e).click()},V=function(e){var n=document.getElementById("coBrowsingCursor-"+t);null==n&&(n=document.createElement("img"),n.id="coBrowsingCursor-"+t,n.src=T,n.style.position="fixed",n.style.zIndex="2147483647",document.body.appendChild(n)),n.style.left=e.x+"px",n.style.top=e.y+"px"},P=function(e){l=!1,window.scroll(e.x,e.y)},M=function(e){C("userMousePosition",{x:e.clientX,y:e.clientY})},w=function(e){l&&C("userWindowScroll",{x:0!=e.target.documentElement.scrollLeft?e.target.documentElement.scrollLeft:e.target.body.scrollLeft,y:0!=e.target.documentElement.scrollTop?e.target.documentElement.scrollTop:e.target.body.scrollTop}),l=!0},F=function(e){C("userWindowResize",{x:window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,y:window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight})},k=function(e){var t=document.getElementById(e.id);switch(u=!1,e.type){case"INPUT":t.value=e.value;break;case"SELECT":for(var n=t.options.length-1;n>=0;n--)t.options[n].selected=e.options[n];break;case"TEXTAREA":t.value=e.value}},U=function(e,t){var n,i="string"==typeof e?e:"HTML";if("HTML"==i)n=G(document.doctype)+document.documentElement.outerHTML,n=G(B(n));else if("HEAD"==i)n=B(document.head.outerHTML).head.outerHTML;else if("BODY"==i)n=B(document.body.outerHTML).body.outerHTML;else{var o=i.substr(1);n=B(document.getElementById(o).outerHTML).getElementById(o).outerHTML}for(var r={element:i,html:n},a="",s=document.getElementsByTagName("style"),c=0;c<s.length;c++)a+=s[c].innerHTML;(a!==S||"HTML"==i)&&(r.css=S=a,console.log("New CSS")),"HTML"==i&&(r.screenx=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,r.screeny=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,r.scrollx=0!=document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft,r.scrolly=0!=document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop),("HTML"==i||"HEAD"==i)&&(r.baseURI=document.baseURI),C("screenUpdate",r,t),console.log(Math.floor(Date.now()/1e3)+" Screen Sent "+i)},W=function(){document.removeEventListener("mousemove",M),document.removeEventListener("scroll",w),window.removeEventListener("resize",F),window.removeEventListener("input",Y),window.removeEventListener("change",j)},x=function(){W(),document.addEventListener("mousemove",M),document.addEventListener("scroll",w),window.addEventListener("resize",F),window.addEventListener("input",Y),window.addEventListener("change",j)},H=function(e,n){e.forEach(function(e){var n,i=0,o="",r=[];if("undefined"==typeof e.addedNodes[0]||e.addedNodes[0].id!="coBrowsingCursor-"+t){for(n="characterData"==e.type||"attributes"==e.type&&"id"==e.attributeName?e.target.parentNode:e.target;n.parentNode;){if(""!=n.id||"HTML"==n.tagName||"HEAD"==n.tagName||"BODY"==n.tagName){if("HTML"==n.tagName||"HEAD"==n.tagName||"BODY"==n.tagName)var a=n.tagName;else var a="#"+n.id;""==o&&(o=a),r.push(a)}""!=o&&i++,n=n.parentNode}if(""==o)return f="HTML",!1;if(o=="#coBrowsingCursor-"+t)return!1;if(r=r.reverse(),-1==p)console.log("First element: "+o+" ("+i+")"),p=i,f=o,E=r;else if(-1==r.indexOf(f)){console.log(o+" ("+i+") not under "+f);var s="HTML";E.forEach(function(e){return-1==r.indexOf(e)?!1:void(s=e)}),p=E.indexOf(s)+1,f=s,E=E.slice(0,p),console.log("Renegotiated top to: "+f+" ("+p+")")}}});var i=q(),o=Y();return 0!=i||0!=o?void console.log("Updated skipped, ids:"+i+" forms:"+o):("HTML"==f?(console.log("Doing a full page refresh"),U()):""!=f&&(console.log("Doing a partial page update on: "+f),U(f)),p=-1,f="",void(E=""))};s.startBrowsingUser=function(n){t=n,c=!0,kandy.session.setListeners(t,{onData:m}),q(),Y(),U(),x(),e=new MutationObserver(H),e.observe(document.body,{childList:!0,attributes:!0,characterData:!0,subtree:!0})},s.stopBrowsingUser=function(){e.disconnect(),W(),C("closeCoBrowse",!0);var n=document.getElementById("coBrowsingCursor-"+t);null!=n&&n.remove(),c=!1};var B=function(e){for(var n=["SCRIPT","STYLE"],i=new RegExp("^on","i"),o=new RegExp("^javascript:","i"),r=[],a=(new DOMParser).parseFromString(e,"text/html"),s=a.getElementsByTagName("*"),c=0;c<s.length;c++){var d=s[c];if(-1==n.indexOf(d.nodeName))for(var l=0;l<d.attributes.length;l++){var u=d.attributes[l];i.test(u.name)?d.removeAttribute(u.name):o.test(u.value)&&(u.value="")}else r.push(d)}for(var p=null,f=document.createTreeWalker(a,NodeFilter.SHOW_COMMENT,p,!1);f.nextNode();)r.push(f.currentNode);r.forEach(function(e){e.parentNode.removeChild(e)});var E=a.getElementById("coBrowsingCursor-"+t);return E&&E.parentNode&&E.parentNode.removeChild(E),a},G=function(e){if("object"==typeof e&&null!=e){if("undefined"!=typeof window.XMLSerializer)return(new window.XMLSerializer).serializeToString(e);if("undefined"!=typeof e.xml)return e.xml}return""},Y=function(){if(!u)return void(u=!0);for(var e=0,t=document.getElementsByTagName("input"),n=0;n<t.length;n++){var i=t[n];switch(i.type){case"password":for(var o="";o.length<i.value.length;)o+="*";i.defaultValue!=o&&(i.defaultValue=o,e++);break;case"checkbox":case"radio":i.defaultChecked!=i.checked&&(i.defaultChecked=i.checked,e++);break;case"reset":case"submit":case"button":break;default:i.defaultValue!=i.value&&(i.defaultValue=i.value,e++)}}for(var r=document.getElementsByTagName("select"),n=0;n<r.length;n++)for(var i=r[n],a=i.options.length-1;a>=0;a--)i.options[a].defaultSelected!=i.options[a].selected&&(i.options[a].defaultSelected=i.options[a].selected,e++);for(var s=document.getElementsByTagName("textarea"),n=0;n<s.length;n++)s[n].defaultValue!=s[n].value&&(s[n].defaultValue=s[n].value,e++);return e},j=function(e){"INPUT"!=e.target.nodeName||"radio"!=e.target.type&&"checkbox"!=e.target.type||Y()},q=function(){for(var e="uid-ui-",t=0,n=document.querySelectorAll('body *:not([id]), body *[id=""]'),i=0;i<n.length;i++){for(;null!=document.getElementById(e+t);)t++;n[i].id=e+t,t++}return n.length};return s}(),v.messaging=function(){function t(e,t,n,i,o,r,a){a=a||{};var s,c,d=a&&a.uuid||g.createUUIDv4(),l={message:{contentType:t,UUID:d,message:n,additional_data:a.additionalData}};return r?(g.extend(l.message,{group_id:e}),s="/users/chatgroups/chatgroup/messages"):(l.message.destination=e,l.messageType="chat",s="/devices/messages",c={device_id:N.devices[0].id}),y({type:"POST",url:s,params:c,data:l,success:function(e){i&&i(l.message)},failure:o}),d}function n(e,n,i,o,r,a,s){if("fring"===h.messageProvider){var c=g.createUUIDv4();return s=s||{},s.uuid=c,d.uploadFile(n,function(c){var d={mimeType:n.type,content_uuid:c,content_name:n.name,contact_display_name:s.contact_display_name};return t(e,i,d,o,r,a,s)},r),c}D.error("NOT SUPPORTED"),r&&r()}function i(e,n,i,o,r,a){return n.location_latitude&&n.location_longitude&&(n.latitude=n.location_latitude,n.longitude=n.location_longitude),t(e,c.LOCATION,{mimeType:"location/utm",media_map_zoom:10,location_latitude:n.latitude,locationLatitude:n.latitude,location_longitude:n.longitude,locationLongitude:n.longitude},i,o,r,a)}function o(e,n,i,o,r,a){return t(e,"text",{mimeType:"application/json",json:JSON.stringify(n)},i,o,r,a)}function r(e,t,n,i){y({type:"PUT",url:"/users/chatgroups/chatgroup/mute",params:{mute:i,group_id:e},success:function(e){t&&t(e.result)},failure:n})}function a(e,t,n,i,o){var r={members:t,mute:o,group_id:e};y({type:"PUT",data:r,url:"/users/chatgroups/chatgroup/members/mute",success:function(e){n&&n(e.result)},failure:i})}function s(e){var t=e.message;if(t){var n=t.messageType;"chat"===n?V.emit("message",t):"groupChat"===n?V.emit("chatGroupMessage",t):"chatGroupInvite"===n?V.emit("chatGroupInvite",t):"chatGroupBoot"===n?V.emit("chatGroupBoot",t):"chatGroupLeave"===n?V.emit("chatGroupLeave",t):"chatGroupUpdate"===n?V.emit("chatGroupUpdate",t):"chatGroupDelete"===n&&V.emit("chatGroupDelete",t)}}var c={VIDEO:"video",AUDIO:"audio",IMAGE:"image",FILE:"file",LOCATION:"location",CONTACT:"contact"},d={};return d.sendSMS=function(e,t,n,i,o){y({type:"POST",url:"/devices/smss",params:{device_id:N.devices[0].id},data:{message:{source:t,destination:e,message:{text:n}}},success:i,failure:o})},d.sendIm=function(n,i,o,r,a){if("fring"===h.messageProvider)return t(n,"text",{mimeType:"text/plain",text:i},o,r,!1,a);if("spidr"===h.messageProvider){var s=new e.im.Message;return s.primaryContact=n,s.type="A2",s.msgText=i,s.charset="UTF-8",e.im.send(s,o,r),0}},d.sendJSON=function(e,t,n,i,r){return o(e,t,n,i,!1,r)},d.sendImWithFile=function(e,t,i,o,r){return n(e,t,c.FILE,i,o,!1,r)},d.sendImWithImage=function(e,t,i,o,r){return n(e,t,c.IMAGE,i,o,!1,r)},d.sendImWithAudio=function(e,t,i,o,r){return n(e,t,c.AUDIO,i,o,!1,r)},d.sendImWithVideo=function(e,t,i,o,r){return n(e,t,c.VIDEO,i,o,!1,r)},d.sendImWithContact=function(e,t,i,o,r){if("string"==typeof r){var a=r;r={contact_display_name:a}}return n(e,t,c.CONTACT,i,o,!1,r)},d.sendImWithLocation=function(e,t,n,o,r){return i(e,t,n,o,!1,r)},d.uploadFile=function(e,t,n){var i=g.createUUIDv4(),o=new FormData;o.append("file",e,e.name);var r=new XMLHttpRequest,a=h.kandyApiUrl+"/devices/content?key="+N.userAccessToken+"&content_uuid="+encodeURIComponent(i)+"&device_id="+N.devices[0].id+"&content_type="+encodeURIComponent(e.type);return r.open("POST",a,!0),r.onload=function(){if(200===r.status){var e=JSON.parse(r.responseText);e.status===I.OK?t&&t(i):n&&n(e.message,e.status)}else n&&n("Request Error","500")},r.send(o),i},d.buildFileUrl=function(e){return h.kandyApiUrl+"/devices/content?key="+N.userAccessToken+"&content_uuid="+encodeURIComponent(e)+"&device_id="+N.devices[0].id},d.buildFileThumbnailUrl=function(e,t){return void 0!==t&&t||(t="500x500"),h.kandyApiUrl+"/devices/content/thumbnail?key="+N.userAccessToken+"&content_uuid="+encodeURIComponent(e)+"&device_id="+N.devices[0].id+"&thumbnail_size="+t},d.getIm=function(e,t,n){D.info("Consider using the message event instead of fetching messages"),void 0===n&&(n=!0),y({url:"/devices/messages",params:{device_id:N.devices[0].id},success:function(t){if(e){if(t.result.messages.length){var i=t.result.messages.map(function(e){return e.UUID});t.result.messages=t.result.messages.map(function(e){return-1===e.UUID.indexOf("-")&&(e.UUID=[e.UUID.substring(0,8),e.UUID.substring(8,12),e.UUID.substring(12,16),e.UUID.substring(16,20),e.UUID.substring(20,e.UUID.length)].join("-")),e})}e(t.result),n&&t.result.messages.length&&d.clearIm(i)}},failure:t})},d.clearIm=function(e,t,n){for(var i=0;i<e.length;i+=10)y({type:"DELETE",url:"/devices/messages",params:{messages:e.slice(i,i+10),device_id:N.devices[0].id},failure:n})},d.getGroups=function(e,t){y({url:"/users/chatgroups",success:function(t){e&&e(t.result)},failure:t})},d.createGroup=function(e,t,n,i){var o={group_name:e,group_image:{}};y({type:"POST",data:o,url:"/users/chatgroups",success:function(e){n&&n(e.result)},failure:i})},d.getGroupById=function(e,t,n){y({url:"/users/chatgroups/chatgroup",params:{group_id:e},success:function(e){t&&t(e.result)},failure:n})},d.deleteGroup=function(e,t,n){y({type:"DELETE",url:"/users/chatgroups/chatgroup",params:{group_id:e},success:function(e){t&&t(e.result)},failure:n})},d.updateGroup=function(e,t,n,i,o){var r={group_id:e,group_name:t,group_image:{}};y({type:"PUT",data:r,url:"/users/chatgroups/chatgroup",success:function(e){i&&i(e.result)},failure:o})},d.addGroupMembers=function(e,t,n,i){var o={members:t};y({type:"POST",url:"/users/chatgroups/chatgroup/members",params:{group_id:e},data:o,success:function(e){n&&n(e.result)},failure:i})},d.removeGroupMembers=function(e,t,n,i){y({type:"DELETE",url:"/users/chatgroups/chatgroup/members",params:{group_id:e,members:t},success:function(e){n&&n(e.result)},failure:i})},d.leaveGroup=function(e,t,n){y({type:"DELETE",url:"/users/chatgroups/chatgroup/members/membership",params:{group_id:e},success:function(e){t&&t(e.result)},failure:n})},d.muteGroup=function(e,t,n){r(e,t,n,!0)},d.unmuteGroup=function(e,t,n){r(e,t,n,!1)},d.muteGroupMembers=d.muteGroupMember=function(e,t,n,i){a(e,t,n,i,!0)},d.unmuteGroupMembers=d.unmuteGroupMember=function(e,t,n,i){a(e,t,n,i,!1)},d.sendGroupIm=function(e,n,i,o,r){return t(e,"text",{mimeType:"text/plain",text:n},i,o,!0,r)},d.sendGroupImWithFile=function(e,t,i,o,r){return n(e,t,c.FILE,i,o,!0,r)},d.sendGroupImWithImage=function(e,t,i,o,r){return n(e,t,c.IMAGE,i,o,!0,r)},d.sendGroupImWithAudio=function(e,t,i,o,r){return n(e,t,c.AUDIO,i,o,!0,r)},d.sendGroupImWithVideo=function(e,t,i,o,r){return n(e,t,c.VIDEO,i,o,!0,r)},d.sendGroupJSON=function(e,t,n,i,r){return o(e,t,n,i,!0,r)},d.sendGroupImWithLocation=function(e,t,n,o,r){return i(e,t,n,o,!0,r)},E({notification:s}),d}();var U,W,x;return v.Phone=v.call=v.voice=function(){function t(e){e.intraframe||(e.intraframe=setInterval(function(){e.sendIntraFrame()},5e3))}function n(e){e.intraframe&&(clearInterval(e.intraframe),delete e.intraframe)}function i(i,o){switch(o){case e.call.States.IN_CALL:i.canSendVideo()&&t(i),V.emit("oncall",i),i._remoteHold&&(V.emit("callunhold"),i._remoteHold=!1),i._established?V.emit("callstatechanged",i):(V.emit("callestablished",i),i._established=!0);break;case e.call.States.RENEGOTIATION:V.emit("callstatechanged",i);break;case e.call.States.RINGING:V.emit("ringing",i.getId());break;case e.call.States.ENDED:i&&(n(i),0===i.statusCode||void 0===i.statusCode?D.info("CALL END"):i.statusCode>=100&&i.statusCode<=300?D.error("WebRTC ERROR"):D.error("ERROR"),i.isAnonymous&&i.isOutgoing&&I.logout(),delete O[i.getId()],V.emit("callended",i));break;case e.call.States.ON_REMOTE_HOLD:i._remoteHold=!0,V.emit("callhold",i)}}function o(e){return null===e.state?void D.info("State is empty."):null===e.name?void D.info("Name is empty."):void V.emit("presencenotification",e.name,e.state,_[e.state],e.activity)}function r(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}}function a(e){return localStorage["kandyphone.userinformation"]=R+";"+N.full_user_id+";"+e,!0}function s(){return localStorage["kandyphone.userinformation"]}function c(){return localStorage.removeItem("kandyphone.userinformation"),!0}function d(t){return t.fcsApi?t.fcsApi:{notificationType:e.notification.NotificationTypes.WEBSOCKET,restUrl:t.REST_server_address,restPort:t.REST_server_port,websocketIP:t.webSocket_server_address,websocketPort:t.webSocket_server_port,websocketProtocol:t.webSocket_secure!==!1?"wss":"ws",protocol:t.REST_protocol,serverProvidedTurnCredentials:t.serverProvidedTurnCredentials}}function l(e){return e.fcsMedia?e.fcsMedia:(e.ICE_servers&&g.extend(e,{ICE_server_address:e.ICE_servers[0],ICE_server_port:""}),{iceserver:e.ICE_server_address,iceserverPort:e.ICE_server_port,webrtcdtls:e.use_DTLS})}function u(e){h.spidrApi=g.defaults(d(e),h.spidrApi),h.spidrMedia=g.defaults(l(e),h.spidrMedia),h.screenSharing&&(h.spidrMedia.screenSharing=h.screenSharing),h.screenSharingChromeExtensionId&&(h.spidrMedia.screenSharingChromeExtensionId=h.screenSharingChromeExtensionId)}function p(e){var t=e.versions;if(t){delete e.versions;var n=t.slice(0,h.version+1);g.deepExtend.apply(void 0,[e].concat(n))}return e}function f(t,n,i){p(t),u(t),e.setup(h.spidrApi),t.useProxy&&e.setKandyUAT(N.userAccessToken),e.setUserAuth(N.full_user_id,N.userPassword),e.notification.start(function(){h.allowAutoLogin&&r()&&a(N.userPassword),n()},function(e){D.error("login failed: unable to start spidr notification"),i(e)},!1)}function S(e){for(var t in O)I.endCall(t)}function T(e){e=e.message,e=e&&(e.kandyType||e.message_type),e&&"gofetch"!==e?"incomingCall"===e&&I._onIncommingCall("CALLavailable",e.call_id):V.emit("messagesavailable")}function m(t,n,o,r,a,s){function c(t){u(t.result.spidr_configuration),e.setup(h.spidrApi),e.setUserAuth(n,""),e.notification.start(function(){D.info("Notification started"),I.initMedia(function(){D.info("Call init successfully"),setTimeout(function(){e.call.startCall(o,a,r,function(e){e.onStateChange=function(t,n){e.statusCode=n,i(e,t)},e.isOutgoing=!0,e.isAnonymous=!0,O[e.getId()]=e,V.emit("callinitiated",e,r)},function(e){D.error("call failed"),V.emit("callinitiatefailed","error code: "+e)},!1,s)},100)},function(e){D.error("Call init failed"),v.logout(),V.emit("callinitiatefailed","Init media failed: "+e)})},function(){console.error("Notification failed"),V.emit("callinitiatefailed","Auth failed")},!0)}L(),y({url:"/domains/configurations/communications/spidr",params:{key:t},success:c,failure:function(){V.emit("callinitiatefailed","Failed to retrieve domain configuration"),D.error("Call Failed: Failed to retrieve domain configuration")}})}function C(e,t){y({url:"/users/configurations/communications/spidr",params:{secure:!0},success:function(t){e&&e(t.result.spidr_configuration)},failure:t})}var I={},R=null,A={INCOMING_CALL:1,OUTGOING_CALL:2},_={0:"Available",1:"Unavailable",2:"Away",3:"Out To Lunch",4:"Busy",5:"On Vacation",6:"Be Right Back",7:"On The Phone",8:"Active",9:"Inactive",10:"Pending",11:"Offline"},b={urlWin32bit:"https://kandy-portal.s3.amazonaws.com/public/plugin/3.0.498/Kandy_Plugin_3.0.498.exe",urlWin64bit:"https://kandy-portal.s3.amazonaws.com/public/plugin/3.0.498/Kandy_Plugin_3.0.498_x86_64.exe",urlMacUnix:"https://kandy-portal.s3.amazonaws.com/public/plugin/3.0.498/Kandy_Plugin_3.0.498.pkg"},O=[],P=!1,M=!1;I.MediaErrors=e.call.MediaErrors,U=function(e,t){C(function(n){f(n,e,t)},function(e){D.error("login failed: unable to get spidr configuration"),t()})},E({notification:T}),I.setup=function(e){D.warn("Deprecated method KandyAPI.Phone.setup use kandy.setup"),v.setup(e)},x=function(t){h=g.extend(h,t),e.notification.setOnConnectionEstablished(function(){D.info("Connection established"),V.emit("onconnectionestablished","spider")}),e.notification.setOnConnectionLost(function(){D.info("Connection Lost"),V.emit("onconnectionlost","spider")}),h.allowAutoLogin&&r()&&s()&&v.login(s().split(";")[0],s().split(";")[1],s().split(";")[2],function(){V.emit("loginsuccess",N)},function(e,t){V.emit("loginfailed",e,t)}),e.presence.onReceived=function(e){o(e)},e.call.onReceived=function(e){D.info("incoming call"),e.onStateChange=function(t){i(e,t)},e.isOutgoing=!1,O[e.getId()]=e,e.isAnonymous=-1!==e.callerNumber.indexOf("concierge"),V.emit("callincoming",e,e.isAnonymous)}},I.login=function(e,t,n){D.warn("Deprecated method KandyAPI.Phone.login use kandy.login"),v.login(e,t,n,function(){V.emit("loginsuccess",N)},function(e){V.emit("loginfailed","",e)})},I.mediaErrors=e.call.MediaErrors,I.initMedia=function(t,n,i,o){return i||o||!M?(M=!1,P=!1,o=o||{},o=g.defaults({remoteVideoContainer:o.remoteVideoContainer||h.remoteVideoContainer,localVideoContainer:o.localVideoContainer||h.localVideoContainer},h.spidrMedia),void e.call.initMedia(function(){D.info("media initiated"),P=!0,window.addEventListener("beforeunload",S),M=!0,t()},function(e){switch(e){case I.mediaErrors.WRONG_VERSION:D.error("Media Plugin Version Not Supported"),V.emit("media",{type:I.mediaErrors.WRONG_VERSION});break;case I.mediaErrors.NEW_VERSION_WARNING:D.error("New Plugin Version is available"),V.emit("media",g.extend({type:I.mediaErrors.NEW_VERSION_WARNING},b));break;case I.mediaErrors.NOT_INITIALIZED:D.error("Media couldn't be initialized"),V.emit("media",{type:I.mediaErrors.NOT_INITIALIZED});break;case I.mediaErrors.NOT_FOUND:D.error("Plugin couldn't be found!"),V.emit("media",g.extend({type:I.mediaErrors.NOT_FOUND},b));break;case I.mediaErrors.NO_SCREENSHARING_WARNING:return D.info("ScreenShare extension could not be found"),V.emit("media",{type:I.mediaErrors.NO_SCREENSHARING_WARNING}),M=!0,void t()}n(e)},o)):void t()},W=function(t){r()&&c(),e.clearResources(function(){t&&t()},!0)},I.logout=function(e){D.info("KandyAPI.Phone.logout is deprecated use kandy.logout"),v.logout(e)},I.hasStoredLogin=function(){r()&&s()},I.isMediaInitiated=function(){return P},I.isIncoming=function(e){var t=O[e];return!t.isOutgoing},I.isOutgoing=function(e){var t=O[e];return t.isOutgoing},I.callTypes=function(){return A};for(var w in A)A.hasOwnProperty(w)&&(I.callTypes[w]=A[w]);return I.getAnonymousData=function(e){var t=_call[e];return t&&t.isAnonymous?t.callerName:null},I.callType=function(e){var t=O[e];return t.isIncoming?A.INCOMING_CALL:t.isOutgoing?A.OUTGOING_CALL:void 0},I.makeSIPCall=function(e,t,n){I.makeCall(h.sipOutNumber+e+"@"+N.domain_name,!1,t,n)},I.makePSTNCall=function(e,t,n){I.makeCall(h.pstnOutNumber+e+"@"+N.domain_name,!1,t,n)},I.makeCall=function(t,n,o,r){D.info("making voice call"),I.initMedia(function(){return t===N.full_user_id?void V.emit("callinitiatefailed","You cannot call yourself"):void e.call.startCall(e.getUser(),{firstName:o},t,function(e){e.onStateChange=function(t,n){e.statusCode=n,i(e,t)},e.isOutgoing=!0,e.isAnonymous=!1,O[e.getId()]=e,V.emit("callinitiated",e,t)},function(e){D.error("call failed"),V.emit("callinitiatefailed","Start call failed: "+e)},!0,n)},function(e){D.error("call failed"),V.emit("callinitiatefailed","Init media failed: "+e)},!1,r)},I.makeAnonymousCallWithToken=function(t,n,i,o,r,a){e.setRealm(n),m(t,i,o,r,null,a)},I.makeAnonymousCall=function(e,t,n,i,o){var r={firstName:n};i=i||"anonymous@concierge.com",m(e,i,i,t,r,o)},I.rejectCall=function(e){var t=O[e];t.reject(function(){V.emit("callrejected",t)},function(e){D.info("reject failed"),V.emit("callrejectfailed",t,e)})},I.ignoreCall=function(e){var t=O[e];t.ignore(function(){V.emit("callignored",t)},function(e){V.emit("callignorefailed",t,e),D.info("ignore failed")})},I.answerCall=function(t,n,o){I.initMedia(function(){var o=O[t];o.answer(function(){V.emit("callanswered",o,o.isAnonymous),i(o,e.call.States.IN_CALL)},function(e){D.info("answer failed"),V.emit("callanswerfailed",o,e)},n)},function(e){D.info("answer failed"),V.emit("callanswerfailed")},!1,o)},I.muteCall=function(e){var t=O[e];t&&(t.mute(),t.isMuted=!0)},I.unMuteCall=function(e){var t=O[e];t&&(t.unmute(),t.isMuted=!1)},I.holdCall=function(e,t,n){var i=O[e];i&&(i.hold(t,n),i.held=!0)},I.unHoldCall=function(e,t,n){var i=O[e];i&&(i.unhold(t,n),i.held=!1)},I.startCallVideo=function(e,t,n){var i=O[e];i&&i.videoStart(t,n)},I.stopCallVideo=function(e,t,n){var i=O[e];i&&i.videoStop(t,n)},I.startScreenSharing=function(e,t,n,i){var o=O[e];o&&o.screenSharingStart(t,n,function(){V.emit("callscreenstopped",o)},i)},I.stopScreenSharing=function(e,t,n){var i=O[e];i&&i.screenSharingStop(function(){V.emit("callscreenstopped",i),t&&t()},n)},I.sendDTMF=function(e,t){var n=O[e];n&&n.sendDTMF(t)},I.endCall=function(t){var i=O[t];i&&(D.info("ending call"),i.end(function(){n(i),delete O[t],i.isAnonymous&&i.isOutgoing&&e.clearResources(function(){},!0),V.emit("callended",i)},function(e){D.error("COULD NOT END CALL"),V.emit("callendfailed",i,e)}))},I.watchPresence=function(t,n,i){D.warn("KandyAPI.Phone.watchPresence is deprecated please use kandy.getLastSeen");e.presence.watch(t.map(function(e){return e.full_user_id}),function(){D.info("Watch presence successful"),n&&n()},function(){D.error("Watch presence error"),i&&i()})},I.updatePresence=function(t){D.warn("KandyAPI.Phone.updatePresence is deprecated please use kandy.getLastSeen"),e.getServices().presence===!0?e.presence.update(parseInt(t),function(){D.info("Presence update success")},function(){D.error("Presence update failed")}):D.error("Presence service not available for account")},I.normalizeNumber=function(e,t,n,i){y({url:"/users/services/normalize/phone_number",params:{phone_number:e,countryCode:t},success:function(e){n&&n(e.result)},failure:i})},I.getSpidrConfiguration=C,I}(),v.addressBook=v.addressbook=function(){var e={};return e.searchDirectoryByPhoneNumber=function(e,t,n){y({url:"/users/directories/native/searches/phone_number",params:{search_string:e},success:function(e){t&&t(e.result.contacts)},failure:n})},e.searchDirectoryByName=function(e,t,n){y({url:"/users/directories/native/searches/name",params:{search_string:e},success:function(e){t&&t(e.result.contacts)},failure:n})},e.searchDirectoryByUsername=function(e,t,n){y({url:"/users/directories/native/searches/user_id",params:{search_string:e},success:function(e){t&&t(e.result.contacts)},failure:n})},e.searchDirectoryByUserName=e.searchDirectoryByUsername,e.searchDirectory=function(e,t,n){y({url:"/users/directories/native/search/",params:{search_string:e},success:function(e){t&&t(e.result.contacts)},failure:n})},e.retrieveDirectory=function(e,t){y({url:"/users/directories/native",success:function(t){e&&t.result&&t.result.contacts&&(t.result.contacts.forEach(function(e){e.firstName=e.user_first_name,e.lastName=e.user_last_name,e.number=e.user_phone_number,e.hintType="community",delete e.user_first_name,delete e.user_last_name}),e(t.result))},failure:t})},e.retrievePersonalAddressBook=function(e,t){y({url:"/users/addressbooks/personal",success:function(t){e&&e(t.result.contacts)},failure:t})},e.addToPersonalAddressBook=function(e,t,n){y({type:"POST",url:"/users/addressbooks/personal",data:{contact:e},success:function(e){t&&t(e.result)},failure:n})},e.removeFromPersonalAddressBook=function(e,t,n){y({type:"DELETE",url:"/users/addressbooks/personal",params:{contact_id:e},success:function(e){t&&t()},failure:n})},e.retrieveUserDeviceAddressBook=function(e,t){y({url:"/users/addressbooks/device",success:function(t){e&&e(t.result)},failure:t})},e}(),v.Registration=v.registration=function(){var t={};return t.setup=function(n){h=g.extend(h,n),t._domainAccessToken=n.domainAccessToken,D=e.logManager.getLogger()},t.retrieveCountryCode=function(e,n){y({url:"/domains/countrycodes",params:{key:t._domainAccessToken},success:function(t){e&&e(t.result)},failure:n})},t.sendValidationCode=function(e,n,i,o){y({type:"POST",url:"/domains/verifications/smss",params:{key:t._domainAccessToken},data:{user_phone_number:e,user_country_code:n},success:i,failure:o})},t.validateCode=function(e,n,i){encodeURIComponent(t._domainAccessToken);y({url:"/domains/verifications/codes",params:{key:t._domainAccessToken,validation_code:e},success:function(e){n&&n(e.result.valid)},failure:i})},t.getUserInfo=function(e,t){y({url:"/users/billing/packages/status/active",success:function(t){e&&e(t.result)},failure:t})},t.getProfileInfo=function(e,t,n,i){y({url:"/users/profiles/user_profiles/user_profile",params:{user_id:e,domain_name:t},success:function(e){n&&n(e.result)},failure:i})},t.setProfileInfo=function(e,t,n){y({type:"POST",url:"/users/profiles/user_profiles",params:{first_name:e.first_name,last_name:e.last_name,status_text:e.status_text,image_details:e.image_details,user_data:e.user_data},success:function(e){t&&t()},failure:n})},t.register=function(e,n,i){y({type:"POST",url:"/api_wrappers/registrations",params:{key:t._domainAccessToken
},data:{user_phone_number:e.userPhoneNumber,user_country_code:e.userCountryCode,validation_code:e.validationCode,device_native_id:e.deviceNativeId},success:function(e){n&&n(e.result)},failure:i})},t.getConfiguration=function(e,t,n){y({url:"/api_wrappers/configurations",params:{key:e.domainApiKey,domain_api_secret:e.domainApiSecret},success:function(e){t&&t({domainName:e.result.domain_name,domainAccessToken:e.result.domain_access_token,spidrConfiguration:{restUrl:e.result.spidr_configuration.REST_server_address,restPort:e.result.spidr_configuration.REST_server_port,protocol:e.result.spidr_configuration.REST_protocol,websocketIP:e.result.spidr_configuration.webSocket_server_address,websocketPort:e.result.spidr_configuration.webSocket_server_port,spidr_env:{iceserver:"stun:"+e.result.spidr_configuration.ICE_server_address+":"+e.result.spidr_configuration.ICE_server_port,ice:"STUN stun:"+e.result.spidr_configuration.ICE_server_address+":"+e.result.spidr_configuration.ICE_server_port}}})},failure:n})},t}(),v.Phone.sendSMS=function(){return D.warn("KandyAPI.Phone.sendSMS is deprecated please use kandy.messaging.sendSMS"),v.messaging.sendSMS.apply(null,arguments)},v.Phone.sendIm=function(){return D.warn("KandyAPI.Phone.sendIm is deprecated please use kandy.messaging.sendIm"),v.messaging.sendIm.apply(null,arguments)},v.Phone.sendJSON=function(){return D.warn("KandyAPI.Phone.sendJSON is deprecated please use kandy.messaging.sendJSON"),v.messaging.sendJSON.apply(null,arguments)},v.Phone.sendImWithFile=function(){return D.warn("KandyAPI.Phone.sendImWithFile is deprecated please use kandy.messaging.sendImWithFile"),v.messaging.sendImWithFile.apply(null,arguments)},v.Phone.sendImWithImage=function(){return D.warn("KandyAPI.Phone.sendImWithImage is deprecated please use kandy.messaging.sendImWithImage"),v.messaging.sendImWithImage.apply(null,arguments)},v.Phone.sendImWithAudio=function(){return D.warn("KandyAPI.Phone.sendImWithAudio is deprecated please use kandy.messaging.sendImWithAudio"),v.messaging.sendImWithAudio.apply(null,arguments)},v.Phone.sendImWithVideo=function(){return D.warn("KandyAPI.Phone.sendImWithVideo is deprecated please use kandy.messaging.sendImWithVideo"),v.messaging.sendImWithVideo.apply(null,arguments)},v.Phone.uploadFile=function(){return D.warn("KandyAPI.Phone.uploadFile is deprecated please use kandy.messaging.uploadFile"),v.messaging.uploadFile.apply(null,arguments)},v.Phone.buildFileUrl=function(){return D.warn("KandyAPI.Phone.buildFileUrl is deprecated please use kandy.messaging.buildFileUrl"),v.messaging.buildFileUrl.apply(null,arguments)},v.Phone.buildFileThumbnailUrl=function(){return D.warn("KandyAPI.Phone.buildFileThumbnailUrl is deprecated please use kandy.messaging.buildFileThumbnailUrl"),v.messaging.buildFileThumbnailUrl.apply(null,arguments)},v.Phone.getIm=function(){return D.warn("KandyAPI.Phone.getIm is deprecated please use kandy.messaging.getIm"),v.messaging.getIm.apply(null,arguments)},v.Phone.clearIm=function(){return D.warn("KandyAPI.Phone.clearIm is deprecated please use kandy.messaging.clearIm"),v.messaging.clearIm.apply(null,arguments)},v.Phone.searchDirectoryByPhoneNumber=function(){return D.warn("KandyAPI.Phone.searchDirectoryByPhoneNumber is deprecated please use kandy.addressbook.searchDirectoryByPhoneNumber"),v.addressbook.searchDirectoryByPhoneNumber.apply(null,arguments)},v.Phone.searchDirectoryByName=function(){return D.warn("KandyAPI.Phone.searchDirectoryByName is deprecated please use kandy.addressbook.searchDirectoryByName"),v.addressbook.searchDirectoryByName.apply(null,arguments)},v.Phone.searchDirectoryByUserName=function(){return D.warn("KandyAPI.Phone.searchDirectoryByUserName is deprecated please use kandy.addressbook.searchDirectoryByUserName"),v.addressbook.searchDirectoryByUserName.apply(null,arguments)},v.Phone.searchDirectory=function(){return D.warn("KandyAPI.Phone.searchDirectory is deprecated please use kandy.addressbook.searchDirectory"),v.addressbook.searchDirectory.apply(null,arguments)},v.Phone.retrievePersonalAddressBook=function(){D.warn("KandyAPI.Phone.retrievePersonalAddressBook is deprecated please use kandy.addressbook.retrievePersonalAddressBook"),v.addressbook.retrievePersonalAddressBook.apply(null,arguments)},v.Phone.addToPersonalAddressBook=function(){return D.warn("KandyAPI.Phone.addToPersonalAddressBook is deprecated please use kandy.addressbook.addToPersonalAddressBook"),v.addressbook.addToPersonalAddressBook.apply(null,arguments)},v.Phone.removeFromPersonalAddressBook=function(){return D.warn("KandyAPI.Phone.removeFromPersonalAddressBook is deprecated please use kandy.addressbook.removeFromPersonalAddressBook"),v.addressbook.removeFromPersonalAddressBook.apply(null,arguments)},v.Phone.retrieveUserDeviceAddressBook=function(){return D.warn("KandyAPI.Phone.retrieveUserDeviceAddressBook is deprecated please use kandy.addressbook.retrieveUserDeviceAddressBook"),v.addressbook.retrieveUserDeviceAddressBook.apply(null,arguments)},v});